<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>Ø§Ù„Ø³ÙˆÙ‚ ÙˆÙŠØ§Ùƒ | Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ø´Ø§Ù…Ù„</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ø§Ù„Ø³ÙˆÙ‚ ÙˆÙŠØ§Ùƒ">
    <link id="manifest-link" rel="manifest">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { 
                extend: { 
                    colors: { 
                        navy: '#0f172a', 
                        darkbg: '#1e293b', 
                        primary: '#10b981', 
                        secondary: '#3b82f6' 
                    } 
                } 
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { 
            font-family: 'Cairo', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 90px;
            overscroll-behavior-y: none;
            background-color: #f8fafc;
        }
        .dark body { background-color: #0f172a; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .gpu { transform: translateZ(0); will-change: transform; }
        .select-none { user-select: none; }

        @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
        .skeleton { animation: shimmer 2s infinite linear; background: linear-gradient(to right, #f1f5f9 4%, #e2e8f0 25%, #f1f5f9 36%); background-size: 1000px 100%; }
        .dark .skeleton { background: linear-gradient(to right, #1e293b 4%, #334155 25%, #1e293b 36%); }

        @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-pop { animation: popIn 0.15s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        .mobile-full-modal { position: fixed; inset: 0; z-index: 80; background-color: white; display: flex; flex-direction: column; height: 100dvh; }
        .dark .mobile-full-modal { background-color: #0f172a; }
        @media (min-width: 768px) { 
            .mobile-full-modal { position: relative; inset: auto; width: 100%; max-width: 28rem; height: 600px; max-height: 85vh; border-radius: 1.5rem; overflow: hidden; } 
            .modal-overlay { position: fixed; inset: 0; z-index: 80; background-color: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; padding: 1rem; } 
        }

        @keyframes slideInDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .toast { animation: slideInDown 0.2s ease-out forwards; }
        .toast.hiding { animation: fadeOut 0.2s ease-in forwards; }

        .form-label { display: block; font-size: 0.7rem; font-weight: 700; color: #475569; margin-bottom: 0.1rem; }
        .dark .form-label { color: #cbd5e1; }
        
        /* Fixes for Inputs and Selects Text Visibility */
        .form-input { 
            width: 100%; 
            background-color: #ffffff; 
            border: 1px solid #cbd5e1; 
            border-radius: 0.5rem; 
            padding: 0.5rem 0.7rem;
            font-size: 0.8rem; 
            font-weight: 600; 
            color: #1e293b; 
            outline: none; 
            transition: all 0.2s; 
            line-height: 1.5;
            min-height: 2.4rem; /* Ensure enough height */
        }
        select.form-input {
            padding-top: 0.4rem;
            padding-bottom: 0.4rem;
            background-position: left 0.5rem center;
        }
        .form-input:focus { border-color: #10b981; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1); }
        .dark .form-input { background-color: #1e293b; border-color: #475569; color: white; }
        .dark .form-input:focus { border-color: #10b981; }
        
        .chip-checkbox:checked + div { background-color: #10b981; color: white; border-color: #10b981; }
        .smart-option:checked + div { background-color: #0f172a; color: white; border-color: #0f172a; }
        .dark .smart-option:checked + div { background-color: #10b981; border-color: #10b981; }

        .select-sidebar-container { position: relative; overflow: hidden; border-radius: 0.5rem; }
        .select-sidebar-container::after { content: ''; position: absolute; top: 0; right: 0; bottom: 0; width: 4px; background-color: #0f172a; z-index: 10; pointer-events: none; }
        .dark .select-sidebar-container::after { background-color: #10b981; }

        /* Compact Layout for Add Modal */
        .compact-form .form-group { margin-bottom: 0.5rem; }
        .compact-form input, .compact-form select { padding: 0.4rem; font-size: 0.75rem; height: 2.2rem; }
        .compact-form .form-label { font-size: 0.65rem; margin-bottom: 0px; }

        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .install-banner { animation: slideUp 0.3s ease-out forwards; }

        #login-view { position: fixed; inset: 0; z-index: 200; background-color: #f1f5f9; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        #login-view.hidden { display: none !important; } 
        .dark #login-view { background-color: #0f172a; }
        .login-scroll { max-height: 65vh; overflow-y: auto; padding: 4px; }
        .spinner { border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 2px solid #fff; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-navy dark:text-slate-100 select-none">

    <!-- LOGIN VIEW -->
    <div id="login-view">
        <div class="w-full max-w-md bg-white dark:bg-darkbg p-5 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 flex flex-col max-h-[95vh]">
            <div class="flex flex-col items-center gap-2 mb-4 shrink-0">
                <div class="bg-navy dark:bg-primary text-white p-3 rounded-2xl shadow-lg rotate-3">
                    <i data-lucide="shopping-bag" class="w-6 h-6"></i>
                </div>
                <h1 class="font-black text-xl text-navy dark:text-white">Ø§Ù„Ø³ÙˆÙ‚ <span class="text-primary">ÙˆÙŠØ§Ùƒ</span></h1>
            </div>

            <div class="bg-slate-100 dark:bg-slate-800 p-1 rounded-xl flex mb-3 border border-slate-200 dark:border-slate-700 shrink-0">
                <button onclick="setAuthType('login')" id="btn-type-login" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-navy dark:bg-primary text-white shadow-md">
                    ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
                </button>
                <button onclick="setAuthType('signup')" id="btn-type-signup" class="flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:text-navy dark:hover:text-white">
                    Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
                </button>
            </div>

            <div class="bg-slate-100 dark:bg-slate-800 p-1 rounded-xl flex mb-4 border border-slate-200 dark:border-slate-700 shrink-0">
                <button onclick="setAuthRole('customer')" id="btn-role-customer" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-navy text-white shadow-md">
                    <div class="flex items-center justify-center gap-2"><i data-lucide="user" class="w-3 h-3"></i> Ø¹Ù…ÙŠÙ„</div>
                </button>
                <button onclick="setAuthRole('marketer')" id="btn-role-marketer" class="flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:bg-white dark:hover:bg-slate-700">
                    <div class="flex items-center justify-center gap-2"><i data-lucide="store" class="w-3 h-3"></i> Ù…Ù‚Ø¯Ù… Ø®Ø¯Ù…Ø©</div>
                </button>
            </div>

            <div class="login-scroll no-scrollbar space-y-3 flex-1">
                <div id="auth-image-field" class="hidden flex-col items-center gap-2 transition-all duration-300">
                    <div class="relative group cursor-pointer">
                        <input type="file" id="auth-img-input" accept="image/*" onchange="handleAuthImage(this)" class="absolute inset-0 opacity-0 z-10 cursor-pointer">
                        <div class="w-20 h-20 rounded-full bg-slate-50 dark:bg-slate-800 border-2 border-dashed border-primary/50 flex items-center justify-center overflow-hidden relative hover:bg-primary/5 transition">
                            <img id="auth-img-preview" src="" class="w-full h-full object-cover hidden">
                            <div id="auth-img-placeholder" class="flex flex-col items-center text-slate-400">
                                <i data-lucide="camera" class="w-6 h-6 mb-1"></i>
                                <span class="text-[9px] font-bold">ØµÙˆØ±Ø©</span>
                            </div>
                        </div>
                        <div class="absolute bottom-0 right-0 bg-navy dark:bg-primary text-white p-1 rounded-full shadow-sm pointer-events-none"><i data-lucide="plus" class="w-3 h-3"></i></div>
                    </div>
                </div>

                <div>
                    <label id="lbl-username" class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-1 block mr-1">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ ÙÙ‚Ø·)</label>
                    <div class="relative">
                        <input id="auth-username" type="text" class="form-input text-left" placeholder="username" style="direction: ltr;">
                        <i data-lucide="at-sign" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-1 block mr-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <div class="relative">
                        <input id="auth-pass" type="password" class="form-input" placeholder="******">
                        <i data-lucide="lock" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                    </div>
                </div>

                <div id="signup-fields" class="hidden space-y-3 border-t border-slate-100 dark:border-slate-700 pt-3 mt-2">
                    <div>
                        <label class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-1 block mr-1">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ (Ø¹Ø±Ø¨ÙŠ)</label>
                        <input id="auth-name-ar" type="text" class="form-input" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯">
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-1 block mr-1">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label>
                            <div class="select-sidebar-container">
                                <select id="auth-gov" onchange="updateCities()" class="form-input text-xs"></select>
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-1 block mr-1">Ø§Ù„Ù…Ø±ÙƒØ²/Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
                            <select id="auth-city" class="form-input text-xs">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø£ÙˆÙ„Ø§Ù‹</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-1 block mr-1">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„</label>
                        <input id="auth-address" type="text" class="form-input" placeholder="Ø§Ù„Ø´Ø§Ø±Ø¹ØŒ Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø²Ù„ØŒ Ø¹Ù„Ø§Ù…Ø© Ù…Ù…ÙŠØ²Ø©...">
                    </div>
                </div>
            </div>

            <div class="mt-4 pt-2 border-t border-slate-100 dark:border-slate-700 shrink-0">
                <button onclick="processAuth()" id="btn-auth-action" class="w-full bg-navy dark:bg-primary text-white py-3 rounded-xl font-bold shadow-lg shadow-navy/20 hover:opacity-90 transition-all active:scale-95 flex justify-center items-center gap-2 text-sm">
                    <span>Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø­Ø³Ø§Ø¨</span> <i data-lucide="arrow-left" class="w-4 h-4"></i>
                </button>
                <div id="auth-error" class="text-red-600 dark:text-red-400 text-[10px] font-bold text-center hidden bg-red-50 dark:bg-red-900/20 p-2 rounded-lg border border-red-200 dark:border-red-800 mt-2 break-words" dir="ltr"></div>
            </div>
        </div>
    </div>

    <!-- APP CONTENT -->
    <div id="app-content" class="hidden">
        <div id="toast-container" class="fixed top-4 left-0 right-0 z-[120] flex flex-col items-center gap-2 pointer-events-none px-4"></div>

        <header class="fixed top-0 w-full z-[60] bg-white/90 dark:bg-navy/90 border-b border-slate-200 dark:border-slate-700 flex flex-col justify-center px-4 shadow-sm backdrop-blur-md h-auto py-2">
            <div class="flex items-center justify-between w-full">
                <div class="flex items-center gap-2" id="logo-trigger">
                    <div class="bg-navy dark:bg-primary text-white p-1.5 rounded-lg"><i data-lucide="shopping-bag" class="w-5 h-5"></i></div>
                    <div class="flex flex-col">
                        <h1 class="font-bold text-base leading-tight">Ø§Ù„Ø³ÙˆÙ‚ <span class="text-primary">ÙˆÙŠØ§Ùƒ</span></h1>
                         <!-- REQ 3: Modern Welcome Text -->
                        <div id="welcome-text" class="hidden">
                            <span class="text-[10px] text-slate-400 font-bold">Ø£Ù‡Ù„Ø§Ù‹ØŒ <span id="header-username" class="text-navy dark:text-primary"></span></span>
                        </div>
                    </div>
                </div>
                <div class="flex gap-2 items-center">
                    <a href="https://wa.me/201206244875" target="_blank" class="p-2 rounded-full bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400 hover:bg-green-100 border border-green-100 dark:border-green-900/50 transition shadow-sm"><i data-lucide="message-circle" class="w-5 h-5"></i></a>
                    <button onclick="toggleDarkMode()" class="p-2 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-yellow-400 hover:bg-slate-200 transition"><i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i><i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i></button>
                    <button onclick="logout()" class="p-2 rounded-full bg-slate-100 dark:bg-slate-800 text-red-600 hover:bg-red-100 transition"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                    <button onclick="toggleAdminPanel()" id="btn-admin-top" class="hidden bg-slate-100 dark:bg-slate-800 p-2 rounded-full text-slate-600 dark:text-white"><i data-lucide="shield" class="w-5 h-5"></i></button>
                </div>
            </div>
        </header>

        <main class="pt-20 container mx-auto px-4 max-w-6xl min-h-screen">
            <div id="view-header" class="hidden flex items-center gap-3 pb-3">
                <button onclick="switchToHomeView()" class="bg-white dark:bg-slate-800 p-2 rounded-full border border-slate-200 dark:border-slate-700 shadow-sm"><i data-lucide="arrow-right" class="w-5 h-5 text-slate-600 dark:text-white"></i></button>
                <h2 id="view-title" class="text-xl font-bold text-slate-800 dark:text-white pt-1"></h2>
            </div>

            <div id="search-container" class="sticky top-16 z-[50] bg-slate-50/95 dark:bg-navy/95 backdrop-blur-lg pt-2 pb-3 -mx-4 px-4 transition-all">
                <div class="relative max-w-3xl mx-auto flex gap-2 items-center">
                    <div class="relative flex-1">
                        <input type="text" id="search-input" oninput="handleSearch()" placeholder="Ø§Ø¨Ø­Ø«..." class="w-full form-input pr-10 pl-24 h-11 !border-2 !border-black dark:!border-slate-500 shadow-lg">
                        <i data-lucide="search" class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
                        
                        <div class="absolute left-3 top-1/2 -translate-y-1/2 flex items-center gap-1 z-10">
                            <button id="btn-filter-toggle" onclick="toggleFilterPanel()" class="hidden text-secondary dark:text-blue-400 p-1.5 hover:scale-110 transition">
                                <i data-lucide="sliders-horizontal" class="w-5 h-5"></i>
                            </button>
                            <button onclick="toggleFavView()" class="relative text-red-500 p-1.5 hover:scale-110 transition">
                                <i data-lucide="heart" class="w-5 h-5"></i>
                                <span id="fav-count" class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-600 rounded-full border-2 border-white dark:border-darkbg hidden"></span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Filter Panel: REQ 2 Fix -->
                <div id="filter-panel" class="hidden mt-2 bg-white dark:bg-darkbg p-3 rounded-xl border border-slate-200 dark:border-slate-700 shadow-xl animate-pop">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-xs">ØªØµÙÙŠØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬</span>
                        <button onclick="resetFilters()" class="text-[10px] text-red-500 font-bold underline">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="select-sidebar-container h-10">
                             <select id="filter-gov" onchange="applyFilters()" class="form-input text-xs h-full leading-normal">
                                <option value="">ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª</option>
                            </select>
                        </div>
                        <select id="filter-price" onchange="applyFilters()" class="form-input text-xs h-10 leading-normal">
                            <option value="">ÙƒÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</option>
                            <option value="low">Ø§Ù„Ø£Ù‚Ù„ Ø³Ø¹Ø±Ø§Ù‹</option>
                            <option value="high">Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø±Ø§Ù‹</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="categories-container" class="hidden justify-start gap-2 overflow-x-auto pt-2 pb-3 no-scrollbar"></div>

            <div id="grid-container" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 pb-10 mt-4"></div>

            <div id="loader" class="text-center py-20"><div class="w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-2"></div><p class="text-xs text-slate-400">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>
            <div id="empty-state" class="hidden text-center py-20 opacity-60 flex-col items-center"><div class="bg-slate-200 dark:bg-slate-800 p-4 rounded-full inline-block mb-2"><i data-lucide="shirt" class="w-8 h-8 text-slate-400"></i></div><p class="text-slate-500 dark:text-slate-400 font-bold text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p><button onclick="resetFilters()" class="mt-2 text-primary text-xs font-bold underline">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button></div>
        </main>

        <!-- NAV BAR -->
        <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[70] bg-white/90 dark:bg-slate-800/90 border border-slate-200 dark:border-slate-600 px-6 py-2 rounded-full flex items-center gap-8 shadow-lg transform transition-all hover:scale-105">
            <button onclick="switchToHomeView()" class="flex flex-col items-center gap-1 text-slate-500 dark:text-slate-400 hover:text-navy dark:hover:text-white transition group"><i data-lucide="home" class="w-6 h-6 group-hover:scale-110 transition"></i></button>
            <button id="nav-add-btn" onclick="toggleAddModal()" class="w-14 h-14 bg-navy dark:bg-primary text-white rounded-full flex items-center justify-center shadow-lg shadow-slate-900/20 transform -translate-y-6 border-4 border-slate-50 dark:border-navy hover:scale-110 transition active:scale-90"><i data-lucide="plus" class="w-7 h-7"></i></button>
            <button onclick="toggleChat()" class="flex flex-col items-center gap-1 text-slate-500 dark:text-slate-400 hover:text-navy dark:hover:text-white transition group relative"><div id="chat-badge" class="hidden absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border border-white dark:border-slate-800"></div><i data-lucide="message-circle" class="w-6 h-6 group-hover:scale-110 transition"></i></button>
        </nav>

        <div id="pwa-install-toast" class="hidden fixed bottom-24 left-4 right-4 bg-navy dark:bg-white dark:text-navy text-white p-4 rounded-xl shadow-2xl z-[110] flex items-center justify-between install-banner border dark:border-slate-200">
            <div class="flex items-center gap-3">
                <div class="bg-white/10 dark:bg-navy/10 p-2 rounded-lg"><i data-lucide="download" class="w-6 h-6"></i></div>
                <div>
                    <h4 class="font-bold text-sm">ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h4>
                    <p class="text-xs opacity-80">Ø§Ù„Ø³ÙˆÙ‚ ÙˆÙŠØ§Ùƒ - ØªØ¬Ø±Ø¨Ø© Ø£Ø³Ø±Ø¹</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="installPWA()" class="bg-primary text-white px-4 py-2 rounded-lg font-bold text-xs shadow-lg">ØªØ«Ø¨ÙŠØª</button>
                <button onclick="closeInstall()" class="text-white dark:text-navy p-1"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
        </div>
    </div>

    <!-- Add Modal: REQ 7 Compact & REQ 4 Multi-Select -->
    <div id="add-modal" class="hidden modal-overlay">
        <div class="mobile-full-modal animate-pop border border-slate-200 dark:border-slate-700 compact-form">
            <div class="p-2 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800 shrink-0">
                <h3 class="font-bold text-slate-800 dark:text-white text-base">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</h3>
                <button onclick="toggleAddModal()" class="bg-white dark:bg-slate-700 p-1 rounded-full border border-slate-200 dark:border-slate-600 text-slate-500 dark:text-white hover:text-red-500"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>

            <div class="flex-1 overflow-y-auto p-2 space-y-2 bg-white dark:bg-darkbg">
                <div class="form-group"><span class="form-label">Ø§Ù„ØµÙˆØ± (max 7)</span><div class="grid grid-cols-4 gap-2"><label class="aspect-square border-2 border-dashed border-primary/40 bg-primary/5 dark:bg-primary/10 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:border-primary hover:bg-primary/10 transition text-primary relative overflow-hidden group"><input type="file" multiple accept="image/*" onchange="handleUpload(this)" class="absolute inset-0 opacity-0 z-10"><i data-lucide="camera" class="w-5 h-5 mb-1 group-hover:scale-110 transition"></i><span class="text-[9px] font-bold">Ø¥Ø¶Ø§ÙØ©</span></label><div id="preview-area" class="col-span-3 flex gap-2 overflow-x-auto no-scrollbar items-center"></div></div></div>
                <div class="form-group"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label><input id="in-title" class="form-input !border-1 !border-slate-300 dark:!border-slate-600" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬..."></div>
                <div class="grid grid-cols-2 gap-2 form-group"><div><label class="form-label">Ø§Ù„Ø³Ø¹Ø±</label><input id="in-price" type="number" class="form-input !border-1" placeholder="0"></div><div><label class="form-label">Ø§Ù„Ù‚Ø³Ù…</label><select id="in-cat" onchange="updateFormFields()" class="form-input bg-gray-50 !border-1"></select></div></div>
                
                <!-- Smart Chips -->
                <div id="dynamic-fields" class="bg-slate-50 dark:bg-slate-800/50 p-2 rounded-xl border border-slate-100 dark:border-slate-700 form-group space-y-2">
                    <div id="field-condition" class="hidden"><label class="form-label text-primary">Ø§Ù„Ø­Ø§Ù„Ø©</label><select id="in-condition" class="form-input !border-1"><option value="new">Ø¬Ø¯ÙŠØ¯</option><option value="used">Ù…Ø³ØªØ¹Ù…Ù„</option><option value="openbox">ÙƒØ³Ø± Ø²ÙŠØ±Ùˆ</option></select></div>
                    <div id="field-size-chips" class="hidden">
                        <label class="form-label text-primary">Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</label>
                        <div id="size-chips-container" class="flex flex-wrap gap-1.5"></div>
                    </div>
                    <div id="field-color-chips" class="hidden">
                        <label class="form-label text-primary">Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ØªØ§Ø­Ø©</label>
                        <div id="color-chips-container" class="flex flex-wrap gap-1.5"></div>
                    </div>
                </div>

                <!-- REQ 4: Multi-Select Shipping -->
                <div class="form-group bg-slate-50 dark:bg-slate-800/50 p-2 rounded-xl border border-slate-100 dark:border-slate-700">
                    <label class="form-label mb-1">Ø£Ù…Ø§ÙƒÙ† Ø§Ù„Ø´Ø­Ù†</label>
                    <div class="flex gap-2 mb-2">
                        <label class="flex-1 cursor-pointer"><input type="radio" name="ship-mode" value="all" onchange="toggleShipGov()" checked class="hidden peer"><div class="text-center py-1.5 rounded-lg border border-slate-200 dark:border-slate-600 text-xs font-bold text-slate-500 peer-checked:border-primary peer-checked:text-primary peer-checked:bg-white dark:peer-checked:bg-slate-700 transition">ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª</div></label>
                        <label class="flex-1 cursor-pointer"><input type="radio" name="ship-mode" value="specific" onchange="toggleShipGov()" class="hidden peer"><div class="text-center py-1.5 rounded-lg border border-slate-200 dark:border-slate-600 text-xs font-bold text-slate-500 peer-checked:border-primary peer-checked:text-primary peer-checked:bg-white dark:peer-checked:bg-slate-700 transition">Ù…Ø­Ø§ÙØ¸Ø§Øª Ù…Ø­Ø¯Ø¯Ø©</div></label>
                    </div>
                    <div id="ship-gov-container" class="hidden max-h-32 overflow-y-auto border border-slate-200 dark:border-slate-600 rounded-lg p-2 bg-white dark:bg-slate-800">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <div class="form-group"><label class="form-label">Ù…ÙˆØ§ØµÙØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©:</label><div class="flex flex-wrap gap-1.5"><label class="cursor-pointer"><input type="checkbox" class="chip-checkbox hidden" value="Ø£ØµÙ„ÙŠ"><div class="border border-slate-200 dark:border-slate-700 rounded-lg px-2 py-1 text-[10px] font-bold text-slate-500 dark:text-slate-400 transition hover:bg-slate-100">Ø£ØµÙ„ÙŠ</div></label><label class="cursor-pointer"><input type="checkbox" class="chip-checkbox hidden" value="Ù‡Ø§ÙŠ ÙƒÙˆØ¨ÙŠ"><div class="border border-slate-200 dark:border-slate-700 rounded-lg px-2 py-1 text-[10px] font-bold text-slate-500 dark:text-slate-400 transition hover:bg-slate-100">Ù‡Ø§ÙŠ ÙƒÙˆØ¨ÙŠ</div></label><label class="cursor-pointer"><input type="checkbox" class="chip-checkbox hidden" value="Ø¶Ù…Ø§Ù†"><div class="border border-slate-200 dark:border-slate-700 rounded-lg px-2 py-1 text-[10px] font-bold text-slate-500 dark:text-slate-400 transition hover:bg-slate-100">Ø¶Ù…Ø§Ù†</div></label></div></div>
                <div class="form-group"><label class="form-label">ØªÙ…ÙŠÙŠØ²:</label><div class="flex gap-2 p-1 bg-slate-100 dark:bg-slate-800 rounded-lg"><label class="flex-1 cursor-pointer text-center"><input type="radio" name="badge" value="none" checked class="hidden peer"><div class="text-center py-1 rounded-md text-[10px] font-bold text-slate-500 peer-checked:bg-white dark:peer-checked:bg-slate-700 peer-checked:shadow-sm peer-checked:text-navy dark:peer-checked:text-white transition">Ø¹Ø§Ø¯ÙŠ</div></label><label class="flex-1 cursor-pointer text-center"><input type="radio" name="badge" value="hot" class="hidden peer"><div class="text-center py-1 rounded-md text-[10px] font-bold text-slate-500 peer-checked:bg-orange-500 peer-checked:text-white transition">ğŸ”¥ Ø¹Ø±Ø¶</div></label></div></div>
                <div class="form-group"><label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input id="in-phone" type="tel" class="form-input !border-1" placeholder="01xxxxxxxxx"></div>
                <div class="form-group"><label class="form-label">Ø§Ù„ÙˆØµÙ</label><textarea id="in-desc" rows="2" class="form-input !border-1" placeholder="ØªÙØ§ØµÙŠÙ„..."></textarea></div>
            </div>
            <div class="p-2 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 shrink-0 pb-8 md:pb-2"><button onclick="submitListing()" id="btn-publish" class="w-full bg-navy dark:bg-primary text-white py-2.5 rounded-xl font-bold text-sm shadow-lg shadow-navy/20 hover:opacity-90 transition flex justify-center items-center gap-2"><span>Ù†Ø´Ø± Ø§Ù„Ø¢Ù†</span><i data-lucide="arrow-left" class="w-4 h-4"></i></button></div>
        </div>
    </div>

    <!-- Details Modal: REQ 1 & 6 Updates -->
    <div id="details-modal" class="hidden modal-overlay">
        <div class="mobile-full-modal animate-pop border border-slate-200 dark:border-slate-700">
            <div class="relative h-72 bg-gray-100 dark:bg-slate-800 shrink-0 group">
                <button onclick="closeDetails()" class="absolute top-3 left-3 bg-white/80 dark:bg-black/50 text-slate-800 dark:text-white p-1.5 rounded-full z-20 shadow-sm"><i data-lucide="x" class="w-5 h-5"></i></button>
                <div class="absolute top-3 right-3 flex gap-2 z-20">
                    <button onclick="copyDetails()" class="bg-white/80 dark:bg-black/50 text-slate-800 dark:text-white p-1.5 rounded-full shadow-sm hover:bg-white hover:text-primary transition"><i data-lucide="copy" class="w-5 h-5"></i></button>
                    <button onclick="shareListing()" class="bg-white/80 dark:bg-black/50 text-slate-800 dark:text-white p-1.5 rounded-full shadow-sm"><i data-lucide="share-2" class="w-5 h-5"></i></button>
                </div>
                <div id="details-slider-container" class="w-full h-full flex items-center justify-center bg-gray-100 dark:bg-slate-800">
                    <img id="details-img" src="" class="w-full h-full object-cover cursor-pointer" onclick="openLightbox(this.src)">
                </div>
                <div id="details-arrows"><button onclick="scrollDetails(1)" class="absolute left-2 top-1/2 -translate-y-1/2 bg-black/30 text-white p-1 rounded-full z-10"><i data-lucide="chevron-left" class="w-5 h-5"></i></button><button onclick="scrollDetails(-1)" class="absolute right-2 top-1/2 -translate-y-1/2 bg-black/30 text-white p-1 rounded-full z-10"><i data-lucide="chevron-right" class="w-5 h-5"></i></button></div>
                <div id="details-dots" class="absolute bottom-3 left-1/2 -translate-x-1/2 z-20 flex gap-1.5"></div>
            </div>
            <div class="flex-1 overflow-y-auto p-5 bg-white dark:bg-darkbg">
                <!-- REQ 1: Modern Publisher Bar with Verified Badge -->
                <div class="flex items-center gap-3 mb-4 p-3 bg-white dark:bg-slate-800 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm">
                     <div id="d-pub-img" class="w-12 h-12 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center overflow-hidden border-2 border-slate-100 dark:border-slate-600"><i data-lucide="user" class="w-6 h-6 text-slate-400"></i></div>
                     <div>
                         <p class="text-[10px] text-slate-400 font-bold mb-0.5">Ø§Ù„Ù†Ø§Ø´Ø±</p>
                         <div class="flex items-center gap-1">
                             <h4 id="d-pub-name" class="font-bold text-sm text-navy dark:text-white">...</h4>
                             <i id="d-verified-badge" data-lucide="badge-check" class="w-4 h-4 text-blue-500 fill-white dark:fill-slate-800 hidden"></i>
                         </div>
                     </div>
                </div>

                <div class="flex justify-between items-start mb-2"><h2 id="d-title" class="text-lg font-bold text-slate-900 dark:text-white leading-snug w-3/4 select-text"></h2><span id="d-price" class="text-primary font-black text-xl whitespace-nowrap select-text"></span></div>
                <div class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400 mb-4 pb-4 border-b border-slate-100 dark:border-slate-700"><span id="d-cat" class="bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded text-xs border border-slate-200 dark:border-slate-700"></span> <span id="d-cond" class="bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded text-xs border border-slate-200 dark:border-slate-700 font-bold"></span></div>
                
                <!-- REQ 1: Combined Fields for Size & Color -->
                <div id="d-combined-fields" class="space-y-2 mb-4">
                    <!-- Injected by JS -->
                </div>

                <div id="d-features" class="flex flex-wrap gap-2 mb-4"></div>
                
                <!-- REQ 1: Shipping Icon -->
                <div id="d-shipping-info" class="text-xs text-slate-600 dark:text-slate-300 mb-4 font-bold flex items-center gap-2 bg-slate-50 dark:bg-slate-800 p-2 rounded-lg border border-slate-100 dark:border-slate-700">
                    <!-- Injected by JS -->
                </div>

                <div class="space-y-2"><h3 class="text-xs font-bold text-slate-900 dark:text-slate-200 uppercase tracking-wider">Ø§Ù„ÙˆØµÙ</h3><p id="d-desc" class="text-sm text-slate-600 dark:text-slate-300 leading-relaxed whitespace-pre-wrap bg-slate-50 dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700 font-medium select-text"></p></div>
            </div>
            <div class="p-4 border-t border-slate-100 dark:border-slate-700 bg-white dark:bg-darkbg flex gap-3 shrink-0 pb-8 md:pb-4"><a id="d-wa" href="#" target="_blank" class="flex-1 bg-[#25D366] text-white py-3 rounded-xl flex justify-center items-center gap-2 font-bold shadow-lg hover:opacity-90 transition"><i data-lucide="message-circle" class="w-5 h-5"></i> ÙˆØ§ØªØ³Ø§Ø¨</a><a id="d-call" href="#" class="flex-1 bg-navy dark:bg-primary text-white py-3 rounded-xl flex justify-center items-center gap-2 font-bold shadow-lg hover:opacity-90 transition"><i data-lucide="phone" class="w-5 h-5"></i> Ø§ØªØµØ§Ù„</a></div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chat-modal" class="hidden modal-overlay">
        <div class="mobile-full-modal animate-pop border border-slate-200 dark:border-slate-700">
            <div class="bg-navy dark:bg-primary p-3 text-white flex justify-between items-center shrink-0"><div class="flex items-center gap-2"><div class="bg-white/10 p-1.5 rounded-full"><i data-lucide="bot" class="w-5 h-5 text-yellow-400"></i></div><div><h4 class="font-bold text-xs">Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</h4></div></div><button onclick="toggleChat()" class="hover:bg-white/20 p-1 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <div id="chat-box" class="flex-1 bg-slate-100 dark:bg-slate-900 p-3 overflow-y-auto space-y-2 text-xs"></div>
            <div class="p-2 bg-white dark:bg-slate-800 border-t dark:border-slate-700 flex items-center gap-2 shrink-0 pb-safe"><input id="chat-msg" type="text" class="flex-1 bg-slate-100 dark:bg-slate-700 border-0 rounded-full px-4 py-3 text-sm outline-none dark:text-white font-bold" placeholder="Ø§ÙƒØªØ¨..."><button onclick="sendMsg()" class="w-8 h-8 bg-navy dark:bg-primary rounded-full text-white flex items-center justify-center shadow"><i data-lucide="send" class="w-4 h-4"></i></button></div>
        </div>
    </div>

    <!-- Lightbox -->
    <div id="lightbox" class="hidden fixed inset-0 bg-black/95 z-[150] flex flex-col items-center justify-center select-none">
        <button onclick="closeLightbox()" class="absolute top-4 left-4 bg-white/20 text-white p-2 rounded-full z-20"><i data-lucide="x" class="w-6 h-6"></i></button>
        <button onclick="navigateLightbox(-1)" class="absolute left-2 md:left-10 top-1/2 -translate-y-1/2 bg-black/30 text-white p-2 rounded-full z-20 hover:bg-black/50 transition"><i data-lucide="chevron-left" class="w-8 h-8"></i></button>
        <button onclick="navigateLightbox(1)" class="absolute right-2 md:right-10 top-1/2 -translate-y-1/2 bg-black/30 text-white p-2 rounded-full z-20 hover:bg-black/50 transition"><i data-lucide="chevron-right" class="w-8 h-8"></i></button>
        <div class="relative w-full h-full flex items-center justify-center"><img id="lightbox-img" src="" class="max-w-full max-h-[80vh] object-contain"></div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="hidden fixed inset-0 bg-navy z-[130] flex flex-col text-white"><div class="p-3 border-b border-white/10 flex justify-between items-center bg-[#001a38]"><h2 class="font-bold flex items-center gap-2 text-sm"><i data-lucide="shield" class="w-4 h-4 text-primary"></i> Ø§Ù„ØªØ­ÙƒÙ…</h2><div class="flex gap-3"><button onclick="refreshAdmin()"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button><button onclick="toggleAdminPanel()"><i data-lucide="x" class="w-5 h-5"></i></button></div></div><div class="flex-1 flex overflow-hidden"><div class="w-1/3 border-l border-white/10 bg-[#001f3f] overflow-y-auto p-2" id="admin-users-list"></div><div class="w-2/3 flex flex-col bg-navy relative"><div id="admin-chat-header" class="h-12 border-b border-white/10 flex items-center justify-between px-3 bg-[#001a38]"><span class="text-xs font-bold">Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø©</span><button onclick="kickUser()" id="btn-end-chat" class="hidden bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded flex items-center gap-1"><i data-lucide="slash" class="w-3 h-3"></i> Ø¥Ù†Ù‡Ø§Ø¡</button></div><div id="admin-msg-area" class="flex-1 p-3 overflow-y-auto space-y-2 text-xs"></div><div class="p-2 border-t border-white/10 flex gap-2 bg-[#001a38]"><input id="admin-input" class="flex-1 bg-white/5 border border-white/20 rounded px-3 py-1.5 text-xs text-white outline-none" placeholder="Ø§Ù„Ø±Ø¯..."><button onclick="sendAdminMsg()" class="bg-primary px-4 py-1.5 rounded text-xs font-bold">Ø¥Ø±Ø³Ø§Ù„</button></div></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const EGYPT_DATA = {
            "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©": ["Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±", "Ù…ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ", "Ø§Ù„ØªØ¬Ù…Ø¹ Ø§Ù„Ø®Ø§Ù…Ø³", "Ø´Ø¨Ø±Ø§", "Ø¹ÙŠÙ† Ø´Ù…Ø³", "Ø§Ù„Ù…Ø±Ø¬", "Ø­Ù„ÙˆØ§Ù†", "ÙˆØ³Ø· Ø§Ù„Ø¨Ù„Ø¯", "Ø§Ù„Ø²Ù…Ø§Ù„Ùƒ", "Ø§Ù„Ù…Ù†ÙŠÙ„", "Ø§Ù„Ø¹Ø¨Ø§Ø³ÙŠØ©", "Ø§Ù„Ø²ÙŠØªÙˆÙ†", "Ø­Ø¯Ø§Ø¦Ù‚ Ø§Ù„Ù‚Ø¨Ø©", "Ø§Ù„Ø³ÙŠØ¯Ø© Ø²ÙŠÙ†Ø¨"],
            "Ø§Ù„Ø¬ÙŠØ²Ø©": ["Ø§Ù„Ù‡Ø±Ù…", "ÙÙŠØµÙ„", "6 Ø£ÙƒØªÙˆØ¨Ø±", "Ø§Ù„Ø´ÙŠØ® Ø²Ø§ÙŠØ¯", "Ø§Ù„Ø¯Ù‚ÙŠ", "Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†", "Ø§Ù„Ø¹Ø¬ÙˆØ²Ø©", "Ø¥Ù…Ø¨Ø§Ø¨Ø©", "Ø§Ù„ÙˆØ±Ø§Ù‚", "Ø¨ÙˆÙ„Ø§Ù‚ Ø§Ù„Ø¯ÙƒØ±ÙˆØ±", "Ø§Ù„Ø¹Ù…Ø±Ø§Ù†ÙŠØ©", "Ø§Ù„Ù…Ù†ÙŠØ¨", "Ø§Ù„Ø¨Ø¯Ø±Ø´ÙŠÙ†", "Ø§Ù„Ø­ÙˆØ§Ù…Ø¯ÙŠØ©", "Ø§Ù„ØµÙ", "Ø£Ø·ÙÙŠØ­"],
            "Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©": ["Ø³Ù…ÙˆØ­Ø©", "Ù…ÙŠØ§Ù…ÙŠ", "Ø§Ù„Ù…Ù†ØªØ²Ù‡", "Ø³ÙŠØ¯ÙŠ Ø¨Ø´Ø±", "Ø§Ù„Ø¹ØµØ§ÙØ±Ø©", "Ø§Ù„Ù…Ù†Ø¯Ø±Ø©", "ÙÙŠÙƒØªÙˆØ±ÙŠØ§", "Ø¬Ù„ÙŠÙ…", "Ø³ØªØ§Ù†Ù„ÙŠ", "Ø±Ø´Ø¯ÙŠ", "ÙƒÙØ± Ø¹Ø¨Ø¯Ù‡", "Ù…Ø­Ø±Ù… Ø¨Ùƒ", "Ø§Ù„Ø¹Ø¬Ù…ÙŠ", "Ø§Ù„Ø¨ÙŠØ·Ø§Ø´", "Ø§Ù„Ù‡Ø§Ù†ÙˆÙÙŠÙ„", "Ø¨Ø±Ø¬ Ø§Ù„Ø¹Ø±Ø¨"],
            "Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©": ["Ø§Ù„Ù…Ù†ØµÙˆØ±Ø©", "Ø·Ù„Ø®Ø§", "Ù…ÙŠØª ØºÙ…Ø±", "Ø¯ÙƒØ±Ù†Ø³", "Ø´Ø±Ø¨ÙŠÙ†", "Ø§Ù„Ø³Ù†Ø¨Ù„Ø§ÙˆÙŠÙ†", "Ø£Ø¬Ø§", "Ø¨Ù„Ù‚Ø§Ø³", "Ù…Ù†ÙŠØ© Ø§Ù„Ù†ØµØ±", "Ø§Ù„Ù…Ø·Ø±ÙŠØ©", "Ø§Ù„Ø¬Ù…Ø§Ù„ÙŠØ©", "Ø¨Ù†ÙŠ Ø¹Ø¨ÙŠØ¯"],
            "Ø§Ù„Ø´Ø±Ù‚ÙŠØ©": ["Ø§Ù„Ø²Ù‚Ø§Ø²ÙŠÙ‚", "Ø§Ù„Ø¹Ø´Ø± Ù…Ù† Ø±Ù…Ø¶Ø§Ù†", "Ù…Ù†ÙŠØ§ Ø§Ù„Ù‚Ù…Ø­", "Ø¨Ù„Ø¨ÙŠØ³", "ÙØ§Ù‚ÙˆØ³", "Ø£Ø¨Ùˆ Ø­Ù…Ø§Ø¯", "Ø§Ù„Ø­Ø³ÙŠÙ†ÙŠØ©", "ÙƒÙØ± ØµÙ‚Ø±", "Ø£Ø¨Ùˆ ÙƒØ¨ÙŠØ±", "Ø¯ÙŠØ±Ø¨ Ù†Ø¬Ù…", "Ù…Ø´ØªÙˆÙ„ Ø§Ù„Ø³ÙˆÙ‚", "Ù‡Ù‡ÙŠØ§"],
            "Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©": ["Ø´Ø¨ÙŠÙ† Ø§Ù„ÙƒÙˆÙ…", "Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø³Ø§Ø¯Ø§Øª", "Ù…Ù†ÙˆÙ", "Ø£Ø´Ù…ÙˆÙ†", "Ù‚ÙˆÙŠØ³Ù†Ø§", "Ø¨Ø±ÙƒØ© Ø§Ù„Ø³Ø¨Ø¹", "ØªÙ„Ø§", "Ø§Ù„Ø´Ù‡Ø¯Ø§Ø¡", "Ø§Ù„Ø¨Ø§Ø¬ÙˆØ±", "Ø³Ø±Ø³ Ø§Ù„Ù„ÙŠØ§Ù†"],
            "Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©": ["Ø¨Ù†Ù‡Ø§", "Ø´Ø¨Ø±Ø§ Ø§Ù„Ø®ÙŠÙ…Ø©", "Ù‚Ù„ÙŠÙˆØ¨", "Ø§Ù„Ù‚Ù†Ø§Ø·Ø± Ø§Ù„Ø®ÙŠØ±ÙŠØ©", "Ø§Ù„Ø®Ø§Ù†ÙƒØ©", "ÙƒÙØ± Ø´ÙƒØ±", "Ø·ÙˆØ®", "Ø§Ù„Ø¹Ø¨ÙˆØ±", "Ø´Ø¨ÙŠÙ† Ø§Ù„Ù‚Ù†Ø§Ø·Ø±", "Ø§Ù„Ø®ØµÙˆØµ"],
            "Ø§Ù„Ø¨Ø­ÙŠØ±Ø©": ["Ø¯Ù…Ù†Ù‡ÙˆØ±", "ÙƒÙØ± Ø§Ù„Ø¯ÙˆØ§Ø±", "Ø¥ÙŠØªØ§ÙŠ Ø§Ù„Ø¨Ø§Ø±ÙˆØ¯", "Ø£Ø¨Ùˆ Ø­Ù…Øµ", "ÙƒÙˆÙ… Ø­Ù…Ø§Ø¯Ø©", "Ø§Ù„Ø¯Ù„Ù†Ø¬Ø§Øª", "Ø­ÙˆØ´ Ø¹ÙŠØ³Ù‰", "Ø±Ø´ÙŠØ¯", "Ø¥Ø¯ÙƒÙˆ", "Ø§Ù„Ù…Ø­Ù…ÙˆØ¯ÙŠØ©", "Ø§Ù„Ø±Ø­Ù…Ø§Ù†ÙŠØ©", "Ø§Ù„Ù†ÙˆØ¨Ø§Ø±ÙŠØ©"],
            "Ø§Ù„ØºØ±Ø¨ÙŠØ©": ["Ø·Ù†Ø·Ø§", "Ø§Ù„Ù…Ø­Ù„Ø© Ø§Ù„ÙƒØ¨Ø±Ù‰", "ÙƒÙØ± Ø§Ù„Ø²ÙŠØ§Øª", "Ø²ÙØªÙ‰", "Ø§Ù„Ø³Ù†Ø·Ø©", "Ù‚Ø·ÙˆØ±", "Ø¨Ø³ÙŠÙˆÙ†", "Ø³Ù…Ù†ÙˆØ¯"],
            "Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯": ["Ø­ÙŠ Ø§Ù„Ø´Ø±Ù‚", "Ø­ÙŠ Ø§Ù„Ø¹Ø±Ø¨", "Ø­ÙŠ Ø§Ù„Ù…Ù†Ø§Ø®", "Ø­ÙŠ Ø§Ù„Ø¶ÙˆØ§Ø­ÙŠ", "Ø­ÙŠ Ø§Ù„Ø¬Ù†ÙˆØ¨", "Ø­ÙŠ Ø§Ù„Ø²Ù‡ÙˆØ±", "Ø¨ÙˆØ±ÙØ¤Ø§Ø¯"],
            "Ø¯Ù…ÙŠØ§Ø·": ["Ø¯Ù…ÙŠØ§Ø·", "Ø±Ø£Ø³ Ø§Ù„Ø¨Ø±", "Ø¯Ù…ÙŠØ§Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "ÙØ§Ø±Ø³ÙƒÙˆØ±", "Ø§Ù„Ø²Ø±Ù‚Ø§", "ÙƒÙØ± Ø³Ø¹Ø¯", "Ø§Ù„Ø±ÙˆØ¶Ø©", "Ø§Ù„Ø³Ø±Ùˆ", "Ø¹Ø²Ø¨Ø© Ø§Ù„Ø¨Ø±Ø¬", "Ù…ÙŠØª Ø£Ø¨Ùˆ ØºØ§Ù„Ø¨"],
            "Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©": ["Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©", "Ø§Ù„Ù‚ØµØ§ØµÙŠÙ†", "Ø§Ù„ØªÙ„ Ø§Ù„ÙƒØ¨ÙŠØ±", "ÙØ§ÙŠØ¯", "Ø§Ù„Ù‚Ù†Ø·Ø±Ø© Ø´Ø±Ù‚", "Ø§Ù„Ù‚Ù†Ø·Ø±Ø© ØºØ±Ø¨", "Ø£Ø¨Ùˆ ØµÙˆÙŠØ±"],
            "Ø§Ù„Ø³ÙˆÙŠØ³": ["Ø­ÙŠ Ø§Ù„Ø³ÙˆÙŠØ³", "Ø­ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø¹ÙŠÙ†", "Ø­ÙŠ Ø¹ØªØ§Ù‚Ø©", "Ø­ÙŠ Ø§Ù„Ø¬Ù†Ø§ÙŠÙ†", "Ø­ÙŠ ÙÙŠØµÙ„"],
            "ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®": ["ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®", "Ø¯Ø³ÙˆÙ‚", "ÙÙˆÙ‡", "Ù…Ø·ÙˆØ¨Ø³", "Ø¨Ù„Ø·ÙŠÙ…", "Ù…ØµÙŠÙ Ø¨Ù„Ø·ÙŠÙ…", "Ø§Ù„Ø­Ø§Ù…ÙˆÙ„", "Ø¨ÙŠÙ„Ø§", "Ø§Ù„Ø±ÙŠØ§Ø¶", "Ø³ÙŠØ¯ÙŠ Ø³Ø§Ù„Ù…", "Ù‚Ù„ÙŠÙ†"],
            "Ø§Ù„ÙÙŠÙˆÙ…": ["Ø§Ù„ÙÙŠÙˆÙ…", "Ø§Ù„ÙÙŠÙˆÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø·Ø§Ù…ÙŠØ©", "Ø³Ù†ÙˆØ±Ø³", "Ø¥Ø·Ø³Ø§", "Ø¥Ø¨Ø´ÙˆØ§ÙŠ", "ÙŠÙˆØ³Ù Ø§Ù„ØµØ¯ÙŠÙ‚"],
            "Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ": ["Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ", "Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø§Ù„ÙˆØ§Ø³Ø·Ù‰", "Ù†Ø§ØµØ±", "Ø¥Ù‡Ù†Ø§Ø³ÙŠØ§", "Ø¨Ø¨Ø§", "Ø§Ù„ÙØ´Ù†", "Ø³Ù…Ø³Ø·Ø§"],
            "Ø§Ù„Ù…Ù†ÙŠØ§": ["Ø§Ù„Ù…Ù†ÙŠØ§", "Ø§Ù„Ù…Ù†ÙŠØ§ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø§Ù„Ø¹Ø¯ÙˆØ©", "Ù…ØºØ§ØºØ©", "Ø¨Ù†ÙŠ Ù…Ø²Ø§Ø±", "Ù…Ø·Ø§ÙŠ", "Ø³Ù…Ø§Ù„ÙˆØ·", "Ø£Ø¨Ùˆ Ù‚Ø±Ù‚Ø§Øµ", "Ù…Ù„ÙˆÙŠ", "Ø¯ÙŠØ± Ù…ÙˆØ§Ø³"],
            "Ø£Ø³ÙŠÙˆØ·": ["Ø£Ø³ÙŠÙˆØ·", "Ø£Ø³ÙŠÙˆØ· Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø¯ÙŠØ±ÙˆØ·", "Ø§Ù„Ù‚ÙˆØµÙŠØ©", "Ø£Ø¨Ù†ÙˆØ¨", "Ù…Ù†ÙÙ„ÙˆØ·", "Ø£Ø¨Ùˆ ØªÙŠØ¬", "Ø§Ù„ØºÙ†Ø§ÙŠÙ…", "Ø³Ø§Ø­Ù„ Ø³Ù„ÙŠÙ…", "Ø§Ù„Ø¨Ø¯Ø§Ø±ÙŠ", "ØµØ¯ÙØ§"],
            "Ø³ÙˆÙ‡Ø§Ø¬": ["Ø³ÙˆÙ‡Ø§Ø¬", "Ø³ÙˆÙ‡Ø§Ø¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø£Ø®Ù…ÙŠÙ…", "Ø£Ø®Ù…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø§Ù„Ø¨Ù„ÙŠÙ†Ø§", "Ø§Ù„Ù…Ø±Ø§ØºØ©", "Ø§Ù„Ù…Ù†Ø´Ø£Ø©", "Ø¯Ø§Ø± Ø§Ù„Ø³Ù„Ø§Ù…", "Ø¬Ø±Ø¬Ø§", "Ø¬Ù‡ÙŠÙ†Ø©", "Ø³Ø§Ù‚Ù„ØªØ©", "Ø·Ù…Ø§", "Ø·Ù‡Ø·Ø§"],
            "Ù‚Ù†Ø§": ["Ù‚Ù†Ø§", "Ù‚Ù†Ø§ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø£Ø¨Ùˆ ØªØ´Øª", "Ù†Ø¬Ø¹ Ø­Ù…Ø§Ø¯ÙŠ", "Ø¯Ø´Ù†Ø§", "Ø§Ù„ÙˆÙ‚Ù", "Ù‚ÙØ·", "Ù‚ÙˆØµ", "Ù†Ù‚Ø§Ø¯Ø©", "ÙØ±Ø´ÙˆØ·"],
            "Ø§Ù„Ø£Ù‚ØµØ±": ["Ø§Ù„Ø£Ù‚ØµØ±", "Ø¥Ø³Ù†Ø§", "Ø£Ø±Ù…Ù†Øª", "Ø§Ù„Ù‚Ø±Ù†Ø©", "Ø§Ù„Ø¨ÙŠØ§Ø¶ÙŠØ©", "Ø§Ù„Ø²ÙŠÙ†ÙŠØ©", "Ø§Ù„Ø·ÙˆØ¯"],
            "Ø£Ø³ÙˆØ§Ù†": ["Ø£Ø³ÙˆØ§Ù†", "Ø£Ø³ÙˆØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø¯Ø±Ø§Ùˆ", "ÙƒÙˆÙ… Ø£Ù…Ø¨Ùˆ", "Ù†ØµØ± Ø§Ù„Ù†ÙˆØ¨Ø©", "Ø¥Ø¯ÙÙˆ"],
            "Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±": ["Ø§Ù„ØºØ±Ø¯Ù‚Ø©", "Ø±Ø£Ø³ ØºØ§Ø±Ø¨", "Ø³ÙØ§Ø¬Ø§", "Ø§Ù„Ù‚ØµÙŠØ±", "Ù…Ø±Ø³Ù‰ Ø¹Ù„Ù…", "Ø´Ù„Ø§ØªÙŠÙ†", "Ø­Ù„Ø§ÙŠØ¨"],
            "Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯": ["Ø§Ù„Ø®Ø§Ø±Ø¬Ø©", "Ø§Ù„Ø¯Ø§Ø®Ù„Ø©", "Ø§Ù„ÙØ±Ø§ÙØ±Ø©", "Ø¨Ø§Ø±ÙŠØ³", "Ø¨Ù„Ø§Ø·"],
            "Ù…Ø·Ø±ÙˆØ­": ["Ù…Ø±Ø³Ù‰ Ù…Ø·Ø±ÙˆØ­", "Ø§Ù„Ø­Ù…Ø§Ù…", "Ø§Ù„Ø¹Ù„Ù…ÙŠÙ†", "Ø§Ù„Ø¶Ø¨Ø¹Ø©", "Ø§Ù„Ù†Ø¬ÙŠÙ„Ø©", "Ø³ÙŠØ¯ÙŠ Ø¨Ø±Ø§Ù†ÙŠ", "Ø§Ù„Ø³Ù„ÙˆÙ…", "Ø³ÙŠÙˆØ©"],
            "Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡": ["Ø§Ù„Ø¹Ø±ÙŠØ´", "Ø¨Ø¦Ø± Ø§Ù„Ø¹Ø¨Ø¯", "Ø§Ù„Ø´ÙŠØ® Ø²ÙˆÙŠØ¯", "Ø±ÙØ­", "Ø§Ù„Ø­Ø³Ù†Ø©", "Ù†Ø®Ù„"],
            "Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡": ["Ø§Ù„Ø·ÙˆØ±", "Ø´Ø±Ù… Ø§Ù„Ø´ÙŠØ®", "Ø¯Ù‡Ø¨", "Ù†ÙˆÙŠØ¨Ø¹", "Ø·Ø§Ø¨Ø§", "Ø³Ø§Ù†Øª ÙƒØ§ØªØ±ÙŠÙ†", "Ø£Ø¨Ùˆ Ø±Ø¯ÙŠØ³", "Ø£Ø¨Ùˆ Ø²Ù†ÙŠÙ…Ø©", "Ø±Ø£Ø³ Ø³Ø¯Ø±"]
        };

        const pwaManifest = {
            "name": "Ø§Ù„Ø³ÙˆÙ‚ ÙˆÙŠØ§Ùƒ",
            "short_name": "Ø§Ù„Ø³ÙˆÙ‚ ÙˆÙŠØ§Ùƒ",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#0f172a",
            "description": "Ù…ØªØ¬Ø± Ø§ÙƒØªØ±ÙˆÙ†ÙŠ Ø¹ØµØ±ÙŠ",
            "icons": [
                {
                    "src": "https://cdn-icons-png.flaticon.com/512/641/641813.png",
                    "sizes": "192x192",
                    "type": "image/png"
                },
                 {
                    "src": "https://cdn-icons-png.flaticon.com/512/641/641813.png",
                    "sizes": "512x512",
                    "type": "image/png"
                }
            ]
        };
        const stringManifest = JSON.stringify(pwaManifest);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        document.querySelector('#manifest-link').setAttribute('href', manifestURL);

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if(!localStorage.getItem('pwa_installed')) {
                document.getElementById('pwa-install-toast').classList.remove('hidden');
            }
        });

        window.installPWA = async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    localStorage.setItem('pwa_installed', 'true');
                }
                deferredPrompt = null;
                document.getElementById('pwa-install-toast').classList.add('hidden');
            }
        }

        window.closeInstall = () => {
            document.getElementById('pwa-install-toast').classList.add('hidden');
        }

        const firebaseConfig = {
          apiKey: "AIzaSyA5OiTcX95GBgiJoDHnY3y7N23o-j8hsQ8",
          authDomain: "services-cef84.firebaseapp.com",
          databaseURL: "https://services-cef84-default-rtdb.firebaseio.com",
          projectId: "services-cef84",
          storageBucket: "services-cef84.firebasestorage.app",
          messagingSenderId: "902396219187",
          appId: "1:902396219187:web:3ba084a724266afa8bb846"
        };

        const app = initializeApp(firebaseConfig); 
        const db = getFirestore(app); 
        const auth = getAuth(app);

        let state = { 
            user: null, 
            userData: null,
            listings: [], 
            images: [], 
            chatId: null, 
            chatStep: 0, 
            tempName: '', 
            activeAdminChat: null, 
            isAdmin: false, 
            welcomeSent: false, 
            favorites: [], 
            currentFilter: 'all', 
            currentItem: null, 
            currentView: 'home',
            lightboxImages: [], 
            lightboxIndex: 0,
            detailsSliderIndex: 0, 
            detailsSliderImages: [],
            authRole: 'customer',
            authType: 'login',
            authImageBase64: null,
            userRole: 'customer'
        };

        function initGovs() {
            const govSelect = document.getElementById('auth-gov');
            const filterGov = document.getElementById('filter-gov');
            // Populate Dropdowns
            govSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>';
            filterGov.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª</option>';
            
            Object.keys(EGYPT_DATA).forEach(gov => {
                govSelect.innerHTML += `<option value="${gov}">${gov}</option>`;
                filterGov.innerHTML += `<option value="${gov}">${gov}</option>`;
            });

            // REQ 4: Populate Multi-select checkboxes
            const shipContainer = document.getElementById('ship-gov-container');
            shipContainer.innerHTML = '';
            Object.keys(EGYPT_DATA).forEach(gov => {
                shipContainer.innerHTML += `
                    <label class="flex items-center gap-2 p-1.5 hover:bg-slate-50 dark:hover:bg-slate-700/50 rounded cursor-pointer">
                        <input type="checkbox" name="ship-gov-check" value="${gov}" class="chip-checkbox rounded border-gray-300 text-primary focus:ring-primary w-4 h-4">
                        <span class="text-xs font-medium text-slate-700 dark:text-slate-300">${gov}</span>
                    </label>
                `;
            });
        }
        initGovs();

        window.updateCities = () => {
            const gov = document.getElementById('auth-gov').value;
            const citySelect = document.getElementById('auth-city');
            citySelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²/Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</option>';
            if(gov && EGYPT_DATA[gov]) {
                EGYPT_DATA[gov].forEach(city => {
                    citySelect.innerHTML += `<option value="${city}">${city}</option>`;
                });
            }
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister();
                }
            });
        }

        function forceSwitchToApp() {
            const loginView = document.getElementById('login-view');
            const appContent = document.getElementById('app-content');
            loginView.classList.add('hidden');
            loginView.style.setProperty('display', 'none', 'important');
            appContent.classList.remove('hidden');
            document.getElementById('loader').classList.add('hidden'); 
        }

        onAuthStateChanged(auth, async (u) => { 
            if(u) { 
                state.user = u;
                forceSwitchToApp();
                try {
                    const userDoc = await getDoc(doc(db, "users", u.uid));
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        state.userData = data;
                        state.userRole = data.role || 'customer';
                        state.isAdmin = data.isAdmin === true;
                        document.getElementById('header-username').innerText = data.name || u.displayName;
                        document.getElementById('welcome-text').classList.remove('hidden');

                        if(state.isAdmin) {
                            document.getElementById('btn-admin-top').classList.remove('hidden');
                        } else {
                             document.getElementById('btn-admin-top').classList.add('hidden');
                        }
                    }
                } catch(e) {
                    console.warn("Role fetch failed", e);
                }

                loadListings(); 
                checkUserChat(); 
                initFavs(); 
                initCats(); 
            } else {
                state.user = null;
                const loginView = document.getElementById('login-view');
                loginView.classList.remove('hidden');
                loginView.style.removeProperty('display');
                document.getElementById('app-content').classList.add('hidden');
            }
        });

        window.setAuthRole = (role) => {
            state.authRole = role;
            const btnCust = document.getElementById('btn-role-customer');
            const btnMark = document.getElementById('btn-role-marketer');
            if (role === 'customer') {
                btnCust.className = "flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-navy dark:bg-primary text-white shadow-md";
                btnMark.className = "flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:bg-white dark:hover:bg-slate-700";
            } else {
                btnMark.className = "flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-navy dark:bg-primary text-white shadow-md";
                btnCust.className = "flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:bg-white dark:hover:bg-slate-700";
            }
        }

        window.setAuthType = (type) => {
            state.authType = type;
            const btnLogin = document.getElementById('btn-type-login');
            const btnSignup = document.getElementById('btn-type-signup');
            const actionBtn = document.getElementById('btn-auth-action');
            const imgField = document.getElementById('auth-image-field');
            const signupFields = document.getElementById('signup-fields');
            const usernameLabel = document.getElementById('lbl-username');

            if (type === 'login') {
                btnLogin.className = "flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-navy dark:bg-primary text-white shadow-md";
                btnSignup.className = "flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:text-navy dark:hover:text-white";
                actionBtn.innerHTML = `<span>Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø­Ø³Ø§Ø¨</span> <i data-lucide="arrow-left" class="w-4 h-4"></i>`;
                imgField.classList.add('hidden');
                imgField.classList.remove('flex');
                signupFields.classList.add('hidden');
                usernameLabel.innerText = "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ ÙÙ‚Ø· - Ù„Ù„Ø¯Ø®ÙˆÙ„)";
            } else {
                btnSignup.className = "flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-navy dark:bg-primary text-white shadow-md";
                btnLogin.className = "flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:text-navy dark:hover:text-white";
                actionBtn.innerHTML = `<span>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</span> <i data-lucide="plus-circle" class="w-4 h-4"></i>`;
                imgField.classList.remove('hidden');
                imgField.classList.add('flex');
                signupFields.classList.remove('hidden');
                usernameLabel.innerText = "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ ÙÙ‚Ø· - Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨)";
            }
            lucide.createIcons();
        }

        window.handleAuthImage = async (input) => {
            if (input.files && input.files[0]) {
                const c = await compress(input.files[0]);
                state.authImageBase64 = c;
                const preview = document.getElementById('auth-img-preview');
                const placeholder = document.getElementById('auth-img-placeholder');
                preview.src = c;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
            }
        }

        window.processAuth = async () => {
            const username = document.getElementById('auth-username').value.trim().toLowerCase();
            const pass = document.getElementById('auth-pass').value;
            const errDiv = document.getElementById('auth-error');
            const btn = document.getElementById('btn-auth-action');

            errDiv.classList.add('hidden');
            errDiv.innerText = "";
            
            if (!username || !pass) {
                errDiv.innerText = "ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±";
                errDiv.classList.remove('hidden');
                return;
            }

            const usernameRegex = /^[a-z0-9_]+$/;
            if (!usernameRegex.test(username)) {
                errDiv.innerText = "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø­Ø±ÙˆÙ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙˆØ£Ø±Ù‚Ø§Ù… ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§ÙØ§Øª)";
                errDiv.classList.remove('hidden');
                return;
            }

            if (pass.length < 6) {
                errDiv.innerText = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø±Ù‚Ø§Ù…/Ø­Ø±ÙˆÙ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„";
                errDiv.classList.remove('hidden');
                return;
            }

            const email = `${username}@souq.local`;
            const originalBtnText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<div class="spinner"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...`;

            try {
                let user;
                if (state.authType === 'signup') {
                    const nameAr = document.getElementById('auth-name-ar').value.trim();
                    const gov = document.getElementById('auth-gov').value;
                    const city = document.getElementById('auth-city').value;
                    const address = document.getElementById('auth-address').value.trim();

                    if (!nameAr || !gov || !city || !address) {
                        throw new Error("missing_fields");
                    }

                    const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                    user = userCredential.user;
                    
                    await updateProfile(user, { displayName: nameAr });

                    await setDoc(doc(db, "users", user.uid), {
                        username: username,
                        name: nameAr,
                        email: email,
                        role: state.authRole,
                        governorate: gov,
                        city: city,
                        address: address,
                        isAdmin: false,
                        isVerified: false,
                        image: state.authImageBase64 || null, 
                        createdAt: serverTimestamp()
                    });
                    
                    state.userRole = state.authRole;

                } else {
                    const uc = await signInWithEmailAndPassword(auth, email, pass);
                    user = uc.user;
                }
                
                btn.innerHTML = `ØªÙ… Ø¨Ù†Ø¬Ø§Ø­ <i data-lucide="check" class="w-4 h-4"></i>`;
                btn.classList.replace('bg-navy', 'bg-green-600');
                btn.classList.replace('dark:bg-primary', 'dark:bg-green-600');
                
                // REQ 9: Welcome Toast
                setTimeout(() => {
                    forceSwitchToApp();
                    showToast(`Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ${user.displayName || 'ØµØ¯ÙŠÙ‚ÙŠ'} ğŸ‘‹`, 's');
                }, 500);

            } catch (error) {
                console.error("Auth Error:", error);
                let msg = `Ø­Ø¯Ø« Ø®Ø·Ø£: ${error.code}`; 
                if(error.message === "missing_fields") msg = "ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØŒ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©ØŒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†)";
                else if(error.code === 'auth/email-already-in-use') msg = "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„. Ø§Ø®ØªØ± Ø§Ø³Ù…Ø§Ù‹ Ø¢Ø®Ø±.";
                else if(error.code === 'auth/wrong-password') msg = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
                else if(error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') msg = "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
                errDiv.innerText = msg;
                errDiv.classList.remove('hidden');
                btn.disabled = false;
                btn.innerHTML = originalBtnText;
                lucide.createIcons();
            }
        }

        window.logout = () => {
            signOut(auth).then(() => {
                window.location.reload();
            });
        }

        const CATEGORIES = [
            "Ù…Ù„Ø§Ø¨Ø³ Ø±Ø¬Ø§Ù„ÙŠ", "Ù…Ù„Ø§Ø¨Ø³ Ø­Ø±ÙŠÙ…ÙŠ", "Ù…Ù„Ø§Ø¨Ø³ Ø§Ø·ÙØ§Ù„", "Ø§Ø­Ø°ÙŠØ© Ø±Ø¬Ø§Ù„ÙŠ", "Ø§Ø­Ø°ÙŠØ© Ø­Ø±ÙŠÙ…ÙŠ", "Ø§Ø­Ø°ÙŠØ© Ø§Ø·ÙØ§Ù„", 
            "Ø§ÙƒØ³Ø³ÙˆØ±Ø§Øª Ø±Ø¬Ø§Ù„ÙŠ", "Ø§ÙƒØ³Ø³ÙˆØ±Ø§Øª Ø­Ø±ÙŠÙ…ÙŠ", "Ø§ÙƒØ³Ø³ÙˆØ±Ø§Øª Ø§Ø·ÙØ§Ù„", "Ø¨Ø±ÙØ§Ù†Ø§Øª Ø±Ø¬Ø§Ù„ÙŠ ÙˆØ­Ø±ÙŠÙ…ÙŠ", "Ø§Ù„Ø­Ù‚Ø§Ø¦Ø¨ Ø§Ù„Ø´Ø®ØµÙŠØ©",
            "Ø§Ù„Ù†Ø¸Ø§Ø±Ø§Øª", "Ù…Ø³ØªØ­Ø¶Ø±Ø§Øª Ø§Ù„ØªØ¬Ù…ÙŠÙ„", "Ø§Ø¯ÙˆØ§Øª Ø­Ù„Ø§Ù‚Ø© Ù„Ù„Ø±Ø¬Ø§Ù„", "Ù…ÙƒÙ…Ù„Ø§Øª ØºØ°Ø§Ø¦ÙŠØ©", "Ø§Ø¯ÙˆØ§Øª Ø±ÙŠØ§Ø¶ÙŠØ©",
            "Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø´Ø®ØµÙŠØ©", "Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ ÙˆØ§Ù„Ø§Ù„Ø¹Ø§Ø¨", "Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¹Ù†Ø§ÙŠØ© Ø¨Ø§Ù„Ø¨Ø´Ø±Ø©", "Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø§Ø·ÙØ§Ù„", "Ø§Ù‚Ù…Ø´Ø©"
        ];
        const USED_CATS = ["Ø§Ù„Ù†Ø¸Ø§Ø±Ø§Øª", "Ø§ÙƒØ³Ø³ÙˆØ±Ø§Øª Ø±Ø¬Ø§Ù„ÙŠ", "Ø§ÙƒØ³Ø³ÙˆØ±Ø§Øª Ø­Ø±ÙŠÙ…ÙŠ", "Ø§ÙƒØ³Ø³ÙˆØ±Ø§Øª Ø§Ø·ÙØ§Ù„"];
        
        // REQ 5: Expanded Smart Categories
        const CLOTHES_CATS = ["Ù…Ù„Ø§Ø¨Ø³ Ø±Ø¬Ø§Ù„ÙŠ", "Ù…Ù„Ø§Ø¨Ø³ Ø­Ø±ÙŠÙ…ÙŠ", "Ù…Ù„Ø§Ø¨Ø³ Ø§Ø·ÙØ§Ù„", "Ø§Ù‚Ù…Ø´Ø©"];
        const SHOES_CATS = ["Ø§Ø­Ø°ÙŠØ© Ø±Ø¬Ø§Ù„ÙŠ", "Ø§Ø­Ø°ÙŠØ© Ø­Ø±ÙŠÙ…ÙŠ", "Ø§Ø­Ø°ÙŠØ© Ø§Ø·ÙØ§Ù„"];
        const CLOTHES_SIZES = ["S", "M", "L", "XL", "2XL", "3XL", "4XL", "FreeSize"];
        const SHOES_SIZES = ["36", "37", "38", "39", "40", "41", "42", "43", "44", "45"];
        const BASIC_COLORS = ["Ø£Ø¨ÙŠØ¶", "Ø£Ø³ÙˆØ¯", "Ø±Ù…Ø§Ø¯ÙŠ", "ÙƒØ­Ù„ÙŠ", "Ø£Ø­Ù…Ø±", "Ø£Ø²Ø±Ù‚", "Ø¨ÙŠØ¬", "Ø£Ø®Ø¶Ø±", "Ø£ØµÙØ±", "Ø¨Ù†ÙŠ"];

         const CATEGORY_IMAGES = {
            "Ù…Ù„Ø§Ø¨Ø³ Ø±Ø¬Ø§Ù„ÙŠ": "https://images.unsplash.com/photo-1617137968427-85924c800a22?q=80&w=300&auto=format&fit=crop",
            "Ø¨Ø±ÙØ§Ù†Ø§Øª Ø±Ø¬Ø§Ù„ÙŠ ÙˆØ­Ø±ÙŠÙ…ÙŠ": "https://images.unsplash.com/photo-1541643600914-78b084683601?q=80&w=300&auto=format&fit=crop",
            "Ø§Ù„Ù†Ø¸Ø§Ø±Ø§Øª": "https://images.unsplash.com/photo-1572635196237-14b3f281503f?q=80&w=300&auto=format&fit=crop",
            "Ù…Ø³ØªØ­Ø¶Ø±Ø§Øª Ø§Ù„ØªØ¬Ù…ÙŠÙ„": "https://images.unsplash.com/photo-1596462502278-27bfdc403348?q=80&w=300&auto=format&fit=crop",
            "Ø§Ø¯ÙˆØ§Øª Ø­Ù„Ø§Ù‚Ø© Ù„Ù„Ø±Ø¬Ø§Ù„": "https://images.unsplash.com/photo-1621607512214-68297480165e?q=80&w=300&auto=format&fit=crop",
            "Ù…ÙƒÙ…Ù„Ø§Øª ØºØ°Ø§Ø¦ÙŠØ©": "https://images.unsplash.com/photo-1581009137042-c552e485697a?q=80&w=300&auto=format&fit=crop",
            "Ø§Ø­Ø°ÙŠØ© Ø­Ø±ÙŠÙ…ÙŠ": "https://images.unsplash.com/photo-1549298916-b41d501d3772?q=80&w=300&auto=format&fit=crop",
            "Ø§Ø¯ÙˆØ§Øª Ø±ÙŠØ§Ø¶ÙŠØ©": "https://images.unsplash.com/photo-1517836357463-d25dfeac3438?q=80&w=300&auto=format&fit=crop",
            "Ù…Ù„Ø§Ø¨Ø³ Ø­Ø±ÙŠÙ…ÙŠ": "https://images.pexels.com/photos/3772506/pexels-photo-3772506.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
            "Ø§Ø­Ø°ÙŠØ© Ø±Ø¬Ø§Ù„ÙŠ": "https://images.pexels.com/photos/5264901/pexels-photo-5264901.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
            "Ø§Ø­Ø°ÙŠØ© Ø§Ø·ÙØ§Ù„": "https://images.pexels.com/photos/29737094/pexels-photo-29737094.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
            "Ù…Ù„Ø§Ø¨Ø³ Ø§Ø·ÙØ§Ù„": "https://images.pexels.com/photos/1620758/pexels-photo-1620758.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
            "Ø§ÙƒØ³Ø³ÙˆØ±Ø§Øª Ø±Ø¬Ø§Ù„ÙŠ": "https://images.pexels.com/photos/3766112/pexels-photo-3766112.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
            "Ø§ÙƒØ³Ø³ÙˆØ±Ø§Øª Ø­Ø±ÙŠÙ…ÙŠ": "https://images.pexels.com/photos/17568000/pexels-photo-17568000.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
            "Ø§ÙƒØ³Ø³ÙˆØ±Ø§Øª Ø§Ø·ÙØ§Ù„": "https://images.pexels.com/photos/2848522/pexels-photo-2848522.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
            "Ø§Ù„Ø­Ù‚Ø§Ø¦Ø¨ Ø§Ù„Ø´Ø®ØµÙŠØ©": "https://images.pexels.com/photos/1986996/pexels-photo-1986996.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
            "Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø´Ø®ØµÙŠØ©": "https://images.pexels.com/photos/19066549/pexels-photo-19066549.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
            "Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ ÙˆØ§Ù„Ø§Ù„Ø¹Ø§Ø¨": "https://images.pexels.com/photos/4491662/pexels-photo-4491662.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
            "Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¹Ù†Ø§ÙŠØ© Ø¨Ø§Ù„Ø¨Ø´Ø±Ø©": "https://images.pexels.com/photos/10117729/pexels-photo-10117729.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
            "Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø§Ø·ÙØ§Ù„": "https://images.pexels.com/photos/26337029/pexels-photo-26337029.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
            "Ø§Ù‚Ù…Ø´Ø©": "https://images.pexels.com/photos/34636582/pexels-photo-34636582.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop"
        };

        function preloadCategoryImages() {
            Object.values(CATEGORY_IMAGES).forEach(url => {
                const img = new Image();
                img.src = url;
            });
        }
        preloadCategoryImages();

        function initCats() {
            const cont = document.getElementById('categories-container');
            cont.innerHTML = `<button onclick="filter('all')" id="chip-all" class="chip-btn">Ø§Ù„ÙƒÙ„</button>`;
            const sel = document.getElementById('in-cat');
            sel.innerHTML = '';
            CATEGORIES.forEach(c => {
                const btn = document.createElement('button'); 
                btn.innerText = c; 
                btn.id = `chip-${c.replace(/\s/g, '')}`;
                btn.className = "px-4 py-1.5 rounded-full bg-white dark:bg-darkbg border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-300 text-xs font-bold whitespace-nowrap transition hover:border-primary hover:text-primary chip-btn";
                btn.onclick = () => filter(c); 
                cont.appendChild(btn);
                const opt = document.createElement('option'); 
                opt.value = c; 
                opt.innerText = c; 
                sel.appendChild(opt);
            });
        }

        function renderView() {
            const searchInput = document.getElementById('search-input');
            const catContainer = document.getElementById('categories-container');
            const searchContainer = document.getElementById('search-container');
            const viewHeader = document.getElementById('view-header');
            const gridContainer = document.getElementById('grid-container');
            const filterBtn = document.getElementById('btn-filter-toggle');
            const filterPanel = document.getElementById('filter-panel');

            filterPanel.classList.add('hidden');

            if (state.currentView === 'home') {
                viewHeader.classList.add('hidden');
                catContainer.classList.add('hidden');
                filterBtn.classList.add('hidden'); 
                searchContainer.classList.remove('hidden');
                gridContainer.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 pb-10 mt-4';
                searchInput.placeholder = 'Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ø³Ù…...';
                renderCategoryCards();
            } else if (state.currentView === 'category') {
                viewHeader.classList.remove('hidden');
                const title = state.currentFilter === 'all' ? 'ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª' : (state.currentFilter === 'fav' ? 'Ø§Ù„Ù…ÙØ¶Ù„Ø©' : state.currentFilter);
                document.getElementById('view-title').innerText = title;

                if (state.currentFilter === 'fav') {
                    searchContainer.classList.add('hidden');
                    catContainer.classList.add('hidden');
                } else {
                    searchContainer.classList.remove('hidden');
                    filterBtn.classList.remove('hidden'); 
                    searchInput.placeholder = 'Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬...';
                    if (state.currentFilter === 'all') {
                        catContainer.classList.remove('hidden');
                    } else {
                        catContainer.classList.add('hidden');
                    }
                }

                gridContainer.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 pb-10';
                filter(state.currentFilter);
            }
            lucide.createIcons();
        }

        window.toggleFilterPanel = () => {
             document.getElementById('filter-panel').classList.toggle('hidden');
        }

        window.applyFilters = () => {
            renderProducts();
        }

        window.resetFilters = () => {
            document.getElementById('search-input').value = '';
            document.getElementById('filter-price').value = '';
            document.getElementById('filter-gov').value = '';
            if (state.currentView === 'category') {
                renderProducts();
            } else {
                renderCategoryCards();
            }
        };

        window.switchToCategoryView = (category) => {
            state.currentView = 'category';
            state.currentFilter = category;
            document.getElementById('search-input').value = '';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            renderView();
        }

        window.switchToHomeView = () => {
            state.currentView = 'home';
            state.currentFilter = 'all';
            document.getElementById('search-input').value = '';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            renderView();
            const url = new URL(window.location);
            url.searchParams.delete('product_id');
            window.history.replaceState({}, '', url);
        }

        function renderCategoryCards() {
            const cont = document.getElementById('grid-container');
            const q = normalizeText(document.getElementById('search-input').value);
            cont.innerHTML = '';
            const filteredCats = CATEGORIES.filter(c => normalizeText(c).includes(q));

            if (!filteredCats.length) {
                document.getElementById('empty-state').classList.remove('hidden');
            } else {
                document.getElementById('empty-state').classList.add('hidden');
                filteredCats.forEach(cat => {
                    const imageUrl = CATEGORY_IMAGES[cat] || 'https://images.unsplash.com/photo-1523275335684-37898b6baf30?q=80&w=300&auto=format&fit=crop';
                    cont.innerHTML += `
                        <div onclick="switchToCategoryView('${cat}')" class="relative rounded-xl overflow-hidden shadow-sm border-2 border-black dark:border-slate-700 h-28 cursor-pointer active:scale-95 transition-transform group flex items-center justify-center text-center p-2">
                            <img src="${imageUrl}" class="absolute inset-0 w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" loading="lazy">
                            <div class="absolute inset-0 bg-black/50"></div>
                            <h3 class="relative z-10 font-bold text-white text-sm drop-shadow-md">${cat}</h3>
                        </div>`;
                });
            }
        }

        function loadListings() { 
            showSkeletons(); 
            onSnapshot(query(collection(db, "listings")), (snap) => { 
                state.listings = []; 
                snap.forEach(d => state.listings.push({id: d.id, ...d.data()})); 
                state.listings.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); 

                const params = new URLSearchParams(window.location.search);
                const linkedProdId = params.get('product_id');
                if(linkedProdId && !state.currentItem) {
                   const item = state.listings.find(i => i.id === linkedProdId);
                   if(item) openDetails(item.id);
                }
                renderView();
            }); 
        }

        window.handleSearch = () => {
            if (state.currentView === 'home') {
                renderCategoryCards();
            } else {
                renderProducts();
            }
        };

        window.filter = (type) => { 
            state.currentFilter = type; 
            document.querySelectorAll('#categories-container .chip-btn').forEach(btn => {
                btn.className = "px-4 py-1.5 rounded-full bg-white dark:bg-darkbg border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-300 text-xs font-bold whitespace-nowrap transition hover:border-primary hover:text-primary chip-btn";
            });
            const activeId = type === 'all' ? 'chip-all' : `chip-${type.replace(/\s/g, '')}`;
            const activeBtn = document.getElementById(activeId);
            if(activeBtn) {
                activeBtn.className = "px-5 py-1.5 rounded-full bg-navy dark:bg-primary text-white text-xs font-bold shadow whitespace-nowrap transform scale-105 transition chip-btn";
                activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
            if (state.currentView !== 'category') {
                state.currentView = 'category';
            }
            const title = type === 'all' ? 'ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª' : (type === 'fav' ? 'Ø§Ù„Ù…ÙØ¶Ù„Ø©' : type);
            document.getElementById('view-title').innerText = title;
            renderProducts(); 
        };

        function renderProducts() {
            const q = normalizeText(document.getElementById('search-input').value);
            const priceFilter = document.getElementById('filter-price').value;
            const govFilter = document.getElementById('filter-gov').value;

            const cont = document.getElementById('grid-container'); 
            cont.innerHTML = ''; 

            let filtered = state.listings.filter(item => { 
                let matchType = true; 
                if (state.currentFilter === 'fav') {
                    matchType = (state.favorites || []).includes(item.id);
                } else {
                    matchType = state.currentFilter === 'all' || item.category === state.currentFilter; 
                }
                const matchText = normalizeText(item.title).includes(q) || normalizeText(item.category || '').includes(q); 
                
                let matchGov = true;
                if(govFilter && item.governorate) {
                    matchGov = item.governorate === govFilter;
                }

                return matchType && matchText && matchGov; 
            }); 

            if (priceFilter === 'low') {
                filtered.sort((a, b) => a.price - b.price);
            } else if (priceFilter === 'high') {
                filtered.sort((a, b) => b.price - a.price);
            }

            if(!filtered.length) {
                document.getElementById('empty-state').classList.remove('hidden'); 
            } else { 
                document.getElementById('empty-state').classList.add('hidden'); 
                filtered.forEach(item => cont.innerHTML += createCard(item)); 
            } 
            lucide.createIcons(); 
        }

        function createCard(item) {
            const imgs = Array.isArray(item.images)?item.images:[item.image];
            const isFav = (state.favorites || []).includes(item.id);
            const heartClass = isFav ? "fill-red-500 text-red-500" : "text-white";
            const isOwner = state.user && state.user.uid === item.authorId;
            let badge = item.badge==='hot' ? `<span class="absolute top-1 left-1 bg-orange-500 text-white text-[9px] font-bold px-2 py-0.5 rounded shadow animate-pulse z-10">ğŸ”¥ Ø¹Ø±Ø¶</span>` : '';
            let statusOverlay = ''; let isClickable = true; 
            if(item.status && item.status !== 'available') { 
                isClickable = false; 
                const txt = item.status==='sold'?'ØªÙ… Ø§Ù„Ø¨ÙŠØ¹':'ØºÙŠØ± Ù…ØªØ§Ø­'; 
                statusOverlay=`<div class="absolute inset-0 z-20 bg-white/80 dark:bg-black/80 backdrop-blur-sm flex items-center justify-center"><span class="bg-red-600 text-white font-bold px-4 py-2 rounded-xl shadow-xl transform -rotate-12 text-sm">${txt}</span></div>`; 
            }
            const showControls = state.isAdmin || isOwner;
            const controls = showControls ? `<div class="absolute top-1 right-1 z-20 flex gap-1"><button onclick="del(event,'${item.id}')" class="bg-white/80 text-red-500 p-1 rounded shadow"><i data-lucide="trash-2" class="w-3 h-3"></i></button><button onclick="toggleStatus(event,'${item.id}','${item.status||'available'}')" class="bg-white/80 text-blue-600 p-1 rounded shadow"><i data-lucide="edit-3" class="w-3 h-3"></i></button></div>` : '';

            return `<div class="bg-white dark:bg-slate-800 rounded-lg overflow-hidden shadow-sm border-2 border-black dark:border-slate-700 flex flex-col h-full cursor-pointer active:scale-95 transition-transform group relative" onclick="${isClickable ? `openDetails('${item.id}')` : ''}"><div class="relative w-full h-32 sm:h-40 bg-gray-200 dark:bg-slate-700">${statusOverlay} ${controls} ${!showControls && !statusOverlay ? badge : ''}<button onclick="toggleFav(event, '${item.id}')" class="absolute top-1 left-1 z-20 p-1.5 rounded-full bg-black/20 hover:bg-black/40"><i data-lucide="heart" class="w-4 h-4 ${heartClass}"></i></button>${imgs.length > 1 ? `<button onclick="scrollCard(event, '${item.id}', -1)" class="absolute right-1 top-1/2 -translate-y-1/2 bg-black/20 hover:bg-black/40 text-white p-1 rounded-full z-10 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="chevron-right" class="w-4 h-4"></i></button><button onclick="scrollCard(event, '${item.id}', 1)" class="absolute left-1 top-1/2 -translate-y-1/2 bg-black/20 hover:bg-black/40 text-white p-1 rounded-full z-10 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>` : ''}<div id="slider-${item.id}" class="flex w-full h-full overflow-x-auto no-scrollbar snap-x snap-mandatory scroll-smooth">${imgs.map(src => `<img src="${src}" class="w-full h-full object-cover shrink-0 snap-center ${statusOverlay?'grayscale':''}" loading="lazy">`).join('')}</div><span class="absolute bottom-1 right-1 bg-white/90 dark:bg-black/60 text-slate-800 dark:text-white px-2 py-0.5 rounded text-[9px] font-bold shadow z-10">${item.category}</span></div><div class="p-2 flex-1 flex flex-col"><div class="flex justify-between items-start mb-1"><h3 class="font-bold text-slate-900 dark:text-white text-xs line-clamp-1">${item.title}</h3><span class="font-black text-primary text-xs whitespace-nowrap">${Number(item.price).toLocaleString()} Ø¬.Ù…</span></div><div class="text-[10px] text-slate-500 dark:text-slate-400 mb-2 flex gap-1 items-center"><span class="bg-slate-100 dark:bg-white/5 px-1.5 rounded">${item.condition==='new'?'Ø¬Ø¯ÙŠØ¯':(item.condition==='openbox'?'ÙƒØ³Ø± Ø²ÙŠØ±Ùˆ':'Ù…Ø³ØªØ¹Ù…Ù„')}</span></div><div class="mt-auto flex gap-1 pt-2 border-t border-slate-100 dark:border-slate-700"><a href="https://wa.me/20${item.phone}" target="_blank" onclick="event.stopPropagation()" class="flex-1 bg-primary text-white py-1.5 rounded flex justify-center items-center gap-1 text-[10px] font-bold"><i data-lucide="message-circle" class="w-3 h-3"></i> ÙˆØ§ØªØ³</a></div></div></div>`;
        }

        function goToDetailsSlide(index, behavior = 'auto') {
            const total = state.detailsSliderImages.length;
            if (total === 0) return;
            if (index < 0) index = total - 1;
            if (index >= total) index = 0;
            state.detailsSliderIndex = index;
            const imgEl = document.getElementById('details-img');
            if (imgEl) {
                imgEl.src = state.detailsSliderImages[state.detailsSliderIndex];
            }
            updateSliderDots();
        }

        window.scrollDetails = (dir) => { 
            const total = state.detailsSliderImages.length;
            if (total <= 1) return;
            let dirAmount = -dir;
            let newIndex = state.detailsSliderIndex + dirAmount;
            goToDetailsSlide(newIndex);
        }

        function updateSliderDots() {
            if (state.detailsSliderImages.length <= 1) return;
            for (let i = 0; i < state.detailsSliderImages.length; i++) {
                const dot = document.getElementById(`dot-${i}`);
                if (dot) {
                    dot.className = i === state.detailsSliderIndex 
                        ? 'w-4 h-2 rounded-full bg-white shadow transition-all' 
                        : 'w-2 h-2 rounded-full bg-white/40 transition-all';
                }
            }
        }

        window.copyDetails = () => {
            if(!state.currentItem) return;
            
            const text = `Ø§Ù„Ù…Ù†ØªØ¬: ${state.currentItem.title}\nØ§Ù„Ø³Ø¹Ø±: ${Number(state.currentItem.price).toLocaleString()} Ø¬.Ù…\nØ§Ù„ÙˆØµÙ: ${state.currentItem.desc}\nÙ„Ù„ØªÙˆØ§ØµÙ„: ${state.currentItem.phone}`;
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('ØªÙ… Ù†Ø³Ø® Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…');
            }).catch(err => {
                showToast('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®', 'e');
            });
        }

        window.openDetails = async (id) => {
            const item = state.listings.find(i => i.id === id); if(!item) return;
            state.currentItem = item; 
            document.getElementById('d-title').innerText = item.title; 
            document.getElementById('d-price').innerText = Number(item.price).toLocaleString() + ' Ø¬.Ù…'; 
            document.getElementById('d-cat').innerText = item.category; 
            document.getElementById('d-desc').innerText = item.desc;
            document.getElementById('d-cond').innerText = item.condition === 'new' ? 'Ø¬Ø¯ÙŠØ¯' : (item.condition === 'openbox' ? 'ÙƒØ³Ø± Ø²ÙŠØ±Ùˆ' : 'Ù…Ø³ØªØ¹Ù…Ù„');

            // REQ 1 & 6: Publisher Info & Verified Badge
            const pubName = document.getElementById('d-pub-name');
            const pubImg = document.getElementById('d-pub-img');
            const verifiedBadge = document.getElementById('d-verified-badge');
            
            pubName.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
            verifiedBadge.classList.add('hidden'); // Hide initially
            
            try {
                const uSnap = await getDoc(doc(db, "users", item.authorId));
                if(uSnap.exists()) {
                    const uData = uSnap.data();
                    pubName.innerText = uData.name || "Ù…Ø³ØªØ®Ø¯Ù…";
                    if(uData.image) {
                        pubImg.innerHTML = `<img src="${uData.image}" class="w-full h-full object-cover">`;
                    } else {
                        pubImg.innerHTML = `<i data-lucide="user" class="w-6 h-6 text-slate-400"></i>`;
                    }
                    if(uData.isVerified) {
                        verifiedBadge.classList.remove('hidden');
                    }
                } else {
                    pubName.innerText = "Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
                }
            } catch(e) {
                pubName.innerText = "Ù†Ø§Ø´Ø±";
            }

            const featuresCont = document.getElementById('d-features'); 
            featuresCont.innerHTML=''; 
            
            // REQ 1: Combined Size & Color Fields
            const combinedCont = document.getElementById('d-combined-fields');
            combinedCont.innerHTML = '';

            if(item.size) {
                 const sizeVal = Array.isArray(item.size) ? item.size.join(' - ') : item.size;
                 combinedCont.innerHTML += `
                    <div class="flex items-center text-sm p-2 bg-slate-50 dark:bg-slate-800 border border-slate-100 dark:border-slate-700 rounded-lg">
                        <span class="w-20 font-bold text-slate-500">Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª:</span>
                        <span class="font-bold text-slate-900 dark:text-white flex-1">${sizeVal}</span>
                    </div>`;
            }
            if(item.color) {
                 const colorVal = Array.isArray(item.color) ? item.color.join(' - ') : item.color;
                 combinedCont.innerHTML += `
                    <div class="flex items-center text-sm p-2 bg-slate-50 dark:bg-slate-800 border border-slate-100 dark:border-slate-700 rounded-lg">
                        <span class="w-20 font-bold text-slate-500">Ø§Ù„Ø£Ù„ÙˆØ§Ù†:</span>
                        <span class="font-bold text-slate-900 dark:text-white flex-1">${colorVal}</span>
                    </div>`;
            }

            if(item.features) item.features.forEach(a => featuresCont.innerHTML += `<span class="bg-blue-50 text-blue-600 dark:bg-blue-900/30 dark:text-blue-300 px-2 py-1 rounded text-[10px] font-bold border border-blue-100 dark:border-blue-900">${a}</span>`);
            
            // REQ 1: Shipping Icon & Info
            const shipInfo = document.getElementById('d-shipping-info');
            if(item.shippingMode === 'specific' && item.shippingGov) {
                const govs = Array.isArray(item.shippingGov) ? item.shippingGov.join('ØŒ ') : item.shippingGov;
                shipInfo.innerHTML = `<i data-lucide="truck" class="w-5 h-5 text-primary"></i> <span class="flex-1">Ø´Ø­Ù† Ù…ØªØ§Ø­ Ù„Ù€: ${govs}</span>`;
            } else {
                shipInfo.innerHTML = `<i data-lucide="globe" class="w-5 h-5 text-primary"></i> <span class="flex-1">Ø´Ø­Ù† Ù…ØªØ§Ø­ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª</span>`;
            }

            document.getElementById('d-wa').href = `https://wa.me/20${item.phone}?text=Ø§Ø³ØªÙØ³Ø§Ø± Ø¨Ø®ØµÙˆØµ: ${item.title}`; 
            document.getElementById('d-call').href = `tel:${item.phone}`;

            const imgs = Array.isArray(item.images) ? item.images : [item.image]; 
            state.detailsSliderImages = imgs; 
            state.detailsSliderIndex = 0;   

            const dotsContainer = document.getElementById('details-dots');
            const imgEl = document.getElementById('details-img');
            if (imgEl) {
                imgEl.src = imgs.length > 0 ? imgs[0] : 'https://placehold.co/400x300/e2e8f0/94a3b8?text=No+Image';
                imgEl.onclick = () => openLightbox(imgEl.src); 
            }

            dotsContainer.innerHTML = ''; 
            if (imgs.length > 1) {
                dotsContainer.innerHTML = imgs.map((_, index) => 
                    `<span id="dot-${index}" class="w-2 h-2 rounded-full bg-white/40 transition-all"></span>`
                ).join('');
            }

            document.getElementById('details-arrows').style.display = imgs.length > 1 ? 'block' : 'none';
            toggleModal('details-modal'); 
            goToDetailsSlide(0, 'auto'); 
            lucide.createIcons();

            const url = new URL(window.location);
            url.searchParams.set('product_id', id);
            window.history.replaceState({}, '', url);
        }

        window.closeDetails = () => {
             toggleModal('details-modal');
             state.currentItem = null; 
             document.getElementById('details-dots').innerHTML = ''; 
             const imgEl = document.getElementById('details-img');
             if (imgEl) { imgEl.src = ''; }
             const url = new URL(window.location);
             url.searchParams.delete('product_id');
             window.history.replaceState({}, '', url);
        }

        function initFavs() { try { state.favorites = JSON.parse(localStorage.getItem('souq_favs') || '[]'); } catch(e){ state.favorites = []; } updateFavBadge(); }
        window.toggleFav = (e, id) => { e.stopPropagation(); if(state.favorites.includes(id)) state.favorites = state.favorites.filter(i => i !== id); else state.favorites.push(id); localStorage.setItem('souq_favs', JSON.stringify(state.favorites)); updateFavBadge(); if(state.currentView === 'category') renderProducts(); };
        function updateFavBadge() { const b = document.getElementById('fav-count'); if(b){ if(state.favorites.length) b.classList.remove('hidden'); else b.classList.add('hidden'); }}
        window.toggleFavView = () => { 
            state.currentView = 'category';
            state.currentFilter = 'fav';
            renderView();
            showToast("Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙØ¶Ù„Ø© â¤ï¸"); 
        };

        window.updateFormFields = () => {
            const cat = document.getElementById('in-cat').value;
            document.getElementById('field-condition').classList.toggle('hidden', !USED_CATS.includes(cat));
            
            // Smart Chips Visibility
            const isClothes = CLOTHES_CATS.includes(cat);
            const isShoes = SHOES_CATS.includes(cat);
            
            const sizeContainer = document.getElementById('field-size-chips');
            const sizeChips = document.getElementById('size-chips-container');
            const colorContainer = document.getElementById('field-color-chips');
            const colorChips = document.getElementById('color-chips-container');

            sizeContainer.classList.add('hidden');
            colorContainer.classList.add('hidden');
            sizeChips.innerHTML = '';
            colorChips.innerHTML = '';

            if (isClothes || isShoes) {
                sizeContainer.classList.remove('hidden');
                const sizes = isClothes ? CLOTHES_SIZES : SHOES_SIZES;
                sizes.forEach(s => {
                    sizeChips.innerHTML += `<label class="cursor-pointer"><input type="checkbox" name="smart-size" value="${s}" class="smart-option hidden"><div class="px-2.5 py-1 rounded-md border border-slate-300 dark:border-slate-600 font-bold text-xs text-slate-500 hover:border-navy transition">${s}</div></label>`;
                });
            }

            if (isClothes) {
                colorContainer.classList.remove('hidden');
                BASIC_COLORS.forEach(c => {
                    colorChips.innerHTML += `<label class="cursor-pointer"><input type="checkbox" name="smart-color" value="${c}" class="smart-option hidden"><div class="px-2.5 py-1 rounded-md border border-slate-300 dark:border-slate-600 font-bold text-xs text-slate-500 hover:border-navy transition">${c}</div></label>`;
                });
            }
        }

        // REQ 4: Toggle Shipping Container
        window.toggleShipGov = () => {
             const mode = document.querySelector('input[name="ship-mode"]:checked').value;
             const container = document.getElementById('ship-gov-container');
             if(mode === 'specific') {
                 container.classList.remove('hidden');
             } else {
                 container.classList.add('hidden');
             }
        }

        window.submitListing=async()=>{
            if(!state.images.length)return showToast('Ù…Ø·Ù„ÙˆØ¨ ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„','e');
            const btn = document.getElementById('btn-publish');
            btn.disabled = true;
            btn.innerHTML = '<span>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø´Ø±...</span>';
            const bdg=document.querySelector('input[name="badge"]:checked').value;
            const cond=document.getElementById('in-condition').value;
            const cat=document.getElementById('in-cat').value;
            const feats=[]; document.querySelectorAll('.chip-checkbox:checked').forEach(c=>feats.push(c.value));
            
            // Gather Smart Chips Data
            const sizes = []; document.querySelectorAll('input[name="smart-size"]:checked').forEach(c => sizes.push(c.value));
            const colors = []; document.querySelectorAll('input[name="smart-color"]:checked').forEach(c => colors.push(c.value));
            
            // REQ 4: Gather Multi-Shipping Data
            const shipMode = document.querySelector('input[name="ship-mode"]:checked').value;
            let shipGovs = [];
            if (shipMode === 'specific') {
                document.querySelectorAll('input[name="ship-gov-check"]:checked').forEach(c => shipGovs.push(c.value));
                if(shipGovs.length === 0) {
                     showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø­Ø§ÙØ¸Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø´Ø­Ù†', 'e');
                     btn.disabled = false;
                     btn.innerHTML = '<span>Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬</span><i data-lucide="arrow-left" class="w-4 h-4"></i>';
                     return;
                }
            }

            const userGov = state.userData ? state.userData.governorate : '';

            await addDoc(collection(db,"listings"),{
                title:document.getElementById('in-title').value,
                price:Number(document.getElementById('in-price').value),
                category:cat,
                condition:cond,
                size: sizes.length > 0 ? sizes : null, 
                color: colors.length > 0 ? colors : null,
                shippingMode: shipMode,
                shippingGov: shipMode === 'specific' ? shipGovs : null, // Array of govs
                phone:document.getElementById('in-phone').value,
                desc:document.getElementById('in-desc').value,
                features:feats,
                images:state.images,
                badge:bdg,
                status:'available',
                governorate: userGov,
                createdAt:serverTimestamp(),
                authorId:state.user.uid
            });
            showToast('ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­');
            toggleAddModal();
            btn.disabled = false;
            btn.innerHTML = '<span>Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬</span><i data-lucide="arrow-left" class="w-4 h-4"></i>';
            lucide.createIcons();
        };

        window.del=async(e,id)=>{e.stopPropagation();if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')){await deleteDoc(doc(db,"listings",id));showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­')}};
        window.toggleStatus=async(e,id,currentStatus)=>{e.stopPropagation();let nextStatus=currentStatus==='available'?'sold':'available';await updateDoc(doc(db,"listings",id),{status:nextStatus});showToast(`ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰: ${nextStatus==='available'?'Ù…ØªØ§Ø­':'Ù…ÙØ¨Ø§Ø¹'}`)};

        window.toggleDarkMode = () => { 
            document.documentElement.classList.toggle('dark'); 
            localStorage.setItem('souq_theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); 
        }
        if(localStorage.getItem('souq_theme') === 'dark') document.documentElement.classList.add('dark');

        window.showToast=(m,t='s')=>{const d=document.createElement('div');d.className=`toast fixed top-4 left-1/2 -translate-x-1/2 bg-white dark:bg-slate-800 shadow-xl px-4 py-2 rounded-lg border border-${t==='e'?'red':'primary'}-500 flex items-center gap-2 text-xs font-bold z-[100] text-slate-800 dark:text-white`;d.innerHTML=`<i data-lucide="${t==='e'?'alert-circle':'check-circle'}" class="w-4 h-4 text-${t==='e'?'red':'primary'}-500"></i> ${m}`;document.getElementById('toast-container').appendChild(d);lucide.createIcons();setTimeout(()=>{d.classList.add('hiding');setTimeout(()=>d.remove(),300)},3000)};
        function normalizeText(t) { return t.replace(/[Ø£Ø¥Ø¢]/g,'Ø§').replace(/Ø©/g,'Ù‡').replace(/Ù‰/g,'ÙŠ').toLowerCase(); }
        function showSkeletons() { const c=document.getElementById('grid-container'); c.innerHTML=''; for(let i=0;i<8;i++) c.innerHTML+=`<div class="bg-white dark:bg-slate-800 rounded-lg overflow-hidden shadow-sm border-2 border-slate-200 dark:border-slate-700 h-full"><div class="h-32 skeleton"></div><div class="p-2 space-y-2"><div class="h-4 rounded skeleton w-3/4"></div><div class="h-3 rounded skeleton w-1/2"></div></div></div>`; }

        window.shareListing = async () => { 
            if(!state.currentItem) return; 
            const directLink = `${window.location.origin}${window.location.pathname}?product_id=${state.currentItem.id}`;
            const d = { title: 'Ø§Ù„Ø³ÙˆÙ‚ ÙˆÙŠØ§Ùƒ', text: `Ø´Ø§Ù‡Ø¯ Ø§Ù„Ù…Ù†ØªØ¬: ${state.currentItem.title}`, url: directLink }; 
            try { await navigator.share(d); showToast('ØªÙ…Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­'); } catch(e) { navigator.clipboard.writeText(d.url); showToast('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·'); } 
        };

        window.scrollCard = (e, id, dir) => { 
            e.stopPropagation(); 
            const s = document.getElementById(`slider-${id}`);
            if (!s) return;
            const totalImages = s.children.length;
            if (totalImages <= 1) return;
            const imgWidth = s.clientWidth;
            let currentIndex = Math.round(s.scrollLeft / imgWidth);
            let nextIndex = currentIndex - dir; 
            if (nextIndex >= totalImages) { nextIndex = 0; } else if (nextIndex < 0) { nextIndex = totalImages - 1; }
            s.scrollTo({ left: nextIndex * imgWidth, behavior: 'smooth' });
        }

        window.openLightbox = (src) => {
            if (!src || src.endsWith('?text=No+Image')) return; 
            if(state.currentItem && document.getElementById('details-modal').classList.contains('hidden') === false) {
                 state.lightboxImages = state.detailsSliderImages;
            } else {
                 state.lightboxImages = state.detailsSliderImages.length ? state.detailsSliderImages : [];
                 if(!state.lightboxImages.length && state.currentItem) {
                     state.lightboxImages = Array.isArray(state.currentItem.images) ? state.currentItem.images : [state.currentItem.image].filter(Boolean);
                 }
            }
            state.lightboxIndex = state.lightboxImages.indexOf(src);
            if (state.lightboxIndex === -1) state.lightboxIndex = 0; 
            if (state.lightboxImages.length > 0) {
                document.getElementById('lightbox-img').src = state.lightboxImages[state.lightboxIndex];
                document.getElementById('lightbox').classList.remove('hidden');
                lucide.createIcons(); 
            }
        }

        window.navigateLightbox = (dir) => {
            if (!state.lightboxImages.length) return;
            state.lightboxIndex += dir;
            if (state.lightboxIndex >= state.lightboxImages.length) {
                state.lightboxIndex = 0;
            } else if (state.lightboxIndex < 0) {
                state.lightboxIndex = state.lightboxImages.length - 1;
            }
            document.getElementById('lightbox-img').src = state.lightboxImages[state.lightboxIndex];
        }

        window.closeLightbox = () => {
            document.getElementById('lightbox').classList.add('hidden');
            state.lightboxImages = [];
            state.lightboxIndex = 0;
        }

        function toggleModal(id) { const m=document.getElementById(id); m.classList.toggle('hidden'); if(!m.classList.contains('hidden')) document.body.style.overflow='hidden'; else document.body.style.overflow=''; return !m.classList.contains('hidden'); }

        window.toggleAddModal=()=>{
            if(state.userRole !== 'marketer') {
                if(confirm("Ø¹ÙÙˆØ§Ù‹ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„ØºÙŠØ± Ø§Ù„Ù…Ø³ÙˆÙ‚ÙŠÙ† ÙˆØ£ØµØ­Ø§Ø¨ Ø§Ù„Ø¹Ù…Ù„.\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø£Ù† ØªØµØ¨Ø­ Ù…Ø³ÙˆÙ‚ØŸ")) {
                    state.userRole = 'marketer';
                    updateDoc(doc(db, "users", state.user.uid), { role: 'marketer' }).then(() => {
                         showToast(`Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø´Ø±ÙƒØªÙ†Ø§ ğŸ‘‹`, 's');
                         openAddModalLogic();
                    });
                } else {
                    showToast("Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ù…Ø³ÙˆÙ‚ÙŠÙ† ÙˆÙ…Ù‚Ø¯Ù…ÙŠ Ø§Ù„Ø®Ø¯Ù…Ø§Øª", 'e');
                }
            } else {
                openAddModalLogic();
            }
        };

        function openAddModalLogic() {
            if(toggleModal('add-modal')) { 
                state.images=[];
                document.getElementById('preview-area').innerHTML='';
                document.getElementById('in-title').value = '';
                document.getElementById('in-price').value = '';
                document.getElementById('in-phone').value = '';
                document.getElementById('in-desc').value = '';
                document.getElementById('in-cat').selectedIndex = 0;
                document.getElementById('in-condition').selectedIndex = 0;
                document.querySelectorAll('.chip-checkbox').forEach(c => c.checked = false);
                document.querySelector('input[name="badge"][value="none"]').checked = true;
                
                // Reset Smart Inputs
                document.querySelectorAll('.smart-option').forEach(c => c.checked = false);
                document.querySelector('input[name="ship-mode"][value="all"]').checked = true;
                document.querySelectorAll('input[name="ship-gov-check"]').forEach(c => c.checked = false);
                toggleShipGov();

                updateFormFields(); 
            }
        }

        window.handleUpload=async(input)=>{if(input.files.length+state.images.length>7)return showToast('7 ØµÙˆØ± Ø¨Ø­Ø¯ Ø£Ù‚ØµÙ‰','e');for(let f of input.files){const c=await compress(f);state.images.push(c);document.getElementById('preview-area').innerHTML+=`<img src="${c}" class="w-14 h-14 rounded-xl object-cover border border-gray-200 shrink-0">`}}; 
        function compress(f){return new Promise(r=>{const d=new FileReader();d.readAsDataURL(f);d.onload=e=>{const i=new Image();i.src=e.target.result;i.onload=()=>{const c=document.createElement('canvas');const x=c.getContext('2d');const s=800/i.width;c.width=800;c.height=i.height*s;x.drawImage(i,0,0,c.width,c.height);r(c.toDataURL('image/jpeg',0.6))}}})};
        
        window.toggleChat=()=>{
            if(toggleModal('chat-modal')){
                if(!state.chatId&&state.chatStep===0&&!state.welcomeSent){
                    state.welcomeSent=true;
                    const name = state.user.displayName || 'ÙŠØ§ ØµØ¯ÙŠÙ‚ÙŠ';
                    setTimeout(()=>botMsg(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${name} ğŸ‘‹<br>Ù…Ø§Ù‡Ùˆ Ø·Ù„Ø¨Ùƒ Ø­ØªÙŠ Ø§Ù‚ÙˆÙ… Ø¨ØªØ­ÙˆÙŠÙ„Ùƒ Ù„Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠØŸ`),100);
                }
            }
        };

        window.sendMsg=async()=>{
            const t=document.getElementById('chat-msg').value.trim();
            if(!t)return;
            document.getElementById('chat-msg').value='';
            userMsg(t);

            if(!state.chatId){
                if(state.chatStep===0){
                    state.chatStep=2;
                    try {
                        const r=await addDoc(collection(db,"chats"),{
                            userId:state.user.uid, 
                            userName:state.user.displayName || state.user.email,
                            lastMsg:t,
                            status:'waiting',
                            messages:[
                                {s:'bot',t:`Ø§Ù„Ø§Ø³Ù…: ${state.user.displayName}`,d:new Date()},
                                {s:'user',t,d:new Date()},
                                {s:'bot',t:'Ø¬Ø§Ø±ÙŠ ØªÙˆØµÙŠÙ„Ùƒ Ø¨Ø®Ø¯Ù…Ù‡ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡',d:new Date()}
                            ],
                            createdAt:serverTimestamp()
                        });
                        state.chatId=r.id;
                        listenChat(r.id);
                    } catch (err) {
                        console.error("Chat creation failed:", err);
                        botMsg("Ø¹ÙÙˆØ§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙˆØµÙŠÙ„Ùƒ Ø¨Ø§Ù„Ø¯Ø¹Ù….");
                    }
                }
            } else {
                const s=await getDocs(query(collection(db,"chats"),where('__name__','==',state.chatId)));
                if(!s.empty){
                    const m=s.docs[0].data().messages;
                    m.push({s:'user',t,d:new Date()});
                    await updateDoc(doc(db,"chats",state.chatId),{messages:m,lastMsg:t,status:'waiting'});
                }
            }
        };

        function listenChat(id){onSnapshot(doc(db,"chats",id),s=>{if(s.exists()){const d=s.data();if(d.status==='closed'){state.chatId=null;state.chatStep=0;state.welcomeSent=false;document.getElementById('chat-box').innerHTML='';showToast("ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©");toggleModal('chat-modal');return}document.getElementById('chat-box').innerHTML='';d.messages.forEach(m=>{if(!m.t.startsWith('Ø§Ù„Ø§Ø³Ù…'))(m.s==='user'?userMsg:botMsg)(m.t)})}})};
        function checkUserChat(){onSnapshot(query(collection(db,"chats"),where('userId','==',state.user.uid),where('status','!=','closed')),s=>{if(!s.empty){state.chatId=s.docs[0].id;state.chatStep=2;listenChat(state.chatId)}})};
        function userMsg(t){const d=document.createElement('div');d.className="flex justify-start";d.innerHTML=`<div class="bg-primary text-white px-3 py-2 rounded-xl rounded-tr-none shadow-sm text-xs max-w-[85%]">${t}</div>`;document.getElementById('chat-box').appendChild(d);document.getElementById('chat-box').scrollTop=9999}
        function botMsg(t){const d=document.createElement('div');d.className="flex justify-end";d.innerHTML=`<div class="bg-white dark:bg-slate-700 dark:text-white text-slate-800 px-3 py-2 rounded-xl rounded-tl-none shadow-sm text-xs max-w-[85%]">${t}</div>`;document.getElementById('chat-box').appendChild(d);document.getElementById('chat-box').scrollTop=9999}
        
        window.toggleAdminPanel=()=>{document.getElementById('admin-panel').classList.toggle('hidden');if(!document.getElementById('admin-panel').classList.contains('hidden'))refreshAdmin()};
        
        // REQ 6: Secret Code 1032 for Verification Badge
        document.getElementById('logo-trigger').addEventListener('click',()=>{
            const code = prompt('Code:');
            if(code === '1532'){
                if(state.user) {
                    updateDoc(doc(db, "users", state.user.uid), { isAdmin: true }).then(() => {
                        state.isAdmin = true;
                        document.getElementById('btn-admin-top').classList.remove('hidden');
                        showToast('ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø£Ø¯Ù…Ù† (1532)');
                    });
                }
            } else if(code === '1032') {
                 if(state.user) {
                    updateDoc(doc(db, "users", state.user.uid), { isVerified: true }).then(() => {
                        showToast('ØªÙ… ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­ âœ…', 's');
                    });
                } else {
                    showToast("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹", "e");
                }
            }
        });

        window.refreshAdmin=()=>{
            onSnapshot(query(collection(db,"chats"),where('status','!=','closed')),s=>{
                const l=document.getElementById('admin-users-list');
                l.innerHTML='';
                let chats = [];
                s.forEach(d => chats.push({id: d.id, ...d.data()}));
                chats.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                chats.forEach(dt => {
                    l.innerHTML+=`<div onclick="loadAdmin('${dt.id}','${dt.userName}')" class="p-3 mb-2 bg-white/5 rounded-xl cursor-pointer border border-white/10"><div class="font-bold text-xs text-white flex justify-between"><span>${dt.userName}</span>${dt.status==='waiting'?'<span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>':''}</div><div class="text-[10px] text-gray-400 truncate mt-1">${dt.lastMsg}</div></div>`
                });
            })
        };

        window.loadAdmin=(id,n)=>{state.activeAdminChat=id;document.getElementById('admin-chat-header').innerHTML=`<span>${n}</span><button onclick="kickUser()" id="btn-end-chat" class="hidden bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded flex items-center gap-1"><i data-lucide="slash" class="w-3 h-3"></i> Ø¥Ù†Ù‡Ø§Ø¡</button>`;document.getElementById('btn-end-chat').classList.remove('hidden');onSnapshot(doc(db,"chats",id),s=>{const b=document.getElementById('admin-msg-area');b.innerHTML='';if(!s.exists())return;s.data().messages.forEach(m=>{b.innerHTML+=`<div class="${m.s==='support'?'text-left':'text-right'} mb-2"><span class="inline-block px-3 py-2 rounded-lg text-xs ${m.s==='support'?'bg-primary text-white':'bg-white/10'}">${m.t}</span></div>`});b.scrollTop=9999})};
        window.sendAdminMsg=async()=>{const t=document.getElementById('admin-input').value;if(!t||!state.activeAdminChat)return;document.getElementById('admin-input').value='';const s=await getDocs(query(collection(db,"chats"),where('__name__','==',state.activeAdminChat)));const m=s.docs[0].data().messages;m.push({s:'support',t,d:new Date()});await updateDoc(doc(db,"chats",state.activeAdminChat),{messages:m,status:'active'})};
        window.kickUser=async()=>{if(confirm("Ø¥Ù†Ù‡Ø§Ø¡ØŸ")){await updateDoc(doc(db,"chats",state.activeAdminChat),{status:'closed'});document.getElementById('admin-msg-area').innerHTML='';document.getElementById('btn-end-chat').classList.add('hidden');state.activeAdminChat=null}};

        lucide.createIcons();
    </script>
</body>
</html>
