<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</title>


    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="manifest.json">
   <link rel="assetlinks" href="https://shehabt1000-boop.github.io/.well-known/assetlinks.json" type="application/json">


    <meta name="theme-color" content="#1e40af">
    <script src="https://cdn.tailwindcss.com"></script>


    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">


    <style>
        /* === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 1: Ù…Ù†Ø¹ Ø§Ù„ØªØ§Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø­Ø±ÙƒÙŠØ© ÙˆØ§Ù„ØµÙˆØ± Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© (Ø§Ù„Ø£Ø¯Ø§Ø¡) === */
        * {
            transition: none !important;
            animation: none !important;
        }
        .animate-spin, .animate-ping {
            animation: none !important;
        }
        /* Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø· Cairo ÙƒØ®Ø· Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¹Ø±Ø¨ÙŠ */
        body {
            font-family: 'Cairo', 'Inter', sans-serif;
            direction: rtl; /* Ø¶Ù…Ø§Ù† Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ø± */
        }
        /* ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³ÙŠØ·Ø© Ù„Ù€ Tailwind Ù„Ø¯Ø¹Ù… RTL Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„ */
        .space-x-reverse > :not([hidden]) ~ :not([hidden]) {
            --tw-space-x-reverse: 1;
        }
        /* Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ÙˆØ¸ÙŠÙØªÙ‡ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª SVG Ù„Ù„Ù†Ø¬ÙˆÙ… (Ù„Ù„ØªÙ‚ÙŠÙŠÙ…) */
        .star-icon {
            width: 1.5rem;
            height: 1.5rem;
            fill: currentColor;
            display: inline-block;
        }








        /* === ØªØ¹Ø¯ÙŠÙ„ ÙÙ‚Ø§Ø¹Ø§Øª Ø§Ù„Ø´Ø§Øª === */
        .chat-bubble-sent {
            background-color: #1e40af; /* bg-blue-800 */
            color: white; 
            padding: 0.6rem 0.75rem; 
            border-radius: 1.25rem 1.25rem 0 1.25rem; 
            word-wrap: break-word; 
        }
        .chat-bubble-received {
            background-color: #e5e7eb; /* bg-gray-200 */
            color: #1f2937; 
            padding: 0.6rem 0.75rem; 
            border-radius: 1.25rem 1.25rem 1.25rem 0; 
            word-wrap: break-word; 
        }








        /* truncate */
        .truncate-1-line {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 1;
        }








        /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªØ¨Ø§Ø¹Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© */
        .main-padding {
            padding: 0.75rem; /* p-3 */
        }
        @media (min-width: 768px) {
            .main-padding {
                padding: 2rem; 
            }
        }








        /* === Ø¥ØµÙ„Ø§Ø­ 1: ØªØµØºÙŠØ± Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¨Ø§Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ === */
        .app-header {
            padding: 0.5rem 0.75rem; 
        }
        /* === Ø¥ØµÙ„Ø§Ø­ 1: ØªØµØºÙŠØ± Ø§Ø±ØªÙØ§Ø¹ Ø¨Ø§Ø± Ø§Ù„ØªØ±Ø­ÙŠØ¨ === */
        .welcome-header {
            padding: 0.6rem 1rem; 
        }
        /* === ØªÙ†Ø³ÙŠÙ‚ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ (Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 5: ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø¥Ø·Ø§Ø±) === */
        .register-input-card {
            background-color: #ffffff;
            border: 2px solid #1e40af; /* Ø¥Ø·Ø§Ø± Ù†ÙŠÙ„ÙŠ ØºØ§Ù…Ù‚ Ø¨Ø³Ù…Ùƒ 2px */
            border-radius: 0.75rem; /* Ø£ÙƒØ«Ø± Ø§Ø³ØªØ¯Ø§Ø±Ø© */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); /* Ø¸Ù„ Ø£Ù‚ÙˆÙ‰ */
            padding: 1rem; /* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø­Ø´Ùˆ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ */
            /* transition: border-color 0.2s, box-shadow 0.2s;  ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ */
        }
        .register-input-card:focus-within {
            border-color: #3730a3; /* indigo-900 */
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.5); /* Ø­Ù„Ù‚Ø© Ø£Ù‚ÙˆÙ‰ */
        }
        .register-input-card input, .register-input-card select, .register-input-card textarea {
            border: none !important;
            padding: 0 !important;
            box-shadow: none !important;
            outline: none !important;
            background-color: transparent !important;
        }
        /* === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 2: Ø¬Ø¹Ù„ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„ÙØ±Ø¹ÙŠØ© Ø³ÙˆØ¯Ø§Ø¡ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­ === */
        .register-input-card label {
            font-size: 0.75rem;
            color: #1f2937; /* text-gray-900 */
            margin-bottom: 0.25rem;
            display: block;
        }
        /* Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 2: Ø¥Ø·Ø§Ø± ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ */
        .register-photo-preview {
            border-color: #1e40af; /* Ø¥Ø·Ø§Ø± Ù†ÙŠÙ„ÙŠ ØºØ§Ù…Ù‚ */
            border-width: 2px;
            padding: 0.25rem;
        }
        .register-photo-preview:hover {
            border-color: #3730a3; /* indigo-900 */
        }
        
        /* === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 5: Ø®Ù„ÙÙŠØ© Ø²Ø¬Ø§Ø¬ÙŠØ© Ø´ÙØ§ÙØ© Ù„ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ === */
        .glassy-indigo-bg {
            background-color: rgba(255, 255, 255, 0.8); /* Ø£Ø¨ÙŠØ¶ Ø´ÙØ§Ù */
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }




        /* === ØªØµØºÙŠØ± Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¯Ù„ÙŠÙ„ ÙˆØ§Ù„ÙˆØ¸Ø§Ø¦Ù ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø­Ø¯Ø«) === */
        @media (max-width: 767px) {
            /* ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø¯Ù„ÙŠÙ„ */
            .directory-card {
                padding: 0.5rem; /* p-2 */
            }
            .directory-card img {
                width: 2rem; /* w-8 */
                height: 2rem; /* h-8 */
            }
            .directory-card h3 {
                font-size: 0.875rem; /* text-sm */
            }
            .directory-card p {
                font-size: 0.625rem; /* text-xs - Ø£ØµØºØ± */
            }
            /* ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„ÙˆØ¸Ø§Ø¦Ù (3) */
            .job-listing-card {
                padding: 0.5rem; /* p-2 Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† p-3 */
            }
            .job-listing-card h3 {
                font-size: 0.875rem; /* text-sm Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† text-base */
            }
            .job-listing-card p {
                font-size: 0.75rem; /* Ø£ØµØºØ± */
            }
        }
        
        /* === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 6: Ø¥ØµÙ„Ø§Ø­ Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ (Toggle) Ù„Ù€ RTL === */
        .settings-toggle-container input[type="checkbox"].sr-only:checked + div:after {
            /* Override for RTL translation */
             transform: translateX(-18px) !important;
             right: 2px !important; 
             left: auto !important;
        }
        
        
        /* === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 3: Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† (Dark Mode) - ØªÙ… Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ¨Ø§ÙŠÙ† === */
        body.dark {
            background-color: #1f2937; /* bg-gray-800 */
            color: #f3f4f6; /* text-gray-100 */
        }
        body.dark #app {
            background-color: #1f2937;
            box-shadow: none;
        }
        body.dark .bg-gray-50 {
            background-color: #1f2937;
        }
        body.dark .bg-white {
            background-color: #374151; /* bg-gray-700 */
        }
        /* === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 3: Ø¬Ø¹Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØµÙˆØµ Ø¨ÙŠØ¶Ø§Ø¡ Ø£Ùˆ ÙØ§ØªØ­Ø© Ø¬Ø¯Ø§Ù‹ === */
        body.dark .text-gray-900, 
        body.dark .text-gray-800, 
        body.dark .text-gray-700,
        body.dark .text-gray-600 {
            color: #ffffff; /* Ø£Ø¨ÙŠØ¶ Ù†Ø§ØµØ¹ */
        }
        body.dark .text-gray-500 {
            color: #d1d5db; /* Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­ Ø¬Ø¯Ø§Ù‹ Ù„Ù„ÙØ±Ø¹ÙŠØ© */
        }
        body.dark .register-input-card {
            background-color: #374151;
            border-color: #4f46e5; /* indigo-600 */
        }
        body.dark .register-input-card:focus-within {
            border-color: #6366f1; /* indigo-500 */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
        }
        body.dark .register-input-card label {
            color: #ffffff; /* ØªÙØªÙŠØ­ Ù„ÙˆÙ† Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† */
        }
        body.dark .border-gray-200 {
            border-color: #4b5563;
        }
        body.dark .border-gray-300 {
            border-color: #4b5563;
        }
        body.dark .bg-indigo-50 {
            background-color: #374151;
        }
        body.dark .bg-indigo-100 {
            background-color: #4f46e5;
        }
        body.dark .bg-red-100 {
            background-color: #ef4444;
        }
        body.dark .bg-green-100 {
            background-color: #10b981;
        }
        body.dark .chat-bubble-received {
            background-color: #4b5563;
            color: #f3f4f6;
        }
        body.dark .shadow-md {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -2px rgba(0, 0, 0, 0.5);
        }
        body.dark .glassy-indigo-bg {
            background-color: rgba(55, 65, 81, 0.9); /* bg-gray-700 Ø´ÙØ§Ù */
            border: 1px solid rgba(156, 163, 175, 0.4);
        }
        body.dark .bg-gray-100 {
            background-color: #1f2937;
        }
    </style>
</head>
<body class="bg-gray-50">








    <!-- Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ -->
    <div id="app" class="max-w-lg mx-auto min-h-screen bg-white shadow-lg md:max-w-2xl lg:max-w-4xl">
        <!-- Ø³ÙŠØªÙ… Ø­Ù‚Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‡Ù†Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
    </div>








    <!-- Ù…ÙˆØ¯Ø§Ù„ (Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø©) Ø¹Ø§Ù…Ø© -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden flex items-center justify-center p-4">
        <div id="modal-content" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø³ÙŠØªÙ… Ø­Ù‚Ù†Ù‡ Ù‡Ù†Ø§ -->
        </div>
    </div>








    <!-- ============================================= -->
    <!-- ==== Ø¨Ø¯Ø§ÙŠØ© ÙƒÙˆØ¯ Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª Ùˆ Firebase ==== -->
    <!-- ============================================= -->
    <script type="module">
        // 1. Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ¸Ø§Ø¦Ù Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithCustomToken, 
            onAuthStateChanged, 
            signOut,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            updateProfile,
            updatePassword
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            collection, 
            query, 
            where, 
            onSnapshot, 
            Timestamp,
            updateDoc,
            runTransaction,
            getDocs,
            orderBy,
            deleteDoc,
            increment 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";








        // 2. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
        const firebaseConfig = {
          apiKey: "AIzaSyA5OiTcX95GBgiJoDHnY3y7N23o-j8hsQ8",
          authDomain: "services-cef84.firebaseapp.com",
          databaseURL: "https://services-cef84-default-rtdb.firebaseio.com",
          projectId: "services-cef84",
          storageBucket: "services-cef84.firebasestorage.app",
          messagingSenderId: "902396219187",
          appId: "1:902396219187:web:3ba084a724266afa8bb846"
        };








        // 3. ØªÙ‡ÙŠØ¦Ø© Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);








        // 4. Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
        let userId = null;
        let userProfile = null;
        let currentUnsubscribe = null; 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'services-cef84'; 








        let isRegistering = false; 
        let allUsers = []; 








        let navigationHistory = [];




        // === Ø¥Ø¶Ø§ÙØ© Ø«Ø§Ø¨Øª Ù„Ù„Ø­Ø°Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (48 Ø³Ø§Ø¹Ø©) ===
        const AUTO_DELETE_MS = 48 * 60 * 60 * 1000;
        // === Ø«Ø§Ø¨Øª Ù„ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (5 Ø¯Ù‚Ø§Ø¦Ù‚) ===
        const ONLINE_THRESHOLD_MS = 5 * 60 * 1000; 




        // === Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„ØªØ±ØªÙŠØ¨ (Ù…Ø­Ø¯Ø«Ø©) ===
        const MAIN_SERVICES_ORDER = [
            'Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø¯Ù†ÙŠ (ØªÙ†ÙÙŠØ°)', 'Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø¹Ù…Ø§Ø±ÙŠ (ØªØµÙ…ÙŠÙ…)', 'Ù…Ù‡Ù†Ø¯Ø³ Ø´Ø¨ÙƒØ§Øª', 'Ù…Ù‡Ù†Ø¯Ø³ Ø¨Ø±Ù…Ø¬ÙŠØ§Øª', 'Ù…Ù‡Ù†Ø¯Ø³ ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ù‚ÙˆÙ‰', 'Ù…Ù‡Ù†Ø¯Ø³ Ù…ÙŠÙƒØ§Ù†ÙŠÙƒØ§ Ø¥Ù†ØªØ§Ø¬', 'Ù…Ù‡Ù†Ø¯Ø³ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª', 'Ù…Ù‡Ù†Ø¯Ø³ Ø²Ø±Ø§Ø¹ÙŠ', 'Ù…Ù‡Ù†Ø¯Ø³ Ø¬ÙˆØ¯Ø©', 'Ù…Ù‡Ù†Ø¯Ø³ Ø¨ØªØ±ÙˆÙ„',
            'Ù…Ø­Ø§Ø³Ø¨', 'Ù…Ø­Ø§Ø³Ø¨ Ù‚Ø§Ù†ÙˆÙ†ÙŠ', 'Ù…Ø­Ø§Ø³Ø¨ Ø´Ø±ÙƒØ§Øª', 'Ù…Ø­Ø§Ø³Ø¨ ØªÙƒØ§Ù„ÙŠÙ', 
            'Ø·Ø¨ÙŠØ¨ Ø¨Ø´Ø±ÙŠ', 'Ù…Ù…Ø±Ø¶ Ù…Ù†Ø²Ù„ÙŠ', 'ØµÙŠØ§Ø¯Ù„ÙŠ', 'Ù…Ø³Ø¹Ù', 'Ø·Ø¨ÙŠØ¨ Ø£Ø³Ù†Ø§Ù†', 'Ø·Ø¨ÙŠØ¨ Ø¨ÙŠØ·Ø±ÙŠ',
            'ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ', 'Ø³Ø¨Ø§Ùƒ', 'Ù†Ø¬Ø§Ø± Ù…ÙˆØ¨ÙŠÙ„ÙŠØ§', 'ÙÙ†ÙŠ ØªØ¨Ø±ÙŠØ¯ ÙˆØªÙƒÙŠÙŠÙ', 'Ù†Ù‚Ø§Ø´ ÙˆØ¯Ù‡Ø§Ù†Ø§Øª', 'ØµÙŠØ§Ù†Ø© Ù‡ÙˆØ§ØªÙ ÙˆÙƒÙ…Ø¨ÙŠÙˆØªØ±'
        ];




        // === Ø¯Ø§Ù„Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ø®Ø¯Ù…Ø§Øª (Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 3) ===
        function sortServices(services) {
            const otherService = services.find(s => s.name === 'Ø£Ø®Ø±Ù‰ (Ù…Ù‡Ù† Ø­Ø±Ø©/Ø¹Ø§Ù…Ø©)');
            const otherIndex = services.indexOf(otherService);
            if (otherIndex !== -1) {
                services.splice(otherIndex, 1); // Ø¥Ø²Ø§Ù„Ø© "Ø£Ø®Ø±Ù‰" Ù…Ø¤Ù‚ØªØ§Ù‹
            }
            
            services.sort((a, b) => {
                const indexA = MAIN_SERVICES_ORDER.indexOf(a.name);
                const indexB = MAIN_SERVICES_ORDER.indexOf(b.name);




                if (indexA !== -1 && indexB !== -1) {
                    return indexA - indexB; // ÙƒÙ„Ø§Ù‡Ù…Ø§ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©: ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                }
                if (indexA !== -1) {
                    return -1; // A ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©ØŒ ÙŠØ¸Ù‡Ø± Ø£ÙˆÙ„Ø§Ù‹
                }
                if (indexB !== -1) {
                    return 1; // B ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©ØŒ ÙŠØ¸Ù‡Ø± Ø£ÙˆÙ„Ø§Ù‹
                }
                return a.name.localeCompare(b.name); // Ù„Ø§ Ø´ÙŠØ¡ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©: ØªØ±ØªÙŠØ¨ Ø£Ø¨Ø¬Ø¯ÙŠ
            });
            
            if (otherService) {
                services.push(otherService); // Ø¥Ø¶Ø§ÙØ© "Ø£Ø®Ø±Ù‰" ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
            }
            
            return services;
        }




        // === Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª (ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ù„Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ØªØ±ØªÙŠØ¨) ===
        const SERVICES_LIST_UNSORTED = [
            // Ù…Ù‡Ù† Ø­Ø±ÙÙŠØ© ÙˆØ®Ø¯Ù…Ø§Øª Ù…Ù†Ø²Ù„ÙŠØ© (20)
            { name: 'Ø³Ø¨Ø§Ùƒ', icon: 'ğŸ”§' },
            { name: 'ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ', icon: 'ğŸ’¡' }, 
            { name: 'Ù†Ø¬Ø§Ø± Ù…ÙˆØ¨ÙŠÙ„ÙŠØ§', icon: 'ğŸªš' },
            { name: 'ÙÙ†ÙŠ ØªØ¨Ø±ÙŠØ¯ ÙˆØªÙƒÙŠÙŠÙ', icon: 'â„ï¸' },
            { name: 'Ù†Ù‚Ø§Ø´ ÙˆØ¯Ù‡Ø§Ù†Ø§Øª', icon: 'ğŸ¨' },
            { name: 'ÙÙ†ÙŠ ØµÙŠØ§Ù†Ø© Ø£Ø¬Ù‡Ø²Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©', icon: 'ğŸ”Œ' },
            { name: 'ÙÙ†ÙŠ ØµÙŠØ§Ù†Ø© ØºØ³Ø§Ù„Ø§Øª', icon: 'ğŸ§º' },
            { name: 'ÙÙ†ÙŠ ØµÙŠØ§Ù†Ø© Ø«Ù„Ø§Ø¬Ø§Øª', icon: 'ğŸ§Š' },
            { name: 'ØªØ±ÙƒÙŠØ¨ Ø¯Ø´ ÙˆØ³ØªØ§Ù„Ø§ÙŠØª', icon: 'ğŸ“¡' },
            { name: 'ØªÙ†Ø¸ÙŠÙ Ù…Ù†Ø§Ø²Ù„ ÙˆÙ…ÙƒØ§ØªØ¨', icon: 'ğŸ§¹' },
            { name: 'Ù…ÙƒØ§ÙØ­Ø© Ø­Ø´Ø±Ø§Øª', icon: 'ğŸœ' },
            { name: 'ÙÙ†ÙŠ Ø£Ù…Ù† ØµÙ†Ø§Ø¹ÙŠ', icon: 'ğŸš¨' },
            { name: 'ÙÙ†ÙŠ Ù…ØµØ§Ø¹Ø¯', icon: 'â¬†ï¸' },
            { name: 'ÙÙ†ÙŠ ØºÙ„Ø§ÙŠØ§Øª', icon: 'ğŸ”¥' },
            { name: 'ÙÙ†ÙŠ ØªØ±ÙƒÙŠØ¨ Ø¨Ø§Ø±ÙƒÙŠÙ‡', icon: 'ğŸªµ' },
            { name: 'ÙÙ†ÙŠ ØªØ±ÙƒÙŠØ¨ ÙˆØ±Ù‚ Ø­Ø§Ø¦Ø·', icon: 'ğŸ–¼ï¸' },
            { name: 'ÙÙ†ÙŠ ØªØ±ÙƒÙŠØ¨ Ø³ØªØ§Ø¦Ø±', icon: 'ğŸªŸ' },
            { name: 'ÙÙ†ÙŠ ØªØ±ÙƒÙŠØ¨ Ù…Ø·Ø§Ø¨Ø® Ø£Ù„ÙˆÙ…ÙŠØªØ§Ù„', icon: 'ğŸ”ª' },
            { name: 'ÙÙ†ÙŠ ØªÙ†Ø¬ÙŠØ¯ ÙˆØµØ§Ù„ÙˆÙ†Ø§Øª', icon: 'ğŸ›‹ï¸' },
            { name: 'ÙÙ†ÙŠ ØªØ±ÙƒÙŠØ¨ Ø²Ø¬Ø§Ø¬ ÙˆØ³ÙŠÙƒÙˆØ±ÙŠØª', icon: 'ğŸ’' },
            // Ù…Ù‡Ù† Ù‡Ù†Ø¯Ø³ÙŠØ© ÙˆØªÙ‚Ù†ÙŠØ© (20)
            { name: 'Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø¯Ù†ÙŠ (ØªÙ†ÙÙŠØ°)', icon: 'ğŸ—ï¸' },
            { name: 'Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø¹Ù…Ø§Ø±ÙŠ (ØªØµÙ…ÙŠÙ…)', icon: 'ğŸ“' },
            { name: 'Ù…Ù‡Ù†Ø¯Ø³ Ø´Ø¨ÙƒØ§Øª', icon: 'ğŸ“¶' },
            { name: 'Ù…Ù‡Ù†Ø¯Ø³ Ø¨Ø±Ù…Ø¬ÙŠØ§Øª', icon: 'ğŸ’»' },
            { name: 'Ù…Ù‡Ù†Ø¯Ø³ ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ù‚ÙˆÙ‰', icon: 'âš¡' },
            { name: 'Ù…Ù‡Ù†Ø¯Ø³ Ù…ÙŠÙƒØ§Ù†ÙŠÙƒØ§ Ø¥Ù†ØªØ§Ø¬', icon: 'ğŸ­' },
            { name: 'Ù…Ù‡Ù†Ø¯Ø³ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª', icon: 'ğŸ”¬' },
            { name: 'Ù…Ù‡Ù†Ø¯Ø³ Ø²Ø±Ø§Ø¹ÙŠ', icon: 'ğŸŒ¾' },
            { name: 'Ù…Ù‡Ù†Ø¯Ø³ Ø¬ÙˆØ¯Ø©', icon: 'âœ…' },
            { name: 'Ù…Ù‡Ù†Ø¯Ø³ Ø¨ØªØ±ÙˆÙ„', icon: 'ğŸ›¢ï¸' },
            { name: 'ØµÙŠØ§Ù†Ø© Ù‡ÙˆØ§ØªÙ ÙˆÙƒÙ…Ø¨ÙŠÙˆØªØ±', icon: 'ğŸ“±' },
            { name: 'ÙÙ†ÙŠ ÙƒØ§Ù…ÙŠØ±Ø§Øª Ù…Ø±Ø§Ù‚Ø¨Ø©', icon: 'ğŸ“¹' },
            { name: 'Ù…Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª', icon: 'âŒ¨ï¸' },
            { name: 'Ù…ØµÙ…Ù… Ø¬Ø±Ø§ÙÙŠÙƒ', icon: 'ğŸ¨' },
            { name: 'Ù…Ø·ÙˆØ± ÙˆÙŠØ¨', icon: 'ğŸŒ' },
            { name: 'Ø®Ø¨ÙŠØ± Ø£Ù…Ù† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª', icon: 'ğŸ”’' },
            { name: 'ÙÙ†ÙŠ Ø¯Ø¹Ù… ÙÙ†ÙŠ IT', icon: 'ğŸ“' },
            { name: 'ÙÙ†ÙŠ Ø·Ø¨Ø§Ø¹Ø© ÙˆØªØµÙˆÙŠØ±', icon: 'ğŸ–¨ï¸' },
            { name: 'ÙÙ†ÙŠ Ù…Ø®ØªØ¨Ø±Ø§Øª', icon: 'ğŸ§ª' },
            { name: 'Ø£Ø®ØµØ§Ø¦ÙŠ ØªØ³ÙˆÙŠÙ‚ Ø±Ù‚Ù…ÙŠ', icon: 'ğŸ“ˆ' },
            // Ù…Ù‡Ù† Ù…Ø§Ù„ÙŠØ© ÙˆÙ‚Ø§Ù†ÙˆÙ†ÙŠØ© ÙˆØ¥Ø¯Ø§Ø±ÙŠØ© (16)
            { name: 'Ù…Ø­Ø§Ø³Ø¨', icon: 'ğŸ’µ' }, 
            { name: 'Ù…Ø­Ø§Ø³Ø¨ Ù‚Ø§Ù†ÙˆÙ†ÙŠ', icon: 'ğŸ§¾' },
            { name: 'Ù…Ø­Ø§Ø³Ø¨ Ø´Ø±ÙƒØ§Øª', icon: 'ğŸ§®' },
            { name: 'Ù…Ø­Ø§Ø³Ø¨ ØªÙƒØ§Ù„ÙŠÙ', icon: 'ğŸ’°' },
            { name: 'Ù…Ø­Ø§Ù…ÙŠ (Ù‚Ø¶Ø§ÙŠØ§ Ù…Ø¯Ù†ÙŠØ©)', icon: 'âš–ï¸' },
            { name: 'Ù…Ø­Ø§Ù…ÙŠ (Ù‚Ø¶Ø§ÙŠØ§ Ø£Ø³Ø±ÙŠØ©)', icon: 'ğŸ“œ' },
            { name: 'Ù…Ø­Ø§Ù…ÙŠ (Ù‚Ø¶Ø§ÙŠØ§ Ø¬Ù†Ø§Ø¦ÙŠØ©)', icon: 'ğŸ”ª' },
            { name: 'Ù…Ø¯ÙŠØ± Ù…ÙƒØªØ¨/Ø³ÙƒØ±ØªÙŠØ±', icon: 'ğŸ“' },
            { name: 'Ù…ÙˆØ¸Ù Ø§Ø³ØªÙ‚Ø¨Ø§Ù„', icon: 'ğŸ›ï¸' },
            { name: 'Ø£Ù…ÙŠÙ† Ù…Ø®Ø²Ù†', icon: 'ğŸ“¦' },
            { name: 'Ù…Ù†Ø¯ÙˆØ¨ Ù…Ø¨ÙŠØ¹Ø§Øª', icon: 'ğŸ’¼' },
            { name: 'Ù…Ø¯ÙŠØ± Ù…Ø´ØªØ±ÙŠØ§Øª', icon: 'ğŸ›’' },
            { name: 'Ù…Ø¯ÙŠØ± Ù…ÙˆØ§Ø±Ø¯ Ø¨Ø´Ø±ÙŠØ©', icon: 'ğŸ‘¥' },
            { name: 'Ù…ØªØ±Ø¬Ù…', icon: 'ğŸŒ' },
            { name: 'Ù…Ø¯Ù‚Ù‚ Ø­Ø³Ø§Ø¨Ø§Øª', icon: 'ğŸ”' },
            { name: 'Ù…Ø³ØªØ´Ø§Ø± Ù…Ø§Ù„ÙŠ', icon: 'ğŸ’µ' },
            // Ù…Ù‡Ù† Ø·Ø¨ÙŠØ© ÙˆØªÙ…Ø±ÙŠØ¶ (10)
            { name: 'Ø·Ø¨ÙŠØ¨ Ø¨Ø´Ø±ÙŠ', icon: 'âš•ï¸' },
            { name: 'Ù…Ù…Ø±Ø¶ Ù…Ù†Ø²Ù„ÙŠ', icon: 'ğŸ©º' },
            { name: 'ØµÙŠØ§Ø¯Ù„ÙŠ', icon: 'ğŸ’Š' },
            { name: 'Ù…Ø³Ø¹Ù', icon: 'ğŸ©¹' },
            { name: 'Ø·Ø¨ÙŠØ¨ Ø£Ø³Ù†Ø§Ù†', icon: 'ğŸ¦·' },
            { name: 'Ø·Ø¨ÙŠØ¨ Ø¨ÙŠØ·Ø±ÙŠ', icon: 'ğŸ•' },
            { name: 'Ø£Ø®ØµØ§Ø¦ÙŠ Ø¹Ù„Ø§Ø¬ Ø·Ø¨ÙŠØ¹ÙŠ', icon: 'ğŸš¶' },
            { name: 'Ø£Ø®ØµØ§Ø¦ÙŠ ØªØºØ°ÙŠØ©', icon: 'ğŸ' },
            { name: 'ÙÙ†ÙŠ Ø£Ø´Ø¹Ø©', icon: 'â˜¢ï¸' },
            { name: 'ÙÙ†ÙŠ ØªØ­Ø§Ù„ÙŠÙ„ Ø·Ø¨ÙŠØ©', icon: 'ğŸ©¸' },
            // Ù…Ù‡Ù† ØªØ¹Ù„ÙŠÙ…ÙŠØ© (5)
            { name: 'Ù…Ø¯Ø±Ø³ Ø®ØµÙˆØµÙŠ', icon: 'âœï¸' },
            { name: 'Ù…Ø¯Ø±Ø¨ Ø±ÙŠØ§Ø¶ÙŠ', icon: 'ğŸ’ª' },
            { name: 'Ù…Ø¯Ø±Ø¨ ÙƒÙ„Ø§Ø¨', icon: 'ğŸ•' },
            { name: 'Ù…Ø¯Ø±Ø¨ ØªÙ†Ù…ÙŠØ© Ø¨Ø´Ø±ÙŠØ©', icon: 'ğŸ§ ' },
            { name: 'Ù…ØµØ­Ø­ Ù„ØºÙˆÙŠ', icon: 'ğŸ“' },
            // Ù…Ù‡Ù† Ø§Ù„Ø¨Ù†Ø§Ø¡ ÙˆØ§Ù„ØªØ´ÙŠÙŠØ¯ (10)
            { name: 'Ø¹Ø§Ù…Ù„ Ø¨Ù†Ø§Ø¡', icon: 'ğŸ§±' },
            { name: 'Ù…Ø¨ÙŠØ¶ Ù…Ø­Ø§Ø±Ø©', icon: 'â¬œ' },
            { name: 'Ù…Ø±ÙƒØ¨ Ø³ÙŠØ±Ø§Ù…ÙŠÙƒ ÙˆØ±Ø®Ø§Ù…', icon: 'ğŸ”¨' },
            { name: 'Ø­Ø¯Ø§Ø¯ Ù…Ø³Ù„Ø­', icon: 'ğŸ”—' },
            { name: 'Ø­Ø¯Ø§Ø¯ ÙƒØ±ÙŠØªØ§Ù„', icon: 'ğŸ›¡ï¸' },
            { name: 'Ø£Ù„ÙˆÙ…ÙŠØªØ§Ù„ ÙˆØ²Ø¬Ø§Ø¬', icon: 'ğŸªŸ' },
            { name: 'ÙÙ†ÙŠ Ø¹Ø²Ù„ Ù…Ø§Ø¦ÙŠ ÙˆØ­Ø±Ø§Ø±ÙŠ', icon: 'ğŸ’§' },
            { name: 'ÙÙ†ÙŠ ØªØ±ÙƒÙŠØ¨ Ø¬Ø¨Ø³ Ø¨ÙˆØ±Ø¯', icon: 'ğŸ’¡' },
            { name: 'Ù…Ø³Ø§Ø­ Ø£Ø±Ø§Ø¶ÙŠ', icon: 'ğŸ“' },
            { name: 'Ù…Ù‚Ø§ÙˆÙ„ ØªØ´Ø·ÙŠØ¨Ø§Øª', icon: 'ğŸ”‘' },
            // Ù…Ù‡Ù† Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª ÙˆØ§Ù„Ù†Ù‚Ù„ (10)
            { name: 'ÙÙ†ÙŠ Ø³ÙŠØ§Ø±Ø§Øª/Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠ', icon: 'âš™ï¸' },
            { name: 'ÙÙ†ÙŠ ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ø³ÙŠØ§Ø±Ø§Øª', icon: 'ğŸ”‹' },
            { name: 'Ù…Ø¹Ù„Ù… Ø¯Ù‡Ø§Ù† Ø³ÙŠØ§Ø±Ø§Øª', icon: 'ğŸ–Œï¸' },
            { name: 'Ø³Ø§Ø¦Ù‚ Ø®Ø§Øµ', icon: 'ğŸš—' },
            { name: 'Ù†Ù‚Ù„ Ø¹ÙØ´', icon: 'ğŸšš' },
            { name: 'Ø³Ø§Ø¦Ù‚ Ø´Ø§Ø­Ù†Ø©/Ù†Ù‚Ù„ Ø«Ù‚ÙŠÙ„', icon: 'ğŸš›' },
            { name: 'ÙÙ†ÙŠ ÙƒØ§ÙˆØªØ´ ÙˆØ¨Ø·Ø§Ø±ÙŠØ§Øª', icon: 'ğŸ›' },
            { name: 'ÙÙ†ÙŠ Ø³Ù…ÙƒØ±Ø© Ø³ÙŠØ§Ø±Ø§Øª', icon: 'ğŸ› ï¸' },
            { name: 'ÙÙ†ÙŠ ØºØ³ÙŠÙ„ ÙˆØªÙ„Ù…ÙŠØ¹ Ø³ÙŠØ§Ø±Ø§Øª', icon: 'ğŸ§¼' },
            { name: 'Ø®Ø¯Ù…Ø§Øª Ø³ÙŠØ§Ø­ÙŠØ© ÙˆØ­Ø¬Ø²', icon: 'âœˆï¸' },
            // Ù…Ù‡Ù† Ø§Ù„Ø¶ÙŠØ§ÙØ© ÙˆØ§Ù„Ø¥Ø¹Ù„Ø§Ù… (10)
            { name: 'Ù…ØµÙˆØ± ÙÙˆØªÙˆØºØ±Ø§ÙÙŠ', icon: 'ğŸ“¸' },
            { name: 'Ù…ØµÙˆØ± ÙÙŠØ¯ÙŠÙˆ', icon: 'ğŸ¥' },
            { name: 'Ø·Ø¨Ø§Ø® Ù…Ù†Ø§Ø³Ø¨Ø§Øª', icon: 'ğŸ§‘â€ğŸ³' },
            { name: 'Ø´ÙŠÙ Ù…Ø·Ø¹Ù…', icon: 'ğŸ½ï¸' },
            { name: 'Ù…Ø°ÙŠØ¹/Ù…Ø¹Ù„Ù‚ ØµÙˆØªÙŠ', icon: 'ğŸ¤' },
            { name: 'Ù…Ù†Ø¸Ù… Ø­ÙÙ„Ø§Øª ÙˆÙ…Ù†Ø§Ø³Ø¨Ø§Øª', icon: 'ğŸ‰' },
            { name: 'Ù…ØµÙÙ Ø´Ø¹Ø± (ÙƒÙˆØ§ÙÙŠØ±)', icon: 'ğŸ’‡' },
            { name: 'Ø®ÙŠØ§Ø· / ØªØ±Ø²ÙŠ', icon: 'ğŸ‘”' },
            { name: 'Ø¬Ù„ÙŠØ³ Ù…Ø³Ù†ÙŠÙ†', icon: 'ğŸ§“' },
            { name: 'Ù…Ø±Ø¨ÙŠØ© Ø£Ø·ÙØ§Ù„', icon: 'ğŸ‘¶' },
            // Ù…Ù‡Ù† Ù…ØªÙ†ÙˆØ¹Ø© (10)
            { name: 'Ø­Ø§Ø±Ø³ Ø£Ù…Ù†', icon: 'ğŸ”’' },
            { name: 'Ø¨Ø§Ø¦Ø¹/ÙƒØ§Ø´ÙŠØ±', icon: 'ğŸ›’' },
            { name: 'Ù…Ø²Ø§Ø±Ø¹/Ø¬Ù†Ø§ÙŠÙ†ÙŠ', icon: 'ğŸŒ¿' },
            { name: 'ÙÙ†ÙŠ ØµÙŠØ§Ù†Ø© Ø¢Ù„Ø§Øª ØµÙ†Ø§Ø¹ÙŠØ©', icon: 'ğŸ”©' },
            { name: 'Ø£Ø®ØµØ§Ø¦ÙŠ ØªØ®Ø§Ø·Ø¨', icon: 'ğŸ—£ï¸' },
            { name: 'Ø£Ø®ØµØ§Ø¦ÙŠ Ù†ÙØ³ÙŠ', icon: 'ğŸ§˜' },
            { name: 'ÙÙ†ÙŠ ØµÙŠØ§Ù†Ø© Ø£Ø¬Ù‡Ø²Ø© Ø±ÙŠØ§Ø¶ÙŠØ©', icon: 'ğŸ‹ï¸' },
            { name: 'ÙÙ†ÙŠ ØµÙŠØ§Ù†Ø© Ø£Ø¬Ù‡Ø²Ø© Ø·Ø¨Ø§Ø¹Ø©', icon: 'ğŸ–¨ï¸' },
            { name: 'Ø£Ø®ØµØ§Ø¦ÙŠ Ù…ÙˆØ§Ø±Ø¯ Ø¨ÙŠØ¦ÙŠØ©', icon: 'â™»ï¸' },
            { name: 'Ø£Ø®Ø±Ù‰ (Ù…Ù‡Ù† Ø­Ø±Ø©/Ø¹Ø§Ù…Ø©)', icon: 'ğŸ‘¥' },
        ]; 




        const SERVICES_LIST = sortServices(SERVICES_LIST_UNSORTED);




        // Ù‚Ø§Ø¦Ù…Ø© Ù…Ø±Ø§ÙƒØ² ÙˆÙ…Ø¯Ù† Ø§Ù„Ø´Ø±Ù‚ÙŠØ©
        const SHARQIA_CITIES = [
            "Ø§Ù„Ø²Ù‚Ø§Ø²ÙŠÙ‚", "Ø¨Ù„Ø¨ÙŠØ³", "Ø§Ù„Ø¹Ø§Ø´Ø± Ù…Ù† Ø±Ù…Ø¶Ø§Ù†", "Ø£Ø¨Ùˆ ÙƒØ¨ÙŠØ±", "ÙØ§Ù‚ÙˆØ³", "Ù…Ù†ÙŠØ§ Ø§Ù„Ù‚Ù…Ø­", 
            "Ø¯ÙŠØ±Ø¨ Ù†Ø¬Ù…", "ÙƒÙØ± ØµÙ‚Ø±", "Ø£Ø¨Ùˆ Ø­Ù…Ø§Ø¯", "Ø§Ù„Ù‚Ø±ÙŠÙ†", "Ø§Ù„Ù‚Ù†Ø§ÙŠØ§Øª", "Ù…Ø´ØªÙˆÙ„ Ø§Ù„Ø³ÙˆÙ‚", 
            "Ù‡Ù‡ÙŠØ§", "Ø§Ù„Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…ÙŠØ©", "Ø£ÙˆÙ„Ø§Ø¯ ØµÙ‚Ø±", "Ø§Ù„ØµØ§Ù„Ø­ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø§Ù„Ø­Ø³ÙŠÙ†ÙŠØ©"
        ];








        // 5. Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª SVG 
        const ICONS = {
            star: `<svg class="star-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/></svg>`,
            starEmpty: `<svg class="star-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.31h5.513c.498 0 .704.656.34.985l-4.46 4.062a.562.562 0 0 0-.162.541l1.618 5.22c.19.613-.526 1.09-1.04.724l-4.59-3.44a.563.563 0 0 0-.642 0l-4.59 3.44c-.514.366-1.23-.111-1.04-.724l1.618-5.22a.562.562 0 0 0-.162-.541l-4.46-4.062a.563.563 0 0 1 .34-.985h5.513a.563.563 0 0 0 .475.31l2.125-5.112Z" /></svg>`,
            home: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" /></svg>`,
            users: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-3.741-5.582M11.995 12.75a9.004 9.004 0 0 1-5.214 0m-2.5 4.972a9.094 9.094 0 0 1 3.741-.479 3 3 0 0 1 3.741 5.582M12 12a4.5 4.5 0 1 0 0-9 4.5 4.5 0 0 0 0 9Zm-5.214 0a9.004 9.004 0 0 0 5.214 0M12 12a4.5 4.5 0 1 1 0-9 4.5 4.5 0 0 1 0 9Zm5.214 0a9.004 9.004 0 0 0-5.214 0" /></svg>`,
            add: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>`,
            profile: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>`,
            chat: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193l-3.72 3.72a.75.75 0 0 1-1.06 0l-3.72-3.72C9.847 17.1 9 16.136 9 15v-4.286c0-.97 0.616-1.813 1.5-2.097l6.75-3.375c.22-.11.459-.11.679 0l6.75 3.375Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.5c.884-.284 1.5-1.128 1.5-2.097V7.116c0-1.136.847-2.1 1.98-2.193l3.72-3.72a.75.75 0 0 1 1.06 0l3.72 3.72C16.153 5.016 17 5.98 17 7.116v4.286c0 .97-.616 1.813-1.5 2.097l-6.75 3.375a.625.625 0 0 1-.679 0L3 13.5Z" /></svg>`,
            logout: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15M12 9l-3 3m0 0 3 3m-3-3h12.75" /></svg>`,
            back: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 8.25 21 12m0 0-3.75 3.75M21 12H3" /></svg>`, // RTL back arrow
            send: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L6 12Z" /></svg>`,
            edit: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 18.07a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.862 4.487Zm0 0L19.5 7.125" /></svg>`,
            camera: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.322 2.322 0 0 1 5.86 7.5v10.375A2.322 2.322 0 0 0 8.182 20.25h8.375A2.322 2.322 0 0 0 18.916 18V7.5a2.322 2.322 0 0 1-1.077-1.325M12 9.75a2.25 2.25 0 1 0 0 4.5 2.25 2.25 0 0 0 0-4.5Z" /></svg>`,
            job: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21h16.5M4.5 3h15M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25M9 13.5h6" /></svg>`,
            trash: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.24 6.913m1.018 0h16.5M16.5 6.75h-9" /></svg>`,
            settings: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.875 1.486.82 2.668 2.05 3.37 3.568.163.33.194.71.09 1.055l-.202.73a1.125 1.125 0 0 1-.362.683l-1.704 1.705a1.125 1.125 0 0 0-.362.684l.202.73c.104.345.073.725-.09 1.055-.702 1.518-1.884 2.748-3.37 3.568a1.125 1.125 0 0 1-.645.875l-.213 1.281c-.09.542-.56.94-1.11.94h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281a1.125 1.125 0 0 1-.645-.875c-1.486-.82-2.668-2.05-3.37-3.568a1.125 1.125 0 0 1-.09-1.055l.202-.73a1.125 1.125 0 0 0-.362-.683l-1.704-1.705a1.125 1.125 0 0 0-.362-.684l.202-.73c.104-.345.073-.725-.09-1.055-.702-1.518-1.884-2.748-3.37-3.568a1.125 1.125 0 0 1-.645-.875l-.213-1.281Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>`,
            bell: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.043 5.454 1.31Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75a.75.75 0 0 0 0 1.5h-9a.75.75 0 0 0 0-1.5Z" /></svg>`,
        };








        // 6. Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        const appContainer = document.getElementById('app');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalContent = document.getElementById('modal-content');




        // === Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ===
        let isUserOnline = false;




        // 7. ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© (Modal)
        function showModal(html) {
            modalContent.innerHTML = html;
            modalBackdrop.classList.remove('hidden');
        }








        function hideModal() {
            modalBackdrop.classList.add('hidden');
            modalContent.innerHTML = '';
        }








        function showLoading(message = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...') {
            // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 1: Ø¥Ø²Ø§Ù„Ø© animate-spin ===
            const html = `
                <div class="flex flex-col items-center justify-center p-6">
                    <svg class="h-10 w-10 text-indigo-800 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-gray-700 font-medium">${message}</p>
                </div>
            `;
            showModal(html);
        }








        function hideLoading() {
            hideModal();
        }








        function showMessageModal(title, message, isSuccess = true) {
            const color = isSuccess ? 'text-green-600' : 'text-red-600';
            const html = `
                <h2 class="text-xl font-semibold text-center ${color} mb-4">${title}</h2>
                <p class="text-center text-gray-700">${message}</p>
                <button data-action="closeModal" class="mt-4 w-full py-2 bg-indigo-800 text-white rounded-md hover:bg-indigo-700">Ø­Ø³Ù†Ø§Ù‹</button>
            `;
            showModal(html);
        }








        // ÙˆØ¸ÙŠÙØ© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¶ØºØ· ÙˆØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Base64
        function resizeAndConvertImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (readerEvent) => {
                    const img = new Image();
                    img.onload = () => {
                        const MAX_SIZE = 400; 
                        let width = img.width;
                        let height = img.height;








                        if (width > height) {
                            if (width > MAX_SIZE) {
                                height *= MAX_SIZE / width;
                                width = MAX_SIZE;
                            }
                        } else {
                            if (height > MAX_SIZE) {
                                width *= MAX_SIZE / height;
                                height = MAX_SIZE;
                            }
                        }








                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);








                        // Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Base64 Ù…Ø¹ Ø¶ØºØ· Ø§Ù„Ø¬ÙˆØ¯Ø©
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.6); 
                        resolve(dataUrl); 
                    };
                    img.src = readerEvent.target.result;
                };
                reader.onerror = reject;
            });
        }




        // === Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­Ø°Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (48 Ø³Ø§Ø¹Ø©) ===
        async function attemptAutoDelete(docId, docData, collectionName) {
            if (!docData.createdAt || !docData.createdAt.toDate) return;








            const postTime = docData.createdAt.toDate().getTime();
            const currentTime = Date.now();




            if (currentTime - postTime > AUTO_DELETE_MS) {
                console.log(`Attempting to auto-delete old post (${collectionName}): ${docId}`);
                try {
                    const docRef = doc(db, `artifacts/${appId}/public/data/${collectionName}`, docId);
                    await deleteDoc(docRef);
                    console.log(`Successfully auto-deleted: ${docId}`);
                    return true; // ØªÙ… Ø§Ù„Ø­Ø°Ù
                } catch (error) {
                    console.error(`Error during auto-delete of ${docId} in ${collectionName}:`, error);
                    return true; // Ù†ÙØªØ±Ø¶ Ø£Ù†Ù‡ ØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡ Ø£Ùˆ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡
                }
            }
            return false; // Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­Ø°Ù
        }




        // === Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¸Ù‡ÙˆØ± (isOnline) (Ù…Ø­Ø¯Ø«Ø©) ===
        async function updateOnlineStatus(isOnline) {
            if (userId) {
                isUserOnline = isOnline;
                try {
                    const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                    await updateDoc(userDocRef, {
                        isOnline: isOnline,
                        lastSeen: Timestamp.now()
                    });
                } catch (error) {
                    console.error("Error updating online status:", error);
                }
            }
        }




        // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 5: Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… lastSeen ===
        function getOnlineStatusHtml(user) {
            // Check if lastSeen is within the threshold
            const lastSeenTime = user.lastSeen && user.lastSeen.toMillis ? user.lastSeen.toMillis() : 0;
            const currentTime = Date.now();
            
            // A user is considered online if:
            // 1. The 'isOnline' flag is true AND
            // 2. The 'lastSeen' timestamp is recent (within ONLINE_THRESHOLD_MS)
            const isActuallyOnline = user.isOnline && (currentTime - lastSeenTime < ONLINE_THRESHOLD_MS);

            const color = isActuallyOnline ? 'bg-green-500' : 'bg-gray-400';
            const text = isActuallyOnline ? 'Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†' : 'ØºÙŠØ± Ù…ØªØµÙ„';
            // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 1: Ø¥Ø²Ø§Ù„Ø© animate-ping ===
            const ping = isActuallyOnline ? `<span class="absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>` : '';

            return `
                <div class="flex items-center text-gray-500">
                    <span class="relative flex h-2 w-2">
                        ${ping}
                        <span class="relative inline-flex rounded-full h-2 w-2 ${color}"></span>
                    </span>
                    <span class="mr-2 text-xs font-medium">${text}</span>
                </div>
            `;
        }




        // === Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Ù…Ø­Ø¯Ø«Ø©) ===
        async function updateNotificationCount(change = 0) {
            if (userId) {
                try {
                    const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                    if (change !== 0) {
                        await updateDoc(userDocRef, {
                            unreadNotifications: increment(change)
                        });
                    }
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
                    const userDoc = await getDoc(userDocRef);
                    if (userDoc.exists()) {
                        userProfile = userDoc.data();
                    }
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø±Ø³
                    const currentRoute = navigationHistory[navigationHistory.length - 1];
                    if (currentRoute && (currentRoute.page === 'clientHome' || currentRoute.page === 'providerHome')) {
                        navigateTo(currentRoute.page, currentRoute.params);
                    }
                } catch (error) {
                    console.error("Error updating notification count:", error);
                }
            }
        }




        // === Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø´Ø¹Ø§Ø± (Ù…Ø­Ø¯Ø«Ø©) ===
        async function createNotification(recipientId, type, title, linkPage, linkParams = {}) {
            if (recipientId === userId) return; // Ù„Ø§ ØªØ±Ø³Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Ù‹ Ù„Ù†ÙØ³Ùƒ




            const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, recipientId);
            const userDoc = await getDoc(userDocRef);
            if (!userDoc.exists()) return;
            const recipientProfile = userDoc.data();




            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù„Ù…Ø³ØªÙ„Ù…
            if (!recipientProfile.isNotificationsEnabled) return;
            if (type === 'message' && !recipientProfile.isMessageNotificationsEnabled) return;
            if (type === 'job' && !recipientProfile.isJobNotificationsEnabled) return;
            if (type === 'request' && !recipientProfile.isRequestNotificationsEnabled) return;




            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¬Ø§Ù„ (Ù„Ù„ÙˆØ¸Ø§Ø¦Ù ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª)
            if ((type === 'job' || type === 'request') && recipientProfile.role === 'provider' && recipientProfile.jobTitle !== title.split(': ')[1]) {
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ù‚Ø¯Ù… Ø®Ø¯Ù…Ø© ÙˆØ§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù„ÙŠØ³ ÙÙŠ Ù…Ø¬Ø§Ù„Ù‡ØŒ Ù„Ø§ ØªØ±Ø³Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
                return;
            }




            const notificationsColRef = collection(db, `artifacts/${appId}/public/data/notifications`);
            await addDoc(notificationsColRef, {
                recipientId: recipientId,
                senderId: userId,
                type: type,
                title: title,
                isRead: false,
                linkPage: linkPage,
                linkParams: linkParams,
                createdAt: Timestamp.now()
            });




            // Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©
            await updateDoc(userDocRef, {
                unreadNotifications: increment(1)
            });
            
            // âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø®Ø§Ø±Ø¬ÙŠ (Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ø§Ù„Ù…ØªØµÙØ­ Ù…ØºÙ„Ù‚Ø§Ù‹)ØŒ ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø¯Ù…Ø©
            // Ù…Ø«Ù„ Firebase Cloud Messaging (FCM) ÙˆØªØ®Ø²ÙŠÙ† Ø±Ù…Ø² Ø§Ù„Ø¬Ù‡Ø§Ø² (FCM Token) Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            // ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø¨Ø± Ø®Ø§Ø¯Ù… Ø®Ù„ÙÙŠ. Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙŠØ±Ø³Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¯Ø§Ø®Ù„ÙŠØ© ÙÙ‚Ø·.
        }
        
        // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 1: Ø¯Ø§Ù„Ø© Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© ===
        function requestNotificationPermission() {
            if ('Notification' in window) {
                if (Notification.permission === 'default') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            console.log('âœ… Notification permission granted.');
                            // ÙŠÙ…ÙƒÙ†Ùƒ Ù‡Ù†Ø§ ØªÙØ¹ÙŠÙ„ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² FCM Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                        } else {
                            console.log('âŒ Notification permission denied or blocked.');
                        }
                    });
                } else if (Notification.permission === 'granted') {
                    console.log('âœ… Notification permission already granted.');
                }
            }
        }




        // === Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Ù…Ø­Ø¯Ø«Ø© - Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„) ===
        async function renderNotificationsPage() {
            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <h1 class="text-xl font-bold">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h1>
                        <button data-action="goBack" class="bg-white text-indigo-800 rounded-full p-1 w-7 h-7 flex items-center justify-center hover:bg-gray-100">
                            ${ICONS.back}
                        </button>
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <div id="notifications-list" class="space-y-3">
                            <p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª...</p>
                        </div>
                    </main>
                    
                    ${renderBottomNav(userProfile?.role === 'provider' ? 'home' : 'home')}
                </div>
            `;




            const notificationsColRef = collection(db, `artifacts/${appId}/public/data/notifications`);
            // === Ø¥ØµÙ„Ø§Ø­: Ø§Ø³ØªØ®Ø¯Ø§Ù… where('recipientId', '==', userId) ÙÙ‚Ø·ØŒ ÙˆØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ createdAt
            const q = query(notificationsColRef, 
                            where('recipientId', '==', userId), 
                            orderBy('createdAt', 'desc'));




            currentUnsubscribe = onSnapshot(q, (snapshot) => {
                const listEl = document.getElementById('notifications-list');
                if (!listEl) return;




                const notifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));




                if (notifications.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©.</p>';
                    return;
                }




                listEl.innerHTML = notifications.map(n => {
                    const bgColor = n.isRead ? 'bg-white' : 'bg-indigo-50 border-indigo-200';
                    const dateString = n.createdAt && n.createdAt.toDate ? new Date(n.createdAt.toDate()).toLocaleString('ar-EG') : 'ØªØ§Ø±ÙŠØ® ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    const icon = n.type === 'message' ? ICONS.chat : (n.type === 'job' ? ICONS.job : ICONS.add);




                    return `
                        <div data-action="readNotification" data-id="${n.id}" data-page="${n.linkPage}" data-params='${JSON.stringify(n.linkParams)}'
                             class="${bgColor} p-3 rounded-lg shadow-sm border cursor-pointer hover:shadow-md flex items-start space-x-3 space-x-reverse">
                            <span class="flex-shrink-0 text-indigo-600">${icon}</span>
                            <div class="flex-1">
                                <h3 class="text-sm font-semibold text-gray-900">${n.title}</h3>
                                <p class="text-xs text-gray-500 mt-1">${dateString}</p>
                            </div>
                        </div>
                    `;
                }).join('');
            }, (error) => {
                 console.error("Error fetching notifications: ", error);
                 document.getElementById('notifications-list').innerHTML = '<p class="text-red-500 text-center p-6 bg-white rounded-lg shadow-sm">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª.</p>';
            });
        }




        // 8. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ (Routing) 
        function navigateTo(page, params = {}) {
            console.log(`Navigating to: ${page}`, params);
            if (currentUnsubscribe) {
                currentUnsubscribe();
                currentUnsubscribe = null;
                console.log('Unsubscribed from real-time listener.');
            }




            // === ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¸Ù‡ÙˆØ± Ø¹Ù†Ø¯ Ø§Ù„ØªÙ†Ù‚Ù„ (Ù…Ø­Ø¯Ø«) ===
            if (userId) {
                updateOnlineStatus(true);
            }




            const newRoute = { page, params };
            if (page !== 'loading' && page !== 'auth' && page !== 'register') {
                const lastRoute = navigationHistory[navigationHistory.length - 1];
                if (!lastRoute || lastRoute.page !== page || JSON.stringify(lastRoute.params) !== JSON.stringify(params)) {
                    navigationHistory.push(newRoute);
                    if(navigationHistory.length > 20) {
                        navigationHistory.shift();
                    }
                }
            } else if (page === 'auth' || page === 'register') {
                navigationHistory = [];
                navigationHistory.push(newRoute);
            }








            appContainer.innerHTML = ''; 
            window.scrollTo(0, 0);








            // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø©
            document.title = getPageTitle(page);
            
            // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 7: ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† ===
            applyDarkMode(userProfile?.isDarkModeEnabled);








            switch (page) {
                case 'loading':
                    renderLoadingScreen();
                    break;
                case 'auth':
                    renderAuthPage();
                    break;
                case 'register':
                    renderRegisterPage();
                    break;
                case 'clientHome':
                    renderClientHome();
                    break;
                case 'providerHome':
                    renderProviderHome();
                    break;
                case 'category':
                    renderCategoryPage(params.category);
                    break;
                case 'directory':
                    renderDirectoryPage();
                    break;
                case 'chatList':
                    renderChatListPage();
                    break;
                case 'notifications': 
                    renderNotificationsPage();
                    break;
                case 'profile':
                    renderProfilePage(params.uid);
                    break;
                case 'editProfile': 
                    renderEditProfilePage();
                    break;
                case 'settings': 
                    renderSettingsPage();
                    break;
                case 'chat':
                    renderChatPage(params.otherUserId);
                    break;
                case 'newRequest':
                    renderNewRequestPage();
                    break;
                case 'jobListings':
                    renderJobListingsPage();
                    break;
                case 'jobPosting':
                    renderJobPostingPage();
                    break;
                case 'myPostings': 
                    renderMyPostingsPage();
                    break;
                default:
                    renderAuthPage(); 
            }
        }








        function getPageTitle(page) {
            switch(page) {
                case 'auth': return 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ù…Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠØ©';
                case 'register': return 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ - Ù…Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠØ©';
                case 'clientHome':
                case 'providerHome': return 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© - Ù…Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠØ©';
                case 'directory': return 'Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† - Ù…Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠØ©';
                case 'chatList': return 'Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª - Ù…Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠØ©';
                case 'notifications': return 'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª - Ù…Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠØ©'; 
                case 'jobListings': return 'Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…ØªØ§Ø­Ø© - Ù…Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠØ©';
                case 'myPostings': return 'Ø¥Ø¹Ù„Ø§Ù†Ø§ØªÙŠ ÙˆØ·Ù„Ø¨Ø§ØªÙŠ - Ù…Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠØ©';
                case 'profile': return 'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ - Ù…Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠØ©';
                case 'settings': return 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª - Ù…Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠØ©'; 
                default: return 'Ù…Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠØ©';
            }
        }
        
        // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 7: Ø¯Ø§Ù„Ø© ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† ===
        function applyDarkMode(isDarkModeEnabled) {
            const body = document.body;
            if (isDarkModeEnabled) {
                body.classList.add('dark');
            } else {
                body.classList.remove('dark');
            }
        }




        // === Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¹Ø±Ø¶ Ø¬Ø±Ø³ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Ù…Ø­Ø¯Ø«Ø© - Ø§Ù„Ø·Ù„Ø¨ 5) ===
        function renderNotificationBell() {
            const unreadCount = userProfile?.unreadNotifications || 0;
            const bellClass = unreadCount > 0 ? 'text-red-500' : 'text-white hover:text-indigo-100';
            const bellDot = unreadCount > 0 ? `
                <span class="absolute top-0 right-0 block h-4 w-4 rounded-full ring-2 ring-indigo-800 bg-red-500 text-xs text-white flex items-center justify-center -mt-1 -mr-1">
                    ${unreadCount > 9 ? '9+' : unreadCount}
                </span>
            ` : '';




            return `
                <button data-action="navigateTo" data-page="notifications" class="relative flex items-center p-1 ${bellClass} rounded-full">
                    ${bellDot}
                    ${ICONS.bell}
                    <span class="text-xs font-medium mr-1 text-white">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span> 
                </button>
            `;
        }




        // 9. ÙˆØ¸Ø§Ø¦Ù Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø§Øª (Render Functions)








        function renderLoadingScreen() {
            appContainer.innerHTML = `
                <div class="flex items-center justify-center min-h-screen">
                    <div class="flex flex-col items-center">
                        <!-- === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 1: Ø¥Ø²Ø§Ù„Ø© animate-spin === -->
                        <svg class="h-12 w-12 text-indigo-800 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <h1 class="text-xl font-semibold text-gray-700">Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...</h1>
                    </div>
                </div>
            `;
        }








        function renderAuthPage() {
            appContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-screen p-4 bg-indigo-800">
                    <h1 class="text-4xl font-bold text-white mb-4">Ù…Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</h1>
                    <p class="text-lg text-indigo-100 mb-8 text-center">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø®Ø¯Ù…Ø§Øª Ù…Ø­Ø§ÙØ¸Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</p>
                    
                    <div class="w-full max-w-sm bg-white rounded-lg shadow-xl p-6">
                        <form id="login-form" class="space-y-4">
                            <h2 class="text-2xl font-semibold text-center text-gray-800 mb-4">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
                            <div id="login-error" class="text-red-500 text-sm text-center hidden"></div>
                            
                            <!-- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 2: ØªØ·Ø¨ÙŠÙ‚ ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ÙˆØ­Ø¯ -->
                            <div class="register-input-card">
                                <label for="login-identifier">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                                <input type="text" id="login-identifier" required class="mt-1 block w-full text-gray-900 text-sm" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                            </div>
                            <div class="register-input-card">
                                <label for="login-password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                                <input type="password" id="login-password" required class="mt-1 block w-full text-gray-900 text-sm" placeholder="********">
                            </div>
                            <button type="submit" data-action="login" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Ø¯Ø®ÙˆÙ„
                            </button>
                        </form>
                        
                        <div class="my-4 flex items-center justify-center">
                            <span class="border-t border-gray-300 flex-grow"></span>
                            <span class="px-4 text-sm text-gray-500">Ø£Ùˆ</span>
                            <span class="border-t border-gray-300 flex-grow"></span>
                        </div>
                        
                        <button data-action="navigateTo" data-page="register" class="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
                        </button>
                    </div>
                </div>
            `;
        }








        function renderRegisterPage() {
            const serviceOptions = SERVICES_LIST.map(service => 
                `<option value="${service.name}">${service.name}</option>`
            ).join('');








            const cityOptions = SHARQIA_CITIES.map(city => 
                `<option value="${city}">${city}</option>`
            ).join('');








            appContainer.innerHTML = `
                <!-- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 5: ØªØºÙŠÙŠØ± Ø®Ù„ÙÙŠØ© Ø§Ù„Ø´Ø§Ø´Ø© Ù„Ù€ indigo-800 -->
                <div class="min-h-screen main-padding bg-indigo-800 flex items-start justify-center pt-8 pb-24">
                    <div class="w-full max-w-md">
                         <h1 class="text-2xl font-bold text-white mb-6 text-center">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h1>
                         <!-- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 5: Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ Ø§Ù„Ø²Ø¬Ø§Ø¬ Ø§Ù„Ø´ÙØ§Ù -->
                        <form id="register-form" class="space-y-4 glassy-indigo-bg p-6 rounded-lg shadow-2xl mx-auto">
                            <div id="register-error" class="text-red-600 text-sm text-center font-bold hidden bg-red-100 p-2 rounded-md"></div>
                            
                            <!-- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 2: ØªØ·Ø¨ÙŠÙ‚ ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ÙˆØ­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© -->
                            <div class="register-input-card p-4">
                                <input type="file" id="photo-upload-input" accept="image/*" class="hidden">
                                <label for="photo-upload-input" class="block text-sm font-medium text-gray-900 text-center cursor-pointer">
                                    Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                                    <div class="mt-2 flex flex-col items-center justify-center">
                                        <img id="photo-preview" class="w-24 h-24 rounded-full object-cover register-photo-preview border-gray-300 p-1 hover:border-indigo-500" 
                                             src="https://placehold.co/100x100/EBF8FF/3182CE?text=User" alt="ØµÙˆØ±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©">
                                        <span class="text-xs text-indigo-500 mt-2 hover:underline">Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ ØµÙˆØ±ØªÙƒ</span>
                                    </div>
                                </label>
                                <input type="hidden" id="photo-base64" value="">
                            </div>
                            
                            <hr class="my-3 border-gray-300">
                            
                            <!-- === ØªÙ†Ø³ÙŠÙ‚ Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 5) === -->
                            <div class="register-input-card">
                                <label for="register-username">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                                <input type="text" id="register-username" required class="mt-1 block w-full text-gray-900 text-sm" placeholder="Ù…Ø«Ø§Ù„: myname123">
                            </div>
                            
                            <div class="register-input-card">
                                <label for="register-password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (6 Ø­Ø±ÙˆÙ Ø£Ùˆ Ø£Ø±Ù‚Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)</label>
                                <input type="password" id="register-password" required minlength="6" class="mt-1 block w-full text-gray-900 text-sm" placeholder="********">
                            </div>
                            
                            <hr class="my-3 border-gray-300">
                            
                            <div class="register-input-card">
                                <label for="register-name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                                <input type="text" id="register-name" required class="mt-1 block w-full text-gray-900 text-sm" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ">
                            </div>
                            <div class="register-input-card">
                                <label for="register-phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (11 Ø±Ù‚Ù…)</label>
                                <input type="tel" id="register-phone" required pattern="[0-9]{11}" maxlength="11" class="mt-1 block w-full text-gray-900 text-sm" placeholder="Ù…Ø«Ø§Ù„: 01012345678">
                            </div>
                            
                            <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ù†Ø³ -->
                            <div class="register-input-card">
                                <label class="block text-sm font-medium text-gray-900">Ø§Ù„Ø¬Ù†Ø³</label>
                                <div class="mt-1 flex space-x-4 space-x-reverse">
                                    <label class="flex items-center">
                                        <input type="radio" name="gender" value="Ø°ÙƒØ±" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" required>
                                        <span class="mr-2 text-gray-700 text-sm">Ø°ÙƒØ±</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="gender" value="Ø£Ù†Ø«Ù‰" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" required>
                                        <span class="mr-2 text-gray-700 text-sm">Ø£Ù†Ø«Ù‰</span>
                                    </label>
                                </div>
                            </div>








                            
                            <!-- ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø¹Ù†ÙˆØ§Ù† -->
                            <div class="register-input-card">
                                <label for="register-city">Ø§Ù„Ù…Ø±ÙƒØ² / Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
                                <select id="register-city" required class="mt-1 block w-full text-gray-900 text-sm bg-white">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²/Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</option>
                                    ${cityOptions}
                                </select>
                            </div>
                            <div class="register-input-card">
                                <label for="register-area">Ø§Ù„Ù…Ù†Ø·Ù‚Ø© / ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                                <input type="text" id="register-area" required class="mt-1 block w-full text-gray-900 text-sm" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù‚ÙˆÙ…ÙŠØ©ØŒ Ø´Ø§Ø±Ø¹ 33">
                            </div>
                            
                            <hr class="my-3 border-gray-300">
                            
                            <div class="register-input-card">
                                <label class="block text-sm font-medium text-gray-900">Ø£Ø±ØºØ¨ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙƒÙ€:</label>
                                <div class="mt-2 flex space-x-4 space-x-reverse">
                                    <label class="flex items-center">
                                        <input type="radio" name="role" value="client" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" checked>
                                        <span class="mr-2 text-gray-700 text-sm">Ø¹Ù…ÙŠÙ„</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="role" value="provider" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                                        <span class="mr-2 text-gray-700 text-sm">Ù…Ù‚Ø¯Ù… Ø®Ø¯Ù…Ø©</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div id="job-title-field" class="hidden space-y-4">
                                <div class="register-input-card">
                                    <label for="register-job-select">Ø§Ø®ØªØ± ÙˆØ¸ÙŠÙØªÙƒ / Ø§Ù„Ø®Ø¯Ù…Ø©:</label>
                                    <select id="register-job-select" required class="mt-1 block w-full text-gray-900 text-sm bg-white">
                                        <option value="">Ø§Ø®ØªØ±...</option>
                                        ${serviceOptions}
                                    </select>
                                </div>
                            </div>
                            
                            <button type="submit" data-action="register" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨
                            </button>
                            
                            <p class="text-center text-xs text-gray-700">
                                Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ 
                                <button type="button" data-action="navigateTo" data-page="auth" class="font-medium text-indigo-700 hover:text-indigo-900">
                                    Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                                </button>
                            </p>
                        </form>
                    </div>
                </div>
            `;








            // ØªÙ‡ÙŠØ¦Ø© Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©
            document.getElementById('photo-upload-input').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;








                showLoading('Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©...');
                try {
                    const base64Image = await resizeAndConvertImage(file);
                    document.getElementById('photo-preview').src = base64Image;
                    document.getElementById('photo-base64').value = base64Image;
                } catch (error) {
                    console.error("Image processing error:", error);
                    showMessageModal('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©', 'Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨ØµÙˆØ±Ø© Ø£Ø®Ø±Ù‰.', false);
                } finally {
                    hideLoading();
                }
            });
        }








        function renderClientHome() {
            const categoriesHtml = SERVICES_LIST.map(cat => `
                <div data-action="navigateTo" data-page="category" data-category="${cat.name.toLowerCase()}" 
                     class="flex flex-col items-center justify-center bg-indigo-50 p-3 rounded-lg shadow-sm hover:shadow-md cursor-pointer border border-indigo-200 hover:border-indigo-500">
                    <span class="text-3xl mb-1">${cat.icon}</span>
                    <h3 class="text-xs font-semibold text-gray-800 text-center">${cat.name}</h3>
                </div>
            `).join('');








            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white welcome-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <div>
                            <h1 class="text-lg font-bold">Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ ${userProfile.name}</h1>
                            <p class="text-indigo-100 text-xs">Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬Ù‡Ø§ ÙÙŠ Ù…Ø­Ø§ÙØ¸Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</p>
                        </div>
                        ${renderNotificationBell()}
                    </header>
                    
                    <main class="main-padding">
                        <h2 class="text-base font-semibold text-gray-900 mb-4">Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h2>
                        <div class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 gap-3">
                            ${categoriesHtml}
                        </div>
                    </main>
                    
                    <button data-action="navigateTo" data-page="newRequest" 
                            class="fixed bottom-16 left-4 bg-indigo-600 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center z-30 hover:bg-indigo-700">
                        ${ICONS.add}
                    </button>
                    
                    ${renderBottomNav('home')}
                </div>
            `;
        }








        // === Ø¯Ø§Ù„Ø© Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù…Ù‚Ø¯Ù… Ø§Ù„Ø®Ø¯Ù…Ø© (ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… ÙˆØ§Ù„ÙØ±Ø²) ===
        async function renderProviderHome() {
            const categoriesHtml = SERVICES_LIST.map(cat => `
                <div data-action="navigateTo" data-page="category" data-category="${cat.name.toLowerCase()}" 
                     class="flex flex-col items-center justify-center bg-indigo-50 p-3 rounded-lg shadow-sm hover:shadow-md cursor-pointer border border-indigo-200 hover:border-indigo-500">
                    <span class="text-3xl mb-1">${cat.icon}</span>
                    <h3 class="text-xs font-semibold text-gray-800 text-center">${cat.name}</h3>
                </div>
            `).join('');








            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white welcome-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <div>
                            <h1 class="text-lg font-bold">Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ ${userProfile.name}</h1>
                            <p class="text-indigo-100 text-xs">ØªØµÙØ­ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ø£Ùˆ Ø§Ø·Ù„Ø¨ Ø®Ø¯Ù…Ø© Ø¨Ù†ÙØ³Ùƒ</p>
                        </div>
                        ${renderNotificationBell()}
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© (Ù„Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡) -->
                        <h2 class="text-base font-semibold text-gray-900 mb-4">Ø·Ù„Ø¨Ø§Øª ÙˆØ¸ÙŠÙØ© ${userProfile.jobTitle || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©'} Ø§Ù„Ù…ØªØ§Ø­Ø©</h2>
                        <div id="requests-list" class="space-y-3">
                            <p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
                        </div>
                        
                        <!-- Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø®Ø¯Ù…Ø§Øª (Ù„ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ø·Ù„Ø¨ Ø®Ø¯Ù…Ø© ÙƒØ¹Ù…ÙŠÙ„) -->
                        <h2 class="text-base font-semibold text-gray-900 mt-6 mb-4 border-t pt-4">Ø§Ø·Ù„Ø¨ Ø®Ø¯Ù…Ø© Ø£Ùˆ ØªØµÙØ­ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h2>
                        <div class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 gap-3">
                            ${categoriesHtml}
                        </div>
                    </main>
                    
                    <button data-action="navigateTo" data-page="newRequest" 
                            class="fixed bottom-16 left-4 bg-indigo-600 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center z-30 hover:bg-indigo-700">
                        ${ICONS.add}
                    </button>
                    
                    ${renderBottomNav('home')}
                </div>
            `;








            const requestsColRef = collection(db, `artifacts/${appId}/public/data/serviceRequests`);








            // 1. Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙŠ ØªØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ ÙˆØ¸ÙŠÙØ© Ù…Ù‚Ø¯Ù… Ø§Ù„Ø®Ø¯Ù…Ø© (Ø¨Ø¯ÙˆÙ† orderBy)
            const jobSpecificQuery = query(requestsColRef, where('category', '==', userProfile.jobTitle));








            currentUnsubscribe = onSnapshot(jobSpecificQuery, async (snapshot) => {
                const requestsList = document.getElementById('requests-list');
                let requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));




                // === ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø°Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ===
                const validRequests = [];
                for (const req of requests) {
                    const isDeleted = await attemptAutoDelete(req.id, req, 'serviceRequests');
                    if (!isDeleted) {
                        validRequests.push(req);
                    }
                }
                requests = validRequests;




                // === Ø§Ù„ÙØ±Ø² Ø§Ù„ÙŠØ¯ÙˆÙŠ (Client-Side Sorting) ===
                requests.sort((a, b) => {
                    const timeA = a.createdAt && a.createdAt.toMillis ? a.createdAt.toMillis() : 0;
                    const timeB = b.createdAt && b.createdAt.toMillis ? b.createdAt.toMillis() : 0;
                    return timeB - timeA;
                });








                if (requests.length === 0) {
                    // 2. Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„ÙˆØ¸ÙŠÙØªÙ‡ØŒ ÙŠØ¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø®Ø¯Ù…Ø© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"
                    requestsList.innerHTML = '<p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø®Ø¯Ù…Ø© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„ÙˆØ¸ÙŠÙØ© ' + (userProfile.jobTitle || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©') + '.</p>';
                } else {
                    requestsList.innerHTML = generateRequestList(requests);
                }
            }, (error) => {
                console.error("Error fetching requests: ", error);
                document.getElementById('requests-list').innerHTML = '<p class="text-red-500 p-6 bg-white rounded-lg shadow-sm">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª.</p>';
            });








            function generateRequestList(requests, emptyMessage = `Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„ÙˆØ¸ÙŠÙØ© ${userProfile.jobTitle || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©'}.`) {
                 if (requests.length === 0) {
                     return `<p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">${emptyMessage}</p>`;
                 }
                return requests.map(req => {
                    const dateString = req.createdAt && req.createdAt.toDate ? new Date(req.createdAt.toDate()).toLocaleDateString('ar-EG') : 'ØªØ§Ø±ÙŠØ® ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    return `
                    <div class="bg-indigo-50 p-4 rounded-lg shadow-md border border-indigo-200">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-3 space-x-reverse">
                                <img data-action="navigateTo" data-page="profile" data-uid="${req.requesterId}"
                                     src="${req.requesterPhoto || 'https://placehold.co/100x100/EBF8FF/3182CE?text=User'}" 
                                     alt="${req.requesterName}" class="w-10 h-10 rounded-full object-cover cursor-pointer">
                                <div>
                                    <h4 data-action="navigateTo" data-page="profile" data-uid="${req.requesterId}" 
                                        class="font-semibold text-gray-800 text-sm cursor-pointer hover:text-indigo-600">${req.requesterName}</h4>
                                    <p class="text-xs text-gray-500">Ø·Ù„Ø¨ Ø®Ø¯Ù…Ø©: ${req.category}</p>
                                </div>
                            </div>
                            <span class="text-xs text-gray-400">${dateString}</span>
                        </div>
                        <h3 class="text-base font-semibold text-gray-900 mb-1">${req.title}</h3>
                        <p class="text-sm text-gray-600 mb-3">${req.description.substring(0, 100)}...</p>
                        <button data-action="navigateTo" data-page="chat" data-otheruserid="${req.requesterId}"
                                class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md text-sm font-medium hover:bg-indigo-700">
                            ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„
                        </button>
                    </div>
                `}).join('');
            }
        }








        async function renderCategoryPage(categoryName) {
            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <h1 class="text-lg font-bold">Ù…Ù‚Ø¯Ù…Ùˆ Ø®Ø¯Ù…Ø©: ${categoryName || 'ÙƒÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª'}</h1>
                        <button data-action="goBack" class="bg-white text-indigo-800 rounded-full p-1 w-7 h-7 flex items-center justify-center hover:bg-gray-100">
                            ${ICONS.back}
                        </button>
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <div id="providers-list" class="space-y-3">
                            <p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù‚Ø¯Ù…ÙŠ Ø®Ø¯Ù…Ø§Øª...</p>
                        </div>
                    </main>
                    
                    ${renderBottomNav('home')}
                </div>
            `;








            const usersColRef = collection(db, `artifacts/${appId}/public/data/users`);
            const allProvidersQuery = query(usersColRef, where('role', '==', 'provider'));








            currentUnsubscribe = onSnapshot(allProvidersQuery, (snapshot) => {
                const providersListEl = document.getElementById('providers-list');








                // === Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³Ù… Ø§Ù„ÙˆØ¸ÙŠÙØ© ÙÙŠ Ø­Ù‚Ù„ jobTitleSearch ===
                const providers = snapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(p => !categoryName || (p.jobTitle && p.jobTitle.toLowerCase().includes(categoryName))); 








                if (providers.length === 0) {
                    providersListEl.innerHTML = '<p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù‚Ø¯Ù…Ùˆ Ø®Ø¯Ù…Ø§Øª Ù…Ø³Ø¬Ù„ÙˆÙ† ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
                    return;
                }








                providersListEl.innerHTML = providers.map(p => {
                    const avgRating = p.avgRating ? p.avgRating.toFixed(1) : 'Ø¬Ø¯ÙŠØ¯';
                    const ratingCount = p.ratings ? p.ratings.length : 0;




                    // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 5: Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø¸Ù‡ÙˆØ± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø© ===
                    const onlineStatusHtml = getOnlineStatusHtml(p);




                    return `
                    <div class="bg-indigo-50 p-3 rounded-lg shadow-sm border border-indigo-200 flex items-center space-x-3 space-x-reverse directory-card">
                        <img data-action="navigateTo" data-page="profile" data-uid="${p.uid}"
                             src="${p.photoURL || 'https://placehold.co/100x100/EBF8FF/3182CE?text=User'}" 
                             alt="${p.name}" class="w-12 h-12 rounded-full object-cover cursor-pointer">
                        <div class="flex-1">
                            <div class="flex justify-between items-center">
                                <h3 data-action="navigateTo" data-page="profile" data-uid="${p.uid}"
                                    class="text-base font-semibold text-gray-900 cursor-pointer hover:text-indigo-600">${p.name}</h3>
                                <div class="flex items-center text-yellow-500 text-xs">
                                    <span class="font-bold mr-1">${avgRating}</span>
                                    ${ICONS.star}
                                    <span class="text-xs text-gray-500 ms-1">(${ratingCount})</span>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 truncate-1-line">${p.jobTitle}</p>
                            <div class="flex justify-between items-center">
                                <p class="text-xs text-gray-500">${p.addressCity || p.address} - ${p.addressArea || ''}</p>
                                ${onlineStatusHtml}
                            </div>
                        </div>
                        <button data-action="navigateTo" data-page="chat" data-otheruserid="${p.uid}"
                                class="flex-shrink-0 bg-indigo-100 text-indigo-700 py-1.5 px-3 rounded-md text-sm font-medium hover:bg-indigo-200">
                            ØªÙˆØ§ØµÙ„
                        </button>
                    </div>
                `}).join('');
            }, (error) => {
                console.error("Error fetching providers: ", error);
                document.getElementById('providers-list').innerHTML = '<p class="text-red-500">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ù…Ù‚Ø¯Ù…ÙŠ Ø§Ù„Ø®Ø¯Ù…Ø§Øª.</p>';
            });
        }








        async function renderDirectoryPage() {
            function renderUserList(users) {
                const listEl = document.getElementById('directory-list');
                const searchInput = document.getElementById('search-directory');
                const searchText = searchInput ? searchInput.value.toLowerCase() : '';








                const filteredUsers = users.filter(user => 
                    // === ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ø¯Ù„ÙŠÙ„ ===
                    !user.isDirectoryHidden && (
                        user.name.toLowerCase().includes(searchText) || 
                        (user.jobTitle && user.jobTitle.toLowerCase().includes(searchText)) ||
                        (user.username && user.username.toLowerCase().includes(searchText))
                    )
                );
                
                // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 2: ÙØ±Ø² Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø£Ø¨Ø¬Ø¯ÙŠØ§Ù‹) ===
                filteredUsers.sort((a, b) => {
                    const isAOnline = a.isOnline && (Date.now() - (a.lastSeen?.toMillis() || 0) < ONLINE_THRESHOLD_MS);
                    const isBOnline = b.isOnline && (Date.now() - (b.lastSeen?.toMillis() || 0) < ONLINE_THRESHOLD_MS);

                    if (isAOnline && !isBOnline) return -1; // A Ù…ØªØµÙ„ØŒ B Ù„ÙŠØ³ ÙƒØ°Ù„Ùƒ
                    if (!isAOnline && isBOnline) return 1;  // B Ù…ØªØµÙ„ØŒ A Ù„ÙŠØ³ ÙƒØ°Ù„Ùƒ

                    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ù…ØªÙ…Ø§Ø«Ù„Ø©ØŒ ÙØ±Ø² Ø£Ø¨Ø¬Ø¯ÙŠ
                    return a.name.localeCompare(b.name);
                });








                if (filteredUsers.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ† Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«.</p>';
                    return;
                }








                listEl.innerHTML = filteredUsers.map(user => {
                    const userRole = user.role === 'provider' ? (user.jobTitle || 'Ù…Ù‚Ø¯Ù… Ø®Ø¯Ù…Ø©') : 'Ø¹Ù…ÙŠÙ„';
                    const userColor = user.role === 'provider' ? 'text-indigo-600' : 'text-green-600';
                    // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 5: Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø¸Ù‡ÙˆØ± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø© ===
                    const onlineStatusHtml = getOnlineStatusHtml(user);




                    return `
                    <div data-action="navigateTo" data-page="profile" data-uid="${user.uid}" 
                         class="bg-indigo-50 p-3 rounded-lg shadow-sm border border-indigo-200 flex items-center space-x-3 space-x-reverse cursor-pointer hover:bg-indigo-100 directory-card">
                        <img src="${user.photoURL || 'https://placehold.co/100x100/EBF8FF/3182CE?text=User'}" 
                             alt="${user.name}" class="w-8 h-8 rounded-full object-cover">
                        <div class="flex-1">
                            <h3 class="text-sm font-semibold text-gray-900">${user.name}</h3>
                            <p class="text-xs ${userColor} font-medium">${userRole}</p>
                            <div class="flex justify-between items-center">
                                <p class="text-xs text-gray-500">${user.phone}</p>
                                ${onlineStatusHtml}
                            </div>
                        </div>
                    </div>
                    `
                }).join('');
            }








            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10">
                        <h1 class="text-xl font-bold mb-0">Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h1>
                        <!-- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 2: ØªØ·Ø¨ÙŠÙ‚ ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ÙˆØ­Ø¯ Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« -->
                        <div class="register-input-card p-2 mt-2">
                            <input type="text" id="search-directory" class="w-full text-gray-900 text-sm" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙˆØ¸ÙŠÙØ©...">
                        </div>
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <div id="directory-list" class="space-y-3">
                            <p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</p>
                        </div>
                    </main>
                    
                    ${renderBottomNav('directory')}
                </div>
            `;








            const usersColRef = collection(db, `artifacts/${appId}/public/data/users`);








            const unsubscribeDirectory = onSnapshot(usersColRef, (snapshot) => {
                allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUserList(allUsers); 
            }, (error) => {
                console.error("Error fetching all users: ", error);
                document.getElementById('directory-list').innerHTML = '<p class="text-red-500">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.</p>';
            });








            currentUnsubscribe = unsubscribeDirectory;








            document.getElementById('search-directory').addEventListener('input', () => {
                renderUserList(allUsers);
            });
        }








        async function renderChatListPage() {
            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <h1 class="text-xl font-bold">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</h1>
                        <!-- ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø¬Ø±Ø³ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† Ù‡Ù†Ø§ -->
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <div id="chat-list-container" class="space-y-3">
                            <p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª...</p>
                        </div>
                    </main>
                    
                    ${renderBottomNav('chatList')}
                </div>
            `;








            const chatsColRef = collection(db, `artifacts/${appId}/public/data/chats`);
            const q = query(chatsColRef, where('users', 'array-contains', userId));








            currentUnsubscribe = onSnapshot(q, async (snapshot) => {
                const listEl = document.getElementById('chat-list-container');
                if (snapshot.empty) {
                    listEl.innerHTML = '<p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù„Ø¯ÙŠÙƒ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</p>';
                    return;
                }




                // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ø¶Ù…Ø§Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¸Ù‡ÙˆØ±
                const userIds = snapshot.docs.flatMap(doc => doc.data().users);
                const uniqueUserIds = [...new Set(userIds.filter(uid => uid !== userId))];
                const userPromises = uniqueUserIds.map(uid => getDoc(doc(db, `artifacts/${appId}/public/data/users`, uid)));
                const userDocs = await Promise.all(userPromises);
                const userMap = userDocs.reduce((acc, doc) => {
                    if (doc.exists()) acc[doc.id] = doc.data();
                    return acc;
                }, {});




                const chats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                chats.sort((a, b) => b.lastUpdate.toMillis() - a.lastUpdate.toMillis());








                listEl.innerHTML = chats.map(chat => {
                    const otherUserId = chat.users.find(uid => uid !== userId);
                    const otherUser = userMap[otherUserId] || chat.userDetails[otherUserId];
                    if (!otherUser) {
                        return ''; 
                    }




                    // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 1: Ù…Ù†Ø·Ù‚ Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø­Ù…Ø±Ø§Ø¡ Ù„Ø±Ø³Ø§Ù„Ø© ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡Ø© (ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ unreadBy) ===
                    const isUnread = chat.unreadBy && chat.unreadBy.includes(userId);
                    const unreadDot = isUnread ? `<span class="absolute top-0 right-0 h-2 w-2 rounded-full bg-red-500 ring-2 ring-white -mt-1 -mr-1"></span>` : '';




                    // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 5: Ø­Ø§Ù„Ø© Ø§Ù„Ø¸Ù‡ÙˆØ± ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø© ===
                    const onlineStatusHtml = getOnlineStatusHtml(otherUser);




                    return `
                    <div data-action="navigateTo" data-page="chat" data-otheruserid="${otherUserId}"
                         class="bg-indigo-50 p-3 rounded-lg shadow-sm border border-indigo-200 flex items-center space-x-3 space-x-reverse cursor-pointer hover:bg-indigo-100 relative">
                        <div class="relative flex-shrink-0">
                            <img src="${otherUser.photoURL || 'https://placehold.co/100x100/EBF8FF/3182CE?text=User'}" 
                                 alt="${otherUser.name}" class="w-12 h-12 rounded-full object-cover">
                            ${unreadDot}
                        </div>
                        <div class="flex-1 overflow-hidden">
                            <div class="flex items-center justify-between">
                                <h3 class="text-base font-semibold text-gray-900 truncate-1-line">${otherUser.name}</h3>
                                ${onlineStatusHtml}
                            </div>
                            <p class="text-sm text-gray-600 truncate-1-line">${chat.lastMessage}</p>
                        </div>
                        <span class="text-xs text-gray-400 flex-shrink-0">${new Date(chat.lastUpdate.toDate()).toLocaleTimeString('ar-EG', {hour: '2-digit', minute: '2-digit'})}</span>
                    </div>
                    `;
                }).join('');








            }, (error) => {
                console.error("Error fetching chat list: ", error);
                document.getElementById('chat-list-container').innerHTML = '<p class="text-red-500">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª.</p>';
            });
        }








        async function renderProfilePage(uid) {
            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <h1 class="text-xl font-bold">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h1>
                        <div class="flex items-center space-x-2 space-x-reverse">
                            <!-- === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 2: Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø¹ Ø§Ù„Ù†Øµ === -->
                            ${uid === userId ? `
                                <button data-action="navigateTo" data-page="settings"
                                        class="flex items-center space-x-1 space-x-reverse p-1 bg-indigo-700 rounded-full text-white hover:bg-indigo-600 cursor-pointer">
                                    ${ICONS.settings}
                                    <span class="text-xs font-medium mr-1">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
                                </button>
                                <!-- === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 2: Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹ Ø§Ù„Ù†Øµ === -->
                                <button data-action="navigateTo" data-page="editProfile"
                                        class="flex items-center space-x-1 space-x-reverse p-1 bg-indigo-700 rounded-full text-white hover:bg-indigo-600 cursor-pointer">
                                    ${ICONS.edit}
                                    <span class="text-xs font-medium mr-1">ØªØ¹Ø¯ÙŠÙ„</span>
                                </button>
                            ` : ''}
                            <button data-action="goBack" class="bg-white text-indigo-800 rounded-full p-1 w-7 h-7 flex items-center justify-center hover:bg-gray-100">
                                ${ICONS.back}
                            </button>
                        </div>
                    </header>
                    
                    <main id="profile-content" class="main-padding bg-gray-50">
                        <p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ...</p>
                    </main>
                    
                    ${renderBottomNav(uid === userId ? 'profile' : '')}
                </div>
            `;








            try {
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, uid);
                const userDoc = await getDoc(userDocRef);








                if (!userDoc.exists()) {
                    document.getElementById('profile-content').innerHTML = '<p class="text-red-500">Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.</p>';
                    return;
                }








                const profileData = userDoc.data();
                const isMyProfile = uid === userId;




                // === Ù…Ù†Ø·Ù‚ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ===
                const showPhone = isMyProfile || !profileData.isPhoneHidden;
                const showAddress = isMyProfile || !profileData.isAddressHidden;




                const ratings = profileData.ratings || [];
                const avgRating = profileData.avgRating ? profileData.avgRating.toFixed(1) : 0;
                const ratingCount = ratings.length;








                const clientRatings = profileData.clientRatings || [];
                const clientAvgRating = clientRatings.length > 0 ? (clientRatings.reduce((acc, r) => acc + r.stars, 0) / clientRatings.length).toFixed(1) : 0;
                const clientRatingCount = clientRatings.length;




                // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 5: Ø­Ø§Ù„Ø© Ø§Ù„Ø¸Ù‡ÙˆØ± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø© ===
                const onlineStatusHtml = getOnlineStatusHtml(profileData);




                const profileContent = document.getElementById('profile-content');
                profileContent.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 flex flex-col items-center">
                        <img src="${profileData.photoURL || 'https://placehold.co/150x150/EBF8FF/3182CE?text=User'}" 
                             alt="${profileData.name}" class="w-28 h-28 rounded-full object-cover shadow-lg border-4 border-white mb-3">
                        <h2 class="text-2xl font-bold text-gray-900">${profileData.name}</h2>
                        ${profileData.role === 'provider' ? 
                            `<p class="text-lg text-indigo-600 font-medium mt-1">${profileData.jobTitle || 'Ù…Ù‚Ø¯Ù… Ø®Ø¯Ù…Ø©'}</p>` : 
                            '<p class="text-lg text-green-600 font-medium mt-1">Ø¹Ù…ÙŠÙ„</p>'
                        }
                        <div class="mt-2">
                            ${onlineStatusHtml}
                        </div>
                        
                        ${uid !== userId ? `
                            <button data-action="navigateTo" data-page="chat" data-otheruserid="${uid}"
                                    class="mt-4 bg-indigo-600 text-white py-2 px-6 rounded-lg font-semibold text-base hover:bg-indigo-700">
                                ØªÙˆØ§ØµÙ„ Ø§Ù„Ø¢Ù†
                            </button>
                        ` : ''}
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg shadow-md mt-4 border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„</h3>
                        <div class="space-y-3">
                            <div class="flex items-start">
                                <span class="w-5 text-gray-500 mt-1">ğŸ‘¤</span>
                                <div class="mr-3">
                                    <span class="block text-xs text-gray-500">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span>
                                    <span class="text-gray-700 font-medium text-sm">${profileData.username || 'N/A'}</span>
                                </div>
                            </div>
                            <!-- Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ù†Ø³ -->
                            <div class="flex items-start">
                                <span class="w-5 text-gray-500 mt-1">ğŸš»</span>
                                <div class="mr-3">
                                    <span class="block text-xs text-gray-500">Ø§Ù„Ø¬Ù†Ø³</span>
                                    <span class="text-gray-700 font-medium text-sm">${profileData.gender || 'N/A'}</span>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <span class="w-5 text-gray-500 mt-1">ğŸ“</span>
                                <div class="mr-3">
                                    <span class="block text-xs text-gray-500">Ø§Ù„Ø±Ù‚Ù…</span>
                                    <span class="text-gray-700 font-medium text-sm">
                                        ${showPhone ? profileData.phone : '<span class="text-red-500">Ù…Ø®ÙÙŠ</span>'}
                                    </span>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <span class="w-5 text-gray-500 mt-1">ğŸ“</span>
                                <div class="mr-3">
                                    <span class="block text-xs text-gray-500">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</span>
                                    <span class="text-gray-700 font-medium text-sm">
                                        ${showAddress ? `${profileData.addressCity}ØŒ ${profileData.addressArea}` : '<span class="text-red-500">Ù…Ø®ÙÙŠ</span>'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>








                    <!-- ØªÙ‚ÙŠÙŠÙ… Ù…Ù‚Ø¯Ù… Ø§Ù„Ø®Ø¯Ù…Ø© (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ù‚Ø¯Ù… Ø®Ø¯Ù…Ø©) -->
                    ${profileData.role === 'provider' ? `
                    <div class="bg-white p-4 rounded-lg shadow-md mt-4 border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªÙŠ Ù‚Ø¯Ù…Ù‡Ø§ (${ratingCount})</h3>
                        <div class="flex items-center mb-4">
                            <span class="text-3xl font-bold text-yellow-500">${avgRating}</span>
                            <span class="text-xl text-gray-400 mx-2">/</span>
                            <span class="text-xl text-gray-400">5</span>
                            <div class="flex mr-4">
                                ${renderStarRating(avgRating, 5, 'h-6 w-6 text-yellow-400')}
                            </div>
                        </div>
                        
                        <div id="ratings-list" class="space-y-3 max-h-48 overflow-y-auto no-scrollbar text-sm">
                            ${ratings.length > 0 ? ratings.sort((a,b) => b.createdAt.toMillis() - a.createdAt.toMillis()).map(r => `
                                <div class="border-t border-gray-200 pt-3">
                                    <div class="flex justify-between items-center">
                                        <span class="font-semibold text-gray-800">${r.byName || 'Ù…Ø³ØªØ®Ø¯Ù…'}</span>
                                        <div class="flex text-yellow-400">
                                            ${renderStarRating(r.stars, 5, 'h-4 w-4')}
                                        </div>
                                    </div>
                                    <p class="text-gray-600 mt-1">${r.comment}</p>
                                </div>
                            `).join('') : '<p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯.</p>'}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ù…ÙŠÙ„) -->
                    ${profileData.role === 'client' ? `
                    <div class="bg-white p-4 rounded-lg shadow-md mt-4 border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ù† Ù…Ù‚Ø¯Ù…ÙŠ Ø§Ù„Ø®Ø¯Ù…Ø§Øª (${clientRatingCount})</h3>
                        <div class="flex items-center mb-4">
                            <span class="text-3xl font-bold text-yellow-500">${clientAvgRating}</span>
                            <span class="text-xl text-gray-400 mx-2">/</span>
                            <span class="text-xl text-gray-400">5</span>
                            <div class="flex mr-4">
                                ${renderStarRating(clientAvgRating, 5, 'h-6 w-6 text-yellow-400')}
                            </div>
                        </div>
                        
                        <div id="client-ratings-list" class="space-y-3 max-h-48 overflow-y-auto no-scrollbar text-sm">
                            ${clientRatings.length > 0 ? clientRatings.sort((a,b) => b.createdAt.toMillis() - a.createdAt.toMillis()).map(r => `
                                <div class="border-t border-gray-200 pt-3">
                                    <div class="flex justify-between items-center">
                                        <span class="font-semibold text-gray-800">${r.byName || 'Ù…Ø³ØªØ®Ø¯Ù…'}</span>
                                        <div class="flex text-yellow-400">
                                            ${renderStarRating(r.stars, 5, 'h-4 w-4')}
                                        </div>
                                    </div>
                                    <p class="text-gray-600 mt-1">${r.comment}</p>
                                </div>
                            `).join('') : '<p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯.</p>'}
                        </div>
                    </div>
                    ` : ''}








                    
                    ${uid === userId ? `
                        <!-- Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª -->
                        <button data-action="navigateTo" data-page="myPostings" 
                                class="mt-6 w-full bg-indigo-100 text-indigo-700 py-2 px-6 rounded-lg font-semibold text-base hover:bg-indigo-200 flex items-center justify-center space-x-2 space-x-reverse">
                            ${ICONS.job}
                            <span>Ø¹Ø±Ø¶ Ø¥Ø¹Ù„Ø§Ù†Ø§ØªÙŠ ÙˆØ·Ù„Ø¨Ø§ØªÙŠ</span>
                        </button>




                        <button data-action="logout" 
                                class="mt-3 w-full bg-red-100 text-red-700 py-2 px-6 rounded-lg font-semibold text-base hover:bg-red-200 flex items-center justify-center space-x-2 space-x-reverse">
                            ${ICONS.logout}
                            <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
                        </button>
                    ` : ''}
                `;








            } catch (error) {
                console.error("Error fetching profile: ", error);
                document.getElementById('profile-content').innerHTML = '<p class="text-red-500">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ.</p>';
            }
        }




        // === Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ù…Ø­Ø¯Ø«Ø©) ===
        function renderSettingsPage() {
            if (!userProfile) {
                navigateTo('auth');
                return;
            }




            const isPhoneHidden = userProfile.isPhoneHidden || false;
            const isAddressHidden = userProfile.isAddressHidden || false;
            const isDirectoryHidden = userProfile.isDirectoryHidden || false;
            const isNotificationsEnabled = userProfile.isNotificationsEnabled || false;
            const isMessageNotificationsEnabled = userProfile.isMessageNotificationsEnabled !== false; 
            const isJobNotificationsEnabled = userProfile.isJobNotificationsEnabled !== false; 
            const isRequestNotificationsEnabled = userProfile.isRequestNotificationsEnabled !== false; 
            const isDarkModeEnabled = userProfile.isDarkModeEnabled || false; // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¥Ø¶Ø§ÙÙŠ
            const isLocationSharingEnabled = userProfile.isLocationSharingEnabled || false; // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¥Ø¶Ø§ÙÙŠ
            // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 3: Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Ø§Ù„Ù…Ù†Ø§ÙØ¹ ===
            const chatPermission = userProfile.chatPermission || 'all';
            const ratingPermission = userProfile.ratingPermission || 'all';




            const toggleHtml = (id, label, isChecked, description) => `
                <div class="flex items-center justify-between py-3 border-b border-gray-100 settings-toggle-container">
                    <div class="flex-1 mr-4">
                        <label for="${id}" class="block text-sm font-medium text-gray-900">${label}</label>
                        <p class="text-xs text-gray-500 mt-1">${description}</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="${id}" value="" class="sr-only peer rtl-toggle-input" ${isChecked ? 'checked' : ''}>
                        <!-- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 6: ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø¥ØµÙ„Ø§Ø­ RTL ÙÙŠ CSS Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰ -->
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:right-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                    </label>
                </div>
            `;




            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <h1 class="text-xl font-bold">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</h1>
                        <button data-action="goBack" class="bg-white text-indigo-800 rounded-full p-1 w-7 h-7 flex items-center justify-center hover:bg-gray-100">
                            ${ICONS.back}
                        </button>
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <!-- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 6: ØªØ­Ø³ÙŠÙ† ØªØµÙ…ÙŠÙ… ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
                        <div id="settings-form" class="space-y-6 bg-white p-6 rounded-lg shadow-xl max-w-md mx-auto border border-indigo-100">
                            
                            <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù† -->
                            <div class="border-b border-indigo-200 pb-3">
                                <h2 class="text-lg font-semibold text-indigo-800">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†</h2>
                            </div>
                            <button data-action="openChangePasswordModal" class="w-full bg-indigo-100 text-indigo-700 py-2 rounded-md hover:bg-indigo-200 text-sm font-medium border border-indigo-300">
                                ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                            </button>
                            
                            <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®ØµÙˆØµÙŠØ© -->
                            <div class="border-b border-indigo-200 pb-3 pt-2">
                                <h2 class="text-lg font-semibold text-indigo-800">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®ØµÙˆØµÙŠØ© ÙˆØ§Ù„Ø¸Ù‡ÙˆØ±</h2>
                            </div>
                            ${toggleHtml('toggle-phone', 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø´Ø®ØµÙŠ', isPhoneHidden, 'Ù„Ù† ÙŠØªÙ…ÙƒÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ø¢Ø®Ø±ÙˆÙ† Ù…Ù† Ø±Ø¤ÙŠØ© Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ ÙÙŠ Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ.')}
                            ${toggleHtml('toggle-address', 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', isAddressHidden, 'Ù„Ù† ÙŠØªÙ…ÙƒÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ø¢Ø®Ø±ÙˆÙ† Ù…Ù† Ø±Ø¤ÙŠØ© ØªÙØ§ØµÙŠÙ„ Ø¹Ù†ÙˆØ§Ù†Ùƒ.')}
                            ${toggleHtml('toggle-directory', 'Ø¥Ø®ÙØ§Ø¡ Ù…Ù† Ø§Ù„Ø¯Ù„ÙŠÙ„', isDirectoryHidden, 'Ø¥Ø®ÙØ§Ø¡ Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ù† ØµÙØ­Ø© Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.')}
                            
                            <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ -->
                            <div class="border-b border-indigo-200 pb-3 pt-2">
                                <h2 class="text-lg font-semibold text-indigo-800">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„</h2>
                            </div>
                            <div class="register-input-card p-3">
                                <label for="chat-permission" class="block text-sm font-medium text-gray-900 mb-1">Ù…Ù† ÙŠÙ…ÙƒÙ†Ù‡ Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ÙŠØŸ</label>
                                <select id="chat-permission" class="mt-1 block w-full text-gray-900 text-sm bg-white">
                                    <option value="all" ${chatPermission === 'all' ? 'selected' : ''}>Ø§Ù„Ø¬Ù…ÙŠØ¹ (Ø¹Ù…Ù„Ø§Ø¡ ÙˆÙ…Ù‚Ø¯Ù…Ùˆ Ø®Ø¯Ù…Ø§Øª)</option>
                                    <option value="providers" ${chatPermission === 'providers' ? 'selected' : ''}>Ù…Ù‚Ø¯Ù…Ùˆ Ø§Ù„Ø®Ø¯Ù…Ø§Øª ÙÙ‚Ø·</option>
                                    <option value="clients" ${chatPermission === 'clients' ? 'selected' : ''}>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙÙ‚Ø·</option>
                                    <option value="none" ${chatPermission === 'none' ? 'selected' : ''}>Ù„Ø§ Ø£Ø­Ø¯ (ÙÙ‚Ø· Ù…Ù† Ù‚Ù…Øª Ø¨Ù…Ø­Ø§Ø¯Ø«ØªÙ‡ Ø³Ø§Ø¨Ù‚Ø§Ù‹)</option>
                                </select>
                            </div>
                            
                            <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ… -->
                            <div class="border-b border-indigo-200 pb-3 pt-2">
                                <h2 class="text-lg font-semibold text-indigo-800">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</h2>
                            </div>
                            <div class="register-input-card p-3">
                                <label for="rating-permission" class="block text-sm font-medium text-gray-900 mb-1">Ù…Ù† ÙŠÙ…ÙƒÙ†Ù‡ ØªÙ‚ÙŠÙŠÙ…ÙŠØŸ</label>
                                <select id="rating-permission" class="mt-1 block w-full text-gray-900 text-sm bg-white">
                                    <option value="all" ${ratingPermission === 'all' ? 'selected' : ''}>Ø§Ù„Ø¬Ù…ÙŠØ¹ (Ø¹Ù…Ù„Ø§Ø¡ ÙˆÙ…Ù‚Ø¯Ù…Ùˆ Ø®Ø¯Ù…Ø§Øª)</option>
                                    <option value="providers" ${ratingPermission === 'providers' ? 'selected' : ''}>Ù…Ù‚Ø¯Ù…Ùˆ Ø§Ù„Ø®Ø¯Ù…Ø§Øª ÙÙ‚Ø·</option>
                                    <option value="clients" ${ratingPermission === 'clients' ? 'selected' : ''}>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙÙ‚Ø·</option>
                                    <option value="none" ${ratingPermission === 'none' ? 'selected' : ''}>Ù„Ø§ Ø£Ø­Ø¯</option>
                                </select>
                            </div>


                            <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
                            <div class="border-b border-indigo-200 pb-3 pt-2">
                                <h2 class="text-lg font-semibold text-indigo-800">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h2>
                            </div>
                            ${toggleHtml('toggle-notifications', 'ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©', isNotificationsEnabled, 'ØªÙØ¹ÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (ØµÙˆØªÙŠØ© ÙˆÙ…Ù†Ø¨Ø«Ù‚Ø©).')}
                            <div class="mr-4 mt-2 p-3 bg-indigo-50 rounded-md border border-indigo-200 ${isNotificationsEnabled ? '' : 'opacity-50 pointer-events-none'}" id="custom-notifications-settings">
                                <h3 class="text-sm font-semibold text-indigo-700 mb-2">Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ø®ØµØµØ©:</h3>
                                ${toggleHtml('toggle-msg-notifications', 'Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©', isMessageNotificationsEnabled, 'ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ Ø§Ø³ØªÙ„Ø§Ù… Ø±Ø³Ø§Ù„Ø© Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©.')}
                                ${toggleHtml('toggle-job-notifications', 'Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©', isJobNotificationsEnabled, 'ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† ÙˆØ¸ÙŠÙØ© Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ù…Ø¬Ø§Ù„Ùƒ.')}
                                ${toggleHtml('toggle-request-notifications', 'Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©', isRequestNotificationsEnabled, 'ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ Ù†Ø´Ø± Ø·Ù„Ø¨ Ø®Ø¯Ù…Ø© Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ù…Ø¬Ø§Ù„Ùƒ.')}
                            </div>


                            <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ -->
                            <div class="border-b border-indigo-200 pb-3 pt-2">
                                <h2 class="text-lg font-semibold text-indigo-800">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø±Ø¶</h2>
                            </div>
                            ${toggleHtml('toggle-dark-mode', 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ (Dark Mode)', isDarkModeEnabled, 'ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ù„ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªØµÙØ­Ùƒ/Ù†Ø¸Ø§Ù…Ùƒ.')}
                            
                            <!-- Ù…ÙŠØ²Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© -->
                            <div class="border-b border-indigo-200 pb-3 pt-2">
                                <h2 class="text-lg font-semibold text-indigo-800">Ù…ÙŠØ²Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</h2>
                            </div>
                            ${toggleHtml('toggle-location-sharing', 'Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹ (ØªÙ‚Ø±ÙŠØ¨ÙŠ)', isLocationSharingEnabled, 'Ù…Ø´Ø§Ø±ÙƒØ© Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ Ù…Ø¹ Ù…Ù‚Ø¯Ù…ÙŠ/Ø·Ø§Ù„Ø¨ÙŠ Ø§Ù„Ø®Ø¯Ù…Ø© (Ù…ÙŠØ²Ø© Ù‚Ø§Ø¯Ù…Ø©).')}
                            
                            <div class="pt-4">
                                <button data-action="saveSettings" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                    Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                                </button>
                            </div>
                        </div>
                    </main>
                    
                    ${renderBottomNav('profile')}
                </div>
            `;
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø§Ù…
            document.getElementById('toggle-notifications').addEventListener('change', (e) => {
                const customSettings = document.getElementById('custom-notifications-settings');
                if (e.target.checked) {
                    customSettings.classList.remove('opacity-50', 'pointer-events-none');
                } else {
                    customSettings.classList.add('opacity-50', 'pointer-events-none');
                }
            });
        }




        // === Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ù…Ø­Ø¯Ø«Ø©) ===
        async function handleSaveSettings() {
            showLoading('Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª...');




            try {
                const isPhoneHidden = document.getElementById('toggle-phone').checked;
                const isAddressHidden = document.getElementById('toggle-address').checked;
                const isDirectoryHidden = document.getElementById('toggle-directory').checked;
                const isNotificationsEnabled = document.getElementById('toggle-notifications').checked;
                const isMessageNotificationsEnabled = document.getElementById('toggle-msg-notifications').checked;
                const isJobNotificationsEnabled = document.getElementById('toggle-job-notifications').checked;
                const isRequestNotificationsEnabled = document.getElementById('toggle-request-notifications').checked;
                const isDarkModeEnabled = document.getElementById('toggle-dark-mode').checked;
                const isLocationSharingEnabled = document.getElementById('toggle-location-sharing').checked;
                // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 3: Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Ø§Ù„Ù…Ù†Ø§ÙØ¹ ===
                const chatPermission = document.getElementById('chat-permission').value;
                const ratingPermission = document.getElementById('rating-permission').value;




                const updates = {
                    isPhoneHidden: isPhoneHidden,
                    isAddressHidden: isAddressHidden,
                    isDirectoryHidden: isDirectoryHidden,
                    isNotificationsEnabled: isNotificationsEnabled,
                    isMessageNotificationsEnabled: isMessageNotificationsEnabled,
                    isJobNotificationsEnabled: isJobNotificationsEnabled,
                    isRequestNotificationsEnabled: isRequestNotificationsEnabled,
                    isDarkModeEnabled: isDarkModeEnabled,
                    isLocationSharingEnabled: isLocationSharingEnabled,
                    // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 3: Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Ø§Ù„Ù…Ù†Ø§ÙØ¹ ===
                    chatPermission: chatPermission,
                    ratingPermission: ratingPermission,
                };




                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                await updateDoc(userDocRef, updates);




                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ userProfile Ø§Ù„Ù…Ø­Ù„ÙŠ
                userProfile = { ...userProfile, ...updates };
                
                // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 7: ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† ÙÙˆØ±Ø§Ù‹ ===
                applyDarkMode(isDarkModeEnabled);




                hideLoading();
                showMessageModal('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙƒ.', true);




                setTimeout(() => {
                    navigateTo('profile', { uid: userId });
                }, 1500);




            } catch (error) {
                console.error("Save Settings Error: ", error);
                hideLoading();
                showMessageModal('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', false);
            }
        }
        
        // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 3: Ø¯Ø§Ù„Ø© ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ===
        function handleChangePasswordModal() {
            showModal(`
                <h2 class="text-xl font-semibold text-center text-indigo-800 mb-4">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2>
                <form id="change-password-form" class="space-y-4">
                    <div id="password-error" class="text-red-500 text-sm text-center hidden"></div>
                    
                    <div class="register-input-card">
                        <label for="current-password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
                        <input type="password" id="current-password" required class="mt-1 block w-full text-gray-900 text-sm" placeholder="********">
                    </div>
                    <div class="register-input-card">
                        <label for="new-password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)</label>
                        <input type="password" id="new-password" required minlength="6" class="mt-1 block w-full text-gray-900 text-sm" placeholder="********">
                    </div>
                    
                    <div class="flex justify-between mt-6 space-x-4 space-x-reverse">
                        <button type="button" data-action="closeModal" class="flex-1 py-2 px-4 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 text-sm">
                            Ø¥Ù„ØºØ§Ø¡
                        </button>
                        <button type="submit" data-action="changePassword" class="flex-1 py-2 px-4 border border-transparent rounded-md text-white bg-indigo-600 hover:bg-indigo-700 text-sm">
                            ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØºÙŠÙŠØ±
                        </button>
                    </div>
                </form>
            `);
        }
        
        async function handleChangePassword(e) {
            e.preventDefault();
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const errorEl = document.getElementById('password-error');
            errorEl.classList.add('hidden');
            
            if (newPassword.length < 6) {
                errorEl.textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø£Ùˆ Ø£ÙƒØ«Ø±.';
                errorEl.classList.remove('hidden');
                return;
            }
            
            showLoading('Ø¬Ø§Ø±ÙŠ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±...');
            
            try {
                // Ø¥Ø¹Ø§Ø¯Ø© Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹ (Ø¶Ø±ÙˆØ±ÙŠØ© Ù„ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±)
                // Ù…Ù„Ø§Ø­Ø¸Ø©: ÙÙŠ Ø¨ÙŠØ¦Ø© Firebase Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©ØŒ ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… reauthenticateWithCredential
                // ÙˆÙ„ÙƒÙ† ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯Ø©ØŒ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ signInWithEmailAndPassword ÙƒØ¨Ø¯ÙŠÙ„
                await signInWithEmailAndPassword(auth, auth.currentUser.email, currentPassword);
                
                // ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                await updatePassword(auth.currentUser, newPassword);
                
                hideLoading();
                hideModal();
                showMessageModal('ØªÙ… Ø¨Ù†Ø¬Ø§Ø­', 'ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­.', true);
                
            } catch (error) {
                console.error("Change Password Error: ", error);
                hideLoading();
                let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password') {
                    errorMessage = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… 6 Ø£Ø­Ø±Ù Ø£Ùˆ Ø£ÙƒØ«Ø±.';
                }
                
                errorEl.textContent = errorMessage;
                errorEl.classList.remove('hidden');
                // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù…Ø¹ Ø§Ù„Ø®Ø·Ø£ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø®Ø·Ø£
                if (document.getElementById('modal-content').innerHTML.includes('ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±')) {
                    showModal(document.getElementById('modal-content').innerHTML); 
                } else {
                    handleChangePasswordModal(); // Ø¥Ø°Ø§ ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ØŒ Ø§ÙØªØ­Ù‡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                }
            }
        }




        // === Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ÙˆØ·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… ÙˆØ§Ù„ÙØ±Ø²) ===
        async function renderMyPostingsPage() {
            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <h1 class="text-xl font-bold">Ø¥Ø¹Ù„Ø§Ù†Ø§ØªÙŠ ÙˆØ·Ù„Ø¨Ø§ØªÙŠ</h1>
                        <button data-action="goBack" class="bg-white text-indigo-800 rounded-full p-1 w-7 h-7 flex items-center justify-center hover:bg-gray-100">
                            ${ICONS.back}
                        </button>
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <div id="my-postings-list" class="space-y-4">
                            <p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ù„Ø§Ù†Ø§ØªÙƒ ÙˆØ·Ù„Ø¨Ø§ØªÙƒ...</p>
                        </div>
                    </main>
                    
                    ${renderBottomNav('profile')}
                </div>
            `;




            const listEl = document.getElementById('my-postings-list');
            showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ...');




            try {
                // 1. Ø¬Ù„Ø¨ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø§Øª (Service Requests) - ØªÙ… Ø­Ø°Ù orderBy
                const requestsColRef = collection(db, `artifacts/${appId}/public/data/serviceRequests`);
                // Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯: where ÙÙ‚Ø·
                const requestsQuery = query(requestsColRef, where('requesterId', '==', userId)); 
                const requestsSnapshot = await getDocs(requestsQuery);




                let requests = requestsSnapshot.docs.map(doc => ({ id: doc.id, type: 'request', ...doc.data() }));




                // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø°Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
                const validRequests = [];
                for (const req of requests) {
                    const isDeleted = await attemptAutoDelete(req.id, req, 'serviceRequests');
                    if (!isDeleted) {
                        validRequests.push(req);
                    }
                }
                requests = validRequests;








                // 2. Ø¬Ù„Ø¨ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„ÙˆØ¸Ø§Ø¦Ù (Job Postings) - ØªÙ… Ø­Ø°Ù orderBy
                const jobsColRef = collection(db, `artifacts/${appId}/public/data/jobPostings`);
                // Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯: where ÙÙ‚Ø·
                const jobsQuery = query(jobsColRef, where('posterId', '==', userId));
                const jobsSnapshot = await getDocs(jobsQuery);




                let jobs = jobsSnapshot.docs.map(doc => ({ id: doc.id, type: 'job', ...doc.data() }));




                // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø°Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„ÙˆØ¸Ø§Ø¦Ù
                const validJobs = [];
                for (const job of jobs) {
                    const isDeleted = await attemptAutoDelete(job.id, job, 'jobPostings');
                    if (!isDeleted) {
                        validJobs.push(job);
                    }
                }
                jobs = validJobs;




                // 3. Ø¯Ù…Ø¬ ÙˆØªØ±ØªÙŠØ¨ Ø§Ù„ÙƒÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ (Client-Side Sorting)
                const allPostings = [...requests, ...jobs].sort((a, b) => {
                    const timeA = a.createdAt && a.createdAt.toMillis ? a.createdAt.toMillis() : 0;
                    const timeB = b.createdAt && b.createdAt.toMillis ? b.createdAt.toMillis() : 0;
                    return timeB - timeA; // ÙØ±Ø² ØªÙ†Ø§Ø²Ù„ÙŠ (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
                });




                hideLoading();




                if (allPostings.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">Ù„Ù… ØªÙ‚Ù… Ø¨Ù†Ø´Ø± Ø£ÙŠ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø£Ùˆ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯.</p>';
                    return;
                }




                listEl.innerHTML = allPostings.map(post => {
                    const isRequest = post.type === 'request';
                    const title = isRequest ? post.title : post.title;
                    const category = post.category;
                    const description = isRequest ? post.description : post.details;
                    const typeLabel = isRequest ? 'Ø·Ù„Ø¨ Ø®Ø¯Ù…Ø©' : 'Ø¥Ø¹Ù„Ø§Ù† ÙˆØ¸ÙŠÙØ©';
                    const typeColor = isRequest ? 'bg-green-100 text-green-700' : 'bg-indigo-100 text-indigo-700';
                    const dateString = post.createdAt && post.createdAt.toDate ? new Date(post.createdAt.toDate()).toLocaleDateString('ar-EG') : 'ØªØ§Ø±ÙŠØ® ØºÙŠØ± Ù…Ø­Ø¯Ø¯';




                    return `
                        <div class="bg-white p-4 rounded-lg shadow-md border border-gray-200 job-listing-card">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-xs font-medium ${typeColor} py-1 px-2 rounded-full">${typeLabel}</span>
                                <span class="text-xs text-gray-400">${dateString}</span>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-1">${title}</h3>
                            <p class="text-sm text-gray-600 mb-3">${description.substring(0, 150)}...</p>
                            <p class="text-sm text-indigo-600 mb-3 font-medium">Ø§Ù„Ù‚Ø³Ù…: ${category}</p>
                            
                            <button data-action="deletePosting" data-type="${post.type}" data-id="${post.id}"
                                    class="mt-2 w-full flex items-center justify-center space-x-1 space-x-reverse bg-red-500 text-white py-2 px-4 rounded-md text-sm font-medium hover:bg-red-600">
                                ${ICONS.trash}
                                <span>Ø­Ø°Ù Ù‡Ø°Ø§ ${isRequest ? 'Ø§Ù„Ø·Ù„Ø¨' : 'Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†'}</span>
                            </button>
                        </div>
                    `;
                }).join('');




            } catch (error) {
                console.error("Error fetching my postings: ", error);
                hideLoading();
                listEl.innerHTML = '<p class="text-red-500 p-6 bg-white rounded-lg shadow-sm">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ù„Ø§Ù†Ø§ØªÙƒ ÙˆØ·Ù„Ø¨Ø§ØªÙƒ.</p>';
            }
        }








        function renderEditProfilePage() {
            if (!userProfile) {
                navigateTo('auth');
                return;
            }








            const serviceOptions = SERVICES_LIST.map(service => 
                `<option value="${service.name}" ${userProfile.jobTitle === service.name ? 'selected' : ''}>${service.name}</option>`
            ).join('');








            const cityOptions = SHARQIA_CITIES.map(city => 
                `<option value="${city}" ${userProfile.addressCity === city ? 'selected' : ''}>${city}</option>`
            ).join('');








            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <h1 class="text-xl font-bold">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h1>
                        <button data-action="goBack" class="bg-white text-indigo-800 rounded-full p-1 w-7 h-7 flex items-center justify-center hover:bg-gray-100">
                            ${ICONS.back}
                        </button>
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <form id="edit-profile-form" class="space-y-4 bg-white p-6 rounded-lg shadow-md max-w-md mx-auto">
                            <div id="edit-error" class="text-red-500 text-sm text-center hidden"></div>
                            
                            <!-- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 2: ØªØ·Ø¨ÙŠÙ‚ ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ÙˆØ­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© -->
                            <div class="register-input-card">
                                <input type="file" id="photo-upload-input" accept="image/*" class="hidden">
                                <label for="photo-upload-input" class="block text-sm font-medium text-gray-900 text-center cursor-pointer">
                                    Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©
                                    <div class="mt-2 flex flex-col items-center justify-center">
                                        <img id="photo-preview" class="w-24 h-24 rounded-full object-cover register-photo-preview border-gray-300 p-0.5 hover:border-indigo-700" 
                                             src="${userProfile.photoURL || 'https://placehold.co/100x100/EBF8FF/3182CE?text=User'}" alt="Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©">
                                        <span class="text-xs text-indigo-500 mt-2 hover:underline">Ø§Ø¶ØºØ· Ù„ØªØºÙŠÙŠØ± ØµÙˆØ±ØªÙƒ</span>
                                    </div>
                                </label>
                                <input type="hidden" id="photo-base64" value="${userProfile.photoURL || ''}">
                            </div>








                            <hr class="my-3">
                            
                            <!-- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 2: ØªØ·Ø¨ÙŠÙ‚ ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ÙˆØ­Ø¯ Ø¹Ù„Ù‰ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„ -->
                            <div class="register-input-card">
                                <label for="edit-name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                                <input type="text" id="edit-name" value="${userProfile.name}" required class="mt-1 block w-full text-gray-900 text-sm">
                            </div>
                            <div class="register-input-card">
                                <label for="edit-phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (11 Ø±Ù‚Ù…)</label>
                                <input type="tel" id="edit-phone" value="${userProfile.phone}" required pattern="[0-9]{11}" maxlength="11" class="mt-1 block w-full text-gray-900 text-sm">
                            </div>
                            
                            <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ù†Ø³ -->
                            <div class="register-input-card">
                                <label class="block text-sm font-medium text-gray-900">Ø§Ù„Ø¬Ù†Ø³</label>
                                <div class="mt-1 flex space-x-4 space-x-reverse">
                                    <label class="flex items-center">
                                        <input type="radio" name="edit-gender" value="Ø°ÙƒØ±" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" ${userProfile.gender === 'Ø°ÙƒØ±' ? 'checked' : ''} required>
                                        <span class="mr-2 text-gray-700 text-sm">Ø°ÙƒØ±</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="edit-gender" value="Ø£Ù†Ø«Ù‰" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" ${userProfile.gender === 'Ø£Ù†Ø«Ù‰' ? 'checked' : ''} required>
                                        <span class="mr-2 text-gray-700 text-sm">Ø£Ù†Ø«Ù‰</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø¹Ù†ÙˆØ§Ù† -->
                            <div class="register-input-card">
                                <label for="edit-city">Ø§Ù„Ù…Ø±ÙƒØ² / Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
                                <select id="edit-city" required class="mt-1 block w-full text-gray-900 text-sm bg-white">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²/Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</option>
                                    ${cityOptions}
                                </select>
                            </div>
                            <div class="register-input-card">
                                <label for="edit-area">Ø§Ù„Ù…Ù†Ø·Ù‚Ø© / ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                                <input type="text" id="edit-area" value="${userProfile.addressArea}" required class="mt-1 block w-full text-gray-900 text-sm" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù‚ÙˆÙ…ÙŠØ©ØŒ Ø´Ø§Ø±Ø¹ 33">
                            </div>
                            
                            ${userProfile.role === 'provider' ? `
                                <div id="job-title-edit-field" class="space-y-4">
                                    <div class="register-input-card">
                                        <label for="edit-job-select">Ø§Ø®ØªØ± ÙˆØ¸ÙŠÙØªÙƒ / Ø§Ù„Ø®Ø¯Ù…Ø©:</label>
                                        <select id="edit-job-select" class="mt-1 block w-full text-gray-900 text-sm bg-white">
                                            <option value="" ${!userProfile.jobTitle ? 'selected' : ''}>Ø§Ø®ØªØ±...</option>
                                            ${serviceOptions}
                                        </select>
                                    </div>
                                </div>
                            ` : ''}








                            <button type="submit" data-action="editProfile" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
                            </button>
                        </form>
                    </main>
                </div>
            `;








            // ØªÙ‡ÙŠØ¦Ø© Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©
            document.getElementById('photo-upload-input').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;








                showLoading('Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©...');
                try {
                    const base64Image = await resizeAndConvertImage(file);
                    document.getElementById('photo-preview').src = base64Image;
                    document.getElementById('photo-base64').value = base64Image;
                } catch (error) {
                    console.error("Image processing error:", error);
                    showMessageModal('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©', 'Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨ØµÙˆØ±Ø© Ø£Ø®Ø±Ù‰.', false);
                } finally {
                    hideLoading();
                }
            });
        }








        async function renderChatPage(otherUserId) {
            let otherUserProfile = null;
            try {
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, otherUserId);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    otherUserProfile = userDoc.data();
                } else {
                    throw new Error('User not found');
                }
            } catch (e) {
                console.error(e);
                appContainer.innerHTML = `<p class="p-4 text-red-500">Ø®Ø·Ø£: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….</p>`;
                return;
            }
            
            // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 3: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø°Ù† Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ===
            const chatPermission = otherUserProfile.chatPermission || 'all';
            let canStartChat = true;
            if (chatPermission === 'none') {
                canStartChat = false;
            } else if (chatPermission === 'providers' && userProfile.role !== 'provider') {
                canStartChat = false;
            } else if (chatPermission === 'clients' && userProfile.role !== 'client') {
                canStartChat = false;
            }
            
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø³Ù…ÙˆØ­Ø§Ù‹ Ø¨Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©ØŒ Ù„Ø§ ØªØ¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø©
            if (!canStartChat && userId !== otherUserId) {
                appContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center min-h-screen p-4">
                        <h1 class="text-xl font-bold text-red-600 mb-4">ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ØªÙˆØ§ØµÙ„</h1>
                        <p class="text-center text-gray-700">Ù‚Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ØªÙ‚ÙŠÙŠØ¯ Ù…Ù† ÙŠÙ…ÙƒÙ†Ù‡ Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹Ù‡.</p>
                        <button data-action="goBack" class="mt-6 bg-indigo-600 text-white py-2 px-6 rounded-lg font-semibold text-base hover:bg-indigo-700">
                            Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø®Ù„Ù
                        </button>
                    </div>
                `;
                return;
            }
            
            // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 1: ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØµÙØ­Ø© ===
            const chatRoomId = [userId, otherUserId].sort().join('_');
            const chatRoomDocRef = doc(db, `artifacts/${appId}/public/data/chats`, chatRoomId);
            runTransaction(db, async (transaction) => {
                const chatDoc = await transaction.get(chatRoomDocRef);
                if (chatDoc.exists()) {
                    const chatData = chatDoc.data();
                    const unreadBy = chatData.unreadBy || [];
                    if (unreadBy.includes(userId)) {
                        const newUnreadBy = unreadBy.filter(uid => uid !== userId);
                        transaction.update(chatRoomDocRef, { unreadBy: newUnreadBy });
                    }
                }
            }).catch(error => {
                console.error("Transaction failed to clear unread flag:", error);
            });


            // ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠÙ…ÙƒÙ† Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
            const isProviderRatingClient = userProfile.role === 'provider' && otherUserProfile.role === 'client';
            const isClientRatingProvider = userProfile.role === 'client' && otherUserProfile.role === 'provider';
            // === Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ ØªÙ‚ÙŠÙŠÙ… Ù…Ù‚Ø¯Ù… Ø®Ø¯Ù…Ø© Ù„Ù…Ù‚Ø¯Ù… Ø®Ø¯Ù…Ø© Ø¢Ø®Ø± ===
            const isProviderRatingProvider = userProfile.role === 'provider' && otherUserProfile.role === 'provider';




            // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 5: Ø­Ø§Ù„Ø© Ø§Ù„Ø¸Ù‡ÙˆØ± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø© ===
            const onlineStatusHtml = getOnlineStatusHtml(otherUserProfile);




            appContainer.innerHTML = `
                <div class="flex flex-col h-screen max-h-screen"> 
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between space-x-3 space-x-reverse">
                        <div class="flex items-center space-x-3 space-x-reverse">
                            <img data-action="navigateTo" data-page="profile" data-uid="${otherUserId}"
                                 src="${otherUserProfile.photoURL || 'https://placehold.co/100x100/EBF8FF/3182CE?text=User'}" 
                                 alt="${otherUserProfile.name}" class="w-9 h-9 rounded-full object-cover cursor-pointer">
                            <div>
                                <h1 class="text-base font-bold">${otherUserProfile.name}</h1>
                                ${onlineStatusHtml}
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-2 space-x-reverse">
                            ${isClientRatingProvider || isProviderRatingProvider ? `
                                <button data-action="openRatingModal" data-targetrole="provider" data-targetid="${otherUserId}" data-targetname="${otherUserProfile.name}"
                                        class="p-1 text-yellow-300 hover:text-yellow-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.31h5.513c.498 0 .704.656.34.985l-4.46 4.062a.562.562 0 0 0-.162.541l1.618 5.22c.19.613-.526 1.09-1.04.724l-4.59-3.44a.563.563 0 0 0-.642 0l-4.59 3.44c-.514.366-1.23-.111-1.04-.724l1.618-5.22a.562.562 0 0 0-.162-.541l-4.46-4.062a.563.563 0 0 1 .34-.985h5.513a.563.563 0 0 0 .475.31l2.125-5.112Z" /></svg>
                                </button>
                            ` : ''}
                            ${isProviderRatingClient ? `
                                <button data-action="openRatingClientModal" data-targetrole="client" data-targetid="${otherUserId}" data-targetname="${otherUserProfile.name}"
                                        class="p-1 text-yellow-300 hover:text-yellow-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.31h5.513c.498 0 .704.656.34.985l-4.46 4.062a.562.562 0 0 0-.162.541l1.618 5.22c.19.613-.526 1.09-1.04.724l-4.59-3.44a.563.563 0 0 0-.642 0l-4.59 3.44c-.514.366-1.23-.111-1.04-.724l1.618-5.22a.562.562 0 0 0-.162-.541l-4.46-4.062a.563.563 0 0 1 .34-.985h5.513a.563.563 0 0 0 .475.31l2.125-5.112Z" /></svg>
                                </button>
                            ` : ''}
                            <button data-action="goBack" class="bg-white text-indigo-800 rounded-full p-1 w-7 h-7 flex items-center justify-center hover:bg-gray-100">
                                ${ICONS.back}
                            </button>
                        </div>
                    </header>
                    
                    <main id="messages-container" class="flex-1 overflow-y-auto p-3 space-y-3 bg-gray-100 no-scrollbar">
                        <p class="text-center text-gray-500 text-sm">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©...</p>
                    </main>
                    
                    <footer class="bg-white p-3 shadow-inner sticky bottom-0 z-10 border-t border-gray-200">
                        <form id="chat-form" class="flex items-center space-x-2 space-x-reverse">
                            <!-- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 2: ØªØ·Ø¨ÙŠÙ‚ ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ÙˆØ­Ø¯ Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø´Ø§Øª -->
                            <div class="register-input-card flex-1 p-2">
                                <input type="text" id="message-input" class="w-full text-gray-900 text-sm" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." required>
                            </div>
                            <button type="submit" data-action="sendMessage" data-otheruserid="${otherUserId}"
                                    class="p-2 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                ${ICONS.send}
                            </button>
                        </form>
                    </footer>
                </div>
            `;








            const messagesColRef = collection(db, `artifacts/${appId}/public/data/chats/${chatRoomId}/messages`);








            currentUnsubscribe = onSnapshot(messagesColRef, (snapshot) => {
                const messagesContainer = document.getElementById('messages-container');
                const isNearBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop - messagesContainer.clientHeight < 50; 








                if (snapshot.empty) {
                    messagesContainer.innerHTML = '<p class="text-center text-gray-500 text-sm">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©...</p>';
                    return;
                }








                const messages = snapshot.docs.map(doc => doc.data());
                messages.sort((a, b) => a.createdAt.toMillis() - b.createdAt.toMillis());








                messagesContainer.innerHTML = messages.map(msg => {
                    const isSent = msg.senderId === userId;
                    const bubbleClass = isSent ? 'chat-bubble-sent' : 'chat-bubble-received';
                    const alignmentClass = isSent ? 'justify-end' : 'justify-start';








                    return `
                        <div class="flex ${alignmentClass}">
                            <div class="${bubbleClass} max-w-[80%] text-sm">
                                <p>${msg.text}</p>
                                <span class="text-xs ${isSent ? 'text-indigo-100' : 'text-gray-500'} block text-left mt-1">
                                    ${new Date(msg.createdAt.toDate()).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' })}
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');








                // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø³ÙÙ„
                if (isNearBottom) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }








            }, (error) => {
                console.error("Error fetching messages: ", error);
                document.getElementById('messages-container').innerHTML = '<p class="text-red-500">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„.</p>';
            });
        }








        function renderNewRequestPage() {
            const serviceOptions = SERVICES_LIST.map(service => 
                `<option value="${service.name}">${service.name}</option>`
            ).join('');








            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <h1 class="text-xl font-bold">Ø·Ù„Ø¨ Ø®Ø¯Ù…Ø© Ø¬Ø¯ÙŠØ¯</h1>
                        <button data-action="goBack" class="bg-white text-indigo-800 rounded-full p-1 w-7 h-7 flex items-center justify-center hover:bg-gray-100">
                            ${ICONS.back}
                        </button>
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <form id="new-request-form" class="space-y-4 bg-white p-6 rounded-lg shadow-md max-w-md mx-auto">
                            <div id="request-error" class="text-red-500 text-sm text-center hidden"></div>
                            
                            <!-- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 2: ØªØ·Ø¨ÙŠÙ‚ ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ÙˆØ­Ø¯ -->
                            <div class="register-input-card">
                                <label for="request-title">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø·Ù„Ø¨</label>
                                <input type="text" id="request-title" required class="mt-1 block w-full text-gray-900 text-sm" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­ØªØ§Ø¬ Ø³Ø¨Ø§Ùƒ Ù„Ø¥ØµÙ„Ø§Ø­ ØµÙ†Ø¨ÙˆØ±">
                            </div>
                            
                            <div class="register-input-card">
                                <label for="request-category">Ø§Ù„Ù‚Ø³Ù…</label>
                                <select id="request-category" required class="mt-1 block w-full text-gray-900 text-sm bg-white">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>
                                    ${serviceOptions}
                                </select>
                            </div>
                            
                            <div class="register-input-card">
                                <label for="request-description">ÙˆØµÙ Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</label>
                                <textarea id="request-description" rows="4" required class="mt-1 block w-full text-gray-900 text-sm" placeholder="ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©..."></textarea>
                            </div>
                            
                            <button type="submit" data-action="submitRequest" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Ù†Ø´Ø± Ø§Ù„Ø·Ù„Ø¨
                            </button>
                        </form>
                    </main>
                </div>
            `;
        }








        // === ØµÙØ­Ø© Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† ÙˆØ¸ÙŠÙØ© ===
        function renderJobPostingPage() {
            const serviceOptions = SERVICES_LIST.map(service => 
                `<option value="${service.name}">${service.name}</option>`
            ).join('');








            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <h1 class="text-xl font-bold">Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† ÙˆØ¸ÙŠÙØ©</h1>
                        <button data-action="goBack" class="bg-white text-indigo-800 rounded-full p-1 w-7 h-7 flex items-center justify-center hover:bg-gray-100">
                            ${ICONS.back}
                        </button>
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <form id="job-posting-form" class="space-y-4 bg-white p-6 rounded-lg shadow-md max-w-md mx-auto">
                            <div id="job-post-error" class="text-red-500 text-sm text-center hidden"></div>
                            
                            <!-- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 2: ØªØ·Ø¨ÙŠÙ‚ ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ÙˆØ­Ø¯ -->
                            <div class="register-input-card">
                                <label for="job-title">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ¸ÙŠÙØ©</label>
                                <input type="text" id="job-title" required class="mt-1 block w-full text-gray-900 text-sm" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø·Ù„ÙˆØ¨ Ø³ÙƒØ±ØªÙŠØ±Ø© ØªÙ†ÙÙŠØ°ÙŠØ©">
                            </div>
                            
                            <div class="register-input-card">
                                <label for="job-category">Ø§Ù„Ù‚Ø³Ù…</label>
                                <select id="job-category" required class="mt-1 block w-full text-gray-900 text-sm bg-white">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>
                                    ${serviceOptions}
                                </select>
                            </div>
                            
                            <div class="register-input-card">
                                <label for="job-details">ØªÙØ§ØµÙŠÙ„ ÙˆÙ…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ¸ÙŠÙØ©</label>
                                <textarea id="job-details" rows="4" required class="mt-1 block w-full text-gray-900 text-sm" placeholder="ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©ØŒ ÙˆØ§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ØŒ ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹..."></textarea>
                            </div>
                            
                            <button type="submit" data-action="submitJobPost" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„ÙˆØ¸ÙŠÙØ©
                            </button>
                        </form>
                    </main>
                    
                    ${renderBottomNav('jobListings')}
                </div>
            `;
        }








        // === ØµÙØ­Ø© Ø¹Ø±Ø¶ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„ÙˆØ¸Ø§Ø¦Ù (Ù…Ø­Ø¯Ø«Ø©) ===
        async function renderJobListingsPage() {
            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <h1 class="text-xl font-bold">Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…ØªØ§Ø­Ø©</h1>
                         <div class="flex items-center space-x-2 space-x-reverse">
                            <!-- ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø¬Ø±Ø³ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† Ù‡Ù†Ø§ -->
                            <button data-action="navigateTo" data-page="jobPosting" 
                                class="bg-indigo-600 text-white py-1 px-3 rounded-md text-xs font-medium hover:bg-indigo-700">
                                + Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯
                            </button>
                        </div>
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <div id="job-listings-list" class="space-y-3">
                            <p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„ÙˆØ¸Ø§Ø¦Ù...</p>
                        </div>
                    </main>
                    
                    ${renderBottomNav('jobListings')}
                </div>
            `;








            const jobPostingsColRef = collection(db, `artifacts/${appId}/public/data/jobPostings`);
            const q = query(jobPostingsColRef, orderBy('createdAt', 'desc'));








            currentUnsubscribe = onSnapshot(q, async (snapshot) => {
                const listEl = document.getElementById('job-listings-list');




                let listings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));




                // === ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø°Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ø§Ù„Ø®Ø§ØµÙŠØ© Ø±Ù‚Ù… 2) ===
                const validListings = [];
                for (const job of listings) {
                    const isDeleted = await attemptAutoDelete(job.id, job, 'jobPostings');
                    if (!isDeleted) {
                        validListings.push(job);
                    }
                }
                listings = validListings;








                if (listings.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ÙˆØ¸Ø§Ø¦Ù Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
                    return;
                }








                listEl.innerHTML = listings.map(job => {
                    const dateString = job.createdAt && job.createdAt.toDate ? new Date(job.createdAt.toDate()).toLocaleDateString('ar-EG') : 'ØªØ§Ø±ÙŠØ® ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    return `
                    <div class="bg-indigo-50 p-4 rounded-lg shadow-md border border-indigo-200 job-listing-card">
                        <div class="flex items-center justify-between mb-1">
                            <h3 class="text-lg font-bold text-gray-900">${job.title}</h3>
                            <span class="text-xs text-gray-400">${dateString}</span>
                        </div>
                        <p class="text-sm text-indigo-600 mb-1 font-medium">${job.category}</p>
                        <p class="text-sm text-gray-700 mb-2">${job.details.substring(0, 150)}...</p>
                        
                        <div class="flex items-center space-x-3 space-x-reverse">
                            <img data-action="navigateTo" data-page="profile" data-uid="${job.posterId}"
                                 src="${job.posterPhoto || 'https://placehold.co/100x100/EBF8FF/3182CE?text=User'}" 
                                 alt="${job.posterName}" class="w-7 h-7 rounded-full object-cover cursor-pointer">
                            <p data-action="navigateTo" data-page="profile" data-uid="${job.posterId}" 
                               class="text-xs text-gray-600 cursor-pointer hover:text-indigo-600">Ø§Ù„Ù†Ø§Ø´Ø±: ${job.posterName}</p>
                        </div>
                        
                        <button data-action="navigateTo" data-page="chat" data-otheruserid="${job.posterId}"
                                class="mt-2 w-full bg-indigo-600 text-white py-2 px-4 rounded-md text-sm font-medium hover:bg-indigo-700">
                            ØªÙˆØ§ØµÙ„ Ù„Ù„ØªÙ‚Ø¯ÙŠÙ…
                        </button>
                    </div>
                `}).join('');
            }, (error) => {
                console.error("Error fetching job listings: ", error);
                document.getElementById('job-listings-list').innerHTML = '<p class="text-red-500">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„ÙˆØ¸Ø§Ø¦Ù.</p>';
            });
        }








        // === Ø¥ØµÙ„Ø§Ø­ 1 Ùˆ 2: ØªØµØºÙŠØ± Ø§Ø±ØªÙØ§Ø¹ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ ÙˆØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ† ===
        function renderBottomNav(activeTab) {
            const activeClass = 'text-white bg-indigo-700';
            const inactiveClass = 'text-indigo-300 hover:text-white';
            
            // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 1: Ù…Ù†Ø·Ù‚ Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø­Ù…Ø±Ø§Ø¡ ÙÙŠ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ (Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„) ===
            const unreadCount = userProfile?.unreadNotifications || 0;
            const showDot = unreadCount > 0;
            const dotHtml = `<span class="absolute top-0 right-0 block h-2 w-2 rounded-full bg-red-500 ring-2 ring-indigo-800 -mt-1 -mr-1"></span>`;








            return `
                <nav class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto md:max-w-2xl lg:max-w-4xl bg-indigo-800 shadow-lg border-t border-indigo-700 z-20">
                    <div class="flex justify-around items-center h-12">
                        <button data-action="navigateTo" data-page="home" 
                                class="relative flex flex-col items-center justify-center p-1 rounded-md ${activeTab === 'home' ? activeClass : inactiveClass}">
                            ${showDot ? dotHtml : ''}
                            ${ICONS.home}
                            <span class="text-xs font-medium">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
                        </button>
                        
                        <button data-action="navigateTo" data-page="directory" 
                                class="flex flex-col items-center justify-center p-1 rounded-md ${activeTab === 'directory' ? activeClass : inactiveClass}">
                            ${ICONS.users}
                            <span class="text-xs font-medium">Ø§Ù„Ø¯Ù„ÙŠÙ„</span>
                        </button>
                        
                        <button data-action="navigateTo" data-page="chatList" 
                                class="relative flex flex-col items-center justify-center p-1 rounded-md ${activeTab === 'chatList' ? activeClass : inactiveClass}">
                            ${showDot ? dotHtml : ''}
                            ${ICONS.chat}
                            <span class="text-xs font-medium">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</span>
                        </button>
                        
                        <button data-action="navigateTo" data-page="jobListings" 
                                class="relative flex flex-col items-center justify-center p-1 rounded-md ${activeTab === 'jobListings' ? activeClass : inactiveClass}">
                            ${showDot ? dotHtml : ''}
                            ${ICONS.job}
                            <span class="text-xs font-medium">ÙˆØ¸Ø§Ø¦Ù</span>
                        </button>
                        
                        <button data-action="navigateTo" data-page="profile" data-uid="${userId}"
                                class="flex flex-col items-center justify-center p-1 rounded-md ${activeTab === 'profile' ? activeClass : inactiveClass}">
                            ${ICONS.profile}
                            <span class="text-xs font-medium">Ù…Ù„ÙÙŠ</span>
                        </button>
                    </div>
                </nav>
            `;
        }








        function renderStarRating(rating, maxStars = 5, cssClass = 'h-5 w-5') {
            let html = '';
            for (let i = 1; i <= maxStars; i++) {
                if (i <= rating) {
                    html += `<svg class="${cssClass}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/></svg>`;
                } else {
                    html += `<svg class="${cssClass}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.31h5.513c.498 0 .704.656.34.985l-4.46 4.062a.562.562 0 0 0-.162.541l1.618 5.22c.19.613-.526 1.09-1.04.724l-4.59-3.44a.563.563 0 0 0-.642 0l-4.59 3.44c-.514.366-1.23-.111-1.04-.724l1.618-5.22a.562.562 0 0 0-.162-.541l-4.46-4.062a.563.563 0 0 1 .34-.985h5.513a.563.563 0 0 0 .475.31l2.125-5.112Z" /></svg>`;
                }
            }
            return html;
        }








        // 10. ÙˆØ¸Ø§Ø¦Ù Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Event Handlers)








        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('login-identifier').value.trim(); 
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');








            showLoading('Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');
            errorEl.classList.add('hidden');








            try {
                const usersColRef = collection(db, `artifacts/${appId}/public/data/users`);
                const q = query(usersColRef, where('username', '==', username));
                const snapshot = await getDocs(q); 








                if (snapshot.empty) {
                    throw new Error('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± ØµØ­ÙŠØ­.');
                }








                const userData = snapshot.docs[0].data();
                const authEmail = userData.email; 








                await signInWithEmailAndPassword(auth, authEmail, password);




                // === ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¸Ù‡ÙˆØ± Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ===
                await updateOnlineStatus(true);




                hideLoading();
            } catch (error) {
                console.error("Login Error: ", error);
                let errorMessage = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
                if (error.message.includes('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± ØµØ­ÙŠØ­')) {
                     errorMessage = error.message;
                } else if (error.code === 'auth/invalid-credential') {
                     errorMessage = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
                }








                errorEl.textContent = errorMessage;
                errorEl.classList.remove('hidden');
                hideLoading();
            }
        }








        async function handleRegister(e) {
            e.preventDefault();
            isRegistering = true; 
            showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨...');
            const errorEl = document.getElementById('register-error');
            errorEl.classList.add('hidden');








            try {
                const username = document.getElementById('register-username').value.trim(); 
                const password = document.getElementById('register-password').value;
                const name = document.getElementById('register-name').value;
                const phone = document.getElementById('register-phone').value;
                const gender = document.querySelector('input[name="gender"]:checked').value; 
                const city = document.getElementById('register-city').value;
                const area = document.getElementById('register-area').value.trim();
                const role = document.querySelector('input[name="role"]:checked').value;
                const photoURL = document.getElementById('photo-base64').value || null; 








                const jobSelect = document.getElementById('register-job-select')?.value;
                const jobTitle = jobSelect;








                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù†
                if (phone.length !== 11 || !/^[0-9]{11}$/.test(phone)) {
                    throw new Error('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ù…ØµØ±ÙŠ ØµØ­ÙŠØ­ Ù…ÙƒÙˆÙ† Ù…Ù† 11 Ø±Ù‚Ù….');
                }
                if (!city || !area) {
                    throw new Error('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©/Ø§Ù„Ù…Ø±ÙƒØ² ÙˆØ¥Ø¯Ø®Ø§Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©.');
                }
                if (role === 'provider' && (!jobTitle || jobTitle === '')) {
                    throw new Error('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù„Ù…Ù‚Ø¯Ù… Ø§Ù„Ø®Ø¯Ù…Ø©.');
                }








                const usersColRef = collection(db, `artifacts/${appId}/public/data/users`);
                const q = query(usersColRef, where('username', '==', username));
                const snapshot = await getDocs(q);
                if (!snapshot.empty) {
                    throw new Error('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ù…Ø­Ø¬ÙˆØ² Ø¨Ø§Ù„ÙØ¹Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ø¢Ø®Ø±.');
                }








                const dummyEmail = `${username}@sharqia.service`; // ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†
                const userCredential = await createUserWithEmailAndPassword(auth, dummyEmail, password);
                const newUserId = userCredential.user.uid;








                await updateProfile(userCredential.user, {
                    displayName: name,
                });








                const jobTitleSearch = role === 'provider' ? jobTitle.toLowerCase() : null;
                
                // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 7: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ ===
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                
                // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 4: ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¥Ø°Ù† Ø§Ù„Ù…ØªØµÙØ­ ===
                const isNotificationsGranted = 'Notification' in window && Notification.permission === 'granted';








                const newUserProfile = {
                    uid: newUserId,
                    username: username, 
                    email: dummyEmail, 
                    name: name,
                    phone: phone,
                    gender: gender, 
                    addressCity: city, 
                    addressArea: area, 
                    address: `${city}, ${area}`, 
                    photoURL: photoURL, 
                    role: role,
                    jobTitle: role === 'provider' ? jobTitle : null,
                    jobTitleSearch: jobTitleSearch, 
                    createdAt: Timestamp.now(),
                    ratings: [],
                    avgRating: 0,
                    clientRatings: [], 
                    clientAvgRating: 0, 
                    // === Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®ØµÙˆØµÙŠØ© ÙˆØ§Ù„Ø¸Ù‡ÙˆØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ù…Ø­Ø¯Ø«Ø©) ===
                    isPhoneHidden: false,
                    isAddressHidden: false,
                    isDirectoryHidden: false,
                    isNotificationsEnabled: isNotificationsGranted, // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 4
                    isMessageNotificationsEnabled: true,
                    isJobNotificationsEnabled: true,
                    isRequestNotificationsEnabled: true,
                    isDarkModeEnabled: prefersDark, // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 7: ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­
                    isLocationSharingEnabled: false,
                    isOnline: true, 
                    unreadNotifications: 0, 
                    // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 3: Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Ø§Ù„Ù…Ù†Ø§ÙØ¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ===
                    chatPermission: 'all', 
                    ratingPermission: 'all', 
                };








                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, newUserId);
                await setDoc(userDocRef, newUserProfile);








                userProfile = newUserProfile;
                userId = newUserId;
                hideLoading();
                showMessageModal('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠØ©!', true);








                setTimeout(() => {
                    navigateTo(userProfile.role === 'provider' ? 'providerHome' : 'clientHome');
                }, 1500);








            } catch (error) {
                console.error("Register Error: ", error);
                let displayError = error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
                if (error.code === 'auth/email-already-in-use') {
                    displayError = 'Ù‡Ø°Ø§ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„/Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„.';
                } else if (error.code === 'auth/invalid-email') {
                    displayError = 'ØµÙŠØºØ© Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± ØµØ­ÙŠØ­Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø±ÙˆÙ ÙˆØ£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·.';
                } else if (error.code === 'auth/weak-password') {
                    displayError = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… 6 Ø£Ø­Ø±Ù Ø£Ùˆ Ø£ÙƒØ«Ø±.';
                }








                errorEl.textContent = displayError;
                errorEl.classList.remove('hidden');
                hideLoading();
            } finally {
                isRegistering = false; 
            }
        }








        async function handleEditProfile(e) {
            e.preventDefault();
            showLoading('Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª...');
            const errorEl = document.getElementById('edit-error');
            errorEl.classList.add('hidden');








            try {
                const name = document.getElementById('edit-name').value;
                const phone = document.getElementById('edit-phone').value;
                const gender = document.querySelector('input[name="edit-gender"]:checked').value; 
                const city = document.getElementById('edit-city').value;
                const area = document.getElementById('edit-area').value.trim();
                const photoURL = document.getElementById('photo-base64').value || null; 








                if (phone.length !== 11 || !/^[0-9]{11}$/.test(phone)) {
                    throw new Error('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ù…ØµØ±ÙŠ ØµØ­ÙŠØ­ Ù…ÙƒÙˆÙ† Ù…Ù† 11 Ø±Ù‚Ù….');
                }
                if (!city || !area) {
                    throw new Error('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©/Ø§Ù„Ù…Ø±ÙƒØ² ÙˆØ¥Ø¯Ø®Ø§Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©.');
                }








                let jobTitle = userProfile.jobTitle;
                if (userProfile.role === 'provider') {
                    const jobSelect = document.getElementById('edit-job-select').value;
                    jobTitle = jobSelect;
                }








                showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
                const jobTitleSearch = userProfile.role === 'provider' ? jobTitle.toLowerCase() : null;








                const updates = {
                    name: name,
                    phone: phone,
                    gender: gender, 
                    addressCity: city, 
                    addressArea: area, 
                    address: `${city}, ${area}`,
                    photoURL: photoURL, 
                    jobTitle: userProfile.role === 'provider' ? jobTitle : null,
                    jobTitleSearch: jobTitleSearch,
                };








                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                await updateDoc(userDocRef, updates);








                await updateProfile(auth.currentUser, {
                    displayName: name,
                });








                userProfile = { ...userProfile, ...updates };








                hideLoading();
                showMessageModal('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ.', true);








                setTimeout(() => {
                    navigateTo('profile', { uid: userId });
                }, 1500);








            } catch (error) {
                console.error("Edit Profile Error: ", error);
                errorEl.textContent = error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª.';
                errorEl.classList.remove('hidden');
                hideLoading();
            }
        }








        async function handleLogout() {
            showLoading('Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬...');
            await updateOnlineStatus(false); // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¸Ù‡ÙˆØ± Ø¥Ù„Ù‰ ØºÙŠØ± Ù…ØªØµÙ„
            await signOut(auth);
            userId = null;
            userProfile = null;
            hideLoading();
            navigateTo('auth');
        }








        async function handleSendMessage(otherUserId) {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (text === '') return;








            input.value = '';








            const chatRoomId = [userId, otherUserId].sort().join('_');
            const messagesColRef = collection(db, `artifacts/${appId}/public/data/chats/${chatRoomId}/messages`);








            try {
                await addDoc(messagesColRef, {
                    text: text,
                    senderId: userId,
                    createdAt: Timestamp.now()
                });








                const otherUserDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/users`, otherUserId));
                if (!otherUserDoc.exists()) { throw new Error("Other user not found"); }
                const otherUserData = otherUserDoc.data();








                const chatRoomDocRef = doc(db, `artifacts/${appId}/public/data/chats`, chatRoomId);
                const chatRoomData = {
                    users: [userId, otherUserId],
                    userDetails: {
                        [userId]: { name: userProfile.name, photoURL: userProfile.photoURL },
                        [otherUserId]: { name: otherUserData.name, photoURL: otherUserData.photoURL }
                    },
                    lastMessage: text,
                    lastSenderId: userId,
                    lastUpdate: Timestamp.now(),
                    // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 1: ØªØ­Ø¯ÙŠØ« Ø­Ù‚Ù„ unreadBy ===
                    unreadBy: [otherUserId]
                };
                await setDoc(chatRoomDocRef, chatRoomData, { merge: true });




                // === Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªÙ„Ù… (Ù…Ø­Ø¯Ø«) ===
                await createNotification(
                    otherUserId, 
                    'message', 
                    `Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† ${userProfile.name}`, 
                    'chat', 
                    { otherUserId: userId }
                );




            } catch (error) {
                console.error("Error sending message: ", error);
            }
        }








        async function handleSubmitRequest(e) {
            e.preventDefault();
            showLoading('Ø¬Ø§Ø±ÙŠ Ù†Ø´Ø± Ø§Ù„Ø·Ù„Ø¨...');
            const errorEl = document.getElementById('request-error');
            errorEl.classList.add('hidden');








            try {
                const title = document.getElementById('request-title').value;
                const category = document.getElementById('request-category').value;
                const description = document.getElementById('request-description').value;








                if (!title || !category || !description) {
                    throw new Error('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.');
                }








                const requestsColRef = collection(db, `artifacts/${appId}/public/data/serviceRequests`);
                const newRequestRef = await addDoc(requestsColRef, {
                    title: title,
                    category: category,
                    description: description,
                    requesterId: userId,
                    requesterName: userProfile.name,
                    requesterPhoto: userProfile.photoURL,
                    status: 'open',
                    createdAt: Timestamp.now()
                });




                // === Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù…Ù‚Ø¯Ù…ÙŠ Ø§Ù„Ø®Ø¯Ù…Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ø§Ù„ (Ø¬Ø¯ÙŠØ¯) ===
                const usersColRef = collection(db, `artifacts/${appId}/public/data/users`);
                const providersQuery = query(usersColRef, where('role', '==', 'provider'), where('jobTitle', '==', category));
                const providersSnapshot = await getDocs(providersQuery);




                providersSnapshot.docs.forEach(doc => {
                    createNotification(
                        doc.id, 
                        'request', 
                        `Ø·Ù„Ø¨ Ø®Ø¯Ù…Ø© Ø¬Ø¯ÙŠØ¯: ${category}`, 
                        'providerHome'
                    );
                });




                hideLoading();
                showMessageModal('ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø·Ù„Ø¨', 'ÙŠÙ…ÙƒÙ† Ù„Ù…Ù‚Ø¯Ù…ÙŠ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¢Ù† Ø±Ø¤ÙŠØ© Ø·Ù„Ø¨Ùƒ ÙˆØ§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ.', true);








                setTimeout(() => {
                    navigateTo(userProfile.role === 'provider' ? 'providerHome' : 'clientHome');
                }, 1500);








            } catch (error) {
                console.error("Error submitting request: ", error);
                errorEl.textContent = error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù†Ø´Ø± Ø§Ù„Ø·Ù„Ø¨.';
                errorEl.classList.remove('hidden');
                hideLoading();
            }
        }








        // === Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¹Ù„Ø§Ù† ÙˆØ¸ÙŠÙØ© ===
        async function handleSubmitJobPost(e) {
            e.preventDefault();
            showLoading('Ø¬Ø§Ø±ÙŠ Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„ÙˆØ¸ÙŠÙØ©...');
            const errorEl = document.getElementById('job-post-error');
            errorEl.classList.add('hidden');








            try {
                const title = document.getElementById('job-title').value;
                const category = document.getElementById('job-category').value;
                const details = document.getElementById('job-details').value;








                if (!title || !category || !details) {
                    throw new Error('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.');
                }








                const jobPostingsColRef = collection(db, `artifacts/${appId}/public/data/jobPostings`);
                const newJobPostRef = await addDoc(jobPostingsColRef, {
                    title: title,
                    category: category,
                    details: details,
                    posterId: userId,
                    posterName: userProfile.name,
                    posterPhoto: userProfile.photoURL,
                    createdAt: Timestamp.now()
                });




                // === Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù…Ù‚Ø¯Ù…ÙŠ Ø§Ù„Ø®Ø¯Ù…Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ø§Ù„ (Ø¬Ø¯ÙŠØ¯) ===
                const usersColRef = collection(db, `artifacts/${appId}/public/data/users`);
                const providersQuery = query(usersColRef, where('role', '==', 'provider'), where('jobTitle', '==', category));
                const providersSnapshot = await getDocs(providersQuery);




                providersSnapshot.docs.forEach(doc => {
                    createNotification(
                        doc.id, 
                        'job', 
                        `Ø¥Ø¹Ù„Ø§Ù† ÙˆØ¸ÙŠÙØ© Ø¬Ø¯ÙŠØ¯: ${category}`, 
                        'jobListings'
                    );
                });




                hideLoading();
                showMessageModal('ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†', 'ØªÙ… Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø¨Ù†Ø¬Ø§Ø­.', true);








                setTimeout(() => {
                    navigateTo('jobListings');
                }, 1500);








            } catch (error) {
                console.error("Error submitting job post: ", error);
                errorEl.textContent = error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†.';
                errorEl.classList.remove('hidden');
                hideLoading();
            }
        }




        // === Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø¥Ø¹Ù„Ø§Ù†/Ø·Ù„Ø¨ ===
        async function handleDeletePosting(type, id) {
             const collectionName = type === 'request' ? 'serviceRequests' : 'jobPostings';
             const confirmDelete = await new Promise(resolve => {
                showModal(`
                    <h2 class="text-xl font-semibold text-center text-red-600 mb-4">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h2>
                    <p class="text-center text-gray-700">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ ${type === 'request' ? 'Ø§Ù„Ø·Ù„Ø¨' : 'Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†'}ØŸ</p>
                    <div class="flex justify-between mt-6 space-x-4 space-x-reverse">
                        <button data-action="closeModal" class="flex-1 py-2 px-4 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 text-sm">
                            Ø¥Ù„ØºØ§Ø¡
                        </button>
                        <button data-action="confirmDelete" class="flex-1 py-2 px-4 border border-transparent rounded-md text-white bg-red-600 hover:bg-red-700 text-sm">
                            ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù
                        </button>
                    </div>
                `);
                document.querySelector('[data-action="confirmDelete"]').addEventListener('click', () => {
                    hideModal();
                    resolve(true);
                });
                document.querySelector('[data-action="closeModal"]').addEventListener('click', () => {
                    hideModal();
                    resolve(false);
                });
            });




            if (!confirmDelete) return;




            showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...');
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/${collectionName}`, id);
                await deleteDoc(docRef);
                hideLoading();
                showMessageModal('Ù†Ø¬Ø§Ø­', `ØªÙ… Ø­Ø°Ù ${type === 'request' ? 'Ø§Ù„Ø·Ù„Ø¨' : 'Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†'} Ø¨Ù†Ø¬Ø§Ø­.`, true);
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ­Ø¯ÙŠØ«
                setTimeout(() => {
                    navigateTo('myPostings');
                }, 1000); 
            } catch (error) {
                console.error("Error deleting posting: ", error);
                hideLoading();
                showMessageModal('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', false);
            }
        }








        function handleOpenRatingModal(targetRole, targetId, targetName) {
            // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 3: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø°Ù† Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ===
            const ratingPermission = userProfile.ratingPermission || 'all';
            let canRate = true;
            if (ratingPermission === 'none') {
                canRate = false;
            } else if (ratingPermission === 'providers' && userProfile.role !== 'provider') {
                canRate = false;
            } else if (ratingPermission === 'clients' && userProfile.role !== 'client') {
                canRate = false;
            }
            
            if (!canRate) {
                showMessageModal('ØºÙŠØ± Ù…ØµØ±Ø­', 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø§Ù„Ø¥Ø°Ù† Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙƒ.', false);
                return;
            }
            
            
            const modalHtml = `
                <h2 class="text-xl font-semibold text-center mb-4">ØªÙ‚ÙŠÙŠÙ… ${targetName} (${targetRole === 'provider' ? 'Ù…Ù‚Ø¯Ù… Ø®Ø¯Ù…Ø©' : 'Ø¹Ù…ÙŠÙ„'})</h2>
                <div id="rating-stars" class="flex justify-center text-gray-300 space-x-2 space-x-reverse mb-4 cursor-pointer">
                    ${[1,2,3,4,5].map(i => `<span data-action="setRating" data-value="${i}" class="star-icon hover:text-yellow-400">${ICONS.starEmpty}</span>`).join('')}
                </div>
                <input type="hidden" id="rating-value" value="0">
                <textarea id="rating-comment" class="w-full p-2 border border-gray-300 rounded-md text-sm" rows="3" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ Ù‡Ù†Ø§..."></textarea>
                <div class="flex justify-between mt-6 space-x-4 space-x-reverse">
                    <button data-action="closeModal" class="flex-1 py-2 px-4 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 text-sm">
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                    <button data-action="submitRating" data-targetrole="${targetRole}" data-targetid="${targetId}" class="flex-1 py-2 px-4 border border-transparent rounded-md text-white bg-indigo-600 hover:bg-indigo-700 text-sm">
                        Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
                    </button>
                </div>
            `;
            showModal(modalHtml);
        }








        // === ØªÙˆØ­ÙŠØ¯ Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù„Ù„Ù…Ù‚Ø¯Ù… ÙˆØ§Ù„Ø¹Ù…ÙŠÙ„ ===
        async function handleSubmitRating(targetId, targetRole) {
            const stars = parseInt(document.getElementById('rating-value').value);
            const comment = document.getElementById('rating-comment').value.trim();








            if (stars === 0) {
                showMessageModal('Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø¬ÙˆÙ… Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….', false);
                return;
            }








            showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…...');








            try {
                const targetDocRef = doc(db, `artifacts/${appId}/public/data/users`, targetId);
                const ratingFieldName = targetRole === 'provider' ? 'ratings' : 'clientRatings';
                const avgRatingFieldName = targetRole === 'provider' ? 'avgRating' : 'clientAvgRating';








                await runTransaction(db, async (transaction) => {
                    const targetDoc = await transaction.get(targetDocRef);
                    if (!targetDoc.exists()) {
                        throw "Target user document does not exist!";
                    }








                    const data = targetDoc.data();
                    const oldRatings = data[ratingFieldName] || [];
                    const filteredRatings = oldRatings.filter(r => r.by !== userId);








                    const newRating = {
                        by: userId,
                        byName: userProfile.name,
                        stars: stars,
                        comment: comment,
                        createdAt: Timestamp.now()
                    };
                    const newRatings = [...filteredRatings, newRating];








                    // âš ï¸ ØªÙ… ØªØµØ­ÙŠØ­ Ø§Ù„Ø®Ø·Ø£ Ù‡Ù†Ø§: Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚ÙˆØ³ Ø§Ù„Ù†Ø§Ù‚Øµ Ø¨Ø¹Ø¯ r
                    const totalStars = newRatings.reduce((acc, r) => acc + r.stars, 0);
                    const newAvgRating = totalStars / newRatings.length;








                    const updates = {};
                    updates[ratingFieldName] = newRatings;
                    updates[avgRatingFieldName] = newAvgRating;








                    transaction.update(targetDocRef, updates);
                });








                hideLoading();
                hideModal();
                showMessageModal('Ù†Ø¬Ø§Ø­', 'Ø´ÙƒØ±Ø§Ù‹ Ù„ØªÙ‚ÙŠÙŠÙ…Ùƒ!', true);








            } catch (error) {
                console.error("Error submitting rating: ", error);
                hideLoading();
                showMessageModal('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', false);
            }
        }




        // === Ø¯Ø§Ù„Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± (Ø¬Ø¯ÙŠØ¯ - Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø¹Ø¯Ù… Ø§Ø®ØªÙØ§Ø¡ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©) ===
        async function handleReadNotification(notificationId, page, params) {
            try {
                const notificationDocRef = doc(db, `artifacts/${appId}/public/data/notifications`, notificationId);
                const notificationDoc = await getDoc(notificationDocRef);




                if (notificationDoc.exists() && !notificationDoc.data().isRead) {
                    await updateDoc(notificationDocRef, { isRead: true });
                    // ØªÙ‚Ù„ÙŠÙ„ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©
                    await updateNotificationCount(-1);
                }




                // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
                navigateTo(page, params);
            } catch (error) {
                console.error("Error reading notification:", error);
                showMessageModal('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±.', false);
            }
        }




        // 11. Event Delegation (Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ø£Ø­Ø¯Ø§Ø«)
        appContainer.addEventListener('click', async (e) => {
            const target = e.target.closest('[data-action]');
            if (!target) return;








            const action = target.dataset.action;
            const page = target.dataset.page;
            const uid = target.dataset.uid;
            const category = target.dataset.category;
            const otherUserId = target.dataset.otheruserid;
            const targetId = target.dataset.targetid;
            const targetName = target.dataset.targetname;
            const targetRole = target.dataset.targetrole;
            const type = target.dataset.type;
            const id = target.dataset.id;
            const params = target.dataset.params ? JSON.parse(target.dataset.params) : {};




            switch (action) {
                case 'navigateTo':
                    if (page === 'profile') navigateTo(page, { uid });
                    else if (page === 'category') navigateTo(page, { category });
                    else if (page === 'chat') navigateTo(page, { otherUserId });
                    else if (page === 'home') navigateTo(userProfile.role === 'provider' ? 'providerHome' : 'clientHome');
                    else navigateTo(page);
                    break;








                case 'goBack':
                    // === Ø¥ØµÙ„Ø§Ø­ Ù…Ù†Ø·Ù‚ Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ ===
                    if (navigationHistory.length > 1) {
                        navigationHistory.pop(); // 1. Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ø³Ø¬Ù„
                        const previousRoute = navigationHistory[navigationHistory.length - 1]; // 2. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
                        navigateTo(previousRoute.page, previousRoute.params); // 3. Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„ÙŠÙ‡Ø§ (Ù„Ù† ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø³Ø¨Ø¨ Ù…Ù†Ø·Ù‚ navigateTo)
                    } else if (userId) {
                         navigateTo(userProfile.role === 'provider' ? 'providerHome' : 'clientHome');
                    } else {
                         navigateTo('auth');
                    }
                    break;








                case 'login':
                    e.preventDefault();
                    await handleLogin(e); 
                    break;
                case 'register':
                    e.preventDefault();
                    await handleRegister(e);
                    break;
                case 'logout':
                    await handleLogout();
                    break;
                case 'editProfile': 
                    e.preventDefault();
                    await handleEditProfile(e);
                    break;
                case 'saveSettings': // === Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ===
                    await handleSaveSettings();
                    break;
                case 'sendMessage':
                    e.preventDefault();
                    await handleSendMessage(otherUserId);
                    break;
                case 'submitRequest':
                    e.preventDefault();
                    await handleSubmitRequest(e);
                    break;
                case 'submitJobPost': 
                    e.preventDefault();
                    await handleSubmitJobPost(e);
                    break;
                case 'deletePosting': 
                    await handleDeletePosting(type, id);
                    break;
                case 'openRatingModal': // ØªÙ‚ÙŠÙŠÙ… Ù…Ù‚Ø¯Ù… Ø§Ù„Ø®Ø¯Ù…Ø©
                    handleOpenRatingModal('provider', targetId, targetName);
                    break;
                case 'openRatingClientModal': // ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„ 
                    handleOpenRatingModal('client', targetId, targetName);
                    break;
                case 'readNotification': // === Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ===
                    await handleReadNotification(id, page, params);
                    break;
                case 'openChangePasswordModal': // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 3: ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ===
                    handleChangePasswordModal();
                    break;
            }
        });








        modalBackdrop.addEventListener('click', (e) => {
            const target = e.target.closest('[data-action]');
            if (!target && e.target === modalBackdrop) {
                return;
            }
            if(!target) return;








            const action = target.dataset.action;
            switch(action) {
                case 'closeModal':
                    hideModal();
                    break;
                case 'setRating':
                    const value = parseInt(target.dataset.value);
                    document.getElementById('rating-value').value = value;
                    const stars = document.querySelectorAll('#rating-stars .star-icon');
                    stars.forEach((star, index) => {
                        if (index < value) {
                            star.innerHTML = ICONS.star;
                            star.classList.add('text-yellow-400');
                        } else {
                            star.innerHTML = ICONS.starEmpty;
                            star.classList.remove('text-yellow-400');
                        }
                    });
                    break;
                case 'submitRating':
                    const targetId = target.dataset.targetid;
                    const targetRole = target.dataset.targetrole;
                    handleSubmitRating(targetId, targetRole);
                    break;
                case 'changePassword': // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 3: Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ===
                    handleChangePassword(e);
                    break;
            }
        });








        appContainer.addEventListener('change', (e) => {
            if (e.target.name === 'role') {
                const jobField = document.getElementById('job-title-field');
                if (e.target.value === 'provider') {
                    jobField.classList.remove('hidden');
                } else {
                    jobField.classList.add('hidden');
                }
            }
        });








        appContainer.addEventListener('submit', (e) => {
            e.preventDefault();
        });




        // === Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„/Ø§Ù„Ø§Ù†ÙØµØ§Ù„ (Ù…Ø­Ø¯Ø«) ===
        window.addEventListener('beforeunload', () => {
             if (userId) {
                updateOnlineStatus(false);
            }
        });




        document.addEventListener('visibilitychange', () => {
            if (userId) {
                if (document.visibilityState === 'hidden') {
                    updateOnlineStatus(false);
                } else {
                    updateOnlineStatus(true);
                }
            }
        });




        // 13. Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        window.onload = () => {
            // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 1: Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ ===
            requestNotificationPermission();

            // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 1: Ø§Ù„Ø¨Ø¯Ø¡ Ø¨ØµÙØ­Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø«Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ===
            navigateTo('loading');
            
            // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 7: Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… ===
            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                    if (userProfile && userProfile.isDarkModeEnabled) {
                        applyDarkMode(e.matches);
                    }
                });
            }








            onAuthStateChanged(auth, async (user) => {








                if (isRegistering) {
                    console.log('Registration in progress, onAuthStateChanged will handle.');
                    return; 
                }








                if (user) {
                    console.log('User is signed in:', user.uid);
                    userId = user.uid;








                    const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                    const userDoc = await getDoc(userDocRef);








                    if (userDoc.exists()) {
                        userProfile = userDoc.data();
                        console.log('User profile found:', userProfile);

                        // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 7: ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ===
                        applyDarkMode(userProfile.isDarkModeEnabled);

                        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¸Ù‡ÙˆØ± Ø¥Ù„Ù‰ Ù…ØªØµÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
                        await updateOnlineStatus(true);




                        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
                        if(navigationHistory.length <= 1 || navigationHistory[navigationHistory.length - 1].page === 'auth' || navigationHistory[navigationHistory.length - 1].page === 'register') {
                            navigateTo(userProfile.role === 'provider' ? 'providerHome' : 'clientHome');
                        } else {
                            // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ ØµÙØ­Ø© Ù…Ø§ØŒ Ø§ØªØ±ÙƒÙ‡ Ù‡Ù†Ø§Ùƒ
                            navigateTo(navigationHistory[navigationHistory.length - 1].page, navigationHistory[navigationHistory.length - 1].params);
                        }
                    } else {
                        console.log('No profile found, redirecting to register.');
                        navigateTo('register');
                    }
                } else {
                    console.log('User is signed out.');
                    userId = null;
                    userProfile = null;
                    // === Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 1: Ø¶Ù…Ø§Ù† Ø¹Ø±Ø¶ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙˆØ§Ø¬Ù‡Ø© Ø£ÙˆÙ„Ù‰ ===
                    navigateTo('auth');
                }
            });








            (async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        console.log("Signing in with custom token...");
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else if (!auth.currentUser) {
                         console.log("No token, onAuthStateChanged will handle.");
                    }
                } catch (error) {
                    console.error("Error during initial auth:", error);
                    navigateTo('auth');
                }
            })();
        };


        // 14. PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…Ù„Ù service-worker.js Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }








    </script>
    <!-- ============================================= -->
    <!-- ==== Ù†Ù‡Ø§ÙŠØ© ÙƒÙˆØ¯ Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª Ùˆ Firebase ===== -->
    <!-- ============================================= -->




<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then(registration => {
        console.log('âœ… Service Worker registered with scope:', registration.scope);
      })
      .catch(error => {
        console.error('âŒ Service Worker registration failed:', error);
      });
  });
}
</script>
    <script src="install-prompt.js" defer></script>
</body>
</html>
