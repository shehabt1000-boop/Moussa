<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
	<title>السوق وياك | 2026</title>


	<meta property="og:image" content="https://raw.githubusercontent.com/shehabt1000-boop/Moussa/main/647557c3-c686-4ae6-925e-9fd3765180a7.jpeg">
	<meta property="og:title" content="السوق وياك">
	<meta property="og:description" content="تصفح أفضل المنتجات والعروض الحصرية">
	<meta property="og:type" content="website">
	<meta name="twitter:card" content="summary_large_image">
	<meta name="twitter:image" content="https://raw.githubusercontent.com/shehabt1000-boop/Moussa/main/647557c3-c686-4ae6-925e-9fd3765180a7.jpeg">


	<meta name="theme-color" content="#0f172a">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="apple-mobile-web-app-title" content="السوق وياك">
	<link id="manifest-link" rel="manifest">




	<script src="https://cdn.tailwindcss.com"></script>
	<script>
    	tailwind.config = {
        	darkMode: 'class',
        	theme: { 
            	extend: { 
                	colors: { 
                    	navy: '#0f172a', 
                    	darkbg: '#1e293b', 
                    	primary: '#10b981', 
                    	secondary: '#3b82f6' 
                	},
                	fontFamily: {
                    	cairo: ['Cairo', 'sans-serif']
                	}
            	} 
        	}
    	}
	</script>
	<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
	<script src="https://unpkg.com/lucide@latest"></script>




	<style>
    	body { 
        	font-family: 'Cairo', sans-serif; 
        	-webkit-tap-highlight-color: transparent;
        	padding-bottom: 80px;
        	overscroll-behavior-y: none;
        	background-color: #f8fafc;
    	}
    	.dark body { background-color: #0f172a; }




    	.no-scrollbar::-webkit-scrollbar { display: none; }
    	.select-none { user-select: none; }




    	/* Custom Scrollbar */
    	.custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
    	.custom-scroll::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 4px; }
    	.custom-scroll::-webkit-scrollbar-thumb { background: #0f172a; border-radius: 10px; border: 1px solid white; }
    	.dark .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
    	.dark .custom-scroll::-webkit-scrollbar-thumb { background: #94a3b8; border: 1px solid #0f172a; }




    	@keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    	.animate-pop { animation: popIn 0.1s cubic-bezier(0.16, 1, 0.3, 1) forwards; }




    	.mobile-full-modal { position: fixed; inset: 0; z-index: 80; background-color: white; display: flex; flex-direction: column; height: 100dvh; }
    	.dark .mobile-full-modal { background-color: #0f172a; }




    	#profile-modal .mobile-full-modal, #order-modal .mobile-full-modal { z-index: 90; } 
    	#profile-modal.modal-overlay, #order-modal.modal-overlay { z-index: 90; }




    	@media (min-width: 768px) { 
        	.mobile-full-modal { position: relative; inset: auto; width: 100%; max-width: 28rem; height: 600px; max-height: 85vh; border-radius: 1.5rem; overflow: hidden; } 
        	.modal-overlay { position: fixed; inset: 0; z-index: 80; background-color: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; padding: 1rem; } 
    	}




    	/* Modern Toast */
    	@keyframes slideInDown { from { transform: translate(-50%, -100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
    	@keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    	.toast { 
        	animation: slideInDown 0.2s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; 
        	position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999;
        	width: max-content; max-width: 90vw; 
        	box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.2);
        	backdrop-filter: blur(8px);
    	}
    	.toast.hiding { animation: fadeOut 0.1s ease-in forwards; }




    	.form-label { display: block; font-size: 0.7rem; font-weight: 800; color: #334155; margin-bottom: 0.1rem; }
    	.dark .form-label { color: #cbd5e1; }




    	.form-input { 
        	width: 100%; background-color: #ffffff; border: 1px solid #000000 !important; border-radius: 0.5rem; 
        	padding: 0 0.5rem; height: 2.25rem; display: flex; align-items: center; font-size: 0.75rem; 
        	font-weight: 600; color: #1e293b; outline: none; transition: all 0.1s; line-height: normal; 
    	}
    	select.form-input {
        	padding-top: 0; padding-bottom: 0; -webkit-appearance: none; 
        	background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        	background-position: left 0.5rem center; background-repeat: no-repeat; background-size: 1.2em 1.2em; padding-left: 2rem; 
    	}
    	textarea.form-input { height: auto; padding-top: 0.5rem; padding-bottom: 0.5rem; }
    	.form-input:focus { border-color: #10b981 !important; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1); }
    	.dark .form-input { background-color: #1e293b; border-color: #94a3b8 !important; color: white; }
    	.dark .form-input:focus { border-color: #10b981 !important; }




    	.chip-checkbox:checked + div { background-color: #10b981; color: white; border-color: #10b981; }
    	.smart-option:checked + div { background-color: #0f172a; color: white; border-color: #0f172a; }
    	.dark .smart-option:checked + div { background-color: #10b981; border-color: #10b981; }




    	.star-rating input { display: none; }
    	.star-rating label { cursor: pointer; color: #cbd5e1; transition: color 0.1s; }
    	.star-rating input:checked ~ label, .star-rating label:hover, .star-rating label:hover ~ label { color: #fbbf24; }
    	.star-rating { display: flex; flex-direction: row-reverse; justify-content: flex-end; }




    	@keyframes slideUp { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    	.install-banner { animation: slideUp 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; }




    	#login-view { position: fixed; inset: 0; z-index: 200; background-color: #f1f5f9; display: flex; align-items: center; justify-content: center; padding: 1rem; }
    	#login-view.hidden { display: none !important; } 
    	.dark #login-view { background-color: #0f172a; }
    	.login-scroll { max-height: 65vh; overflow-y: auto; padding: 2px; }
    	.spinner { border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 2px solid #fff; width: 16px; height: 16px; animation: spin 1s linear infinite; }
    	@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }


    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-navy dark:text-slate-100 select-none">



	<!-- LOGIN VIEW -->
	<div id="login-view" class="hidden">
    	<div class="w-full max-w-md bg-white dark:bg-darkbg p-4 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 flex flex-col max-h-[95vh]">
        	<div class="flex flex-col items-center gap-1 mb-3 shrink-0">
            	<div class="bg-navy dark:bg-primary text-white p-2 rounded-xl shadow-lg rotate-3">
                	<i data-lucide="shopping-bag" class="w-5 h-5"></i>
            	</div>
            	<h1 class="font-black text-lg text-navy dark:text-white">السوق <span class="text-primary">وياك</span></h1>
        	</div>

        	<div class="bg-slate-100 dark:bg-slate-800 p-1 rounded-xl flex mb-2 border border-slate-200 dark:border-slate-700 shrink-0">
            	<button onclick="setAuthType('login')" id="btn-type-login" class="flex-1 py-1.5 rounded-lg text-xs font-bold transition-all bg-navy dark:bg-primary text-white shadow-md">
                	تسجيل دخول
            	</button>
            	<button onclick="setAuthType('signup')" id="btn-type-signup" class="flex-1 py-1.5 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:text-navy dark:hover:text-white">
                	إنشاء حساب
            	</button>
        	</div>




        	<div class="bg-slate-100 dark:bg-slate-800 p-1 rounded-xl flex mb-3 border border-slate-200 dark:border-slate-700 shrink-0">
            	<button onclick="setAuthRole('customer')" id="btn-role-customer" class="flex-1 py-1.5 rounded-lg text-xs font-bold transition-all bg-navy text-white shadow-md">
                	<div class="flex items-center justify-center gap-2"><i data-lucide="user" class="w-3 h-3"></i> عميل</div>
            	</button>
            	<button onclick="setAuthRole('marketer')" id="btn-role-marketer" class="flex-1 py-1.5 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:bg-white dark:hover:bg-slate-700">
                	<div class="flex items-center justify-center gap-2"><i data-lucide="store" class="w-3 h-3"></i> مقدم خدمة</div>
            	</button>
        	</div>




        	<div class="login-scroll no-scrollbar space-y-2 flex-1">
            	<div id="auth-image-field" class="hidden flex-col items-center gap-2 transition-all duration-300">
                	<div class="relative group cursor-pointer">
                    	<input type="file" id="auth-img-input" accept="image/*" onchange="handleAuthImage(this)" class="absolute inset-0 opacity-0 z-10 cursor-pointer">
                    	<div class="w-16 h-16 rounded-full bg-slate-50 dark:bg-slate-800 border-2 border-dashed border-primary/50 flex items-center justify-center overflow-hidden relative hover:bg-primary/5 transition">
                        	<img id="auth-img-preview" src="" class="w-full h-full object-cover hidden">
                        	<div id="auth-img-placeholder" class="flex flex-col items-center text-slate-400">
                            	<i data-lucide="camera" class="w-5 h-5 mb-1"></i>
                            	<span class="text-[8px] font-bold">صورة</span>
                        	</div>
                    	</div>
                    	<div class="absolute bottom-0 right-0 bg-navy dark:bg-primary text-white p-1 rounded-full shadow-sm pointer-events-none"><i data-lucide="plus" class="w-3 h-3"></i></div>
                	</div>
            	</div>




            	<div>
                	<label id="lbl-username" class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-0.5 block mr-1">اسم المستخدم (إنجليزي)</label>
                	<div class="relative">
                    	<input id="auth-username" type="text" class="form-input text-left" placeholder="username" style="direction: ltr;">
                    	<i data-lucide="at-sign" class="absolute right-3 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-400 pointer-events-none"></i>
                	</div>
            	</div>




            	<div>
                	<label class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-0.5 block mr-1">كلمة المرور</label>
                	<div class="relative">
                    	<input id="auth-pass" type="password" class="form-input" placeholder="******">
                    	<i data-lucide="lock" class="absolute right-3 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-400 pointer-events-none"></i>
                	</div>
            	</div>




            	<div id="signup-fields" class="hidden space-y-2 border-t border-slate-100 dark:border-slate-700 pt-2 mt-1">
                	<div>
                    	<label class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-0.5 block mr-1">الاسم الكامل (عربي)</label>
                    	<input id="auth-name-ar" type="text" class="form-input" placeholder="مثال: أحمد محمد">
                	</div>
                	<div>
                    	<label class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-0.5 block mr-1">رقم الهاتف</label>
                    	<input id="auth-phone" type="tel" class="form-input" placeholder="01xxxxxxxxx">
                	</div>




                	<div class="grid grid-cols-2 gap-2">
                    	<div>
                        	<label class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-0.5 block mr-1">المحافظة</label>
                        	<select id="auth-gov" onchange="updateCities()" class="form-input text-xs"></select>
                    	</div>
                    	<div>
                        	<label class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-0.5 block mr-1">المركز/المدينة</label>
                        	<select id="auth-city" class="form-input text-xs">
                            	<option value="">اختر المحافظة</option>
                        	</select>
                    	</div>
                	</div>
                	<div>
                    	<label class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-0.5 block mr-1">العنوان بالتفصيل</label>
                    	<input id="auth-address" type="text" class="form-input" placeholder="الشارع، رقم المنزل...">
                	</div>
            	</div>
        	</div>




        	<div class="mt-3 pt-2 border-t border-slate-100 dark:border-slate-700 shrink-0">
            	<button onclick="processAuth()" id="btn-auth-action" class="w-full bg-navy dark:bg-primary text-white py-2.5 rounded-xl font-bold shadow-lg shadow-navy/20 hover:opacity-90 transition-all active:scale-95 flex justify-center items-center gap-2 text-sm">
                	<span>دخول للحساب</span> <i data-lucide="arrow-left" class="w-4 h-4"></i>
            	</button>
            	<div id="auth-error" class="text-red-600 dark:text-red-400 text-[10px] font-bold text-center hidden bg-red-50 dark:bg-red-900/20 p-2 rounded-lg border border-red-200 dark:border-red-800 mt-2 break-words" dir="ltr"></div>
        	</div>
    	</div>
	</div>




	<!-- APP CONTENT -->
	<div id="app-content" class="hidden">
    	<div id="toast-container" class="fixed top-4 left-0 right-0 z-[120] flex flex-col items-center gap-2 pointer-events-none px-4"></div>




    	<!-- Header -->
    	<header class="fixed top-0 w-full z-[60] bg-white/95 dark:bg-navy/95 border-b border-slate-200 dark:border-slate-700 flex flex-col justify-center px-4 shadow-sm backdrop-blur-md h-12">
        	<div class="flex items-center justify-between w-full">
            	<div class="flex items-center gap-2" id="logo-trigger">
                	<div class="bg-navy dark:bg-primary text-white p-1 rounded-md"><i data-lucide="shopping-bag" class="w-4 h-4"></i></div>
                	<div class="flex flex-col leading-none">
                    	<h1 class="font-bold text-sm">السوق <span class="text-primary">وياك</span></h1>
                    	<div id="welcome-text" class="hidden text-[10px] font-bold mt-0.5">
                         	<span class="text-navy dark:text-white">أهلاً: </span><span id="header-username" class="text-primary"></span>
                    	</div>
                	</div>
            	</div>




            	<div class="flex gap-1.5 items-center">
                	<button onclick="toggleProfile(null)" class="p-1.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-white hover:bg-slate-200 transition"><i data-lucide="user" class="w-4 h-4"></i></button>
                	<button onclick="toggleDarkMode()" class="p-1.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-yellow-400 hover:bg-slate-200 transition"><i data-lucide="moon" class="w-4 h-4 block dark:hidden"></i><i data-lucide="sun" class="w-4 h-4 hidden dark:block"></i></button>
                	<button onclick="toggleAdminPanel()" id="btn-admin-top" class="hidden bg-slate-100 dark:bg-slate-800 p-1.5 rounded-full text-slate-600 dark:text-white"><i data-lucide="shield" class="w-4 h-4"></i></button>
                	<button onclick="logout()" class="p-1.5 rounded-full bg-slate-100 dark:bg-slate-800 text-red-600 hover:bg-red-100 transition"><i data-lucide="log-out" class="w-4 h-4"></i></button>
            	</div>
        	</div>
    	</header>




    	<main class="pt-14 container mx-auto px-4 max-w-6xl min-h-screen">
        	<div id="view-header" class="hidden flex items-center gap-2 pb-1">
            	<button onclick="switchToHomeView()" class="bg-white dark:bg-slate-800 p-1.5 rounded-full border border-slate-200 dark:border-slate-700 shadow-sm"><i data-lucide="arrow-right" class="w-4 h-4 text-slate-600 dark:text-white"></i></button>
            	<h2 id="view-title" class="text-base font-bold text-slate-800 dark:text-white pt-0.5"></h2>
        	</div>




        	<div id="search-container" class="sticky top-12 z-[50] bg-slate-50/95 dark:bg-navy/95 backdrop-blur-lg pt-1.5 pb-1.5 -mx-4 px-4 transition-all">
            	<div class="relative max-w-3xl mx-auto flex gap-2 items-center">
                	<div class="relative flex-1">
                    	<input type="text" id="search-input" oninput="handleSearch()" placeholder="ابحث..." class="w-full form-input pr-9 pl-20 h-8 shadow-sm text-xs">
                    	<i data-lucide="search" class="absolute right-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-400"></i>




                    	<div class="absolute left-2 top-1/2 -translate-y-1/2 flex items-center gap-1 z-10">
                        	<button id="btn-filter-toggle" onclick="toggleFilterPanel()" class="hidden text-secondary dark:text-blue-400 p-1 hover:scale-110 transition">
                            	<i data-lucide="sliders-horizontal" class="w-3.5 h-3.5"></i>
                        	</button>
                        	<button onclick="toggleFavView()" class="relative text-red-500 p-1 hover:scale-110 transition">
                            	<i data-lucide="heart" class="w-3.5 h-3.5"></i>
                            	<span id="fav-count" class="absolute top-0 right-0 w-1.5 h-1.5 bg-red-600 rounded-full border border-white dark:border-darkbg hidden"></span>
                        	</button>
                    	</div>
                	</div>
            	</div>




            	<div id="filter-panel" class="hidden mt-1 bg-white dark:bg-darkbg p-2 rounded-xl border border-slate-200 dark:border-slate-700 shadow-xl animate-pop relative z-50">
                	<div class="flex justify-between items-center mb-1">
                    	<span class="font-bold text-[10px]">تصفية النتائج</span>
                    	<button onclick="resetFilters()" class="text-[10px] text-red-500 font-bold underline cursor-pointer p-1">إعادة تعيين</button>
                	</div>
                	<div class="grid grid-cols-2 gap-2">
                    	<select id="filter-gov" onchange="applyFilters()" class="form-input text-xs h-7">
                        	<option value="">كل المحافظات</option>
                    	</select>
                    	<select id="filter-price" onchange="applyFilters()" class="form-input text-xs h-7">
                        	<option value="">كل الأسعار</option>
                        	<option value="low">الأقل سعراً</option>
                        	<option value="high">الأعلى سعراً</option>
                    	</select>
                	</div>
            	</div>
        	</div>


       <div id="categories-container" class="hidden justify-start gap-2 overflow-x-auto pt-1 pb-2 no-scrollbar"></div>

        <div id="home-grid" class="hidden grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 pb-10 mt-4"></div>

        <div id="grid-container" class="hidden grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 pb-10 mt-2"></div>

        <div id="loader" class="text-center py-20"><div class="w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-2"></div><p class="text-xs text-slate-400">جاري التحميل...</p></div>
        <div id="empty-state" class="hidden text-center py-20 opacity-60 flex-col items-center"><div class="bg-slate-200 dark:bg-slate-800 p-4 rounded-full inline-block mb-2"><i data-lucide="shirt" class="w-8 h-8 text-slate-400"></i></div><p class="text-slate-500 dark:text-slate-400 font-bold text-sm">لا توجد نتائج</p><button onclick="resetFilters()" class="mt-2 text-primary text-xs font-bold underline">إعادة تعيين</button></div>
    </main>


    	<!-- NAV BAR -->
    	<nav class="fixed bottom-4 left-1/2 -translate-x-1/2 z-[70] bg-white/90 dark:bg-slate-800/90 border border-slate-200 dark:border-slate-600 px-6 py-2 rounded-full flex items-center gap-8 shadow-lg transform transition-all hover:scale-105">
        	<button onclick="switchToHomeView()" class="flex flex-col items-center gap-1 text-slate-500 dark:text-slate-400 hover:text-navy dark:hover:text-white transition group"><i data-lucide="home" class="w-5 h-5 group-hover:scale-110 transition"></i></button>
        	<button id="nav-add-btn" onclick="toggleAddModal()" class="w-12 h-12 bg-navy dark:bg-primary text-white rounded-full flex items-center justify-center shadow-lg shadow-slate-900/20 transform -translate-y-5 border-4 border-slate-50 dark:border-navy hover:scale-110 transition active:scale-90"><i data-lucide="plus" class="w-6 h-6"></i></button>
        	<button onclick="toggleChat()" class="flex flex-col items-center gap-1 text-slate-500 dark:text-slate-400 hover:text-navy dark:hover:text-white transition group relative"><div id="chat-badge" class="hidden absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border border-white dark:border-slate-800"></div><i data-lucide="message-circle" class="w-5 h-5 group-hover:scale-110 transition"></i></button>
    	</nav>




    	<!-- PWA Install Banner (Top) -->
    	<div id="install-banner" class="hidden fixed top-0 left-0 right-0 bg-navy dark:bg-white dark:text-navy text-white p-3 shadow-2xl z-[110] flex items-center justify-between install-banner border-b dark:border-slate-200">
        	<div class="flex items-center gap-3">
            	<div class="bg-white/10 dark:bg-navy/10 p-2 rounded-lg"><i data-lucide="download" class="w-5 h-5"></i></div>
            	<div>
                	<h4 class="font-bold text-xs">تثبيت التطبيق</h4>
                	<p class="text-[10px] opacity-80">تجربة أسرع وأسهل</p>
            	</div>
        	</div>
        	<div class="flex gap-2">
            	<button onclick="installPWA()" class="bg-primary text-white px-3 py-1.5 rounded-lg font-bold text-xs shadow-lg">تثبيت</button>
            	<button onclick="closeInstall()" class="text-white dark:text-navy p-1"><i data-lucide="x" class="w-4 h-4"></i></button>
        	</div>
    	</div>
	</div>




	<!-- Profile Modal -->
	<div id="profile-modal" class="hidden modal-overlay">
    	<div class="mobile-full-modal animate-pop border border-slate-200 dark:border-slate-700">
        	<div class="bg-navy dark:bg-primary p-3 text-white flex justify-between items-center shrink-0">
            	<h3 class="font-bold text-sm">الملف الشخصي</h3>
            	<button onclick="toggleProfile()" class="bg-red-500 hover:bg-red-600 p-1.5 rounded-full text-white shadow-sm"><i data-lucide="x" class="w-4 h-4"></i></button>
        	</div>
        	<div class="flex-1 overflow-y-auto p-4 bg-white dark:bg-darkbg custom-scroll">




            	<!-- VIEW MODE -->
            	<div id="prof-view-mode">
                	<div class="flex flex-col items-center gap-3 mb-6">
                    	<div id="prof-img-container" class="w-24 h-24 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center overflow-hidden border-4 border-primary shadow-lg">
                        	<i data-lucide="user" class="w-10 h-10 text-slate-400"></i>
                    	</div>
                    	<div class="text-center w-full">
                        	<div class="flex items-center justify-center gap-2">
                            	<h2 id="prof-name" class="font-black text-xl text-navy dark:text-white">...</h2>
                            	<button id="global-edit-btn" onclick="toggleEditMode()" class="hidden flex items-center gap-1 text-primary hover:text-primary/80 bg-primary/10 px-2 py-0.5 rounded-full transition">
                                	<i data-lucide="pen-tool" class="w-3 h-3"></i> <span class="text-[10px] font-bold">تعديل</span>
                            	</button>
                        	</div>




                        	<div id="prof-rating-display" class="flex justify-center items-center gap-1 mt-1 text-yellow-400 text-xs font-bold hidden">
                            	<span>★</span> <span id="prof-rating-val">0.0</span>
                        	</div>
                        	<span id="prof-role" class="text-xs bg-slate-100 dark:bg-slate-700 px-3 py-1 rounded-full text-slate-500 dark:text-slate-300 font-bold mt-1 inline-block">...</span>
                        	<p id="prof-joined" class="text-[10px] text-slate-400 mt-1 text-black dark:text-white font-bold"></p>
                    	</div>
                	</div>




                	<div class="space-y-3 mb-6">
                    	<div class="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border border-slate-100 dark:border-slate-700">
                        	<label class="text-[10px] font-bold text-slate-400 mb-1 block">رقم الهاتف</label>
                        	<div class="flex items-center gap-2 font-bold text-sm text-navy dark:text-white">
                            	<i data-lucide="phone" class="w-4 h-4 text-primary"></i>
                            	<span id="prof-phone">...</span>
                        	</div>
                    	</div>




                    	<div class="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border border-slate-100 dark:border-slate-700">
                        	<label class="text-[10px] font-bold text-slate-400 mb-1 block">العنوان بالتفصيل</label>
                        	<div class="flex items-center gap-2 font-bold text-sm text-navy dark:text-white">
                            	<i data-lucide="map-pin" class="w-4 h-4 text-primary"></i>
                            	<span id="prof-address">...</span>
                        	</div>
                    	</div>




                    	<div id="prof-rate-user-section" class="hidden bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border border-slate-100 dark:border-slate-700 mt-2">
                        	<label class="text-[10px] font-bold text-slate-400 mb-2 block">قيم هذا المستخدم</label>
                        	<div class="flex flex-col gap-2">
                            	<div class="star-rating text-lg self-end">
                                	<input type="radio" id="u-star5" name="u-rating" value="5" onclick="setUserRating(5)"><label for="u-star5">★</label>
                                	<input type="radio" id="u-star4" name="u-rating" value="4" onclick="setUserRating(4)"><label for="u-star4">★</label>
                                	<input type="radio" id="u-star3" name="u-rating" value="3" onclick="setUserRating(3)"><label for="u-star3">★</label>
                                	<input type="radio" id="u-star2" name="u-rating" value="2" onclick="setUserRating(2)"><label for="u-star2">★</label>
                                	<input type="radio" id="u-star1" name="u-rating" value="1" onclick="setUserRating(1)"><label for="u-star1">★</label>
                            	</div>
                            	<textarea id="user-review-text" class="form-input text-xs w-full" rows="2" placeholder="اكتب تعليقك..."></textarea>
                            	<button onclick="submitUserReview()" class="bg-primary text-white px-3 py-1.5 rounded-lg text-xs font-bold w-full">إرسال التقييم</button>
                        	</div>
                    	</div>
                	</div>




                	<div id="prof-reviews-section" class="hidden">
                    	<h3 class="font-bold text-sm text-navy dark:text-white mb-3 border-b pb-2 border-slate-100 dark:border-slate-700">آراء العملاء</h3>
                    	<div id="prof-reviews-list" class="space-y-3"></div>
                    	<div class="flex gap-2 mt-2">
                        	<button id="prof-reviews-more" onclick="loadProfileReviews(true)" class="hidden flex-1 text-center text-xs text-primary font-bold py-2 bg-slate-50 dark:bg-slate-800 rounded-lg">عرض المزيد</button>
                        	<button id="prof-reviews-less" onclick="loadProfileReviews(false, true)" class="hidden flex-1 text-center text-xs text-red-500 font-bold py-2 bg-slate-50 dark:bg-slate-800 rounded-lg">عرض أقل</button>
                    	</div>
                	</div>
            	</div>




            	<!-- EDIT MODE -->
            	<div id="prof-edit-mode" class="hidden space-y-3">
                	<div class="flex flex-col items-center gap-2 mb-4">
                    	<div class="w-24 h-24 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center overflow-hidden border-4 border-primary shadow-lg relative group">
                        	<img id="edit-img-preview" src="" class="w-full h-full object-cover hidden">
                        	<div id="edit-img-placeholder" class="flex flex-col items-center text-slate-400">
                            	<i data-lucide="camera" class="w-8 h-8"></i>
                        	</div>
                        	<input type="file" id="edit-img-input" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleEditImage(this)">
                    	</div>
                    	<span class="text-[10px] text-primary font-bold">اضغط لتغيير الصورة</span>
                	</div>




                	<div>
                    	<label class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-1 block">الاسم الكامل</label>
                    	<input id="edit-name" type="text" class="form-input">
                	</div>
                	<div>
                    	<label class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-1 block">رقم الهاتف</label>
                    	<input id="edit-phone" type="tel" class="form-input">
                	</div>
                	<div class="grid grid-cols-2 gap-2">
                    	<div>
                        	<label class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-1 block">المحافظة</label>
                        	<select id="edit-gov" onchange="updateEditCities()" class="form-input text-xs"></select>
                    	</div>
                    	<div>
                        	<label class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-1 block">المركز/المدينة</label>
                        	<select id="edit-city" class="form-input text-xs"></select>
                    	</div>
                	</div>
                	<div>
                    	<label class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-1 block">العنوان بالتفصيل</label>
                    	<input id="edit-address" type="text" class="form-input">
                	</div>




                	<div id="prof-password-section" class="hidden bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border border-slate-100 dark:border-slate-700 mt-4">
                    	<label class="text-[10px] font-bold text-slate-400 mb-2 block">تغيير كلمة المرور</label>
                    	<div class="flex gap-2">
                        	<input id="new-password" type="password" class="form-input text-xs" placeholder="كلمة المرور الجديدة">
                        	<button onclick="changePassword()" class="bg-navy dark:bg-primary text-white px-3 py-1 rounded-lg text-xs font-bold whitespace-nowrap">تحديث</button>
                    	</div>
                	</div>




                	<div class="flex gap-2 pt-4">
                    	<button onclick="saveProfile()" class="flex-1 bg-primary text-white py-2 rounded-xl font-bold text-sm shadow-lg">حفظ التعديلات</button>
                    	<button onclick="toggleEditMode()" class="flex-1 bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-white py-2 rounded-xl font-bold text-sm">إلغاء</button>
                	</div>
            	</div>




        	</div>
    	</div>
	</div>




	<!-- Order Modal (Req 7) -->
	<div id="order-modal" class="hidden modal-overlay">
    	<div class="mobile-full-modal animate-pop border border-slate-200 dark:border-slate-700">
        	<div class="bg-primary p-3 text-white flex justify-between items-center shrink-0">
            	<h3 class="font-bold text-sm">طلب المنتج</h3>
            	<button onclick="toggleOrderModal()" class="hover:bg-white/20 p-1 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
        	</div>
        	<div class="flex-1 overflow-y-auto p-4 bg-white dark:bg-darkbg custom-scroll">
            	<div class="mb-4 p-2 bg-slate-50 dark:bg-slate-800 rounded-lg flex gap-3 items-center">
                	<img id="ord-img" src="" class="w-12 h-12 rounded object-cover">
                	<div>
                    	<h4 id="ord-title" class="font-bold text-xs text-navy dark:text-white"></h4>
                    	<span id="ord-price" class="text-primary font-black text-sm"></span>
                	</div>
            	</div>




            	<div id="order-items-container" class="space-y-3">
                	<!-- Items will be added here -->
            	</div>




            	<button onclick="addOrderItem()" class="w-full py-2 mt-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl text-slate-500 text-xs font-bold hover:border-primary hover:text-primary transition flex items-center justify-center gap-1">
                	<i data-lucide="plus" class="w-3 h-3"></i> إضافة قطعة أخرى
            	</button>




            	<div class="mt-6 space-y-3 border-t border-slate-100 dark:border-slate-700 pt-4">
                	<div class="grid grid-cols-2 gap-2">
                    	<div>
                        	<label class="form-label">المحافظة</label>
                        	<select id="ord-gov" onchange="updateOrderCities()" class="form-input text-xs"></select>
                    	</div>
                    	<div>
                        	<label class="form-label">المركز/المدينة</label>
                        	<select id="ord-city" class="form-input text-xs"><option value="">اختر المحافظة</option></select>
                    	</div>
                	</div>
                	<div>
                    	<label class="form-label">العنوان بالتفصيل</label>
                    	<input id="ord-address" type="text" class="form-input text-xs" placeholder="الشارع، رقم المنزل...">
                	</div>
                	<div>
                    	<label class="form-label">رقم الهاتف</label>
                    	<input id="ord-phone" type="tel" class="form-input text-xs" placeholder="01xxxxxxxxx">
                	</div>
            	</div>
        	</div>
        	<div class="p-3 border-t border-slate-100 dark:border-slate-700 bg-white dark:bg-darkbg shrink-0">
            	<div class="flex justify-between items-center mb-2">
                	<span class="text-xs font-bold text-slate-500">الإجمالي:</span>
                	<span id="ord-total" class="text-lg font-black text-primary">0 ج.م</span>
            	</div>
            	<button onclick="confirmOrder()" class="w-full bg-navy dark:bg-primary text-white py-3 rounded-xl font-bold text-sm shadow-lg">تأكيد الطلب عبر واتساب</button>
        	</div>
    	</div>
	</div>




	<!-- Add Modal -->
	<div id="add-modal" class="hidden modal-overlay">
    	<div class="mobile-full-modal animate-pop border border-slate-200 dark:border-slate-700">
        	<div class="p-3 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800 shrink-0 h-12">
            	<h3 class="font-bold text-slate-800 dark:text-white text-sm">إضافة منتج</h3>
            	<button onclick="toggleAddModal()" class="bg-white dark:bg-slate-700 p-1 rounded-full border border-slate-200 dark:border-slate-600 text-slate-500 dark:text-white hover:text-red-500"><i data-lucide="x" class="w-4 h-4"></i></button>
        	</div>




        	<div class="flex-1 overflow-y-auto p-3 space-y-2 bg-white dark:bg-darkbg custom-scroll">
            	<div class="form-group"><span class="form-label">الصور (max 7)</span><div class="grid grid-cols-4 gap-2"><label class="aspect-square border-2 border-dashed border-primary/40 bg-primary/5 dark:bg-primary/10 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:border-primary hover:bg-primary/10 transition text-primary relative overflow-hidden group"><input type="file" multiple accept="image/*" onchange="handleUpload(this)" class="absolute inset-0 opacity-0 z-10"><i data-lucide="camera" class="w-5 h-5 mb-1 group-hover:scale-110 transition"></i><span class="text-[9px] font-bold">إضافة</span></label><div id="preview-area" class="col-span-3 flex gap-2 overflow-x-auto no-scrollbar items-center"></div></div></div>




            	<div class="grid grid-cols-2 gap-2">
                	<div class="form-group"><label class="form-label">اسم المنتج</label><input id="in-title" class="form-input h-9 text-xs" placeholder="اسم المنتج..."></div>
                	<div class="form-group"><label class="form-label">السعر</label><input id="in-price" type="number" class="form-input h-9 text-xs" placeholder="0"></div>
            	</div>




            	<div class="grid grid-cols-2 gap-2">
                	<div class="form-group"><label class="form-label">القسم</label><select id="in-cat" onchange="updateFormFields()" class="form-input h-9 text-xs bg-gray-50"></select></div>
                	<div id="field-condition" class="form-group hidden"><label class="form-label">الحالة</label><select id="in-condition" class="form-input h-9 text-xs"><option value="new">جديد</option><option value="used">مستعمل</option><option value="openbox">كسر زيرو</option></select></div>
            	</div>




            	<div id="dynamic-fields" class="bg-slate-50 dark:bg-slate-800/50 p-2 rounded-lg border border-slate-100 dark:border-slate-700 form-group space-y-2 hidden">
                	<div id="field-size-chips" class="hidden">
                    	<label class="form-label text-primary">المقاسات المتاحة</label>
                    	<div id="size-chips-container" class="flex flex-wrap gap-1.5"></div>
                	</div>
                	<div id="field-color-chips" class="hidden">
                    	<label class="form-label text-primary">الألوان المتاحة</label>
                    	<div id="color-chips-container" class="flex flex-wrap gap-1.5"></div>
                	</div>
            	</div>




            	<div class="form-group bg-slate-50 dark:bg-slate-800/50 p-2 rounded-lg border border-slate-100 dark:border-slate-700">
                	<label class="form-label mb-1">أماكن الشحن</label>
                	<div class="flex gap-2 mb-2">
                    	<label class="flex-1 cursor-pointer"><input type="radio" name="ship-mode" value="all" onchange="toggleShipGov()" checked class="hidden peer"><div class="text-center py-1.5 rounded-lg border border-slate-300 dark:border-slate-600 text-[10px] font-bold text-slate-500 peer-checked:border-primary peer-checked:text-primary peer-checked:bg-white dark:peer-checked:bg-slate-700 transition">كل المحافظات</div></label>
                    	<label class="flex-1 cursor-pointer"><input type="radio" name="ship-mode" value="specific" onchange="toggleShipGov()" class="hidden peer"><div class="text-center py-1.5 rounded-lg border border-slate-300 dark:border-slate-600 text-[10px] font-bold text-slate-500 peer-checked:border-primary peer-checked:text-primary peer-checked:bg-white dark:peer-checked:bg-slate-700 transition">محافظات محددة</div></label>
                	</div>
                	<div id="ship-gov-container" class="hidden">
                    	<div class="text-[10px] mb-1 text-slate-400">اختر المحافظات المتاحة:</div>
                    	<div id="ship-gov-list" class="max-h-24 overflow-y-auto custom-scroll grid grid-cols-2 gap-1 p-1 bg-white dark:bg-darkbg border border-slate-200 dark:border-slate-600 rounded-lg">
                    	</div>
                	</div>
            	</div>




            	<div class="form-group"><label class="form-label">مواصفات إضافية:</label><div class="flex flex-wrap gap-1.5"><label class="cursor-pointer"><input type="checkbox" class="chip-checkbox hidden" value="أصلي"><div class="border border-slate-300 dark:border-slate-600 rounded-lg px-2 py-1 text-[10px] font-bold text-slate-500 dark:text-slate-400 transition hover:bg-slate-100">أصلي</div></label><label class="cursor-pointer"><input type="checkbox" class="chip-checkbox hidden" value="متوفر فاتورة"><div class="border border-slate-300 dark:border-slate-600 rounded-lg px-2 py-1 text-[10px] font-bold text-slate-500 dark:text-slate-400 transition hover:bg-slate-100">متوفر فاتورة</div></label><label class="cursor-pointer"><input type="checkbox" class="chip-checkbox hidden" value="ضمان"><div class="border border-slate-300 dark:border-slate-600 rounded-lg px-2 py-1 text-[10px] font-bold text-slate-500 dark:text-slate-400 transition hover:bg-slate-100">ضمان</div></label><label class="cursor-pointer"><input type="checkbox" class="chip-checkbox hidden" value="توصيل"><div class="border border-slate-300 dark:border-slate-600 rounded-lg px-2 py-1 text-[10px] font-bold text-slate-500 dark:text-slate-400 transition hover:bg-slate-100">توصيل</div></label></div></div>




            	<div class="form-group"><label class="form-label">تمييز:</label><div class="flex gap-2 p-1 bg-slate-100 dark:bg-slate-800 rounded-lg"><label class="flex-1 cursor-pointer text-center"><input type="radio" name="badge" value="none" checked class="hidden peer"><div class="text-center py-1 rounded-md text-[10px] font-bold text-slate-500 peer-checked:bg-white dark:peer-checked:bg-slate-700 peer-checked:shadow-sm peer-checked:text-navy dark:peer-checked:text-white transition">عادي</div></label><label class="flex-1 cursor-pointer text-center"><input type="radio" name="badge" value="hot" class="hidden peer"><div class="text-center py-1 rounded-md text-[10px] font-bold text-slate-500 peer-checked:bg-orange-500 peer-checked:text-white transition">🔥 عرض</div></label></div></div>




            	<div class="grid grid-cols-3 gap-2">
                	<div class="form-group col-span-1"><label class="form-label">رقم الهاتف</label><input id="in-phone" type="tel" class="form-input h-9 text-xs" placeholder="01xxxxxxxxx"></div>
                	<div class="form-group col-span-2"><label class="form-label">الوصف</label><textarea id="in-desc" rows="1" class="form-input text-xs" placeholder="تفاصيل..."></textarea></div>
            	</div>
        	</div>
        	<div class="p-3 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 shrink-0 pb-8 md:pb-3"><button onclick="submitListing()" id="btn-publish" class="w-full bg-navy dark:bg-primary text-white py-3 rounded-xl font-bold text-sm shadow-lg shadow-navy/20 hover:opacity-90 transition flex justify-center items-center gap-2"><span>نشر الآن</span><i data-lucide="arrow-left" class="w-4 h-4"></i></button></div>
    	</div>
	</div>




	<!-- Details Modal -->
	<div id="details-modal" class="hidden modal-overlay">
    	<div class="mobile-full-modal animate-pop border border-slate-200 dark:border-slate-700">
        	<div class="relative h-72 bg-gray-100 dark:bg-slate-800 shrink-0 group">
            	<button onclick="closeDetails()" class="absolute top-3 left-3 bg-white/80 dark:bg-black/50 text-slate-800 dark:text-white p-1.5 rounded-full z-20 shadow-sm"><i data-lucide="x" class="w-5 h-5"></i></button>
            	
           <div class="absolute top-3 right-3 flex gap-2 z-20">
                <div id="d-admin-controls" class="flex gap-2"></div>

                <button onclick="copyDetails()" class="bg-white/80 dark:bg-black/50 text-slate-800 dark:text-white p-1.5 rounded-full shadow-sm hover:bg-white hover:text-primary transition"><i data-lucide="copy" class="w-5 h-5"></i></button>
                <button onclick="shareListing()" class="bg-white/80 dark:bg-black/50 text-slate-800 dark:text-white p-1.5 rounded-full shadow-sm"><i data-lucide="share-2" class="w-5 h-5"></i></button>
            </div>
            	<div id="details-slider-container" class="w-full h-full flex items-center justify-center bg-gray-100 dark:bg-slate-800">
                	<img id="details-img" src="" class="w-full h-full object-cover cursor-pointer" onclick="openLightbox(this.src)">
            	</div>
            	<div id="details-arrows"><button onclick="scrollDetails(1)" class="absolute left-2 top-1/2 -translate-y-1/2 bg-black/30 text-white p-1 rounded-full z-10"><i data-lucide="chevron-left" class="w-5 h-5"></i></button><button onclick="scrollDetails(-1)" class="absolute right-2 top-1/2 -translate-y-1/2 bg-black/30 text-white p-1 rounded-full z-10"><i data-lucide="chevron-right" class="w-5 h-5"></i></button></div>
            	<div id="details-dots" class="absolute bottom-3 left-1/2 -translate-x-1/2 z-20 flex gap-1.5"></div>
        	</div>
        	<div class="flex-1 overflow-y-auto p-4 bg-white dark:bg-darkbg custom-scroll">
            	<!-- Req 5: Order Button -->
            	<button onclick="toggleOrderModal()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold text-sm shadow-lg mb-4 flex items-center justify-center gap-2 animate-pulse">
                	<i data-lucide="shopping-cart" class="w-5 h-5"></i> طلب المنتج
            	</button>




            	<div id="d-pub-bar" class="flex items-center justify-between mb-2 p-1.5 bg-slate-100 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 h-auto cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-700/80 transition">
                 	<div class="flex items-center gap-2">
                     	<div id="d-pub-img" class="w-7 h-7 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center overflow-hidden"><i data-lucide="user" class="w-3 h-3 text-slate-400"></i></div>
                     	<div class="flex flex-col justify-center">
                         	<h4 id="d-pub-name" class="font-bold text-[10px] text-navy dark:text-white leading-tight">...</h4>
                         	<span class="text-[8px] text-slate-400">اضغط لعرض حساب الناشر </span>
                     	</div>
                 	</div>
                 	<div id="d-shipping-info" class="flex flex-wrap items-center gap-1 text-[9px] font-bold text-slate-500 bg-white dark:bg-slate-700 px-1.5 py-0.5 rounded border border-slate-200 dark:border-slate-600 max-w-[55%] justify-end leading-tight"></div>
            	</div>




            	<div class="flex justify-between items-start mb-2 bg-slate-100 dark:bg-slate-800 p-2 rounded-lg"><h2 id="d-title" class="text-base font-bold text-slate-900 dark:text-white leading-snug w-3/4 select-text"></h2><span id="d-price" class="text-primary font-black text-lg whitespace-nowrap select-text"></span></div>
            	<div class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400 mb-3 pb-2 border-b border-slate-100 dark:border-slate-700">
                	<span id="d-cat" class="bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded text-[10px] border border-slate-200 dark:border-slate-700"></span> 
                	<span id="d-cond" class="bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded text-[10px] border border-slate-200 dark:border-slate-700 font-bold"></span>
                	<span id="d-date" class="text-[10px] text-black dark:text-white font-bold mr-auto"></span>
            	</div>




            	<div id="d-variants-container" class="space-y-2 mb-4">
                	<div id="d-sizes-row" class="hidden flex flex-wrap items-center gap-2 bg-slate-100 dark:bg-slate-800 p-2 rounded-lg">
                    	<span class="text-[10px] font-bold text-slate-400 shrink-0">المقاسات:</span>
                    	<div id="d-sizes-list" class="flex flex-wrap gap-1"></div>
                	</div>
                	<div id="d-colors-row" class="hidden flex flex-wrap items-center gap-2 bg-slate-100 dark:bg-slate-800 p-2 rounded-lg">
                    	<span class="text-[10px] font-bold text-slate-400 shrink-0">الألوان:</span>
                    	<div id="d-colors-list" class="flex flex-wrap gap-1"></div>
                	</div>
            	</div>




            	<div id="d-features" class="flex flex-wrap gap-2 mb-4"></div>




            	<div class="space-y-1 mb-6"><h3 class="text-xs font-bold text-slate-900 dark:text-slate-200 uppercase tracking-wider">الوصف</h3><p id="d-desc" class="text-xs text-slate-600 dark:text-slate-300 leading-relaxed whitespace-pre-wrap bg-slate-100 dark:bg-slate-800 p-3 rounded-xl border border-slate-200 dark:border-slate-700 font-medium select-text"></p></div>




            	<div class="border-t border-slate-100 dark:border-slate-700 pt-4">
                	<h3 class="text-xs font-bold text-slate-900 dark:text-white mb-3">التقييمات</h3>




                	<div id="product-reviews-list" class="space-y-3 mb-3"></div>
                	<div class="flex gap-2 mt-2">
                    	<button id="load-more-reviews" onclick="loadProductReviews(true)" class="hidden flex-1 text-center text-xs text-primary font-bold py-2 bg-slate-50 dark:bg-slate-800 rounded-lg">عرض المزيد</button>
                    	<button id="load-less-reviews" onclick="loadProductReviews(false, true)" class="hidden flex-1 text-center text-xs text-red-500 font-bold py-2 bg-slate-50 dark:bg-slate-800 rounded-lg">عرض أقل</button>
                	</div>




                	<div id="add-review-form" class="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border border-slate-100 dark:border-slate-700 mt-2">
                    	<div class="flex justify-between items-center mb-2">
                        	<span class="text-[10px] font-bold">أضف تقييمك</span>
                        	<div class="star-rating text-lg">
                            	<input type="radio" id="star5" name="rating" value="5" onclick="setRating(5)"><label for="star5">★</label>
                            	<input type="radio" id="star4" name="rating" value="4" onclick="setRating(4)"><label for="star4">★</label>
                            	<input type="radio" id="star3" name="rating" value="3" onclick="setRating(3)"><label for="star3">★</label>
                            	<input type="radio" id="star2" name="rating" value="2" onclick="setRating(2)"><label for="star2">★</label>
                            	<input type="radio" id="star1" name="rating" value="1" onclick="setRating(1)"><label for="star1">★</label>
                        	</div>
                    	</div>
                    	<textarea id="review-text" class="form-input text-xs w-full mb-2" rows="2" placeholder="اكتب رأيك هنا..."></textarea>
                    	<button onclick="submitProductReview()" class="bg-navy dark:bg-primary text-white px-3 py-1.5 rounded-lg text-xs font-bold w-full">نشر التقييم</button>
                	</div>
            	</div>
        	</div>
        	<div class="p-3 border-t border-slate-100 dark:border-slate-700 bg-white dark:bg-darkbg flex gap-2 shrink-0 pb-8 md:pb-3"><a id="d-wa" href="#" target="_blank" class="flex-1 bg-[#25D366] text-white py-2.5 rounded-xl flex justify-center items-center gap-2 font-bold shadow-lg hover:opacity-90 transition text-sm"><i data-lucide="message-circle" class="w-4 h-4"></i> واتساب</a><a id="d-call" href="#" class="flex-1 bg-navy dark:bg-primary text-white py-2.5 rounded-xl flex justify-center items-center gap-2 font-bold shadow-lg hover:opacity-90 transition text-sm"><i data-lucide="phone" class="w-4 h-4"></i> اتصال</a></div>
    	</div>
	</div>




	<!-- Chat Modal -->
	<div id="chat-modal" class="hidden modal-overlay">
    	<div class="mobile-full-modal animate-pop border border-slate-200 dark:border-slate-700">
        	<div class="bg-navy dark:bg-primary p-3 text-white flex justify-between items-center shrink-0">
            	<div class="flex items-center gap-2">
                	<div class="bg-white/10 p-1.5 rounded-full"><i data-lucide="bot" class="w-5 h-5 text-yellow-400"></i></div>
                	<div><h4 class="font-bold text-xs">الدعم الفني</h4></div>
            	</div>
            	<div class="flex items-center gap-2">
                	<a href="https://wa.me/201206244875" target="_blank" class="bg-[#25D366] px-2 py-1 rounded-full flex items-center gap-1 text-[10px] font-bold hover:opacity-90 transition">
                    	<i data-lucide="message-circle" class="w-3 h-3"></i> للتواصل مع الدعم عبر الواتساب 
                	</a>
                	<button onclick="toggleChat()" class="hover:bg-white/20 p-1 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            	</div>
        	</div>
        	<div id="chat-box" class="flex-1 bg-slate-100 dark:bg-slate-900 p-3 overflow-y-auto space-y-2 text-xs"></div>
        	<div class="p-2 bg-white dark:bg-slate-800 border-t dark:border-slate-700 flex items-center gap-2 shrink-0 pb-safe"><input id="chat-msg" type="text" class="flex-1 bg-slate-100 dark:bg-slate-700 border-0 rounded-full px-4 py-3 text-sm outline-none dark:text-white font-bold" placeholder="اكتب..."><button onclick="sendMsg()" class="w-8 h-8 bg-navy dark:bg-primary rounded-full text-white flex items-center justify-center shadow"><i data-lucide="send" class="w-4 h-4"></i></button></div>
    	</div>
	</div>




	<!-- Lightbox -->
	<div id="lightbox" class="hidden fixed inset-0 bg-black/95 z-[150] flex flex-col items-center justify-center select-none">
    	<button onclick="closeLightbox()" class="absolute top-4 left-4 bg-white/20 text-white p-2 rounded-full z-20"><i data-lucide="x" class="w-6 h-6"></i></button>
    	<button onclick="navigateLightbox(-1)" class="absolute left-2 md:left-10 top-1/2 -translate-y-1/2 bg-black/30 text-white p-2 rounded-full z-20 hover:bg-black/50 transition"><i data-lucide="chevron-left" class="w-8 h-8"></i></button>
    	<button onclick="navigateLightbox(1)" class="absolute right-2 md:right-10 top-1/2 -translate-y-1/2 bg-black/30 text-white p-2 rounded-full z-20 hover:bg-black/50 transition"><i data-lucide="chevron-right" class="w-8 h-8"></i></button>
    	<div class="relative w-full h-full flex items-center justify-center"><img id="lightbox-img" src="" class="max-w-full max-h-[80vh] object-contain"></div>
	</div>




	<!-- Admin Panel -->
	<div id="admin-panel" class="hidden fixed inset-0 bg-navy z-[130] flex flex-col text-white"><div class="p-3 border-b border-white/10 flex justify-between items-center bg-[#001a38]"><h2 class="font-bold flex items-center gap-2 text-sm"><i data-lucide="shield" class="w-4 h-4 text-primary"></i> التحكم</h2><div class="flex gap-3"><button onclick="refreshAdmin()"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button><button onclick="toggleAdminPanel()"><i data-lucide="x" class="w-5 h-5"></i></button></div></div><div class="flex-1 flex overflow-hidden"><div class="w-1/3 border-l border-white/10 bg-[#001f3f] overflow-y-auto p-2" id="admin-users-list"></div><div class="w-2/3 flex flex-col bg-navy relative"><div id="admin-chat-header" class="h-12 border-b border-white/10 flex items-center justify-between px-3 bg-[#001a38]"><span class="text-xs font-bold">اختر محادثة</span><button onclick="kickUser()" id="btn-end-chat" class="hidden bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded flex items-center gap-1"><i data-lucide="slash" class="w-3 h-3"></i> إنهاء</button></div><div id="admin-msg-area" class="flex-1 p-3 overflow-y-auto space-y-2 text-xs"></div><div class="p-2 border-t border-white/10 flex gap-2 bg-[#001a38]"><input id="admin-input" class="flex-1 bg-white/5 border border-white/20 rounded px-3 py-1.5 text-xs text-white outline-none" placeholder="الرد..."><button onclick="sendAdminMsg()" class="bg-primary px-4 py-1.5 rounded text-xs font-bold">إرسال</button></div></div></div></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    // 👇 التعديل الأول: ضفنا enableIndexedDbPersistence
    import { getFirestore, doc, setDoc, getDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp, getDocs, limit, orderBy, startAfter, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Req 4: Service Worker Registration (نسخة التخزين القوي v2)
    if ('serviceWorker' in navigator) {
        const swCode = `
            const CACHE_NAME = 'souq-v2'; // غيرنا الاسم عشان نحدث الكاش
            const ASSETS = [
                'https://cdn.tailwindcss.com',
                'https://unpkg.com/lucide@latest',
                'https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap'
            ];

            self.addEventListener('install', e => e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(ASSETS))));
            
            self.addEventListener('fetch', e => {
                const url = new URL(e.request.url);
                
                // استراتيجية: الكاش أولاً (للصور والملفات الثابتة)
                // ده اللي هيخلي الصور تظهر فوراً حتى لو النت ضعيف أو مقطوع
                if (e.request.destination === 'image' || e.request.destination === 'style' || e.request.destination === 'script' || e.request.destination === 'font') {
                    e.respondWith(
                        caches.match(e.request).then(cachedResponse => {
                            if (cachedResponse) return cachedResponse;
                            return fetch(e.request).then(networkResponse => {
                                return caches.open(CACHE_NAME).then(cache => {
                                    cache.put(e.request, networkResponse.clone());
                                    return networkResponse;
                                });
                            });
                        })
                    );
                } 
                // استراتيجية: الشبكة أولاً (لأي حاجة تانية زي البيانات الحية)
                else {
                    e.respondWith(fetch(e.request).catch(() => caches.match(e.request)));
                }
            });
        `;
        const blob = new Blob([swCode], {type: 'application/javascript'});
        navigator.serviceWorker.register(URL.createObjectURL(blob));
    }

    // PWA Install Logic
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        if(!localStorage.getItem('pwa_installed')) {
            document.getElementById('install-banner').classList.remove('hidden');
        }
    });

    window.installPWA = async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                localStorage.setItem('pwa_installed', 'true');
            }
            deferredPrompt = null;
            document.getElementById('install-banner').classList.add('hidden');
        }
    }

    window.closeInstall = () => {
        document.getElementById('install-banner').classList.add('hidden');
    }

    	const EGYPT_DATA = {
        	"القاهرة": ["مدينة نصر", "مصر الجديدة", "المعادي", "التجمع الخامس", "شبرا", "عين شمس", "المرج", "حلوان", "وسط البلد", "الزمالك", "المنيل", "العباسية", "الزيتون", "حدائق القبة", "السيدة زينب"],
        	"الجيزة": ["الهرم", "فيصل", "6 أكتوبر", "الشيخ زايد", "الدقي", "المهندسين", "العجوزة", "إمبابة", "الوراق", "بولاق الدكرور", "العمرانية", "المنيب", "البدرشين", "الحوامدية", "الصف", "أطفيح"],
        	"الإسكندرية": ["سموحة", "ميامي", "المنتزه", "سيدي بشر", "العصافرة", "المندرة", "فيكتوريا", "جليم", "ستانلي", "رشدي", "كفر عبده", "محرم بك", "العجمي", "البيطاش", "الهانوفيل", "برج العرب"],
        	"الدقهلية": ["المنصورة", "طلخا", "ميت غمر", "دكرنس", "شربين", "السنبلاوين", "أجا", "بلقاس", "منية النصر", "المطرية", "الجمالية", "بني عبيد"],
        	"الشرقية": ["الزقازيق", "العشر من رمضان", "منيا القمح", "بلبيس", "فاقوس", "أبو حماد", "الحسينية", "كفر صقر", "أبو كبير", "ديرب نجم", "مشتول السوق", "ههيا"],
        	"المنوفية": ["شبين الكوم", "مدينة السادات", "منوف", "أشمون", "قويسنا", "بركة السبع", "تلا", "الشهداء", "الباجور", "سرس الليان"],
        	"القليوبية": ["بنها", "شبرا الخيمة", "قليوب", "القناطر الخيرية", "الخانكة", "كفر شكر", "طوخ", "العبور", "شبين القناطر", "الخصوص"],
        	"البحيرة": ["دمنهور", "كفر الدوار", "إيتاي البارود", "أبو حمص", "كوم حمادة", "الدلنجات", "حوش عيسى", "رشيد", "إدكو", "المحمودية", "الرحمانية", "النوبارية"],
        	"الغربية": ["طنطا", "المحلة الكبرى", "كفر الزيات", "زفتى", "السنطة", "قطور", "بسيون", "سمنود"],
        	"بورسعيد": ["حي الشرق", "حي العرب", "حي المناخ", "حي الضواحي", "حي الجنوب", "حي الزهور", "بورفؤاد"],
        	"دمياط": ["دمياط", "رأس البر", "دمياط الجديدة", "فارسكور", "الزرقا", "كفر سعد", "الروضة", "السرو", "عزبة البرج", "ميت أبو غالب"],
        	"الإسماعيلية": ["الإسماعيلية", "القصاصين", "التل الكبير", "فايد", "القنطرة شرق", "القنطرة غرب", "أبو صوير"],
        	"السويس": ["حي السويس", "حي الأربعين", "حي عتاقة", "حي الجناين", "حي فيصل"],
        	"كفر الشيخ": ["كفر الشيخ", "دسوق", "فوه", "مطوبس", "بلطيم", "مصيف بلطيم", "الحامول", "بيلا", "الرياض", "سيدي سالم", "قلين"],
        	"الفيوم": ["الفيوم", "الفيوم الجديدة", "طامية", "سنورس", "إطسا", "إبشواي", "يوسف الصديق"],
        	"بني سويف": ["بني سويف", "بني سويف الجديدة", "الواسطى", "ناصر", "إهناسيا", "ببا", "الفشن", "سمسطا"],
        	"المنيا": ["المنيا", "المنيا الجديدة", "العدوة", "مغاغة", "بني مزار", "مطاي", "سمالوط", "أبو قرقاص", "ملوي", "دير مواس"],
        	"أسيوط": ["أسيوط", "أسيوط الجديدة", "ديروط", "القوصية", "أبنوب", "منفلوط", "أبو تيج", "الغنايم", "ساحل سليم", "البداري", "صدفا"],
        	"سوهاج": ["سوهاج", "سوهاج الجديدة", "أخميم", "أخميم الجديدة", "البلينا", "المراغة", "المنشأة", "دار السلام", "جرجا", "جهينة", "ساقلتة", "طما", "طهطا"],
        	"قنا": ["قنا", "قنا الجديدة", "أبو تشت", "نجع حمادي", "دشنا", "الوقف", "قفط", "قوص", "نقادة", "فرشوط"],
        	"الأقصر": ["الأقصر", "إسنا", "أرمنت", "القرنة", "البياضية", "الزينية", "الطود"],
        	"أسوان": ["أسوان", "أسوان الجديدة", "دراو", "كوم أمبو", "نصر النوبة", "إدفو"],
        	"البحر الأحمر": ["الغردقة", "رأس غارب", "سفاجا", "القصير", "مرسى علم", "شلاتين", "حلايب"],
        	"الوادي الجديد": ["الخارجة", "الداخلة", "الفرافرة", "باريس", "بلاط"],
        	"مطروح": ["مرسى مطروح", "الحمام", "العلمين", "الضبعة", "النجيلة", "سيدي براني", "السلوم", "سيوة"],
        	"شمال سيناء": ["العريش", "بئر العبد", "الشيخ زويد", "رفح", "الحسنة", "نخل"],
        	"جنوب سيناء": ["الطور", "شرم الشيخ", "دهب", "نويبع", "طابا", "سانت كاترين", "أبو رديس", "أبو زنيمة", "رأس سدر"]
    	};




    	const pwaManifest = {
        	"name": "السوق وياك",
        	"short_name": "السوق وياك",
        	"start_url": ".",
        	"display": "standalone",
        	"background_color": "#0f172a",
        	"theme_color": "#0f172a",
        	"orientation": "portrait",
        	"scope": "/",
        	"description": "متجر اكتروني عصري",
        	"icons": [
            	{
                	"src": "https://cdn-icons-png.flaticon.com/512/641/641813.png",
                	"sizes": "192x192",
                	"type": "image/png"
            	},
             	{
                	"src": "https://cdn-icons-png.flaticon.com/512/641/641813.png",
                	"sizes": "512x512",
                	"type": "image/png"
            	}
        	]
    	};
    	const stringManifest = JSON.stringify(pwaManifest);
    	const blob = new Blob([stringManifest], {type: 'application/json'});
    	const manifestURL = URL.createObjectURL(blob);
    	document.querySelector('#manifest-link').setAttribute('href', manifestURL);

    	const firebaseConfig = {
      	apiKey: "AIzaSyA5OiTcX95GBgiJoDHnY3y7N23o-j8hsQ8",
      	authDomain: "services-cef84.firebaseapp.com",
      	databaseURL: "https://services-cef84-default-rtdb.firebaseio.com",
      	projectId: "services-cef84",
      	storageBucket: "services-cef84.firebasestorage.app",
      	messagingSenderId: "902396219187",
      	appId: "1:902396219187:web:3ba084a724266afa8bb846"
    	};

    	const app = initializeApp(firebaseConfig); 
    	const db = getFirestore(app); 
    	const auth = getAuth(app);

        // 🔥 كود تفعيل الذاكرة (عشان الموقع يبقى طيارة)
        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') {
                console.log('Multiple tabs open, persistence can only be enabled in one tab at a a time.');
            } else if (err.code == 'unimplemented') {
                console.log('The current browser does not support all of the features required to enable persistence');
            }
        });


   	let state = { 
        	user: null, 
        	userData: null,
        	listings: [], 
        	images: [], 
        	chatId: null, 
        	chatStep: 0, 
        	tempName: '', 
        	activeAdminChat: null, 
        	isAdmin: false, 
        	welcomeSent: false, 
        	favorites: [], 
            
            // --- التعديل هنا: بنقرأ آخر مكان من الذاكرة ---
        	currentFilter: localStorage.getItem('last_filter') || 'all', 
        	currentView: localStorage.getItem('last_view') || 'home', 
            // -------------------------------------------

        	currentItem: null, 
        	lightboxImages: [], 
        	lightboxIndex: 0,
        	detailsSliderIndex: 0, 
        	detailsSliderImages: [],
        	authRole: 'customer',
        	authType: 'login',
        	authImageBase64: null,
        	userRole: 'customer',
        	currentRating: 0,
        	currentUserRating: 0,
        	productReviews: [],
        	productReviewsLimit: 1,
        	profileReviews: [],
        	profileReviewsLimit: 3,
        	viewingProfileId: null,
        	orderItems: [] // Req 7
    	};



    	function initGovs() {
        	const govSelect = document.getElementById('auth-gov');
        	const filterGov = document.getElementById('filter-gov');
        	const shipGovList = document.getElementById('ship-gov-list'); 
        	const editGov = document.getElementById('edit-gov'); 
        	const ordGov = document.getElementById('ord-gov'); // Req 7




        	govSelect.innerHTML = '<option value="">اختر المحافظة</option>';
        	filterGov.innerHTML = '<option value="">كل المحافظات</option>';
        	editGov.innerHTML = '<option value="">اختر المحافظة</option>';
        	ordGov.innerHTML = '<option value="">اختر المحافظة</option>';
        	shipGovList.innerHTML = '';




        	Object.keys(EGYPT_DATA).forEach(gov => {
            	govSelect.innerHTML += `<option value="${gov}">${gov}</option>`;
            	filterGov.innerHTML += `<option value="${gov}">${gov}</option>`;
            	editGov.innerHTML += `<option value="${gov}">${gov}</option>`;
            	ordGov.innerHTML += `<option value="${gov}">${gov}</option>`;
            	shipGovList.innerHTML += `
                	<label class="flex items-center gap-1 cursor-pointer hover:bg-slate-50 p-1 rounded">
                    	<input type="checkbox" name="ship-gov-check" value="${gov}" class="w-3 h-3 rounded border-gray-300 text-primary focus:ring-primary">
                    	<span class="text-[10px] font-bold text-slate-600">${gov}</span>
                	</label>
            	`;
        	});
    	}
    	initGovs();




    	window.updateCities = () => {
        	const gov = document.getElementById('auth-gov').value;
        	const citySelect = document.getElementById('auth-city');
        	citySelect.innerHTML = '<option value="">اختر المركز/المدينة</option>';
        	if(gov && EGYPT_DATA[gov]) {
            	EGYPT_DATA[gov].forEach(city => {
                	citySelect.innerHTML += `<option value="${city}">${city}</option>`;
            	});
        	}
    	}




    	window.updateEditCities = () => {
        	const gov = document.getElementById('edit-gov').value;
        	const citySelect = document.getElementById('edit-city');
        	citySelect.innerHTML = '<option value="">اختر المركز/المدينة</option>';
        	if(gov && EGYPT_DATA[gov]) {
            	EGYPT_DATA[gov].forEach(city => {
                	citySelect.innerHTML += `<option value="${city}">${city}</option>`;
            	});
        	}
    	}




    	// Req 3: Order Cities
    	window.updateOrderCities = () => {
        	const gov = document.getElementById('ord-gov').value;
        	const citySelect = document.getElementById('ord-city');
        	citySelect.innerHTML = '<option value="">اختر المركز/المدينة</option>';
        	if(gov && EGYPT_DATA[gov]) {
            	EGYPT_DATA[gov].forEach(city => {
                	citySelect.innerHTML += `<option value="${city}">${city}</option>`;
            	});
        	}
    	}
   	onAuthStateChanged(auth, async (u) => { 
        	if(u) { 
            	state.user = u;
            	try {
                	const userDoc = await getDoc(doc(db, "users", u.uid));
                	if (userDoc.exists()) {
                    	const data = userDoc.data();
                    	state.userData = data;
                    	state.userRole = data.role || 'customer';
                    	state.isAdmin = data.isAdmin === true;
                    	document.getElementById('header-username').innerText = data.name || u.displayName;
                    	document.getElementById('welcome-text').classList.remove('hidden');

                    	if(state.isAdmin) {
                        	document.getElementById('btn-admin-top').classList.remove('hidden');
                    	} else {
                         	document.getElementById('btn-admin-top').classList.add('hidden');
                    	}
                	}
            	} catch(e) {
                	console.warn("Role fetch failed", e);
            	}
            	
                // التبديل المباشر للشاشات (بديل forceSwitchToApp)
            	const loginView = document.getElementById('login-view');
            	loginView.classList.add('hidden');
            	loginView.style.setProperty('display', 'none', 'important');
            	document.getElementById('app-content').classList.remove('hidden');
                const loader = document.getElementById('loader');
                if(loader) loader.classList.add('hidden');

            	loadListings(); 
            	checkUserChat(); 
            	initFavs(); 
            	initCats(); 
        	} else {
            	state.user = null;
                
                // إظهار شاشة تسجيل الدخول مباشرة (بدون سبلاش سكرين)
            	const loginView = document.getElementById('login-view');
            	loginView.classList.remove('hidden');
            	loginView.style.removeProperty('display');
            	document.getElementById('app-content').classList.add('hidden');
        	}
    	});




    	window.setAuthRole = (role) => {
        	state.authRole = role;
        	const btnCust = document.getElementById('btn-role-customer');
        	const btnMark = document.getElementById('btn-role-marketer');
        	if (role === 'customer') {
            	btnCust.className = "flex-1 py-1.5 rounded-lg text-xs font-bold transition-all bg-navy dark:bg-primary text-white shadow-md";
            	btnMark.className = "flex-1 py-1.5 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:bg-white dark:hover:bg-slate-700";
        	} else {
            	btnMark.className = "flex-1 py-1.5 rounded-lg text-xs font-bold transition-all bg-navy dark:bg-primary text-white shadow-md";
            	btnCust.className = "flex-1 py-1.5 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:bg-white dark:hover:bg-slate-700";
        	}
    	}




    	window.setAuthType = (type) => {
        	state.authType = type;
        	const btnLogin = document.getElementById('btn-type-login');
        	const btnSignup = document.getElementById('btn-type-signup');
        	const actionBtn = document.getElementById('btn-auth-action');
        	const imgField = document.getElementById('auth-image-field');
        	const signupFields = document.getElementById('signup-fields');
        	const usernameLabel = document.getElementById('lbl-username');




        	if (type === 'login') {
            	btnLogin.className = "flex-1 py-1.5 rounded-lg text-xs font-bold transition-all bg-navy dark:bg-primary text-white shadow-md";
            	btnSignup.className = "flex-1 py-1.5 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:text-navy dark:hover:text-white";
            	actionBtn.innerHTML = `<span>دخول للحساب</span> <i data-lucide="arrow-left" class="w-4 h-4"></i>`;
            	imgField.classList.add('hidden');
            	imgField.classList.remove('flex');
            	signupFields.classList.add('hidden');
            	usernameLabel.innerText = "اسم المستخدم (إنجليزي)";
        	} else {
            	btnSignup.className = "flex-1 py-1.5 rounded-lg text-xs font-bold transition-all bg-navy dark:bg-primary text-white shadow-md";
            	btnLogin.className = "flex-1 py-1.5 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:text-navy dark:hover:text-white";
            	actionBtn.innerHTML = `<span>إنشاء حساب جديد</span> <i data-lucide="plus-circle" class="w-4 h-4"></i>`;
            	imgField.classList.remove('hidden');
            	imgField.classList.add('flex');
            	signupFields.classList.remove('hidden');
            	usernameLabel.innerText = "اسم المستخدم (إنجليزي)";
        	}
        	lucide.createIcons();
    	}




    	window.handleAuthImage = async (input) => {
        	if (input.files && input.files[0]) {
            	const c = await compress(input.files[0]);
            	state.authImageBase64 = c;
            	const preview = document.getElementById('auth-img-preview');
            	const placeholder = document.getElementById('auth-img-placeholder');
            	preview.src = c;
            	preview.classList.remove('hidden');
            	placeholder.classList.add('hidden');
        	}
    	}




    	window.processAuth = async () => {
        	const username = document.getElementById('auth-username').value.trim().toLowerCase();
        	const pass = document.getElementById('auth-pass').value;
        	const errDiv = document.getElementById('auth-error');
        	const btn = document.getElementById('btn-auth-action');




        	errDiv.classList.add('hidden');
        	errDiv.innerText = "";




        	if (!username || !pass) {
            	errDiv.innerText = "يرجى ملء اسم المستخدم وكلمة المرور";
            	errDiv.classList.remove('hidden');
            	return;
        	}




        	const usernameRegex = /^[a-z0-9_]+$/;
        	if (!usernameRegex.test(username)) {
            	errDiv.innerText = "اسم المستخدم يجب أن يكون حروف إنجليزية وأرقام فقط";
            	errDiv.classList.remove('hidden');
            	return;
        	}




        	if (pass.length < 6) {
            	errDiv.innerText = "كلمة المرور يجب أن تكون 6 أرقام/حروف على الأقل";
            	errDiv.classList.remove('hidden');
            	return;
        	}




        	const email = `${username}@souq.local`;
        	const originalBtnText = btn.innerHTML;
        	btn.disabled = true;
        	btn.innerHTML = `<div class="spinner"></div> جاري المعالجة...`;




        	try {
            	if (state.authType === 'signup') {
                	const nameAr = document.getElementById('auth-name-ar').value.trim();
                	const phone = document.getElementById('auth-phone').value.trim();
                	const gov = document.getElementById('auth-gov').value;
                	const city = document.getElementById('auth-city').value;
                	const address = document.getElementById('auth-address').value.trim();




                	if (!nameAr || !gov || !city || !address || !phone) {
                    	throw new Error("missing_fields");
                	}




                	const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                	const user = userCredential.user;




                	await updateProfile(user, { displayName: nameAr });




                	const newUser = {
                    	username: username,
                    	name: nameAr,
                    	phone: phone,
                    	email: email,
                    	role: state.authRole,
                    	governorate: gov,
                    	city: city,
                    	address: address,
                    	isAdmin: false,
                    	image: state.authImageBase64 || null, 
                    	createdAt: serverTimestamp()
                	};




                	await setDoc(doc(db, "users", user.uid), newUser);




                	state.userData = newUser;
                	state.userRole = state.authRole;
                	document.getElementById('header-username').innerText = nameAr;
                	document.getElementById('welcome-text').classList.remove('hidden');




            	} else {
                	await signInWithEmailAndPassword(auth, email, pass);
            	}




            	btn.innerHTML = `تم بنجاح <i data-lucide="check" class="w-4 h-4"></i>`;
            	btn.classList.replace('bg-navy', 'bg-green-600');


setTimeout(() => {
    // التبديل اليدوي
    document.getElementById('login-view').classList.add('hidden');
    document.getElementById('app-content').classList.remove('hidden');
    showToast(`أهلاً بك في السوق وياك 👋`, 's');
}, 500);


        	} catch (error) {
            	console.error("Auth Error:", error);
            	let msg = `حدث خطأ: ${error.code}`; 
            	if(error.message === "missing_fields") msg = "يرجى إكمال جميع البيانات";
            	else if(error.code === 'auth/email-already-in-use') msg = "اسم المستخدم هذا موجود بالفعل";
            	else if(error.code === 'auth/wrong-password') msg = "كلمة المرور غير صحيحة";
            	else if(error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') msg = "بيانات الدخول غير صحيحة";
            	errDiv.innerText = msg;
            	errDiv.classList.remove('hidden');
            	btn.disabled = false;
            	btn.innerHTML = originalBtnText;
            	lucide.createIcons();
        	}
    	}




    	window.logout = () => {
        	signOut(auth).then(() => {
            	window.location.reload();
        	});
    	}




    	const CATEGORIES = [
        	"ملابس رجالي", "ملابس حريمي", "ملابس اطفال", "احذية رجالي", "احذية حريمي", "احذية اطفال", 
        	"اكسسورات رجالي", "اكسسورات حريمي", "اكسسورات اطفال", "برفانات رجالي وحريمي", "الحقائب الشخصية",
        	"النظارات", "مستحضرات التجميل", "ادوات حلاقة للرجال", "مكملات غذائية", "ادوات رياضية",
        	"الهدايا الشخصية", "الهدايا والالعاب", "منتجات العناية بالبشرة", "منتجات الاطفال", "اقمشة"
    	];




    	const USED_CATS = ["النظارات", "اكسسورات رجالي", "اكسسورات حريمي", "اكسسورات اطفال"];
    	const CLOTHES_CATS = ["ملابس رجالي", "ملابس حريمي", "ملابس اطفال", "اقمشة"];
    	const SHOES_CATS = ["احذية رجالي", "احذية حريمي", "احذية اطفال"];




    	const SIZES_MEN = ["S", "M", "L", "XL", "2XL", "3XL", "4XL", "FreeSize"];
    	const SIZES_WOMEN = ["XS", "S", "M", "L", "XL", "2XL", "FreeSize"];
    	const SIZES_KIDS = ["1y", "2y", "4y", "6y", "8y", "10y", "12y", "14y", "16y"];
    	const SIZES_SHOES_ADULT = ["37", "38", "39", "40", "41", "42", "43", "44", "45"];
    	const SIZES_SHOES_KIDS = ["20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35"];




    	const BASIC_COLORS = ["أبيض", "أسود", "رمادي", "كحلي", "أحمر", "أزرق", "بيج", "أخضر", "أصفر", "بني"];




     	const CATEGORY_IMAGES = {
        	"ملابس رجالي": "https://images.unsplash.com/photo-1617137968427-85924c800a22?q=80&w=300&auto=format&fit=crop",
        	"برفانات رجالي وحريمي": "https://images.unsplash.com/photo-1541643600914-78b084683601?q=80&w=300&auto=format&fit=crop",
        	"النظارات": "https://images.unsplash.com/photo-1572635196237-14b3f281503f?q=80&w=300&auto=format&fit=crop",
        	"مستحضرات التجميل": "https://images.unsplash.com/photo-1596462502278-27bfdc403348?q=80&w=300&auto=format&fit=crop",
        	"ادوات حلاقة للرجال": "https://images.unsplash.com/photo-1621607512214-68297480165e?q=80&w=300&auto=format&fit=crop",
        	"مكملات غذائية": "https://images.unsplash.com/photo-1581009137042-c552e485697a?q=80&w=300&auto=format&fit=crop",
        	"احذية حريمي": "https://images.unsplash.com/photo-1549298916-b41d501d3772?q=80&w=300&auto=format&fit=crop",
        	"ادوات رياضية": "https://images.unsplash.com/photo-1517836357463-d25dfeac3438?q=80&w=300&auto=format&fit=crop",
        	"ملابس حريمي": "https://images.pexels.com/photos/3772506/pexels-photo-3772506.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
        	"احذية رجالي": "https://images.pexels.com/photos/5264901/pexels-photo-5264901.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
        	"احذية اطفال": "https://images.pexels.com/photos/29737094/pexels-photo-29737094.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
        	"ملابس اطفال": "https://images.pexels.com/photos/1620758/pexels-photo-1620758.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
        	"اكسسورات رجالي": "https://images.pexels.com/photos/3766112/pexels-photo-3766112.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
        	"اكسسورات حريمي": "https://images.pexels.com/photos/17568000/pexels-photo-17568000.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
        	"اكسسورات اطفال": "https://images.pexels.com/photos/2848522/pexels-photo-2848522.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
        	"الحقائب الشخصية": "https://images.pexels.com/photos/1986996/pexels-photo-1986996.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
        	"الهدايا الشخصية": "https://images.pexels.com/photos/19066549/pexels-photo-19066549.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
        	"الهدايا والالعاب": "https://images.pexels.com/photos/4491662/pexels-photo-4491662.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
        	"منتجات العناية بالبشرة": "https://images.pexels.com/photos/10117729/pexels-photo-10117729.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
        	"منتجات الاطفال": "https://images.pexels.com/photos/26337029/pexels-photo-26337029.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
        	"اقمشة": "https://images.pexels.com/photos/34636582/pexels-photo-34636582.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop"
    	};




    	function preloadCategoryImages() {
        	Object.values(CATEGORY_IMAGES).forEach(url => {
            	const img = new Image();
            	img.src = url;
        	});
    	}
    	preloadCategoryImages();




    	function initCats() {
        	const cont = document.getElementById('categories-container');
        	cont.innerHTML = `<button onclick="filter('all')" id="chip-all" class="chip-btn">الكل</button>`;
        	const sel = document.getElementById('in-cat');
        	sel.innerHTML = '';
        	CATEGORIES.forEach(c => {
            	const btn = document.createElement('button'); 
            	btn.innerText = c; 
            	btn.id = `chip-${c.replace(/\s/g, '')}`;
            	btn.className = "px-4 py-1.5 rounded-full bg-white dark:bg-darkbg border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-300 text-xs font-bold whitespace-nowrap transition hover:border-primary hover:text-primary chip-btn";
            	btn.onclick = () => filter(c); 
            	cont.appendChild(btn);
            	const opt = document.createElement('option'); 
            	opt.value = c; 
            	opt.innerText = c; 
            	sel.appendChild(opt);
        	});
    	}

function renderView() {
    // حفظ الحالة في الذاكرة
    localStorage.setItem('last_view', state.currentView);
    localStorage.setItem('last_filter', state.currentFilter);

    // تعريف العناصر
    const searchInput = document.getElementById('search-input');
    const catContainer = document.getElementById('categories-container');
    const searchContainer = document.getElementById('search-container');
    const viewHeader = document.getElementById('view-header');
    const filterBtn = document.getElementById('btn-filter-toggle');
    const filterPanel = document.getElementById('filter-panel');
    
    // تعريف الحاويات
    const homeGrid = document.getElementById('home-grid');
    const prodGrid = document.getElementById('grid-container');
    
    // 👇 (1) تعريف عنصر الحالة الفارغة
    const emptyState = document.getElementById('empty-state'); 

    // إغلاق بانل الفلتر دائماً عند التنقل
    filterPanel.classList.add('hidden');

    if (state.currentView === 'home') {
        // === وضع الصفحة الرئيسية ===
        
        // التعامل مع الحاويات
        if(homeGrid) homeGrid.classList.remove('hidden'); 
        prodGrid.classList.add('hidden');
        
        // 👇 (2) إخفاء رسالة "لا توجد نتائج" إجبارياً عند العودة للرئيسية
        if(emptyState) emptyState.classList.add('hidden'); 

        // إخفاء عناصر الهيدر غير المطلوبة
        viewHeader.classList.add('hidden');
        catContainer.classList.add('hidden');
        filterBtn.classList.add('hidden'); 
        
        // إعداد البحث
        searchContainer.classList.remove('hidden');
        searchInput.placeholder = 'ابحث عن قسم...';

    } else if (state.currentView === 'category') {
        // === وضع عرض المنتجات ===

        if(homeGrid) homeGrid.classList.add('hidden');
        prodGrid.classList.remove('hidden');

        viewHeader.classList.remove('hidden');
        const title = state.currentFilter === 'all' ? 'كل المنتجات' : (state.currentFilter === 'fav' ? 'المفضلة' : state.currentFilter);
        document.getElementById('view-title').innerText = title;

        if (state.currentFilter === 'fav') {
            searchContainer.classList.add('hidden');
            catContainer.classList.add('hidden');
        } else {
            searchContainer.classList.remove('hidden');
            filterBtn.classList.remove('hidden'); 
            searchInput.placeholder = 'ابحث عن منتج...';
            
            if (state.currentFilter === 'all') {
                catContainer.classList.remove('hidden');
            } else {
                catContainer.classList.add('hidden');
            }
        }

        prodGrid.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 pb-10';
        filter(state.currentFilter);
    }
    
    lucide.createIcons();

}

    	window.applyFilters = () => {
        	renderProducts();
    	}

    // 👇 تم إضافة دالة فتح وإغلاق لوحة الفلترة هنا
    window.toggleFilterPanel = () => {
        document.getElementById('filter-panel').classList.toggle('hidden');
    }

   // Fix 5: Reset Button Logic (تم التعديل)
    window.resetFilters = () => {
        // 1. تفريغ خانات البحث والفلتر
        document.getElementById('search-input').value = '';
        document.getElementById('filter-price').value = '';
        document.getElementById('filter-gov').value = '';

        // 2. التحقق من الصفحة الحالية
        if (state.currentView === 'home') {
            // لو إنت في الرئيسية، أظهر بطاقات الأقسام تاني
            renderCategoryCards();
        } else {
            // لو إنت جوه قسم أو بتعرض منتجات، عيد تحميل المنتجات في نفس مكانك
            renderProducts();
        }
    };
 
    	window.switchToCategoryView = (category) => {
        	state.currentView = 'category';
        	state.currentFilter = category;
        	document.getElementById('search-input').value = '';
        	window.scrollTo({ top: 0, behavior: 'smooth' });
        	renderView();
    	}




    	window.switchToHomeView = () => {
        	state.currentView = 'home';
        	state.currentFilter = 'all';
        	document.getElementById('search-input').value = '';
        	window.scrollTo({ top: 0, behavior: 'smooth' });
        	renderView();
        	const url = new URL(window.location);
        	url.searchParams.delete('product_id');
        	window.history.replaceState({}, '', url);
    	}

function renderCategoryCards() {
    // 👇 التعديل الأول: نستهدف الديف الجديد المخصص للأقسام
    const cont = document.getElementById('home-grid'); 
    
    const q = normalizeText(document.getElementById('search-input').value);
    
    // 👇 التعديل الثاني: التحقق من وجود العنصر لتجنب الأخطاء
    if (!cont) return;

    cont.innerHTML = '';
    const filteredCats = CATEGORIES.filter(c => normalizeText(c).includes(q));

    if (!filteredCats.length) {
        document.getElementById('empty-state').classList.remove('hidden');
    } else {
        document.getElementById('empty-state').classList.add('hidden');
        
        // بناء الكروت (نفس الكود القديم ولكن داخل الحاوية الجديدة)
        // استخدام map و join أسرع للأداء من innerHTML +=
        cont.innerHTML = filteredCats.map(cat => {
            const imageUrl = CATEGORY_IMAGES[cat] || 'https://images.unsplash.com/photo-1523275335684-37898b6baf30?q=80&w=300&auto=format&fit=crop';
            return `
                <div onclick="switchToCategoryView('${cat}')" class="relative rounded-xl overflow-hidden shadow-sm border-2 border-black dark:border-slate-700 h-28 cursor-pointer active:scale-95 transition-transform group flex items-center justify-center text-center p-2">
                    <img src="${imageUrl}" class="absolute inset-0 w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" loading="lazy">
                    <div class="absolute inset-0 bg-black/50"></div>
                    <h3 class="relative z-10 font-bold text-white text-sm drop-shadow-md">${cat}</h3>
                </div>`;
        }).join('');
    }
}

// 👇 هام جداً: استدعاء الدالة مرة واحدة عند تشغيل الموقع لرسم الأقسام
// ضع هذا السطر في نهاية ملف السكريبت أو بعد تعريف الدالة مباشرة
renderCategoryCards();



    	function loadListings() { 
        	showSkeletons(); 
        	onSnapshot(query(collection(db, "listings")), (snap) => { 
            	state.listings = []; 
            	snap.forEach(d => state.listings.push({id: d.id, ...d.data()})); 
            	state.listings.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); 




            	const params = new URLSearchParams(window.location.search);
            	const linkedProdId = params.get('product_id');
            	if(linkedProdId && !state.currentItem) {
               	const item = state.listings.find(i => i.id === linkedProdId);
               	if(item) openDetails(item.id);
            	}
            	renderView();
        	}); 
    	}




    	window.handleSearch = () => {
        	if (state.currentView === 'home') {
            	renderCategoryCards();
        	} else {
            	renderProducts();
        	}
    	};




    	window.filter = (type) => { 
        	state.currentFilter = type; 
        	document.querySelectorAll('#categories-container .chip-btn').forEach(btn => {
            	btn.className = "px-4 py-1.5 rounded-full bg-white dark:bg-darkbg border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-300 text-xs font-bold whitespace-nowrap transition hover:border-primary hover:text-primary chip-btn";
        	});
        	const activeId = type === 'all' ? 'chip-all' : `chip-${type.replace(/\s/g, '')}`;
        	const activeBtn = document.getElementById(activeId);
        	if(activeBtn) {
            	activeBtn.className = "px-5 py-1.5 rounded-full bg-navy dark:bg-primary text-white text-xs font-bold shadow whitespace-nowrap transform scale-105 transition chip-btn";
            	activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        	}
        	if (state.currentView !== 'category') {
            	state.currentView = 'category';
        	}
        	const title = type === 'all' ? 'كل المنتجات' : (type === 'fav' ? 'المفضلة' : type);
        	document.getElementById('view-title').innerText = title;
        	renderProducts(); 
    	};

   function renderProducts() {
        const q = normalizeText(document.getElementById('search-input').value);
        const priceFilter = document.getElementById('filter-price').value;
        const govFilter = document.getElementById('filter-gov').value;

        const cont = document.getElementById('grid-container'); 
        
        // 1. التصفية (Filtering)
        let filtered = state.listings.filter(item => { 
            let matchType = true; 
            if (state.currentFilter === 'fav') {
                matchType = (state.favorites || []).includes(item.id);
            } else {
                matchType = state.currentFilter === 'all' || item.category === state.currentFilter; 
            }
            
            const matchText = normalizeText(item.title).includes(q) || normalizeText(item.category || '').includes(q); 
            
            let matchGov = true;
            if(govFilter && item.governorate) {
                matchGov = item.governorate === govFilter;
            }

            return matchType && matchText && matchGov; 
        }); 

        // 2. الترتيب (Sorting)
        if (priceFilter === 'low') {
            filtered.sort((a, b) => a.price - b.price);
        } else if (priceFilter === 'high') {
            filtered.sort((a, b) => b.price - a.price);
        }

        // 3. الرسم (Rendering) - التحسين الكبير هنا 🚀
        if(!filtered.length) {
            cont.innerHTML = ''; 
            document.getElementById('empty-state').classList.remove('hidden'); 
        } else { 
            document.getElementById('empty-state').classList.add('hidden'); 
            
            // استخدام map و join أسرع بكتير من forEach و innerHTML+=
            // ده بيخلي المتصفح يرسم الصفحة مرة واحدة بس بدل ما يرسمها مع كل منتج
            const cardsHTML = filtered.map(item => createCard(item)).join('');
            cont.innerHTML = cardsHTML;
        } 
        
        lucide.createIcons(); 
    }

    // دالة تنسيق التاريخ (سيبها زي ما هي)
    function formatDate(timestamp) {
        if (!timestamp) return '';
        const date = timestamp.toDate();
        const now = new Date();
        const diff = Math.floor((now - date) / 1000); // seconds

        if (diff < 60) return 'منذ لحظات';
        if (diff < 3600) return `منذ ${Math.floor(diff / 60)} دقيقة`;
        if (diff < 86400) return `منذ ${Math.floor(diff / 3600)} ساعة`;
        if (diff < 604800) return `منذ ${Math.floor(diff / 86400)} يوم`;
        return date.toLocaleDateString('ar-EG');
    }



       function createCard(item) {
        const imgs = Array.isArray(item.images) ? item.images : [item.image];
        const isFav = (state.favorites || []).includes(item.id);
        const heartClass = isFav ? "fill-red-500 text-red-500" : "text-white";
        
        // التعديل هنا: غيرنا left-1 إلى right-1
        let badge = item.badge === 'hot' ? `<span class="absolute top-1 right-1 bg-orange-500 text-white text-[9px] font-bold px-2 py-0.5 rounded shadow animate-pulse z-10">🔥 عرض</span>` : '';
        
        let statusOverlay = ''; 
        let isClickable = true; 
        
        if(item.status && item.status !== 'available') { 
            const txt = item.status === 'sold' ? 'تم البيع' : 'غير متاح'; 
            statusOverlay = `<div class="absolute inset-0 z-20 bg-white/80 dark:bg-black/80 backdrop-blur-sm flex items-center justify-center"><span class="bg-red-600 text-white font-bold px-4 py-2 rounded-xl shadow-xl transform -rotate-12 text-sm">${txt}</span></div>`; 
        }

        return `<div class="bg-white dark:bg-slate-800 rounded-lg overflow-hidden shadow-sm border-2 border-black dark:border-slate-700 flex flex-col h-full cursor-pointer active:scale-95 transition-transform group relative" onclick="${isClickable ? `openDetails('${item.id}')` : ''}"><div class="relative w-full h-28 sm:h-36 bg-gray-200 dark:bg-slate-700">${statusOverlay} ${!statusOverlay ? badge : ''}<button onclick="toggleFav(event, '${item.id}')" class="absolute top-1 left-1 z-20 p-1.5 rounded-full bg-black/20 hover:bg-black/40"><i data-lucide="heart" class="w-3.5 h-3.5 ${heartClass}"></i></button><span class="absolute bottom-1 left-1 bg-white/80 text-black text-[8px] font-bold px-1 rounded z-10">${formatDate(item.createdAt)}</span>${imgs.length > 1 ? `<button onclick="scrollCard(event, '${item.id}', -1)" class="absolute right-1 top-1/2 -translate-y-1/2 bg-black/20 hover:bg-black/40 text-white p-1 rounded-full z-10 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="chevron-right" class="w-3 h-3"></i></button><button onclick="scrollCard(event, '${item.id}', 1)" class="absolute left-1 top-1/2 -translate-y-1/2 bg-black/20 hover:bg-black/40 text-white p-1 rounded-full z-10 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="chevron-left" class="w-3 h-3"></i></button>` : ''}<div id="slider-${item.id}" class="flex w-full h-full overflow-x-auto no-scrollbar snap-x snap-mandatory scroll-smooth">${imgs.map(src => `<img src="${src}" class="w-full h-full object-cover shrink-0 snap-center ${statusOverlay?'grayscale':''}" loading="lazy">`).join('')}</div><span class="absolute bottom-1 right-1 bg-white/90 dark:bg-black/60 text-slate-800 dark:text-white px-1.5 py-0.5 rounded text-[8px] font-bold shadow z-10">${item.category}</span></div><div class="p-1.5 flex-1 flex flex-col"><div class="flex justify-between items-start mb-0.5"><h3 class="font-bold text-slate-900 dark:text-white text-[10px] line-clamp-1">${item.title}</h3><span class="font-black text-primary text-[10px] whitespace-nowrap">${Number(item.price).toLocaleString()} ج.م</span></div><div class="text-[8px] text-slate-500 dark:text-slate-400 mb-1 flex gap-1 items-center"><span class="bg-slate-100 dark:bg-white/5 px-1 rounded">${item.condition==='new'?'جديد':(item.condition==='openbox'?'كسر زيرو':'مستعمل')}</span></div><div class="mt-auto flex gap-1 pt-1 border-t border-slate-100 dark:border-slate-700"><a href="https://wa.me/20${item.phone}" target="_blank" onclick="event.stopPropagation()" class="flex-1 bg-primary text-white py-1 rounded flex justify-center items-center gap-1 text-[9px] font-bold"><i data-lucide="message-circle" class="w-3 h-3"></i> واتس</a></div></div></div>`;
    }


    	function goToDetailsSlide(index, behavior = 'auto') {
        	const total = state.detailsSliderImages.length;
        	if (total === 0) return;
        	if (index < 0) index = total - 1;
        	if (index >= total) index = 0;
        	state.detailsSliderIndex = index;
        	const imgEl = document.getElementById('details-img');
        	if (imgEl) {
            	imgEl.src = state.detailsSliderImages[state.detailsSliderIndex];
        	}
        	updateSliderDots();
    	}




    	window.scrollDetails = (dir) => { 
        	const total = state.detailsSliderImages.length;
        	if (total <= 1) return;
        	let dirAmount = -dir;
        	let newIndex = state.detailsSliderIndex + dirAmount;
        	goToDetailsSlide(newIndex);
    	}




    	function updateSliderDots() {
        	if (state.detailsSliderImages.length <= 1) return;
        	for (let i = 0; i < state.detailsSliderImages.length; i++) {
            	const dot = document.getElementById(`dot-${i}`);
            	if (dot) {
                	dot.className = i === state.detailsSliderIndex 
                    	? 'w-4 h-2 rounded-full bg-white shadow transition-all' 
                    	: 'w-2 h-2 rounded-full bg-white/40 transition-all';
            	}
        	}
    	}




    	window.copyDetails = () => {
        	if(!state.currentItem) return;




        	const text = `المنتج: ${state.currentItem.title}\nالسعر: ${Number(state.currentItem.price).toLocaleString()} ج.م\nالوصف: ${state.currentItem.desc}\nللتواصل: ${state.currentItem.phone}`;




        	navigator.clipboard.writeText(text).then(() => {
            	showToast('تم نسخ التفاصيل بنجاح ✅');
        	}).catch(err => {
            	showToast('فشل النسخ', 'e');
        	});
    	}
   window.openDetails = (id) => {
        // 1. العثور على المنتج فوراً
        const item = state.listings.find(i => i.id === id); 
        if(!item) return;
        state.currentItem = item; 

        // 2. تحديث البيانات الأساسية (تظهر فوراً)
        document.getElementById('d-title').innerText = item.title; 
        document.getElementById('d-price').innerText = Number(item.price).toLocaleString() + ' ج.م'; 
        document.getElementById('d-cat').innerText = item.category; 
        document.getElementById('d-desc').innerText = item.desc;
        document.getElementById('d-cond').innerText = item.condition === 'new' ? 'جديد' : (item.condition === 'openbox' ? 'كسر زيرو' : 'مستعمل');
        document.getElementById('d-date').innerText = formatDate(item.createdAt);

        // --- (إضافة جديدة) إظهار أزرار التحكم داخل الصفحة ---
        const adminControls = document.getElementById('d-admin-controls');
        if(adminControls) {
            adminControls.innerHTML = ''; // تنظيف الأزرار القديمة
            const isOwner = state.user && state.user.uid === item.authorId;
            
            if (state.isAdmin || isOwner) {
                adminControls.innerHTML = `
                    <button onclick="del(null, '${item.id}')" class="bg-white/80 dark:bg-black/50 text-red-500 p-1.5 rounded-full shadow-sm hover:bg-white transition"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                    <button onclick="toggleStatus(event, '${item.id}', '${item.status || 'available'}')" class="bg-white/80 dark:bg-black/50 text-blue-500 p-1.5 rounded-full shadow-sm hover:bg-white transition"><i data-lucide="edit-3" class="w-5 h-5"></i></button>
                `;
            }
        }
        // ---------------------------------------------------

        // 3. وضع "جاري التحميل" لبيانات البائع مؤقتاً
        const pubName = document.getElementById('d-pub-name');
        const pubImg = document.getElementById('d-pub-img');
        pubName.innerText = "جاري التحميل...";
        pubImg.innerHTML = `<div class="animate-pulse bg-slate-300 w-full h-full"></div>`; // Skeleton loader
        
        // تجهيز زر البروفايل
        document.getElementById('d-pub-bar').onclick = () => toggleProfile(item.authorId);

        // 4. معالجة المميزات والألوان والمقاسات
        const amCont = document.getElementById('d-features'); 
        amCont.innerHTML=''; 
        const sizeRow = document.getElementById('d-sizes-row');
        const sizeList = document.getElementById('d-sizes-list');
        const colorRow = document.getElementById('d-colors-row');
        const colorList = document.getElementById('d-colors-list');

        sizeRow.classList.add('hidden');
        colorRow.classList.add('hidden');
        sizeList.innerHTML = '';
        colorList.innerHTML = '';

        if(item.size && Array.isArray(item.size) && item.size.length > 0) {
             sizeRow.classList.remove('hidden');
             item.size.forEach(s => {
                 sizeList.innerHTML += `<span class="bg-white dark:bg-slate-700 text-slate-700 dark:text-white px-2 py-1 rounded-md text-[10px] font-bold border border-slate-200 dark:border-slate-600 shadow-sm min-w-[30px] text-center">${s}</span>`;
             });
        }

        if(item.color && Array.isArray(item.color) && item.color.length > 0) {
             colorRow.classList.remove('hidden');
             item.color.forEach(c => {
                 colorList.innerHTML += `<span class="bg-white dark:bg-slate-700 text-slate-700 dark:text-white px-2 py-1 rounded-md text-[10px] font-bold border border-slate-200 dark:border-slate-600 shadow-sm">${c}</span>`;
             });
        }

        if(item.features) item.features.forEach(a => amCont.innerHTML += `<span class="bg-slate-100 dark:bg-slate-700 dark:text-white px-2 py-1 rounded text-xs flex items-center gap-1 border border-slate-200 dark:border-slate-600 font-bold">${a}</span>`);

        // 5. معلومات الشحن والاتصال
        const shipInfo = document.getElementById('d-shipping-info');
        if(item.shippingMode === 'specific' && item.shippingGov) {
             let govText = Array.isArray(item.shippingGov) ? item.shippingGov.join('، ') : item.shippingGov;
             shipInfo.innerHTML = `<i data-lucide="truck" class="w-3 h-3 shrink-0"></i> <span class="whitespace-normal leading-tight text-right">الشحن متاح لـ: ${govText}</span>`;
        } else {
            shipInfo.innerHTML = `<i data-lucide="truck" class="w-3 h-3 shrink-0"></i> شحن لكل المحافظات`;
        }

        document.getElementById('d-wa').href = `https://wa.me/20${item.phone}?text=استفسار بخصوص: ${item.title}`; 
        document.getElementById('d-call').href = `tel:${item.phone}`;

        // 6. إعداد الصور والسلايدر
        const imgs = Array.isArray(item.images) ? item.images : [item.image]; 
        state.detailsSliderImages = imgs; 
        state.detailsSliderIndex = 0;   

        const dotsContainer = document.getElementById('details-dots');
        const imgEl = document.getElementById('details-img');
        if (imgEl) {
            imgEl.src = imgs.length > 0 ? imgs[0] : 'https://placehold.co/400x300/e2e8f0/94a3b8?text=No+Image';
            imgEl.onclick = () => openLightbox(imgEl.src); 
        }

        dotsContainer.innerHTML = ''; 
        if (imgs.length > 1) {
            dotsContainer.innerHTML = imgs.map((_, index) => 
                `<span id="dot-${index}" class="w-2 h-2 rounded-full bg-white/40 transition-all"></span>`
            ).join('');
        }
        document.getElementById('details-arrows').style.display = imgs.length > 1 ? 'block' : 'none';

        // 7. فتح المودال فورااااً
        toggleModal('details-modal'); 
        goToDetailsSlide(0, 'auto'); 
        
        // تحديث الرابط
        const url = new URL(window.location);
        url.searchParams.set('product_id', id);
        window.history.replaceState({}, '', url);

        // 8. جلب بيانات البائع والتقييمات في الخلفية (Lazy Loading)
        (async () => {
            try {
                // جلب بيانات البائع
                const uSnap = await getDoc(doc(db, "users", item.authorId));
                if(uSnap.exists()) {
                    const uData = uSnap.data();
                    state.currentAuthor = uData;
                    // تحديث الواجهة لما البيانات توصل
                    if(document.getElementById('details-modal').classList.contains('hidden')) return; // لو قفل المودال قبل ما تخلص
                    
                    pubName.innerText = uData.name || "مستخدم";
                    if(uData.image) {
                        pubImg.innerHTML = `<img src="${uData.image}" class="w-full h-full object-cover">`;
                    } else {
                        pubImg.innerHTML = `<i data-lucide="user" class="w-4 h-4 text-slate-400"></i>`;
                        lucide.createIcons();
                    }
                } else {
                    pubName.innerText = "مستخدم غير معروف";
                    state.currentAuthor = null;
                }
            } catch(e) {
                pubName.innerText = "ناشر";
                state.currentAuthor = null;
            }
            
            // جلب التقييمات
            state.productReviewsLimit = 1;
            loadProductReviews(false);
            lucide.createIcons(); // لتحديث أيقونات التحكم
        })();
        
        lucide.createIcons(); // للأيقونات الأساسية فور الفتح
    }

    	window.closeDetails = () => {
         	toggleModal('details-modal');
         	state.currentItem = null; 
         	document.getElementById('details-dots').innerHTML = ''; 
         	const imgEl = document.getElementById('details-img');
         	if (imgEl) { imgEl.src = ''; }
         	const url = new URL(window.location);
         	url.searchParams.delete('product_id');
         	window.history.replaceState({}, '', url);
    	}




    	function initFavs() { try { state.favorites = JSON.parse(localStorage.getItem('souq_favs') || '[]'); } catch(e){ state.favorites = []; } updateFavBadge(); }
    	window.toggleFav = (e, id) => { e.stopPropagation(); if(state.favorites.includes(id)) state.favorites = state.favorites.filter(i => i !== id); else state.favorites.push(id); localStorage.setItem('souq_favs', JSON.stringify(state.favorites)); updateFavBadge(); if(state.currentView === 'category') renderProducts(); };
    	function updateFavBadge() { const b = document.getElementById('fav-count'); if(b){ if(state.favorites.length) b.classList.remove('hidden'); else b.classList.add('hidden'); }}
    	window.toggleFavView = () => { 
        	state.currentView = 'category';
        	state.currentFilter = 'fav';
        	renderView();
        	showToast("عرض المفضلة ❤️"); 
    	};




    	window.updateFormFields = () => {
        	const cat = document.getElementById('in-cat').value;
        	document.getElementById('field-condition').classList.toggle('hidden', !USED_CATS.includes(cat));




        	const isClothes = CLOTHES_CATS.includes(cat);
        	const isShoes = SHOES_CATS.includes(cat);




        	const sizeContainer = document.getElementById('field-size-chips');
        	const sizeChips = document.getElementById('size-chips-container');
        	const colorContainer = document.getElementById('field-color-chips');
        	const colorChips = document.getElementById('color-chips-container');
        	const dynamicFields = document.getElementById('dynamic-fields');




        	sizeContainer.classList.add('hidden');
        	colorContainer.classList.add('hidden');
        	dynamicFields.classList.add('hidden');
        	sizeChips.innerHTML = '';
        	colorChips.innerHTML = '';




        	if (isClothes || isShoes) {
            	dynamicFields.classList.remove('hidden');
            	sizeContainer.classList.remove('hidden');




            	let sizes = [];
            	if (cat.includes("اطفال")) {
                	sizes = isShoes ? SIZES_SHOES_KIDS : SIZES_KIDS;
            	} else if (cat.includes("حريمي")) {
                	sizes = isShoes ? SIZES_SHOES_ADULT : SIZES_WOMEN;
            	} else {
                	sizes = isShoes ? SIZES_SHOES_ADULT : SIZES_MEN;
            	}




            	sizes.forEach(s => {
                	sizeChips.innerHTML += `<label class="cursor-pointer"><input type="checkbox" name="smart-size" value="${s}" class="smart-option hidden"><div class="px-2 py-1 rounded-lg border border-slate-300 dark:border-slate-600 font-bold text-[10px] text-slate-500 hover:border-navy transition min-w-[30px] text-center">${s}</div></label>`;
            	});
        	}




        	if (isClothes) {
            	colorContainer.classList.remove('hidden');
            	BASIC_COLORS.forEach(c => {
                	colorChips.innerHTML += `<label class="cursor-pointer"><input type="checkbox" name="smart-color" value="${c}" class="smart-option hidden"><div class="px-2 py-1 rounded-lg border border-slate-300 dark:border-slate-600 font-bold text-[10px] text-slate-500 hover:border-navy transition">${c}</div></label>`;
            	});
        	}
    	}




    	window.toggleShipGov = () => {
         	const mode = document.querySelector('input[name="ship-mode"]:checked').value;
         	const container = document.getElementById('ship-gov-container');
         	if(mode === 'specific') {
             	container.classList.remove('hidden');
         	} else {
             	container.classList.add('hidden');
         	}
    	}




    	window.submitListing=async()=>{
        	if(!state.images.length)return showToast('مطلوب صورة واحدة على الأقل','e');
        	const btn = document.getElementById('btn-publish');
        	btn.disabled = true;
        	btn.innerHTML = '<span>جاري النشر...</span>';
        	const bdg=document.querySelector('input[name="badge"]:checked').value;
        	const cond=document.getElementById('in-condition').value;
        	const cat=document.getElementById('in-cat').value;
        	const feats=[]; document.querySelectorAll('.chip-checkbox:checked').forEach(c=>feats.push(c.value));




        	const sizes = []; document.querySelectorAll('input[name="smart-size"]:checked').forEach(c => sizes.push(c.value));
        	const colors = []; document.querySelectorAll('input[name="smart-color"]:checked').forEach(c => colors.push(c.value));




        	const shipMode = document.querySelector('input[name="ship-mode"]:checked').value;
        	let shipGovs = [];
        	if(shipMode === 'specific') {
            	document.querySelectorAll('input[name="ship-gov-check"]:checked').forEach(c => shipGovs.push(c.value));
            	if(shipGovs.length === 0) {
                	showToast('يرجى اختيار محافظة واحدة على الأقل للشحن', 'e');
                	btn.disabled = false;
                	btn.innerHTML = '<span>نشر المنتج</span>';
                	return;
            	}
        	}




        	const userGov = state.userData ? state.userData.governorate : '';




        	await addDoc(collection(db,"listings"),{
            	title:document.getElementById('in-title').value,
            	price:Number(document.getElementById('in-price').value),
            	category:cat,
            	condition:cond,
            	size: sizes.length > 0 ? sizes : null, 
            	color: colors.length > 0 ? colors : null, 
            	shippingMode: shipMode,
            	shippingGov: shipMode === 'specific' ? shipGovs : null, 
            	phone:document.getElementById('in-phone').value,
            	desc:document.getElementById('in-desc').value,
            	features:feats,
            	images:state.images,
            	badge:bdg,
            	status:'available',
            	governorate: userGov,
            	createdAt:serverTimestamp(),
            	authorId:state.user.uid
        	});
        	showToast('تم النشر بنجاح');
        	toggleAddModal();
        	btn.disabled = false;
        	btn.innerHTML = '<span>نشر المنتج</span><i data-lucide="arrow-left" class="w-4 h-4"></i>';
        	lucide.createIcons();
    	};




       // دالة الحذف (تم تحديثها لتغلق النافذة بعد الحذف)
    window.del = async (e, id) => {
        if(e) e.stopPropagation(); // منع تعارض النقرات
        
        if(confirm('هل أنت متأكد من حذف هذا المنتج نهائياً؟')) {
            await deleteDoc(doc(db, "listings", id));
            showToast('تم الحذف بنجاح');
            closeDetails(); // <-- هذه الإضافة المهمة: إغلاق المودال بعد الحذف
        }
    };

    // دالة تغيير الحالة (متاح/مباع)
    window.toggleStatus = async (e, id, currentStatus) => {
        if(e) e.stopPropagation();
        
        let nextStatus = currentStatus === 'available' ? 'sold' : 'available';
        await updateDoc(doc(db, "listings", id), { status: nextStatus });
        
        showToast(`تم تغيير الحالة إلى: ${nextStatus === 'available' ? 'متاح' : 'مُباع'}`);
        
        // تحديث النافذة الحالية لو كانت مفتوحة
        if(!document.getElementById('details-modal').classList.contains('hidden')) {
             openDetails(id); // إعادة تحميل تفاصيل المنتج لتحديث الزر والحالة
        }
    };



    	window.toggleDarkMode = () => { 
        	document.documentElement.classList.toggle('dark'); 
        	localStorage.setItem('souq_theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); 
    	}
    	if(localStorage.getItem('souq_theme') === 'dark') document.documentElement.classList.add('dark');




    	window.showToast=(m,t='s')=>{
        	const d=document.createElement('div');
        	const bgClass = t==='e' ? 'bg-red-600 text-white' : 'bg-green-600 text-white';
        	d.className=`toast px-6 py-3 rounded-full shadow-2xl flex items-center gap-2 text-xs font-bold ${bgClass}`;
        	d.innerHTML=`<i data-lucide="${t==='e'?'alert-circle':'check-circle'}" class="w-4 h-4"></i> ${m}`;
        	document.getElementById('toast-container').appendChild(d);
        	lucide.createIcons();
        	setTimeout(()=>{d.classList.add('hiding');setTimeout(()=>d.remove(),300)},3000)
    	};




    	function normalizeText(t) { return t.replace(/[أإآ]/g,'ا').replace(/ة/g,'ه').replace(/ى/g,'ي').toLowerCase(); }
    	function showSkeletons() { const c=document.getElementById('grid-container'); c.innerHTML=''; for(let i=0;i<8;i++) c.innerHTML+=`<div class="bg-white dark:bg-slate-800 rounded-lg overflow-hidden shadow-sm border-2 border-slate-200 dark:border-slate-700 h-full"><div class="h-32 skeleton"></div><div class="p-2 space-y-2"><div class="h-4 rounded skeleton w-3/4"></div><div class="h-3 rounded skeleton w-1/2"></div></div></div>`; }




    	window.shareListing = async () => { 
        	if(!state.currentItem) return; 
        	const directLink = `${window.location.origin}${window.location.pathname}?product_id=${state.currentItem.id}`;
        	const d = { title: 'السوق وياك', text: `شاهد المنتج: ${state.currentItem.title}`, url: directLink }; 
        	try { await navigator.share(d); showToast('تمت المشاركة بنجاح'); } catch(e) { navigator.clipboard.writeText(d.url); showToast('تم نسخ الرابط'); } 
    	};




    	window.scrollCard = (e, id, dir) => { 
        	e.stopPropagation(); 
        	const s = document.getElementById(`slider-${id}`);
        	if (!s) return;
        	const totalImages = s.children.length;
        	if (totalImages <= 1) return;
        	const imgWidth = s.clientWidth;
        	let currentIndex = Math.round(s.scrollLeft / imgWidth);
        	let nextIndex = currentIndex - dir; 
        	if (nextIndex >= totalImages) { nextIndex = 0; } else if (nextIndex < 0) { nextIndex = totalImages - 1; }
        	s.scrollTo({ left: nextIndex * imgWidth, behavior: 'smooth' });
    	}




    	window.openLightbox = (src) => {
        	if (!src || src.endsWith('?text=No+Image')) return; 
        	if(state.currentItem && document.getElementById('details-modal').classList.contains('hidden') === false) {
             	state.lightboxImages = state.detailsSliderImages;
        	} else {
             	state.lightboxImages = state.detailsSliderImages.length ? state.detailsSliderImages : [];
             	if(!state.lightboxImages.length && state.currentItem) {
                 	state.lightboxImages = Array.isArray(state.currentItem.images) ? state.currentItem.images : [state.currentItem.image].filter(Boolean);
             	}
        	}
        	state.lightboxIndex = state.lightboxImages.indexOf(src);
        	if (state.lightboxIndex === -1) state.lightboxIndex = 0; 
        	if (state.lightboxImages.length > 0) {
            	document.getElementById('lightbox-img').src = state.lightboxImages[state.lightboxIndex];
            	document.getElementById('lightbox').classList.remove('hidden');
            	lucide.createIcons(); 
        	}
    	}




    	window.navigateLightbox = (dir) => {
        	if (!state.lightboxImages.length) return;
        	state.lightboxIndex += dir;
        	if (state.lightboxIndex >= state.lightboxImages.length) {
            	state.lightboxIndex = 0;
        	} else if (state.lightboxIndex < 0) {
            	state.lightboxIndex = state.lightboxImages.length - 1;
        	}
        	document.getElementById('lightbox-img').src = state.lightboxImages[state.lightboxIndex];
    	}




    	window.closeLightbox = () => {
        	document.getElementById('lightbox').classList.add('hidden');
        	state.lightboxImages = [];
        	state.lightboxIndex = 0;
    	}




    	function toggleModal(id) { const m=document.getElementById(id); m.classList.toggle('hidden'); if(!m.classList.contains('hidden')) document.body.style.overflow='hidden'; else document.body.style.overflow=''; return !m.classList.contains('hidden'); }




    	window.toggleAddModal=()=>{
        	if(state.userRole !== 'marketer') {
            	if(confirm("عفواً لا يمكن عرض هذه الصفحة لغير المسوقين وأصحاب العمل.\nهل تريد أن تصبح مسوق؟")) {
                	state.userRole = 'marketer';
                	updateDoc(doc(db, "users", state.user.uid), { role: 'marketer' }).then(() => {
                     	showToast(`أهلاً بك في شركتنا 👋`, 's');
                     	openAddModalLogic();
                	});
            	} else {
                	showToast("هذه الصفحة مخصصة للمسوقين ومقدمي الخدمات", 'e');
            	}
        	} else {
            	openAddModalLogic();
        	}
    	};




    	function openAddModalLogic() {
        	if(toggleModal('add-modal')) { 
            	state.images=[];
            	document.getElementById('preview-area').innerHTML='';
            	document.getElementById('in-title').value = '';
            	document.getElementById('in-price').value = '';
            	document.getElementById('in-phone').value = '';
            	document.getElementById('in-desc').value = '';
            	document.getElementById('in-cat').selectedIndex = 0;
            	document.getElementById('in-condition').selectedIndex = 0;
            	document.querySelectorAll('.chip-checkbox').forEach(c => c.checked = false);
            	document.querySelector('input[name="badge"][value="none"]').checked = true;




            	document.querySelectorAll('.smart-option').forEach(c => c.checked = false);
            	document.querySelector('input[name="ship-mode"][value="all"]').checked = true;
            	document.querySelectorAll('input[name="ship-gov-check"]').forEach(c => c.checked = false);
            	toggleShipGov();




            	updateFormFields(); 
        	}
    	}




    	window.handleUpload=async(input)=>{if(input.files.length+state.images.length>7)return showToast('7 صور بحد أقصى','e');for(let f of input.files){const c=await compress(f);state.images.push(c);document.getElementById('preview-area').innerHTML+=`<img src="${c}" class="w-14 h-14 rounded-xl object-cover border border-gray-200 shrink-0">`}}; 
    	function compress(f){return new Promise(r=>{const d=new FileReader();d.readAsDataURL(f);d.onload=e=>{const i=new Image();i.src=e.target.result;i.onload=()=>{const c=document.createElement('canvas');const x=c.getContext('2d');const s=800/i.width;c.width=800;c.height=i.height*s;x.drawImage(i,0,0,c.width,c.height);r(c.toDataURL('image/jpeg',0.6))}}})};




    	window.toggleChat=()=>{
        	if(toggleModal('chat-modal')){
            	if(!state.chatId&&state.chatStep===0&&!state.welcomeSent){
                	state.welcomeSent=true;
                	const name = state.user.displayName || 'يا صديقي';
                	setTimeout(()=>botMsg(`مرحباً ${name} 👋<br>معك المساعد الذكي للسوق  وياك اخبرني بطلبك لتحويلك للدعم الفني؟`),100);
            	}
        	}
    	};




    	window.sendMsg=async()=>{
        	const t=document.getElementById('chat-msg').value.trim();
        	if(!t)return;
        	document.getElementById('chat-msg').value='';
        	userMsg(t);




        	if(!state.chatId){
            	if(state.chatStep===0){
                	state.chatStep=2;
                	try {
                    	const r=await addDoc(collection(db,"chats"),{
                        	userId:state.user.uid, 
                        	userName:state.user.displayName || state.user.email,
                        	lastMsg:t,
                        	status:'waiting',
                        	messages:[
                            	{s:'bot',t:`الاسم: ${state.user.displayName}`,d:new Date()},
                            	{s:'user',t,d:new Date()},
                            	{s:'bot',t:'تم تحويلك لاحد ممثلي خدمة العملاء انتظر  الرد',d:new Date()}
                        	],
                        	createdAt:serverTimestamp()
                    	});
                    	state.chatId=r.id;
                    	listenChat(r.id);
                	} catch (err) {
                    	console.error("Chat creation failed:", err);
                    	botMsg("عفواً، حدث خطأ أثناء محاولة توصيلك بالدعم.");
                	}
            	}
        	} else {
            	const s=await getDocs(query(collection(db,"chats"),where('__name__','==',state.chatId)));
            	if(!s.empty){
                	const m=s.docs[0].data().messages;
                	m.push({s:'user',t,d:new Date()});
                	await updateDoc(doc(db,"chats",state.chatId),{messages:m,lastMsg:t,status:'waiting'});
            	}
        	}
    	};




    	function listenChat(id){onSnapshot(doc(db,"chats",id),s=>{if(s.exists()){const d=s.data();if(d.status==='closed'){state.chatId=null;state.chatStep=0;state.welcomeSent=false;document.getElementById('chat-box').innerHTML='';showToast("تم إنهاء المحادثة");toggleModal('chat-modal');return}document.getElementById('chat-box').innerHTML='';d.messages.forEach(m=>{if(!m.t.startsWith('الاسم'))(m.s==='user'?userMsg:botMsg)(m.t)})}})};
    	function checkUserChat(){onSnapshot(query(collection(db,"chats"),where('userId','==',state.user.uid),where('status','!=','closed')),s=>{if(!s.empty){state.chatId=s.docs[0].id;state.chatStep=2;listenChat(state.chatId)}})};
    	function userMsg(t){const d=document.createElement('div');d.className="flex justify-start";d.innerHTML=`<div class="bg-primary text-white px-3 py-2 rounded-xl rounded-tr-none shadow-sm text-xs max-w-[85%]">${t}</div>`;document.getElementById('chat-box').appendChild(d);document.getElementById('chat-box').scrollTop=9999}
    	function botMsg(t){const d=document.createElement('div');d.className="flex justify-end";d.innerHTML=`<div class="bg-white dark:bg-slate-700 dark:text-white text-slate-800 px-3 py-2 rounded-xl rounded-tl-none shadow-sm text-xs max-w-[85%]">${t}</div>`;document.getElementById('chat-box').appendChild(d);document.getElementById('chat-box').scrollTop=9999}




    	window.toggleAdminPanel=()=>{document.getElementById('admin-panel').classList.toggle('hidden');if(!document.getElementById('admin-panel').classList.contains('hidden'))refreshAdmin()};




    	document.getElementById('logo-trigger').addEventListener('click',()=>{
        	if(prompt('Code:')==='1532'){
            	if(state.user) {
                	state.isAdmin = true;
                	document.getElementById('btn-admin-top').classList.remove('hidden');
                	showToast('تم تفعيل وضع الأدمن (محلي)');
                	updateDoc(doc(db, "users", state.user.uid), { isAdmin: true }).catch(e => console.log("DB Update blocked by rules, local admin active"));
            	} else {
                	showToast("يجب تسجيل الدخول أولاً", "e");
            	}
        	}
    	});




    	window.refreshAdmin=()=>{
        	onSnapshot(query(collection(db,"chats"),where('status','!=','closed')),s=>{
            	const l=document.getElementById('admin-users-list');
            	l.innerHTML='';
            	let chats = [];
            	s.forEach(d => chats.push({id: d.id, ...d.data()}));
            	chats.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
            	chats.forEach(dt => {
                	l.innerHTML+=`<div onclick="loadAdmin('${dt.id}','${dt.userName}')" class="p-3 mb-2 bg-white/5 rounded-xl cursor-pointer border border-white/10"><div class="font-bold text-xs text-white flex justify-between"><span>${dt.userName}</span>${dt.status==='waiting'?'<span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>':''}</div><div class="text-[10px] text-gray-400 truncate mt-1">${dt.lastMsg}</div></div>`
            	});
        	})
    	};




    	window.loadAdmin=(id,n)=>{state.activeAdminChat=id;document.getElementById('admin-chat-header').innerHTML=`<span>${n}</span><button onclick="kickUser()" id="btn-end-chat" class="hidden bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded flex items-center gap-1"><i data-lucide="slash" class="w-3 h-3"></i> إنهاء</button>`;document.getElementById('btn-end-chat').classList.remove('hidden');onSnapshot(doc(db,"chats",id),s=>{const b=document.getElementById('admin-msg-area');b.innerHTML='';if(!s.exists())return;s.data().messages.forEach(m=>{b.innerHTML+=`<div class="${m.s==='support'?'text-left':'text-right'} mb-2"><span class="inline-block px-3 py-2 rounded-lg text-xs ${m.s==='support'?'bg-primary text-white':'bg-white/10'}">${m.t}</span></div>`});b.scrollTop=9999})};
    	window.sendAdminMsg=async()=>{const t=document.getElementById('admin-input').value;if(!t||!state.activeAdminChat)return;document.getElementById('admin-input').value='';const s=await getDocs(query(collection(db,"chats"),where('__name__','==',state.activeAdminChat)));const m=s.docs[0].data().messages;m.push({s:'support',t,d:new Date()});await updateDoc(doc(db,"chats",state.activeAdminChat),{messages:m,status:'active'})};
    	window.kickUser=async()=>{if(confirm("إنهاء؟")){await updateDoc(doc(db,"chats",state.activeAdminChat),{status:'closed'});document.getElementById('admin-msg-area').innerHTML='';document.getElementById('btn-end-chat').classList.add('hidden');state.activeAdminChat=null}};




    	// Profile Logic (Updated)
    	window.toggleProfile = async (userId = null) => {
        	if(toggleModal('profile-modal')) {
            	const targetId = userId || (auth.currentUser ? auth.currentUser.uid : null);
            	if(!targetId) return;




            	state.viewingProfileId = targetId;
            	const isOwner = auth.currentUser && auth.currentUser.uid === targetId;




            	// Reset UI
            	document.getElementById('prof-name').innerText = '...';
            	document.getElementById('prof-role').innerText = '...';
            	document.getElementById('prof-phone').innerText = '...';
            	document.getElementById('prof-address').innerText = '...';
            	document.getElementById('prof-joined').innerText = '';
            	document.getElementById('prof-img-container').innerHTML = `<i data-lucide="user" class="w-10 h-10 text-slate-400"></i>`;
            	document.getElementById('prof-password-section').classList.add('hidden');
            	document.getElementById('prof-reviews-section').classList.add('hidden');
            	document.getElementById('prof-rate-user-section').classList.add('hidden');
            	document.getElementById('prof-rating-display').classList.add('hidden');
            	document.getElementById('global-edit-btn').classList.add('hidden');




            	// Ensure View Mode is active
            	document.getElementById('prof-view-mode').classList.remove('hidden');
            	document.getElementById('prof-edit-mode').classList.add('hidden');




            	try {
                	let data = null;
                	if(isOwner && state.userData) {
                    	data = state.userData;
                	} else {
                    	const snap = await getDoc(doc(db, "users", targetId));
                    	if(snap.exists()) data = snap.data();
                	}




                	if(data) {
                    	document.getElementById('prof-name').innerText = data.name || 'مستخدم';
                    	document.getElementById('prof-role').innerText = data.role === 'marketer' ? 'مسوق / بائع' : 'عميل';
                    	document.getElementById('prof-phone').innerText = data.phone || 'غير مسجل';
                    	document.getElementById('prof-address').innerText = (data.address || '') + ' - ' + (data.governorate || '');
                    	document.getElementById('prof-joined').innerText = 'انضم: ' + formatDate(data.createdAt); // Req 10




                    	if(data.image) {
                        	document.getElementById('prof-img-container').innerHTML = `<img src="${data.image}" class="w-full h-full object-cover">`;
                    	}




                    	calculateUserRating(targetId);




                    	if(isOwner) {
                        	document.getElementById('global-edit-btn').classList.remove('hidden');
                        	document.getElementById('prof-password-section').classList.remove('hidden');
                    	} else {
                        	document.getElementById('prof-rate-user-section').classList.remove('hidden');
                    	}




                    	if(data.role === 'marketer') {
                         	document.getElementById('prof-reviews-section').classList.remove('hidden');
                         	state.profileReviewsLimit = 3;
                         	loadProfileReviews(false);
                    	}
                	}
            	} catch(e) {
                	console.error(e);
            	}
            	lucide.createIcons();
        	}
    	}




    	// Req 1: Full Edit Form Logic
    	window.toggleEditMode = () => {
        	const viewMode = document.getElementById('prof-view-mode');
        	const editMode = document.getElementById('prof-edit-mode');




        	if(editMode.classList.contains('hidden')) {
            	// Switch to Edit
            	viewMode.classList.add('hidden');
            	editMode.classList.remove('hidden');




            	// Pre-fill data
            	document.getElementById('edit-name').value = state.userData.name || '';
            	document.getElementById('edit-phone').value = state.userData.phone || '';
            	document.getElementById('edit-address').value = state.userData.address || '';
            	document.getElementById('edit-gov').value = state.userData.governorate || '';
            	updateEditCities();
            	document.getElementById('edit-city').value = state.userData.city || '';




            	if(state.userData.image) {
                	document.getElementById('edit-img-preview').src = state.userData.image;
                	document.getElementById('edit-img-preview').classList.remove('hidden');
                	document.getElementById('edit-img-placeholder').classList.add('hidden');
            	}
        	} else {
            	// Switch to View
            	editMode.classList.add('hidden');
            	viewMode.classList.remove('hidden');
        	}
    	}




    	window.handleEditImage = async (input) => {
        	if (input.files && input.files[0]) {
            	const c = await compress(input.files[0]);
            	document.getElementById('edit-img-preview').src = c;
            	document.getElementById('edit-img-preview').classList.remove('hidden');
            	document.getElementById('edit-img-placeholder').classList.add('hidden');
            	// Store temporarily
            	state.tempEditImage = c;
        	}
    	}




    	window.saveProfile = async () => {
        	const name = document.getElementById('edit-name').value.trim();
        	const phone = document.getElementById('edit-phone').value.trim();
        	const address = document.getElementById('edit-address').value.trim();
        	const gov = document.getElementById('edit-gov').value;
        	const city = document.getElementById('edit-city').value;




        	if(!name || !phone || !address || !gov || !city) return showToast("يرجى ملء جميع الحقول", "e");




        	const updateData = {
            	name, phone, address, governorate: gov, city
        	};




        	if(state.tempEditImage) {
            	updateData.image = state.tempEditImage;
        	}




        	try {
            	await updateDoc(doc(db, "users", state.user.uid), updateData);




            	// Update local state
            	state.userData = { ...state.userData, ...updateData };
            	state.tempEditImage = null;




            	// Update View
            	document.getElementById('prof-name').innerText = name;
            	document.getElementById('prof-phone').innerText = phone;
            	document.getElementById('prof-address').innerText = address + ' - ' + gov;
            	if(updateData.image) {
                	document.getElementById('prof-img-container').innerHTML = `<img src="${updateData.image}" class="w-full h-full object-cover">`;
            	}




            	showToast("تم حفظ التعديلات بنجاح");
            	toggleEditMode(); // Switch back to view
        	} catch(e) {
            	showToast("فشل الحفظ", "e");
        	}
    	}




    	window.changePassword = async () => {
        	const newPass = document.getElementById('new-password').value;
        	if(!newPass || newPass.length < 6) return showToast("كلمة المرور قصيرة جداً", "e");
        	try {
            	await updatePassword(auth.currentUser, newPass);
            	showToast("تم تحديث كلمة المرور بنجاح");
            	document.getElementById('new-password').value = '';
        	} catch(e) {
            	showToast("يجب إعادة تسجيل الدخول لتغيير كلمة المرور", "e");
        	}
    	}




    	// User Rating Logic
    	window.setUserRating = (n) => { state.currentUserRating = n; }




    	window.submitUserReview = async () => {
        	if(!state.user) return showToast("يجب تسجيل الدخول للتقييم", "e");
        	if(!state.viewingProfileId) return;
        	if(state.currentUserRating === 0) return showToast("يرجى تحديد عدد النجوم", "e");




        	const text = document.getElementById('user-review-text').value;




        	await addDoc(collection(db, "user_reviews"), {
            	targetUserId: state.viewingProfileId,
            	reviewerId: state.user.uid,
            	reviewerName: state.userData.name || 'مستخدم',
            	reviewerImage: state.userData.image || null,
            	rating: state.currentUserRating,
            	text: text,
            	timestamp: serverTimestamp()
        	});




        	showToast("تم إرسال التقييم");
        	document.getElementById('user-review-text').value = '';
        	calculateUserRating(state.viewingProfileId);




        	// Refresh reviews
        	state.profileReviewsLimit = 3;
        	loadProfileReviews(false);
    	}




    	async function calculateUserRating(userId) {
        	const q = query(collection(db, "user_reviews"), where("targetUserId", "==", userId));
        	const snap = await getDocs(q);
        	if(!snap.empty) {
            	let total = 0;
            	snap.forEach(d => total += d.data().rating);
            	const avg = (total / snap.size).toFixed(1);
            	document.getElementById('prof-rating-val').innerText = avg;
            	document.getElementById('prof-rating-display').classList.remove('hidden');
        	} else {
            	document.getElementById('prof-rating-display').classList.add('hidden');
        	}
    	}




    	// Product Reviews Logic
    	window.setRating = (n) => { state.currentRating = n; }




    	window.submitProductReview = async () => {
        	if(!state.user) return showToast("يجب تسجيل الدخول للتقييم", "e");
        	if(!state.currentItem) return;
        	if(state.currentRating === 0) return showToast("يرجى تحديد عدد النجوم", "e");




        	const text = document.getElementById('review-text').value;




        	await addDoc(collection(db, "product_reviews"), {
            	productId: state.currentItem.id,
            	productAuthorId: state.currentItem.authorId, 
            	userId: state.user.uid,
            	userName: state.userData.name || 'مستخدم',
            	userImage: state.userData.image || null,
            	rating: state.currentRating,
            	text: text,
            	timestamp: serverTimestamp()
        	});




        	showToast("تم نشر التقييم");
        	document.getElementById('review-text').value = '';
        	state.productReviewsLimit = 1;
        	loadProductReviews(false);
    	}




    	// Req 3: Pagination Logic (Show More / Show Less)
    	window.loadProductReviews = async (append = false, reduce = false) => {
        	if(!state.currentItem) return;
        	const list = document.getElementById('product-reviews-list');
        	const btnMore = document.getElementById('load-more-reviews');
        	const btnLess = document.getElementById('load-less-reviews');




        	if(reduce) {
            	state.productReviewsLimit = 1;
            	append = false;
        	} else if(append) {
            	state.productReviewsLimit += 3;
        	}




        	const q = query(
            	collection(db, "product_reviews"), 
            	where("productId", "==", state.currentItem.id),
            	orderBy("timestamp", "desc"),
            	limit(state.productReviewsLimit + 1) 
        	);




        	const snap = await getDocs(q);
        	if(!append) list.innerHTML = '';




        	let count = 0;
        	snap.forEach(doc => {
            	if(count < state.productReviewsLimit) {
                	const r = doc.data();
                	const stars = "★".repeat(r.rating) + "☆".repeat(5 - r.rating);
                	const img = r.userImage ? `<img src="${r.userImage}" class="w-full h-full object-cover">` : `<i data-lucide="user" class="w-4 h-4 text-slate-400"></i>`;




                	if(append && list.innerHTML.includes(r.text)) return; 




                	list.innerHTML += `
                    	<div class="bg-slate-50 dark:bg-slate-800/50 p-2 rounded-lg border border-slate-100 dark:border-slate-700">
                        	<div class="flex items-center gap-2 mb-1">
                            	<div class="w-6 h-6 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center overflow-hidden">${img}</div>
                            	<span class="text-[10px] font-bold text-navy dark:text-white">${r.userName}</span>
                            	<span class="text-yellow-400 text-xs tracking-tighter">${stars}</span>
                            	<span class="text-[8px] text-slate-300 mr-auto">${formatDate(r.timestamp)}</span>
                        	</div>
                        	<p class="text-[10px] text-slate-600 dark:text-slate-300 pr-8">${r.text || ''}</p>
                    	</div>
                	`;
            	}
            	count++;
        	});




        	if(snap.size > state.productReviewsLimit) {
            	btnMore.classList.remove('hidden');
        	} else {
            	btnMore.classList.add('hidden');
        	}




        	if(state.productReviewsLimit > 1) {
            	btnLess.classList.remove('hidden');
        	} else {
            	btnLess.classList.add('hidden');
        	}
        	lucide.createIcons();
    	}




    	window.loadProfileReviews = async (append = false, reduce = false) => {
        	if(!state.viewingProfileId) return;
        	const list = document.getElementById('prof-reviews-list');
        	const btnMore = document.getElementById('prof-reviews-more');
        	const btnLess = document.getElementById('prof-reviews-less');




        	if(reduce) {
            	state.profileReviewsLimit = 3;
            	append = false;
        	} else if(append) {
            	state.profileReviewsLimit += 3;
        	}




        	const q = query(
            	collection(db, "user_reviews"),
            	where("targetUserId", "==", state.viewingProfileId),
            	orderBy("timestamp", "desc"),
            	limit(state.profileReviewsLimit + 1)
        	);




        	try {
            	const snap = await getDocs(q);
            	if(!append) list.innerHTML = '';




            	if(snap.empty) {
                	list.innerHTML = '<p class="text-[10px] text-slate-400 text-center">لا توجد تقييمات بعد</p>';
                	btnMore.classList.add('hidden');
                	btnLess.classList.add('hidden');
                	return;
            	}




            	let count = 0;
            	snap.forEach(doc => {
                	if(count < state.profileReviewsLimit) {
                    	const r = doc.data();
                    	const stars = "★".repeat(r.rating);
                    	const img = r.reviewerImage ? `<img src="${r.reviewerImage}" class="w-full h-full object-cover">` : `<i data-lucide="user" class="w-4 h-4 text-slate-400"></i>`;




                    	list.innerHTML += `
                        	<div class="bg-slate-50 dark:bg-slate-800/50 p-2 rounded-lg text-xs">
                            	<div class="flex justify-between mb-1">
                                	<div class="flex items-center gap-2">
                                     	<div class="w-6 h-6 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center overflow-hidden">${img}</div>
                                     	<span class="font-bold">${r.reviewerName || 'مستخدم'}</span>
                                	</div>
                                	<span class="text-yellow-400">${stars}</span>
                            	</div>
                            	<p class="text-slate-600 dark:text-slate-300 pr-8">${r.text}</p>
                            	<span class="text-[8px] text-slate-300 block mt-1">${formatDate(r.timestamp)}</span>
                        	</div>
                    	`;
                	}
                	count++;
            	});




            	if(snap.size > state.profileReviewsLimit) btnMore.classList.remove('hidden');
            	else btnMore.classList.add('hidden');




            	if(state.profileReviewsLimit > 3) btnLess.classList.remove('hidden');
            	else btnLess.classList.add('hidden');




        	} catch(e) {
            	console.log("Index might be missing for profile reviews", e);
            	list.innerHTML = '<p class="text-[10px] text-slate-400 text-center">جاري تفعيل نظام التقييمات...</p>';
        	}
    	}




    	// Req 7: Smart Order Logic
    	window.toggleOrderModal = () => {
        	if(toggleModal('order-modal')) {
            	if(!state.currentItem) return;




            	document.getElementById('ord-img').src = Array.isArray(state.currentItem.images) ? state.currentItem.images[0] : state.currentItem.image;
            	document.getElementById('ord-title').innerText = state.currentItem.title;
            	document.getElementById('ord-price').innerText = Number(state.currentItem.price).toLocaleString() + ' ج.م';




            	// Pre-fill user data
            	if(state.userData) {
                	document.getElementById('ord-phone').value = state.userData.phone || '';
                	document.getElementById('ord-gov').value = state.userData.governorate || '';
                	updateOrderCities();
                	document.getElementById('ord-city').value = state.userData.city || '';
                	document.getElementById('ord-address').value = state.userData.address || '';
            	}




            	state.orderItems = [];
            	document.getElementById('order-items-container').innerHTML = '';
            	addOrderItem(); // Add first item
        	}
    	}




    	window.addOrderItem = () => {
        	const index = state.orderItems.length;
        	state.orderItems.push({ qty: 1, size: '', color: '' });




        	const container = document.getElementById('order-items-container');
        	const itemDiv = document.createElement('div');
        	itemDiv.className = "bg-slate-50 dark:bg-slate-800 p-2 rounded-lg border border-slate-200 dark:border-slate-600 relative";
        	itemDiv.id = `ord-item-${index}`;




        	let sizeOptions = '';
        	if(state.currentItem.size && Array.isArray(state.currentItem.size)) {
            	sizeOptions = `<select onchange="updateOrderItem(${index}, 'size', this.value)" class="form-input text-xs h-8 w-full mb-1"><option value="">المقاس</option>${state.currentItem.size.map(s => `<option value="${s}">${s}</option>`).join('')}</select>`;
        	}




        	let colorOptions = '';
        	if(state.currentItem.color && Array.isArray(state.currentItem.color)) {
            	colorOptions = `<select onchange="updateOrderItem(${index}, 'color', this.value)" class="form-input text-xs h-8 w-full mb-1"><option value="">اللون</option>${state.currentItem.color.map(c => `<option value="${c}">${c}</option>`).join('')}</select>`;
        	}




        	itemDiv.innerHTML = `
            	<div class="flex justify-between items-center mb-2">
                	<span class="text-xs font-bold text-primary">المنتج #${index + 1}</span>
                	${index > 0 ? `<button onclick="removeOrderItem(${index})" class="text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
            	</div>
            	<div class="grid grid-cols-3 gap-2">
                	<input type="number" value="" min="1" onchange="updateOrderItem(${index}, 'qty', this.value)" class="form-input text-xs h-8 text-center" placeholder="العدد">
                	<div class="col-span-2 flex gap-1">
                    	${sizeOptions}
                    	${colorOptions}
                	</div>
            	</div>
        	`;
        	container.appendChild(itemDiv);
        	calculateOrderTotal();
        	lucide.createIcons();
    	}




    	window.updateOrderItem = (index, field, value) => {
        	if(state.orderItems[index]) {
            	state.orderItems[index][field] = field === 'qty' ? Number(value) : value;
            	calculateOrderTotal();
        	}
    	}




    	window.removeOrderItem = (index) => {
        	document.getElementById(`ord-item-${index}`).classList.add('hidden');
        	state.orderItems[index].qty = 0;
        	calculateOrderTotal();
    	}




    	window.calculateOrderTotal = () => {
        	let totalQty = 0;
        	state.orderItems.forEach(i => totalQty += i.qty);
        	const total = totalQty * Number(state.currentItem.price);
        	document.getElementById('ord-total').innerText = total.toLocaleString() + ' ج.م';
    	}




            	window.confirmOrder = () => {
        	const phone = document.getElementById('ord-phone').value;
        	const gov = document.getElementById('ord-gov').value;
        	const city = document.getElementById('ord-city').value;
        	const address = document.getElementById('ord-address').value;


        	if(!phone || !gov || !city || !address) return showToast("يرجى إكمال جميع البيانات", "e");


        	// جلب رقم البائع
        	const sellerPhone = state.currentItem.phone || (state.currentAuthor ? state.currentAuthor.phone : '');
        	if(!sellerPhone) return showToast("لا يوجد رقم للتواصل مع البائع", "e");


        	// 1. تجهيز التاريخ والوقت
        	const now = new Date();
        	const dateStr = now.toLocaleDateString('ar-EG');
        	const timeStr = now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });


        	// 2. تجهيز رابط المنتج
        	const productUrl = `${window.location.origin}${window.location.pathname}?product_id=${state.currentItem.id}`;


        	// --- بناء نص الرسالة بالتنسيق المطلوب ---
        	let msg = `طلب جديد من تطبيق السوق وياك🏠📥\n`;
        	msg += `📅 وقت الطلب: ${dateStr} - ${timeStr}\n\n`;


        	msg += `📦 معلومات المنتج:\n`;
        	msg += `*الاسم:* ${state.currentItem.title}\n`;
        	msg += `*القسم:* ${state.currentItem.category || 'غير محدد'}\n`;
        	msg += `*سعر القطعة:* ${Number(state.currentItem.price).toLocaleString()} ج.م\n\n`;


        	msg += `📝 تفاصيل الطلب:\n`;
        	
        	let totalQty = 0;
        	state.orderItems.forEach((item, idx) => {
            	if(item.qty > 0) {
                	// تنسيق السطر الواحد لكل خيار
                	msg += `اختيار #${idx+1}:  	(عدد ${item.qty})`;
                	
                	if(item.size) msg += ` | مقاس: ${item.size}`;
                	if(item.color) msg += ` | لون: ${item.color}`;
                	
                	msg += `\n`;
                	totalQty += item.qty;
            	}
        	});


        	if(totalQty === 0) return showToast("يرجى إضافة قطعة واحدة على الأقل", "e");


        	msg += `\nاجمالي الفاتورة: ${(totalQty * state.currentItem.price).toLocaleString()} ج.م\n`;
        	msg += `----------------\n`;
        	
        	msg += `👤 بيانات العميل:\n`;
        	msg += `الاسم: ${state.userData ? state.userData.name : 'ضيف'}\n`;
        	msg += `رقم الهاتف: ${phone}\n`;
        	msg += `العنوان: ${gov} - ${city} - ${address}\n\n`;


        	// وضع الرابط في نهاية الرسالة
        	msg += `🔗 رابط المنتج: ${productUrl}`;


        	// فتح واتساب
        	const url = `https://wa.me/20${sellerPhone}?text=${encodeURIComponent(msg)}`;
        	window.open(url, '_blank');
        	toggleOrderModal();
    	}


lucide.createIcons();
	</script>
</body>
</html>

