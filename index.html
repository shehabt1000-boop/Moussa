<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>دليل الشرقية V8 - المهن الشاملة</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Cairo', 'sans-serif'] },
                    colors: { primary: '#2563EB', darkBg: '#111827' },
                    animation: { 'fade': 'fadeIn 0.2s ease-in-out' },
                    keyframes: { fadeIn: { '0%': { opacity: 0 }, '100%': { opacity: 1 } } }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        
        /* تحسينات اللمس */
        button { cursor: pointer; touch-action: manipulation; }
        
        /* طبقات الخلفية */
        .glass-header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid #eee; }
        .dark .glass-header { background: rgba(17, 24, 39, 0.95); border-bottom: 1px solid #374151; }
        
        .prof-card-overlay { background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); }
        
        /* إشعار Toast */
        #toast-box { position: fixed; top: 20px; left: 0; right: 0; display: flex; justify-content: center; z-index: 9999; pointer-events: none; }
        .toast-msg { background: #333; color: white; padding: 10px 20px; border-radius: 30px; font-size: 14px; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.2); opacity: 0; transform: translateY(-20px); transition: all 0.3s; }
        .toast-msg.show { opacity: 1; transform: translateY(0); }
        .toast-msg.success { background: #10B981; }
        .toast-msg.error { background: #EF4444; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen pb-24 transition-colors duration-200">

    <!-- Toast Container -->
    <div id="toast-box"></div>

    <!-- Loading Overlay -->
    <div id="loader" class="fixed inset-0 bg-white/80 dark:bg-gray-900/90 z-[100] flex flex-col items-center justify-center hidden">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-gray-300 border-t-blue-600"></div>
        <p id="loader-text" class="mt-4 font-bold text-gray-500 text-sm">جاري التحميل...</p>
    </div>

    <!-- Header (Sticky) -->
    <header id="app-header" class="fixed top-0 left-0 right-0 h-16 glass-header z-50 px-4 flex items-center justify-between hidden md:max-w-md md:mx-auto">
        <div class="flex items-center gap-3">
            <button id="btn-back" onclick="window.goBack()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 hidden transition-colors">
                <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"/></svg>
            </button>
            <h1 id="page-title" class="text-lg font-bold text-primary">الرئيسية</h1>
        </div>
        
        <div class="flex items-center gap-3">
            <!-- Notification Bell -->
            <button class="relative p-2">
                <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                <span id="notif-dot" class="hidden absolute top-1.5 right-2 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white dark:border-gray-900"></span>
            </button>
            <!-- User Avatar Small -->
            <img id="header-avatar" src="https://via.placeholder.com/40" class="w-9 h-9 rounded-full bg-gray-200 object-cover border border-gray-300">
        </div>
    </header>

    <!-- ================= AUTH SECTION ================= -->
    <div id="auth-view" class="min-h-screen p-6 flex flex-col justify-center md:max-w-md md:mx-auto pt-10">
        <div class="text-center mb-8">
            <div class="inline-block p-4 bg-blue-600 rounded-2xl shadow-lg shadow-blue-600/30 mb-4 transform -rotate-3">
                <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            </div>
            <h1 class="text-3xl font-extrabold text-gray-800 dark:text-white">خدمات الشرقية</h1>
            <p class="text-sm text-gray-500 mt-2">سوق الخدمات الأول في محافظتك</p>
        </div>

        <div class="bg-gray-200 dark:bg-gray-800 p-1 rounded-xl flex mb-6">
            <button onclick="window.switchAuthMode('login')" id="btn-mode-login" class="flex-1 py-3 rounded-lg text-sm font-bold bg-white shadow text-blue-600 transition-all">دخول</button>
            <button onclick="window.switchAuthMode('signup')" id="btn-mode-signup" class="flex-1 py-3 rounded-lg text-sm font-bold text-gray-500 hover:bg-gray-300 dark:hover:bg-gray-700 transition-all">حساب جديد</button>
        </div>

        <!-- Login Form -->
        <form id="form-login" class="space-y-4 animate-fade">
            <input type="email" id="login-email" placeholder="البريد الإلكتروني" class="w-full p-4 rounded-xl bg-white dark:bg-gray-800 border border-transparent focus:border-blue-500 outline-none shadow-sm" required>
            <input type="password" id="login-pass" placeholder="كلمة المرور" class="w-full p-4 rounded-xl bg-white dark:bg-gray-800 border border-transparent focus:border-blue-500 outline-none shadow-sm" required>
            <button type="submit" class="w-full py-4 bg-blue-600 text-white rounded-xl font-bold shadow-lg hover:bg-blue-700 transition-transform active:scale-95">تسجيل الدخول</button>
        </form>

        <!-- Signup Form -->
        <form id="form-signup" class="hidden space-y-4 animate-fade pb-10">
            <!-- Photo Upload -->
            <div class="flex flex-col items-center mb-4">
                <div class="w-24 h-24 rounded-full bg-gray-100 dark:bg-gray-800 border-4 border-dashed border-blue-300 relative overflow-hidden group cursor-pointer" onclick="document.getElementById('signup-file').click()">
                    <img id="signup-preview" src="https://via.placeholder.com/150?text=+" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    </div>
                </div>
                <p class="text-xs text-blue-500 font-bold mt-2">اضغط لرفع صورة شخصية</p>
                <input type="file" id="signup-file" class="hidden" accept="image/*" onchange="window.handleImageUpload(this, 'signup-preview')">
            </div>

            <div class="grid grid-cols-2 gap-3">
                <input type="text" id="signup-name" placeholder="الاسم بالكامل" class="w-full p-3 rounded-xl bg-white dark:bg-gray-800 border-none shadow-sm outline-none" required>
                <input type="tel" id="signup-phone" placeholder="رقم الهاتف" class="w-full p-3 rounded-xl bg-white dark:bg-gray-800 border-none shadow-sm outline-none" required>
            </div>

            <input type="email" id="signup-email" placeholder="البريد الإلكتروني" class="w-full p-3 rounded-xl bg-white dark:bg-gray-800 border-none shadow-sm outline-none" required>
            <input type="password" id="signup-pass" placeholder="كلمة المرور (6 أحرف عالأقل)" class="w-full p-3 rounded-xl bg-white dark:bg-gray-800 border-none shadow-sm outline-none" minlength="6" required>

            <div class="grid grid-cols-2 gap-3">
                <select id="signup-city" class="w-full p-3 rounded-xl bg-white dark:bg-gray-800 border-none shadow-sm outline-none">
                    <option value="الزقازيق">الزقازيق</option>
                    <option value="بلبيس">بلبيس</option>
                    <option value="منيا القمح">منيا القمح</option>
                    <option value="فاقوس">فاقوس</option>
                    <option value="أبو كبير">أبو كبير</option>
                    <option value="العاشر من رمضان">العاشر</option>
                    <option value="ديرب نجم">ديرب نجم</option>
                    <option value="الإبراهيمية">الإبراهيمية</option>
                    <option value="الحسينية">الحسينية</option>
                    <option value="ههيا">ههيا</option>
                </select>
                <input type="text" id="signup-area" placeholder="المنطقة" class="w-full p-3 rounded-xl bg-white dark:bg-gray-800 border-none shadow-sm outline-none">
            </div>

            <!-- Role Toggle -->
            <div class="flex bg-gray-200 dark:bg-gray-700 p-1 rounded-xl">
                <label class="flex-1 text-center cursor-pointer">
                    <input type="radio" name="role" value="client" class="hidden peer" checked onchange="window.toggleProfVisibility(false)">
                    <div class="py-2 rounded-lg text-xs font-bold text-gray-500 peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow-sm transition-all">عميل</div>
                </label>
                <label class="flex-1 text-center cursor-pointer">
                    <input type="radio" name="role" value="provider" class="hidden peer" onchange="window.toggleProfVisibility(true)">
                    <div class="py-2 rounded-lg text-xs font-bold text-gray-500 peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow-sm transition-all">مقدم خدمة</div>
                </label>
            </div>

            <div id="prof-container" class="hidden animate-fade">
                <select id="signup-prof" class="w-full p-3 rounded-xl bg-white dark:bg-gray-800 border-2 border-blue-100 dark:border-gray-600 outline-none text-sm">
                    <option value="">اختر المهنة...</option>
                    <!-- JS Populated -->
                </select>
            </div>

            <button type="submit" class="w-full py-4 bg-green-600 text-white rounded-xl font-bold shadow-lg hover:bg-green-700 transition-transform active:scale-95">إنشاء الحساب</button>
        </form>
    </div>

    <!-- ================= APP VIEW ================= -->
    <div id="app-view" class="hidden md:max-w-md md:mx-auto pt-20 min-h-screen relative">
        
        <!-- PAGE: HOME -->
        <section id="page-home" class="page-section px-4 animate-fade">
            <!-- Home Tabs -->
            <div class="sticky top-16 z-30 bg-gray-50 dark:bg-gray-900 py-2 mb-2">
                <div class="flex p-1 bg-white dark:bg-gray-800 rounded-xl shadow-sm border dark:border-gray-700">
                    <button onclick="window.switchHomeTab('services')" id="tab-home-serv" class="flex-1 py-2 rounded-lg text-sm font-bold bg-blue-50 text-blue-600 transition-all">أقسام الخدمات</button>
                    <button onclick="window.switchHomeTab('jobs')" id="tab-home-jobs" class="flex-1 py-2 rounded-lg text-sm font-bold text-gray-500 transition-all">وظائف شاغرة</button>
                </div>
            </div>

            <!-- Services Grid -->
            <div id="view-services" class="pb-4">
                <div id="categories-grid" class="grid grid-cols-2 gap-3">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Jobs List -->
            <div id="view-jobs" class="hidden space-y-3 pb-4">
                <p class="text-center text-gray-400 py-10">جاري تحميل الوظائف...</p>
            </div>
        </section>

        <!-- PAGE: CATEGORY DETAILS (New Separate Page) -->
        <section id="page-category-details" class="page-section hidden px-4 animate-fade">
            <div class="sticky top-16 z-30 bg-gray-50 dark:bg-gray-900 py-2 mb-2">
                <input type="text" id="cat-search" onkeyup="window.filterCategoryList()" placeholder="بحث داخل القسم..." class="w-full p-3 rounded-xl bg-white dark:bg-gray-800 border-none shadow-sm outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div id="cat-list-container" class="space-y-3 pb-20">
                <!-- Populated by JS -->
            </div>
        </section>

        <!-- PAGE: DIRECTORY (General) -->
        <section id="page-directory" class="page-section hidden px-4 animate-fade">
            <input type="text" id="dir-search" onkeyup="window.filterDirectory()" placeholder="بحث عام عن مستخدم..." class="w-full p-3 rounded-xl bg-white dark:bg-gray-800 border-none shadow-sm outline-none mb-4">
            <div id="dir-list" class="space-y-3 pb-20"></div>
        </section>

        <!-- PAGE: ADD -->
        <section id="page-add" class="page-section hidden px-4 animate-fade">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-5 border dark:border-gray-700">
                <h2 class="text-lg font-bold mb-4 text-center">إضافة جديد</h2>
                
                <div class="flex gap-2 mb-4">
                    <button onclick="window.switchAddMode('req')" id="btn-add-req" class="flex-1 py-2 rounded-lg text-sm font-bold bg-blue-50 text-blue-600 border border-blue-200">طلب خدمة</button>
                    <button onclick="window.switchAddMode('job')" id="btn-add-job" class="flex-1 py-2 rounded-lg text-sm font-bold bg-gray-50 text-gray-500 border border-gray-200">وظيفة</button>
                </div>

                <!-- Request Form -->
                <form id="form-req" class="space-y-3">
                    <select id="req-prof" class="w-full p-3 rounded-xl border bg-white dark:bg-gray-900 dark:border-gray-600 outline-none text-sm"></select>
                    <textarea id="req-desc" rows="4" placeholder="وصف المشكلة بالتفصيل..." class="w-full p-3 rounded-xl border bg-white dark:bg-gray-900 dark:border-gray-600 outline-none"></textarea>
                    <div class="flex gap-2 pt-2">
                        <button type="submit" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold">نشر الطلب</button>
                        <button type="button" onclick="window.goBack()" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold">إلغاء</button>
                    </div>
                </form>

                <!-- Job Form -->
                <form id="form-job" class="hidden space-y-3">
                    <input type="text" id="job-title" placeholder="عنوان الوظيفة" class="w-full p-3 rounded-xl border bg-white dark:bg-gray-900 dark:border-gray-600 outline-none">
                    <textarea id="job-desc" rows="4" placeholder="التفاصيل والراتب..." class="w-full p-3 rounded-xl border bg-white dark:bg-gray-900 dark:border-gray-600 outline-none"></textarea>
                    <div class="flex gap-2 pt-2">
                        <button type="submit" class="flex-1 py-3 bg-purple-600 text-white rounded-xl font-bold">نشر الوظيفة</button>
                        <button type="button" onclick="window.goBack()" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold">إلغاء</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- PAGE: PROFILE (Main) -->
        <section id="page-profile" class="page-section hidden px-4 animate-fade">
            <div class="bg-white dark:bg-gray-800 rounded-3xl p-6 shadow-sm border border-gray-100 dark:border-gray-700 mb-4 relative overflow-hidden">
                <div class="absolute top-0 left-0 right-0 h-20 bg-gradient-to-r from-blue-500 to-cyan-400"></div>
                <div class="relative flex flex-col items-center pt-6">
                    <img id="prof-img-view" src="" class="w-24 h-24 rounded-full border-4 border-white dark:border-gray-800 bg-white object-cover shadow-md">
                    <h2 id="prof-name-view" class="text-xl font-bold mt-2 dark:text-white"></h2>
                    <p id="prof-role-view" class="text-sm text-gray-500 bg-gray-100 dark:bg-gray-700 px-3 py-1 rounded-full mt-1"></p>
                    <p id="prof-phone-view" class="text-sm text-gray-400 mt-1"></p>
                    
                    <div class="flex gap-2 mt-4 w-full">
                        <button onclick="window.navTo('edit-profile')" class="flex-1 py-2 bg-blue-50 text-blue-600 rounded-xl font-bold text-sm hover:bg-blue-100 transition-colors">تعديل البيانات ✏️</button>
                        <button onclick="window.navTo('settings')" class="flex-1 py-2 bg-gray-100 text-gray-600 rounded-xl font-bold text-sm hover:bg-gray-200 transition-colors">الإعدادات ⚙️</button>
                    </div>
                </div>
            </div>

            <div class="mt-6 pb-20">
                <h3 class="font-bold text-gray-500 text-sm mb-3">نشاطي (المنشورات)</h3>
                <div id="my-activity" class="space-y-2"></div>
                <button onclick="window.logout()" class="w-full mt-8 py-3 bg-red-50 text-red-500 border border-red-100 rounded-xl font-bold">تسجيل الخروج</button>
            </div>
        </section>

        <!-- PAGE: EDIT PROFILE (Separate Page) -->
        <section id="page-edit-profile" class="page-section hidden px-4 animate-fade">
            <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm space-y-4">
                <div class="flex flex-col items-center mb-4">
                    <div class="relative">
                        <img id="edit-img-preview" src="" class="w-24 h-24 rounded-full object-cover">
                        <button onclick="document.getElementById('edit-file').click()" class="absolute bottom-0 right-0 bg-blue-600 text-white p-2 rounded-full shadow-lg">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                        </button>
                    </div>
                    <input type="file" id="edit-file" class="hidden" accept="image/*" onchange="window.handleImageUpload(this, 'edit-img-preview', true)">
                </div>

                <div class="space-y-3">
                    <div><label class="text-xs text-gray-400">الاسم</label><input type="text" id="edit-name" class="w-full p-3 rounded-xl border dark:bg-gray-900 dark:border-gray-700"></div>
                    <div><label class="text-xs text-gray-400">الهاتف</label><input type="tel" id="edit-phone" class="w-full p-3 rounded-xl border dark:bg-gray-900 dark:border-gray-700"></div>
                    <div><label class="text-xs text-gray-400">المدينة</label>
                        <select id="edit-city" class="w-full p-3 rounded-xl border dark:bg-gray-900 dark:border-gray-700">
                            <option value="الزقازيق">الزقازيق</option><option value="بلبيس">بلبيس</option><option value="منيا القمح">منيا القمح</option><option value="فاقوس">فاقوس</option>
                            <option value="أبو كبير">أبو كبير</option><option value="الحسينية">الحسينية</option>
                        </select>
                    </div>
                    <div id="edit-prof-container" class="hidden">
                        <label class="text-xs text-gray-400">المهنة</label>
                        <select id="edit-prof" class="w-full p-3 rounded-xl border dark:bg-gray-900 dark:border-gray-700"></select>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="window.saveProfileChanges()" class="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold shadow-md">حفظ</button>
                    <button onclick="window.goBack()" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold">إلغاء</button>
                </div>
            </div>
        </section>

        <!-- PAGE: SETTINGS (Separate Page) -->
        <section id="page-settings" class="page-section hidden px-4 animate-fade">
            <div class="bg-white dark:bg-gray-800 rounded-2xl p-5 shadow-sm space-y-4 border dark:border-gray-700">
                <div class="flex justify-between items-center p-2">
                    <span class="font-bold">الوضع الليلي</span>
                    <input type="checkbox" id="theme-toggle" class="w-6 h-6 accent-blue-600" onchange="window.toggleTheme()">
                </div>
                <div class="flex justify-between items-center p-2 border-t dark:border-gray-700">
                    <span class="font-bold text-red-500">إخفاء الهاتف من الدليل</span>
                    <input type="checkbox" id="privacy-toggle" class="w-6 h-6 accent-red-500">
                </div>
                <button onclick="window.goBack()" class="w-full py-3 bg-gray-100 text-gray-600 rounded-xl font-bold mt-4">رجوع</button>
            </div>
        </section>

        <!-- PAGE: CHAT LIST -->
        <section id="page-chat" class="page-section hidden px-4 animate-fade">
            <div id="chat-history-list" class="space-y-2 pb-20">
                <p class="text-center text-gray-400 py-10">لا توجد محادثات</p>
            </div>
        </section>

        <!-- PAGE: CHAT ROOM -->
        <section id="page-chat-room" class="page-section hidden flex flex-col h-[calc(100vh-80px)] bg-white dark:bg-gray-900 fixed inset-0 z-[60] md:relative">
            <div class="h-16 bg-gray-50 dark:bg-gray-800 flex items-center px-4 gap-3 border-b dark:border-gray-700">
                <button onclick="window.goBack()"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>
                <h3 id="chat-room-name" class="font-bold text-lg">...</h3>
            </div>
            <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-100 dark:bg-gray-900"></div>
            <form id="form-message" class="p-3 bg-white dark:bg-gray-800 border-t dark:border-gray-700 flex gap-2">
                <input type="text" id="msg-input" class="flex-1 p-3 rounded-full bg-gray-100 dark:bg-gray-700 outline-none" placeholder="اكتب رسالة...">
                <button type="submit" class="p-3 bg-blue-600 text-white rounded-full"><svg class="w-5 h-5 transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg></button>
            </form>
        </section>

    </div>

    <!-- Bottom Navigation -->
    <nav id="nav-bar" class="hidden fixed bottom-0 left-0 right-0 h-20 bg-white dark:bg-gray-800 border-t dark:border-gray-700 flex justify-around items-center md:max-w-md md:mx-auto z-40 shadow-2xl">
        <button onclick="window.navTo('home')" class="nav-btn active flex flex-col items-center text-blue-600 w-16">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
            <span class="text-[10px] font-bold">الرئيسية</span>
        </button>
        <button onclick="window.navTo('directory')" class="nav-btn flex flex-col items-center text-gray-400 w-16 hover:text-blue-500">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
            <span class="text-[10px] font-bold">الدليل</span>
        </button>
        <div class="relative -top-6">
            <button onclick="window.navTo('add')" class="w-14 h-14 bg-gradient-to-br from-blue-600 to-blue-400 rounded-full flex items-center justify-center shadow-lg border-4 border-gray-50 dark:border-gray-900 text-white transform active:scale-90 transition-transform">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            </button>
        </div>
        <button onclick="window.navTo('chat')" class="nav-btn flex flex-col items-center text-gray-400 w-16 hover:text-blue-500">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
            <span class="text-[10px] font-bold">محادثات</span>
        </button>
        <button onclick="window.navTo('profile')" class="nav-btn flex flex-col items-center text-gray-400 w-16 hover:text-blue-500">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
            <span class="text-[10px] font-bold">حسابي</span>
        </button>
    </nav>

    <!-- LOGIC MODULE -->
    <script type="module">
        // Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, addDoc, where, updateDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Config
        const firebaseConfig = {
            apiKey: "AIzaSyA5OiTcX95GBgiJoDHnY3y7N23o-j8hsQ8",
            authDomain: "services-cef84.firebaseapp.com",
            databaseURL: "https://services-cef84-default-rtdb.firebaseio.com",
            projectId: "services-cef84",
            storageBucket: "services-cef84.firebasestorage.app",
            messagingSenderId: "902396219187",
            appId: "1:902396219187:web:3ba084a724266afa8bb846"
        };

        // Init
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const APP_ID = 'services-cef84';

        // --- DATA LISTS (UPDATED) ---
        const professions = [
            "محاسب", "مهندس مدني", "مهندس معماري", "طبيب بشري", "طبيب أسنان", "صيدلي", "ممرض", "محامي", "مدرس", "جرافيك ديزاينر",
            "مبرمج", "كاتب محتوى", "مسوق إلكتروني", "مترجم", "مدخل بيانات", "موظف استقبال", "سكرتير", "شيف", "ويتر", "باريستا",
            "سباك", "كهربائي", "نجار", "نقاش", "حداد", "لحام", "ميكانيكي سيارات", "عفشجي", "سمكري", "كهربائي سيارات", "سروجي سيارات",
            "فني تكييف", "فني دش", "فني غسالات", "فني ثلاجات", "فني فلاتر", "مبلط سيراميك", "مبيض محارة", "بناء", "مقاول", "فني الوميتال",
            "استورجي", "منجد", "ترزي", "جزمجي", "مكوجي", "حلاق", "كوافير", "ماكيير", "مصور", "فني طباعة", "فني كمبيوتر", "فني موبايل",
            "سائق خاص", "سائق تاكسي", "سائق نقل", "دليفري", "عامل نظافة", "عامل بوفيه", "عامل بناء", "عامل زراعي", "جنايني", "حارس عقار",
            "فني كاميرات", "فني شبكات", "فني مصاعد", "فني زجاج", "فني رخام", "فني جبس بورد", "فني باركيه", "خطاط", "رسام", "نحات", "صائغ",
            "ساعاتي", "فني مفاتيح", "فني اليكترونيات", "فني تحاليل", "فني أشعة", "أخصائي علاج طبيعي", "أخصائي تخاطب", "محفظ قرآن", "مأذون",
            "طباخ منزلي", "بيبي سيتر", "جليس مسنين", "مدرب جيم", "مدرب سباحة", "مدرب سواقة", "سمسار عقارات", "تاجر ملابس", "تاجر أغذية",
            "مندوب مبيعات", "كاشير", "مدير محل", "فني بصريات", "فني أسنان", "مدرب كرة قدم", "حكم", "يوتيوبر", "صانع محتوى"
        ];

        // Updated Category Map with Pexels Images & Better Grouping
        const categoryMap = {
            'طب وصحة': { 
                img: 'https://images.pexels.com/photos/40568/medical-appointment-doctor-healthcare-40568.jpeg?auto=compress&cs=tinysrgb&w=400', 
                keywords: ['طبيب', 'صيدلي', 'ممرض', 'علاج', 'تحاليل', 'أشعة', 'أسنان', 'بصريات', 'تخاطب'] 
            },
            'تشييد وبناء': { 
                img: 'https://images.pexels.com/photos/159306/construction-site-build-construction-work-159306.jpeg?auto=compress&cs=tinysrgb&w=400', 
                keywords: ['مهندس', 'مقاول', 'بناء', 'سيراميك', 'محارة', 'جبس', 'رخام', 'باركيه', 'الوميتال', 'زجاج'] 
            },
            'صيانة وحرف': { 
                img: 'https://images.pexels.com/photos/3212114/pexels-photo-3212114.jpeg?auto=compress&cs=tinysrgb&w=400', 
                keywords: ['سباك', 'كهربائي', 'نجار', 'نقاش', 'حداد', 'لحام', 'تكييف', 'دش', 'غسالات', 'ثلاجات', 'فلاتر', 'استورجي', 'منجد', 'مفاتيح', 'اليكترونيات', 'مصاعد'] 
            },
            'سيارات ونقل': { 
                img: 'https://images.pexels.com/photos/4489749/pexels-photo-4489749.jpeg?auto=compress&cs=tinysrgb&w=400', 
                keywords: ['ميكانيكي', 'عفشجي', 'سمكري', 'سيارات', 'سائق', 'نقل', 'دليفري', 'سروجي'] 
            },
            'تكنولوجيا وأعمال': { 
                img: 'https://images.pexels.com/photos/1181671/pexels-photo-1181671.jpeg?auto=compress&cs=tinysrgb&w=400', 
                keywords: ['مبرمج', 'كمبيوتر', 'موبايل', 'شبكات', 'كاميرات', 'جرافيك', 'محاسب', 'محامي', 'كاتب', 'مسوق', 'مترجم', 'بيانات', 'سكرتير', 'استقبال', 'يوتيوبر', 'صانع', 'طباعة'] 
            },
            'تعليم وتدريب': { 
                img: 'https://images.pexels.com/photos/5212345/pexels-photo-5212345.jpeg?auto=compress&cs=tinysrgb&w=400', 
                keywords: ['مدرس', 'محفظ', 'مدرب', 'حكم'] 
            },
            'خدمات شخصية': { 
                img: 'https://images.pexels.com/photos/1319460/pexels-photo-1319460.jpeg?auto=compress&cs=tinysrgb&w=400', 
                keywords: ['حلاق', 'كوافير', 'ماكيير', 'مصور', 'ترزي', 'جزمجي', 'مكوجي', 'ساعاتي', 'صائغ', 'خطاط', 'رسام', 'نحات', 'مأذون'] 
            },
            'طعام وضيافة': { 
                img: 'https://images.pexels.com/photos/1267320/pexels-photo-1267320.jpeg?auto=compress&cs=tinysrgb&w=400', 
                keywords: ['شيف', 'ويتر', 'باريستا', 'طباخ'] 
            },
            'عمالة وخدمات': {
                img: 'https://images.pexels.com/photos/380769/pexels-photo-380769.jpeg?auto=compress&cs=tinysrgb&w=400',
                keywords: ['نظافة', 'بوفيه', 'زراعي', 'جنايني', 'حارس', 'بيبي', 'جليس']
            },
            'تجارة ومبيعات': {
                img: 'https://images.pexels.com/photos/955081/pexels-photo-955081.jpeg?auto=compress&cs=tinysrgb&w=400',
                keywords: ['مندوب', 'كاشير', 'مدير', 'تاجر', 'سمسار']
            }
        };

        // --- GLOBAL STATE ---
        let currentUser = null;
        let userProfile = null;
        let navStack = ['home']; // History Stack
        let tempImgBase64 = null;
        let currentChatId = null;
        let allUsersCache = [];

        // --- UTILITIES ---
        window.showToast = (msg, type = 'success') => {
            const box = document.getElementById('toast-box');
            const el = document.createElement('div');
            el.className = `toast-msg ${type}`;
            el.innerText = msg;
            box.appendChild(el);
            requestAnimationFrame(() => el.classList.add('show'));
            setTimeout(() => {
                el.classList.remove('show');
                setTimeout(() => el.remove(), 300);
            }, 3000);
        };

        // Image Compression Logic (Canvas)
        window.handleImageUpload = async (input, previewId, isEdit = false) => {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (file.size > 5 * 1024 * 1024) return window.showToast('حجم الصورة كبير جداً', 'error');
                
                // Compress
                const compressed = await compressImage(file);
                tempImgBase64 = compressed;
                document.getElementById(previewId).src = compressed;
            }
        };

        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 600; // Resize to max 600px width
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        // Convert to JPEG 0.7 quality
                        resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                    }
                }
            });
        }

        // --- NAVIGATION SYSTEM ---
        window.navTo = (pageId) => {
            // Hide all pages
            document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
            
            // Stack Logic
            if (pageId === 'home') {
                navStack = ['home']; // Reset stack
            } else if (navStack[navStack.length - 1] !== pageId) {
                navStack.push(pageId);
            }

            // Show Target
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            
            // Header Update
            const headerTitle = document.getElementById('page-title');
            const backBtn = document.getElementById('btn-back');
            
            if (pageId === 'home') {
                headerTitle.innerText = 'الرئيسية';
                backBtn.classList.add('hidden');
            } else {
                backBtn.classList.remove('hidden');
                // Dynamic Titles
                const titles = { directory: 'الدليل', add: 'إضافة', chat: 'المحادثات', profile: 'حسابي', 'category-details': 'تفاصيل القسم', 'chat-room': 'محادثة' };
                headerTitle.innerText = titles[pageId] || 'صفحة';
            }

            // Bottom Nav Highlight
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('text-blue-600', 'active'));
            const navMap = { 'home': 0, 'directory': 1, 'chat': 3, 'profile': 4 }; // indices
            if (navMap[pageId] !== undefined) {
                document.querySelectorAll('.nav-btn')[navMap[pageId]].classList.add('text-blue-600');
            }
        };

        window.goBack = () => {
            if (navStack.length > 1) {
                navStack.pop(); // Remove current
                const prevPage = navStack[navStack.length - 1];
                // Manually call show logic without pushing to stack again
                document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
                document.getElementById(`page-${prevPage}`).classList.remove('hidden');
                
                // Update Header
                const backBtn = document.getElementById('btn-back');
                if (prevPage === 'home') {
                    document.getElementById('page-title').innerText = 'الرئيسية';
                    backBtn.classList.add('hidden');
                } else {
                    backBtn.classList.remove('hidden');
                }
            }
        };

        // --- INITIALIZATION ---
        function initApp() {
            // Populate all select inputs
            const selects = ['signup-prof', 'req-prof', 'edit-prof'];
            const opts = professions.map(p => `<option value="${p}">${p}</option>`).join('');
            selects.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.innerHTML = '<option value="">اختر المهنة...</option>' + opts;
            });

            // Build Home Categories Grid
            const grid = document.getElementById('categories-grid');
            grid.innerHTML = '';
            Object.entries(categoryMap).forEach(([catName, data]) => {
                grid.innerHTML += `
                    <div onclick="window.openCategory('${catName}')" class="relative h-28 rounded-xl overflow-hidden cursor-pointer shadow-sm transform hover:scale-105 transition-transform">
                        <img src="${data.img}" class="absolute inset-0 w-full h-full object-cover">
                        <div class="absolute inset-0 prof-card-overlay flex items-end p-3">
                            <p class="text-white font-bold text-sm shadow-black drop-shadow-md">${catName}</p>
                        </div>
                    </div>
                `;
            });
        }

        // --- AUTH LOGIC ---
        window.switchAuthMode = (mode) => {
            if (mode === 'login') {
                document.getElementById('form-login').classList.remove('hidden');
                document.getElementById('form-signup').classList.add('hidden');
                document.getElementById('btn-mode-login').classList.add('bg-white', 'shadow', 'text-blue-600');
                document.getElementById('btn-mode-signup').classList.remove('bg-white', 'shadow', 'text-blue-600');
            } else {
                document.getElementById('form-login').classList.add('hidden');
                document.getElementById('form-signup').classList.remove('hidden');
                document.getElementById('btn-mode-signup').classList.add('bg-white', 'shadow', 'text-blue-600');
                document.getElementById('btn-mode-login').classList.remove('bg-white', 'shadow', 'text-blue-600');
            }
        };

        window.toggleProfVisibility = (show) => {
            document.getElementById('prof-container').style.display = show ? 'block' : 'none';
        };

        // Login Handler
        document.getElementById('form-login').onsubmit = async (e) => {
            e.preventDefault();
            document.getElementById('loader').classList.remove('hidden');
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pass').value);
            } catch (err) {
                window.showToast('خطأ في البيانات', 'error');
                document.getElementById('loader').classList.add('hidden');
            }
        };

        // Signup Handler
        document.getElementById('form-signup').onsubmit = async (e) => {
            e.preventDefault();
            document.getElementById('loader').classList.remove('hidden');
            try {
                const email = document.getElementById('signup-email').value;
                const pass = document.getElementById('signup-pass').value;
                const role = document.querySelector('input[name="role"]:checked').value;
                const prof = role === 'provider' ? document.getElementById('signup-prof').value : null;
                
                if (role === 'provider' && !prof) throw new Error('يرجى اختيار المهنة');

                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                const photo = tempImgBase64 || `https://ui-avatars.com/api/?name=${document.getElementById('signup-name').value}&background=random`;

                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'profiles', cred.user.uid), {
                    uid: cred.user.uid,
                    name: document.getElementById('signup-name').value,
                    phone: document.getElementById('signup-phone').value,
                    city: document.getElementById('signup-city').value,
                    role, profession: prof, photoURL: photo,
                    createdAt: new Date().toISOString()
                });

                window.showToast('تم التسجيل بنجاح');
                e.target.reset(); // Smart reset
            } catch (err) {
                window.showToast(err.message, 'error');
                document.getElementById('loader').classList.add('hidden');
            }
        };

        // --- CORE LISTENER ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                // Load Profile
                const snap = await getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'profiles', user.uid));
                if (snap.exists()) {
                    userProfile = snap.data();
                    // Setup UI
                    document.getElementById('auth-view').classList.add('hidden');
                    document.getElementById('app-view').classList.remove('hidden');
                    document.getElementById('app-header').classList.remove('hidden');
                    document.getElementById('nav-bar').classList.remove('hidden');
                    document.getElementById('header-avatar').src = userProfile.photoURL;
                    
                    // Pre-fill Profile Page
                    document.getElementById('prof-name-view').innerText = userProfile.name;
                    document.getElementById('prof-role-view').innerText = userProfile.role === 'provider' ? userProfile.profession : 'عميل';
                    document.getElementById('prof-phone-view').innerText = userProfile.phone;
                    document.getElementById('prof-img-view').src = userProfile.photoURL;
                    
                    // Pre-fill Edit Form
                    document.getElementById('edit-name').value = userProfile.name;
                    document.getElementById('edit-phone').value = userProfile.phone;
                    document.getElementById('edit-city').value = userProfile.city || '';
                    document.getElementById('edit-img-preview').src = userProfile.photoURL;
                    if (userProfile.role === 'provider') {
                        document.getElementById('edit-prof-container').classList.remove('hidden');
                        document.getElementById('edit-prof').value = userProfile.profession;
                    }

                    initApp();
                    startListeners();
                    window.navTo('home');
                }
                document.getElementById('loader').classList.add('hidden');
            } else {
                // Reset
                document.getElementById('app-view').classList.add('hidden');
                document.getElementById('app-header').classList.add('hidden');
                document.getElementById('nav-bar').classList.add('hidden');
                document.getElementById('auth-view').classList.remove('hidden');
                document.getElementById('loader').classList.add('hidden');
            }
        });

        // --- DATA LISTENERS ---
        function startListeners() {
            // 1. Directory Listener (Cached)
            onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'profiles'), (snap) => {
                allUsersCache = [];
                snap.forEach(d => {
                    if (d.id !== currentUser.uid && d.data().role === 'provider') {
                        allUsersCache.push(d.data());
                    }
                });
                window.renderDirectory();
            });

            // 2. Jobs Listener
            onSnapshot(query(collection(db, 'artifacts', APP_ID, 'public', 'data', 'requests'), where('type', '==', 'job')), (snap) => {
                const list = document.getElementById('view-jobs');
                list.innerHTML = '';
                if (snap.empty) list.innerHTML = '<p class="text-center text-gray-400 py-10">لا توجد وظائف</p>';
                snap.forEach(d => {
                    const j = d.data();
                    list.innerHTML += `
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border-r-4 border-purple-500">
                            <h3 class="font-bold text-gray-800 dark:text-white">${j.title}</h3>
                            <p class="text-sm text-gray-500 mt-1">${j.desc}</p>
                        </div>
                    `;
                });
            });

            // 3. My Activity
            onSnapshot(query(collection(db, 'artifacts', APP_ID, 'public', 'data', 'requests'), where('uid', '==', currentUser.uid)), (snap) => {
                const list = document.getElementById('my-activity');
                list.innerHTML = '';
                if (snap.empty) list.innerHTML = '<p class="text-center text-gray-400 text-sm">لا يوجد نشاط</p>';
                snap.forEach(d => {
                    const j = d.data();
                    list.innerHTML += `
                        <div class="bg-gray-50 dark:bg-gray-700 p-2 rounded text-sm flex justify-between">
                            <span>${j.type==='job' ? 'وظيفة: '+j.title : 'طلب: '+j.profession}</span>
                            <span class="text-green-500 font-bold">نشط</span>
                        </div>
                    `;
                });
            });
        }

        // --- CATEGORY LOGIC (SEPARATE PAGE) ---
        window.openCategory = (catName) => {
            window.navTo('category-details');
            document.getElementById('page-title').innerText = catName;
            
            const keywords = categoryMap[catName].keywords;
            // Improved filtering logic: Check if any keyword matches profession
            const filtered = allUsersCache.filter(u => 
                keywords.some(k => u.profession.includes(k))
            );
            
            const cont = document.getElementById('cat-list-container');
            cont.innerHTML = '';
            if (filtered.length === 0) {
                cont.innerHTML = '<p class="text-center text-gray-400 py-10">لا يوجد مقدمي خدمة في هذا القسم حالياً</p>';
                return;
            }
            
            filtered.forEach(u => {
                cont.innerHTML += createUserCard(u);
            });
        };

        function createUserCard(u) {
            return `
                <div class="bg-white dark:bg-gray-800 p-3 rounded-xl shadow-sm flex items-center gap-3 border dark:border-gray-700">
                    <img src="${u.photoURL}" class="w-12 h-12 rounded-full object-cover bg-gray-200">
                    <div class="flex-1">
                        <h4 class="font-bold text-sm dark:text-white">${u.name}</h4>
                        <p class="text-xs text-blue-600 font-bold">${u.profession}</p>
                        <p class="text-xs text-gray-400">${u.city}</p>
                    </div>
                    <div class="flex gap-2">
                        <a href="https://wa.me/${u.phone}" target="_blank" class="p-2 bg-green-100 text-green-600 rounded-full"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.232-.297.347-.497.114-.198.06-.371-.03-.496-.09-.124-.8-1.928-1.09-2.641-.283-.692-.572-.6-.789-.608l-.67-.007c-.231 0-.606.088-.922.434-.317.347-1.212 1.185-1.212 2.892 0 1.706 1.243 3.356 1.416 3.584.173.228 2.444 3.732 5.92 5.228.827.357 1.473.571 1.974.73.831.264 1.588.227 2.184.138.668-.1 2.052-.839 2.34-1.649.287-.811.287-1.505.201-1.649-.086-.144-.317-.228-.614-.377z"/></svg></a>
                        <button onclick="window.openChat('${u.uid}', '${u.name}')" class="p-2 bg-blue-100 text-blue-600 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg></button>
                    </div>
                </div>
            `;
        }

        window.filterCategoryList = () => {
            // Simple inline search within the opened category
            const term = document.getElementById('cat-search').value.toLowerCase();
            const container = document.getElementById('cat-list-container');
            const cards = container.getElementsByTagName('div');
            
            // Note: This logic is simplified for DOM manipulation of already rendered cards
            // In a real production app with virtual DOM, this would be state-based
            Array.from(cards).forEach(card => {
                if(card.className.includes('bg-white')) { // Check if it's a card
                   const text = card.innerText.toLowerCase();
                   card.style.display = text.includes(term) ? 'flex' : 'none';
                }
            });
        };

        window.renderDirectory = () => {
            const cont = document.getElementById('dir-list');
            cont.innerHTML = '';
            allUsersCache.forEach(u => cont.innerHTML += createUserCard(u));
        };

        window.filterDirectory = () => {
            const term = document.getElementById('dir-search').value;
            const filtered = allUsersCache.filter(u => u.name.includes(term) || u.profession.includes(term));
            const cont = document.getElementById('dir-list');
            cont.innerHTML = '';
            filtered.forEach(u => cont.innerHTML += createUserCard(u));
        };

        // --- CHAT LOGIC ---
        window.openChat = (uid, name) => {
            currentChatId = [currentUser.uid, uid].sort().join('_');
            document.getElementById('chat-room-name').innerText = name;
            window.navTo('chat-room');
            
            const msgsRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'chats', currentChatId, 'messages');
            onSnapshot(query(msgsRef, orderBy('createdAt', 'asc')), (snap) => {
                const box = document.getElementById('messages-container');
                box.innerHTML = '';
                snap.forEach(d => {
                    const m = d.data();
                    const isMe = m.senderId === currentUser.uid;
                    box.innerHTML += `
                        <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                            <div class="max-w-[75%] p-3 rounded-2xl text-sm ${isMe ? 'bg-blue-600 text-white rounded-br-none' : 'bg-white dark:bg-gray-800 text-gray-800 dark:text-white rounded-bl-none shadow-sm'}">
                                ${m.text}
                            </div>
                        </div>
                    `;
                });
                box.scrollTop = box.scrollHeight;
            });
        };

        document.getElementById('form-message').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text || !currentChatId) return;
            
            await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'chats', currentChatId, 'messages'), {
                text, senderId: currentUser.uid, createdAt: new Date().toISOString()
            });
            input.value = '';
        };

        // --- PROFILE EDIT ---
        window.saveProfileChanges = async () => {
            try {
                const newName = document.getElementById('edit-name').value;
                const newPhone = document.getElementById('edit-phone').value;
                const newCity = document.getElementById('edit-city').value;
                const newProf = document.getElementById('edit-prof').value;
                
                await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'profiles', currentUser.uid), {
                    name: newName, phone: newPhone, city: newCity, 
                    profession: userProfile.role === 'provider' ? newProf : null,
                    photoURL: tempImgBase64 || userProfile.photoURL
                });
                
                window.showToast('تم حفظ التعديلات');
                window.location.reload(); // Reload to refresh all UI cleanly
            } catch (e) { window.showToast('خطأ في الحفظ', 'error'); }
        };

        // --- ADD REQUESTS ---
        window.switchAddMode = (mode) => {
            if (mode === 'req') {
                document.getElementById('form-req').classList.remove('hidden');
                document.getElementById('form-job').classList.add('hidden');
                document.getElementById('btn-add-req').classList.add('bg-blue-50', 'text-blue-600');
                document.getElementById('btn-add-job').classList.remove('bg-blue-50', 'text-blue-600');
            } else {
                document.getElementById('form-job').classList.remove('hidden');
                document.getElementById('form-req').classList.add('hidden');
                document.getElementById('btn-add-job').classList.add('bg-blue-50', 'text-blue-600');
                document.getElementById('btn-add-req').classList.remove('bg-blue-50', 'text-blue-600');
            }
        };

        document.getElementById('form-req').onsubmit = async (e) => {
            e.preventDefault();
            await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'requests'), {
                type: 'service', 
                profession: document.getElementById('req-prof').value,
                desc: document.getElementById('req-desc').value,
                uid: currentUser.uid, createdAt: new Date().toISOString()
            });
            window.showToast('تم النشر');
            e.target.reset();
            window.goBack();
        };

        // --- HOME TABS ---
        window.switchHomeTab = (tab) => {
            if (tab === 'services') {
                document.getElementById('view-services').classList.remove('hidden');
                document.getElementById('view-jobs').classList.add('hidden');
                document.getElementById('tab-home-serv').classList.add('bg-blue-50', 'text-blue-600');
                document.getElementById('tab-home-jobs').classList.remove('bg-blue-50', 'text-blue-600');
            } else {
                document.getElementById('view-services').classList.add('hidden');
                document.getElementById('view-jobs').classList.remove('hidden');
                document.getElementById('tab-home-jobs').classList.add('bg-blue-50', 'text-blue-600');
                document.getElementById('tab-home-serv').classList.remove('bg-blue-50', 'text-blue-600');
            }
        };

        window.logout = () => {
            signOut(auth);
            window.navStack = ['home'];
        };
        
        // Toggle Theme
        window.toggleTheme = () => {
            document.documentElement.classList.toggle('dark');
        };

    </script>
</body>
</html>

