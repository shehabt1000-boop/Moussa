<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Ø´Ø§Øª Ø´Ù‡Ø§Ø¨</title>








  <!-- === [!!] Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¬Ø¹Ù„Ù‡ ØªØ·Ø¨ÙŠÙ‚Ø§Ù‹ [!!] === -->








  <!-- Ù„ÙˆÙ† Ø´Ø±ÙŠØ· Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ø¹Ù„ÙˆÙŠ (Ù„Ù„Ù‡Ø§ØªÙ) -->
  <meta name="theme-color" content="#0a3d62">








  <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ø£Ø¬Ù‡Ø²Ø© Ø¢Ø¨Ù„ -->
  <link rel="apple-touch-icon" href="https://placehold.co/180x180/0a3d62/FFF?text=Chat">








  <!-- Ù…Ù„Ù Manifest (ÙŠØ®Ø¨Ø± Ø§Ù„Ù…ØªØµÙØ­ Ø£Ù† Ù‡Ø°Ø§ ØªØ·Ø¨ÙŠÙ‚) -->
  <!-- (ØªÙ… ØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ ÙƒÙˆØ¯ Base64 Ù„ÙŠØ¨Ù‚Ù‰ ÙÙŠ Ù…Ù„Ù ÙˆØ§Ø­Ø¯) -->
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQ2hhdCBTaGVoYWIiLCJzaG9ydF9uYW1lIjoiQ2hhdCBTaGVoYWIiLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2Y1ZjVmNSIsInRoZW1lX2NvbG9yIjoiIzBhM2Q2MiIsImRlc2NyaXB0aW9uIjoi2LXZhNmK2LEg2KrYsdioINiR2LPQsCDYrtix06rZhNmLIiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vcGxhY2Vob2xkLmNvLzE5MngxOTIvMGEzZDYyL0ZGRj90ZXh0PUNoYXQiLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn0seyJzcmMiOiJodHRwczovL3BsYWNlaG9sZC5jby81MTJ4NTEyLzBhM2Q2Mi9GRkY/dGV4dD1DaGF0Iiwic2l6ZXMiOiI1MTJ4NTEyIiwidHlwZSI6ImltYWdlL3BuZyJ9XX0=">








  <!-- === Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© === -->








  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ø£Ø­Ø¬Ø§Ù… */
    :root {
      --primary-dark: #0a3d62;
      --primary-light: #000;
      --accent-color: #25d366;
      --danger-color: #c0392b;
      --wa-sent-bubble-bg: #e1ffc7;
      --wa-recv-bubble-bg: #ffffff;
      --background-color: #fafafa;
      --text-dark: #333;
      --text-light: #ffffff;
      --font-size: 12px; /* <--- ØªÙ… ØªØµØºÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø®Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
      --bubble-padding: 4px 8px; /* <--- ØªÙ… ØªØµØºÙŠØ± Ø§Ù„Ø­Ø´Ùˆ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù„ÙÙ‚Ø§Ø¹Ø§Øª */
      --main-bg-gradient: linear-gradient(90deg, var(--primary-light), var(--primary-dark));
      --card-bg-color: #ffffff;
      --border-color: #eee;
      --body-bg: #f5f5f5;
      --input-bar-height: 50px; /* <--- [ØªØ¹Ø¯ÙŠÙ„] Ø§Ø±ØªÙØ§Ø¹ ØªÙ‚Ø±ÙŠØ¨ÙŠ Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
    }
    * { box-sizing: border-box; }
    html { 
      height: 100%; 
    }
    /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ø³Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
    body {
      height: 100%;
      margin: 0;
      font-family: "Cairo", Arial, sans-serif;
      background-color: var(--body-bg);
      display: block; 
    }
    /* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ */
    .chat-container {
      width: 100%;
      height: 100%;
      height: 100dvh; 
      background: var(--background-color);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }
    /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ (Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©) */
    .chat-header {
      display: flex; align-items: center; gap: 10px; padding: 8px;
      background: var(--main-bg-gradient); color: var(--text-light); position: relative; z-index: 10;
      flex-shrink: 0;
    }
    .chat-header .avatar {
      width: 36px; /* <--- ØªØµØºÙŠØ± */
      height: 36px; /* <--- ØªØµØºÙŠØ± */
      border-radius: 50%; border: 2px solid var(--text-light); object-fit: cover;
    }
    .chat-header .title { margin: 0; font-size: 17px; font-weight: 800; } /* <--- ØªØµØºÙŠØ± */
    .logout-btn {
      margin-right: auto; padding: 5px 8px; /* <--- ØªØµØºÙŠØ± */
      background: linear-gradient(90deg, #c0392b, #e74c3c);
      color: var(--text-light); border: none; border-radius: 20px; cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25); 
      font-size: calc(var(--font-size) - 1px); /* <--- ØªØµØºÙŠØ± */
      white-space: nowrap;
    }
    /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ (Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©ØŒ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡...) */
    .chat-nav {
      display: flex; background: var(--main-bg-gradient); position: relative; z-index: 10;
      flex-shrink: 0;
    }
    .nav-btn {
      flex: 1; padding: 8px 4px; /* <--- ØªØµØºÙŠØ± */
      background: transparent; border: none;
      color: var(--text-light); 
      font-size: var(--font-size); 
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .nav-btn.active { background: rgba(255,255,255,0.08); }
    /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø© */
    .chat-content { 
        flex: 1; display: flex; flex-direction: column; min-height: 0; position: relative; 
        /* [ØªØ¹Ø¯ÙŠÙ„] Ø¥Ø¶Ø§ÙØ© Ø­Ø´Ùˆ Ø³ÙÙ„ÙŠ Ù„ØªØ¹ÙˆÙŠØ¶ Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø«Ø§Ø¨Øª */
        padding-bottom: var(--input-bar-height); 
    }
    /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ù…Ø®ÙÙŠØ©) */
    .page {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        display: flex; flex-direction: column; min-height: 0;
        visibility: hidden; opacity: 0;
        transition: opacity 0.2s ease-in-out, visibility 0.2s;
        pointer-events: none;
    }
    .page.active {
        visibility: visible; opacity: 1; z-index: 5;
        pointer-events: auto;
    }
    /* --- ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø¶Ø§ÙØ© ØªØ«Ø¨ÙŠØª Ù„Ù„Ø®Ù„ÙÙŠØ© --- */
    .chat-page {
      background-size: cover; 
      background-position: center; 
      background-repeat: no-repeat;
      background-attachment: scroll; /* <--- ØªÙ… ØªØºÙŠÙŠØ±Ù‡Ø§ Ø¥Ù„Ù‰ scroll Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙÙŠ Ø§Ù„Ù‡Ø§ØªÙ */
      background-color: #f0f2f5;
      transition: background-image 0.3s ease-in-out;
    }
    /* Ø­Ø§ÙˆÙŠØ© Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
    .messages {
      flex: 1; padding: 8px 6px; /* <--- ØªØµØºÙŠØ± Ø§Ù„Ù‡ÙˆØ§Ù…Ø´ */
      padding-bottom: var(--input-bar-height); /* <--- [ØªØ¹Ø¯ÙŠÙ„] Ø¥Ø¶Ø§ÙØ© Ø­Ø´Ùˆ Ø³ÙÙ„ÙŠ Ø¨Ø§Ø±ØªÙØ§Ø¹ Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
      overflow-y: auto; display: flex; flex-direction: column;
      gap: 5px; /* <--- ØªÙ… ØªØµØºÙŠØ± Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„ÙÙ‚Ø§Ø¹Ø§Øª */
      background-color: transparent;
    }
    .load-more-container {
        display: flex;
        justify-content: center;
        padding: 6px; /* <--- ØªØµØºÙŠØ± */
    }
    .load-more-btn {
        background: var(--primary-dark);
        color: var(--text-light);
        border: none;
        padding: 6px 12px; /* <--- ØªØµØºÙŠØ± */
        border-radius: 20px;
        cursor: pointer;
        font-size: calc(var(--font-size) - 1px); /* <--- ØªØµØºÙŠØ± */
    }
    .load-more-btn:disabled {
        background: #999;
        cursor: not-allowed;
    }
    .welcome-message {
        text-align: center; margin: 15px auto; padding: 8px 12px; /* <--- ØªØµØºÙŠØ± */
        background-color: rgba(255, 255, 255, 0.8); border-radius: 10px; /* <--- ØªØµØºÙŠØ± */
        color: var(--text-dark); max-width: 80%;
    }
    /* Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø®Ø§Øµ Ø¨ÙƒÙ„ Ø±Ø³Ø§Ù„Ø© (Ù„ØªØ­Ø¯ÙŠØ¯ ÙŠÙ…ÙŠÙ†/ÙŠØ³Ø§Ø±) */
    .message-row { display: flex; align-items: flex-end; gap: 6px; /* <--- ØªØµØºÙŠØ± */ max-width: 85%; position: relative; }
    .message-row.sent { align-self: flex-end; flex-direction: row-reverse; }
    .message-row.recv { align-self: flex-start; flex-direction: row; max-width: 75%; }
    /* ØªØ¹Ø¯ÙŠÙ„: ØªØµØºÙŠØ± Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø±Ø³Ù„ (Ø§Ù„Ø®Ø§ØµØ© Ø¨ÙŠ) */
    .chat-avatar { width: 24px; height: 24px; /* <--- ØªØµØºÙŠØ± */ border-radius: 50%; object-fit: cover; margin-bottom: 3px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
















    /* ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù†ÙØ³Ù‡Ø§ (Ø§Ù„Ø®Ù„ÙÙŠØ© ÙˆØ§Ù„Ù‡ÙˆØ§Ù…Ø´) */
    .bubble {
      padding: var(--bubble-padding); 
      border-radius: 10px; /* <--- ØªØµØºÙŠØ± */
      line-height: 1.4; /* <--- ØªØµØºÙŠØ± */
      word-wrap: break-word;
      width: fit-content; 
      font-size: var(--font-size); 
      box-shadow: 0 1px 1px rgba(0,0,0,0.1);
      position: relative; color: var(--text-dark);
      text-shadow: 0 1px 1px rgba(0,0,0,0.2);
      transition: padding 0.2s ease-in-out;
    }
    .bubble.sent { background: var(--wa-sent-bubble-bg); border-top-right-radius: 0; }
    .bubble.recv { background: var(--wa-recv-bubble-bg); border: 1px solid var(--border-color); border-top-left-radius: 0; }
    .bubble-content { display: flex; flex-direction: column; }
    /* ØªØ¹Ø¯ÙŠÙ„: ØªØµØºÙŠØ± Ø®Ø· Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„ */
    .bubble-sender {
      font-size: calc(var(--font-size) - 2px); /* <--- ØªØµØºÙŠØ± */
      font-weight: bold; color: var(--primary-dark);
      margin-bottom: 1px; /* <--- ØªØµØºÙŠØ± */
      display: flex; align-items: center; gap: 3px; /* <--- ØªØµØºÙŠØ± */
    }
    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù‚ØªØ¨Ø§Ø³ Ø§Ù„Ø±Ø¯ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© */
    .reply-quote {
        background-color: rgba(0,0,0,0.05);
        border-right: 3px solid var(--accent-color);
        padding: 3px 6px; /* <--- ØªØµØºÙŠØ± */
        margin-bottom: 3px; /* <--- ØªØµØºÙŠØ± */
        border-radius: 3px; /* <--- ØªØµØºÙŠØ± */
        font-size: calc(var(--font-size) - 2px); /* <--- ØªØµØºÙŠØ± */
        max-height: 40px; /* <--- ØªØµØºÙŠØ± */
        overflow: hidden;
    }
    .reply-quote-name {
        font-weight: bold;
        color: var(--accent-color);
        margin-bottom: 1px; /* <--- ØªØµØºÙŠØ± */
    }
    .reply-quote-text {
        color: #777;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    /* ØªØ¹Ø¯ÙŠÙ„: ØªØµØºÙŠØ± Ø®Ø· ÙˆÙ‚Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ */
    .timestamp {
        font-size: 9px; /* <--- ØªØµØºÙŠØ± */
        color: #667781; text-align: left;
        margin-top: 3px; /* <--- ØªØµØºÙŠØ± */
        direction: ltr; text-shadow: none;
    }








    /* === [Ø¬Ø¯ÙŠØ¯] ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª === */
    .reactions-container {
        position: absolute;
        bottom: -10px; /* ÙŠØ±ÙØ¹Ù‡Ø§ Ù‚Ù„ÙŠÙ„Ø§Ù‹ ÙÙˆÙ‚ Ø§Ù„Ø­Ø§ÙØ© */
        right: 0;
        background: var(--card-bg-color);
        border-radius: 10px;
        padding: 1px 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        display: flex;
        gap: 3px;
        font-size: 10px;
        z-index: 2;
        border: 1px solid var(--border-color);
    }
    .reaction-item {
        display: flex;
        align-items: center;
        gap: 1px;
        padding: 1px 2px;
        border-radius: 8px;
        background: rgba(0,0,0,0.05);
        cursor: pointer;
    }
    .reaction-item:hover {
        background: rgba(0,0,0,0.1);
    }
    .reaction-count {
        font-size: 8px;
        color: var(--text-dark);
        font-weight: bold;
    }
    /* === Ù†Ù‡Ø§ÙŠØ© ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª === */








    /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
    .chat-input {
      display: flex; align-items: center; gap: 6px; /* <--- ØªØµØºÙŠØ± */ padding: 5px; /* <--- ØªØµØºÙŠØ± */
      background: var(--main-bg-gradient); border-top: 1px solid rgba(255,255,255,0.08);
      direction: ltr; 
      position: fixed; /* <--- [ØªØ¹Ø¯ÙŠÙ„] ØªØ«Ø¨ÙŠØª Ø§Ù„Ø´Ø±ÙŠØ· */
      bottom: 0; /* <--- ØªØ«Ø¨ÙŠØªÙ‡ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ */
      left: 0; /* <--- ÙŠÙ…ØªØ¯ Ø¹Ù„Ù‰ ÙƒØ§Ù…Ù„ Ø§Ù„Ø¹Ø±Ø¶ */
      right: 0; /* <--- ÙŠÙ…ØªØ¯ Ø¹Ù„Ù‰ ÙƒØ§Ù…Ù„ Ø§Ù„Ø¹Ø±Ø¶ */
      z-index: 100; /* <--- [Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© 2] Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù€ z-index */
      height: var(--input-bar-height); /* <--- [ØªØ¹Ø¯ÙŠÙ„] ØªØ­Ø¯ÙŠØ¯ Ø§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨Øª */
    }
    /* Ø­Ø§ÙˆÙŠØ© Ø§Ù‚ØªØ¨Ø§Ø³ Ø§Ù„Ø±Ø¯ ÙÙˆÙ‚ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
    .reply-quote-container-wrapper {
        position: fixed; /* <--- [ØªØ¹Ø¯ÙŠÙ„] ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙˆØ¶Ø¹ */
        bottom: var(--input-bar-height); /* <--- [ØªØ¹Ø¯ÙŠÙ„] ÙˆØ¶Ø¹Ù‡ ÙÙˆÙ‚ Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø«Ø§Ø¨Øª */
        left: 0;
        right: 0;
        z-index: 99; /* <--- ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù†ÙØ³Ù‡ */
        padding: 0 5px; /* <--- Ù‡Ø§Ù…Ø´ Ù…Ù† Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠÙ† */
        margin-bottom: 3px; /* <--- [Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© 1] Ù…Ø³Ø§ÙØ© Ø¨Ø³ÙŠØ·Ø© ÙÙˆÙ‚ Ø¨Ø§Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø© */
    }
    .reply-quote-container {
        background: var(--card-bg-color);
        padding: 6px 10px; /* <--- ØªØµØºÙŠØ± */
        border-top-left-radius: 10px; /* <--- ØªØµØºÙŠØ± */
        border-top-right-radius: 10px; /* <--- ØªØµØºÙŠØ± */
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 8px; /* <--- ØªØµØºÙŠØ± */
        box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        max-height: 45px; /* <--- ØªØµØºÙŠØ± Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ÙƒÙ„ÙŠ */
        max-width: 95%; /* <--- ØªØµØºÙŠØ± Ø§Ù„Ø¹Ø±Ø¶ Ù…Ù† Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠÙ† */
        margin: 0 auto; /* <--- ØªÙˆØ³ÙŠØ· Ø§Ù„Ø­Ø§ÙˆÙŠØ© */
    }
    .reply-quote-content {
        flex: 1;
        border-right: 3px solid var(--primary-dark);
        padding-right: 6px; /* <--- ØªØµØºÙŠØ± */
        max-height: 35px; /* <--- ØªØµØºÙŠØ± */
        overflow: hidden;
    }
    .reply-quote-content .reply-quote-name {
        font-size: 11px; /* <--- ØªØµØºÙŠØ± */
        font-weight: bold;
        color: var(--primary-dark);
        margin-bottom: 1px;
    }
    .reply-quote-content .reply-quote-text {
        font-size: 10px; /* <--- ØªØµØºÙŠØ± */
        color: var(--text-dark);
    }
    .reply-quote-close {
        background: none;
        border: none;
        color: var(--danger-color);
        font-size: 16px; /* <--- ØªØµØºÙŠØ± */
        cursor: pointer;
        padding: 0;
        flex-shrink: 0;
    }
    /* ØªØ¹Ø¯ÙŠÙ„: ØªØµØºÙŠØ± Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
    .msg-input {
      flex: 1; padding: 7px 10px; /* <--- ØªØµØºÙŠØ± */
      border-radius: 20px; /* <--- ØªØµØºÙŠØ± */
      border: 1px solid #ccc;
      outline: none; background: var(--text-light); 
      font-size: var(--font-size); /* <--- ØªØµØºÙŠØ± */
      direction: rtl;
    }
    /* ØªØ¹Ø¯ÙŠÙ„: ØªØµØºÙŠØ± Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ */
    .send-btn {
      width: 36px; height: 36px; /* <--- ØªØµØºÙŠØ± */
      border: none; border-radius: 50%; background: var(--accent-color);
      color: var(--text-light); font-size: 16px; /* <--- ØªØµØºÙŠØ± */
      cursor: pointer; display: flex;
      align-items: center; justify-content: center; box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    }
    /* [Ø¬Ø¯ÙŠØ¯] Ø²Ø± Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ */
    .emoji-btn {
        width: 36px; height: 36px; /* <--- ØªØµØºÙŠØ± */
        border: none; border-radius: 50%; background: #f39c12;
        color: var(--text-light); font-size: 16px; /* <--- ØªØµØºÙŠØ± */
        cursor: pointer; display: flex;
        align-items: center; justify-content: center; box-shadow: 0 2px 6px rgba(0,0,0,0.25);
        flex-shrink: 0;
    }








    /* === [Ø¬Ø¯ÙŠØ¯] Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø© === */
    .typing-indicator {
        position: fixed; /* <--- [ØªØ¹Ø¯ÙŠÙ„] ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙˆØ¶Ø¹ */
        bottom: var(--input-bar-height); /* <--- [ØªØ¹Ø¯ÙŠÙ„] ÙˆØ¶Ø¹Ù‡ ÙÙˆÙ‚ Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø«Ø§Ø¨Øª */
        left: 0;
        right: 0;
        text-align: center;
        font-size: 10px;
        color: var(--text-dark);
        padding: 2px 0;
        background: rgba(255, 255, 255, 0.8);
        border-top-left-radius: 5px;
        border-top-right-radius: 5px;
        z-index: 98; /* <--- [ØªØ¹Ø¯ÙŠÙ„] Ø£Ù‚Ù„ Ù…Ù† Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ§Ù„Ø±Ø¯ */
        display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    /* === Ù†Ù‡Ø§ÙŠØ© Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø© === */








    /* ØªØ¹Ø¯ÙŠÙ„: ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù‡ÙˆØ§Ù…Ø´ ÙÙŠ Ø§Ù„ØµÙØ­Ø§Øª (Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ØŒ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª...) */
    .page-container { flex: 1; display: flex; flex-direction: column; padding: 10px; /* <--- ØªØµØºÙŠØ± */ gap: 10px; /* <--- ØªØµØºÙŠØ± */ overflow-y: auto; }
    .search-bar {
      display: flex; align-items: center; gap: 6px; /* <--- ØªØµØºÙŠØ± */ background: var(--card-bg-color); padding: 6px 10px; /* <--- ØªØµØºÙŠØ± */
      border-radius: 20px; /* <--- ØªØµØºÙŠØ± */ border: 1px solid #ddd; box-shadow: 0 1px 3px rgba(0,0,0,0.1); direction: rtl;
    }
    .search-bar input {
      flex: 1; border: none; outline: none; background: transparent; 
      font-size: var(--font-size); 
      direction: rtl; color: var(--text-dark);
    }
    /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ */
    .members-list { display: flex; flex-direction: column; gap: 6px; } /* <--- ØªØµØºÙŠØ± Ø§Ù„ÙØ¬ÙˆØ© */
    /* --- ØªØ¹Ø¯ÙŠÙ„: ØªØµØºÙŠØ± Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ø¶Ùˆ --- */
    .member-item-wrapper {
      padding: 1px; /* <--- ØªØµØºÙŠØ± */ background-image: var(--main-bg-gradient); border-radius: 12px; /* <--- ØªØµØºÙŠØ± Ø§Ù„Ø­ÙˆØ§Ù */
      transition: transform 0.2s;
      display: flex;
    }
    .member-item {
      display: flex; align-items: center; gap: 8px; /* <--- ØªØµØºÙŠØ± */ padding: 6px; /* <--- ØªØµØºÙŠØ± Ø§Ù„Ù‡ÙˆØ§Ù…Ø´ */
      background: var(--card-bg-color); border-radius: 10px; /* <--- ØªØµØºÙŠØ± Ø§Ù„Ø­ÙˆØ§Ù */
      position: relative; cursor: pointer;
      flex: 1;
    }
    .member-avatar { 
        width: 36px; height: 36px; /* <--- ØªØµØºÙŠØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© */
        border-radius: 50%; object-fit: cover; 
        background-color: #e0e0e0;
        flex-shrink: 0; /* Ù…Ù†Ø¹ Ø§Ù„ØªÙ‚Ù„Øµ */
    }
    /* --- ØªØ¹Ø¯ÙŠÙ„: Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ø¶Ùˆ ÙˆØ§Ù„Ø­Ø§Ù„Ø© --- */
    .member-info { 
        flex: 1; 
        display: flex; 
        flex-direction: column; 
        justify-content: center;
        min-width: 0; /* Ù…Ù†Ø¹ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù†Øµ */
    }
    .member-name {
        margin: 0; 
        font-size: var(--font-size); /* <--- ØªØµØºÙŠØ± */
        font-weight: 600; color: var(--text-dark);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis; /* Ù‚Øµ Ø§Ù„Ù†Øµ Ø§Ù„Ø·ÙˆÙŠÙ„ */
    }
    /* --- Ø¥Ø¶Ø§ÙØ©: ØªÙ†Ø³ÙŠÙ‚ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ --- */
    .status-dot {
        width: 8px; height: 8px; /* <--- ØªØµØºÙŠØ± */
        border-radius: 50%;
        background-color: #95a5a6; /* Offline (grey) */
        border: 1px solid var(--card-bg-color);
        margin-left: 6px; /* <--- ØªØµØºÙŠØ± */
        flex-shrink: 0; 
        transition: background-color 0.3s ease;
    }
    .status-dot.online {
        background-color: #2ecc71; /* Online (green) */
    }
    .member-status {
        font-size: calc(var(--font-size) - 3px); /* <--- ØªØµØºÙŠØ± */
        color: #777; margin-top: 1px; /* <--- ØªØµØºÙŠØ± */
    }
    body.dark-mode .member-status {
        color: #bdc3c7;
    }
    /* --- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ© --- */
















    /* Ù‚Ø³Ù… Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ (Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ø§Ø³Ù…) */
    .card-section {
      display: flex; flex-direction: column; gap: 6px; /* <--- ØªØµØºÙŠØ± */ background: var(--card-bg-color); padding: 10px; /* <--- ØªØµØºÙŠØ± */
      border-radius: 14px; /* <--- ØªØµØºÙŠØ± */ box-shadow: 0 2px 6px rgba(0,0,0,0.1); align-items: center;
    }
    /* ØªØ¹Ø¯ÙŠÙ„: ØªØµØºÙŠØ± ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ */
    .profile-avatar, .view-profile-avatar {
      width: 70px; height: 70px; /* <--- ØªØµØºÙŠØ± */ border-radius: 50%; border: 3px solid var(--primary-dark); /* <--- ØªØµØºÙŠØ± */ object-fit: cover;
    }
    /* ØªØ¹Ø¯ÙŠÙ„: ØªØµØºÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ */
    .profile-name { font-size: 20px; /* <--- ØªØµØºÙŠØ± */ font-weight: 700; color: var(--primary-dark); margin: 6px 0 0 0; } /* <--- ØªØµØºÙŠØ± */
    .profile-edit-btn, .form-btn-confirm, .settings-btn-themed {
      padding: 8px 14px; /* <--- ØªØµØºÙŠØ± */ border: none; border-radius: 18px; /* <--- ØªØµØºÙŠØ± */ color: var(--text-light);
      background: var(--main-bg-gradient); cursor: pointer;
      font-size: var(--font-size); /* <--- ØªØµØºÙŠØ± */
    }
    /* ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ */
    .auth-page {
      flex: 1; display: flex; flex-direction: column; justify-content: center;
      align-items: center; padding: 15px; /* <--- ØªØµØºÙŠØ± */ background: var(--body-bg); gap: 15px; /* <--- ØªØµØºÙŠØ± */
      overflow-y: auto;
    }
    /* ØªØ¹Ø¯ÙŠÙ„: ØªØµØºÙŠØ± Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø© */
    .auth-title { font-size: 20px; /* <--- ØªØµØºÙŠØ± */ font-weight: bold; color: var(--primary-dark); text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
    /* ØªØ¹Ø¯ÙŠÙ„: ØªÙ‚Ù„ÙŠÙ„ Ù‡ÙˆØ§Ù…Ø´ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
    .auth-card {
      background: var(--card-bg-color); width: 100%; max-width: 320px; /* <--- ØªØµØºÙŠØ± */ padding: 15px; /* <--- ØªØµØºÙŠØ± */
      border-radius: 14px; /* <--- ØªØµØºÙŠØ± */ box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      display: flex; flex-direction: column; gap: 12px; /* <--- ØªØµØºÙŠØ± */
    }
    .auth-input-group { display: flex; flex-direction: column; gap: 6px; } /* <--- ØªØµØºÙŠØ± */
    /* ØªØ¹Ø¯ÙŠÙ„: ØªØµØºÙŠØ± Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
    .auth-input {
      width: 100%; padding: 8px; /* <--- ØªØµØºÙŠØ± */ border-radius: 10px; /* <--- ØªØµØºÙŠØ± */ border: 1px solid #ccc;
      font-size: var(--font-size); 
      background-color: var(--card-bg-color); color: var(--text-dark);
    }
    .form-btn-cancel { padding: 8px; /* <--- ØªØµØºÙŠØ± */ border: none; border-radius: 18px; /* <--- ØªØµØºÙŠØ± */ color: var(--primary-dark); background: #eee; cursor: pointer; }
















    .settings-btn-themed, .form-btn-confirm, .form-btn-cancel {
        font-size: var(--font-size);
    }
















    .form-btn-group { 
        display: flex; gap: 8px; /* <--- ØªØµØºÙŠØ± */ margin-top: 8px; /* <--- ØªØµØºÙŠØ± */
        justify-content: center;
    }
















    /* ØªØ¹Ø¯ÙŠÙ„: ØªØµØºÙŠØ± Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ */
    .signup-avatar { 
        width: 60px; height: 60px; /* <--- ØªØµØºÙŠØ± */ border-radius: 50%; 
        object-fit: cover; border: 2px solid var(--primary-dark); 
        cursor: pointer; 
    }
    .avatar-note {
        font-size: 11px; /* <--- ØªØµØºÙŠØ± */ color: #777; margin: 3px 0 0 0; /* <--- ØªØµØºÙŠØ± */ text-align: center;
    }
















    .error-message { color: var(--danger-color); font-size: 11px; /* <--- ØªØµØºÙŠØ± */ text-align: center; margin-top: 6px; /* <--- ØªØµØºÙŠØ± */ display: none; }
    #loadingScreen {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8);
      display: flex; justify-content: center; align-items: center; z-index: 1000;
    }
    .loading-spinner {
      border: 3px solid rgba(10, 61, 98, 0.2); /* <--- ØªØµØºÙŠØ± */ border-top: 3px solid var(--primary-dark); /* <--- ØªØµØºÙŠØ± */
      border-radius: 50%; width: 30px; height: 30px; /* <--- ØªØµØºÙŠØ± */ animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
















    /* Ù‚Ø³Ù… ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
    .settings-section, .profile-details-section {
        display: flex; flex-direction: column; gap: 6px; /* <--- ØªØµØºÙŠØ± */ background: var(--card-bg-color);
        padding: 10px; /* <--- ØªØµØºÙŠØ± */ border-radius: 14px; /* <--- ØªØµØºÙŠØ± */ box-shadow: 0 2px 6px rgba(0,0,0,0.1); align-items: stretch;
    }
    /* ØªØ¹Ø¯ÙŠÙ„: ØªØµØºÙŠØ± Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù… */
    .settings-section-title {
        margin: 0 0 6px 0; /* <--- ØªØµØºÙŠØ± */ font-size: 16px; /* <--- ØªØµØºÙŠØ± */ font-weight: 700; color: var(--primary-dark);
        border-bottom: 1px solid var(--border-color); /* <--- ØªØµØºÙŠØ± */ padding-bottom: 3px; /* <--- ØªØµØºÙŠØ± */
    }
    .settings-option, .profile-detail-item {
        display: flex; flex-wrap: wrap; align-items: center; gap: 10px; /* <--- ØªØµØºÙŠØ± */ padding: 6px 0; /* <--- ØªØµØºÙŠØ± */ border-bottom: 1px solid var(--border-color);
    }
    .settings-option:last-child, .profile-detail-item:last-child { border-bottom: none; }
    /* ØªØ¹Ø¯ÙŠÙ„: ØªØµØºÙŠØ± Ø®Ø· Ø§Ù„Ù†ØµÙˆØµ */
    .label { 
        flex: 1; 
        font-size: var(--font-size); 
        color: var(--text-dark); 
    }
    .value { 
        font-size: var(--font-size); 
        color: var(--primary-dark); font-weight: 600; 
    }
    .settings-input-color { width: 30px; height: 30px; /* <--- ØªØµØºÙŠØ± */ background-color: transparent; border: none; cursor: pointer; }
    .settings-input-color::-webkit-color-swatch { border-radius: 50%; border: 1px solid var(--border-color); /* <--- ØªØµØºÙŠØ± */ }
    .gender-select { display: flex; gap: 8px; /* <--- ØªØµØºÙŠØ± */ margin-top: 8px; /* <--- ØªØµØºÙŠØ± */ justify-content: center; }
    .gender-option {
      flex: 1; padding: 8px; /* <--- ØªØµØºÙŠØ± */ border: 1px solid #ddd; border-radius: 8px; /* <--- ØªØµØºÙŠØ± */
      text-align: center; cursor: pointer; transition: background 0.3s; color: var(--text-dark);
    }
    .gender-option.selected { background: var(--primary-dark); color: var(--text-light); border-color: var(--primary-dark); }
    .background-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); /* <--- ØªØµØºÙŠØ± */ gap: 6px; /* <--- ØªØµØºÙŠØ± */ }
    .background-option {
        width: 100%; height: 50px; /* <--- ØªØµØºÙŠØ± */ border-radius: 6px; /* <--- ØªØµØºÙŠØ± */ background-size: cover;
        background-position: center; cursor: pointer; border: 2px solid transparent;
        background-color: #eee;
    }
    .background-option.selected { border-color: var(--primary-dark); }
    .toast-notification {
        position: absolute; top: -100px; left: 50%; transform: translateX(-50%);
        background-color: var(--accent-color); color: white; padding: 8px 16px; /* <--- ØªØµØºÙŠØ± */
        border-radius: 18px; /* <--- ØªØµØºÙŠØ± */ box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 2000; font-size: 13px; /* <--- ØªØµØºÙŠØ± */ transition: top 0.5s ease-in-out;
    }
















    /* --- Ø¥ØµÙ„Ø§Ø­ 3: Ø¥Ø¶Ø§ÙØ© Ø³ØªØ§ÙŠÙ„ Ù„Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØµØºÙŠØ± --- */
    .save-btn {
        padding: 4px 8px; /* <--- ØªØµØºÙŠØ± Ø§Ù„Ø­Ø´Ùˆ */
        font-size: 14px; /* <--- ØªØµØºÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© */
        min-width: 30px; /* <--- ØªØµØºÙŠØ± Ø¹Ø±Ø¶ Ø«Ø§Ø¨Øª */
        flex-shrink: 0;
        margin-right: 8px; /* <--- ØªØµØºÙŠØ± Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ù†Øµ */
    }
















    /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
    body.dark-mode {
        --body-bg: #121212;
        --background-color: #2c3e50; --card-bg-color: #34495e; --text-dark: #ecf0f1;
        --border-color: #4a627a; --primary-dark: #3498db; --wa-recv-bubble-bg: #34495e;
        --wa-sent-bubble-bg: #056162;
    }
    body.dark-mode .chat-page { background-color: #0b141a; }
    body.dark-mode .welcome-message { background-color: rgba(0,0,0,0.2); }
    body.dark-mode .form-btn-cancel { background: #4a627a; color: var(--text-dark); }
    body.dark-mode .reply-quote-content .reply-quote-text { color: #bdc3c7; }
















    /* --- ØªØ¹Ø¯ÙŠÙ„: ØªØµØºÙŠØ± Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Ù…ÙˆØ¯Ø§Ù„) --- */
    .modal-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); display: flex; justify-content: center;
        align-items: center; z-index: 2000; opacity: 0; visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
    }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal-content {
        background: var(--card-bg-color); padding: 14px; /* <--- ØªØµØºÙŠØ± Ø§Ù„Ù‡ÙˆØ§Ù…Ø´ */
        border-radius: 14px; /* <--- ØªØµØºÙŠØ± */
        box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center;
        max-width: 90%; width: 260px; /* <--- ØªØµØºÙŠØ± Ø§Ù„Ø¹Ø±Ø¶ */
    }
    .modal-title { 
        margin: 0 0 8px 0; /* <--- ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· ÙˆØ§Ù„Ù‡Ø§Ù…Ø´ */ font-size: 15px; 
        font-weight: 700; color: var(--primary-dark); 
    }
    .modal-body { 
        margin-bottom: 14px; color: var(--text-dark); /* <--- ØªØµØºÙŠØ± */
        font-size: 12px; /* <--- ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· */
    }
    .modal-buttons { display: flex; gap: 8px; /* <--- ØªØµØºÙŠØ± */ justify-content: center; }
    /* ØªØµØºÙŠØ± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
    .modal-buttons .form-btn-cancel,
    .modal-buttons .form-btn-confirm,
    #memberActionModal .settings-btn-themed,
    #messageActionModal .settings-btn-themed {
        padding: 6px 12px; /* <--- ØªØµØºÙŠØ± */
        font-size: 12px; /* <--- ØªØµØºÙŠØ± */
    }
    /* ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Øµ Ù„Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
    #editMessageModal .modal-content {
        width: 90%;
        max-width: 350px; /* <--- ØªØµØºÙŠØ± */
        text-align: right;
    }
    #editMessageModal textarea {
        width: 100%;
        min-height: 60px; /* <--- ØªØµØºÙŠØ± */
        padding: 8px; /* <--- ØªØµØºÙŠØ± */
        border-radius: 6px; /* <--- ØªØµØºÙŠØ± */
        border: 1px solid #ccc;
        resize: vertical;
        font-size: 13px; /* <--- ØªØµØºÙŠØ± */
        direction: rtl;
        margin-bottom: 8px; /* <--- ØªØµØºÙŠØ± */
    }








    /* === [Ø¬Ø¯ÙŠØ¯] Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª === */
    #reactionModal .modal-content {
        width: auto;
        max-width: 300px;
        padding: 10px;
    }
    .reaction-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
    }
    .reaction-emoji-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        padding: 5px;
        border-radius: 8px;
        transition: background-color 0.1s;
    }
    .reaction-emoji-btn:hover {
        background-color: rgba(0,0,0,0.1);
    }
    /* === Ù†Ù‡Ø§ÙŠØ© Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª === */
    
    /* [Ø¬Ø¯ÙŠØ¯] Ù…ÙˆØ¯Ø§Ù„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ */
    #emojiPickerModal .modal-content {
        width: 90%;
        max-width: 350px;
        padding: 10px;
    }
    .emoji-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(30px, 1fr));
        gap: 5px;
        max-height: 250px;
        overflow-y: auto;
        padding: 5px;
    }
    .emoji-item {
        font-size: 24px;
        cursor: pointer;
        text-align: center;
        padding: 2px;
        border-radius: 5px;
    }
    .emoji-item:hover {
        background-color: rgba(0,0,0,0.1);
    }
















    /* --- ØªØµÙ…ÙŠÙ… Ø®Ø§Øµ Ø¨Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø£ÙƒØ¨Ø± (Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±) --- */
    /* Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªØ¹Ù…Ù„ ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØªÙŠ Ø¹Ø±Ø¶Ù‡Ø§ 600 Ø¨ÙƒØ³Ù„ Ø£Ùˆ Ø£ÙƒØ¨Ø± */
    @media screen and (min-width: 600px) {
        .chat-page {
            background-attachment: fixed; /* <--- Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ«Ø¨ÙŠØª Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± */
        }
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            background-color: #d1d8e0;
        }
        body.dark-mode {
            background-color: #192a38;
        }
        .chat-container {
            max-width: 420px;
            height: 95vh;
            max-height: 850px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            border: 1px solid #ccc;
        }
        
        /* [ØªØ¹Ø¯ÙŠÙ„] Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ«Ø¨ÙŠØª ÙˆØ¥Ø¹Ø§Ø¯Ø© Flexbox Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± */
        .chat-input {
            position: relative; /* <--- [Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ«Ø¨ÙŠØª] */
            bottom: auto;
            left: auto;
            right: auto;
            z-index: 10;
            flex-shrink: 0; /* <--- [Ø¥Ø¹Ø§Ø¯Ø© Flexbox] */
            height: auto; /* <--- [Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ] */
        }
        
        .messages {
            padding-bottom: 8px; /* <--- [Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø´Ùˆ Ø§Ù„Ø£ØµÙ„ÙŠ] */
        }
        
        .reply-quote-container-wrapper, .typing-indicator {
            position: absolute; /* <--- [Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø·Ù„Ù‚] */
            bottom: 100%; /* <--- [Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…ÙˆØ¶Ø¹] */
            z-index: 1;
        }
        /* [Ù†Ù‡Ø§ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±] */
        
        @media (hover: hover) {
            .nav-btn:hover {
                background: rgba(255,255,255,0.15);
            }
            .member-item-wrapper:hover {
                transform: scale(1.02);
            }
        }
    }
    @media screen and (min-width: 1200px) {
        .chat-container {
            max-width: 450px;
        }
    }
  </style>
</head>
<body>
  <!-- Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ø´Ø§Øª -->
  <div class="chat-container">
    <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ (Ø§Ù„Ù‡ÙŠØ¯Ø±) -->
    <header class="chat-header" id="chatHeader" style="display: none;">
      <img src="https://placehold.co/44x44/0a3d62/FFF?text=S" class="avatar" alt="avatar" />
      <h1 class="title">Ø´Ø§Øª Ø´Ù‡Ø§Ø¨</h1>
      <button class="logout-btn" id="logoutBtn">ğŸšª Ø®Ø±ÙˆØ¬</button>
    </header>
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ -->
    <nav class="chat-nav" id="chatNav" style="display: none;">
      <button class="nav-btn" onclick="openPage('chat', this)">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</button>
      <button class="nav-btn" onclick="openPage('members', this)">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</button>
      <button class="nav-btn" onclick="openPage('settings', this)">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
      <button class="nav-btn" onclick="openPage('profile', this)">Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</button>
    </nav>
    <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø§Øª Ù‡Ù†Ø§) -->
    <!-- [ØªØ¹Ø¯ÙŠÙ„] ØªÙ… Ø¥Ø²Ø§Ù„Ø© flex: 1 Ù…Ù† chat-content ÙÙŠ CSS ÙˆØªÙ… ØªØ¹ÙˆÙŠØ¶Ù‡Ø§ Ø¨Ù€ padding-bottom ÙÙŠ .messages -->
    <main class="chat-content" id="content"></main>
    
    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
    <div id="loadingScreen" style="display: none;"><div class="loading-spinner"></div></div>
    
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ (ØªÙ… Ù†Ù‚Ù„Ù‡ Ù‡Ù†Ø§ Ù„ÙŠÙƒÙˆÙ† Ø«Ø§Ø¨ØªØ§Ù‹ ÙÙˆÙ‚ ÙƒÙ„ Ø´ÙŠØ¡) -->
    <form class="chat-input" id="messageForm" style="display: none;">
        <!-- [ØªØ¹Ø¯ÙŠÙ„] ØªÙ… ØªØºÙŠÙŠØ± Ù…ÙˆØ¶Ø¹ Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¯ ÙˆÙ…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ CSS Ù„ØªØ¹Ù…Ù„ Ù…Ø¹ position: fixed -->
        <div id="replyQuoteContainerWrapper" class="reply-quote-container-wrapper" style="display:none;">
            <div id="replyQuoteContainer" class="reply-quote-container">
                <div class="reply-quote-content">
                    <div class="reply-quote-name" id="replyQuoteName"></div>
                    <div class="reply-quote-text" id="replyQuoteText"></div>
                </div>
                <button type="button" class="reply-quote-close" id="clearReplyBtn">âœ–</button>
            </div>
        </div>
        <div id="typingIndicator" class="typing-indicator"></div>
        <button type="button" class="emoji-btn" id="openEmojiPicker">ğŸ˜€</button>
        <input class="msg-input" id="msgInput" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." autocomplete="off" />
        <button class="send-btn" type="submit" title="Ø¥Ø±Ø³Ø§Ù„">â¤</button>
    </form>
    <!-- [Ù†Ù‡Ø§ÙŠØ© Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„] -->
















    <!-- Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª (Ù…ÙˆØ¯Ø§Ù„) -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="confirmModalTitle" class="modal-title">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</h3>
            <p id="confirmModalBody" class="modal-body">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ</p>
            <div class="modal-buttons">
                <button id="confirmModalCancel" class="form-btn-cancel">Ø¥Ù„ØºØ§Ø¡</button>
                <button id="confirmModalOk" class="form-btn-confirm">ØªØ£ÙƒÙŠØ¯</button>
            </div>
        </div>
    </div>
















    <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¹Ø¶Ùˆ (Ù…ÙˆØ¯Ø§Ù„) -->
    <div id="memberActionModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="memberActionTitle" class="modal-title"></h3>
            <div class="modal-buttons" style="flex-direction: column; gap: 10px;">
                <button id="memberActionViewProfile" class="settings-btn-themed" style="background: var(--primary-dark);">ğŸ‘¤ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</button>
                <button id="memberActionMute" class="settings-btn-themed">ğŸ”‡ ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</button>
                <button id="memberActionUnmute" class="settings-btn-themed" style="background: var(--accent-color);">ğŸ”Š Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªÙ‚ÙŠÙŠØ¯</button>
                <button id="memberActionDelete" class="settings-btn-themed" style="background: var(--danger-color);">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¹Ø¶Ùˆ</button>
                <button id="memberActionCancel" class="form-btn-cancel">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>
















    <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ù…ÙˆØ¯Ø§Ù„ Ø¬Ø¯ÙŠØ¯) -->
    <div id="messageActionModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø©</h3>
            <div class="modal-buttons" style="flex-direction: column; gap: 10px;">
                <button id="messageActionEdit" class="settings-btn-themed" style="background: var(--primary-dark);">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>
                <button id="messageActionReply" class="settings-btn-themed" style="background: var(--accent-color);">â†©ï¸ Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>
                <button id="messageActionReact" class="settings-btn-themed" style="background: #f39c12;">ğŸ˜€ ØªÙØ§Ø¹Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>
                <button id="messageActionCopy" class="settings-btn-themed" style="background: #3498db;">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>
                <button id="messageActionForward" class="settings-btn-themed" style="background: #f39c12;">â¡ï¸ Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡</button>
                <button id="messageActionDelete" class="settings-btn-themed" style="background: var(--danger-color);">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>
                <button id="messageActionCancel" class="form-btn-cancel">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>
















    <!-- Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ù…ÙˆØ¯Ø§Ù„ Ø¬Ø¯ÙŠØ¯) -->
    <div id="editMessageModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</h3>
            <textarea id="editMessageInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§..." dir="rtl"></textarea>
            <div class="modal-buttons">
                <button id="editMessageCancel" class="form-btn-cancel">Ø¥Ù„ØºØ§Ø¡</button>
                <button id="editMessageSave" class="form-btn-confirm">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
            </div>
        </div>
    </div>








    <!-- === [Ø¬Ø¯ÙŠØ¯] Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª (Ù…ÙˆØ¯Ø§Ù„) === -->
    <div id="reactionModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">Ø§Ø®ØªØ± ØªÙØ§Ø¹Ù„Ùƒ</h3>
            <div class="reaction-grid" id="reactionGrid">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
            </div>
            <div class="modal-buttons" style="margin-top: 10px;">
                <button id="reactionModalCancel" class="form-btn-cancel">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>
    <!-- === Ù†Ù‡Ø§ÙŠØ© Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª === -->








    <!-- === [Ø¬Ø¯ÙŠØ¯] Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ (Ù…ÙˆØ¯Ø§Ù„) === -->
    <div id="emojiPickerModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">Ø§Ø®ØªØ± Ø¥ÙŠÙ…ÙˆØ¬ÙŠ</h3>
            <div class="emoji-grid" id="emojiGrid">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
            </div>
            <div class="modal-buttons" style="margin-top: 10px;">
                <button id="emojiPickerModalClose" class="form-btn-cancel">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
    </div>
    <!-- === Ù†Ù‡Ø§ÙŠØ© Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ === -->
















  </div>
















  <script type="module">
    // --- Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ÙƒØªØ¨Ø§Øª Firebase ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, updateDoc, query, Timestamp, addDoc, orderBy, deleteDoc, getDocs, writeBatch, where, limitToLast, FieldPath, FieldValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
















    /* --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase --- */
    const firebaseConfig = {
      apiKey: "AIzaSyBnFVN-3U4NlLljUbVHHh4vQB9Mmp7RE5A",
      authDomain: "zagazig-commerce.firebaseapp.com",
      projectId: "zagazig-commerce",
      storageBucket: "zagazig-commerce.appspot.com",
      messagingSenderId: "783055989739",
      appId: "1:783055989739:web:d906f9381cb3daac2447ae"
    };
















    /* --- ØªÙ‡ÙŠØ¦Ø© Firebase --- */
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app); // ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
    const db = getFirestore(app); // ÙˆØ­Ø¯Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Firestore)
    const usersCollection = collection(db, `public/data/users`);
    const messagesCollection = collection(db, `public/data/messages`);
    const globalSettingsDoc = doc(db, `public/data/global_config/settings`);
    // [Ø¬Ø¯ÙŠØ¯] Ù…Ø±Ø¬Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
    const typingStatusDoc = doc(db, 'public/data/typing_status', 'status');
















    /* --- Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØ§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª --- */
    let currentUserProfile = null; // ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
    let usersCache = {}; // ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„ØªÙ‚Ù„ÙŠÙ„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    let globalSettings = null; // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ø§Ù„ØªÙŠ ÙŠØ·Ø¨Ù‚Ù‡Ø§ Ø§Ù„Ù…Ø§Ù„Ùƒ
    let pageCache = {}; // ØªØ®Ø²ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª (Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©ØŒ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡...) ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
    let dataListeners = []; // Ù…ØµÙÙˆÙØ© Ù„ØªØ®Ø²ÙŠÙ† "Ù…Ø±Ø§Ù‚Ø¨ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" Ù„Ø¥ÙŠÙ‚Ø§ÙÙ‡Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬
    let replyingToMessage = null; // Ù„ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§
    let typingUsers = {}; // [Ø¬Ø¯ÙŠØ¯] Ù„ØªØ®Ø²ÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹
    let currentMessageToReact = null; // [Ø¬Ø¯ÙŠØ¯] Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ÙŠØªÙ… Ø§Ù„ØªÙØ§Ø¹Ù„ Ø¹Ù„ÙŠÙ‡Ø§
















    /* --- Ø¥ØµÙ„Ø§Ø­ 2: Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØ± Ø§Ù„Ø±Ù…Ø²ÙŠØ© Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„Ø© --- */
    let maleAvatarIndex = 0;
    let femaleAvatarIndex = 0;
















    /* --- Ø¬Ù„Ø¨ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© --- */
    const contentEl = document.getElementById("content");
    const headerEl = document.getElementById("chatHeader");
    const navEl = document.getElementById("chatNav");
    const loadingScreen = document.getElementById("loadingScreen");
    const logoutBtn = document.getElementById('logoutBtn');
    const messageForm = document.getElementById('messageForm'); // [ØªØ¹Ø¯ÙŠÙ„] Ø¬Ù„Ø¨ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
    const msgInput = document.getElementById('msgInput'); // [ØªØ¹Ø¯ÙŠÙ„] Ø¬Ù„Ø¨ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
    const openEmojiPicker = document.getElementById('openEmojiPicker'); // [ØªØ¹Ø¯ÙŠÙ„] Ø¬Ù„Ø¨ Ø²Ø± Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
    const clearReplyBtn = document.getElementById('clearReplyBtn'); // [ØªØ¹Ø¯ÙŠÙ„] Ø¬Ù„Ø¨ Ø²Ø± Ù…Ø³Ø­ Ø§Ù„Ø±Ø¯
    const memberActionModal = document.getElementById('memberActionModal');
    const memberActionTitle = document.getElementById('memberActionTitle');
    const memberActionViewProfile = document.getElementById('memberActionViewProfile');
    const memberActionMute = document.getElementById('memberActionMute');
    const memberActionUnmute = document.getElementById('memberActionUnmute');
    const memberActionDelete = document.getElementById('memberActionDelete');
    const memberActionCancel = document.getElementById('memberActionCancel');








    // Ø¹Ù†Ø§ØµØ± Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    const messageActionModal = document.getElementById('messageActionModal');
    const messageActionEdit = document.getElementById('messageActionEdit');
    const messageActionReply = document.getElementById('messageActionReply');
    const messageActionReact = document.getElementById('messageActionReact'); // [Ø¬Ø¯ÙŠØ¯]
    const messageActionCopy = document.getElementById('messageActionCopy');
    const messageActionForward = document.getElementById('messageActionForward');
    const messageActionDelete = document.getElementById('messageActionDelete');
    const messageActionCancel = document.getElementById('messageActionCancel');
















    // Ø¹Ù†Ø§ØµØ± Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    const editMessageModal = document.getElementById('editMessageModal');
    const editMessageInput = document.getElementById('editMessageInput');
    const editMessageSave = document.getElementById('editMessageSave');
    const editMessageCancel = document.getElementById('editMessageCancel');








    // [Ø¬Ø¯ÙŠØ¯] Ø¹Ù†Ø§ØµØ± Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
    const reactionModal = document.getElementById('reactionModal');
    const reactionGrid = document.getElementById('reactionGrid');
    const reactionModalCancel = document.getElementById('reactionModalCancel');
    
    // [Ø¬Ø¯ÙŠØ¯] Ø¹Ù†Ø§ØµØ± Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
    const emojiPickerModal = document.getElementById('emojiPickerModal');
    const emojiGrid = document.getElementById('emojiGrid');
    const emojiPickerModalClose = document.getElementById('emojiPickerModalClose');
















    /* --- Ø§Ù„ØµÙˆØ± Ø§Ù„Ø±Ù…Ø²ÙŠØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª --- */
    const maleAvatars = [
      "https://images.pexels.com/photos/614810/pexels-photo-614810.jpeg?auto=compress&cs=tinysrgb&dpr=1&w=100&h=100&fit=crop",
      "https://images.pexels.com/photos/91227/pexels-photo-91227.jpeg?auto=compress&cs=tinysrgb&dpr=1&w=100&h=100&fit=crop",
      "https://images.pexels.com/photos/1043471/pexels-photo-1043471.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop",
      "https://images.pexels.com/photos/1222271/pexels-photo-1222271.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop",
      "https://images.pexels.com/photos/220453/pexels-photo-220453.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop",
      "https://images.pexels.com/photos/1681010/pexels-photo-1681010.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop",
      "https://images.pexels.com/photos/846741/pexels-photo-846741.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop",
      "https://images.pexels.com/photos/1082962/pexels-photo-1082962.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop",
    ];
    const femaleAvatars = [
      "https://images.pexels.com/photos/733872/pexels-photo-733872.jpeg?auto=compress&cs=tinysrgb&dpr=1&w=100&h=100&fit=crop",
      "https://images.pexels.com/photos/1181519/pexels-photo-1181519.jpeg?auto=compress&cs=tinysrgb&dpr=1&w=100&h=100&fit=crop",
      "https://images.pexels.com/photos/1065084/pexels-photo-1065084.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop",
      "https://images.pexels.com/photos/1130626/pexels-photo-1130626.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop",
      "https://images.pexels.com/photos/1858175/pexels-photo-1858175.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop",
      "https://images.pexels.com/photos/774909/pexels-photo-774909.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop",
      "https://images.pexels.com/photos/1181686/pexels-photo-1181686.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop",
      "https://images.pexels.com/photos/415829/pexels-photo-415829.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop",
    ];
















    const backgroundImages = [
        { thumb: 'https://images.pexels.com/photos/15286/pexels-photo.jpg?auto=compress&cs=tinysrgb&w=150', full: 'https://images.pexels.com/photos/15286/pexels-photo.jpg' },
        { thumb: 'https://images.pexels.com/photos/3408744/pexels-photo-3408744.jpeg?auto=compress&cs=tinysrgb&w=150', full: 'https://images.pexels.com/photos/3408744/pexels-photo-3408744.jpeg' },
        { thumb: 'https://images.pexels.com/photos/1287145/pexels-photo-1287145.jpeg?auto=compress&cs=tinysrgb&w=150', full: 'https://images.pexels.com/photos/1287145/pexels-photo-1287145.jpeg' },
        { thumb: 'https://images.pexels.com/photos/1766838/pexels-photo-1766838.jpeg?auto=compress&cs=tinysrgb&w=150', full: 'https://images.pexels.com/photos/1766838/pexels-photo-1766838.jpeg' },
        { thumb: 'https://images.pexels.com/photos/3225528/pexels-photo-3225528.jpeg?auto=compress&cs=tinysrgb&w=150', full: 'https://images.pexels.com/photos/3225528/pexels-photo-3225528.jpeg' },
        { thumb: 'https://images.pexels.com/photos/2098428/pexels-photo-2098428.jpeg?auto=compress&cs=tinysrgb&w=150', full: 'https://images.pexels.com/photos/2098428/pexels-photo-2098428.jpeg' },
    ];
    const defaultSettings = {
        darkMode: false, sentBubbleBg: '#e1ffc7', recvBubbleBg: '#ffffff',
        fontSize: 12, chatBackground: '', 
        bubblePadding: 1, 
    };








    // [Ù…Ø­Ø¯Ø«] Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© (ØªÙ… ØªÙˆØ³ÙŠØ¹Ù‡Ø§ Ù„Ù€ 20 Ø±Ù…Ø²Ø§Ù‹)
    const availableReactions = [
      'ğŸ‘', 'â¤ï¸', 'ğŸ˜‚', 'ğŸ˜¢', 'ğŸ˜¡', 'ğŸ™', 'ğŸ”¥', 'ğŸ¤¯', 'ğŸ¥³', 'ğŸ¤”', 
      'ğŸ‘', 'ğŸ’¯', 'ğŸ’”', 'ğŸ˜', 'ğŸ˜´', 'ğŸ˜­', 'ğŸ¤©', 'ğŸ¤®', 'ğŸ˜ˆ', 'ğŸ˜‡'
    ];
    
    // [Ø¬Ø¯ÙŠØ¯] Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ù„Ù„Ø§Ø®ØªÙŠØ§Ø± (50 Ø±Ù…Ø²Ø§Ù‹)
    const emojiList = [
        'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ¤£', 'ğŸ˜‚', 'ğŸ™‚', 'ğŸ™ƒ', 
        'ğŸ˜‰', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤©', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜š', 'ğŸ˜™', 
        'ğŸ¥²', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ˜', 'ğŸ¤‘', 'ğŸ¤—', 'ğŸ¤­', 'ğŸ¤«', 
        'ğŸ¤”', 'ğŸ«¡', 'ğŸ¤¨', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ«¥', 'ğŸ˜¶â€ğŸŒ«ï¸', 'ğŸ˜', 'ğŸ˜’', 
        'ğŸ™„', 'ğŸ˜¬', 'ğŸ˜®â€ğŸ’¨', 'ğŸ¤¥', 'ğŸ˜Œ', 'ğŸ˜”', 'ğŸ˜ª', 'ğŸ¤¤', 'ğŸ˜´', 'ğŸ˜·',
        'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ¥´', 'ğŸ˜µ', 'ğŸ˜µâ€ğŸ’«',
        'ğŸ¤¯', 'ğŸ¤ ', 'ğŸ¥³', 'ğŸ¥¸', 'ğŸ¥º', 'ğŸ¥¹', 'ğŸ˜­', 'ğŸ˜¢', 'ğŸ˜¥', 'æ³„',
        'ğŸ˜¨', 'ğŸ˜©', 'ğŸ˜«', 'ğŸ’¢', 'ğŸ”¥', 'ğŸ’¯', 'ğŸ‘', 'ğŸ‘', 'ğŸ‘', 'ğŸ™',
        'â¤ï¸', 'ğŸ’”', 'ğŸŒ¹', 'ğŸ•', 'ğŸº', 'âš½', 'ğŸ’»', 'ğŸ’¡', 'â°', 'ğŸš€'
    ];
















    /* --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© (Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ØŒ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª...) --- */
    const showLoading = (show) => { loadingScreen.style.display = show ? 'flex' : 'none'; };
    const setActiveNav = (btn) => {
      document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
      if (btn) btn.classList.add("active");
    };
    // Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù„ÙˆÙŠ Ù…Ø¤Ù‚Øª
    const showToast = (message) => {
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        toast.textContent = message;
        document.querySelector('.chat-container').appendChild(toast);
        setTimeout(() => { toast.style.top = '20px'; }, 10);
        setTimeout(() => {
            toast.style.top = '-100px';
            setTimeout(() => { toast.remove(); }, 500);
        }, 3000);
    };
















    /* --- Ø¥ØµÙ„Ø§Ø­ 2: Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¯Ø§Ù„Ø© "Ø¹Ø´ÙˆØ§Ø¦ÙŠ" Ø¨Ø¯Ø§Ù„Ø© "Ø§Ù„ØªØ§Ù„ÙŠ" --- */
    const getNextAvatar = (gender = 'male') => {
        if (gender === 'male') {
            const avatar = maleAvatars[maleAvatarIndex];
            maleAvatarIndex = (maleAvatars.length + maleAvatarIndex + 1) % maleAvatars.length; // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ±
            return avatar;
        } else {
            const avatar = femaleAvatars[femaleAvatarIndex];
            femaleAvatarIndex = (femaleAvatars.length + femaleAvatarIndex + 1) % femaleAvatars.length; // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ±
            return avatar;
        }
    };
















    // Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯
    const showConfirmModal = (title, body) => {
        return new Promise((resolve) => {
            const modal = document.getElementById('confirmModal');
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalBody').textContent = body;
            modal.classList.add('active');
            const okBtn = document.getElementById('confirmModalOk');
            const cancelBtn = document.getElementById('confirmModalCancel');
            const close = (result) => {
                modal.classList.remove('active');
                okBtn.replaceWith(okBtn.cloneNode(true));
                cancelBtn.replaceWith(cancelBtn.cloneNode(true));
                resolve(result);
            }
            document.getElementById('confirmModalOk').onclick = () => close(true);
            document.getElementById('confirmModalCancel').onclick = () => close(false);
        });
    };
















    // --- Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª (Ù…Ù†Ø° 5 Ø¯Ù‚Ø§Ø¦Ù‚...) ---
    function formatTimeAgo(timestamp) {
        if (!timestamp) return 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        const date = timestamp.toDate();
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);
















        let interval = seconds / 31536000;
        if (interval > 1) return `Ù…Ù†Ø° ${Math.floor(interval)} Ø³Ù†Ø©`;
        interval = seconds / 2592000;
        if (interval > 1) return `Ù…Ù†Ø° ${Math.floor(interval)} Ø´Ù‡Ø±`;
        interval = seconds / 86400;
        if (interval > 1) return `Ù…Ù†Ø° ${Math.floor(interval)} ÙŠÙˆÙ…`;
        interval = seconds / 3600;
        if (interval > 1) return `Ù…Ù†Ø° ${Math.floor(interval)} Ø³Ø§Ø¹Ø©`;
        interval = seconds / 60;
        if (interval > 1) return `Ù…Ù†Ø° ${Math.floor(interval)} Ø¯Ù‚ÙŠÙ‚Ø©`;
        return 'Ø§Ù„Ø¢Ù†';
    }
















    /* --- Ø¯Ø§Ù„Ø© Ø¶ØºØ· Ø§Ù„ØµÙˆØ± --- */
    async function compressImage(file, maxSize = 800, quality = 0.7) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    let width = img.width;
                    let height = img.height;
















                    if (width > height) {
                        if (width > maxSize) {
                            height *= maxSize / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width *= maxSize / height;
                            height = maxSize;
                        }
                    }
















                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    const dataUrl = canvas.toDataURL('image/jpeg', quality);
                    resolve(dataUrl);
                };
                img.onerror = (error) => {
                    reject(error);
                };
            };
            reader.onerror = (error) => {
                reject(error);
            };
        });
    }
















    // --- Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ---
    async function updateUserPresence(isOnline) {
        if (!auth.currentUser) return;
        try {
            const userDocRef = doc(usersCollection, auth.currentUser.uid);
            await updateDoc(userDocRef, {
                isOnline: isOnline,
                lastSeen: Timestamp.now()
            });
        } catch (error) {
            console.warn("Failed to update presence:", error.code);
        }
    }








    // [Ù…Ø­Ø¯Ø«] Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© (Ù…Ø¹ Debounce)
    let typingTimeout;
    async function updateTypingStatus(isTyping) {
        if (!auth.currentUser || !currentUserProfile) return;
        const userId = auth.currentUser.uid;
        const typingField = FieldPath.of(userId);








        clearTimeout(typingTimeout);








        if (isTyping) {
            // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙÙˆØ±Ø§Ù‹
            await updateDoc(typingStatusDoc, {
                [typingField]: Timestamp.now()
            });
            // 2. ØªØ¹ÙŠÙŠÙ† Ù…Ø¤Ù‚Øª Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†Ù Ù…Ù† Ø§Ù„ØªÙˆÙ‚Ù Ø¹Ù† Ø§Ù„ÙƒØªØ§Ø¨Ø©
            typingTimeout = setTimeout(() => {
                updateTypingStatus(false);
            }, 3000);
        } else {
            // 3. Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ù† Firestore
            await updateDoc(typingStatusDoc, {
                [typingField]: FieldValue.delete()
            }).catch(e => console.warn("Failed to delete typing status:", e));
        }
    }
















    /* --- Ø¯Ø§Ù„Ø© ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© --- */
    const applyUserSettings = (settings) => {
        const s = { ...defaultSettings, ...settings };
        document.body.classList.toggle('dark-mode', s.darkMode);
        const rootStyle = document.documentElement.style;
        rootStyle.setProperty('--wa-sent-bubble-bg', s.sentBubbleBg);
        rootStyle.setProperty('--wa-recv-bubble-bg', s.recvBubbleBg);
        rootStyle.setProperty('--font-size', `${s.fontSize}px`);
















        let paddingValue = '4px 8px'; // Default (Extra Small)
        if (s.bubblePadding == 1) paddingValue = '5px 10px'; // Small
        if (s.bubblePadding == 2) paddingValue = '8px 12px'; // Medium
        if (s.bubblePadding == 3) paddingValue = '12px 16px'; // Large
        rootStyle.setProperty('--bubble-padding', paddingValue);
















        if (pageCache.chat) { 
            const bgValue = s.chatBackground 
                ? `url(${s.chatBackground})` 
                : 'none';
            pageCache.chat.style.backgroundImage = bgValue;
        }
    };
















    /* --- === [!!] Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© 1: ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ø¹Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù…ÙŠØ¹ [!!] === ---
     * ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© ÙƒØ£ÙˆÙ„ÙˆÙŠØ©
     * --- === Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥ØµÙ„Ø§Ø­ === ---
     */
    const applyCombinedSettings = () => {
        if (!currentUserProfile) return;
















        // 1. Ù†Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        let finalSettings = { ...defaultSettings };
















        // 2. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©)
        if (globalSettings) {
            finalSettings = { ...finalSettings, ...globalSettings };
        }
















        // 3. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… (ÙƒØ£ÙˆÙ„ÙˆÙŠØ© Ø£Ø®ÙŠØ±Ø© Ù„ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¹Ø§Ù…)
        // [Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© 1] ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ†Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        const userSettings = currentUserProfile.settings || {};








        // Ù†Ø¯Ù…Ø¬ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©ØŒ ÙˆÙ„ÙƒÙ† ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ†Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (Ø£Ùˆ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©)
        finalSettings = {
            ...finalSettings,
            ...userSettings,
            // [Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© 1] Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø´Ø®ØµÙŠØ© ØªØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¹Ø§Ù…Ø© ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† Ø®Ù„ÙÙŠØ© Ø¹Ø§Ù…Ø©
            chatBackground: globalSettings?.chatBackground || userSettings.chatBackground || defaultSettings.chatBackground,
            // [Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© 1] Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ø§Ù„Ø´Ø®ØµÙŠ ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¹Ø§Ù…
            darkMode: userSettings.darkMode !== undefined ? userSettings.darkMode : finalSettings.darkMode,
            // ÙŠÙ…ÙƒÙ† ØªØ·Ø¨ÙŠÙ‚ Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø¹Ù„Ù‰ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ø£Ù† ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø¹Ø§Ù…
            sentBubbleBg: userSettings.sentBubbleBg || finalSettings.sentBubbleBg,
            recvBubbleBg: userSettings.recvBubbleBg || finalSettings.recvBubbleBg,
            fontSize: userSettings.fontSize || finalSettings.fontSize,
            bubblePadding: userSettings.bubblePadding || finalSettings.bubblePadding,
        };
















        // 4. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        applyUserSettings(finalSettings);
    };
















    /* --- Ø¯Ø§Ù„Ø© Ø¥ÙŠÙ‚Ø§Ù Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬) --- */
    function detachAllListeners() {
        dataListeners.forEach(unsubscribe => unsubscribe());
        dataListeners = [];
        clearTimeout(typingTimeout); // [Ø¬Ø¯ÙŠØ¯] Ù…Ø³Ø­ Ù…Ø¤Ù‚Øª Ø§Ù„ÙƒØªØ§Ø¨Ø©
    }
















    /* --- Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ --- */
    async function initializeAppState(user) {
        detachAllListeners(); // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ Ù…Ø±Ø§Ù‚Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©
















        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø³ØªØ®Ø¯Ù… (ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬)
        if (!user) {
            currentUserProfile = null;
            headerEl.style.display = "none";
            navEl.style.display = "none";
            messageForm.style.display = "none"; // [ØªØ¹Ø¯ÙŠÙ„] Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
            contentEl.innerHTML = "";
            pageCache = {};
            showWelcomePage(); // Ø¥Ø¸Ù‡Ø§Ø± ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
            return;
        }
















        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø³ØªØ®Ø¯Ù…
        showLoading(true);
        try {
            const userDocRef = doc(usersCollection, user.uid);
            const userDoc = await getDoc(userDocRef);
















            if (userDoc.exists()) {
                // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙ„Ø¯ÙŠÙ‡ Ø¨Ø±ÙˆÙØ§ÙŠÙ„
                currentUserProfile = { id: user.uid, ...userDoc.data() };
















                updateUserPresence(true); 
















                document.addEventListener("visibilitychange", () => {
                    if (!auth.currentUser) return;
                    const isOnline = document.visibilityState === "visible";
                    updateUserPresence(isOnline);
                });
















                buildPageCache(); // Ø¨Ù†Ø§Ø¡ Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„ØµÙØ­Ø§Øª
                attachDataListeners(user.uid); // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
















                // [ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„] Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ø¹Ø¯ Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ÙÙŠ attachDataListeners
                updateHeaderUI(currentUserProfile); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡ÙŠØ¯Ø±
                headerEl.style.display = "flex";
                navEl.style.display = "flex";
                messageForm.style.display = "flex"; // [ØªØ¹Ø¯ÙŠÙ„] Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
                logoutBtn.onclick = handleLogout;
                openPage('chat', document.querySelector('.nav-btn')); // ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø´Ø§Øª
            } else {
                // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ØŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡ Ø¨Ø±ÙˆÙØ§ÙŠÙ„
                headerEl.style.display = "none";
                navEl.style.display = "none";
                messageForm.style.display = "none"; // [ØªØ¹Ø¯ÙŠÙ„] Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
                showNewUserProfilePage(user); // Ø¥Ø¸Ù‡Ø§Ø± ØµÙØ­Ø© Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
            }
        } catch (error) {
            console.error("Error initializing app state:", error);
            showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
        } finally {
            showLoading(false);
        }
    }
















    /* --- Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ --- */
    onAuthStateChanged(auth, initializeAppState);
















    /* --- Ø¯ÙˆØ§Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø®Ø±ÙˆØ¬ --- */
    const handleLogin = async () => {
        showLoading(true);
        try { await signInAnonymously(auth); } // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù…Ø¬Ù‡ÙˆÙ„
        catch (error) { console.error("Anonymous sign-in failed:", error); showLoading(false); }
    };
















    const handleLogout = async () => {
        showLoading(true);
        try { 
            if (auth.currentUser) { 
                await updateUserPresence(false);
                await updateTypingStatus(false); // [Ø¬Ø¯ÙŠØ¯] Ø¥Ø²Ø§Ù„Ø© Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬
            }
            await signOut(auth); // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        } 
        catch (error) { console.error("Sign out error", error); } 
        finally { showLoading(false); }
    };
















    /* --- Ø¯Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ØŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...) --- */
    function attachDataListeners(userId) {
        if (dataListeners.length > 0) return; // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
















        // 1. Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
        const userDocRef = doc(usersCollection, userId);
        const unsubscribeProfile = onSnapshot(userDocRef, (doc) => {
            if (!doc.exists()) return; 
            currentUserProfile = { id: userId, ...doc.data() };
            usersCache[userId] = currentUserProfile;
            applyCombinedSettings(); // [ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„] ÙŠØªÙ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù‡Ù†Ø§
            updateHeaderUI(currentUserProfile);
            if (pageCache.profile && pageCache.profile.classList.contains('active')) {
                renderProfilePage(true);
            }
            if (pageCache.members && pageCache.members.classList.contains('active')) {
                renderMembersList();
            }
        });
















        // 2. Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (Ù„Ù„Ù…Ø§Ù„Ùƒ)
        const unsubscribeGlobalSettings = onSnapshot(globalSettingsDoc, (doc) => {
            globalSettings = doc.exists() ? doc.data() : null;
            if (currentUserProfile) {
                applyCombinedSettings(); // [ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„] ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ø¹Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù…ÙŠØ¹ ÙÙˆØ±Ø§Ù‹
            }
        });
















        // 3. Ù…Ø±Ø§Ù‚Ø¨Ø© ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡)
        const usersQuery = query(usersCollection, orderBy("name"));
        const unsubscribeUsers = onSnapshot(usersQuery, (snapshot) => {
            let listChanged = false;
            snapshot.docChanges().forEach(change => {
                listChanged = true;
                const user = { id: change.doc.id, ...change.doc.data() };
                if (change.type === 'removed') delete usersCache[user.id];
                else usersCache[user.id] = user;
            });
            // Ø¥Ø°Ø§ ØªØºÙŠØ±Øª Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ø£Ùˆ Ø­Ø§Ù„Ø© Ø§ØªØµØ§Ù„Ù‡Ù…)
            if (listChanged && pageCache.members && pageCache.members.classList.contains('active')) {
                renderMembersList(); // Ø£Ø¹Ø¯ Ø±Ø³Ù… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡
            }
        });








        // [Ù…Ø­Ø¯Ø«] 4. Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹
        const unsubscribeTyping = onSnapshot(typingStatusDoc, (doc) => {
            const data = doc.data() || {};
            const now = Timestamp.now().toMillis();
            typingUsers = {};








            for (const userId in data) {
                // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
                if (userId === currentUserProfile.id) continue; 








                const timestamp = data[userId].toMillis();
                // Ø§Ø¹ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙƒØªØ¨ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ù„Ù‡ Ø£Ù‚Ù„ Ù…Ù† 5 Ø«ÙˆØ§Ù†Ù
                if (now - timestamp < 5000) { 
                    typingUsers[userId] = usersCache[userId]?.name || 'Ø¹Ø¶Ùˆ Ù…Ø¬Ù‡ÙˆÙ„';
                }
            }
            updateTypingIndicator();
        });
















        // 5. Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        let isInitialMessagesLoad = true;
        const messagesQuery = query(messagesCollection, orderBy("createdAt"), limitToLast(50));
















        const unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
            const messagesEl = pageCache.chat.querySelector('.messages');
            if (!messagesEl) return; 
















            const welcome = messagesEl.querySelector('.welcome-message');
            const isScrolledUp = messagesEl.scrollHeight - messagesEl.clientHeight > messagesEl.scrollTop + 150;








            // [Ø¥ØµÙ„Ø§Ø­ 1] Ø­ÙØ¸ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«
            const scrollHeightBefore = messagesEl.scrollHeight;
















            if (!snapshot.empty && !messagesEl.querySelector('.load-more-btn')) {
                 const loadMoreContainer = document.createElement('div');
                 loadMoreContainer.className = 'load-more-container';
                 loadMoreContainer.innerHTML = `<button class="load-more-btn" disabled>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</button>`;
                 messagesEl.prepend(loadMoreContainer);
                 setTimeout(() => {
                     const btn = messagesEl.querySelector('.load-more-btn');
                     if(btn) btn.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø£Ù‚Ø¯Ù…';
                 }, 2000);
            }
















            if (snapshot.empty && welcome) {
                welcome.innerHTML = `<h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯</h3><p>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¢Ù†!</p>`;
            } else if (welcome) {
                welcome.remove();
            }
















            let newMessagesAdded = false;
            let messagesModified = false;
            let messagesRemoved = false; // [Ø¥ØµÙ„Ø§Ø­ 1] Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø­Ø°Ù
            snapshot.docChanges().forEach((change) => {
                const msgData = { id: change.doc.id, ...change.doc.data() };
                const msgEl = messagesEl.querySelector(`[data-msg-id="${msgData.id}"]`);








                if (change.type === "added" && !msgEl) {
                    const newMsgEl = createMessageElement(msgData);
                    if (newMsgEl) {
                        // [Ø§Ù„Ø¥ØµÙ„Ø§Ø­ 2] Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© Ù‡ÙŠ Ø£ÙˆÙ„ Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù€ Snapshot 
                        // (ÙˆÙ‡Ø°Ø§ ÙŠØ­Ø¯Ø« Ø¹Ù†Ø¯Ù…Ø§ ÙŠØªÙ… Ø³Ø­Ø¨ Ø±Ø³Ø§Ù„Ø© Ù‚Ø¯ÙŠÙ…Ø© Ù„ØªØ¹ÙˆÙŠØ¶ Ø±Ø³Ø§Ù„Ø© Ù…Ø­Ø°ÙˆÙØ©)
                        if (change.newIndex === 0 && messagesEl.querySelector('.message-row')) {
                            // Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ø¯Ø±Ø§Ø¬Ù‡Ø§ Ù‚Ø¨Ù„ Ø£ÙˆÙ„ Ø±Ø³Ø§Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© (Ø§Ù„Ø£Ù‚Ø¯Ù…)
                            const firstMessageRow = messagesEl.querySelector('.message-row');
                            messagesEl.insertBefore(newMsgEl, firstMessageRow);
                        } else {
                            // ÙˆØ¥Ù„Ø§ØŒ ÙÙ‡ÙŠ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ©ØŒ Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ù„Ø­Ø§Ù‚Ù‡Ø§ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„
                            messagesEl.appendChild(newMsgEl); 
                            newMessagesAdded = true;
                        }
                    }
                }
                // [Ø¬Ø¯ÙŠØ¯] ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© Ø£Ùˆ Ø§Ù„ØªÙŠ ØªÙ… Ø§Ù„ØªÙØ§Ø¹Ù„ Ø¹Ù„ÙŠÙ‡Ø§
                if (change.type === "modified" && msgEl) {
                    const updatedMsgEl = createMessageElement(msgData);
                    if (updatedMsgEl) {
                        msgEl.replaceWith(updatedMsgEl);
                        messagesModified = true; // ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                    }
                }
                if (change.type === "removed" && msgEl) {
                    msgEl.remove();
                    messagesRemoved = true; // [Ø¥ØµÙ„Ø§Ø­ 1]
                }
            });
















            // Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ø£Ø³ÙÙ„
            const scrollToBottom = () => {
                setTimeout(() => {
                    messagesEl.scrollTop = messagesEl.scrollHeight;
                }, 0);
            };








            // [Ø¥ØµÙ„Ø§Ø­ 1] ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†Ø·Ù‚ Ø§Ù„ØªÙ…Ø±ÙŠØ±
            if (messagesRemoved) {
                // Ø¥Ø°Ø§ ØªÙ… Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø©ØŒ ÙŠØªÙ… ØªØ¹ÙˆÙŠØ¶Ù‡Ø§ Ø¨Ø±Ø³Ø§Ù„Ø© Ù‚Ø¯ÙŠÙ…Ø© (Ø§Ù„Ù€ 51).
                // Ù†Ù‚ÙˆÙ… Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù…ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø¤ÙŠØ©.
                const scrollHeightAfter = messagesEl.scrollHeight;
                const scrollDiff = scrollHeightAfter - scrollHeightBefore;
                messagesEl.scrollTop += scrollDiff;
            }
















            if (newMessagesAdded || messagesModified) { // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£ÙŠØ¶Ø§Ù‹
                if (isInitialMessagesLoad || !isScrolledUp) {
                    scrollToBottom();
                }
            } else if (isInitialMessagesLoad) {
                scrollToBottom();
            }
















            isInitialMessagesLoad = false; 
        }, (error) => {
            console.error("Messages listener failed:", error);
            showToast("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ø¦Ù„.");
        });
















        // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø§Øª Ù„Ù„Ù…ØµÙÙˆÙØ© Ù„Ø¥ÙŠÙ‚Ø§ÙÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹
        dataListeners.push(unsubscribeProfile, unsubscribeGlobalSettings, unsubscribeUsers, unsubscribeTyping, unsubscribeMessages);
    };
















    /* --- Ø¯Ø§Ù„Ø© Ø¨Ù†Ø§Ø¡ Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„ØµÙØ­Ø§Øª (Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©ØŒ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡...) --- */
    function buildPageCache() {
        contentEl.innerHTML = '';
        pageCache.chat = createChatPage();
        pageCache.members = createMembersPage();
        pageCache.settings = createSettingsPage();
        pageCache.profile = createProfilePage();
        pageCache.view_profile = document.createElement('div');
        pageCache.view_profile.id = 'view_profile_page';
        pageCache.view_profile.className = 'page page-container';
        pageCache.edit_profile = document.createElement('div');
        pageCache.edit_profile.id = 'edit_profile_page';
        pageCache.edit_profile.className = 'page';
        Object.values(pageCache).forEach(p => contentEl.appendChild(p));
    }
















    /* --- Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª --- */
    window.openPage = (pageName, btn) => {
        if (!auth.currentUser || !currentUserProfile) return;
        if (btn) setActiveNav(btn);
        preparePageForDisplay(pageName); // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø±Ø¶
        Object.values(pageCache).forEach(p => p.classList.remove('active'));
        const targetPage = pageCache[pageName];
        if (targetPage) targetPage.classList.add('active');


        // [ØªØ¹Ø¯ÙŠÙ„] Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        if (pageName === 'chat') {
            messageForm.style.display = 'flex';
        } else {
            messageForm.style.display = 'none';
        }


        // Ù…Ø³Ø­ Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø¯ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ØµÙØ­Ø©
        if (pageName !== 'chat') {
            clearReplyState();
        }
    };
















    // Ø¯Ø§Ù„Ø© ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (ØªÙØ³ØªØ®Ø¯Ù… Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…ØªØºÙŠØ± Ù…Ø«Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡)
    function preparePageForDisplay(pageName) {
        switch (pageName) {
            case 'settings': renderSettingsPage(true); break;
            case 'profile': renderProfilePage(true); break;
            case 'members': renderMembersList(); break; 
            case 'edit_profile': renderEditProfilePage(); break;
        }
    }
















    /* --- Ø¯ÙˆØ§Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø§Øª --- */
    function createChatPage() {
        const page = document.createElement('div');
        page.id = 'chat';
        page.className = 'page chat-page';
        // [ØªØ¹Ø¯ÙŠÙ„] ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù…Ù† Ù‡Ù†Ø§ Ù„Ø£Ù†Ù‡ Ø£ØµØ¨Ø­ Ø«Ø§Ø¨ØªØ§Ù‹ ÙÙŠ HTML Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        page.innerHTML = `<div class="messages" id="messages"><div class="welcome-message"><h3>Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ!</h3><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</p></div></div>`;
        
        // [ØªØ¹Ø¯ÙŠÙ„] Ø±Ø¨Ø· Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø¨Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø«Ø§Ø¨Øª
        messageForm.addEventListener('submit', sendMessage);
        clearReplyBtn.addEventListener('click', clearReplyState);
        msgInput.addEventListener('input', () => updateTypingStatus(true)); // [Ø¬Ø¯ÙŠØ¯] Ø±Ø¨Ø· Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
        openEmojiPicker.addEventListener('click', showEmojiPickerModal); // [Ø¬Ø¯ÙŠØ¯] Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
        
        return page;
    }








    // [Ù…Ø­Ø¯Ø«] Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
    function updateTypingIndicator() {
        if (!pageCache.chat) return;
        const indicator = document.querySelector('#typingIndicator'); // [ØªØ¹Ø¯ÙŠÙ„] Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø«Ø§Ø¨Øª
        const typingNames = Object.values(typingUsers);








        if (typingNames.length === 0) {
            indicator.style.display = 'none';
        } else {
            let text;
            if (typingNames.length === 1) {
                text = `${typingNames[0]} ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†...`;
            } else if (typingNames.length === 2) {
                text = `${typingNames[0]} Ùˆ ${typingNames[1]} ÙŠÙƒØªØ¨Ø§Ù† Ø§Ù„Ø¢Ù†...`;
            } else {
                text = `${typingNames[0]} Ùˆ ${typingNames.length - 1} Ø¢Ø®Ø±ÙˆÙ† ÙŠÙƒØªØ¨ÙˆÙ† Ø§Ù„Ø¢Ù†...`;
            }
            indicator.textContent = text;
            indicator.style.display = 'block';
        }
    }
















    function createMembersPage() {
        const page = document.createElement('div');
        page.id = 'members';
        page.className = 'page page-container';
        page.innerHTML = `<div class="search-bar"><input id="searchInput" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ø¶Ùˆ..."/></div><div id="membersList" class="members-list"></div>`;
        page.querySelector('#searchInput').addEventListener('input', filterMembersList);
        return page;
    }
















    function createProfilePage() {
        const page = document.createElement('div');
        page.id = 'profile';
        page.className = 'page page-container';
        return page;
    }
















    function createSettingsPage() {
        const page = document.createElement('div');
        page.id = 'settings';
        page.className = 'page page-container';
        return page;
    }








    // [Ø¬Ø¯ÙŠØ¯] Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± Ù…ÙˆØ¯Ø§Ù„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
    function showEmojiPickerModal() {
        emojiGrid.innerHTML = '';
        emojiList.forEach(emoji => {
            const span = document.createElement('span');
            span.className = 'emoji-item';
            span.textContent = emoji;
            span.onclick = () => {
                const msgInput = document.getElementById('msgInput');
                msgInput.value += emoji;
                msgInput.focus();
                emojiPickerModal.classList.remove('active');
                updateTypingStatus(true); // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¨Ø¹Ø¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
            };
            emojiGrid.appendChild(span);
        });
        
        emojiPickerModalClose.onclick = () => emojiPickerModal.classList.remove('active');
        emojiPickerModal.classList.add('active');
    }
















    /* --- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª (Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø©ØŒ ØªØ¹Ø¯ÙŠÙ„ØŒ Ø±Ø¯...) --- */








    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø­ Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø¯
    function clearReplyState() {
        replyingToMessage = null;
        const container = document.querySelector('#replyQuoteContainerWrapper'); // [ØªØ¹Ø¯ÙŠÙ„] Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø«Ø§Ø¨Øª
        if (container) container.style.display = 'none';
        document.querySelector('#msgInput').focus(); // [ØªØ¹Ø¯ÙŠÙ„] Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø«Ø§Ø¨Øª
    }
















    // Ø¯Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø¯
    function startReply(msgData) {
        const sender = usersCache[msgData.senderId] || { name: 'Ø¹Ø¶Ùˆ Ù…Ø­Ø°ÙˆÙ' };
        replyingToMessage = { 
            id: msgData.id, 
            name: sender.name, 
            text: msgData.text 
        };
        const container = document.querySelector('#replyQuoteContainerWrapper'); // [ØªØ¹Ø¯ÙŠÙ„] Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø«Ø§Ø¨Øª
        container.querySelector('#replyQuoteName').textContent = `Ø±Ø¯ Ø¹Ù„Ù‰: ${sender.name}`;
        container.querySelector('#replyQuoteText').textContent = msgData.text;
        container.style.display = 'block';
        document.querySelector('#msgInput').focus(); // [ØªØ¹Ø¯ÙŠÙ„] Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø«Ø§Ø¨Øª
        messageActionModal.classList.remove('active'); 
    }
















    // Ø¯Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    function startEdit(msgData) {
        editMessageInput.value = msgData.text;
        editMessageModal.classList.add('active');
        editMessageInput.focus();
        messageActionModal.classList.remove('active'); 
















        const saveHandler = async () => {
            const newText = editMessageInput.value.trim();
            if (newText && newText !== msgData.text) {
                await handleEditMessage(msgData.id, newText);
            }
            editMessageModal.classList.remove('active');
            editMessageSave.removeEventListener('click', saveHandler);
            editMessageCancel.removeEventListener('click', cancelHandler); // [Ø¥ØµÙ„Ø§Ø­ 2] Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ†
        };
















        const cancelHandler = () => {
            editMessageModal.classList.remove('active');
            editMessageSave.removeEventListener('click', saveHandler);
            editMessageCancel.removeEventListener('click', cancelHandler);
        };
















        editMessageSave.addEventListener('click', saveHandler);
        editMessageCancel.addEventListener('click', cancelHandler);
    }
















    // Ø¯Ø§Ù„Ø© ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Firestore
    async function handleEditMessage(messageId, newText) {
        // [Ø¥ØµÙ„Ø§Ø­ 2] ØªÙ… Ø¥Ø²Ø§Ù„Ø© showLoading(true) Ùˆ showLoading(false)
        try {
            await updateDoc(doc(messagesCollection, messageId), { 
                text: newText,
                isEdited: true, // Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
                editedAt: Timestamp.now()
            });
            showToast('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­.');
        } catch (error) {
            console.error("Error editing message:", error);
            showToast('ÙØ´Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.');
        }
    }
















    // [Ù…Ø¹Ø¯Ù„] Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    async function handleDeleteMessage(messageId) {
        messageActionModal.classList.remove('active'); 
        if(await showConfirmModal('Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©', 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠØŸ')) {
            try { await deleteDoc(doc(messagesCollection, messageId)); showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©.'); } 
            catch (error) { console.error("Error deleting message:", error); showToast('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©.'); }
        }
    }
















    // Ø¯Ø§Ù„Ø© Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    function handleCopyMessage(msgData) {
        navigator.clipboard.writeText(msgData.text).then(() => {
            showToast('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©.');
        }).catch(err => {
            console.error('Failed to copy text: ', err);
            showToast('ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø©.');
        });
        messageActionModal.classList.remove('active');
    }
















    // Ø¯Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡
    function startForward(msgData) {
        const msgInput = document.getElementById('msgInput');
        clearReplyState(); // Ù…Ø³Ø­ Ø£ÙŠ Ø­Ø§Ù„Ø© Ø±Ø¯ Ø³Ø§Ø¨Ù‚Ø©
        msgInput.value = `[Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡] ${msgData.text}`;
        msgInput.focus();
        messageActionModal.classList.remove('active');
    }








    // [Ø¬Ø¯ÙŠØ¯] Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
    function showReactionModal(msgData) {
        currentMessageToReact = msgData;
        reactionGrid.innerHTML = '';








        availableReactions.forEach(emoji => {
            const button = document.createElement('button');
            button.className = 'reaction-emoji-btn';
            button.textContent = emoji;
            button.onclick = () => handleReaction(msgData.id, emoji);
            reactionGrid.appendChild(button);
        });








        reactionModalCancel.onclick = () => reactionModal.classList.remove('active');
        reactionModal.classList.add('active');
        messageActionModal.classList.remove('active');
    }








    // [Ø¬Ø¯ÙŠØ¯] Ø¯Ø§Ù„Ø© ØªÙ†ÙÙŠØ° Ø§Ù„ØªÙØ§Ø¹Ù„
    async function handleReaction(messageId, emoji) {
        if (!currentUserProfile) return;
        reactionModal.classList.remove('active');








        const messageRef = doc(messagesCollection, messageId);
        const userId = currentUserProfile.id;








        try {
            // Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
            const msgDoc = await getDoc(messageRef);
            if (!msgDoc.exists()) return;
            const reactions = msgDoc.data().reactions || {};








            let updateNeeded = false;








            // 1. Ø¥Ø²Ø§Ù„Ø© ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø£ÙŠ Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø¢Ø®Ø±
            for (const existingEmoji in reactions) {
                const userIndex = reactions[existingEmoji].indexOf(userId);
                if (userIndex !== -1 && existingEmoji !== emoji) {
                    reactions[existingEmoji].splice(userIndex, 1);
                    if (reactions[existingEmoji].length === 0) {
                        delete reactions[existingEmoji];
                    }
                    updateNeeded = true;
                }
            }








            // 2. Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            if (reactions[emoji] && reactions[emoji].includes(userId)) {
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ (Ù„Ø£Ù†Ù‡ Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰)
                const userIndex = reactions[emoji].indexOf(userId);
                reactions[emoji].splice(userIndex, 1);
                if (reactions[emoji].length === 0) {
                    delete reactions[emoji];
                }
                updateNeeded = true;
            } else {
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙØ§Ø¹Ù„
                if (!reactions[emoji]) {
                    reactions[emoji] = [];
                }
                reactions[emoji].push(userId);
                updateNeeded = true;
            }








            if (updateNeeded) {
                await updateDoc(messageRef, { reactions: reactions });
            }








        } catch (error) {
            console.error("Error handling reaction:", error);
            showToast('ÙØ´Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.');
        }
    }
















    // [Ø¬Ø¯ÙŠØ¯] Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    function showMessageActionModal(msgData) {
        const isOwnMessage = msgData.senderId === currentUserProfile.id;
        const isAdmin = currentUserProfile.badge === 'owner' || currentUserProfile.badge === 'moderator';
















        // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        messageActionEdit.style.display = isOwnMessage ? 'block' : 'none';
        messageActionDelete.style.display = isOwnMessage || isAdmin ? 'block' : 'none';








        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹
        messageActionCopy.style.display = 'block';
        messageActionForward.style.display = 'block';
        messageActionReply.style.display = 'block';
        messageActionReact.style.display = 'block'; // [Ø¬Ø¯ÙŠØ¯]
























        // Ø±Ø¨Ø· Ø§Ù„Ø£ÙˆØ§Ù…Ø±
        messageActionEdit.onclick = () => startEdit(msgData);
        messageActionReply.onclick = () => startReply(msgData);
        messageActionReact.onclick = () => showReactionModal(msgData); // [Ø¬Ø¯ÙŠØ¯]
        messageActionCopy.onclick = () => handleCopyMessage(msgData);
        messageActionForward.onclick = () => startForward(msgData);
        messageActionDelete.onclick = () => handleDeleteMessage(msgData.id);
        messageActionCancel.onclick = () => messageActionModal.classList.remove('active');
















        messageActionModal.classList.add('active');
    }
















    async function handleDeleteMember(userId, userName) {
        if(await showConfirmModal('Ø­Ø°Ù Ø§Ù„Ø¹Ø¶Ùˆ', `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¹Ø¶Ùˆ "${userName}" ÙˆÙƒÙ„ Ø±Ø³Ø§Ø¦Ù„Ù‡ Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠØŸ`)) {
            showLoading(true);
            try {
                // Ø­Ø°Ù Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ø¶Ùˆ
                const messagesQuery = query(messagesCollection, where("senderId", "==", userId));
                const messagesSnapshot = await getDocs(messagesQuery);
                const batch = writeBatch(db);
                messagesSnapshot.forEach(doc => batch.delete(doc.ref));
                // Ø­Ø°Ù Ù…Ù„Ù Ø§Ù„Ø¹Ø¶Ùˆ
                batch.delete(doc(usersCollection, userId));
                await batch.commit(); // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØªÙŠÙ† Ù…Ø¹Ø§Ù‹
                showToast(`ØªÙ… Ø­Ø°Ù ${userName} ÙˆÙƒÙ„ Ø±Ø³Ø§Ø¦Ù„Ù‡ Ø¨Ù†Ø¬Ø§Ø­.`);
            } catch (error) {
                console.error("Error deleting member:", error); showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¹Ø¶Ùˆ.');
            } finally { showLoading(false); }
        }
    }
















    // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¹Ø¶Ùˆ (ØªÙ‚ÙŠÙŠØ¯ØŒ Ø­Ø°Ù...)
    function showMemberActionModal(user) {
        memberActionTitle.textContent = user.name;
        memberActionMute.style.display = user.isMuted ? 'none' : 'block';
        memberActionUnmute.style.display = user.isMuted ? 'block' : 'none';
















        memberActionViewProfile.onclick = () => {
            memberActionModal.classList.remove('active');
            viewUserProfile(user.id);
        };
        memberActionMute.onclick = () => handleSetMute(user.id, true);
        memberActionUnmute.onclick = () => handleSetMute(user.id, false);
        memberActionDelete.onclick = () => {
            memberActionModal.classList.remove('active'); 
            handleDeleteMember(user.id, user.name); 
        };
        memberActionCancel.onclick = () => memberActionModal.classList.remove('active');
















        memberActionModal.classList.add('active');
    }
















    // Ø¯Ø§Ù„Ø© ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„Ø¹Ø¶Ùˆ (ÙƒØªÙ…)
    async function handleSetMute(userId, isMuted) {
        try {
            await updateDoc(doc(usersCollection, userId), { isMuted: isMuted });
            showToast(isMuted ? 'ØªÙ… ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„Ø¹Ø¶Ùˆ Ø¨Ù†Ø¬Ø§Ø­.' : 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„Ø¹Ø¶Ùˆ.');
            if(usersCache[userId]) {
                usersCache[userId].isMuted = isMuted; 
            }
            renderMembersList(); 
        } catch (error) {
            console.error("Error setting mute state:", error);
            showToast('Ø­Ø¯Ø« Ø®Ø·Ø£.');
        } finally {
            memberActionModal.classList.remove('active');
        }
    }
















    /* --- === [!!] Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø·Ù„Ø¨ 3: ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ [!!] === --- */
    function renderMembersList() {
        if (!pageCache.members) return;
        const membersListEl = pageCache.members.querySelector('#membersList');
        membersListEl.innerHTML = ''; 
        const fragment = document.createDocumentFragment();
        const isAdmin = currentUserProfile.badge === 'owner' || currentUserProfile.badge === 'moderator';
















        // 1. ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒØ§Ø´ Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© ÙˆØ­Ø³Ø§Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
        const allUsers = Object.values(usersCache).map(user => {
            const minutesAgo = user.lastSeen ? (new Date() - user.lastSeen.toDate()) / 60000 : Infinity;
            const trulyOnline = user.isOnline && minutesAgo < 2; // Ù…ØªØµÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† isOnline=true ÙˆØ¢Ø®Ø± Ø¸Ù‡ÙˆØ± Ø£Ù‚Ù„ Ù…Ù† Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†
            return { ...user, trulyOnline }; // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        });
















        // 2. ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ØµÙÙˆÙØ©: Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ø­Ø³Ø¨ Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
        allUsers.sort((a, b) => {
            // 1. Online status (trulyOnline first)
            if (a.trulyOnline && !b.trulyOnline) return -1; 
            if (!a.trulyOnline && b.trulyOnline) return 1;  








            // 2. Last Seen (Descending - most recent first)
            // Ù†Ø·Ø¨Ù‚ Ù‡Ø°Ø§ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ù…ØªØ³Ø§ÙˆÙŠØ© (ÙƒÙ„Ø§Ù‡Ù…Ø§ Ù…ØªØµÙ„ Ø£Ùˆ ÙƒÙ„Ø§Ù‡Ù…Ø§ ØºÙŠØ± Ù…ØªØµÙ„)
            const aTime = a.lastSeen ? a.lastSeen.toMillis() : 0;
            const bTime = b.lastSeen ? b.lastSeen.toMillis() : 0;
            if (bTime !== aTime) return bTime - aTime; // Descending (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)








            // 3. Name (Alphabetical)
            return a.name.localeCompare(b.name); 
        });
















        // 3. Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø©
        allUsers.forEach(user => {
            const memberItemWrapper = document.createElement('div');
            memberItemWrapper.className = 'member-item-wrapper';
            memberItemWrapper.dataset.userId = user.id;
















            const memberItem = document.createElement('div');
            memberItem.className = 'member-item';
















            const muteIcon = user.isMuted ? ' ğŸ”‡' : '';
            // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙŠ Ø­Ø³Ø¨Ù†Ø§Ù‡Ø§ Ù…Ø³Ø¨Ù‚Ø§Ù‹
            const statusClass = user.trulyOnline ? 'online' : '';
            const statusText = user.trulyOnline 
                ? 'Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†' 
                : (user.lastSeen ? formatTimeAgo(user.lastSeen) : 'ØºÙŠØ± Ù…ØªØµÙ„');
















            memberItem.innerHTML = `
                <img class="member-avatar" src="${user.avatar}" alt="${user.name}" />
                <div class="member-info">
                    <h3 class="member-name">${user.name}${muteIcon}</h3>
                    <div class="member-status">${statusText}</div>
                </div>
                <div class="status-dot ${statusClass}"></div>
            `;
















            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£Ø¯Ù…Ù† AND Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ø¸Ø§Ù‡Ø± Ù„ÙŠØ³ Ù‡Ùˆ Ù†ÙØ³Ù‡
            if (isAdmin && user.id !== currentUserProfile.id) {
                memberItem.onclick = () => showMemberActionModal(user); // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
            } else {
                memberItem.onclick = () => viewUserProfile(user.id); // Ø¥Ø¸Ù‡Ø§Ø± Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ø¹Ø¶Ùˆ
            }
















            memberItemWrapper.appendChild(memberItem);
            fragment.appendChild(memberItemWrapper);
        });
        /* --- === Ù†Ù‡Ø§ÙŠØ© Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø·Ù„Ø¨ 3 === --- */
















        membersListEl.appendChild(fragment);
        filterMembersList(); // ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„Ø¨Ø­Ø«
    }
















    // Ø¯Ø§Ù„Ø© ÙÙ„ØªØ±Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ (Ø§Ù„Ø¨Ø­Ø«)
    function filterMembersList() {
        if (!pageCache.members) return;
        const searchInput = pageCache.members.querySelector('#searchInput');
        const searchTerm = searchInput.value.toLowerCase().trim();
        const membersListEl = pageCache.members.querySelector('#membersList');
















        membersListEl.querySelectorAll('.member-item-wrapper').forEach(wrapper => {
            const nameEl = wrapper.querySelector('.member-name');
            if (nameEl) {
                const name = nameEl.textContent.toLowerCase();
                wrapper.style.display = (searchTerm && !name.includes(searchTerm)) ? 'none' : 'flex';
            }
        });
    }
















    /* --- Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ --- */
    function renderProfilePage(rerender = false) {
        if (!pageCache.profile || !currentUserProfile) return;
        if (rerender || !pageCache.profile.innerHTML) {
            pageCache.profile.innerHTML = createUserProfileViewHTML(currentUserProfile, true);
            pageCache.profile.querySelector('#editProfileBtn').onclick = () => openPage('edit_profile');
        }
    }
















    /* --- Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª --- */
    function renderSettingsPage(rerender = false) {
        if (!pageCache.settings || !rerender) return;
        const settings = { ...defaultSettings, ...(currentUserProfile.settings) };
        let ownerSectionHTML = '';
        if (currentUserProfile.badge === 'owner') {
            /* --- === [!!] Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø·Ù„Ø¨ 2: ØªØºÙŠÙŠØ± Ù†Øµ Ø§Ù„Ø²Ø± [!!] === --- */
            ownerSectionHTML = `<div class="settings-section"><h2 class="settings-section-title">ğŸ‘‘ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ</h2><div class="settings-option"><button id="applyToAllBtn" class="form-btn-confirm" style="flex:1;">ØªØ·Ø¨ÙŠÙ‚ Ù…Ø¸Ù‡Ø±ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù…ÙŠØ¹ ÙÙˆØ±Ø§Ù‹</button></div><div class="settings-option"><button id="resetAllBtn" class="form-btn-cancel" style="flex:1;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ø¹Ø§Ù…</button></div><div class="settings-option"><button id="clearChatBtn" class="settings-btn-themed" style="background: var(--danger-color); flex:1;">Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</button></div></div>`;
        }
















        const bubblePaddingText = settings.bubblePadding == 1 ? 'ØµØºÙŠØ±' : (settings.bubblePadding == 2 ? 'ÙˆØ³Ø·' : 'ÙƒØ¨ÙŠØ±');
















        pageCache.settings.innerHTML = `<div class="settings-section"><h2 class="settings-section-title">Ø§Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ø¹Ø§Ù…</h2><div class="settings-option"><span class="label">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</span><input type="checkbox" id="darkModeToggle" ${settings.darkMode ? 'checked' : ''}/></div><div class="settings-option"><span class="label">Ù„ÙˆÙ† ÙÙ‚Ø§Ø¹Ø§ØªÙŠ</span><input type="color" class="settings-input-color" id="sentBubbleColor" value="${settings.sentBubbleBg}"></div><div class="settings-option"><span class="label">Ù„ÙˆÙ† ÙÙ‚Ø§Ø¹Ø§Øª Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†</span><input type="color" class="settings-input-color" id="recvBubbleColor" value="${settings.recvBubbleBg}"></div>
        
        <div class="settings-option">
            <span class="label">Ø­Ø¬Ù… Ø§Ù„Ø®Ø·</span>
            <input type="range" id="fontSizeRange" min="12" max="20" value="${settings.fontSize}" style="flex:1" />
            <span id="fontSizeValue" style="min-width: 40px; text-align: left;">${settings.fontSize}px</span>
            <button class="settings-btn-themed save-btn" id="saveFontSize" title="Ø­ÙØ¸">ğŸ’¾</button>
        </div>
        
        <div class="settings-option">
            <span class="label">Ø­Ø¬Ù… Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©</span>
            <input type="range" id="bubblePaddingRange" min="1" max="3" value="${settings.bubblePadding}" style="flex:1" />
            <span id="bubblePaddingValue" style="min-width: 40px; text-align: left;">${bubblePaddingText}</span>
            <button class="settings-btn-themed save-btn" id="saveBubblePadding" title="Ø­ÙØ¸">ğŸ’¾</button>
        </div>
















        </div><div class="settings-section"><h2 class="settings-section-title">Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</h2><div class="background-grid" id="backgroundGrid">${backgroundImages.map(img => `<div class="background-option" style="background-image: url(${img.thumb})" data-url="${img.full}"></div>`).join('')}</div><div class="settings-option" style="padding-top: 16px;"><label for="bgUpload" class="settings-btn-themed" style="flex:1; text-align:center; cursor:pointer; background: var(--accent-color);">Ø±ÙØ¹ Ø®Ù„ÙÙŠØ© Ø®Ø§ØµØ©</label><input type="file" id="bgUpload" accept="image/*" style="display:none;"></div><div class="settings-option" style="padding-top: 8px;"><button class="settings-btn-themed" id="resetBgBtn" style="background: var(--danger-color); flex:1;">Ù…Ø³Ø­ Ø§Ù„Ø®Ù„ÙÙŠØ©</button></div></div>${ownerSectionHTML}<div class="settings-section"><h2 class="settings-section-title">ÙˆØ³Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2><div class="settings-option"><input type="password" id="badgePass" class="auth-input" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="flex:1"/><button id="badgeSaveBtn" class="settings-btn-themed">Ø­ÙØ¸</button></div></div><div class="settings-section"><h2 class="settings-section-title">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·</h2><div class="settings-option"><button id="resetAllSettings" class="settings-btn-themed" style="background: var(--danger-color); flex:1;">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙŠ</button></div></div>`;
















        addSettingsEventListeners(); // Ø±Ø¨Ø· Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø¨Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    }
















    /* --- Ø¯ÙˆØ§Ù„ ØµÙØ­Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ --- */
    const showWelcomePage = () => {
      contentEl.innerHTML = `<div class="auth-page"><h1 class="auth-title">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø´Ø§Øª Ø´Ù‡Ø§Ø¨</h1><div class="auth-card" style="text-align:center;"><p>Ø§Ø¯Ø®Ù„ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</p><button id="loginBtn" class="form-btn-confirm" style="width:100%;">Ø§Ø¯Ø®Ù„ Ø§Ù„Ø¢Ù†</button></div></div>`;
      document.getElementById('loginBtn').addEventListener('click', handleLogin);
    };
















    // Ø¥Ø¸Ù‡Ø§Ø± ØµÙØ­Ø© Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
    const showNewUserProfilePage = (user) => {
      contentEl.innerHTML = ''; 
      const title = 'Ø£ÙƒÙ…Ù„ Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ';
      const buttonText = 'Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©';
      /* --- Ø¥ØµÙ„Ø§Ø­ 2: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø£ÙˆÙ„ ØµÙˆØ±Ø© --- */
      const p = { name: '', avatar: getNextAvatar('male'), gender: 'male', location: '' };
















      const formContainer = document.createElement('div');
















      formContainer.innerHTML = `<div class="auth-page"><h1 class="auth-title">${title}</h1><form class="auth-card" id="profileForm">
        
        <div style="display:flex; flex-direction:column; align-items:center; gap:4px;">
          <label for="avatarUpload">
            <img class="signup-avatar" id="avatarPreview" src="${p.avatar}" alt="Avatar" title="Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ ØµÙˆØ±Ø©" />
          </label>
          <p class="avatar-note">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© Ù„Ø±ÙØ¹ ØµÙˆØ±Ø© Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ</p>
          <input type="file" id="avatarUpload" accept="image/*" style="display:none;">
          <input type="hidden" name="avatar" value="${p.avatar}">
          <button type="button" class="settings-btn-themed" id="randomAvatarBtn" style="margin-top: 8px;">ØµÙˆØ±Ø© Ø±Ù…Ø²ÙŠØ© ØªØ§Ù„ÙŠØ©</button>
        </div>
















        <div class="auth-input-group" style="width:100%;"><label for="nameInput">Ø§Ø³Ù…Ùƒ ÙÙŠ Ø§Ù„Ø´Ø§Øª</label><input type="text" id="nameInput" name="name" class="auth-input" value="${p.name}" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§..." /></div>
        <div class="auth-input-group" style="width:100%;"><label for="locationInput">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input type="text" id="locationInput" name="location" class="auth-input" value="${p.location || ''}" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©ØŒ Ù…ØµØ±" /></div>
        <div class="gender-select"><div class="gender-option ${p.gender === 'male' ? 'selected' : ''}" data-gender="male">Ø°ÙƒÙ€Ø±</div><div class="gender-option ${p.gender === 'female' ? 'selected' : ''}" data-gender="female">Ø£Ù†Ø«Ù€Ù‰</div></div>
        <p class="error-message" id="setupError"></p>
        <div class="form-btn-group"><button type="submit" class="form-btn-confirm">${buttonText}</button></div>
      </form></div>`;
















      contentEl.appendChild(formContainer);
      const form = document.getElementById('profileForm');
      attachProfileFormListeners(form, false); // Ø±Ø¨Ø· Ø§Ù„Ø£ÙˆØ§Ù…Ø± (Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©ØŒ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ù†Ø³)
      form.addEventListener('submit', (e) => handleProfileSave(e, user, false));
    };
















    // Ø¥Ø¸Ù‡Ø§Ø± ØµÙØ­Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
    function renderEditProfilePage() {
        if (!pageCache.edit_profile || !currentUserProfile) return;
        const p = currentUserProfile;
        const title = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ';
        const buttonText = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
















        pageCache.edit_profile.innerHTML = `<div class="auth-page"><h1 class="auth-title">${title}</h1><form class="auth-card" id="editProfileForm">
        
        <div style="display:flex; flex-direction:column; align-items:center; gap:4px;">
          <label for="editAvatarUpload">
            <img class="signup-avatar" id="editAvatarPreview" src="${p.avatar}" alt="Avatar" title="Ø§Ø¶ØºØ· Ù„ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©" />
          </label>
          <p class="avatar-note">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© Ù„Ø±ÙØ¹ ØµÙˆØ±Ø© Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ</p>
          <input type="file" id="editAvatarUpload" accept="image/*" style="display:none;">
          <input type="hidden" name="avatar" value="${p.avatar}">
          <button type="button" class="settings-btn-themed" id="editRandomAvatarBtn" style="margin-top: 8px;">ØµÙˆØ±Ø© Ø±Ù…Ø²ÙŠØ© ØªØ§Ù„ÙŠØ©</button>
        </div>
















        <div class="auth-input-group" style="width:100%;"><label for="editNameInput">Ø§Ø³Ù…Ùƒ ÙÙŠ Ø§Ù„Ø´Ø§Øª</label><input type="text" id="editNameInput" name="name" class="auth-input" value="${p.name}" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§..." /></div>
        <div class="auth-input-group" style="width:100%;"><label for="editLocationInput">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input type="text" id="editLocationInput" name="location" class="auth-input" value="${p.location || ''}" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©ØŒ Ù…ØµØ±" /></div>
        <div class="gender-select"><div class="gender-option ${p.gender === 'male' ? 'selected' : ''}" data-gender="male">Ø°ÙƒÙ€Ø±</div><div class="gender-option ${p.gender === 'female' ? 'selected' : ''}" data-gender="female">Ø£Ù†Ø«Ù€Ù‰</div></div>
        <p class="error-message" id="editError"></p>
        <div class="form-btn-group"><button type="button" class="form-btn-cancel">Ø¥Ù„ØºØ§Ø¡</button><button type="submit" class="form-btn-confirm">${buttonText}</button></div>
        </form></div>`;
















        const form = pageCache.edit_profile.querySelector('#editProfileForm');
        form.querySelector('.form-btn-cancel').onclick = () => openPage('profile');
        attachProfileFormListeners(form, true); // Ø±Ø¨Ø· Ø§Ù„Ø£ÙˆØ§Ù…Ø± (Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©ØŒ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ù†Ø³)
        form.addEventListener('submit', (e) => handleProfileSave(e, auth.currentUser, true));
    }
















    // Ø¯Ø§Ù„Ø© Ø±Ø¨Ø· Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø¨ØµÙØ­Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ (Ù„Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ù†Ø³)
    function attachProfileFormListeners(form, isEditing = false) {
      const avatarUploadInput = form.querySelector(isEditing ? '#editAvatarUpload' : '#avatarUpload');
      const avatarPreview = form.querySelector(isEditing ? '#editAvatarPreview' : '#avatarPreview');
      const randomAvatarBtn = form.querySelector(isEditing ? '#editRandomAvatarBtn' : '#randomAvatarBtn');
      const avatarHiddenInput = form.querySelector('[name="avatar"]');
















      /* --- Ø¥ØµÙ„Ø§Ø­ 2: ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø²Ø± --- */
      randomAvatarBtn.textContent = 'ØµÙˆØ±Ø© Ø±Ù…Ø²ÙŠØ© ØªØ§Ù„ÙŠØ©';
















      // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ØµÙˆØ±Ø©
      avatarUploadInput.addEventListener('change', async (event) => {
          const file = event.target.files[0];
          if (!file) return;
















          showLoading(true);
          try {
              const compressedBase64 = await compressImage(file, 800, 0.7); // Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø©
















              if (compressedBase64.length > 700 * 1024) { 
                  showToast("Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ Ø­ØªÙ‰ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶ØºØ·. Ø­Ø§ÙˆÙ„ Ø¨ØµÙˆØ±Ø© Ø£Ø®Ø±Ù‰.");
                  avatarUploadInput.value = '';
                  showLoading(false);
                  return;
              }
















              avatarPreview.src = compressedBase64; // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¶ØºÙˆØ·Ø©
              avatarHiddenInput.value = compressedBase64; // ØªØ®Ø²ÙŠÙ†Ù‡Ø§ (ÙƒÙ†Øµ)
              randomAvatarBtn.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ
          } catch (error) {
              console.error("Image compression failed:", error);
              showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø©.");
          } finally {
              showLoading(false);
          }
      });
















      /* --- Ø¥ØµÙ„Ø§Ø­ 2: ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© `updateAvatar` Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… `getNextAvatar` --- */
      const updateAvatar = () => {
          const gender = form.querySelector('.gender-option.selected').dataset.gender;
          const newAvatar = getNextAvatar(gender); 
          avatarPreview.src = newAvatar;
          avatarHiddenInput.value = newAvatar;
          randomAvatarBtn.style.display = 'block'; 
      };
















      randomAvatarBtn.addEventListener('click', async () => {
          randomAvatarBtn.disabled = true;
          randomAvatarBtn.textContent = '...';
          await new Promise(resolve => setTimeout(resolve, 10)); 
















          try {
              updateAvatar();
















              await new Promise((resolve) => {
                  avatarPreview.onload = resolve;
                  avatarPreview.onerror = () => {
                      console.error("Failed to load next avatar image.");
                      resolve(); 
                  };
              });
















          } catch (error) {
              console.error("Error in next avatar click:", error);
          } finally {
              randomAvatarBtn.disabled = false;
              randomAvatarBtn.textContent = 'ØµÙˆØ±Ø© Ø±Ù…Ø²ÙŠØ© ØªØ§Ù„ÙŠØ©';
          }
      });
















      form.querySelectorAll('.gender-option').forEach(option => {
          option.addEventListener('click', async () => { 
              form.querySelectorAll('.gender-option').forEach(opt => opt.classList.remove('selected'));
              option.classList.add('selected');
















              randomAvatarBtn.disabled = true;
              randomAvatarBtn.textContent = '...';
              await new Promise(resolve => setTimeout(resolve, 10));
















              try {
                  updateAvatar(); 
                  await new Promise((resolve) => { 
                      avatarPreview.onload = resolve;
                      avatarPreview.onerror = resolve;
                  });
              } finally {
                  randomAvatarBtn.disabled = false;
                  randomAvatarBtn.textContent = 'ØµÙˆØ±Ø© Ø±Ù…Ø²ÙŠØ© ØªØ§Ù„ÙŠØ©';
              }
          });
      });
    }
















    /* --- Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ (Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„) --- */
    const handleProfileSave = async (event, user, isEditing = false) => {
      event.preventDefault();
      const form = event.target;
      const name = form.querySelector('[name="name"]').value.trim();
      if (!name) { 
        form.querySelector('.error-message').textContent = "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù….";
        form.querySelector('.error-message').style.display = 'block'; 
        return;
      }
      showLoading(true);
      form.querySelector('.error-message').style.display = 'none';
















      try {
        const userRef = doc(usersCollection, user.uid);
        const data = { 
            name, 
            gender: form.querySelector('.gender-option.selected').dataset.gender, 
            location: form.querySelector('[name="location"]').value.trim() 
        };
        data.avatar = form.querySelector('[name="avatar"]').value; 
















        if (isEditing) {
            await updateDoc(userRef, data);
            showToast("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
            openPage('profile'); 
        } else {
            data.badge = null; 
















            /* --- === [!!] Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø·Ù„Ø¨ 2: Ø§Ù„Ù…Ø¸Ù‡Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ [!!] === --- */
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø§Ù„Ùƒ Ù‚Ø¯ ÙˆØ¶Ø¹ Ù…Ø¸Ù‡Ø±Ø§Ù‹ Ø¹Ø§Ù…Ø§Ù‹
            if (globalSettings) {
                // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ø¹Ø§Ù… ÙƒØ¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                // Ù†Ø¯Ù…Ø¬Ù‡Ø§ Ù…Ø¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ ÙƒÙ„ Ø§Ù„Ø®ØµØ§Ø¦Øµ
                data.settings = { ...defaultSettings, ...globalSettings };
            } else {
                // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¸Ù‡Ø± Ø¹Ø§Ù…ØŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
                data.settings = defaultSettings; 
            }
            /* --- === Ù†Ù‡Ø§ÙŠØ© Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø·Ù„Ø¨ 2 === --- */
















            data.createdAt = Timestamp.now();
            data.isMuted = false; 
            data.isOnline = true;
            data.lastSeen = Timestamp.now();
            await setDoc(userRef, data);
            await initializeAppState(user); 
        }
      } catch (error) {
        console.error("Profile save failed:", error); 
        form.querySelector('.error-message').textContent = "ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.";
      } finally {
        showLoading(false);
      }
    };
















    // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø±
    window.viewUserProfile = (userId) => {
        const user = usersCache[userId];
        if (user && pageCache.view_profile) {
            pageCache.view_profile.innerHTML = createUserProfileViewHTML(user, false);
            pageCache.view_profile.querySelector('.back-btn').onclick = () => openPage('members');
            Object.values(pageCache).forEach(p => p.classList.remove('active'));
            pageCache.view_profile.classList.add('active');
        }
    }
















    // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
    function createUserProfileViewHTML(user, isOwnProfile = false) {
        const buttonsHTML = isOwnProfile 
            ? `<button class="profile-edit-btn" id="editProfileBtn" style="margin-top: 16px;">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</button>`
            : `<button class="form-btn-confirm back-btn">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø¹Ø¶Ø§Ø¡</button>`;
        return `<div class="card-section"><img class="view-profile-avatar" src="${user.avatar}" alt="${user.name}" /><h2 class="profile-name">${user.name}</h2></div><div class="profile-details-section"><div class="profile-detail-item"><span class="label">Ø§Ù„Ø¬Ù†Ø³</span><span class="value">${user.gender === 'male' ? 'Ø°ÙƒØ±' : 'Ø£Ù†Ø«Ù‰'}</span></div><div class="profile-detail-item"><span class="label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</span><span class="value">${user.location || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span></div></div>${buttonsHTML}`;
    }
















    /* --- Ø¯Ø§Ù„Ø© Ø±Ø¨Ø· Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø¨Ø£Ø²Ø±Ø§Ø± ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª --- */
    function addSettingsEventListeners() {
        const page = pageCache.settings;
        if (!page) return;
















        /* --- === [!!] Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ [!!] === ---
         * ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙˆØ±ÙŠ Ø§Ù„Ù…Ø­Ù„ÙŠ Ù‡Ù†Ø§
         * --- === Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥ØµÙ„Ø§Ø­ === ---
         */
        const updateSettings = async (newSetting) => {
            if (!currentUserProfile) return; 
















            // 1. Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ù…Ø­Ø¯Ø«Ø© Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            const updatedSettings = { ...defaultSettings, ...(currentUserProfile.settings || {}), ...newSetting };
















            try { 
                // 2. [Ø§Ù„Ø¥ØµÙ„Ø§Ø­] ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© *ÙÙˆØ±Ø§Ù‹*
                currentUserProfile.settings = updatedSettings; 
















                // 3. [Ø§Ù„Ø¥ØµÙ„Ø§Ø­] ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª *ÙÙˆØ±Ø§Ù‹* Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                applyCombinedSettings(); 
















                // 4. Ø§Ù„Ø¢Ù†ØŒ Ù†Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©)
                // Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ Ø³ÙŠØ¬Ù„Ø¨Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù„ÙƒÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ØªØ­Ø¯Ø«Øª Ø¨Ø§Ù„ÙØ¹Ù„
                await updateDoc(doc(usersCollection, currentUserProfile.id), { settings: updatedSettings }); 
            } 
            catch (error) { console.error("Failed to save settings:", error); }
        };
















        // --- Ø±Ø¨Ø· Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø§Ù„Ùƒ ---
        if (currentUserProfile.badge === 'owner') {
            page.querySelector('#applyToAllBtn').addEventListener('click', async () => { 
                showLoading(true); 
                try { 
                    // [ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„] Ø­ÙØ¸ ÙƒÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„ØªØ·Ø¨ÙŠÙ‚Ù‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù…ÙŠØ¹
                    const settingsToApply = { ...defaultSettings, ...(currentUserProfile.settings || {}) };
                    await setDoc(globalSettingsDoc, settingsToApply); 
                    showToast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ø¹Ø§Ù… ÙˆØªØ·Ø¨ÙŠÙ‚Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù…ÙŠØ¹ ÙÙˆØ±Ø§Ù‹!"); 
                } catch (e) { console.error(e); showToast("Ø­Ø¯Ø« Ø®Ø·Ø£."); } finally { showLoading(false); } 
            });
















            page.querySelector('#resetAllBtn').addEventListener('click', async () => { 
                showLoading(true); 
                try { 
                    await deleteDoc(globalSettingsDoc); 
                    showToast("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ø¹Ø§Ù…. Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©/Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©."); 
                } catch (e) { console.error(e); showToast("Ø­Ø¯Ø« Ø®Ø·Ø£."); } finally { showLoading(false); } 
            });
















            page.querySelector('#clearChatBtn').addEventListener('click', async () => {
                if(await showConfirmModal("Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„", "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø´Ø§Øª Ù„Ù„Ø¬Ù…ÙŠØ¹ Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠØŸ")){
                    showLoading(true);
                    try {
                        const allMessages = await getDocs(query(messagesCollection));
                        const batch = writeBatch(db);
                        allMessages.forEach(doc => batch.delete(doc.ref)); 
                        await batch.commit();
                        showToast("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
                    } catch(e) { console.error(e); showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Øª."); }
                    finally { showLoading(false); }
                }
            });
        }
















        // --- Ø±Ø¨Ø· Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© ---
















        // Ø±ÙØ¹ Ø®Ù„ÙÙŠØ© Ø®Ø§ØµØ©
        const bgUploadInput = page.querySelector('#bgUpload');
        bgUploadInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            showLoading(true);
            try {
                const compressedBase64 = await compressImage(file, 1200, 0.6); 
                if (compressedBase64.length > 700 * 1024) { 
                     showToast("Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ Ø­ØªÙ‰ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶ØºØ·.");
                     bgUploadInput.value = '';
                     showLoading(false);
                     return;
                }
                updateSettings({ chatBackground: compressedBase64 }); 
                page.querySelectorAll('.background-option').forEach(opt => opt.classList.remove('selected'));
                showToast("ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.");
                bgUploadInput.value = '';
            } catch (error) {
                console.error("BG compression failed:", error);
                showToast("ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ø®Ù„ÙÙŠØ©.");
            } finally {
                showLoading(false);
            }
        });
















        page.querySelector('#darkModeToggle').addEventListener('change', (e) => updateSettings({ darkMode: e.target.checked }));
        page.querySelector('#sentBubbleColor').addEventListener('change', (e) => updateSettings({ sentBubbleBg: e.target.value }));
        page.querySelector('#recvBubbleColor').addEventListener('change', (e) => updateSettings({ recvBubbleBg: e.target.value }));
















        // Ø´Ø±ÙŠØ· Ø­Ø¬Ù… Ø§Ù„Ø®Ø·
        const fontSizeRange = page.querySelector('#fontSizeRange');
        const fontSizeValue = page.querySelector('#fontSizeValue');
















        // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ ÙÙ‚Ø· Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø³Ø­Ø¨ (input)
        fontSizeRange.addEventListener('input', (e) => { 
            const newSize = e.target.value;
            fontSizeValue.textContent = `${newSize}px`; 
        });
        // 2. Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø­ÙØ¸
        page.querySelector('#saveFontSize').addEventListener('click', () => {
            const newSize = parseInt(fontSizeRange.value); 
            updateSettings({ fontSize: newSize }); 
            showToast('ØªÙ… Ø­ÙØ¸ Ø­Ø¬Ù… Ø§Ù„Ø®Ø·.');
        });
















        // Ø´Ø±ÙŠØ· Ø­Ø¬Ù… Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        const bubblePaddingRange = page.querySelector('#bubblePaddingRange');
        const bubblePaddingValue = page.querySelector('#bubblePaddingValue');
















        // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ ÙÙ‚Ø· Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø³Ø­Ø¨ (input)
        bubblePaddingRange.addEventListener('input', (e) => { 
            const val = e.target.value;
            const text = val == 1 ? 'ØµØºÙŠØ±' : (val == 2 ? 'ÙˆØ³Ø·' : 'ÙƒØ¨ÙŠØ±');
            bubblePaddingValue.textContent = text; 
        });
        // 2. Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø­ÙØ¸
        page.querySelector('#saveBubblePadding').addEventListener('click', () => {
            const newPadding = parseInt(bubblePaddingRange.value);
            updateSettings({ bubblePadding: newPadding }); 
            showToast('ØªÙ… Ø­ÙØ¸ Ø­Ø¬Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©.');
        });
















        // Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø®Ù„ÙÙŠØ§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©
        const settings = { ...defaultSettings, ...(currentUserProfile.settings) };
        page.querySelectorAll('.background-option').forEach(el => {
            if(settings.chatBackground === el.dataset.url) el.classList.add('selected');
            el.addEventListener('click', () => {
                 page.querySelectorAll('.background-option').forEach(opt => opt.classList.remove('selected'));
                 el.classList.add('selected');
                 updateSettings({ chatBackground: el.dataset.url })
                 showToast("ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ù„ÙÙŠØ©.");
            });
        });
















        // Ø²Ø± Ù…Ø³Ø­ Ø§Ù„Ø®Ù„ÙÙŠØ©
        page.querySelector('#resetBgBtn').addEventListener('click', () => { 
            page.querySelectorAll('.background-option').forEach(opt => opt.classList.remove('selected')); 
            updateSettings({ chatBackground: '' }); 
            showToast("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø®Ù„ÙÙŠØ©.");
        });
















        /* --- Ø¥ØµÙ„Ø§Ø­ 2: (ÙˆØ³Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©) --- */
        page.querySelector('#badgeSaveBtn').addEventListener('click', async () => {
            const pass = page.querySelector('#badgePass').value;
            let newBadge = null;
            let isValidPass = false;
















            if (pass === '1532') {
                newBadge = 'owner'; 
                isValidPass = true;
            } else if (pass === '2026') {
                newBadge = 'moderator'; 
                isValidPass = true;
            } else if (pass === '') {
                newBadge = null; 
                isValidPass = true;
            }
















            if (!isValidPass) {
                showToast('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.');
                page.querySelector('#badgePass').value = '';
                return;
            }
















            try { 
                await updateDoc(doc(usersCollection, currentUserProfile.id), { badge: newBadge }); 
                showToast(newBadge ? 'ØªÙ… Ù…Ù†Ø­ Ø§Ù„ÙˆØ³Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­!' : 'ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙˆØ³Ø§Ù….');
















                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙˆØ±Ø§Ù‹
                currentUserProfile.badge = newBadge; 
















                // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ
                // Ø³ÙŠØªÙ… Ù…Ø³Ø­ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ù…
                renderSettingsPage(true); 
















            } catch(error){ showToast('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸!'); }
        });
        /* --- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥ØµÙ„Ø§Ø­ 2 --- */
















        // Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©
        page.querySelector('#resetAllSettings').addEventListener('click', async () => {
             if(await showConfirmModal("Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ©ØŸ")){
                try { 
                    await updateSettings(defaultSettings); 
                    showToast('ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ©!'); 
                    renderSettingsPage(true); 
                } catch(error) { showToast('ÙØ´Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·!'); }
             }
        });
    }
















    /* --- Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© --- */
    async function sendMessage(event) {
        event.preventDefault();








        if (currentUserProfile.isMuted) {
            showToast("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Ù„Ù‚Ø¯ ØªÙ… ØªÙ‚ÙŠÙŠØ¯ Ø­Ø³Ø§Ø¨Ùƒ.");
            return;
        }








        const msgInput = document.getElementById('msgInput');
        const text = msgInput.value.trim();








        if (text && currentUserProfile) {
            const originalText = msgInput.value; 
            msgInput.value = ''; // <--- [Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© 1] Ù…Ø³Ø­ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙÙˆØ±Ø§Ù‹








            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            const messageData = { 
                text, 
                senderId: currentUserProfile.id, 
                createdAt: Timestamp.now() 
            };








            // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¯ Ø¥Ù† ÙˆØ¬Ø¯Øª
            if (replyingToMessage) {
                messageData.replyToId = replyingToMessage.id;
                messageData.replyToName = replyingToMessage.name;
                messageData.replyToText = replyingToMessage.text;
                clearReplyState(); // Ù…Ø³Ø­ Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
            }








            let messageSentSuccessfully = false;








            try { 
                // 1. Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                await addDoc(messagesCollection, messageData); 
                messageSentSuccessfully = true;
            } catch (error) { 
                console.error("Error sending message:", error);
                // 2. ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Ù†Ø¹ÙŠØ¯ Ø§Ù„Ù†Øµ ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø±Ø¯
                msgInput.value = originalText; 
                showToast("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.");
                if (messageData.replyToId) {
                    replyingToMessage = { id: messageData.replyToId, name: messageData.replyToName, text: messageData.replyToText };
                    document.querySelector('#replyQuoteContainerWrapper').style.display = 'block'; // [ØªØ¹Ø¯ÙŠÙ„] Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø«Ø§Ø¨Øª
                }
            }








            // 3. Ø¥Ø°Ø§ Ù†Ø¬Ø­ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Ù†Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© (ÙÙŠ ÙƒØªÙ„Ø© try/catch Ù…Ù†ÙØµÙ„Ø© Ù„ØªØ¬Ù†Ø¨ Ù…Ø´ÙƒÙ„Ø© "ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„")
            if (messageSentSuccessfully) {
                try {
                    await updateTypingStatus(false); 
                } catch (error) {
                    console.warn("Failed to clear typing status after send:", error);
                    // Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø£Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØµÙ„Øª Ø¨Ø§Ù„ÙØ¹Ù„
                }
            }
            
            msgInput.focus(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        }
    }
















    /* --- Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø´Ø§Øª --- */
    function createMessageElement(msgData) {
        const createdAtDate = (msgData.createdAt?.toDate) ? msgData.createdAt.toDate() : new Date();
        const sender = usersCache[msgData.senderId]; 
        if(!sender) {
            console.warn(`Sender not found in cache: ${msgData.senderId}`);
            return null; 
        }
        const isSent = msgData.senderId === currentUserProfile.id;
        const row = document.createElement('div');
        row.className = `message-row ${isSent ? 'sent' : 'recv'}`;
        row.dataset.msgId = msgData.id;
        const time = createdAtDate.toLocaleTimeString('ar-EG', { hour: 'numeric', minute: '2-digit' });
















        let badgeHTML = '';
        if (sender.badge === 'owner') badgeHTML = `ğŸ‘‘`;
        else if (sender.badge === 'moderator') badgeHTML = `ğŸ›¡ï¸`;
















        const muteIcon = sender.isMuted ? ' ğŸ”‡' : ''; 
        const editedTag = msgData.isEdited ? ' (Ù…Ø¹Ø¯Ù„Ø©)' : '';
















        // Ø¨Ù†Ø§Ø¡ ÙƒÙˆØ¯ Ø§Ù‚ØªØ¨Ø§Ø³ Ø§Ù„Ø±Ø¯
        let replyQuoteHTML = '';
        if (msgData.replyToId) {
            replyQuoteHTML = `
                <div class="reply-quote">
                    <div class="reply-quote-name">${msgData.replyToName}</div>
                    <div class="reply-quote-text">${msgData.replyToText}</div>
                </div>
            `;
        }








        // [Ø¬Ø¯ÙŠØ¯] Ø¨Ù†Ø§Ø¡ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
        let reactionsHTML = '';
        if (msgData.reactions && Object.keys(msgData.reactions).length > 0) {
            reactionsHTML = `<div class="reactions-container">`;
            for (const emoji in msgData.reactions) {
                const count = msgData.reactions[emoji].length;
                if (count > 0) {
                    // [Ø¬Ø¯ÙŠØ¯] Ø¥Ø¶Ø§ÙØ© onclick Ù„ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                    reactionsHTML += `<div class="reaction-item" onclick="handleReaction('${msgData.id}', '${emoji}')">${emoji}<span class="reaction-count">${count}</span></div>`;
                }
            }
            reactionsHTML += `</div>`;
        }
















        row.innerHTML = `<img src="${sender.avatar}" alt="${sender.name}" class="chat-avatar"><div class="bubble ${isSent ? 'sent' : 'recv'}"><div class="bubble-content">${!isSent ? `<div class="bubble-sender">${badgeHTML} ${sender.name}${muteIcon}</div>` : ''}${replyQuoteHTML}<span>${msgData.text}${editedTag}</span><div class="timestamp">${time}</div></div>${reactionsHTML}</div>`;
















        const bubble = row.querySelector('.bubble');
        const isOwnMessage = msgData.senderId === currentUserProfile.id;
        const isAdmin = currentUserProfile.badge === 'owner' || currentUserProfile.badge === 'moderator';
        const canShowFullOptions = isOwnMessage || isAdmin;
















        if (canShowFullOptions) { 
            bubble.style.cursor = 'pointer';
            bubble.title = 'Ø§Ø¶ØºØ· Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª';
            bubble.addEventListener('click', (e) => {
                e.stopPropagation(); 
                showMessageActionModal(msgData); 
            });
        } else { 
            bubble.style.cursor = 'pointer';
            bubble.title = 'Ø§Ø¶ØºØ· Ù„Ù„Ø±Ø¯ Ø£Ùˆ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø©';
            bubble.addEventListener('click', (e) => {
                e.stopPropagation(); 
                showMessageActionModal(msgData); // [Ù…Ø¹Ø¯Ù„] Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
            });
        }
















        return row;
    }
















    /* --- Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ (Ø§Ù„ØµÙˆØ±Ø©) --- */
    function updateHeaderUI(profile) {
        if (!profile) return;
        headerEl.querySelector('.avatar').src = profile.avatar;
        headerEl.querySelector('.avatar').alt = profile.name;
    };
  </script>
















  <!-- === [!!] Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ù€ Service Worker Ù„Ø¬Ø¹Ù„Ù‡ ØªØ·Ø¨ÙŠÙ‚Ø§Ù‹ [!!] === -->
  <script>
    // Service Worker registration
    if ('serviceWorker' in navigator) {
      // Define the service worker code as a string
      const swCode = `
        const CACHE_NAME = 'chat-shehab-cache-v1';
        // Cache the main HTML file on install
        self.addEventListener('install', (event) => {
          event.waitUntil(
            caches.open(CACHE_NAME).then((cache) => {
              // We cache the start_url defined in the manifest ('.')
              return cache.addAll(['.']);
            })
          );
          self.skipWaiting();
        });
















        // Activate event to clean up old caches
        self.addEventListener('activate', (event) => {
          event.waitUntil(
            caches.keys().then((cacheNames) => {
              return Promise.all(
                cacheNames.map((cacheName) => {
                  if (cacheName !== CACHE_NAME) {
                    return caches.delete(cacheName);
                  }
                })
              );
            })
          );
          return self.clients.claim();
        });
















        // Network-first strategy for a chat app
        // We want the freshest data, but fall back to cache if offline
        self.addEventListener('fetch', (event) => {
          // We only handle GET requests
          if (event.request.method !== 'GET') {
            return;
          }
          
          // For Firebase assets or fonts, use cache-first
          if (event.request.url.includes('firebasestorage.googleapis.com') || 
              event.request.url.includes('fonts.googleapis.com') ||
              event.request.url.includes('pexels.com') ||
              event.request.url.includes('placehold.co')) {
            
            event.respondWith(
              caches.open(CACHE_NAME).then((cache) => {
                return cache.match(event.request).then((cachedResponse) => {
                  const fetchPromise = fetch(event.request).then((networkResponse) => {
                    cache.put(event.request, networkResponse.clone());
                    return networkResponse;
                  });
                  // Return cached response if found, otherwise fetch
                  return cachedResponse || fetchPromise;
                });
              })
            );
            return;
          }
















          // Network-first for the main app
          event.respondWith(
            fetch(event.request).then((networkResponse) => {
              // Cache the fresh response
              return caches.open(CACHE_NAME).then((cache) => {
                cache.put(event.request, networkResponse.clone());
                return networkResponse;
              });
            }).catch(() => {
              // If network fails, try to get it from the cache
              return caches.match(event.request, {
                ignoreSearch: true // This helps match '.' which might be '/' or 'index.html'
              });
            })
          );
        });
      `;
















      // Create a Blob from the service worker string
      const swBlob = new Blob([swCode], { type: 'application/javascript' });
















      // Create an Object URL from the Blob
      const swUrl = URL.createObjectURL(swBlob);
















      // Register the service worker using the Object URL
      navigator.serviceWorker.register(swUrl)
        .then((registration) => {
          console.log('Service Worker registered successfully:', registration);
        })
        .catch((error) => {
          console.error('Service Worker registration failed:', error);
        });
    }
  </script>
  <!-- === Ù†Ù‡Ø§ÙŠØ© Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ù€ Service Worker === -->
















</body>
</html>
