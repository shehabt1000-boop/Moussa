<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">




    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>خدمات الشرقية</title>




    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="manifest.json">
   <link rel="assetlinks" href="https://shehabt1000-boop.github.io/.well-known/assetlinks.json" type="application/json">




    <meta name="theme-color" content="#1e40af">
    <script src="https://cdn.tailwindcss.com"></script>




    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">




    <style>
        /* === التعديل 1: منع التاثيرات الحركية والصور المتحركة (الأداء) === */
        * {
            transition: none !important;
            animation: none !important;
        }
        .animate-spin, .animate-ping {
            animation: none !important;
        }
        /* استخدام خط Cairo كخط أساسي للمحتوى العربي */
        body {
            font-family: 'Cairo', 'Inter', sans-serif;
            direction: rtl; /* ضمان الاتجاه من اليمين لليسار */
        }
        /* تعديلات بسيطة لـ Tailwind لدعم RTL بشكل أفضل */
        .space-x-reverse > :not([hidden]) ~ :not([hidden]) {
            --tw-space-x-reverse: 1;
        }
        /* إخفاء شريط التمرير مع الحفاظ على وظيفته */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* أيقونات SVG للنجوم (للتقييم) */
        .star-icon {
            width: 1.5rem;
            height: 1.5rem;
            fill: currentColor;
            display: inline-block;
        }
















        /* === تعديل فقاعات الشات === */
        .chat-bubble-sent {
            background-color: #1e40af; /* bg-blue-800 */
            color: white; 
            padding: 0.6rem 0.75rem; 
            border-radius: 1.25rem 1.25rem 0 1.25rem; 
            word-wrap: break-word; 
        }
        .chat-bubble-received {
            background-color: #e5e7eb; /* bg-gray-200 */
            color: #1f2937; 
            padding: 0.6rem 0.75rem; 
            border-radius: 1.25rem 1.25rem 1.25rem 0; 
            word-wrap: break-word; 
        }
















        /* truncate */
        .truncate-1-line {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 1;
        }
















        /* تقليل التباعدات الافتراضية */
        .main-padding {
            padding: 0.75rem; /* p-3 */
        }
        @media (min-width: 768px) {
            .main-padding {
                padding: 2rem; 
            }
        }
















        /* === إصلاح 1: تصغير ارتفاع البار العلوي === */
        .app-header {
            padding: 0.5rem 0.75rem; 
        }
        /* === إصلاح 1: تصغير ارتفاع بار الترحيب === */
        .welcome-header {
            padding: 0.6rem 1rem; 
        }
        /* === تنسيق حقول الإدخال (التعديل 5: تكبير الإطار) === */
        .register-input-card {
            background-color: #ffffff;
            border: 2px solid #1e40af; /* إطار نيلي غامق بسمك 2px */
            border-radius: 0.75rem; /* أكثر استدارة */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); /* ظل أقوى */
            padding: 1rem; /* زيادة الحشو الداخلي */
            /* transition: border-color 0.2s, box-shadow 0.2s;  تم إزالة الانتقال */
        }
        .register-input-card:focus-within {
            border-color: #3730a3; /* indigo-900 */
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.5); /* حلقة أقوى */
        }
        .register-input-card input, .register-input-card select, .register-input-card textarea {
            border: none !important;
            padding: 0 !important;
            box-shadow: none !important;
            outline: none !important;
            background-color: transparent !important;
        }
        /* === التعديل 2: جعل العناوين الفرعية سوداء في الوضع الفاتح === */
        .register-input-card label {
            font-size: 0.75rem;
            color: #1f2937; /* text-gray-900 */
            margin-bottom: 0.25rem;
            display: block;
        }
        /* التعديل 2: إطار صورة الملف الشخصي */
        .register-photo-preview {
            border-color: #1e40af; /* إطار نيلي غامق */
            border-width: 2px;
            padding: 0.25rem;
        }
        .register-photo-preview:hover {
            border-color: #3730a3; /* indigo-900 */
        }
        
        /* === التعديل 5: خلفية زجاجية شفافة لصفحة التسجيل === */
        .glassy-indigo-bg {
            background-color: rgba(255, 255, 255, 0.8); /* أبيض شفاف */
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }








        /* === تصغير بطاقات الدليل والوظائف في وضع الهاتف (محدث) === */
        @media (max-width: 767px) {
            /* تعديلات الدليل */
            .directory-card {
                padding: 0.5rem; /* p-2 */
            }
            .directory-card img {
                width: 2rem; /* w-8 */
                height: 2rem; /* h-8 */
            }
            .directory-card h3 {
                font-size: 0.875rem; /* text-sm */
            }
            .directory-card p {
                font-size: 0.625rem; /* text-xs - أصغر */
            }
            /* تعديلات الوظائف (3) */
            .job-listing-card {
                padding: 0.5rem; /* p-2 بدلًا من p-3 */
            }
            .job-listing-card h3 {
                font-size: 0.875rem; /* text-sm بدلًا من text-base */
            }
            .job-listing-card p {
                font-size: 0.75rem; /* أصغر */
            }
        }
        
        /* === التعديل 6: إصلاح زر التبديل (Toggle) لـ RTL === */
        .settings-toggle-container input[type="checkbox"].sr-only:checked + div:after {
            /* Override for RTL translation */
             transform: translateX(-18px) !important;
             right: 2px !important; 
             left: auto !important;
        }
        
        
        /* === التعديل 3: الوضع الداكن (Dark Mode) - تم التأكد من التباين === */
        body.dark {
            background-color: #1f2937; /* bg-gray-800 */
            color: #f3f4f6; /* text-gray-100 */
        }
        body.dark #app {
            background-color: #1f2937;
            box-shadow: none;
        }
        body.dark .bg-gray-50 {
            background-color: #1f2937;
        }
        body.dark .bg-white {
            background-color: #374151; /* bg-gray-700 */
        }
        /* === التعديل 3: جعل جميع النصوص بيضاء أو فاتحة جداً === */
        body.dark .text-gray-900, 
        body.dark .text-gray-800, 
        body.dark .text-gray-700,
        body.dark .text-gray-600 {
            color: #ffffff; /* أبيض ناصع */
        }
        body.dark .text-gray-500 {
            color: #d1d5db; /* رمادي فاتح جداً للفرعية */
        }
        body.dark .register-input-card {
            background-color: #374151;
            border-color: #4f46e5; /* indigo-600 */
        }
        body.dark .register-input-card:focus-within {
            border-color: #6366f1; /* indigo-500 */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
        }
        body.dark .register-input-card label {
            color: #ffffff; /* تفتيح لون العنوان في الوضع الداكن */
        }
        body.dark .border-gray-200 {
            border-color: #4b5563;
        }
        body.dark .border-gray-300 {
            border-color: #4b5563;
        }
        body.dark .bg-indigo-50 {
            background-color: #374151;
        }
        body.dark .bg-indigo-100 {
            background-color: #4f46e5;
        }
        body.dark .bg-red-100 {
            background-color: #ef4444;
        }
        body.dark .bg-green-100 {
            background-color: #10b981;
        }
        body.dark .chat-bubble-received {
            background-color: #4b5563;
            color: #f3f4f6;
        }
        body.dark .shadow-md {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -2px rgba(0, 0, 0, 0.5);
        }
        body.dark .glassy-indigo-bg {
            background-color: rgba(55, 65, 81, 0.9); /* bg-gray-700 شفاف */
            border: 1px solid rgba(156, 163, 175, 0.4);
        }
        body.dark .bg-gray-100 {
            background-color: #1f2937;
        }
    </style>
</head>
<body class="bg-gray-50">
















    <!-- الحاوية الرئيسية للتطبيق -->
    <div id="app" class="max-w-lg mx-auto min-h-screen bg-white shadow-lg md:max-w-2xl lg:max-w-4xl">
        <!-- سيتم حقن المحتوى هنا بواسطة جافاسكريبت -->
    </div>
















    <!-- مودال (نافذة منبثقة) عامة -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden flex items-center justify-center p-4">
        <div id="modal-content" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <!-- محتوى المودال سيتم حقنه هنا -->
        </div>
    </div>
















    <!-- ============================================= -->
    <!-- ==== بداية كود جافاسكريبت و Firebase ==== -->
    <!-- ============================================= -->
    <script type="module">
        // 1. استيراد وظائف Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithCustomToken, 
            onAuthStateChanged, 
            signOut,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            updateProfile,
            updatePassword
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            collection, 
            query, 
            where, 
            onSnapshot, 
            Timestamp,
            updateDoc,
            runTransaction,
            getDocs,
            orderBy,
            deleteDoc,
            increment,
            arrayRemove,
            arrayUnion,
            writeBatch // تم إضافة writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
















        // 2. إعدادات Firebase (من المستخدم)
        const firebaseConfig = {
          apiKey: "AIzaSyA5OiTcX95GBgiJoDHnY3y7N23o-j8hsQ8",
          authDomain: "services-cef84.firebaseapp.com",
          databaseURL: "https://services-cef84-default-rtdb.firebaseio.com",
          projectId: "services-cef84",
          storageBucket: "services-cef84.firebasestorage.app",
          messagingSenderId: "902396219187",
          appId: "1:902396219187:web:3ba084a724266afa8bb846"
        };
















        // 3. تهيئة Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
















        // 4. متغيرات الحالة العامة
        let userId = null;
        let userProfile = null;
        let currentUnsubscribe = null; 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'services-cef84'; 
















        let isRegistering = false; 
        let allUsers = []; 
















        let navigationHistory = [];








        // === إضافة ثابت للحذف التلقائي (48 ساعة) ===
        const AUTO_DELETE_MS = 48 * 60 * 60 * 1000;
        // === ثابت لتحديد حالة الاتصال (5 دقائق) ===
        const ONLINE_THRESHOLD_MS = 5 * 60 * 1000; 








        // === قائمة الوظائف الرئيسية للترتيب (محدثة) ===
        const MAIN_SERVICES_ORDER = [
            'مهندس مدني (تنفيذ)', 'مهندس معماري (تصميم)', 'مهندس شبكات', 'مهندس برمجيات', 'مهندس كهرباء قوى', 'مهندس ميكانيكا إنتاج', 'مهندس إلكترونيات', 'مهندس زراعي', 'مهندس جودة', 'مهندس بترول',
            'محاسب', 'محاسب قانوني', 'محاسب شركات', 'محاسب تكاليف', 
            'طبيب بشري', 'ممرض منزلي', 'صيادلي', 'مسعف', 'طبيب أسنان', 'طبيب بيطري',
            'كهربائي', 'سباك', 'نجار موبيليا', 'فني تبريد وتكييف', 'نقاش ودهانات', 'صيانة هواتف وكمبيوتر'
        ];








        // === دالة ترتيب الخدمات (التعديل 3) ===
        function sortServices(services) {
            const otherService = services.find(s => s.name === 'أخرى (مهن حرة/عامة)');
            const otherIndex = services.indexOf(otherService);
            if (otherIndex !== -1) {
                services.splice(otherIndex, 1); // إزالة "أخرى" مؤقتاً
            }
            
            services.sort((a, b) => {
                const indexA = MAIN_SERVICES_ORDER.indexOf(a.name);
                const indexB = MAIN_SERVICES_ORDER.indexOf(b.name);








                if (indexA !== -1 && indexB !== -1) {
                    return indexA - indexB; // كلاهما في القائمة الرئيسية: ترتيب حسب القائمة
                }
                if (indexA !== -1) {
                    return -1; // A في القائمة الرئيسية، يظهر أولاً
                }
                if (indexB !== -1) {
                    return 1; // B في القائمة الرئيسية، يظهر أولاً
                }
                return a.name.localeCompare(b.name); // لا شيء في القائمة الرئيسية: ترتيب أبجدي
            });
            
            if (otherService) {
                services.push(otherService); // إضافة "أخرى" في النهاية
            }
            
            return services;
        }








        // === قائمة الخدمات (تم تحديثها للاعتماد على الترتيب) ===
        const SERVICES_LIST_UNSORTED = [
            // مهن حرفية وخدمات منزلية (20)
            { name: 'سباك', icon: '🔧' },
            { name: 'كهربائي', icon: '💡' }, 
            { name: 'نجار موبيليا', icon: '🪚' },
            { name: 'فني تبريد وتكييف', icon: '❄️' },
            { name: 'نقاش ودهانات', icon: '🎨' },
            { name: 'فني صيانة أجهزة كهربائية', icon: '🔌' },
            { name: 'فني صيانة غسالات', icon: '🧺' },
            { name: 'فني صيانة ثلاجات', icon: '🧊' },
            { name: 'تركيب دش وستالايت', icon: '📡' },
            { name: 'تنظيف منازل ومكاتب', icon: '🧹' },
            { name: 'مكافحة حشرات', icon: '🐜' },
            { name: 'فني أمن صناعي', icon: '🚨' },
            { name: 'فني مصاعد', icon: '⬆️' },
            { name: 'فني غلايات', icon: '🔥' },
            { name: 'فني تركيب باركيه', icon: '🪵' },
            { name: 'فني تركيب ورق حائط', icon: '🖼️' },
            { name: 'فني تركيب ستائر', icon: '🪟' },
            { name: 'فني تركيب مطابخ ألوميتال', icon: '🔪' },
            { name: 'فني تنجيد وصالونات', icon: '🛋️' },
            { name: 'فني تركيب زجاج وسيكوريت', icon: '💎' },
            // مهن هندسية وتقنية (20)
            { name: 'مهندس مدني (تنفيذ)', icon: '🏗️' },
            { name: 'مهندس معماري (تصميم)', icon: '📐' },
            { name: 'مهندس شبكات', icon: '📶' },
            { name: 'مهندس برمجيات', icon: '💻' },
            { name: 'مهندس كهرباء قوى', icon: '⚡' },
            { name: 'مهندس ميكانيكا إنتاج', icon: '🏭' },
            { name: 'مهندس إلكترونيات', icon: '🔬' },
            { name: 'مهندس زراعي', icon: '🌾' },
            { name: 'مهندس جودة', icon: '✅' },
            { name: 'مهندس بترول', icon: '🛢️' },
            { name: 'صيانة هواتف وكمبيوتر', icon: '📱' },
            { name: 'فني كاميرات مراقبة', icon: '📹' },
            { name: 'مدخل بيانات', icon: '⌨️' },
            { name: 'مصمم جرافيك', icon: '🎨' },
            { name: 'مطور ويب', icon: '🌐' },
            { name: 'خبير أمن معلومات', icon: '🔒' },
            { name: 'فني دعم فني IT', icon: '📞' },
            { name: 'فني طباعة وتصوير', icon: '🖨️' },
            { name: 'فني مختبرات', icon: '🧪' },
            { name: 'أخصائي تسويق رقمي', icon: '📈' },
            // مهن مالية وقانونية وإدارية (16)
            { name: 'محاسب', icon: '💵' }, 
            { name: 'محاسب قانوني', icon: '🧾' },
            { name: 'محاسب شركات', icon: '🧮' },
            { name: 'محاسب تكاليف', icon: '💰' },
            { name: 'محامي (قضايا مدنية)', icon: '⚖️' },
            { name: 'محامي (قضايا أسرية)', icon: '📜' },
            { name: 'محامي (قضايا جنائية)', icon: '🔪' },
            { name: 'مدير مكتب/سكرتير', icon: '📁' },
            { name: 'موظف استقبال', icon: '🛎️' },
            { name: 'أمين مخزن', icon: '📦' },
            { name: 'مندوب مبيعات', icon: '💼' },
            { name: 'مدير مشتريات', icon: '🛒' },
            { name: 'مدير موارد بشرية', icon: '👥' },
            { name: 'مترجم', icon: '🌐' },
            { name: 'مدقق حسابات', icon: '🔍' },
            { name: 'مستشار مالي', icon: '💵' },
            // مهن طبية وتمريض (10)
            { name: 'طبيب بشري', icon: '⚕️' },
            { name: 'ممرض منزلي', icon: '🩺' },
            { name: 'صيادلي', icon: '💊' },
            { name: 'مسعف', icon: '🩹' },
            { name: 'طبيب أسنان', icon: '🦷' },
            { name: 'طبيب بيطري', icon: '🐕' },
            { name: 'أخصائي علاج طبيعي', icon: '🚶' },
            { name: 'أخصائي تغذية', icon: '🍎' },
            { name: 'فني أشعة', icon: '☢️' },
            { name: 'فني تحاليل طبية', icon: '🩸' },
            // مهن تعليمية (5)
            { name: 'مدرس خصوصي', icon: '✍️' },
            { name: 'مدرب رياضي', icon: '💪' },
            { name: 'مدرب كلاب', icon: '🐕' },
            { name: 'مدرب تنمية بشرية', icon: '🧠' },
            { name: 'مصحح لغوي', icon: '📝' },
            // مهن البناء والتشييد (10)
            { name: 'عامل بناء', icon: '🧱' },
            { name: 'مبيض محارة', icon: '⬜' },
            { name: 'مركب سيراميك ورخام', icon: '🔨' },
            { name: 'حداد مسلح', icon: '🔗' },
            { name: 'حداد كريتال', icon: '🛡️' },
            { name: 'ألوميتال وزجاج', icon: '🪟' },
            { name: 'فني عزل مائي وحراري', icon: '💧' },
            { name: 'فني تركيب جبس بورد', icon: '💡' },
            { name: 'مساح أراضي', icon: '📏' },
            { name: 'مقاول تشطيبات', icon: '🔑' },
            // مهن السيارات والنقل (10)
            { name: 'فني سيارات/ميكانيكي', icon: '⚙️' },
            { name: 'فني كهرباء سيارات', icon: '🔋' },
            { name: 'معلم دهان سيارات', icon: '🖌️' },
            { name: 'سائق خاص', icon: '🚗' },
            { name: 'نقل عفش', icon: '🚚' },
            { name: 'سائق شاحنة/نقل ثقيل', icon: '🚛' },
            { name: 'فني كاوتش وبطاريات', icon: '🛞' },
            { name: 'فني سمكرة سيارات', icon: '🛠️' },
            { name: 'فني غسيل وتلميع سيارات', icon: '🧼' },
            { name: 'خدمات سياحية وحجز', icon: '✈️' },
            // مهن الضيافة والإعلام (10)
            { name: 'مصور فوتوغرافي', icon: '📸' },
            { name: 'مصور فيديو', icon: '🎥' },
            { name: 'طباخ مناسبات', icon: '🧑‍🍳' },
            { name: 'شيف مطعم', icon: '🍽️' },
            { name: 'مذيع/معلق صوتي', icon: '🎤' },
            { name: 'منظم حفلات ومناسبات', icon: '🎉' },
            { name: 'مصفف شعر (كوافير)', icon: '💇' },
            { name: 'خياط / ترزي', icon: '👔' },
            { name: 'جليس مسنين', icon: '🧓' },
            { name: 'مربية أطفال', icon: '👶' },
            // مهن متنوعة (10)
            { name: 'حارس أمن', icon: '🔒' },
            { name: 'بائع/كاشير', icon: '🛒' },
            { name: 'مزارع/جنايني', icon: '🌿' },
            { name: 'فني صيانة آلات صناعية', icon: '🔩' },
            { name: 'أخصائي تخاطب', icon: '🗣️' },
            { name: 'أخصائي نفسي', icon: '🧘' },
            { name: 'فني صيانة أجهزة رياضية', icon: '🏋️' },
            { name: 'فني صيانة أجهزة طباعة', icon: '🖨️' },
            { name: 'أخصائي موارد بيئية', icon: '♻️' },
            { name: 'أخرى (مهن حرة/عامة)', icon: '👥' },
        ]; 








        const SERVICES_LIST = sortServices(SERVICES_LIST_UNSORTED);








        // قائمة مراكز ومدن الشرقية
        const SHARQIA_CITIES = [
            "الزقازيق", "بلبيس", "العاشر من رمضان", "أبو كبير", "فاقوس", "منيا القمح", 
            "ديرب نجم", "كفر صقر", "أبو حماد", "القرين", "القنايات", "مشتول السوق", 
            "ههيا", "الإبراهيمية", "أولاد صقر", "الصالحية الجديدة", "الحسينية"
        ];
















        // 5. أيقونات SVG 
        const ICONS = {
            star: `<svg class="star-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/></svg>`,
            starEmpty: `<svg class="star-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.31h5.513c.498 0 .704.656.34.985l-4.46 4.062a.562.562 0 0 0-.162.541l1.618 5.22c.19.613-.526 1.09-1.04.724l-4.59-3.44a.563.563 0 0 0-.642 0l-4.59 3.44c-.514.366-1.23-.111-1.04-.724l1.618-5.22a.562.562 0 0 0-.162-.541l-4.46-4.062a.563.563 0 0 1 .34-.985h5.513a.563.563 0 0 0 .475.31l2.125-5.112Z" /></svg>`,
            home: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" /></svg>`,
            users: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-3.741-5.582M11.995 12.75a9.004 9.004 0 0 1-5.214 0m-2.5 4.972a9.094 9.094 0 0 1 3.741-.479 3 3 0 0 1 3.741 5.582M12 12a4.5 4.5 0 1 0 0-9 4.5 4.5 0 0 0 0 9Zm-5.214 0a9.004 9.004 0 0 0 5.214 0M12 12a4.5 4.5 0 1 1 0-9 4.5 4.5 0 0 1 0 9Zm5.214 0a9.004 9.004 0 0 0-5.214 0" /></svg>`,
            add: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>`,
            profile: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>`,
            chat: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193l-3.72 3.72a.75.75 0 0 1-1.06 0l-3.72-3.72C9.847 17.1 9 16.136 9 15v-4.286c0-.97 0.616-1.813 1.5-2.097l6.75-3.375c.22-.11.459-.11.679 0l6.75 3.375Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.5c.884-.284 1.5-1.128 1.5-2.097V7.116c0-1.136.847-2.1 1.98-2.193l3.72-3.72a.75.75 0 0 1 1.06 0l3.72 3.72C16.153 5.016 17 5.98 17 7.116v4.286c0 .97-.616 1.813-1.5 2.097l-6.75 3.375a.625.625 0 0 1-.679 0L3 13.5Z" /></svg>`,
            logout: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15M12 9l-3 3m0 0 3 3m-3-3h12.75" /></svg>`,
            back: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 8.25 21 12m0 0-3.75 3.75M21 12H3" /></svg>`, // RTL back arrow
            send: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L6 12Z" /></svg>`,
            edit: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 18.07a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.862 4.487Zm0 0L19.5 7.125" /></svg>`,
            camera: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.322 2.322 0 0 1 5.86 7.5v10.375A2.322 2.322 0 0 0 8.182 20.25h8.375A2.322 2.322 0 0 0 18.916 18V7.5a2.322 2.322 0 0 1-1.077-1.325M12 9.75a2.25 2.25 0 1 0 0 4.5 2.25 2.25 0 0 0 0-4.5Z" /></svg>`,
            job: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21h16.5M4.5 3h15M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25M9 13.5h6" /></svg>`,
            trash: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.24 6.913m1.018 0h16.5M16.5 6.75h-9" /></svg>`,
            settings: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.875 1.486.82 2.668 2.05 3.37 3.568.163.33.194.71.09 1.055l-.202.73a1.125 1.125 0 0 1-.362.683l-1.704 1.705a1.125 1.125 0 0 0-.362.684l.202.73c.104.345.073.725-.09 1.055-.702 1.518-1.884 2.748-3.37 3.568a1.125 1.125 0 0 1-.645.875l-.213 1.281c-.09.542-.56.94-1.11.94h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281a1.125 1.125 0 0 1-.645-.875c-1.486-.82-2.668-2.05-3.37-3.568a1.125 1.125 0 0 1-.09-1.055l.202-.73a1.125 1.125 0 0 0-.362-.683l-1.704-1.705a1.125 1.125 0 0 0-.362-.684l.202-.73c.104-.345.073-.725-.09-1.055-.702-1.518-1.884-2.748-3.37-3.568a1.125 1.125 0 0 1-.645-.875l-.213-1.281Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>`,
            bell: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.043 5.454 1.31Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75a.75.75 0 0 0 0 1.5h-9a.75.75 0 0 0 0-1.5Z" /></svg>`,
        };
















        // 6. الحاوية الرئيسية
        const appContainer = document.getElementById('app');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalContent = document.getElementById('modal-content');








        // === متغير لتتبع حالة الاتصال ===
        let isUserOnline = false;








        // 7. وظائف مساعدة (Modal)
        function showModal(html) {
            modalContent.innerHTML = html;
            modalBackdrop.classList.remove('hidden');
        }
















        function hideModal() {
            modalBackdrop.classList.add('hidden');
            modalContent.innerHTML = '';
        }
















        function showLoading(message = 'جاري التحميل...') {
            // === التعديل 1: إزالة animate-spin ===
            const html = `
                <div class="flex flex-col items-center justify-center p-6">
                    <svg class="h-10 w-10 text-indigo-800 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-gray-700 font-medium">${message}</p>
                </div>
            `;
            showModal(html);
        }
















        function hideLoading() {
            hideModal();
        }
















        function showMessageModal(title, message, isSuccess = true) {
            const color = isSuccess ? 'text-green-600' : 'text-red-600';
            const html = `
                <h2 class="text-xl font-semibold text-center ${color} mb-4">${title}</h2>
                <p class="text-center text-gray-700">${message}</p>
                <button data-action="closeModal" class="mt-4 w-full py-2 bg-indigo-800 text-white rounded-md hover:bg-indigo-700">حسناً</button>
            `;
            showModal(html);
        }
















        // وظيفة مساعدة لضغط وتحويل الصورة إلى Base64
        function resizeAndConvertImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (readerEvent) => {
                    const img = new Image();
                    img.onload = () => {
                        const MAX_SIZE = 400; 
                        let width = img.width;
                        let height = img.height;
















                        if (width > height) {
                            if (width > MAX_SIZE) {
                                height *= MAX_SIZE / width;
                                width = MAX_SIZE;
                            }
                        } else {
                            if (height > MAX_SIZE) {
                                width *= MAX_SIZE / height;
                                height = MAX_SIZE;
                            }
                        }
















                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
















                        // التحويل إلى Base64 مع ضغط الجودة
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.6); 
                        resolve(dataUrl); 
                    };
                    img.src = readerEvent.target.result;
                };
                reader.onerror = reject;
            });
        }








        // === دالة مساعدة للحذف التلقائي (48 ساعة) ===
        async function attemptAutoDelete(docId, docData, collectionName) {
            if (!docData.createdAt || !docData.createdAt.toDate) return;
















            const postTime = docData.createdAt.toDate().getTime();
            const currentTime = Date.now();








            if (currentTime - postTime > AUTO_DELETE_MS) {
                console.log(`Attempting to auto-delete old post (${collectionName}): ${docId}`);
                try {
                    const docRef = doc(db, `artifacts/${appId}/public/data/${collectionName}`, docId);
                    await deleteDoc(docRef);
                    console.log(`Successfully auto-deleted: ${docId}`);
                    return true; // تم الحذف
                } catch (error) {
                    console.error(`Error during auto-delete of ${docId} in ${collectionName}:`, error);
                    return true; // نفترض أنه تم التعامل معه أو لا يمكن الوصول إليه
                }
            }
            return false; // لم يتم الحذف
        }








        // === دالة تحديث حالة الظهور (isOnline) (محدثة) ===
        async function updateOnlineStatus(isOnline) {
            if (userId) {
                isUserOnline = isOnline;
                try {
                    const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                    await updateDoc(userDocRef, {
                        isOnline: isOnline,
                        lastSeen: Timestamp.now()
                    });
                } catch (error) {
                    console.error("Error updating online status:", error);
                }
            }
        }








        // === التعديل 5: إصلاح مشكلة حالة الاتصال المعلقة باستخدام lastSeen ===
        function getOnlineStatusHtml(user) {
            // Check if lastSeen is within the threshold
            const lastSeenTime = user.lastSeen && user.lastSeen.toMillis ? user.lastSeen.toMillis() : 0;
            const currentTime = Date.now();
            
            // A user is considered online if:
            // 1. The 'isOnline' flag is true AND
            // 2. The 'lastSeen' timestamp is recent (within ONLINE_THRESHOLD_MS)
            const isActuallyOnline = user.isOnline && (currentTime - lastSeenTime < ONLINE_THRESHOLD_MS);


            const color = isActuallyOnline ? 'bg-green-500' : 'bg-gray-400';
            const text = isActuallyOnline ? 'متصل الآن' : 'غير متصل';
            // === التعديل 1: إزالة animate-ping ===
            const ping = isActuallyOnline ? `<span class="absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>` : '';


            return `
                <div class="flex items-center text-gray-500">
                    <span class="relative flex h-2 w-2">
                        ${ping}
                        <span class="relative inline-flex rounded-full h-2 w-2 ${color}"></span>
                    </span>
                    <span class="mr-2 text-xs font-medium">${text}</span>
                </div>
            `;
        }








        // === دالة تحديث عداد الإشعارات (محدثة - مع إعادة توجيه فورية) ===
        async function updateNotificationCount(change = 0) {
            if (userId) {
                try {
                    const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                    if (change !== 0) {
                        await updateDoc(userDocRef, {
                            unreadNotifications: increment(change)
                        });
                    }
                    // إعادة تحميل البروفايل المحلي لتحديث العداد
                    const userDoc = await getDoc(userDocRef);
                    if (userDoc.exists()) {
                        userProfile = userDoc.data();
                    }
                    
                    // === التعديل 2 و 10: إعادة توجيه فورية لتحديث الـ UI ===
                    const currentRoute = navigationHistory[navigationHistory.length - 1];
                    if (currentRoute) {
                        navigateTo(currentRoute.page, currentRoute.params);
                    }
                } catch (error) {
                    console.error("Error updating notification count:", error);
                }
            }
        }








        // === دالة إنشاء إشعار (محدثة - الإشعارات الداخلية إجبارية) ===
        async function createNotification(recipientId, type, title, linkPage, linkParams = {}) {
            if (recipientId === userId) return; // لا ترسل إشعاراً لنفسك




            // ⚠️ الإشعارات الداخلية إجبارية، لا نتحقق من إعدادات المستخدم هنا.




            const notificationsColRef = collection(db, `artifacts/${appId}/public/data/notifications`);
            await addDoc(notificationsColRef, {
                recipientId: recipientId,
                senderId: userId,
                type: type,
                title: title,
                isRead: false,
                linkPage: linkPage,
                linkParams: linkParams,
                createdAt: Timestamp.now()
            });




            // زيادة عداد الإشعارات غير المقروءة
            await updateDoc(doc(db, `artifacts/${appId}/public/data/users`, recipientId), {
                unreadNotifications: increment(1)
            });
            
            // ⚠️ ملاحظة: الإشعارات الخارجية تتطلب إعداد FCM.
        }
        
        // === دالة تحديد الإشعارات كمقروءة حسب الصفحة (جديد - الطلب 1) ===
        async function markNotificationsAsReadForPage(linkPage) {
            if (!userId) return;
            
            const notificationsColRef = collection(db, `artifacts/${appId}/public/data/notifications`);
            const q = query(notificationsColRef, 
                            where('recipientId', '==', userId), 
                            where('linkPage', '==', linkPage),
                            where('isRead', '==', false));
                            
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) return;
            
            let unreadCountChange = 0;
            const batch = writeBatch(db);
            
            snapshot.docs.forEach(doc => {
                batch.update(doc.ref, { isRead: true });
                unreadCountChange -= 1;
            });
            
            await batch.commit();
            
            // تحديث الـ userProfile محلياً وإعادة توجيه الصفحة لتحديث الـ UI
            if (unreadCountChange < 0) {
                // تحديث العداد في Firestore
                await updateNotificationCount(unreadCountChange);
            }
        }
        
        // === دالة طلب إذن الإشعارات الخارجية (تم إلغاؤها - الطلب 3) ===
        // function requestNotificationPermission() {
        //     // ... (تم إلغاء المنطق)
        // }








        // === دالة عرض صفحة الإشعارات (محدثة - إصلاح مشكلة التحميل وتحديد الكل كمقروء) ===
        async function renderNotificationsPage() {
            
            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <h1 class="text-xl font-bold">الإشعارات</h1>
                        <button data-action="goBack" class="bg-white text-indigo-800 rounded-full p-1 w-7 h-7 flex items-center justify-center hover:bg-gray-100">
                            ${ICONS.back}
                        </button>
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <div id="notifications-list" class="space-y-3">
                            <p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">جاري تحميل الإشعارات...</p>
                        </div>
                    </main>
                    
                    ${renderBottomNav(userProfile?.role === 'provider' ? 'home' : 'home')}
                </div>
            `;




            // === تحديث العداد إلى الصفر عند فتح صفحة الإشعارات ===
            if (userProfile?.unreadNotifications > 0) {
                 await updateDoc(doc(db, `artifacts/${appId}/public/data/users`, userId), {
                     unreadNotifications: 0
                 });
                 userProfile.unreadNotifications = 0;
            }




            const notificationsColRef = collection(db, `artifacts/${appId}/public/data/notifications`);
            const q = query(notificationsColRef, 
                            where('recipientId', '==', userId), 
                            orderBy('createdAt', 'desc'));








            currentUnsubscribe = onSnapshot(q, async (snapshot) => {
                const listEl = document.getElementById('notifications-list');
                if (!listEl) return;




                const notifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // === منطق تحديد الكل كمقروء في Firestore (لضمان أن الإشعارات نفسها مقروءة) ===
                const unreadNotifications = notifications.filter(n => !n.isRead);
                if (unreadNotifications.length > 0) {
                    const batch = writeBatch(db);
                    unreadNotifications.forEach(n => {
                        batch.update(doc(db, `artifacts/${appId}/public/data/notifications`, n.id), { isRead: true });
                    });
                    await batch.commit();
                }




                if (notifications.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">لا توجد إشعارات جديدة.</p>';
                    return;
                }








                listEl.innerHTML = notifications.map(n => {
                    // نعتمد على حالة isRead المخزنة في Firestore للعرض
                    const bgColor = n.isRead ? 'bg-white' : 'bg-indigo-50 border-indigo-200';
                    const dateString = n.createdAt && n.createdAt.toDate ? new Date(n.createdAt.toDate()).toLocaleString('ar-EG') : 'تاريخ غير محدد';
                    const icon = n.type === 'message' ? ICONS.chat : (n.type === 'job' ? ICONS.job : (n.type === 'rating' ? ICONS.star : ICONS.add)); // إضافة أيقونة التقييم




                    return `
                        <div data-action="readNotification" data-id="${n.id}" data-page="${n.linkPage}" data-params='${JSON.stringify(n.linkParams)}'
                             class="${bgColor} p-3 rounded-lg shadow-sm border cursor-pointer hover:shadow-md flex items-start space-x-3 space-x-reverse">
                            <span class="flex-shrink-0 text-indigo-600">${icon}</span>
                            <div class="flex-1">
                                <h3 class="text-sm font-semibold text-gray-900">${n.title}</h3>
                                <p class="text-xs text-gray-500 mt-1">${dateString}</p>
                            </div>
                        </div>
                    `;
                }).join('');
            }, (error) => {
                 console.error("Error fetching notifications: ", error);
                 document.getElementById('notifications-list').innerHTML = '<p class="text-red-500 text-center p-6 bg-white rounded-lg shadow-sm">حدث خطأ أثناء تحميل الإشعارات.</p>';
            });
        }








        // 8. وظائف التوجيه (Routing) 
        function navigateTo(page, params = {}) {
            console.log(`Navigating to: ${page}`, params);
            if (currentUnsubscribe) {
                currentUnsubscribe();
                currentUnsubscribe = null;
                console.log('Unsubscribed from real-time listener.');
            }








            // === تحديث حالة الظهور عند التنقل (محدث) ===
            if (userId) {
                updateOnlineStatus(true);
            }








            const newRoute = { page, params };
            if (page !== 'loading' && page !== 'auth' && page !== 'register') {
                const lastRoute = navigationHistory[navigationHistory.length - 1];
                if (!lastRoute || lastRoute.page !== page || JSON.stringify(lastRoute.params) !== JSON.stringify(params)) {
                    navigationHistory.push(newRoute);
                    if(navigationHistory.length > 20) {
                        navigationHistory.shift();
                    }
                }
            } else if (page === 'auth' || page === 'register') {
                navigationHistory = [];
                navigationHistory.push(newRoute);
            }
















            appContainer.innerHTML = ''; 
            window.scrollTo(0, 0);
















            // تحديث عنوان الصفحة
            document.title = getPageTitle(page);
            
            // === التعديل 7: تطبيق الوضع الداكن ===
            applyDarkMode(userProfile?.isDarkModeEnabled);
















            switch (page) {
                case 'loading':
                    renderLoadingScreen();
                    break;
                case 'auth':
                    renderAuthPage();
                    break;
                case 'register':
                    renderRegisterPage();
                    break;
                case 'clientHome':
                    renderClientHome();
                    break;
                case 'providerHome':
                    // === التعديل 1: تحديد طلبات الخدمات كمقروءة عند الدخول ===
                    markNotificationsAsReadForPage('providerHome');
                    renderProviderHome();
                    break;
                case 'category':
                    renderCategoryPage(params.category);
                    break;
                case 'directory':
                    renderDirectoryPage();
                    break;
                case 'chatList':
                    renderChatListPage();
                    break;
                case 'notifications': 
                    renderNotificationsPage();
                    break;
                case 'profile':
                    renderProfilePage(params.uid);
                    break;
                case 'editProfile': 
                    renderEditProfilePage();
                    break;
                case 'settings': 
                    renderSettingsPage();
                    break;
                case 'chat':
                    renderChatPage(params.otherUserId);
                    break;
                case 'newRequest':
                    renderNewRequestPage();
                    break;
                case 'jobListings':
                    // === التعديل 1: تحديد إعلانات الوظائف كمقروءة عند الدخول ===
                    markNotificationsAsReadForPage('jobListings');
                    renderJobListingsPage();
                    break;
                case 'jobPosting':
                    renderJobPostingPage();
                    break;
                case 'myPostings': 
                    renderMyPostingsPage();
                    break;
                default:
                    renderAuthPage(); 
            }
        }
















        function getPageTitle(page) {
            switch(page) {
                case 'auth': return 'تسجيل الدخول - مستقبل الشرقية';
                case 'register': return 'إنشاء حساب - مستقبل الشرقية';
                case 'clientHome':
                case 'providerHome': return 'الرئيسية - مستقبل الشرقية';
                case 'directory': return 'دليل المستخدمين - مستقبل الشرقية';
                case 'chatList': return 'المحادثات - مستقبل الشرقية';
                case 'notifications': return 'الإشعارات - مستقبل الشرقية'; 
                case 'jobListings': return 'الوظائف المتاحة - مستقبل الشرقية';
                case 'myPostings': return 'إعلاناتي وطلباتي - مستقبل الشرقية';
                case 'profile': return 'الملف الشخصي - مستقبل الشرقية';
                case 'settings': return 'الإعدادات - مستقبل الشرقية'; 
                default: return 'مستقبل الشرقية';
            }
        }
        
        // === التعديل 7: دالة تطبيق الوضع الداكن ===
        function applyDarkMode(isDarkModeEnabled) {
            const body = document.body;
            if (isDarkModeEnabled) {
                body.classList.add('dark');
            } else {
                body.classList.remove('dark');
            }
        }








        // === دالة مساعدة لعرض جرس الإشعارات (محدثة - الطلب 5) ===
        function renderNotificationBell() {
            const unreadCount = userProfile?.unreadNotifications || 0;
            const bellClass = unreadCount > 0 ? 'text-red-500' : 'text-white hover:text-indigo-100';
            const bellDot = unreadCount > 0 ? `
                <span class="absolute top-0 right-0 block h-4 w-4 rounded-full ring-2 ring-indigo-800 bg-red-500 text-xs text-white flex items-center justify-center -mt-1 -mr-1">
                    ${unreadCount > 9 ? '9+' : unreadCount}
                </span>
            ` : '';








            return `
                <button data-action="navigateTo" data-page="notifications" class="relative flex items-center p-1 ${bellClass} rounded-full">
                    ${bellDot}
                    ${ICONS.bell}
                    <span class="text-xs font-medium mr-1 text-white">الإشعارات</span> 
                </button>
            `;
        }








        // 9. وظائف عرض الصفحات (Render Functions)
















        function renderLoadingScreen() {
            appContainer.innerHTML = `
                <div class="flex items-center justify-center min-h-screen">
                    <div class="flex flex-col items-center">
                        <!-- === التعديل 1: إزالة animate-spin === -->
                        <svg class="h-12 w-12 text-indigo-800 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <h1 class="text-xl font-semibold text-gray-700">جاري تهيئة التطبيق...</h1>
                    </div>
                </div>
            `;
        }
















        function renderAuthPage() {
            appContainer.innerHTML = `
                <!-- === التعديل 6: تقليل الحشو الرأسي في وضع الهاتف === -->
                <div class="flex flex-col items-center justify-center min-h-screen p-4 bg-indigo-800 sm:pt-8 sm:pb-8">
                    <h1 class="text-4xl font-bold text-white mb-4">مستقبل الشرقية</h1>
                    <p class="text-lg text-indigo-100 mb-8 text-center">أهلاً بك في تطبيق خدمات محافظة الشرقية</p>
                    
                    <div class="w-full max-w-sm bg-white rounded-lg shadow-xl p-6">
                        <form id="login-form" class="space-y-4">
                            <h2 class="text-2xl font-semibold text-center text-gray-800 mb-4">تسجيل الدخول</h2>
                            <div id="login-error" class="text-red-500 text-sm text-center hidden"></div>
                            
                            <!-- التعديل 2: تطبيق تصميم الإدخال الموحد -->
                            <div class="register-input-card">
                                <label for="login-identifier">اسم المستخدم</label>
                                <input type="text" id="login-identifier" required class="mt-1 block w-full text-gray-900 text-sm" placeholder="ادخل اسم المستخدم">
                            </div>
                            <div class="register-input-card">
                                <label for="login-password">كلمة المرور</label>
                                <input type="password" id="login-password" required class="mt-1 block w-full text-gray-900 text-sm" placeholder="********">
                            </div>
                            <button type="submit" data-action="login" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                دخول
                            </button>
                        </form>
                        
                        <div class="my-4 flex items-center justify-center">
                            <span class="border-t border-gray-300 flex-grow"></span>
                            <span class="px-4 text-sm text-gray-500">أو</span>
                            <span class="border-t border-gray-300 flex-grow"></span>
                        </div>
                        
                        <button data-action="navigateTo" data-page="register" class="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            إنشاء حساب جديد
                        </button>
                    </div>
                </div>
            `;
        }
















        function renderRegisterPage() {
            const serviceOptions = SERVICES_LIST.map(service => 
                `<option value="${service.name}">${service.name}</option>`
            ).join('');
















            const cityOptions = SHARQIA_CITIES.map(city => 
                `<option value="${city}">${city}</option>`
            ).join('');
















            appContainer.innerHTML = `
                <!-- التعديل 5: تغيير خلفية الشاشة لـ indigo-800 -->
                <div class="min-h-screen main-padding bg-indigo-800 flex items-start justify-center pt-8 pb-24">
                    <div class="w-full max-w-md">
                         <h1 class="text-2xl font-bold text-white mb-6 text-center">إنشاء حساب جديد</h1>
                         <!-- التعديل 5: إضافة كلاس الزجاج الشفاف -->
                        <form id="register-form" class="space-y-4 glassy-indigo-bg p-6 rounded-lg shadow-2xl mx-auto">
                            <div id="register-error" class="text-red-600 text-sm text-center font-bold hidden bg-red-100 p-2 rounded-md"></div>
                            
                            <!-- التعديل 2: تطبيق تصميم الإدخال الموحد على الصورة -->
                            <div class="register-input-card p-4">
                                <input type="file" id="photo-upload-input" accept="image/*" class="hidden">
                                <label for="photo-upload-input" class="block text-sm font-medium text-gray-900 text-center cursor-pointer">
                                    الصورة الشخصية (اختياري)
                                    <div class="mt-2 flex flex-col items-center justify-center">
                                        <img id="photo-preview" class="w-24 h-24 rounded-full object-cover register-photo-preview border-gray-300 p-1 hover:border-indigo-500" 
                                             src="https://placehold.co/100x100/EBF8FF/3182CE?text=User" alt="صورة افتراضية">
                                        <span class="text-xs text-indigo-500 mt-2 hover:underline">اضغط لرفع صورتك</span>
                                    </div>
                                </label>
                                <input type="hidden" id="photo-base64" value="">
                            </div>
                            
                            <hr class="my-3 border-gray-300">
                            
                            <!-- === تنسيق حقول التسجيل (التعديل 5) === -->
                            <div class="register-input-card">
                                <label for="register-username">اسم المستخدم</label>
                                <input type="text" id="register-username" required class="mt-1 block w-full text-gray-900 text-sm" placeholder="مثال: myname123">
                            </div>
                            
                            <div class="register-input-card">
                                <label for="register-password">كلمة المرور (6 حروف أو أرقام على الأقل)</label>
                                <input type="password" id="register-password" required minlength="6" class="mt-1 block w-full text-gray-900 text-sm" placeholder="********">
                            </div>
                            
                            <hr class="my-3 border-gray-300">
                            
                            <div class="register-input-card">
                                <label for="register-name">الاسم الكامل</label>
                                <input type="text" id="register-name" required class="mt-1 block w-full text-gray-900 text-sm" placeholder="مثال: محمد أحمد علي">
                            </div>
                            <div class="register-input-card">
                                <label for="register-phone">رقم الهاتف (11 رقم)</label>
                                <input type="tel" id="register-phone" required pattern="[0-9]{11}" maxlength="11" class="mt-1 block w-full text-gray-900 text-sm" placeholder="مثال: 01012345678">
                            </div>
                            
                            <!-- اختيار الجنس -->
                            <div class="register-input-card">
                                <label class="block text-sm font-medium text-gray-900">الجنس</label>
                                <div class="mt-1 flex space-x-4 space-x-reverse">
                                    <label class="flex items-center">
                                        <input type="radio" name="gender" value="ذكر" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" required>
                                        <span class="mr-2 text-gray-700 text-sm">ذكر</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="gender" value="أنثى" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" required>
                                        <span class="mr-2 text-gray-700 text-sm">أنثى</span>
                                    </label>
                                </div>
                            </div>
















                            
                            <!-- تقسيم العنوان -->
                            <div class="register-input-card">
                                <label for="register-city">المركز / المدينة</label>
                                <select id="register-city" required class="mt-1 block w-full text-gray-900 text-sm bg-white">
                                    <option value="">اختر المركز/المدينة</option>
                                    ${cityOptions}
                                </select>
                            </div>
                            <div class="register-input-card">
                                <label for="register-area">المنطقة / تفاصيل العنوان</label>
                                <input type="text" id="register-area" required class="mt-1 block w-full text-gray-900 text-sm" placeholder="مثال: القومية، شارع 33">
                            </div>
                            
                            <hr class="my-3 border-gray-300">
                            
                            <div class="register-input-card">
                                <label class="block text-sm font-medium text-gray-900">أرغب في التسجيل كـ:</label>
                                <div class="mt-2 flex space-x-4 space-x-reverse">
                                    <label class="flex items-center">
                                        <input type="radio" name="role" value="client" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" checked>
                                        <span class="mr-2 text-gray-700 text-sm">عميل</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="role" value="provider" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                                        <span class="mr-2 text-gray-700 text-sm">مقدم خدمة</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div id="job-title-field" class="hidden space-y-4">
                                <div class="register-input-card">
                                    <label for="register-job-select">اختر وظيفتك / الخدمة:</label>
                                    <select id="register-job-select" required class="mt-1 block w-full text-gray-900 text-sm bg-white">
                                        <option value="">اختر...</option>
                                        ${serviceOptions}
                                    </select>
                                </div>
                            </div>
                            
                            <button type="submit" data-action="register" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                إنشاء الحساب
                            </button>
                            
                            <p class="text-center text-xs text-gray-700">
                                هل لديك حساب بالفعل؟ 
                                <button type="button" data-action="navigateTo" data-page="auth" class="font-medium text-indigo-700 hover:text-indigo-900">
                                    سجل الدخول
                                </button>
                            </p>
                        </form>
                    </div>
                </div>
            `;
















            // تهيئة مستمع حدث رفع الصورة
            document.getElementById('photo-upload-input').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
















                showLoading('جاري معالجة الصورة...');
                try {
                    const base64Image = await resizeAndConvertImage(file);
                    document.getElementById('photo-preview').src = base64Image;
                    document.getElementById('photo-base64').value = base64Image;
                } catch (error) {
                    console.error("Image processing error:", error);
                    showMessageModal('خطأ في الصورة', 'لم نتمكن من معالجة الصورة. يرجى المحاولة بصورة أخرى.', false);
                } finally {
                    hideLoading();
                }
            });
        }
















        function renderClientHome() {
            const categoriesHtml = SERVICES_LIST.map(cat => `
                <div data-action="navigateTo" data-page="category" data-category="${cat.name.toLowerCase()}" 
                     class="flex flex-col items-center justify-center bg-indigo-50 p-3 rounded-lg shadow-sm hover:shadow-md cursor-pointer border border-indigo-200 hover:border-indigo-500">
                    <span class="text-3xl mb-1">${cat.icon}</span>
                    <h3 class="text-xs font-semibold text-gray-800 text-center">${cat.name}</h3>
                </div>
            `).join('');
















            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white welcome-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <div>
                            <h1 class="text-lg font-bold">أهلاً بك، ${userProfile.name}</h1>
                            <p class="text-indigo-100 text-xs">ابحث عن الخدمة التي تحتاجها في محافظة الشرقية</p>
                        </div>
                        ${renderNotificationBell()}
                    </header>
                    
                    <main class="main-padding">
                        <h2 class="text-base font-semibold text-gray-900 mb-4">أقسام الخدمات المتاحة</h2>
                        <div class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 gap-3">
                            ${categoriesHtml}
                        </div>
                    </main>
                    
                    <button data-action="navigateTo" data-page="newRequest" 
                            class="fixed bottom-16 right-4 sm:right-auto sm:left-4 bg-indigo-600 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center z-30 hover:bg-indigo-700">
                        ${ICONS.add}
                    </button>
                    
                    ${renderBottomNav('home')}
                </div>
            `;
        }
















        // === دالة الصفحة الرئيسية لمقدم الخدمة (تم تعديل الاستعلام والفرز) ===
        async function renderProviderHome() {
            const categoriesHtml = SERVICES_LIST.map(cat => `
                <div data-action="navigateTo" data-page="category" data-category="${cat.name.toLowerCase()}" 
                     class="flex flex-col items-center justify-center bg-indigo-50 p-3 rounded-lg shadow-sm hover:shadow-md cursor-pointer border border-indigo-200 hover:border-indigo-500">
                    <span class="text-3xl mb-1">${cat.icon}</span>
                    <h3 class="text-xs font-semibold text-gray-800 text-center">${cat.name}</h3>
                </div>
            `).join('');
















            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white welcome-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <div>
                            <h1 class="text-lg font-bold">أهلاً بك، ${userProfile.name}</h1>
                            <p class="text-indigo-100 text-xs">تصفح طلبات الخدمات المتاحة أو اطلب خدمة بنفسك</p>
                        </div>
                        ${renderNotificationBell()}
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <!-- طلبات الخدمات المتاحة (للوظيفة الخاصة به) -->
                        <h2 class="text-base font-semibold text-gray-900 mb-4">طلبات وظيفة ${userProfile.jobTitle || 'غير محددة'} المتاحة</h2>
                        <div id="requests-list" class="space-y-3">
                            <p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">جاري تحميل الطلبات...</p>
                        </div>
                        
                        <!-- أقسام الخدمات (ليتمكن من طلب خدمة كعميل) -->
                        <h2 class="text-base font-semibold text-gray-900 mt-6 mb-4 border-t pt-4">اطلب خدمة أو تصفح الأقسام</h2>
                        <div class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 gap-3">
                            ${categoriesHtml}
                        </div>
                    </main>
                    
                    <button data-action="navigateTo" data-page="newRequest" 
                            class="fixed bottom-16 right-4 sm:right-auto sm:left-4 bg-indigo-600 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center z-30 hover:bg-indigo-700">
                        ${ICONS.add}
                    </button>
                    
                    ${renderBottomNav('home')}
                </div>
            `;
















            const requestsColRef = collection(db, `artifacts/${appId}/public/data/serviceRequests`);
















            // 1. بحث عن الطلبات التي تتطابق مع وظيفة مقدم الخدمة (بدون orderBy)
            const jobSpecificQuery = query(requestsColRef, where('category', '==', userProfile.jobTitle));
















            currentUnsubscribe = onSnapshot(jobSpecificQuery, async (snapshot) => {
                const requestsList = document.getElementById('requests-list');
                let requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));








                // === تطبيق الحذف التلقائي ===
                const validRequests = [];
                for (const req of requests) {
                    const isDeleted = await attemptAutoDelete(req.id, req, 'serviceRequests');
                    if (!isDeleted) {
                        validRequests.push(req);
                    }
                }
                requests = validRequests;








                // === الفرز اليدوي (Client-Side Sorting) ===
                requests.sort((a, b) => {
                    const timeA = a.createdAt && a.createdAt.toMillis ? a.createdAt.toMillis() : 0;
                    const timeB = b.createdAt && b.createdAt.toMillis ? b.createdAt.toMillis() : 0;
                    return timeB - timeA;
                });
















                if (requests.length === 0) {
                    // 2. إذا لم يجد طلبات لوظيفته، يعرض رسالة "لا توجد طلبات خدمة متاحة حالياً"
                    requestsList.innerHTML = '<p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">لا توجد طلبات خدمة متاحة حالياً لوظيفة ' + (userProfile.jobTitle || 'غير محددة') + '.</p>';
                } else {
                    requestsList.innerHTML = generateRequestList(requests);
                }
            }, (error) => {
                console.error("Error fetching requests: ", error);
                document.getElementById('requests-list').innerHTML = '<p class="text-red-500 p-6 bg-white rounded-lg shadow-sm">حدث خطأ أثناء تحميل الطلبات.</p>';
            });
















            function generateRequestList(requests, emptyMessage = `لا توجد طلبات حالياً لوظيفة ${userProfile.jobTitle || 'غير محددة'}.`) {
                 if (requests.length === 0) {
                     return `<p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">${emptyMessage}</p>`;
                 }
                return requests.map(req => {
                    const dateString = req.createdAt && req.createdAt.toDate ? new Date(req.createdAt.toDate()).toLocaleDateString('ar-EG') : 'تاريخ غير محدد';
                    return `
                    <div class="bg-indigo-50 p-4 rounded-lg shadow-md border border-indigo-200">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-3 space-x-reverse">
                                <img data-action="navigateTo" data-page="profile" data-uid="${req.requesterId}"
                                     src="${req.requesterPhoto || 'https://placehold.co/100x100/EBF8FF/3182CE?text=User'}" 
                                     alt="${req.requesterName}" class="w-10 h-10 rounded-full object-cover cursor-pointer">
                                <div>
                                    <h4 data-action="navigateTo" data-page="profile" data-uid="${req.requesterId}" 
                                        class="font-semibold text-gray-800 text-sm cursor-pointer hover:text-indigo-600">${req.requesterName}</h4>
                                    <p class="text-xs text-gray-500">طلب خدمة: ${req.category}</p>
                                </div>
                            </div>
                            <span class="text-xs text-gray-400">${dateString}</span>
                        </div>
                        <h3 class="text-base font-semibold text-gray-900 mb-1">${req.title}</h3>
                        <p class="text-sm text-gray-600 mb-3">${req.description.substring(0, 100)}...</p>
                        <button data-action="navigateTo" data-page="chat" data-otheruserid="${req.requesterId}"
                                class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md text-sm font-medium hover:bg-indigo-700">
                            تواصل مع العميل
                        </button>
                    </div>
                `}).join('');
            }
        }
















        async function renderCategoryPage(categoryName) {
            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <h1 class="text-lg font-bold">مقدمو خدمة: ${categoryName || 'كل الخدمات'}</h1>
                        <button data-action="goBack" class="bg-white text-indigo-800 rounded-full p-1 w-7 h-7 flex items-center justify-center hover:bg-gray-100">
                            ${ICONS.back}
                        </button>
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <div id="providers-list" class="space-y-3">
                            <p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">جاري البحث عن مقدمي خدمات...</p>
                        </div>
                    </main>
                    
                    ${renderBottomNav('home')}
                </div>
            `;
















            const usersColRef = collection(db, `artifacts/${appId}/public/data/users`);
            const allProvidersQuery = query(usersColRef, where('role', '==', 'provider'));
















            currentUnsubscribe = onSnapshot(allProvidersQuery, (snapshot) => {
                const providersListEl = document.getElementById('providers-list');
















                // === البحث باستخدام اسم الوظيفة في حقل jobTitleSearch ===
                const providers = snapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(p => !categoryName || (p.jobTitle && p.jobTitle.toLowerCase().includes(categoryName))); 
















                if (providers.length === 0) {
                    providersListEl.innerHTML = '<p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">لا يوجد مقدمو خدمات مسجلون في هذا القسم حالياً.</p>';
                    return;
                }
















                providersListEl.innerHTML = providers.map(p => {
                    const avgRating = p.avgRating ? p.avgRating.toFixed(1) : 'جديد';
                    const ratingCount = p.ratings ? p.ratings.length : 0;








                    // === التعديل 5: عرض حالة الظهور باستخدام الدالة المحدثة ===
                    const onlineStatusHtml = getOnlineStatusHtml(p);








                    return `
                    <div class="bg-indigo-50 p-3 rounded-lg shadow-sm border border-indigo-200 flex items-center space-x-3 space-x-reverse directory-card">
                        <img data-action="navigateTo" data-page="profile" data-uid="${p.uid}"
                             src="${p.photoURL || 'https://placehold.co/100x100/EBF8FF/3182CE?text=User'}" 
                             alt="${p.name}" class="w-12 h-12 rounded-full object-cover cursor-pointer">
                        <div class="flex-1">
                            <div class="flex justify-between items-center">
                                <h3 data-action="navigateTo" data-page="profile" data-uid="${p.uid}"
                                    class="text-base font-semibold text-gray-900 cursor-pointer hover:text-indigo-600">${p.name}</h3>
                                <div class="flex items-center text-yellow-500 text-xs">
                                    <span class="font-bold mr-1">${avgRating}</span>
                                    ${ICONS.star}
                                    <span class="text-xs text-gray-500 ms-1">(${ratingCount})</span>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 truncate-1-line">${p.jobTitle}</p>
                            <div class="flex justify-between items-center">
                                <p class="text-xs text-gray-500">${p.addressCity || p.address} - ${p.addressArea || ''}</p>
                                ${onlineStatusHtml}
                            </div>
                        </div>
                        <button data-action="navigateTo" data-page="chat" data-otheruserid="${p.uid}"
                                class="flex-shrink-0 bg-indigo-100 text-indigo-700 py-1.5 px-3 rounded-md text-sm font-medium hover:bg-indigo-200">
                            تواصل
                        </button>
                    </div>
                `}).join('');
            }, (error) => {
                console.error("Error fetching providers: ", error);
                document.getElementById('providers-list').innerHTML = '<p class="text-red-500">حدث خطأ أثناء تحميل مقدمي الخدمات.</p>';
            });
        }
















        async function renderDirectoryPage() {
            function renderUserList(users) {
                const listEl = document.getElementById('directory-list');
                const searchInput = document.getElementById('search-directory');
                const searchText = searchInput ? searchInput.value.toLowerCase() : '';
















                const filteredUsers = users.filter(user => 
                    // === تطبيق إخفاء المستخدم من الدليل ===
                    !user.isDirectoryHidden && (
                        user.name.toLowerCase().includes(searchText) || 
                        (user.jobTitle && user.jobTitle.toLowerCase().includes(searchText)) ||
                        (user.username && user.username.toLowerCase().includes(searchText))
                    )
                );
                
                // === التعديل 2: فرز المستخدمين (المتصلون أولاً ثم أبجدياً) ===
                filteredUsers.sort((a, b) => {
                    const isAOnline = a.isOnline && (Date.now() - (a.lastSeen?.toMillis() || 0) < ONLINE_THRESHOLD_MS);
                    const isBOnline = b.isOnline && (Date.now() - (b.lastSeen?.toMillis() || 0) < ONLINE_THRESHOLD_MS);


                    if (isAOnline && !isBOnline) return -1; // A متصل، B ليس كذلك
                    if (!isAOnline && isBOnline) return 1;  // B متصل، A ليس كذلك


                    // إذا كانت حالة الاتصال متماثلة، فرز أبجدي
                    return a.name.localeCompare(b.name);
                });
















                if (filteredUsers.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">لم يتم العثور على مستخدمين مطابقين لنتائج البحث.</p>';
                    return;
                }
















                listEl.innerHTML = filteredUsers.map(user => {
                    const userRole = user.role === 'provider' ? (user.jobTitle || 'مقدم خدمة') : 'عميل';
                    const userColor = user.role === 'provider' ? 'text-indigo-600' : 'text-green-600';
                    // === التعديل 5: عرض حالة الظهور باستخدام الدالة المحدثة ===
                    const onlineStatusHtml = getOnlineStatusHtml(user);








                    return `
                    <div data-action="navigateTo" data-page="profile" data-uid="${user.uid}" 
                         class="bg-indigo-50 p-3 rounded-lg shadow-sm border border-indigo-200 flex items-center space-x-3 space-x-reverse cursor-pointer hover:bg-indigo-100 directory-card">
                        <img src="${user.photoURL || 'https://placehold.co/100x100/EBF8FF/3182CE?text=User'}" 
                             alt="${user.name}" class="w-8 h-8 rounded-full object-cover">
                        <div class="flex-1">
                            <h3 class="text-sm font-semibold text-gray-900">${user.name}</h3>
                            <p class="text-xs ${userColor} font-medium">${userRole}</p>
                            <div class="flex justify-between items-center">
                                <p class="text-xs text-gray-500">${user.phone}</p>
                                ${onlineStatusHtml}
                            </div>
                        </div>
                    </div>
                    `
                }).join('');
            }
















            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10">
                        <h1 class="text-xl font-bold mb-0">دليل المستخدمين</h1>
                        <!-- التعديل 2: تطبيق تصميم الإدخال الموحد على حقل البحث -->
                        <div class="register-input-card p-2 mt-2">
                            <input type="text" id="search-directory" class="w-full text-gray-900 text-sm" placeholder="ابحث بالاسم أو الوظيفة...">
                        </div>
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <div id="directory-list" class="space-y-3">
                            <p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">جاري تحميل المستخدمين...</p>
                        </div>
                    </main>
                    
                    ${renderBottomNav('directory')}
                </div>
            `;
















            const usersColRef = collection(db, `artifacts/${appId}/public/data/users`);
















            const unsubscribeDirectory = onSnapshot(usersColRef, (snapshot) => {
                allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUserList(allUsers); 
            }, (error) => {
                console.error("Error fetching all users: ", error);
                document.getElementById('directory-list').innerHTML = '<p class="text-red-500">حدث خطأ أثناء تحميل المستخدمين.</p>';
            });
















            currentUnsubscribe = unsubscribeDirectory;
















            document.getElementById('search-directory').addEventListener('input', () => {
                renderUserList(allUsers);
            });
        }
















        async function renderChatListPage() {
            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <h1 class="text-xl font-bold">المحادثات</h1>
                        <!-- تم إزالة جرس الإشعارات من هنا -->
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <div id="chat-list-container" class="space-y-3">
                            <p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">جاري تحميل المحادثات...</p>
                        </div>
                    </main>
                    
                    ${renderBottomNav('chatList')}
                </div>
            `;
















            const chatsColRef = collection(db, `artifacts/${appId}/public/data/chats`);
            const q = query(chatsColRef, where('users', 'array-contains', userId));
















            currentUnsubscribe = onSnapshot(q, async (snapshot) => {
                const listEl = document.getElementById('chat-list-container');
                if (snapshot.empty) {
                    listEl.innerHTML = '<p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">لا توجد لديك محادثات حتى الآن.</p>';
                    return;
                }








                // جلب بيانات جميع المستخدمين لضمان حالة الظهور
                const userIds = snapshot.docs.flatMap(doc => doc.data().users);
                const uniqueUserIds = [...new Set(userIds.filter(uid => uid !== userId))];
                const userPromises = uniqueUserIds.map(uid => getDoc(doc(db, `artifacts/${appId}/public/data/users`, uid)));
                const userDocs = await Promise.all(userPromises);
                const userMap = userDocs.reduce((acc, doc) => {
                    if (doc.exists()) acc[doc.id] = doc.data();
                    return acc;
                }, {});








                const chats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                chats.sort((a, b) => b.lastUpdate.toMillis() - a.lastUpdate.toMillis());
















                listEl.innerHTML = chats.map(chat => {
                    const otherUserId = chat.users.find(uid => uid !== userId);
                    const otherUser = userMap[otherUserId] || chat.userDetails[otherUserId];
                    if (!otherUser) {
                        return ''; 
                    }








                    // === التعديل 1: منطق النقطة الحمراء لرسالة غير مقروءة (يعتمد على unreadBy) ===
                    const isUnread = chat.unreadBy && chat.unreadBy.includes(userId);
                    const unreadDot = isUnread ? `<span class="absolute top-0 right-0 h-2 w-2 rounded-full bg-red-500 ring-2 ring-white -mt-1 -mr-1"></span>` : '';








                    // === التعديل 5: حالة الظهور في قائمة المحادثات باستخدام الدالة المحدثة ===
                    const onlineStatusHtml = getOnlineStatusHtml(otherUser);








                    return `
                    <div data-action="navigateTo" data-page="chat" data-otheruserid="${otherUserId}"
                         class="bg-indigo-50 p-3 rounded-lg shadow-sm border border-indigo-200 flex items-center space-x-3 space-x-reverse cursor-pointer hover:bg-indigo-100 relative">
                        <div class="relative flex-shrink-0">
                            <img src="${otherUser.photoURL || 'https://placehold.co/100x100/EBF8FF/3182CE?text=User'}" 
                                 alt="${otherUser.name}" class="w-12 h-12 rounded-full object-cover">
                            ${unreadDot}
                        </div>
                        <div class="flex-1 overflow-hidden">
                            <div class="flex items-center justify-between">
                                <h3 class="text-base font-semibold text-gray-900 truncate-1-line">${otherUser.name}</h3>
                                ${onlineStatusHtml}
                            </div>
                            <p class="text-sm text-gray-600 truncate-1-line">${chat.lastMessage}</p>
                        </div>
                        <span class="text-xs text-gray-400 flex-shrink-0">${new Date(chat.lastUpdate.toDate()).toLocaleTimeString('ar-EG', {hour: '2-digit', minute: '2-digit'})}</span>
                    </div>
                    `;
                }).join('');
















            }, (error) => {
                console.error("Error fetching chat list: ", error);
                document.getElementById('chat-list-container').innerHTML = '<p class="text-red-500">حدث خطأ أثناء تحميل المحادثات.</p>';
            });
        }
















        async function renderProfilePage(uid) {
            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <h1 class="text-xl font-bold">الملف الشخصي</h1>
                        <div class="flex items-center space-x-2 space-x-reverse">
                            <!-- === التعديل 2: زر الإعدادات مع النص === -->
                            ${uid === userId ? `
                                <button data-action="navigateTo" data-page="settings"
                                        class="flex items-center space-x-1 space-x-reverse p-1 bg-indigo-700 rounded-full text-white hover:bg-indigo-600 cursor-pointer">
                                    ${ICONS.settings}
                                    <span class="text-xs font-medium mr-1">الإعدادات</span>
                                </button>
                                <!-- === التعديل 2: زر التعديل مع النص === -->
                                <button data-action="navigateTo" data-page="editProfile"
                                        class="flex items-center space-x-1 space-x-reverse p-1 bg-indigo-700 rounded-full text-white hover:bg-indigo-600 cursor-pointer">
                                    ${ICONS.edit}
                                    <span class="text-xs font-medium mr-1">تعديل</span>
                                </button>
                            ` : ''}
                            <button data-action="goBack" class="bg-white text-indigo-800 rounded-full p-1 w-7 h-7 flex items-center justify-center hover:bg-gray-100">
                                ${ICONS.back}
                            </button>
                        </div>
                    </header>
                    
                    <main id="profile-content" class="main-padding bg-gray-50">
                        <p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">جاري تحميل الملف الشخصي...</p>
                    </main>
                    
                    ${renderBottomNav(uid === userId ? 'profile' : '')}
                </div>
            `;
















            try {
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, uid);
                const userDoc = await getDoc(userDocRef);
















                if (!userDoc.exists()) {
                    document.getElementById('profile-content').innerHTML = '<p class="text-red-500">هذا المستخدم غير موجود.</p>';
                    return;
                }
















                const profileData = userDoc.data();
                const isMyProfile = uid === userId;








                // === منطق إخفاء البيانات ===
                const showPhone = isMyProfile || !profileData.isPhoneHidden;
                const showAddress = isMyProfile || !profileData.isAddressHidden;








                const ratings = profileData.ratings || [];
                const avgRating = profileData.avgRating ? profileData.avgRating.toFixed(1) : 0;
                const ratingCount = ratings.length;
















                const clientRatings = profileData.clientRatings || [];
                const clientAvgRating = clientRatings.length > 0 ? (clientRatings.reduce((acc, r) => acc + r.stars, 0) / clientRatings.length).toFixed(1) : 0;
                const clientRatingCount = clientRatings.length;








                // === التعديل 5: حالة الظهور باستخدام الدالة المحدثة ===
                const onlineStatusHtml = getOnlineStatusHtml(profileData);








                const profileContent = document.getElementById('profile-content');
                profileContent.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-md mt-4 border border-gray-200 flex flex-col items-center">
                        <img src="${profileData.photoURL || 'https://placehold.co/150x150/EBF8FF/3182CE?text=User'}" 
                             alt="${profileData.name}" class="w-28 h-28 rounded-full object-cover shadow-lg border-4 border-white mb-3">
                        <h2 class="text-2xl font-bold text-gray-900">${profileData.name}</h2>
                        ${profileData.role === 'provider' ? 
                            `<p class="text-lg text-indigo-600 font-medium mt-1">${profileData.jobTitle || 'مقدم خدمة'}</p>` : 
                            '<p class="text-lg text-green-600 font-medium mt-1">عميل</p>'
                        }
                        <div class="mt-2">
                            ${onlineStatusHtml}
                        </div>
                        
                        ${uid !== userId ? `
                            <button data-action="navigateTo" data-page="chat" data-otheruserid="${uid}"
                                    class="mt-4 bg-indigo-600 text-white py-2 px-6 rounded-lg font-semibold text-base hover:bg-indigo-700">
                                تواصل الآن
                            </button>
                        ` : ''}
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg shadow-md mt-4 border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">بيانات التواصل</h3>
                        <div class="space-y-3">
                            <div class="flex items-start">
                                <span class="w-5 text-gray-500 mt-1">👤</span>
                                <div class="mr-3">
                                    <span class="block text-xs text-gray-500">اسم المستخدم</span>
                                    <span class="text-gray-700 font-medium text-sm">${profileData.username || 'N/A'}</span>
                                </div>
                            </div>
                            <!-- عرض الجنس -->
                            <div class="flex items-start">
                                <span class="w-5 text-gray-500 mt-1">🚻</span>
                                <div class="mr-3">
                                    <span class="block text-xs text-gray-500">الجنس</span>
                                    <span class="text-gray-700 font-medium text-sm">${profileData.gender || 'N/A'}</span>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <span class="w-5 text-gray-500 mt-1">📞</span>
                                <div class="mr-3">
                                    <span class="block text-xs text-gray-500">الرقم</span>
                                    <span class="text-gray-700 font-medium text-sm">
                                        ${showPhone ? profileData.phone : '<span class="text-red-500">مخفي</span>'}
                                    </span>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <span class="w-5 text-gray-500 mt-1">📍</span>
                                <div class="mr-3">
                                    <span class="block text-xs text-gray-500">العنوان</span>
                                    <span class="text-gray-700 font-medium text-sm">
                                        ${showAddress ? `${profileData.addressCity}، ${profileData.addressArea}` : '<span class="text-red-500">مخفي</span>'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
















                    <!-- تقييم مقدم الخدمة (إذا كان مقدم خدمة) -->
                    ${profileData.role === 'provider' ? `
                    <div class="bg-white p-4 rounded-lg shadow-md mt-4 border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">تقييمات الخدمات التي قدمها (${ratingCount})</h3>
                        <div class="flex items-center mb-4">
                            <span class="text-3xl font-bold text-yellow-500">${avgRating}</span>
                            <span class="text-xl text-gray-400 mx-2">/</span>
                            <span class="text-xl text-gray-400">5</span>
                            <div class="flex mr-4">
                                ${renderStarRating(avgRating, 5, 'h-6 w-6 text-yellow-400')}
                            </div>
                        </div>
                        
                        <div id="ratings-list" class="space-y-3 max-h-48 overflow-y-auto no-scrollbar text-sm">
                            ${ratings.length > 0 ? ratings.sort((a,b) => b.createdAt.toMillis() - a.createdAt.toMillis()).map(r => `
                                <div class="border-t border-gray-200 pt-3">
                                    <div class="flex justify-between items-center">
                                        <span class="font-semibold text-gray-800">${r.byName || 'مستخدم'}</span>
                                        <div class="flex text-yellow-400">
                                            ${renderStarRating(r.stars, 5, 'h-4 w-4')}
                                        </div>
                                    </div>
                                    <p class="text-gray-600 mt-1">${r.comment}</p>
                                </div>
                            `).join('') : '<p class="text-gray-500">لا توجد تقييمات بعد.</p>'}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- تقييم العميل (إذا كان عميل) -->
                    ${profileData.role === 'client' ? `
                    <div class="bg-white p-4 rounded-lg shadow-md mt-4 border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">تقييمات العميل من مقدمي الخدمات (${clientRatingCount})</h3>
                        <div class="flex items-center mb-4">
                            <span class="text-3xl font-bold text-yellow-500">${clientAvgRating}</span>
                            <span class="text-xl text-gray-400 mx-2">/</span>
                            <span class="text-xl text-gray-400">5</span>
                            <div class="flex mr-4">
                                ${renderStarRating(clientAvgRating, 5, 'h-6 w-6 text-yellow-400')}
                            </div>
                        </div>
                        
                        <div id="client-ratings-list" class="space-y-3 max-h-48 overflow-y-auto no-scrollbar text-sm">
                            ${clientRatings.length > 0 ? clientRatings.sort((a,b) => b.createdAt.toMillis() - a.createdAt.toMillis()).map(r => `
                                <div class="border-t border-gray-200 pt-3">
                                    <div class="flex justify-between items-center">
                                        <span class="font-semibold text-gray-800">${r.byName || 'مستخدم'}</span>
                                        <div class="flex text-yellow-400">
                                            ${renderStarRating(r.stars, 5, 'h-4 w-4')}
                                        </div>
                                    </div>
                                    <p class="text-gray-600 mt-1">${r.comment}</p>
                                </div>
                            `).join('') : '<p class="text-gray-500">لا توجد تقييمات بعد.</p>'}
                        </div>
                    </div>
                    ` : ''}
















                    
                    ${uid === userId ? `
                        <!-- إضافة زر عرض الإعلانات والطلبات -->
                        <button data-action="navigateTo" data-page="myPostings" 
                                class="mt-6 w-full bg-indigo-100 text-indigo-700 py-2 px-6 rounded-lg font-semibold text-base hover:bg-indigo-200 flex items-center justify-center space-x-2 space-x-reverse">
                            ${ICONS.job}
                            <span>عرض إعلاناتي وطلباتي</span>
                        </button>








                        <button data-action="logout" 
                                class="mt-3 w-full bg-red-100 text-red-700 py-2 px-6 rounded-lg font-semibold text-base hover:bg-red-200 flex items-center justify-center space-x-2 space-x-reverse">
                            ${ICONS.logout}
                            <span>تسجيل الخروج</span>
                        </button>
                    ` : ''}
                `;
















            } catch (error) {
                console.error("Error fetching profile: ", error);
                document.getElementById('profile-content').innerHTML = '<p class="text-red-500">حدث خطأ أثناء تحميل الملف الشخصي.</p>';
            }
        }








        // === دالة عرض صفحة الإعدادات (محدثة) ===
        function renderSettingsPage() {
            if (!userProfile) {
                navigateTo('auth');
                return;
            }








            const isPhoneHidden = userProfile.isPhoneHidden || false;
            const isAddressHidden = userProfile.isAddressHidden || false;
            const isDirectoryHidden = userProfile.isDirectoryHidden || false;
            const isNotificationsEnabled = userProfile.isNotificationsEnabled || false;
            const isMessageNotificationsEnabled = userProfile.isMessageNotificationsEnabled !== false; 
            const isJobNotificationsEnabled = userProfile.isJobNotificationsEnabled !== false; 
            const isRequestNotificationsEnabled = userProfile.isRequestNotificationsEnabled !== false; 
            const isDarkModeEnabled = userProfile.isDarkModeEnabled || false; // إعداد إضافي
            const isLocationSharingEnabled = userProfile.isLocationSharingEnabled || false; // إعداد إضافي
            // === التعديل 3: إعدادات التحكم الكامل في المنافع ===
            const chatPermission = userProfile.chatPermission || 'all';
            const ratingPermission = userProfile.ratingPermission || 'all';








            const toggleHtml = (id, label, isChecked, description) => `
                <div class="flex items-center justify-between py-3 border-b border-gray-100 settings-toggle-container">
                    <div class="flex-1 mr-4">
                        <label for="${id}" class="block text-sm font-medium text-gray-900">${label}</label>
                        <p class="text-xs text-gray-500 mt-1">${description}</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="${id}" value="" class="sr-only peer rtl-toggle-input" ${isChecked ? 'checked' : ''}>
                        <!-- التعديل 6: تم تطبيق إصلاح RTL في CSS بالأعلى -->
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:right-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                    </label>
                </div>
            `;








            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <h1 class="text-xl font-bold">إعدادات الحساب</h1>
                        <button data-action="goBack" class="bg-white text-indigo-800 rounded-full p-1 w-7 h-7 flex items-center justify-center hover:bg-gray-100">
                            ${ICONS.back}
                        </button>
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <!-- التعديل 6: تحسين تصميم صفحة الإعدادات -->
                        <div id="settings-form" class="space-y-6 bg-white p-6 rounded-lg shadow-xl max-w-md mx-auto border border-indigo-100">
                            
                            <!-- إعدادات الأمان -->
                            <div class="border-b border-indigo-200 pb-3">
                                <h2 class="text-lg font-semibold text-indigo-800">إعدادات الأمان</h2>
                            </div>
                            <button data-action="openChangePasswordModal" class="w-full bg-indigo-100 text-indigo-700 py-2 rounded-md hover:bg-indigo-200 text-sm font-medium border border-indigo-300">
                                تغيير كلمة المرور
                            </button>
                            
                            <!-- إعدادات الخصوصية -->
                            <div class="border-b border-indigo-200 pb-3 pt-2">
                                <h2 class="text-lg font-semibold text-indigo-800">إعدادات الخصوصية والظهور</h2>
                            </div>
                            ${toggleHtml('toggle-phone', 'إخفاء الرقم الشخصي', isPhoneHidden, 'لن يتمكن المستخدمون الآخرون من رؤية رقم هاتفك في ملفك الشخصي.')}
                            ${toggleHtml('toggle-address', 'إخفاء العنوان', isAddressHidden, 'لن يتمكن المستخدمون الآخرون من رؤية تفاصيل عنوانك.')}
                            ${toggleHtml('toggle-directory', 'إخفاء من الدليل', isDirectoryHidden, 'إخفاء ملفك الشخصي بالكامل من صفحة دليل المستخدمين.')}
                            
                            <!-- إعدادات التواصل -->
                            <div class="border-b border-indigo-200 pb-3 pt-2">
                                <h2 class="text-lg font-semibold text-indigo-800">إعدادات التواصل</h2>
                            </div>
                            <div class="register-input-card p-3">
                                <label for="chat-permission" class="block text-sm font-medium text-gray-900 mb-1">من يمكنه بدء محادثة معي؟</label>
                                <select id="chat-permission" class="mt-1 block w-full text-gray-900 text-sm bg-white">
                                    <option value="all" ${chatPermission === 'all' ? 'selected' : ''}>الجميع (عملاء ومقدمو خدمات)</option>
                                    <option value="providers" ${chatPermission === 'providers' ? 'selected' : ''}>مقدمو الخدمات فقط</option>
                                    <option value="clients" ${chatPermission === 'clients' ? 'selected' : ''}>العملاء فقط</option>
                                    <option value="none" ${chatPermission === 'none' ? 'selected' : ''}>لا أحد (فقط من قمت بمحادثته سابقاً)</option>
                                </select>
                            </div>
                            
                            <!-- إعدادات التقييم -->
                            <div class="border-b border-indigo-200 pb-3 pt-2">
                                <h2 class="text-lg font-semibold text-indigo-800">إعدادات التقييم</h2>
                            </div>
                            <div class="register-input-card p-3">
                                <label for="rating-permission" class="block text-sm font-medium text-gray-900 mb-1">من يمكنه تقييمي؟</label>
                                <select id="rating-permission" class="mt-1 block w-full text-gray-900 text-sm bg-white">
                                    <option value="all" ${ratingPermission === 'all' ? 'selected' : ''}>الجميع (عملاء ومقدمو خدمات)</option>
                                    <option value="providers" ${ratingPermission === 'providers' ? 'selected' : ''}>مقدمو الخدمات فقط</option>
                                    <option value="clients" ${ratingPermission === 'clients' ? 'selected' : ''}>العملاء فقط</option>
                                    <option value="none" ${ratingPermission === 'none' ? 'selected' : ''}>لا أحد</option>
                                </select>
                            </div>




                            <!-- إعدادات الإشعارات -->
                            <div class="border-b border-indigo-200 pb-3 pt-2">
                                <h2 class="text-lg font-semibold text-indigo-800">إعدادات الإشعارات (للتنبيهات الخارجية)</h2>
                            </div>
                            ${toggleHtml('toggle-notifications', 'تفعيل الإشعارات العامة', isNotificationsEnabled, 'تفعيل/إيقاف جميع الإشعارات الخارجية (ميزة قادمة).')}
                            <div class="mr-4 mt-2 p-3 bg-indigo-50 rounded-md border border-indigo-200 ${isNotificationsEnabled ? '' : 'opacity-50 pointer-events-none'}" id="custom-notifications-settings">
                                <h3 class="text-sm font-semibold text-indigo-700 mb-2">إشعارات مخصصة:</h3>
                                ${toggleHtml('toggle-msg-notifications', 'إشعارات الرسائل الجديدة', isMessageNotificationsEnabled, 'تنبيه عند استلام رسالة محادثة جديدة.')}
                                ${toggleHtml('toggle-job-notifications', 'إعلانات الوظائف الجديدة', isJobNotificationsEnabled, 'تنبيه عند نشر إعلان وظيفة جديد في مجالك.')}
                                ${toggleHtml('toggle-request-notifications', 'طلبات الخدمات الجديدة', isRequestNotificationsEnabled, 'تنبيه عند نشر طلب خدمة جديد في مجالك.')}
                            </div>




                            <!-- إعدادات العرض -->
                            <div class="border-b border-indigo-200 pb-3 pt-2">
                                <h2 class="text-lg font-semibold text-indigo-800">إعدادات العرض</h2>
                            </div>
                            ${toggleHtml('toggle-dark-mode', 'الوضع الليلي (Dark Mode)', isDarkModeEnabled, 'تفعيل الوضع الليلي ليعتمد على إعدادات متصفحك/نظامك.')}
                            
                            <!-- ميزات إضافية -->
                            <div class="border-b border-indigo-200 pb-3 pt-2">
                                <h2 class="text-lg font-semibold text-indigo-800">ميزات إضافية</h2>
                            </div>
                            ${toggleHtml('toggle-location-sharing', 'مشاركة الموقع (تقريبي)', isLocationSharingEnabled, 'مشاركة موقعك التقريبي مع مقدمي/طالبي الخدمة (ميزة قادمة).')}
                            
                            <div class="pt-4">
                                <button data-action="saveSettings" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                    حفظ الإعدادات
                                </button>
                            </div>
                        </div>
                    </main>
                    
                    ${renderBottomNav('profile')}
                </div>
            `;
            
            // تحديث حالة إعدادات الإشعارات المخصصة عند تغيير التبديل العام
            document.getElementById('toggle-notifications').addEventListener('change', (e) => {
                const customSettings = document.getElementById('custom-notifications-settings');
                if (e.target.checked) {
                    customSettings.classList.remove('opacity-50', 'pointer-events-none');
                } else {
                    customSettings.classList.add('opacity-50', 'pointer-events-none');
                }
            });
        }








        // === دالة حفظ الإعدادات (محدثة) ===
        async function handleSaveSettings() {
            showLoading('جاري حفظ الإعدادات...');








            try {
                const isPhoneHidden = document.getElementById('toggle-phone').checked;
                const isAddressHidden = document.getElementById('toggle-address').checked;
                const isDirectoryHidden = document.getElementById('toggle-directory').checked;
                const isNotificationsEnabled = document.getElementById('toggle-notifications').checked;
                const isMessageNotificationsEnabled = document.getElementById('toggle-msg-notifications').checked;
                const isJobNotificationsEnabled = document.getElementById('toggle-job-notifications').checked;
                const isRequestNotificationsEnabled = document.getElementById('toggle-request-notifications').checked;
                const isDarkModeEnabled = document.getElementById('toggle-dark-mode').checked;
                const isLocationSharingEnabled = document.getElementById('toggle-location-sharing').checked;
                // === التعديل 3: جلب إعدادات التحكم الكامل في المنافع ===
                const chatPermission = document.getElementById('chat-permission').value;
                const ratingPermission = document.getElementById('rating-permission').value;








                const updates = {
                    isPhoneHidden: isPhoneHidden,
                    isAddressHidden: isAddressHidden,
                    isDirectoryHidden: isDirectoryHidden,
                    isNotificationsEnabled: isNotificationsEnabled,
                    isMessageNotificationsEnabled: isMessageNotificationsEnabled,
                    isJobNotificationsEnabled: isJobNotificationsEnabled,
                    isRequestNotificationsEnabled: isRequestNotificationsEnabled,
                    isDarkModeEnabled: isDarkModeEnabled,
                    isLocationSharingEnabled: isLocationSharingEnabled,
                    // === التعديل 3: حفظ إعدادات التحكم الكامل في المنافع ===
                    chatPermission: chatPermission,
                    ratingPermission: ratingPermission,
                };








                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                await updateDoc(userDocRef, updates);








                // تحديث الـ userProfile المحلي
                userProfile = { ...userProfile, ...updates };
                
                // === التعديل 7: تطبيق الوضع الداكن فوراً ===
                applyDarkMode(isDarkModeEnabled);








                hideLoading();
                showMessageModal('تم الحفظ بنجاح', 'تم تحديث إعداداتك.', true);








                // === التعديل 10: تحديث فوري للصفحة ===
                setTimeout(() => {
                    navigateTo('settings');
                }, 500);








            } catch (error) {
                console.error("Save Settings Error: ", error);
                hideLoading();
                showMessageModal('خطأ', 'حدث خطأ أثناء حفظ الإعدادات. يرجى المحاولة مرة أخرى.', false);
            }
        }
        
        // === التعديل 3: دالة تغيير كلمة المرور ===
        function handleChangePasswordModal() {
            showModal(`
                <h2 class="text-xl font-semibold text-center text-indigo-800 mb-4">تغيير كلمة المرور</h2>
                <form id="change-password-form" class="space-y-4">
                    <div id="password-error" class="text-red-500 text-sm text-center hidden"></div>
                    
                    <div class="register-input-card">
                        <label for="current-password">كلمة المرور الحالية</label>
                        <input type="password" id="current-password" required class="mt-1 block w-full text-gray-900 text-sm" placeholder="********">
                    </div>
                    <div class="register-input-card">
                        <label for="new-password">كلمة المرور الجديدة (6 أحرف على الأقل)</label>
                        <input type="password" id="new-password" required minlength="6" class="mt-1 block w-full text-gray-900 text-sm" placeholder="********">
                    </div>
                    
                    <div class="flex justify-between mt-6 space-x-4 space-x-reverse">
                        <button type="button" data-action="closeModal" class="flex-1 py-2 px-4 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 text-sm">
                            إلغاء
                        </button>
                        <button type="submit" data-action="changePassword" class="flex-1 py-2 px-4 border border-transparent rounded-md text-white bg-indigo-600 hover:bg-indigo-700 text-sm">
                            تأكيد التغيير
                        </button>
                    </div>
                </form>
            `);
        }
        
        async function handleChangePassword(e) {
            e.preventDefault();
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const errorEl = document.getElementById('password-error');
            errorEl.classList.add('hidden');
            
            if (newPassword.length < 6) {
                errorEl.textContent = 'كلمة المرور الجديدة يجب أن تكون 6 أحرف أو أكثر.';
                errorEl.classList.remove('hidden');
                return;
            }
            
            showLoading('جاري تغيير كلمة المرور...');
            
            try {
                // إعادة مصادقة المستخدم أولاً (ضرورية لتغيير كلمة المرور)
                // ملاحظة: في بيئة Firebase الحقيقية، يجب استخدام reauthenticateWithCredential
                // ولكن في هذه البيئة المحدودة، نعتمد على signInWithEmailAndPassword كبديل
                await signInWithEmailAndPassword(auth, auth.currentUser.email, currentPassword);
                
                // تغيير كلمة المرور
                await updatePassword(auth.currentUser, newPassword);
                
                hideLoading();
                hideModal();
                showMessageModal('تم بنجاح', 'تم تغيير كلمة المرور بنجاح.', true);
                
            } catch (error) {
                console.error("Change Password Error: ", error);
                hideLoading();
                let errorMessage = 'حدث خطأ. يرجى المحاولة مرة أخرى.';
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password') {
                    errorMessage = 'كلمة المرور الحالية غير صحيحة.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'كلمة المرور ضعيفة جداً، يرجى استخدام 6 أحرف أو أكثر.';
                }
                
                errorEl.textContent = errorMessage;
                errorEl.classList.remove('hidden');
                // إعادة عرض المودال مع الخطأ إذا كان هناك خطأ
                if (document.getElementById('modal-content').innerHTML.includes('تغيير كلمة المرور')) {
                    showModal(document.getElementById('modal-content').innerHTML); 
                } else {
                    handleChangePasswordModal(); // إذا تم إغلاق المودال، افتحه مرة أخرى
                }
            }
        }








        // === دالة عرض إعلانات وطلبات المستخدم (تم تعديل الاستعلام والفرز) ===
        async function renderMyPostingsPage() {
            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <h1 class="text-xl font-bold">إعلاناتي وطلباتي</h1>
                        <button data-action="goBack" class="bg-white text-indigo-800 rounded-full p-1 w-7 h-7 flex items-center justify-center hover:bg-gray-100">
                            ${ICONS.back}
                        </button>
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <div id="my-postings-list" class="space-y-4">
                            <p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">جاري تحميل إعلاناتك وطلباتك...</p>
                        </div>
                    </main>
                    
                    ${renderBottomNav('profile')}
                </div>
            `;








            const listEl = document.getElementById('my-postings-list');
            showLoading('جاري تحميل بياناتك...');








            try {
                // 1. جلب طلبات الخدمات (Service Requests) - تم حذف orderBy
                const requestsColRef = collection(db, `artifacts/${appId}/public/data/serviceRequests`);
                // الاستعلام الجديد: where فقط
                const requestsQuery = query(requestsColRef, where('requesterId', '==', userId)); 
                const requestsSnapshot = await getDocs(requestsQuery);








                let requests = requestsSnapshot.docs.map(doc => ({ id: doc.id, type: 'request', ...doc.data() }));








                // تطبيق الحذف التلقائي على الطلبات
                const validRequests = [];
                for (const req of requests) {
                    const isDeleted = await attemptAutoDelete(req.id, req, 'serviceRequests');
                    if (!isDeleted) {
                        validRequests.push(req);
                    }
                }
                requests = validRequests;
















                // 2. جلب إعلانات الوظائف (Job Postings) - تم حذف orderBy
                const jobsColRef = collection(db, `artifacts/${appId}/public/data/jobPostings`);
                // الاستعلام الجديد: where فقط
                const jobsQuery = query(jobsColRef, where('posterId', '==', userId));
                const jobsSnapshot = await getDocs(jobsQuery);








                let jobs = jobsSnapshot.docs.map(doc => ({ id: doc.id, type: 'job', ...doc.data() }));








                // تطبيق الحذف التلقائي على إعلانات الوظائف
                const validJobs = [];
                for (const job of jobs) {
                    const isDeleted = await attemptAutoDelete(job.id, job, 'jobPostings');
                    if (!isDeleted) {
                        validJobs.push(job);
                    }
                }
                jobs = validJobs;








                // 3. دمج وترتيب الكل يدوياً في الكود (Client-Side Sorting)
                const allPostings = [...requests, ...jobs].sort((a, b) => {
                    const timeA = a.createdAt && a.createdAt.toMillis ? a.createdAt.toMillis() : 0;
                    const timeB = b.createdAt && b.createdAt.toMillis ? b.createdAt.toMillis() : 0;
                    return timeB - timeA; // فرز تنازلي (الأحدث أولاً)
                });








                hideLoading();








                if (allPostings.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">لم تقم بنشر أي إعلانات أو طلبات بعد.</p>';
                    return;
                }








                listEl.innerHTML = allPostings.map(post => {
                    const isRequest = post.type === 'request';
                    const title = isRequest ? post.title : post.title;
                    const category = post.category;
                    const description = isRequest ? post.description : post.details;
                    const typeLabel = isRequest ? 'طلب خدمة' : 'إعلان وظيفة';
                    const typeColor = isRequest ? 'bg-green-100 text-green-700' : 'bg-indigo-100 text-indigo-700';
                    const dateString = post.createdAt && post.createdAt.toDate ? new Date(post.createdAt.toDate()).toLocaleDateString('ar-EG') : 'تاريخ غير محدد';








                    return `
                        <div class="bg-white p-4 rounded-lg shadow-md border border-gray-200 job-listing-card">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-xs font-medium ${typeColor} py-1 px-2 rounded-full">${typeLabel}</span>
                                <span class="text-xs text-gray-400">${dateString}</span>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-1">${title}</h3>
                            <p class="text-sm text-gray-600 mb-3">${description.substring(0, 150)}...</p>
                            <p class="text-sm text-indigo-600 mb-3 font-medium">القسم: ${category}</p>
                            
                            <button data-action="deletePosting" data-type="${post.type}" data-id="${post.id}"
                                    class="mt-2 w-full flex items-center justify-center space-x-1 space-x-reverse bg-red-500 text-white py-2 px-4 rounded-md text-sm font-medium hover:bg-red-600">
                                ${ICONS.trash}
                                <span>حذف هذا ${isRequest ? 'الطلب' : 'الإعلان'}</span>
                            </button>
                        </div>
                    `;
                }).join('');








            } catch (error) {
                console.error("Error fetching my postings: ", error);
                hideLoading();
                listEl.innerHTML = '<p class="text-red-500 p-6 bg-white rounded-lg shadow-sm">حدث خطأ أثناء تحميل إعلاناتك وطلباتك.</p>';
            }
        }
















        function renderEditProfilePage() {
            if (!userProfile) {
                navigateTo('auth');
                return;
            }
















            const serviceOptions = SERVICES_LIST.map(service => 
                `<option value="${service.name}" ${userProfile.jobTitle === service.name ? 'selected' : ''}>${service.name}</option>`
            ).join('');
















            const cityOptions = SHARQIA_CITIES.map(city => 
                `<option value="${city}" ${userProfile.addressCity === city ? 'selected' : ''}>${city}</option>`
            ).join('');
















            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <h1 class="text-xl font-bold">تعديل الملف الشخصي</h1>
                        <button data-action="goBack" class="bg-white text-indigo-800 rounded-full p-1 w-7 h-7 flex items-center justify-center hover:bg-gray-100">
                            ${ICONS.back}
                        </button>
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <form id="edit-profile-form" class="space-y-4 bg-white p-6 rounded-lg shadow-md max-w-md mx-auto">
                            <div id="edit-error" class="text-red-500 text-sm text-center hidden"></div>
                            
                            <!-- التعديل 2: تطبيق تصميم الإدخال الموحد على الصورة -->
                            <div class="register-input-card">
                                <input type="file" id="photo-upload-input" accept="image/*" class="hidden">
                                <label for="photo-upload-input" class="block text-sm font-medium text-gray-900 text-center cursor-pointer">
                                    الصورة الشخصية
                                    <div class="mt-2 flex flex-col items-center justify-center">
                                        <img id="photo-preview" class="w-24 h-24 rounded-full object-cover register-photo-preview border-gray-300 p-0.5 hover:border-indigo-700" 
                                             src="${userProfile.photoURL || 'https://placehold.co/100x100/EBF8FF/3182CE?text=User'}" alt="الصورة الحالية">
                                        <span class="text-xs text-indigo-500 mt-2 hover:underline">اضغط لتغيير صورتك</span>
                                    </div>
                                </label>
                                <input type="hidden" id="photo-base64" value="${userProfile.photoURL || ''}">
                            </div>
















                            <hr class="my-3">
                            
                            <!-- التعديل 2: تطبيق تصميم الإدخال الموحد على باقي الحقول -->
                            <div class="register-input-card">
                                <label for="edit-name">الاسم الكامل</label>
                                <input type="text" id="edit-name" value="${userProfile.name}" required class="mt-1 block w-full text-gray-900 text-sm">
                            </div>
                            <div class="register-input-card">
                                <label for="edit-phone">رقم الهاتف (11 رقم)</label>
                                <input type="tel" id="edit-phone" value="${userProfile.phone}" required pattern="[0-9]{11}" maxlength="11" class="mt-1 block w-full text-gray-900 text-sm">
                            </div>
                            
                            <!-- اختيار الجنس -->
                            <div class="register-input-card">
                                <label class="block text-sm font-medium text-gray-900">الجنس</label>
                                <div class="mt-1 flex space-x-4 space-x-reverse">
                                    <label class="flex items-center">
                                        <input type="radio" name="edit-gender" value="ذكر" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" ${userProfile.gender === 'ذكر' ? 'checked' : ''} required>
                                        <span class="mr-2 text-gray-700 text-sm">ذكر</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="edit-gender" value="أنثى" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" ${userProfile.gender === 'أنثى' ? 'checked' : ''} required>
                                        <span class="mr-2 text-gray-700 text-sm">أنثى</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- تقسيم العنوان -->
                            <div class="register-input-card">
                                <label for="edit-city">المركز / المدينة</label>
                                <select id="edit-city" required class="mt-1 block w-full text-gray-900 text-sm bg-white">
                                    <option value="">اختر المركز/المدينة</option>
                                    ${cityOptions}
                                </select>
                            </div>
                            <div class="register-input-card">
                                <label for="edit-area">المنطقة / تفاصيل العنوان</label>
                                <input type="text" id="edit-area" value="${userProfile.addressArea}" required class="mt-1 block w-full text-gray-900 text-sm" placeholder="مثال: القومية، شارع 33">
                            </div>
                            
                            ${userProfile.role === 'provider' ? `
                                <div id="job-title-edit-field" class="space-y-4">
                                    <div class="register-input-card">
                                        <label for="edit-job-select">اختر وظيفتك / الخدمة:</label>
                                        <select id="edit-job-select" class="mt-1 block w-full text-gray-900 text-sm bg-white">
                                            <option value="" ${!userProfile.jobTitle ? 'selected' : ''}>اختر...</option>
                                            ${serviceOptions}
                                        </select>
                                    </div>
                                </div>
                            ` : ''}
















                            <button type="submit" data-action="editProfile" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                حفظ التعديلات
                            </button>
                        </form>
                    </main>
                </div>
            `;
















            // تهيئة مستمع حدث رفع الصورة
            document.getElementById('photo-upload-input').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
















                showLoading('جاري معالجة الصورة...');
                try {
                    const base64Image = await resizeAndConvertImage(file);
                    document.getElementById('photo-preview').src = base64Image;
                    document.getElementById('photo-base64').value = base64Image;
                } catch (error) {
                    console.error("Image processing error:", error);
                    showMessageModal('خطأ في الصورة', 'لم نتمكن من معالجة الصورة. يرجى المحاولة بصورة أخرى.', false);
                } finally {
                    hideLoading();
                }
            });
        }
















        async function renderChatPage(otherUserId) {
            let otherUserProfile = null;
            const chatRoomId = [userId, otherUserId].sort().join('_');
            
            try {
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, otherUserId);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    otherUserProfile = userDoc.data();
                } else {
                    throw new Error('User not found');
                }
            } catch (e) {
                console.error(e);
                appContainer.innerHTML = `<p class="p-4 text-red-500">خطأ: لا يمكن العثور على المستخدم.</p>`;
                return;
            }
            
            // === التعديل 3: التحقق من إذن بدء المحادثة ===
            const chatPermission = otherUserProfile.chatPermission || 'all';
            let canStartChat = true;
            if (chatPermission === 'none') {
                canStartChat = false;
            } else if (chatPermission === 'providers' && userProfile.role !== 'provider') {
                canStartChat = false;
            } else if (chatPermission === 'clients' && userProfile.role !== 'client') {
                canStartChat = false;
            }
            
            // إذا لم يكن مسموحاً ببدء المحادثة، لا تعرض الصفحة
            if (!canStartChat && userId !== otherUserId) {
                appContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center min-h-screen p-4">
                        <h1 class="text-xl font-bold text-red-600 mb-4">غير مصرح لك بالتواصل</h1>
                        <p class="text-center text-gray-700">قام هذا المستخدم بتقييد من يمكنه بدء محادثة معه.</p>
                        <button data-action="goBack" class="mt-6 bg-indigo-600 text-white py-2 px-6 rounded-lg font-semibold text-base hover:bg-indigo-700">
                            العودة للخلف
                        </button>
                    </div>
                `;
                return;
            }
            
            // === التعديل 1: تحديث حالة القراءة عند الدخول للصفحة ===
            // استخدام arrayRemove لإزالة المستخدم الحالي من قائمة unreadBy
            const chatRoomDocRef = doc(db, `artifacts/${appId}/public/data/chats`, chatRoomId);
            updateDoc(chatRoomDocRef, {
                unreadBy: arrayRemove(userId)
            }).catch(error => {
                console.error("Failed to clear unread flag:", error);
            });




            // تحديد ما إذا كان يمكن التقييم
            const isProviderRatingClient = userProfile.role === 'provider' && otherUserProfile.role === 'client';
            const isClientRatingProvider = userProfile.role === 'client' && otherUserProfile.role === 'provider';
            // === إضافة منطق تقييم مقدم خدمة لمقدم خدمة آخر ===
            const isProviderRatingProvider = userProfile.role === 'provider' && otherUserProfile.role === 'provider';








            // === التعديل 5: حالة الظهور باستخدام الدالة المحدثة ===
            const onlineStatusHtml = getOnlineStatusHtml(otherUserProfile);








            appContainer.innerHTML = `
                <div class="flex flex-col h-screen max-h-screen"> 
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between space-x-3 space-x-reverse">
                        <div class="flex items-center space-x-3 space-x-reverse">
                            <img data-action="navigateTo" data-page="profile" data-uid="${otherUserId}"
                                 src="${otherUserProfile.photoURL || 'https://placehold.co/100x100/EBF8FF/3182CE?text=User'}" 
                                 alt="${otherUserProfile.name}" class="w-9 h-9 rounded-full object-cover cursor-pointer">
                            <div>
                                <h1 class="text-base font-bold">${otherUserProfile.name}</h1>
                                ${onlineStatusHtml}
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-2 space-x-reverse">
                            ${isClientRatingProvider || isProviderRatingProvider ? `
                                <button data-action="openRatingModal" data-targetrole="provider" data-targetid="${otherUserId}" data-targetname="${otherUserProfile.name}"
                                        class="p-1 text-yellow-300 hover:text-yellow-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.31h5.513c.498 0 .704.656.34.985l-4.46 4.062a.562.562 0 0 0-.162.541l1.618 5.22c.19.613-.526 1.09-1.04.724l-4.59-3.44a.563.563 0 0 0-.642 0l-4.59 3.44c-.514.366-1.23-.111-1.04-.724l1.618-5.22a.562.562 0 0 0-.162-.541l-4.46-4.062a.563.563 0 0 1 .34-.985h5.513a.563.563 0 0 0 .475.31l2.125-5.112Z" /></svg>
                                </button>
                            ` : ''}
                            ${isProviderRatingClient ? `
                                <button data-action="openRatingClientModal" data-targetrole="client" data-targetid="${otherUserId}" data-targetname="${otherUserProfile.name}"
                                        class="p-1 text-yellow-300 hover:text-yellow-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.31h5.513c.498 0 .704.656.34.985l-4.46 4.062a.562.562 0 0 0-.162.541l1.618 5.22c.19.613-.526 1.09-1.04.724l-4.59-3.44a.563.563 0 0 0-.642 0l-4.59 3.44c-.514.366-1.23-.111-1.04-.724l1.618-5.22a.562.562 0 0 0-.162-.541l-4.46-4.062a.563.563 0 0 1 .34-.985h5.513a.563.563 0 0 0 .475.31l2.125-5.112Z" /></svg>
                                </button>
                            ` : ''}
                            <button data-action="goBack" class="bg-white text-indigo-800 rounded-full p-1 w-7 h-7 flex items-center justify-center hover:bg-gray-100">
                                ${ICONS.back}
                            </button>
                        </div>
                    </header>
                    
                    <main id="messages-container" class="flex-1 overflow-y-auto p-3 space-y-3 bg-gray-100 no-scrollbar">
                        <p class="text-center text-gray-500 text-sm">ابدأ المحادثة...</p>
                    </main>
                    
                    <footer class="bg-white p-3 shadow-inner sticky bottom-0 z-10 border-t border-gray-200">
                        <form id="chat-form" class="flex items-center space-x-2 space-x-reverse">
                            <!-- التعديل 2: تطبيق تصميم الإدخال الموحد على حقل الشات -->
                            <div class="register-input-card flex-1 p-2">
                                <input type="text" id="message-input" class="w-full text-gray-900 text-sm" placeholder="اكتب رسالتك..." required>
                            </div>
                            <button type="submit" data-action="sendMessage" data-otheruserid="${otherUserId}"
                                    class="p-2 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                ${ICONS.send}
                            </button>
                        </form>
                    </footer>
                </div>
            `;
















            const messagesColRef = collection(db, `artifacts/${appId}/public/data/chats/${chatRoomId}/messages`);
















            currentUnsubscribe = onSnapshot(messagesColRef, (snapshot) => {
                const messagesContainer = document.getElementById('messages-container');
                const isNearBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop - messagesContainer.clientHeight < 50; 
















                if (snapshot.empty) {
                    messagesContainer.innerHTML = '<p class="text-center text-gray-500 text-sm">ابدأ المحادثة...</p>';
                    return;
                }
















                const messages = snapshot.docs.map(doc => doc.data());
                messages.sort((a, b) => a.createdAt.toMillis() - b.createdAt.toMillis());
















                messagesContainer.innerHTML = messages.map(msg => {
                    const isSent = msg.senderId === userId;
                    const bubbleClass = isSent ? 'chat-bubble-sent' : 'chat-bubble-received';
                    const alignmentClass = isSent ? 'justify-end' : 'justify-start';
















                    return `
                        <div class="flex ${alignmentClass}">
                            <div class="${bubbleClass} max-w-[80%] text-sm">
                                <p>${msg.text}</p>
                                <span class="text-xs ${isSent ? 'text-indigo-100' : 'text-gray-500'} block text-left mt-1">
                                    ${new Date(msg.createdAt.toDate()).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' })}
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');
















                // التمرير التلقائي إلى الأسفل
                if (isNearBottom) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
















            }, (error) => {
                console.error("Error fetching messages: ", error);
                document.getElementById('messages-container').innerHTML = '<p class="text-red-500">حدث خطأ أثناء تحميل الرسائل.</p>';
            });
        }
















        function renderNewRequestPage() {
            const serviceOptions = SERVICES_LIST.map(service => 
                `<option value="${service.name}">${service.name}</option>`
            ).join('');
















            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <h1 class="text-xl font-bold">طلب خدمة جديد</h1>
                        <button data-action="goBack" class="bg-white text-indigo-800 rounded-full p-1 w-7 h-7 flex items-center justify-center hover:bg-gray-100">
                            ${ICONS.back}
                        </button>
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <form id="new-request-form" class="space-y-4 bg-white p-6 rounded-lg shadow-md max-w-md mx-auto">
                            <div id="request-error" class="text-red-500 text-sm text-center hidden"></div>
                            
                            <!-- التعديل 2: تطبيق تصميم الإدخال الموحد -->
                            <div class="register-input-card">
                                <label for="request-title">عنوان الطلب</label>
                                <input type="text" id="request-title" required class="mt-1 block w-full text-gray-900 text-sm" placeholder="مثال: أحتاج سباك لإصلاح صنبور">
                            </div>
                            
                            <div class="register-input-card">
                                <label for="request-category">القسم</label>
                                <select id="request-category" required class="mt-1 block w-full text-gray-900 text-sm bg-white">
                                    <option value="">اختر القسم</option>
                                    ${serviceOptions}
                                </select>
                            </div>
                            
                            <div class="register-input-card">
                                <label for="request-description">وصف الخدمة المطلوبة</label>
                                <textarea id="request-description" rows="4" required class="mt-1 block w-full text-gray-900 text-sm" placeholder="يرجى كتابة تفاصيل الخدمة المطلوبة..."></textarea>
                            </div>
                            
                            <button type="submit" data-action="submitRequest" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                نشر الطلب
                            </button>
                        </form>
                    </main>
                </div>
            `;
        }
















        // === صفحة نشر إعلان وظيفة ===
        function renderJobPostingPage() {
            const serviceOptions = SERVICES_LIST.map(service => 
                `<option value="${service.name}">${service.name}</option>`
            ).join('');
















            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <h1 class="text-xl font-bold">نشر إعلان وظيفة</h1>
                        <button data-action="goBack" class="bg-white text-indigo-800 rounded-full p-1 w-7 h-7 flex items-center justify-center hover:bg-gray-100">
                            ${ICONS.back}
                        </button>
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <form id="job-posting-form" class="space-y-4 bg-white p-6 rounded-lg shadow-md max-w-md mx-auto">
                            <div id="job-post-error" class="text-red-500 text-sm text-center hidden"></div>
                            
                            <!-- التعديل 2: تطبيق تصميم الإدخال الموحد -->
                            <div class="register-input-card">
                                <label for="job-title">عنوان الوظيفة</label>
                                <input type="text" id="job-title" required class="mt-1 block w-full text-gray-900 text-sm" placeholder="مثال: مطلوب سكرتيرة تنفيذية">
                            </div>
                            
                            <div class="register-input-card">
                                <label for="job-category">القسم</label>
                                <select id="job-category" required class="mt-1 block w-full text-gray-900 text-sm bg-white">
                                    <option value="">اختر القسم</option>
                                    ${serviceOptions}
                                </select>
                            </div>
                            
                            <div class="register-input-card">
                                <label for="job-details">تفاصيل ومتطلبات الوظيفة</label>
                                <textarea id="job-details" rows="4" required class="mt-1 block w-full text-gray-900 text-sm" placeholder="يرجى كتابة المهارات المطلوبة، والراتب المتوقع، والموقع..."></textarea>
                            </div>
                            
                            <button type="submit" data-action="submitJobPost" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                نشر إعلان الوظيفة
                            </button>
                        </form>
                    </main>
                    
                    ${renderBottomNav('jobListings')}
                </div>
            `;
        }
















        // === صفحة عرض إعلانات الوظائف (محدثة) ===
        async function renderJobListingsPage() {
            appContainer.innerHTML = `
                <div class="pb-24">
                    <header class="bg-indigo-800 text-white app-header shadow-md sticky top-0 z-10 flex items-center justify-between">
                        <h1 class="text-xl font-bold">الوظائف المتاحة</h1>
                         <div class="flex items-center space-x-2 space-x-reverse">
                            <!-- تم إزالة جرس الإشعارات من هنا -->
                            <button data-action="navigateTo" data-page="jobPosting" 
                                class="bg-indigo-600 text-white py-1 px-3 rounded-md text-xs font-medium hover:bg-indigo-700">
                                + إعلان جديد
                            </button>
                        </div>
                    </header>
                    
                    <main class="main-padding bg-gray-50">
                        <div id="job-listings-list" class="space-y-3">
                            <p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">جاري تحميل إعلانات الوظائف...</p>
                        </div>
                    </main>
                    
                    ${renderBottomNav('jobListings')}
                </div>
            `;
















            const jobPostingsColRef = collection(db, `artifacts/${appId}/public/data/jobPostings`);
            const q = query(jobPostingsColRef, orderBy('createdAt', 'desc'));
















            currentUnsubscribe = onSnapshot(q, async (snapshot) => {
                const listEl = document.getElementById('job-listings-list');








                let listings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));








                // === تطبيق الحذف التلقائي (الخاصية رقم 2) ===
                const validListings = [];
                for (const job of listings) {
                    const isDeleted = await attemptAutoDelete(job.id, job, 'jobPostings');
                    if (!isDeleted) {
                        validListings.push(job);
                    }
                }
                listings = validListings;
















                if (listings.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500 text-center p-6 bg-white rounded-lg shadow-sm">لا توجد إعلانات وظائف حالياً.</p>';
                    return;
                }
















                listEl.innerHTML = listings.map(job => {
                    const dateString = job.createdAt && job.createdAt.toDate ? new Date(job.createdAt.toDate()).toLocaleDateString('ar-EG') : 'تاريخ غير محدد';
                    return `
                    <div class="bg-indigo-50 p-4 rounded-lg shadow-md border border-indigo-200 job-listing-card">
                        <div class="flex items-center justify-between mb-1">
                            <h3 class="text-lg font-bold text-gray-900">${job.title}</h3>
                            <span class="text-xs text-gray-400">${dateString}</span>
                        </div>
                        <p class="text-sm text-indigo-600 mb-1 font-medium">${job.category}</p>
                        <p class="text-sm text-gray-700 mb-2">${job.details.substring(0, 150)}...</p>
                        
                        <div class="flex items-center space-x-3 space-x-reverse">
                            <img data-action="navigateTo" data-page="profile" data-uid="${job.posterId}"
                                 src="${job.posterPhoto || 'https://placehold.co/100x100/EBF8FF/3182CE?text=User'}" 
                                 alt="${job.posterName}" class="w-7 h-7 rounded-full object-cover cursor-pointer">
                            <p data-action="navigateTo" data-page="profile" data-uid="${job.posterId}" 
                               class="text-xs text-gray-600 cursor-pointer hover:text-indigo-600">الناشر: ${job.posterName}</p>
                        </div>
                        
                        <button data-action="navigateTo" data-page="chat" data-otheruserid="${job.posterId}"
                                class="mt-2 w-full bg-indigo-600 text-white py-2 px-4 rounded-md text-sm font-medium hover:bg-indigo-700">
                            تواصل للتقديم
                        </button>
                    </div>
                `}).join('');
            }, (error) => {
                console.error("Error fetching job listings: ", error);
                document.getElementById('job-listings-list').innerHTML = '<p class="text-red-500">حدث خطأ أثناء تحميل إعلانات الوظائف.</p>';
            });
        }
















        // === إصلاح 1 و 2: تصغير ارتفاع شريط التنقل السفلي وتغيير اللون ===
        function renderBottomNav(activeTab) {
            const activeClass = 'text-white bg-indigo-700';
            const inactiveClass = 'text-indigo-300 hover:text-white';
            
            // === التعديل 1: منطق النقطة الحمراء في شريط التنقل (إزالة من البروفايل) ===
            const unreadCount = userProfile?.unreadNotifications || 0;
            const showDot = unreadCount > 0;
            const dotHtml = `<span class="absolute top-0 right-0 block h-2 w-2 rounded-full bg-red-500 ring-2 ring-indigo-800 -mt-1 -mr-1"></span>`;
















            return `
                <nav class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto md:max-w-2xl lg:max-w-4xl bg-indigo-800 shadow-lg border-t border-indigo-700 z-20">
                    <div class="flex justify-around items-center h-12">
                        <button data-action="navigateTo" data-page="home" 
                                class="relative flex flex-col items-center justify-center p-1 rounded-md ${activeTab === 'home' ? activeClass : inactiveClass}">
                            ${showDot ? dotHtml : ''}
                            ${ICONS.home}
                            <span class="text-xs font-medium">الرئيسية</span>
                        </button>
                        
                        <button data-action="navigateTo" data-page="directory" 
                                class="flex flex-col items-center justify-center p-1 rounded-md ${activeTab === 'directory' ? activeClass : inactiveClass}">
                            ${ICONS.users}
                            <span class="text-xs font-medium">الدليل</span>
                        </button>
                        
                        <button data-action="navigateTo" data-page="chatList" 
                                class="relative flex flex-col items-center justify-center p-1 rounded-md ${activeTab === 'chatList' ? activeClass : inactiveClass}">
                            ${showDot ? dotHtml : ''}
                            ${ICONS.chat}
                            <span class="text-xs font-medium">المحادثات</span>
                        </button>
                        
                        <button data-action="navigateTo" data-page="jobListings" 
                                class="relative flex flex-col items-center justify-center p-1 rounded-md ${activeTab === 'jobListings' ? activeClass : inactiveClass}">
                            ${showDot ? dotHtml : ''}
                            ${ICONS.job}
                            <span class="text-xs font-medium">وظائف</span>
                        </button>
                        
                        <button data-action="navigateTo" data-page="profile" data-uid="${userId}"
                                class="flex flex-col items-center justify-center p-1 rounded-md ${activeTab === 'profile' ? activeClass : inactiveClass}">
                            ${ICONS.profile}
                            <span class="text-xs font-medium">ملفي</span>
                        </button>
                    </div>
                </nav>
            `;
        }
















        function renderStarRating(rating, maxStars = 5, cssClass = 'h-5 w-5') {
            let html = '';
            for (let i = 1; i <= maxStars; i++) {
                if (i <= rating) {
                    html += `<svg class="${cssClass}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/></svg>`;
                } else {
                    html += `<svg class="${cssClass}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.31h5.513c.498 0 .704.656.34.985l-4.46 4.062a.562.562 0 0 0-.162.541l1.618 5.22c.19.613-.526 1.09-1.04.724l-4.59-3.44a.563.563 0 0 0-.642 0l-4.59 3.44c-.514.366-1.23-.111-1.04-.724l1.618-5.22a.562.562 0 0 0-.162-.541l-4.46-4.062a.563.563 0 0 1 .34-.985h5.513a.563.563 0 0 0 .475.31l2.125-5.112Z" /></svg>`;
                }
            }
            return html;
        }
















        // 10. وظائف معالجة الأحداث (Event Handlers)
















        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('login-identifier').value.trim(); 
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
















            showLoading('جاري تسجيل الدخول...');
            errorEl.classList.add('hidden');
















            try {
                const usersColRef = collection(db, `artifacts/${appId}/public/data/users`);
                const q = query(usersColRef, where('username', '==', username));
                const snapshot = await getDocs(q); 
















                if (snapshot.empty) {
                    throw new Error('اسم المستخدم غير صحيح.');
                }
















                const userData = snapshot.docs[0].data();
                const authEmail = userData.email; 
















                await signInWithEmailAndPassword(auth, authEmail, password);








                // === تحديث حالة الظهور عند تسجيل الدخول ===
                await updateOnlineStatus(true);








                hideLoading();
            } catch (error) {
                console.error("Login Error: ", error);
                let errorMessage = 'اسم المستخدم أو كلمة المرور غير صحيحة.';
                if (error.message.includes('اسم المستخدم غير صحيح')) {
                     errorMessage = error.message;
                } else if (error.code === 'auth/invalid-credential') {
                     errorMessage = 'كلمة المرور غير صحيحة.';
                }
















                errorEl.textContent = errorMessage;
                errorEl.classList.remove('hidden');
                hideLoading();
            }
        }
















        async function handleRegister(e) {
            e.preventDefault();
            isRegistering = true; 
            showLoading('جاري إنشاء الحساب...');
            const errorEl = document.getElementById('register-error');
            errorEl.classList.add('hidden');
















            try {
                const username = document.getElementById('register-username').value.trim(); 
                const password = document.getElementById('register-password').value;
                const name = document.getElementById('register-name').value;
                const phone = document.getElementById('register-phone').value;
                const gender = document.querySelector('input[name="gender"]:checked').value; 
                const city = document.getElementById('register-city').value;
                const area = document.getElementById('register-area').value.trim();
                const role = document.querySelector('input[name="role"]:checked').value;
                const photoURL = document.getElementById('photo-base64').value || null; 
















                const jobSelect = document.getElementById('register-job-select')?.value;
                const jobTitle = jobSelect;
















                // التحقق من رقم الهاتف والعنوان
                if (phone.length !== 11 || !/^[0-9]{11}$/.test(phone)) {
                    throw new Error('يرجى إدخال رقم هاتف مصري صحيح مكون من 11 رقم.');
                }
                if (!city || !area) {
                    throw new Error('يرجى اختيار المدينة/المركز وإدخال تفاصيل المنطقة.');
                }
                if (role === 'provider' && (!jobTitle || jobTitle === '')) {
                    throw new Error('يرجى اختيار الوظيفة لمقدم الخدمة.');
                }
















                const usersColRef = collection(db, `artifacts/${appId}/public/data/users`);
                const q = query(usersColRef, where('username', '==', username));
                const snapshot = await getDocs(q);
                if (!snapshot.empty) {
                    throw new Error('اسم المستخدم هذا محجوز بالفعل. يرجى اختيار اسم آخر.');
                }
















                const dummyEmail = `${username}@sharqia.service`; // تم تحديث الدومين
                const userCredential = await createUserWithEmailAndPassword(auth, dummyEmail, password);
                const newUserId = userCredential.user.uid;
















                await updateProfile(userCredential.user, {
                    displayName: name,
                });
















                const jobTitleSearch = role === 'provider' ? jobTitle.toLowerCase() : null;
                
                // === التعديل 7: التحقق من إعدادات الوضع الداكن في المتصفح ===
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                
                // === التعديل 5: تعيين حالة الوضع الداكن الافتراضية على false ===
                const isDarkModeDefault = false; 
                
                // === التعديل 9: الإعدادات الافتراضية للإشعارات الخارجية (متعطلة) ===
                const isNotificationsDefault = false; 




                const newUserProfile = {
                    uid: newUserId,
                    username: username, 
                    email: dummyEmail, 
                    name: name,
                    phone: phone,
                    gender: gender, 
                    addressCity: city, 
                    addressArea: area, 
                    address: `${city}, ${area}`, 
                    photoURL: photoURL, 
                    role: role,
                    jobTitle: role === 'provider' ? jobTitle : null,
                    jobTitleSearch: jobTitleSearch, 
                    createdAt: Timestamp.now(),
                    ratings: [],
                    avgRating: 0,
                    clientRatings: [], 
                    clientAvgRating: 0, 
                    // === إعدادات الخصوصية والظهور الافتراضية (محدثة) ===
                    isPhoneHidden: false,
                    isAddressHidden: false,
                    isDirectoryHidden: false,
                    isNotificationsEnabled: isNotificationsDefault, // ✅ تم التعديل
                    isMessageNotificationsEnabled: isNotificationsDefault,
                    isJobNotificationsEnabled: isNotificationsDefault,
                    isRequestNotificationsEnabled: isNotificationsDefault,
                    isDarkModeEnabled: isDarkModeDefault, // ✅ تم التعديل
                    isLocationSharingEnabled: false,
                    isOnline: true, 
                    unreadNotifications: 0, 
                    // === التعديل 3: إعدادات التحكم الكامل في المنافع الافتراضية ===
                    chatPermission: 'all', 
                    ratingPermission: 'all', 
                };
















                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, newUserId);
                await setDoc(userDocRef, newUserProfile);
















                userProfile = newUserProfile;
                userId = newUserId;
                hideLoading();
                showMessageModal('تم التسجيل بنجاح', 'أهلاً بك في مستقبل الشرقية!', true);
















                setTimeout(() => {
                    navigateTo(userProfile.role === 'provider' ? 'providerHome' : 'clientHome');
                }, 1500);
















            } catch (error) {
                console.error("Register Error: ", error);
                let displayError = error.message || 'حدث خطأ. يرجى المحاولة مرة أخرى.';
                if (error.code === 'auth/email-already-in-use') {
                    displayError = 'هذا الإيميل/اسم المستخدم مسجل بالفعل.';
                } else if (error.code === 'auth/invalid-email') {
                    displayError = 'صيغة اسم المستخدم غير صحيحة، يرجى استخدام حروف وأرقام فقط.';
                } else if (error.code === 'auth/weak-password') {
                    displayError = 'كلمة المرور ضعيفة جداً، يرجى استخدام 6 أحرف أو أكثر.';
                }
















                errorEl.textContent = displayError;
                errorEl.classList.remove('hidden');
                hideLoading();
            } finally {
                isRegistering = false; 
            }
        }
















        async function handleEditProfile(e) {
            e.preventDefault();
            showLoading('جاري حفظ التعديلات...');
            const errorEl = document.getElementById('edit-error');
            errorEl.classList.add('hidden');
















            try {
                const name = document.getElementById('edit-name').value;
                const phone = document.getElementById('edit-phone').value;
                const gender = document.querySelector('input[name="edit-gender"]:checked').value; 
                const city = document.getElementById('edit-city').value;
                const area = document.getElementById('edit-area').value.trim();
                const photoURL = document.getElementById('photo-base64').value || null; 
















                if (phone.length !== 11 || !/^[0-9]{11}$/.test(phone)) {
                    throw new Error('يرجى إدخال رقم هاتف مصري صحيح مكون من 11 رقم.');
                }
                if (!city || !area) {
                    throw new Error('يرجى اختيار المدينة/المركز وإدخال تفاصيل المنطقة.');
                }
















                let jobTitle = userProfile.jobTitle;
                if (userProfile.role === 'provider') {
                    const jobSelect = document.getElementById('edit-job-select').value;
                    jobTitle = jobSelect;
                }
















                showLoading('جاري تحديث البيانات...');
                const jobTitleSearch = userProfile.role === 'provider' ? jobTitle.toLowerCase() : null;
















                const updates = {
                    name: name,
                    phone: phone,
                    gender: gender, 
                    addressCity: city, 
                    addressArea: area, 
                    address: `${city}, ${area}`,
                    photoURL: photoURL, 
                    jobTitle: userProfile.role === 'provider' ? jobTitle : null,
                    jobTitleSearch: jobTitleSearch,
                };
















                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                await updateDoc(userDocRef, updates);
















                await updateProfile(auth.currentUser, {
                    displayName: name,
                });
















                userProfile = { ...userProfile, ...updates };
















                hideLoading();
                showMessageModal('تم الحفظ بنجاح', 'تم تحديث ملفك الشخصي.', true);
















                setTimeout(() => {
                    navigateTo('profile', { uid: userId });
                }, 1500);
















            } catch (error) {
                console.error("Edit Profile Error: ", error);
                errorEl.textContent = error.message || 'حدث خطأ أثناء حفظ التعديلات.';
                errorEl.classList.remove('hidden');
                hideLoading();
            }
        }
















        async function handleLogout() {
            showLoading('جاري تسجيل الخروج...');
            await updateOnlineStatus(false); // تحديث حالة الظهور إلى غير متصل
            await signOut(auth);
            userId = null;
            userProfile = null;
            hideLoading();
            navigateTo('auth');
        }
















        async function handleSendMessage(otherUserId) {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (text === '') return;
















            input.value = '';
















            const chatRoomId = [userId, otherUserId].sort().join('_');
            const messagesColRef = collection(db, `artifacts/${appId}/public/data/chats/${chatRoomId}/messages`);
















            try {
                await addDoc(messagesColRef, {
                    text: text,
                    senderId: userId,
                    createdAt: Timestamp.now()
                });
















                const otherUserDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/users`, otherUserId));
                if (!otherUserDoc.exists()) { throw new Error("Other user not found"); }
                const otherUserData = otherUserDoc.data();
















                const chatRoomDocRef = doc(db, `artifacts/${appId}/public/data/chats`, chatRoomId);
                const chatRoomData = {
                    users: [userId, otherUserId],
                    userDetails: {
                        [userId]: { name: userProfile.name, photoURL: userProfile.photoURL },
                        [otherUserId]: { name: otherUserData.name, photoURL: otherUserData.photoURL }
                    },
                    lastMessage: text,
                    lastSenderId: userId,
                    lastUpdate: Timestamp.now(),
                    // === تحديث حقل unreadBy (إضافة المستلم) ===
                    unreadBy: arrayUnion(otherUserId)
                };
                
                // 2. تحديث وثيقة المحادثة (انتظار اكتمالها)
                await setDoc(chatRoomDocRef, chatRoomData, { merge: true });




                // 3. إنشاء إشعار للمستلم (محدث) - يتم استدعاؤه بعد تحديث المحادثة
                await createNotification(
                    otherUserId, 
                    'message', 
                    `رسالة جديدة من ${userProfile.name}`, 
                    'chat', 
                    { otherUserId: userId }
                );




            } catch (error) {
                console.error("Error sending message: ", error);
            }
        }
















        async function handleSubmitRequest(e) {
            e.preventDefault();
            showLoading('جاري نشر الطلب...');
            const errorEl = document.getElementById('request-error');
            errorEl.classList.add('hidden');
















            try {
                const title = document.getElementById('request-title').value;
                const category = document.getElementById('request-category').value;
                const description = document.getElementById('request-description').value;
















                if (!title || !category || !description) {
                    throw new Error('يرجى ملء جميع الحقول.');
                }
















                const requestsColRef = collection(db, `artifacts/${appId}/public/data/serviceRequests`);
                const newRequestRef = await addDoc(requestsColRef, {
                    title: title,
                    category: category,
                    description: description,
                    requesterId: userId,
                    requesterName: userProfile.name,
                    requesterPhoto: userProfile.photoURL,
                    status: 'open',
                    createdAt: Timestamp.now()
                });








                // === إرسال إشعار لمقدمي الخدمة في نفس المجال (جديد) ===
                const usersColRef = collection(db, `artifacts/${appId}/public/data/users`);
                const providersQuery = query(usersColRef, where('role', '==', 'provider'), where('jobTitle', '==', category));
                const providersSnapshot = await getDocs(providersQuery);








                providersSnapshot.docs.forEach(doc => {
                    createNotification(
                        doc.id, 
                        'request', 
                        `طلب خدمة جديد: ${category}`, 
                        'providerHome'
                    );
                });








                hideLoading();
                showMessageModal('تم نشر الطلب', 'يمكن لمقدمي الخدمات الآن رؤية طلبك والتواصل معك.', true);
















                setTimeout(() => {
                    navigateTo(userProfile.role === 'provider' ? 'providerHome' : 'clientHome');
                }, 1500);
















            } catch (error) {
                console.error("Error submitting request: ", error);
                errorEl.textContent = error.message || 'حدث خطأ أثناء نشر الطلب.';
                errorEl.classList.remove('hidden');
                hideLoading();
            }
        }
















        // === إرسال إعلان وظيفة ===
        async function handleSubmitJobPost(e) {
            e.preventDefault();
            showLoading('جاري نشر إعلان الوظيفة...');
            const errorEl = document.getElementById('job-post-error');
            errorEl.classList.add('hidden');
















            try {
                const title = document.getElementById('job-title').value;
                const category = document.getElementById('job-category').value;
                const details = document.getElementById('job-details').value;
















                if (!title || !category || !details) {
                    throw new Error('يرجى ملء جميع الحقول.');
                }
















                const jobPostingsColRef = collection(db, `artifacts/${appId}/public/data/jobPostings`);
                const newJobPostRef = await addDoc(jobPostingsColRef, {
                    title: title,
                    category: category,
                    details: details,
                    posterId: userId,
                    posterName: userProfile.name,
                    posterPhoto: userProfile.photoURL,
                    createdAt: Timestamp.now()
                });








                // === إرسال إشعار لمقدمي الخدمة في نفس المجال (جديد) ===
                const usersColRef = collection(db, `artifacts/${appId}/public/data/users`);
                const providersQuery = query(usersColRef, where('role', '==', 'provider'), where('jobTitle', '==', category));
                const providersSnapshot = await getDocs(providersQuery);








                providersSnapshot.docs.forEach(doc => {
                    createNotification(
                        doc.id, 
                        'job', 
                        `إعلان وظيفة جديد: ${category}`, 
                        'jobListings'
                    );
                });








                hideLoading();
                showMessageModal('تم نشر الإعلان', 'تم نشر إعلان الوظيفة بنجاح.', true);
















                setTimeout(() => {
                    navigateTo('jobListings');
                }, 1500);
















            } catch (error) {
                console.error("Error submitting job post: ", error);
                errorEl.textContent = error.message || 'حدث خطأ أثناء نشر الإعلان.';
                errorEl.classList.remove('hidden');
                hideLoading();
            }
        }








        // === دالة حذف إعلان/طلب ===
        async function handleDeletePosting(type, id) {
             const collectionName = type === 'request' ? 'serviceRequests' : 'jobPostings';
             const confirmDelete = await new Promise(resolve => {
                showModal(`
                    <h2 class="text-xl font-semibold text-center text-red-600 mb-4">تأكيد الحذف</h2>
                    <p class="text-center text-gray-700">هل أنت متأكد من أنك تريد حذف هذا ${type === 'request' ? 'الطلب' : 'الإعلان'}؟</p>
                    <div class="flex justify-between mt-6 space-x-4 space-x-reverse">
                        <button data-action="closeModal" class="flex-1 py-2 px-4 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 text-sm">
                            إلغاء
                        </button>
                        <button data-action="confirmDelete" class="flex-1 py-2 px-4 border border-transparent rounded-md text-white bg-red-600 hover:bg-red-700 text-sm">
                            تأكيد الحذف
                        </button>
                    </div>
                `);
                document.querySelector('[data-action="confirmDelete"]').addEventListener('click', () => {
                    hideModal();
                    resolve(true);
                });
                document.querySelector('[data-action="closeModal"]').addEventListener('click', () => {
                    hideModal();
                    resolve(false);
                });
            });








            if (!confirmDelete) return;








            showLoading('جاري الحذف...');
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/${collectionName}`, id);
                await deleteDoc(docRef);
                hideLoading();
                showMessageModal('نجاح', `تم حذف ${type === 'request' ? 'الطلب' : 'الإعلان'} بنجاح.`, true);
                // إعادة تحميل الصفحة لعرض التحديث
                setTimeout(() => {
                    navigateTo('myPostings');
                }, 1000); 
            } catch (error) {
                console.error("Error deleting posting: ", error);
                hideLoading();
                showMessageModal('خطأ', 'حدث خطأ أثناء الحذف. يرجى المحاولة مرة أخرى.', false);
            }
        }
















        function handleOpenRatingModal(targetRole, targetId, targetName) {
            // === التعديل 3: التحقق من إذن التقييم ===
            const ratingPermission = userProfile.ratingPermission || 'all';
            let canRate = true;
            if (ratingPermission === 'none') {
                canRate = false;
            } else if (ratingPermission === 'providers' && userProfile.role !== 'provider') {
                canRate = false;
            } else if (ratingPermission === 'clients' && userProfile.role !== 'client') {
                canRate = false;
            }
            
            if (!canRate) {
                showMessageModal('غير مصرح', 'ليس لديك الإذن لتقييم المستخدمين حالياً بناءً على إعداداتك.', false);
                return;
            }
            
            
            const modalHtml = `
                <h2 class="text-xl font-semibold text-center mb-4">تقييم ${targetName} (${targetRole === 'provider' ? 'مقدم خدمة' : 'عميل'})</h2>
                <div id="rating-stars" class="flex justify-center text-gray-300 space-x-2 space-x-reverse mb-4 cursor-pointer">
                    ${[1,2,3,4,5].map(i => `<span data-action="setRating" data-value="${i}" class="star-icon hover:text-yellow-400">${ICONS.starEmpty}</span>`).join('')}
                </div>
                <input type="hidden" id="rating-value" value="0">
                <textarea id="rating-comment" class="w-full p-2 border border-gray-300 rounded-md text-sm" rows="3" placeholder="اكتب تعليقك هنا..."></textarea>
                <div class="flex justify-between mt-6 space-x-4 space-x-reverse">
                    <button data-action="closeModal" class="flex-1 py-2 px-4 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 text-sm">
                        إلغاء
                    </button>
                    <button data-action="submitRating" data-targetrole="${targetRole}" data-targetid="${targetId}" class="flex-1 py-2 px-4 border border-transparent rounded-md text-white bg-indigo-600 hover:bg-indigo-700 text-sm">
                        إرسال التقييم
                    </button>
                </div>
            `;
            showModal(modalHtml);
        }
















        // === توحيد دالة إرسال التقييم للمقدم والعميل ===
        async function handleSubmitRating(targetId, targetRole) {
            const stars = parseInt(document.getElementById('rating-value').value);
            const comment = document.getElementById('rating-comment').value.trim();
















            if (stars === 0) {
                showMessageModal('خطأ', 'يرجى اختيار عدد النجوم لتقييم المستخدم.', false);
                return;
            }
















            showLoading('جاري إرسال التقييم...');
















            try {
                const targetDocRef = doc(db, `artifacts/${appId}/public/data/users`, targetId);
                const ratingFieldName = targetRole === 'provider' ? 'ratings' : 'clientRatings';
                const avgRatingFieldName = targetRole === 'provider' ? 'avgRating' : 'clientAvgRating';
















                await runTransaction(db, async (transaction) => {
                    const targetDoc = await transaction.get(targetDocRef);
                    if (!targetDoc.exists()) {
                        throw "Target user document does not exist!";
                    }
















                    const data = targetDoc.data();
                    const oldRatings = data[ratingFieldName] || [];
                    const filteredRatings = oldRatings.filter(r => r.by !== userId);
















                    const newRating = {
                        by: userId,
                        byName: userProfile.name,
                        stars: stars,
                        comment: comment,
                        createdAt: Timestamp.now()
                    };
                    const newRatings = [...filteredRatings, newRating];
















                    // ⚠️ تم تصحيح الخطأ هنا: إضافة القوس الناقص بعد r
                    const totalStars = newRatings.reduce((acc, r) => acc + r.stars, 0);
                    const newAvgRating = totalStars / newRatings.length;
















                    const updates = {};
                    updates[ratingFieldName] = newRatings;
                    updates[avgRatingFieldName] = newAvgRating;
















                    transaction.update(targetDocRef, updates);
                });
                
                // === التعديل 4: إنشاء إشعار بالتقييم ===
                await createNotification(
                    targetId, 
                    'rating', 
                    `قام ${userProfile.name} بتقييمك!`, 
                    'profile', 
                    { uid: targetId }
                );
















                hideLoading();
                hideModal();
                showMessageModal('نجاح', 'شكراً لتقييمك!', true);
















            } catch (error) {
                console.error("Error submitting rating: ", error);
                hideLoading();
                showMessageModal('خطأ', 'حدث خطأ أثناء إرسال التقييم. يرجى المحاولة مرة أخرى.', false);
            }
        }








        // === دالة قراءة الإشعار (جديد - إصلاح مشكلة عدم اختفاء الدائرة) ===
        async function handleReadNotification(notificationId, page, params) {
            try {
                const notificationDocRef = doc(db, `artifacts/${appId}/public/data/notifications`, notificationId);
                const notificationDoc = await getDoc(notificationDocRef);








                if (notificationDoc.exists() && !notificationDoc.data().isRead) {
                    await updateDoc(notificationDocRef, { isRead: true });
                    // تقليل عداد الإشعارات غير المقروءة
                    await updateNotificationCount(-1);
                }








                // الانتقال إلى الصفحة المرتبطة بالإشعار
                navigateTo(page, params);
            } catch (error) {
                console.error("Error reading notification:", error);
                showMessageModal('خطأ', 'حدث خطأ أثناء قراءة الإشعار.', false);
            }
        }








        // 11. Event Delegation (المستمع الرئيسي للأحداث)
        appContainer.addEventListener('click', async (e) => {
            const target = e.target.closest('[data-action]');
            if (!target) return;
















            const action = target.dataset.action;
            const page = target.dataset.page;
            const uid = target.dataset.uid;
            const category = target.dataset.category;
            const otherUserId = target.dataset.otheruserid;
            const targetId = target.dataset.targetid;
            const targetName = target.dataset.targetname;
            const targetRole = target.dataset.targetrole;
            const type = target.dataset.type;
            const id = target.dataset.id;
            const params = target.dataset.params ? JSON.parse(target.dataset.params) : {};








            switch (action) {
                case 'navigateTo':
                    if (page === 'profile') navigateTo(page, { uid });
                    else if (page === 'category') navigateTo(page, { category });
                    else if (page === 'chat') navigateTo(page, { otherUserId });
                    else if (page === 'home') navigateTo(userProfile.role === 'provider' ? 'providerHome' : 'clientHome');
                    else navigateTo(page);
                    break;
















                case 'goBack':
                    // === إصلاح منطق زر الرجوع ===
                    if (navigationHistory.length > 1) {
                        navigationHistory.pop(); // 1. إزالة الصفحة الحالية من السجل
                        const previousRoute = navigationHistory[navigationHistory.length - 1]; // 2. الحصول على الصفحة السابقة
                        navigateTo(previousRoute.page, previousRoute.params); // 3. الانتقال إليها (لن يتم إضافتها مرة أخرى بسبب منطق navigateTo)
                    } else if (userId) {
                         navigateTo(userProfile.role === 'provider' ? 'providerHome' : 'clientHome');
                    } else {
                         navigateTo('auth');
                    }
                    break;
















                case 'login':
                    e.preventDefault();
                    await handleLogin(e); 
                    break;
                case 'register':
                    e.preventDefault();
                    await handleRegister(e);
                    break;
                case 'logout':
                    await handleLogout();
                    break;
                case 'editProfile': 
                    e.preventDefault();
                    await handleEditProfile(e);
                    break;
                case 'saveSettings': // === حفظ الإعدادات ===
                    await handleSaveSettings();
                    break;
                case 'sendMessage':
                    e.preventDefault();
                    await handleSendMessage(otherUserId);
                    break;
                case 'submitRequest':
                    e.preventDefault();
                    await handleSubmitRequest(e);
                    break;
                case 'submitJobPost': 
                    e.preventDefault();
                    await handleSubmitJobPost(e);
                    break;
                case 'deletePosting': 
                    await handleDeletePosting(type, id);
                    break;
                case 'openRatingModal': // تقييم مقدم الخدمة
                    handleOpenRatingModal('provider', targetId, targetName);
                    break;
                case 'openRatingClientModal': // تقييم العميل 
                    handleOpenRatingModal('client', targetId, targetName);
                    break;
                case 'readNotification': // === قراءة الإشعار ===
                    await handleReadNotification(id, page, params);
                    break;
                case 'openChangePasswordModal': // === التعديل 3: فتح مودال تغيير كلمة المرور ===
                    handleChangePasswordModal();
                    break;
            }
        });
















        modalBackdrop.addEventListener('click', (e) => {
            const target = e.target.closest('[data-action]');
            if (!target && e.target === modalBackdrop) {
                return;
            }
            if(!target) return;
















            const action = target.dataset.action;
            switch(action) {
                case 'closeModal':
                    hideModal();
                    break;
                case 'setRating':
                    const value = parseInt(target.dataset.value);
                    document.getElementById('rating-value').value = value;
                    const stars = document.querySelectorAll('#rating-stars .star-icon');
                    stars.forEach((star, index) => {
                        if (index < value) {
                            star.innerHTML = ICONS.star;
                            star.classList.add('text-yellow-400');
                        } else {
                            star.innerHTML = ICONS.starEmpty;
                            star.classList.remove('text-yellow-400');
                        }
                    });
                    break;
                case 'submitRating':
                    const targetId = target.dataset.targetid;
                    const targetRole = target.dataset.targetrole;
                    handleSubmitRating(targetId, targetRole);
                    break;
                case 'changePassword': // === التعديل 3: معالجة تغيير كلمة المرور ===
                    handleChangePassword(e);
                    break;
            }
        });
















        appContainer.addEventListener('change', (e) => {
            if (e.target.name === 'role') {
                const jobField = document.getElementById('job-title-field');
                if (e.target.value === 'provider') {
                    jobField.classList.remove('hidden');
                } else {
                    jobField.classList.add('hidden');
                }
            }
        });
















        appContainer.addEventListener('submit', (e) => {
            e.preventDefault();
        });








        // === معالجة حالة الاتصال/الانفصال (محدث) ===
        window.addEventListener('beforeunload', () => {
             if (userId) {
                updateOnlineStatus(false);
            }
        });








        document.addEventListener('visibilitychange', () => {
            if (userId) {
                if (document.visibilityState === 'hidden') {
                    updateOnlineStatus(false);
                } else {
                    updateOnlineStatus(true);
                }
            }
        });








        // 13. نقطة البداية الرئيسية
        window.onload = () => {
            // === التعديل 3: إلغاء طلب الإذن الخارجي ===
            // requestNotificationPermission(); 


            // === التعديل 1: البدء بصفحة التحميل ثم المصادقة ===
            navigateTo('loading');
            
            // === التعديل 7: مراقبة تغيير إعدادات الوضع الداكن في النظام ===
            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                    if (userProfile && userProfile.isDarkModeEnabled) {
                        applyDarkMode(e.matches);
                    }
                });
            }
















            onAuthStateChanged(auth, async (user) => {
















                if (isRegistering) {
                    console.log('Registration in progress, onAuthStateChanged will wait.');
                    return; 
                }
















                if (user) {
                    console.log('User is signed in:', user.uid);
                    userId = user.uid;
















                    const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                    const userDoc = await getDoc(userDocRef);
















                    if (userDoc.exists()) {
                        userProfile = userDoc.data();
                        console.log('User profile found:', userProfile);


                        // === التعديل 7: تطبيق الوضع الداكن عند تسجيل الدخول ===
                        applyDarkMode(userProfile.isDarkModeEnabled);


                        // تحديث حالة الظهور إلى متصل عند التحميل
                        await updateOnlineStatus(true);








                        // إعادة التوجيه للصفحة المناسبة
                        if(navigationHistory.length <= 1 || navigationHistory[navigationHistory.length - 1].page === 'auth' || navigationHistory[navigationHistory.length - 1].page === 'register') {
                            navigateTo(userProfile.role === 'provider' ? 'providerHome' : 'clientHome');
                        } else {
                            // إذا كان في صفحة ما، اتركه هناك
                            navigateTo(navigationHistory[navigationHistory.length - 1].page, navigationHistory[navigationHistory.length - 1].params);
                        }
                    } else {
                        console.log('No profile found, redirecting to register.');
                        navigateTo('register');
                    }
                } else {
                    console.log('User is signed out.');
                    userId = null;
                    userProfile = null;
                    // === التعديل 1: ضمان عرض صفحة تسجيل الدخول كواجهة أولى ===
                    navigateTo('auth');
                }
            });
















            (async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        console.log("Signing in with custom token...");
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else if (!auth.currentUser) {
                         console.log("No token, onAuthStateChanged will handle.");
                    }
                } catch (error) {
                    console.error("Error during initial auth:", error);
                    navigateTo('auth');
                }
            })();
        };




        // 14. PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // يجب أن يكون ملف service-worker.js موجوداً في المجلد الرئيسي
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
















    </script>
    <!-- ============================================= -->
    <!-- ==== نهاية كود جافاسكريبت و Firebase ===== -->
    <!-- ============================================= -->








<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then(registration => {
        console.log('✅ Service Worker registered with scope:', registration.scope);
      })
      .catch(error => {
        console.error('❌ Service Worker registration failed:', error);
      });
  });
}
</script>
    <script src="install-prompt.js" defer></script>
</body>
</html>