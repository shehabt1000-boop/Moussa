<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª PWA -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#111827">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">

    <title>Smart Center | Pro v6.8</title>

    <!-- Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* --- ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¹Ø§Ù…Ø© --- */
        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: #f3f4f6; 
            padding-bottom: 80px; 
            font-size: 10px; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none; 
        }

        /* Ù…Ù†Ø¹ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ØµÙˆØµ ÙˆØ³Ø±Ù‚Ø© Ø§Ù„ÙƒÙˆØ¯ */
        body { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }

        /* Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ø­Ù‚ÙˆÙ„ */
        input, select, textarea {
            border: 1px solid #9ca3af;
            border-radius: 0.25rem;
            background-color: #ffffff;
            color: #111827;
            font-weight: 700;
            transition: all 0.2s ease-in-out;
            padding-right: 0.5rem !important; 
            padding-left: 1.5rem !important; 
            height: 30px;
            font-size: 11px !important;
            width: 100%;
        }

        input:focus, select:focus {
            border-color: #1f2937;
            box-shadow: 0 0 0 1px rgba(31, 41, 55, 0.2);
            outline: none;
        }

        select, input[type="date"], input[type="month"] { 
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23374151' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); 
            background-position: left 0.2rem center; 
            background-repeat: no-repeat; 
            background-size: 0.8em 0.8em; 
            appearance: none; 
        }

        .input-wrapper { position: relative; width: 100%; }
        .input-icon {
            position: absolute;
            top: 50%;
            left: 4px;
            transform: translateY(-50%);
            color: #6b7280;
            pointer-events: none;
            width: 12px;
            height: 12px;
            z-index: 10;
        }

        .sub-nav-item {
            border: 1px solid #374151 !important;
            color: #374151;
            background: transparent;
            font-weight: bold;
            transition: all 0.2s;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        .sub-nav-item.active {
            background: #1f2937 !important;
            color: white !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        @media (min-width: 768px) {
            body { font-size: 12px; padding-bottom: 20px; }
            .container { max-width: 95% !important; }
            .glass-card { padding: 1.25rem !important; }
            .login-card { max-width: 450px !important; padding: 40px !important; }
            .nav-item { font-size: 13px !important; padding: 10px !important; }
            input, select, button { font-size: 12px !important; padding: 8px !important; height: 36px; }
        }

        .nav-item { transition: all 0.2s; opacity: 0.7; border-bottom: 3px solid transparent; }
        .nav-item.active { opacity: 1; background: white; color: #000; font-weight: 800; border-bottom-color: #000; transform: translateY(-2px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tab-content { display: none; animation: fadeIn 0.2s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .scanner-wrapper { border-radius: 0.5rem; overflow: hidden; background: #000000; position: relative; width: 100%; min-height: 250px; border: 2px solid #374151; }
        @media (min-width: 768px) { .scanner-wrapper { height: 400px; } }
        #html5-qrcode-button-camera-stop, #html5-qrcode-anchor-scan-type-change { display: none !important; }

        .glass-card { background: white; border-radius: 0.5rem; padding: 0.5rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #d1d5db; margin-bottom: 0.5rem; }

        .custom-table { width: 100%; border-collapse: collapse; font-size: 10px; table-layout: fixed; border: 1px solid #374151; }
        @media (min-width: 768px) { .custom-table { font-size: 12px; } }

        .custom-table thead { background-color: #1f2937; color: white; font-weight: 800; border-bottom: 2px solid #000; }
        .custom-table th, .custom-table td { padding: 4px; border: 1px solid #e5e7eb; text-align: center; vertical-align: middle; line-height: 1.3; }
        .custom-table thead th { color: white !important; }
        .col-code { width: 45px; font-family: monospace; font-weight: bold; }
        .custom-table tbody td.col-code { color: #000; }
        .col-date { width: 55px; font-size: 9px; }
        .custom-table tbody td.col-date { color: #4b5563; }
        .col-index { width: 25px; color: #6b7280; }
        .col-action { width: 45px; min-width: 45px; } 
        .custom-table tbody tr:hover { background-color: #f3f4f6; }

        #loadingOverlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; font-weight: bold; color: #1f2937; }
        #loginOverlay { position: fixed; inset: 0; background: linear-gradient(135deg, #111827 0%, #374151 100%); z-index: 100000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-card { background: rgba(255, 255, 255, 0.95); width: 100%; max-width: 380px; border-radius: 15px; padding: 25px; box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.3); text-align: center; border: 1px solid #4b5563; }
        .login-input { width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid #4b5563; border-radius: 8px; font-size: 13px; outline: none; transition: all 0.3s; padding-left: 2.5rem; }
        .login-btn { width: 100%; padding: 10px; background: #1f2937; color: white; border-radius: 8px; font-weight: bold; font-size: 13px; transition: transform 0.1s; border: 1px solid #000; }
        .login-tab { flex: 1; padding: 8px; cursor: pointer; font-weight: bold; border-bottom: 3px solid transparent; color: #6b7280; transition: all 0.3s; }
        .login-tab.active { color: #111827; border-bottom-color: #111827; background: #f3f4f6; border-radius: 5px 5px 0 0; }

        .schedule-table { width: 100%; border-collapse: collapse; font-size: 10px; margin-top: 10px; border: 1px solid #374151; }
        .schedule-table thead { background-color: #1f2937; color: white; }
        .schedule-table th, .schedule-table td { padding: 6px; border: 1px solid #9ca3af; text-align: center; }

        .std-dash-card { background: white; border-radius: 10px; padding: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #d1d5db; }
        .std-info-row { display: flex; justify-content: space-between; border-bottom: 1px solid #f3f4f6; padding: 6px 0; font-size: 11px; }
        .std-info-label { color: #4b5563; font-weight: 600; }
        .std-info-val { color: #111827; font-weight: 700; }

        #customAlertModal, #paymentConfirmModal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200000; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(2px); }
        .alert-card { background: white; border-radius: 12px; padding: 20px; width: 100%; max-width: 300px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); border-top: 5px solid #1f2937; }
        .alert-icon { font-size: 35px; margin-bottom: 8px; display: block; }
        .alert-btn { background: #1f2937; color: white; padding: 8px 20px; border-radius: 6px; font-weight: bold; margin-top: 15px; width: 100%; border: 1px solid #000; }

        /* --- ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…ÙˆØ­Ø¯ (Ù„Ù„Ø´Ø§Ø´Ø© ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø©) --- */
        .unified-card {
            border: 4px double #1f2937;
            border-radius: 15px;
            padding: 20px;
            width: 100%;
            max-width: 350px;
            margin: 0 auto 15px auto;
            text-align: center;
            background: #fff;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .unified-card-title { font-size: 14pt; font-weight: bold; margin-bottom: 10px; color: #374151; }
        .unified-card-name { font-size: 18pt; font-weight: 900; margin: 10px 0; border-bottom: 2px solid #1f2937; padding-bottom: 10px; color: #111827; }
        .unified-card-row { font-size: 11pt; font-weight: bold; margin: 5px 0; display: flex; justify-content: space-between; border-bottom: 1px dashed #d1d5db; padding: 4px 0; color: #1f2937; }
        .unified-card-footer { margin-top: 15px; font-size: 9pt; color: #6b7280; font-weight: bold; border-top: 1px solid #1f2937; padding-top: 5px; }

        /* --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…ÙˆØ­Ø¯ (Clean Print System) --- */
        #print-container { display: none; }

        @media print {
            body * { visibility: hidden; height: 0; overflow: hidden; }
            #print-container, #print-container * { visibility: visible; height: auto; overflow: visible; }
            #print-container { 
                display: block; 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                background: white; 
                z-index: 999999; 
                padding: 0;
                margin: 0;
            }

            @page { size: A4; margin: 1cm; }

            .print-page { width: 100%; max-width: 210mm; margin: 0 auto; font-family: 'Cairo', sans-serif; color: #000; }

            .print-header { 
                text-align: center; 
                border-bottom: 3px solid #000; 
                padding-bottom: 15px; 
                margin-bottom: 20px; 
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .print-logo-area { text-align: right; }
            .print-title-area { text-align: center; flex: 1; }
            .print-meta-area { text-align: left; font-size: 10pt; }

            .print-main-title { font-size: 24pt; font-weight: 900; margin: 0; line-height: 1.2; }
            .print-sub-title { font-size: 16pt; font-weight: bold; margin: 5px 0 0 0; color: #333; }

            /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù†Ø¸ÙŠÙØ© */
            .print-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 11pt; table-layout: fixed; }
            .print-table th { background-color: #eee !important; color: #000 !important; font-weight: 900; border: 1px solid #000; padding: 8px; text-align: center; }
            .print-table td { border: 1px solid #000; padding: 8px; text-align: center; vertical-align: middle; word-wrap: break-word; }
            .print-table tr:nth-child(even) { background-color: #f9f9f9 !important; }

            /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Table Layout) */
            .print-stats-table { width: 100%; margin-bottom: 20px; border-collapse: separate; border-spacing: 10px 0; }
            .print-stats-cell { border: 1px solid #000; padding: 10px; text-align: center; border-radius: 8px; width: 33%; vertical-align: middle; }
            .print-box-title { font-size: 12pt; font-weight: bold; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 5px; }
            .print-box-val { font-size: 16pt; font-weight: 900; }

            /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
            .print-student-card { 
                border: 4px double #000; 
                border-radius: 15px; 
                padding: 20px; 
                width: 350px; 
                margin: 20px auto; 
                text-align: center; 
                page-break-inside: avoid;
                background: #fff;
            }
            .print-card-title { font-size: 16pt; font-weight: bold; margin-bottom: 10px; color: #000; text-align: center; }
            .print-card-name { font-size: 20pt; font-weight: 900; margin: 10px 0; border-bottom: 2px solid #000; padding-bottom: 10px; color: #000; text-align: center; }
            .print-card-row { font-size: 12pt; font-weight: bold; margin: 5px 0; display: flex; justify-content: space-between; border-bottom: 1px dashed #ccc; padding: 2px 0; color: #000; }
            .print-card-footer { margin-top: 15px; font-size: 10pt; color: #555; font-weight: bold; border-top: 1px solid #000; padding-top: 5px; text-align: center; }

            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="text-gray-800">

<div id="loginOverlay" style="display: flex; align-items: center; justify-content: center;">
    <div class="login-card">
        <div class="mb-4">
            <h1 class="text-2xl font-black text-gray-900 mb-1 md:text-3xl">ğŸ“ Smart Center</h1>
            <p class="text-gray-500 text-[10px] font-bold md:text-sm">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ (Ø«Ø§Ù†ÙˆÙŠ)</p>
        </div>
        <div class="flex border-b mb-4">
            <div onclick="setLoginMode('admin')" id="tabAdmin" class="login-tab active">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
            <div onclick="setLoginMode('student')" id="tabStudent" class="login-tab">Ø§Ù„Ø·Ø§Ù„Ø¨</div>
        </div>
        <div id="loginForm">
            <div class="input-wrapper mb-2">
                <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                <input type="text" id="loginCode" class="login-input" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„">
            </div>
            <div class="input-wrapper mb-2">
                <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                <input type="password" id="loginPass" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            </div>
            <button onclick="handleLogin()" class="login-btn shadow-lg">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        </div>
        <p id="loginError" class="text-red-500 text-[10px] mt-2 hidden font-bold bg-red-50 p-2 rounded">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©</p>
    </div>
</div>

<div id="customAlertModal">
    <div class="alert-card">
        <div id="alertIcon" class="alert-icon">âš ï¸</div>
        <h3 id="alertTitle" class="text-base font-bold text-gray-800 mb-1">ØªÙ†Ø¨ÙŠÙ‡</h3>
        <p id="alertMessage" class="text-[11px] text-gray-600 font-bold mb-4"></p>
        <button onclick="closeCustomAlert()" class="alert-btn shadow-lg">Ø­Ø³Ù†Ø§Ù‹</button>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø®ØµØµØ© -->
<div id="paymentConfirmModal">
    <div class="alert-card border-t-4 border-green-600">
        <div class="text-4xl mb-2">ğŸ’°</div>
        <h3 class="text-base font-bold text-gray-800 mb-1">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹</h3>
        <p id="payConfirmMsg" class="text-[11px] text-gray-600 font-bold mb-4"></p>
        <div class="flex gap-2">
            <button onclick="proceedWithPayment()" class="flex-1 bg-green-600 text-white py-2 rounded font-bold text-xs shadow">Ù†Ø¹Ù…</button>
            <button onclick="closePaymentConfirm()" class="flex-1 bg-gray-500 text-white py-2 rounded font-bold text-xs">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© ÙØ­Øµ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Ø§Ù„Ù†ØªÙŠØ¬Ø©) -->
<div id="checkResultModal" class="fixed inset-0 bg-black/80 hidden z-[250] flex items-center justify-center p-4 no-print">
    <div class="bg-white rounded-xl w-full max-w-sm p-4 shadow-2xl relative">
        <button onclick="closeModal('checkResultModal')" class="absolute top-2 right-3 text-gray-500 text-xl font-bold">&times;</button>
        <div class="text-center border-b pb-2 mb-2">
            <h3 class="font-bold text-lg text-gray-900">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
        </div>
        <div class="flex justify-center mb-3" id="checkResultQr"></div>
        <div class="space-y-2 text-sm">
            <div class="flex justify-between border-b pb-1">
                <span class="text-gray-500">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</span>
                <span class="font-bold" id="checkResName"></span>
            </div>
            <div class="flex justify-between border-b pb-1">
                <span class="text-gray-500">ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨:</span>
                <span class="font-bold font-mono" id="checkResCode"></span>
            </div>
            <div class="flex justify-between border-b pb-1">
                <span class="text-gray-500">Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±:</span>
                <span class="font-bold" id="checkResPhone"></span>
            </div>
            <div class="flex justify-between border-b pb-1">
                <span class="text-gray-500">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:</span>
                <span class="font-bold" id="checkResDate"></span>
            </div>
            <div class="bg-yellow-50 p-2 rounded border border-yellow-200 mt-2">
                <div class="text-xs text-gray-500 mb-1">Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨ (Ù„Ù„Ø¯Ø®ÙˆÙ„):</div>
                <div class="flex justify-between font-bold">
                    <span>Ø§Ù„ÙƒÙˆØ¯: <span id="checkResLoginCode"></span></span>
                    <span>Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯: <span id="checkResPass" class="text-red-600"></span></span>
                </div>
            </div>
        </div>
        <button onclick="closeModal('checkResultModal')" class="w-full bg-gray-800 text-white py-2 rounded font-bold mt-4 text-xs">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<div id="loadingOverlay" class="hidden">
    <div class="animate-spin rounded-full h-10 w-10 border-b-4 border-gray-900 mb-4"></div>
    <div class="text-base">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...</div>
</div>

<!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
<div id="print-container"></div>

<div id="appContent" class="hidden">
    <style>
        #navBar .nav-item.active { background-color: white !important; color: #000 !important; font-weight: 800 !important; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>

    <header class="bg-gray-900 text-white shadow-md sticky top-0 z-50 no-print">
        <div class="container mx-auto px-4 py-2 flex justify-between items-center">
            <h1 class="text-sm font-bold flex items-center gap-2 md:text-xl">ğŸ“ Smart Center <span class="text-[8px] bg-yellow-500 px-1 py-0.5 rounded text-white md:text-xs border border-yellow-600">pro</span></h1>
            <div class="flex items-center gap-2">
                <div class="text-[9px] bg-gray-800 px-2 py-1 rounded-full font-mono border border-gray-700 md:text-xs" id="headerDate">--/--/----</div>
                <button onclick="logout()" class="text-[9px] bg-red-700 px-2 py-1 rounded font-bold hover:bg-red-800 transition md:text-xs md:px-3 border border-red-900">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
        <div class="bg-gray-800 border-t border-gray-700" id="navBar">
            <div class="container mx-auto px-2">
                <div class="flex w-full gap-1.5 py-1.5 md:gap-4 md:py-2"> 
                    <button id="nav-students" onclick="showTab('students', this)" class="nav-item flex-1 py-1.5 rounded text-[11px] text-gray-300 flex-shrink-0 text-center transition-all md:text-sm">Ø§Ù„Ø·Ù„Ø§Ø¨</button>
                    <button id="nav-attendance" onclick="showTab('attendance', this)" class="nav-item flex-1 py-1.5 rounded text-[11px] text-gray-300 flex-shrink-0 text-center transition-all md:text-sm">Ø§Ù„Ø­Ø¶ÙˆØ±</button>
                    <button id="nav-accounting" onclick="showTab('accounting', this)" class="nav-item flex-1 py-1.5 rounded text-[11px] text-gray-300 flex-shrink-0 text-center transition-all md:text-sm">Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©</button>
                    <button id="nav-reports" onclick="showTab('reports', this)" class="nav-item flex-1 py-1.5 rounded text-[11px] text-gray-300 flex-shrink-0 text-center transition-all md:text-sm">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
                </div>
            </div>
        </div>
    </header>

    <main id="mainContent" class="container mx-auto p-3 max-w-4xl md:max-w-6xl">

        <!-- STUDENT DASHBOARD -->
        <section id="studentDashboard" class="tab-content">
            <div class="flex justify-end mb-2 no-print gap-2">
                <button onclick="printStudentDashboard()" class="bg-gray-800 text-white px-3 py-1 rounded text-xs font-bold md:text-sm md:px-4 md:py-2 border border-gray-900">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ±</button>
                <button onclick="pdfStudentDashboard()" class="bg-red-700 text-white px-3 py-1 rounded text-xs font-bold md:text-sm md:px-4 md:py-2 border border-red-900">ğŸ“„ Ø­ÙØ¸ PDF</button>
            </div>
            <div class="grid md:grid-cols-3 gap-4" id="stdDashContainer">
                <div class="std-dash-card text-center md:col-span-1 border-t-4 border-gray-600">
                    <div class="mb-3 relative inline-block"><div id="dashQr" class="p-2 bg-white border rounded-lg"></div></div>
                    <h2 class="text-xl font-bold text-gray-900 md:text-2xl" id="dashName"></h2>
                    <p class="text-gray-500 font-mono text-lg font-bold mb-2 md:text-xl" id="dashCode"></p>
                    <div class="bg-gray-100 rounded-lg p-2 text-xs text-gray-800 font-bold mb-2 md:text-sm" id="dashLevel"></div>
                    <div class="grid grid-cols-2 gap-2 mt-4">
                        <div class="bg-green-50 p-2 rounded border border-green-100"><div class="text-2xl font-bold text-green-600 md:text-3xl" id="dashPresent">0</div><div class="text-[10px] text-green-800 md:text-xs">Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</div></div>
                        <div class="bg-red-50 p-2 rounded border border-red-100"><div class="text-2xl font-bold text-red-600 md:text-3xl" id="dashAbsent">0</div><div class="text-[10px] text-red-800 md:text-xs">Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨</div></div>
                    </div>
                </div>
                <div class="md:col-span-2 space-y-4">
                    <div class="std-dash-card">
                        <h3 class="font-bold text-sm text-gray-800 border-b pb-2 mb-2 flex items-center gap-2 md:text-base">ğŸ“„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</h3>
                        <div class="std-info-row"><span class="std-info-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</span><span class="std-info-val" id="dashJoinDate"></span></div>
                        <div class="std-info-row"><span class="std-info-label">Ù…Ø¯Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</span><span class="std-info-val" id="dashDuration"></span></div>
                        <div class="std-info-row"><span class="std-info-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</span><span class="std-info-val text-green-600" id="dashPaymentsTotal"></span></div>
                    </div>
                    <div class="std-dash-card">
                        <h3 class="font-bold text-sm text-gray-800 border-b pb-2 mb-2 md:text-base">ğŸ’° Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</h3>
                        <div class="overflow-x-auto"><table class="custom-table"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead><tbody id="dashPaymentsTable"></tbody></table></div>
                    </div>
                    <div class="std-dash-card">
                        <h3 class="font-bold text-sm text-gray-800 border-b pb-2 mb-2 md:text-base">ğŸŒŸ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠ</h3>
                        <div class="overflow-x-auto"><table class="custom-table"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙŠÙˆÙ…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody id="dashExceptionalTable"></tbody></table></div>
                    </div>
                    <div class="std-dash-card">
                        <h3 class="font-bold text-sm text-gray-800 border-b pb-2 mb-2 md:text-base">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</h3>
                        <div id="dashHistory" class="max-h-48 overflow-y-auto pr-1 space-y-1"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- STUDENTS TAB -->
        <section id="students" class="tab-content">
            <div class="glass-card border-r-4 border-gray-500 no-print mb-4">
                <h2 class="font-bold text-gray-900 mb-2 text-xs md:text-base">ØªØ³Ø¬ÙŠÙ„ Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
                <div class="space-y-2 md:grid md:grid-cols-2 md:gap-4 md:space-y-0">
                    <div class="input-wrapper">
                        <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        <input type="text" id="stdName" class="w-full p-2 text-xs md:text-sm" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø±Ø¨Ø§Ø¹ÙŠ">
                    </div>
                    <div class="flex items-center border border-gray-400 rounded bg-white overflow-hidden h-[30px] md:h-[36px]">
                        <span class="bg-gray-100 px-2 py-1 text-gray-600 text-[10px] font-bold border-l border-gray-400 md:text-sm h-full flex items-center">+20</span>
                        <div class="input-wrapper flex-1 h-full">
                            <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                            <input type="tel" id="stdPhone" oninput="validatePhone(this)" class="w-full p-2 text-xs outline-none md:text-sm !border-0 h-full" placeholder="Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±">
                        </div>
                    </div>
                    <div class="input-wrapper">
                        <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                        <select id="stdLevel" class="w-full p-2 text-xs md:text-sm">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø©...</option>
                            <option value="1Ø«">Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                            <option value="2Ø«">Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                            <option value="3Ø«">Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                        </select>
                    </div>
                    <button onclick="registerStudent()" class="w-full bg-gray-800 text-white py-2 rounded font-bold shadow hover:bg-black text-xs transition md:text-sm md:col-span-2 md:py-3 border border-gray-900">Ø­ÙØ¸ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
                </div>
            </div>

            <!-- Ø¨Ø·Ø§Ù‚Ø© ÙØ­Øµ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ù„Ù„Ø£Ø³ÙˆØ¯) -->
            <div class="glass-card border-r-4 border-gray-600 no-print mb-4">
                <h2 class="font-bold text-gray-900 mb-2 text-xs md:text-base">ğŸ” ÙØ­Øµ Ø¨Ø§Ø±ÙƒÙˆØ¯</h2>
                <div id="checkReader" class="scanner-wrapper h-32 mb-2 hidden border-2 border-gray-800"></div>
                <div class="flex gap-2">
                    <button onclick="startCheckScanner()" id="btnStartCheck" class="flex-1 bg-gray-800 text-white py-1.5 rounded font-bold text-xs shadow border border-gray-900">ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
                    <button onclick="stopCheckScanner()" id="btnStopCheck" class="flex-1 bg-red-100 text-red-600 py-1.5 rounded font-bold text-xs hidden">Ø¥ÙŠÙ‚Ø§Ù</button>
                </div>
            </div>

            <div class="glass-card">
                <div class="flex justify-between items-center mb-2 no-print flex-wrap gap-2">
                    <h2 class="font-bold text-[10px] md:text-sm text-gray-800">Ø§Ù„Ø·Ù„Ø§Ø¨ (<span id="stdCount">0</span>)</h2>
                    <div class="flex gap-1.5 items-center flex-1 justify-end max-w-full">
                        <select id="studentListFilter" onchange="renderStudents()" class="text-[10px] px-1 h-8 w-16 text-center md:text-sm md:w-24 shrink-0">
                            <option value="all">Ø§Ù„ÙƒÙ„</option>
                            <option value="1Ø«">1Ø«</option>
                            <option value="2Ø«">2Ø«</option>
                            <option value="3Ø«">3Ø«</option>
                        </select>
                        <div class="input-wrapper flex-1 min-w-0 max-w-[150px] md:max-w-[200px]">
                            <svg class="input-icon" style="width:14px; height:14px; left:6px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            <input type="text" id="searchStd" onkeyup="renderStudents()" placeholder="Ø¨Ø­Ø«..." class="text-[10px] px-2 w-full h-8 transition-all md:text-sm">
                        </div>
                        <button onclick="printStudentsList()" class="bg-gray-800 text-white px-2 h-8 rounded text-[10px] flex items-center justify-center gap-1 hover:bg-black transition md:text-sm md:px-3 border border-gray-900 shrink-0">
                            <span>ğŸ–¨ï¸</span>
                        </button>
                        <button onclick="pdfStudentsList()" class="bg-red-700 text-white px-2 h-8 rounded text-[10px] flex items-center justify-center gap-1 hover:bg-red-800 transition md:text-sm md:px-3 border border-red-900 shrink-0">
                            <span>PDF</span>
                        </button>
                    </div>
                </div>
                <div id="studentsListArea" class="overflow-x-auto"><table class="custom-table"><thead><tr><th class="col-index">Ù…</th><th class="col-code">Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th class="col-date">ØªØ§Ø±ÙŠØ®</th><th class="no-print col-action">Ø­Ø°Ù</th></tr></thead><tbody id="studentsTable"></tbody></table></div>
            </div>
        </section>

        <!-- ATTENDANCE TAB -->
        <section id="attendance" class="tab-content">
            <div class="glass-card text-center">
                <h2 class="text-sm font-bold text-gray-900 mb-2 md:text-lg">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±</h2>
                <div id="exceptionalStatusIndicator" class="hidden bg-indigo-100 border border-indigo-300 text-indigo-800 p-2 rounded mb-2 text-xs font-bold animate-pulse md:text-sm">
                    ğŸŒŸ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠ Ù„Ù€: <span id="exceptionalLevelName"></span>
                </div>

                <div class="grid grid-cols-3 gap-1 mb-2 no-print">
                    <button onclick="openScheduleModal()" class="bg-gray-700 text-white border border-gray-800 py-1 rounded font-bold text-[9px] hover:bg-gray-800 shadow-sm">ğŸ“… Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
                    <button onclick="confirmSessionDay()" class="bg-gray-600 text-white border border-gray-700 py-1 rounded font-bold text-[9px] hover:bg-gray-700 shadow-sm">âœ… ØªØ«Ø¨ÙŠØª</button>
                    <button onclick="cancelSessionDay()" class="bg-red-700 text-white border border-red-800 py-1 rounded font-bold text-[9px] hover:bg-red-800 shadow-sm">âŒ Ø¥Ù„ØºØ§Ø¡</button>
                </div>

                <div class="mb-2 bg-white p-2 rounded border border-gray-300 shadow-sm">
                    <div class="grid grid-cols-2 gap-2">
                        <div class="input-wrapper">
                            <label class="text-[9px] text-gray-600 font-bold block mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…</label>
                            <div class="relative">
                                <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                <input type="date" id="attendanceDate" onchange="changeAttendanceDate()" class="w-full p-1 text-center font-bold text-gray-900 text-xs bg-white">
                            </div>
                        </div>
                        <div class="input-wrapper">
                            <label class="text-[9px] text-gray-600 font-bold block mb-1">Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label>
                            <div class="relative">
                                <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                                <select id="attendanceStage" onchange="updateCounters()" class="w-full p-1 text-center font-bold text-gray-900 text-xs bg-white">
                                    <option value="all" selected>Ø§Ù„ÙƒÙ„</option>
                                    <option value="1Ø«">Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                                    <option value="2Ø«">Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                                    <option value="3Ø«">Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex bg-gray-100 p-1 rounded mb-2 no-print border border-gray-300">
                    <button onclick="setAttMode('scan')" id="btnAttScan" class="sub-nav-item flex-1 rounded text-[10px] active transition-all">ğŸ“· ÙƒØ§Ù…ÙŠØ±Ø§</button>
                    <button onclick="setAttMode('manual')" id="btnAttManual" class="sub-nav-item flex-1 rounded text-[10px] transition-all">âŒ¨ï¸ ÙŠØ¯ÙˆÙŠ</button>
                </div>

                <div id="attScanArea" class="relative">
                    <div id="reader" class="scanner-wrapper w-full mb-2"></div>
                    <div id="scanOverlay" class="absolute inset-0 pointer-events-none border-2 border-gray-500 hidden md:block" style="top: 50%; left: 50%; transform: translate(-50%, -50%); width: 250px; height: 250px;"></div>
                    <div id="scanFeedback" class="absolute inset-0 flex items-center justify-center bg-green-500/90 hidden z-10 rounded-lg"><div class="text-white font-bold text-lg animate-bounce md:text-2xl">âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„</div></div>
                    <div class="flex justify-center gap-2 no-print"><button onclick="startScanner('reader', 'attendance')" class="bg-gray-800 text-white px-4 py-1 rounded shadow text-[10px] border border-gray-900">ØªØ´ØºÙŠÙ„</button><button onclick="stopScanner()" class="bg-red-100 text-red-600 px-4 py-1 rounded text-[10px] border border-red-300">Ø¥ÙŠÙ‚Ø§Ù</button></div>
                </div>

                <div id="attManualArea" class="hidden">
                    <div class="input-wrapper mb-2">
                        <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path></svg>
                        <input type="number" id="manualAttID" placeholder="Ø§Ù„ÙƒÙˆØ¯" class="w-full text-center text-xl font-bold p-2 font-mono md:text-2xl md:p-3">
                    </div>
                    <button onclick="manualAttendance()" class="w-full bg-gray-800 text-white py-2 rounded font-bold text-xs md:text-sm md:py-3 border border-gray-900">ØªØ³Ø¬ÙŠÙ„</button>
                </div>

                <div class="grid grid-cols-2 gap-2 mt-3 no-print md:gap-4">
                    <div onclick="openAttendanceModal('present')" class="bg-green-50 p-2 rounded border border-green-200 cursor-pointer hover:bg-green-100 transition"><span class="block text-lg font-bold text-green-600 md:text-2xl" id="presentCount">0</span><span class="text-[10px] text-green-800 font-bold md:text-sm">Ø­Ø¶ÙˆØ±</span></div>
                    <div onclick="openAttendanceModal('absent')" class="bg-red-50 p-2 rounded border border-red-200 cursor-pointer hover:bg-red-100 transition"><span class="block text-lg font-bold text-red-600 md:text-2xl" id="absentCount">0</span><span class="text-[10px] text-red-800 font-bold md:text-sm">ØºÙŠØ§Ø¨</span></div>
                </div>

                <div class="mt-6 border-t border-gray-300 pt-4" id="formalScheduleContainer">
                    <div class="flex justify-between items-center mb-2"><h3 class="font-bold text-sm text-gray-900 md:text-base">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­ØµØµ Ø§Ù„Ø±Ø³Ù…ÙŠ</h3><div class="flex gap-2"><button onclick="printFormalSchedule()" class="bg-gray-800 text-white px-2 py-1 rounded text-[10px] md:text-sm border border-gray-900">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button><button onclick="pdfFormalSchedule()" class="bg-red-700 text-white px-2 py-1 rounded text-[10px] md:text-sm border border-red-900">PDF</button></div></div>
                    <div id="formalSchedulePrintArea" class="overflow-x-auto rounded border border-gray-300 bg-white p-2">
                        <div class="hidden print-only-header text-center mb-4"><h1 class="text-xl font-bold text-gray-900">Smart Center</h1><p class="text-sm text-gray-500">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø±Ø³Ù…ÙŠ</p></div>
                        <table class="schedule-table"><thead><tr><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</th><th>Ø§Ù„Ù…ÙˆØ¹Ø¯</th><th class="no-print">Ø£Ø¬Ù†Ø¯Ø© Ø§Ù„Ø´Ù‡Ø±</th></tr></thead><tbody id="formalScheduleBody"></tbody></table>
                    </div>
                </div>
            </div>
        </section>

        <!-- ACCOUNTING TAB -->
        <section id="accounting" class="tab-content">
            <div class="grid md:grid-cols-2 gap-2 md:gap-4">
                <div class="glass-card border-t-4 border-green-600">
                    <h3 class="font-bold text-green-800 mb-2 text-xs md:text-base">ğŸ’µ Ø§Ø³ØªÙ„Ø§Ù… Ù†Ù‚Ø¯ÙŠØ©</h3>

                    <div id="defaultPaymentBar" class="bg-green-50 p-2 rounded mb-2 border border-green-200">
                        <div class="text-[9px] text-green-800 font-bold mb-1">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø³Ø±ÙŠØ¹</div>
                        <div class="flex gap-1">
                            <input type="number" id="defPayAmount" value="100" class="w-1/4 p-1 text-center font-bold text-xs" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
                            <select id="defPayType" class="w-1/4 p-1 text-[10px]">
                                <option value="Ø´Ù‡Ø±ÙŠØ©">Ø§Ø´ØªØ±Ø§Ùƒ</option>
                                <option value="Ù…Ø°ÙƒØ±Ø©">Ù…Ø°ÙƒØ±Ø©</option>
                                <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                            </select>
                            <input type="text" id="defPayNote" class="w-2/4 p-1 text-[10px]" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯">
                        </div>
                    </div>

                    <div class="flex bg-gray-100 p-1 rounded mb-2 no-print border border-gray-300">
                        <button onclick="togglePayMethod('scan')" id="btnPayScan" class="sub-nav-item flex-1 rounded text-[10px] active font-bold md:text-sm md:py-2">Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
                        <button onclick="togglePayMethod('manual')" id="btnPayManual" class="sub-nav-item flex-1 rounded text-[10px] font-bold md:text-sm md:py-2">ÙƒÙˆØ¯</button>
                    </div>

                    <div id="payScanDiv" class="mb-2">
                        <div id="payReader" class="scanner-wrapper h-24 mb-2 md:h-48"></div>
                        <div class="flex gap-2">
                            <button onclick="startScanner('payReader', 'payment')" class="flex-1 bg-green-700 text-white py-1 rounded text-[10px] no-print md:text-sm md:py-2 border border-green-800">ØªØ´ØºÙŠÙ„</button>
                            <button onclick="stopScanner()" class="flex-1 bg-red-100 text-red-600 border border-red-200 py-1 rounded text-[10px] no-print md:text-sm md:py-2 font-bold">Ø¥ÙŠÙ‚Ø§Ù</button>
                        </div>
                    </div>
                    <div id="payManualDiv" class="hidden flex gap-2 mb-2">
                        <div class="input-wrapper flex-1">
                            <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path></svg>
                            <input type="number" id="paySearchID" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨" class="w-full p-1 text-center font-bold text-xs md:text-sm md:p-2">
                        </div>
                        <button onclick="searchStudentForPay()" class="bg-green-700 text-white px-2 rounded text-xs md:text-sm md:px-4 border border-green-800">ğŸ”</button>
                    </div>

                    <div id="paymentForm" class="hidden bg-yellow-50 p-2 rounded border border-yellow-200">
                        <div class="flex justify-between text-[10px] mb-1 font-bold md:text-sm"><span id="payStdName"></span><span id="payStdID" class="font-mono bg-white px-1 rounded"></span></div>
                        <div class="flex gap-1 mb-1">
                            <input type="number" id="payAmount" class="w-1/3 p-1 text-center font-bold text-xs md:text-sm md:p-2">
                            <select id="payType" class="w-2/3 p-1 text-[10px] md:text-sm md:p-2">
                                <option value="Ø´Ù‡Ø±ÙŠØ©">Ø§Ø´ØªØ±Ø§Ùƒ</option>
                                <option value="Ù…Ø°ÙƒØ±Ø©">Ù…Ø°ÙƒØ±Ø©</option>
                                <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                            </select>
                        </div>
                        <input type="text" id="payNote" class="w-full p-1 text-[10px] mb-1" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯">
                        <div class="flex gap-2 mt-2">
                            <button onclick="confirmPayment()" class="flex-1 bg-green-700 text-white py-1 rounded font-bold shadow text-[10px] md:text-sm md:py-2 border border-green-800">ØªØ£ÙƒÙŠØ¯</button>
                            <button onclick="cancelPayment()" class="flex-1 bg-gray-500 text-white py-1 rounded font-bold shadow text-[10px] md:text-sm md:py-2 border border-gray-600">Ø¥Ù„ØºØ§Ø¡</button>
                        </div>
                    </div>
                </div>
                <div class="glass-card border-t-4 border-red-600">
                    <h3 class="font-bold text-red-800 mb-2 text-xs md:text-base">ğŸ“‰ Ù…ØµØ±ÙˆÙØ§Øª</h3>
                    <div class="space-y-2">
                        <div class="grid grid-cols-2 gap-1">
                            <select id="expType" class="p-1 bg-white md:text-sm md:p-2"><option value="">Ø§Ù„Ø¨Ù†Ø¯...</option><option value="Ø±ÙˆØ§ØªØ¨">Ø±ÙˆØ§ØªØ¨</option><option value="ÙƒÙ‡Ø±Ø¨Ø§Ø¡">ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option><option value="Ø¥ÙŠØ¬Ø§Ø±">Ø¥ÙŠØ¬Ø§Ø±</option><option value="ØµÙŠØ§Ù†Ø©">ØµÙŠØ§Ù†Ø©</option><option value="Ø·Ø¨Ø§Ø¹Ø©">Ø·Ø¨Ø§Ø¹Ø©</option><option value="Ø¨ÙˆÙÙŠÙ‡">Ø¨ÙˆÙÙŠÙ‡</option><option value="Ù†Ø«Ø±ÙŠØ§Øª">Ù†Ø«Ø±ÙŠØ§Øª</option><option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option></select>
                            <input type="text" id="expDetails" placeholder="ØªÙØ§ØµÙŠÙ„" class="p-1 md:text-sm md:p-2">
                        </div>
                        <div class="grid grid-cols-2 gap-1">
                            <input type="number" id="expAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" class="p-1 md:text-sm md:p-2">
                            <input type="text" id="expNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø©" class="p-1 md:text-sm md:p-2">
                        </div>
                        <button onclick="addExpense()" class="w-full bg-red-50 text-red-700 border border-red-200 py-1 rounded font-bold hover:bg-red-100 text-[10px] md:text-sm md:py-2">ØªØ³Ø¬ÙŠÙ„</button></div>
                </div>
            </div>
            <div class="bg-gray-800 text-white p-3 rounded-xl shadow-lg mt-2 md:p-5 border-2 border-gray-900">
                <div class="grid grid-cols-3 gap-2 mb-2 text-center">
                    <div class="bg-white/10 p-2 rounded border border-white/20">
                        <p class="text-[9px] opacity-70">Ø§Ù„ÙˆØ§Ø±Ø¯</p>
                        <p class="text-lg font-bold text-green-400" id="totalRev">0</p>
                    </div>
                    <div class="bg-white/10 p-2 rounded border border-white/20">
                        <p class="text-[9px] opacity-70">Ø§Ù„ØµØ§Ø¯Ø±</p>
                        <p class="text-lg font-bold text-red-400" id="totalExp">0</p>
                    </div>
                    <div class="bg-white/10 p-2 rounded border border-white/20">
                        <p class="text-[9px] opacity-70">Ø§Ù„ØµØ§ÙÙŠ</p>
                        <p class="text-lg font-bold text-white" id="netProfit">0</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2 md:gap-4"><div class="bg-white/10 p-1.5 rounded md:p-3"><h4 class="text-[10px] font-bold text-green-300 mb-1 border-b border-white/20 md:text-sm">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h4><div id="todayRevList" class="h-20 overflow-y-auto text-[9px] space-y-1 md:text-xs md:h-32"></div></div><div class="bg-white/10 p-1.5 rounded md:p-3"><h4 class="text-[10px] font-bold text-red-300 mb-1 border-b border-white/20 md:text-sm">Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙŠÙˆÙ…</h4><div id="todayExpList" class="h-20 overflow-y-auto text-[9px] space-y-1 md:text-xs md:h-32"></div></div></div>
                <div class="flex gap-2 mt-2">
                    <button onclick="printFinancialReport()" class="flex-1 bg-white/20 text-white py-1 rounded text-[10px] hover:bg-white/30 md:text-sm md:py-2 border border-white/30">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                    <button onclick="pdfFinancialReport()" class="flex-1 bg-red-600/80 text-white py-1 rounded text-[10px] hover:bg-red-600 md:text-sm md:py-2 border border-red-700">PDF</button>
                </div>
            </div>
        </section>

        <!-- REPORTS TAB -->
        <section id="reports" class="tab-content">
            <div class="glass-card border-t-4 border-gray-600 mb-4">
                <h3 class="font-bold mb-1 text-gray-900 flex items-center gap-2 text-xs md:text-base"><span>ğŸ‘¤</span> Ø¨Ø­Ø« Ø·Ø§Ù„Ø¨</h3>
                <div class="flex gap-1 mb-1">
                    <select id="searchStage" class="w-1/4 p-1 bg-white text-[10px] md:text-sm md:p-2">
                        <option value="all">Ø§Ù„ÙƒÙ„</option>
                        <option value="1Ø«">1Ø«</option>
                        <option value="2Ø«">2Ø«</option>
                        <option value="3Ø«">3Ø«</option>
                    </select>
                    <div class="input-wrapper flex-1">
                        <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        <input type="text" id="reportStudentSearch" placeholder="Ø§Ø³Ù…/ÙƒÙˆØ¯" class="w-full p-1 text-xs md:text-sm md:p-2">
                    </div>
                    <button onclick="generateStudentReport()" class="bg-gray-800 text-white px-3 rounded font-bold text-[10px] md:text-sm border border-gray-900">Ø¨Ø­Ø«</button>
                </div>
                <div id="studentReportResult" class="hidden bg-gray-50 p-2 rounded border border-gray-200 text-[10px] md:text-sm"></div>
            </div>
            <div class="glass-card border-t-4 border-gray-600 mb-4">
                <h3 class="font-bold mb-1 text-gray-900 text-xs md:text-base">ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ± Ø¹Ø§Ù…Ø©</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-1 mb-1">
                    <div><label class="text-[9px] text-gray-500 block mb-0.5 md:text-xs">Ø§Ù„Ù†ÙˆØ¹</label><select id="reportType" onchange="toggleReportInputs()" class="w-full p-1 bg-white text-[10px] md:text-sm md:p-2"><option value="daily">ÙŠÙˆÙ…ÙŠ</option><option value="monthly">Ø´Ù‡Ø±ÙŠ</option></select></div>
                    <div>
                        <label class="text-[9px] text-gray-500 block mb-0.5 md:text-xs">Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label>
                        <select id="reportStage" class="w-full p-1 bg-white text-[10px] md:text-sm md:p-2">
                            <option value="all">Ø§Ù„ÙƒÙ„</option>
                            <option value="1Ø«">Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                            <option value="2Ø«">Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                            <option value="3Ø«">Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                        </select>
                    </div>
                    <div id="divDateInput">
                        <label class="text-[9px] text-gray-500 block mb-0.5 md:text-xs">Ø§Ù„ÙŠÙˆÙ…</label>
                        <div class="input-wrapper">
                            <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            <input type="date" id="reportDate" class="w-full p-1 text-[10px] md:text-sm md:p-2">
                        </div>
                    </div>
                    <div id="divMonthInput" class="hidden">
                        <label class="text-[9px] text-gray-500 block mb-0.5 md:text-xs">Ø§Ù„Ø´Ù‡Ø±</label>
                        <div class="input-wrapper">
                            <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            <input type="month" id="reportMonth" class="w-full p-1 text-[10px] md:text-sm md:p-2">
                        </div>
                    </div>
                    <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ -->
                    <div class="col-span-1 md:col-span-2">
                        <label class="text-[9px] text-gray-500 block mb-0.5 md:text-xs">Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</label>
                        <select id="reportCategory" onchange="toggleReportView()" class="w-full p-1 bg-white text-[10px] md:text-sm md:p-2">
                            <option value="finance">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª / Ù…ØµØ±ÙˆÙØ§Øª</option>
                            <option value="attendance">Ø­Ø¶ÙˆØ± ÙˆØºÙŠØ§Ø¨</option>
                        </select>
                    </div>
                </div>
                <button onclick="generateAdvancedReport()" class="w-full bg-gray-800 text-white py-1 rounded font-bold shadow hover:bg-gray-900 text-[10px] md:text-sm md:py-2 border border-gray-900">Ø¹Ø±Ø¶</button>

                <!-- Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
                <div id="reportResult" class="mt-2 hidden bg-gray-50 p-2 rounded border border-gray-200 text-[10px] md:text-sm">
                    <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø¨ÙˆØ§Ø³Ø·Ø© JS -->
                </div>
            </div>
            <div class="glass-card border-t-4 border-gray-600 mb-4">
                <h3 class="font-bold mb-1 text-gray-900 flex items-center gap-2 text-xs md:text-base"><span>ğŸ“¢</span> Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¬Ù…Ø§Ø¹ÙŠØ©</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-1 mb-1">
                    <div><label class="text-[9px] text-gray-500 block mb-0.5 md:text-xs">Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label><select id="bulkStage" class="w-full p-1 bg-white text-[10px] md:text-sm md:p-2"><option value="all">Ø§Ù„ÙƒÙ„</option><option value="1Ø«">Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option><option value="2Ø«">Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option><option value="3Ø«">Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option></select></div>
                    <div><label class="text-[9px] text-gray-500 block mb-0.5 md:text-xs">Ø§Ù„ÙØªØ±Ø©</label><select id="bulkType" onchange="toggleBulkInputs()" class="w-full p-1 bg-white text-[10px] md:text-sm md:p-2"><option value="daily">ÙŠÙˆÙ…ÙŠ</option><option value="monthly">Ø´Ù‡Ø±ÙŠ</option></select></div>
                    <div id="bulkDateDiv"><label class="text-[9px] text-gray-500 block mb-0.5 md:text-xs">Ø§Ù„ÙŠÙˆÙ…</label><input type="date" id="bulkDate" class="w-full p-1 text-[10px] md:text-sm md:p-2"></div>
                    <div id="bulkMonthDiv" class="hidden"><label class="text-[9px] text-gray-500 block mb-0.5 md:text-xs">Ø§Ù„Ø´Ù‡Ø±</label><input type="month" id="bulkMonth" class="w-full p-1 text-[10px] md:text-sm md:p-2"></div>
                </div>
                <div class="flex gap-2">
                    <button onclick="openBulkWhatsAppModal()" class="flex-1 bg-green-700 text-white py-1.5 rounded font-bold shadow hover:bg-green-800 text-[10px] md:text-sm md:py-2 border border-green-900">ğŸ“± ÙˆØ§ØªØ³Ø§Ø¨</button>
                    <button onclick="exportBulkExcel()" class="flex-1 bg-gray-700 text-white py-1.5 rounded font-bold shadow hover:bg-gray-800 text-[10px] md:text-sm md:py-2 border border-gray-900">ğŸ“Š Excel</button>
                </div>
            </div>
            <div class="glass-card border-t-4 border-yellow-500">
                <h3 class="font-bold mb-1 flex items-center gap-2 text-yellow-800 text-xs md:text-base"><span>ğŸ’¾</span> Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ & Ø¥ØµÙ„Ø§Ø­</h3>
                <div class="flex gap-2">
                    <button onclick="exportData()" class="flex-1 bg-yellow-100 text-yellow-800 py-1 rounded font-bold text-[10px] border border-yellow-300 md:text-sm md:py-2">ØªØ­Ù…ÙŠÙ„</button>
                    <div class="relative flex-1"><input type="file" id="importFile" onchange="importData(this)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"><button class="w-full bg-gray-100 text-gray-700 py-1 rounded font-bold text-[10px] border border-gray-300 md:text-sm md:py-2">Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button></div>
                    <button onclick="repairSystemData()" class="flex-1 bg-red-700 text-white py-1 rounded font-bold text-[10px] md:text-sm md:py-2 border border-red-900">ğŸ› ï¸ Ø¥ØµÙ„Ø§Ø­</button>
                </div>
            </div>
        </section>
    </main>
</div>

<!-- MODALS -->
<div id="scheduleModal" class="fixed inset-0 bg-black/80 hidden z-[200] flex items-center justify-center p-4 no-print">
    <div class="bg-white rounded-xl w-full max-w-md p-4 shadow-2xl h-[80vh] flex flex-col md:max-w-lg">
        <div class="flex justify-between items-center mb-4 border-b pb-2"><h3 class="font-bold text-lg text-gray-900">ğŸ“… Ø¥Ø¹Ø¯Ø§Ø¯ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­ØµØµ</h3><button onclick="closeModal('scheduleModal')" class="text-red-500 font-bold text-xl">&times;</button></div>
        <div class="overflow-y-auto flex-1 p-2 space-y-4" id="scheduleContainer"></div>
        <button onclick="saveSchedule()" class="w-full bg-gray-800 text-white py-2 rounded font-bold mt-2 border border-gray-900">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
    </div>
</div>

<div id="monthlyScheduleModal" class="fixed inset-0 bg-black/80 hidden z-[210] flex items-center justify-center p-4 no-print">
    <div class="bg-white rounded-xl w-full max-w-sm p-4 shadow-2xl relative md:max-w-md">
        <button onclick="closeModal('monthlyScheduleModal')" class="absolute top-2 right-3 text-gray-500 text-xl font-bold">&times;</button>
        <div id="monthlyScheduleCard">
            <div class="text-center border-b pb-2 mb-2"><h3 class="font-bold text-lg text-gray-900" id="msStageName"></h3><input type="month" id="msMonthInput" onchange="renderMonthlySchedule()" class="mt-1 p-1 border rounded text-xs md:text-sm"></div>
            <div id="msDatesList" class="max-h-60 overflow-y-auto text-sm space-y-1 p-2 border rounded bg-gray-50"></div>
        </div>
        <div class="grid grid-cols-2 gap-2 mt-3"><button onclick="printMonthlySchedule()" class="bg-gray-800 text-white py-1.5 rounded text-xs font-bold md:text-sm border border-gray-900">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button><button onclick="pdfMonthlySchedule()" class="bg-red-700 text-white py-1.5 rounded text-xs font-bold md:text-sm border border-red-800">ğŸ“„ PDF</button></div>
    </div>
</div>

<div id="studentModal" class="fixed inset-0 bg-black/80 hidden z-[150] flex items-center justify-center p-4 no-print">
    <div class="bg-white rounded-xl w-full max-w-xs p-4 text-center relative shadow-2xl md:max-w-sm">
        <button onclick="closeModal('studentModal')" class="absolute top-2 right-3 text-gray-500 text-xl font-bold">&times;</button>
        <div id="studentCardDisplay" class="unified-card">
            <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ø¨ÙˆØ§Ø³Ø·Ø© JS Ù„ÙŠØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
        </div>
        <div class="grid grid-cols-2 gap-2"><button onclick="printStudentCard()" class="bg-gray-800 text-white py-1 rounded text-[10px] font-bold md:text-sm md:py-2 border border-gray-900">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button><button onclick="shareStudentPdf()" class="bg-red-700 text-white py-1 rounded text-[10px] font-bold md:text-sm md:py-2 border border-red-800">ğŸ“„ PDF</button></div>
    </div>
</div>

<div id="detailsModal" class="fixed inset-0 bg-black/80 hidden z-[100] flex items-center justify-center p-4 no-print">
    <div class="bg-white rounded-xl w-full max-w-xl p-0 h-[80vh] flex flex-col shadow-2xl overflow-hidden md:max-w-2xl">
        <div class="flex justify-between items-center p-3 border-b bg-gray-50"><h3 id="detailsTitle" class="font-bold text-sm text-gray-800 md:text-lg"></h3><div class="flex gap-2"><button onclick="printContent('detailsTableArea', document.getElementById('detailsTitle').innerText)" class="bg-gray-800 text-white px-2 py-1 rounded text-[10px] md:text-sm border border-gray-900">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button><button onclick="pdfContent('detailsTableArea', document.getElementById('detailsTitle').innerText)" class="bg-red-700 text-white px-2 py-1 rounded text-[10px] md:text-sm border border-red-900">PDF</button><button onclick="closeModal('detailsModal')" class="text-red-500 font-bold text-lg">&times;</button></div></div>
        <div id="modalFilterContainer" class="p-2 bg-gray-100 border-b hidden">
            <select id="attFilterLevel" onchange="filterAttendanceList()" class="w-full p-1 border rounded bg-white text-[10px] md:text-sm md:p-2">
                <option value="all">ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„</option>
                <option value="1Ø«">Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                <option value="2Ø«">Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                <option value="3Ø«">Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
            </select>
        </div>
        <div id="detailsTableArea" class="overflow-y-auto flex-1 p-0"><table class="custom-table"><thead id="detailsTableHead"></thead><tbody id="detailsTableBody"></tbody></table></div>
    </div>
</div>

<div id="bulkWhatsAppModal" class="fixed inset-0 bg-black/80 hidden z-[250] flex items-center justify-center p-4 no-print">
    <div class="bg-white rounded-xl w-full max-w-md p-4 shadow-2xl h-[80vh] flex flex-col md:max-w-lg">
        <div class="flex justify-between items-center mb-4 border-b pb-2"><h3 class="font-bold text-lg text-green-900">ğŸ“± Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨ Ø¬Ù…Ø§Ø¹ÙŠ</h3><button onclick="closeModal('bulkWhatsAppModal')" class="text-red-500 font-bold text-xl">&times;</button></div>
        <div class="bg-yellow-50 p-2 rounded border border-yellow-200 mb-2 text-[10px] text-yellow-800 font-bold md:text-xs">ØªÙ†Ø¨ÙŠÙ‡: Ø³ÙŠØªÙ… ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Pop-ups).</div>
        <div class="grid grid-cols-12 gap-1 bg-gray-100 p-2 rounded-t font-bold text-xs border-b md:text-sm">
            <div class="col-span-2 text-center">Ù…</div>
            <div class="col-span-7">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</div>
            <div class="col-span-3 text-center">Ø¥Ø¬Ø±Ø§Ø¡</div>
        </div>
        <div id="bulkListContainer" class="overflow-y-auto flex-1 p-2 space-y-1 border rounded-b bg-gray-50"></div>
        <div class="mt-2 pt-2 border-t text-center"><p id="bulkProgress" class="text-xs font-bold text-gray-600 mb-2 md:text-sm">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ø±Ø³Ø§Ù„</p></div>
    </div>
</div>

<div id="pdf-generator-container" style="position: absolute; top: -9999px; left: -9999px;"></div>
<div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-xl z-[200] hidden font-bold text-xs md:text-sm md:px-8 md:py-4"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, onSnapshot, query, where, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyAttesgksSJWs--veymN8PTRNHBX9r27V0", authDomain: "system-a8c1e.firebaseapp.com", projectId: "system-a8c1e", storageBucket: "system-a8c1e.firebasestorage.app", messagingSenderId: "674440908222", appId: "1:674440908222:web:31221baab0048ee8c63def" };
    const app = initializeApp(firebaseConfig); 
    const db = getFirestore(app);
    const auth = getAuth(app);

    window.db = db; window.auth = auth; window.collection = collection; window.addDoc = addDoc; window.getDocs = getDocs; window.doc = doc; window.deleteDoc = deleteDoc; window.onSnapshot = onSnapshot; window.query = query; window.where = where; window.setDoc = setDoc; window.updateDoc = updateDoc;
    window.signInWithEmailAndPassword = signInWithEmailAndPassword; window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;

    const loading = document.getElementById('loadingOverlay');
    onSnapshot(collection(db, "students"), (snapshot) => { window.students = []; snapshot.forEach(doc => window.students.push({ ...doc.data(), docId: doc.id })); window.renderStudents(); window.updateCounters(); loading.style.display = 'none'; });
    onSnapshot(collection(db, "attendance"), (snapshot) => { window.attendance = []; snapshot.forEach(doc => window.attendance.push({ ...doc.data(), docId: doc.id })); window.updateCounters(); window.renderFormalSchedule(); });
    onSnapshot(collection(db, "accounting"), (snapshot) => { window.accounting = []; snapshot.forEach(doc => window.accounting.push({ ...doc.data(), docId: doc.id })); window.updateFinance(); });
    onSnapshot(doc(db, "settings", "schedule"), (doc) => { if(doc.exists()) window.scheduleData = doc.data(); else window.scheduleData = {}; window.renderFormalSchedule(); window.updateCounters(); });
</script>

<script>
    // --- PWA Service Worker Registration ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./service-worker.js')
                .then(registration => console.log('SW registered: ', registration))
                .catch(registrationError => console.log('SW registration failed: ', registrationError));
        });
    }

    // --- Security Measures (Anti-Theft) ---
    document.addEventListener('contextmenu', event => event.preventDefault());
    document.onkeydown = function(e) {
        if(e.keyCode == 123) return false; 
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false; 
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) return false; 
        if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false; 
    }

    const stageMap = { "1Ø«": "Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ", "2Ø«": "Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ", "3Ø«": "Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ" };
    const daysOfWeek = [{ id: 'Sunday', name: 'Ø§Ù„Ø£Ø­Ø¯' }, { id: 'Monday', name: 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†' }, { id: 'Tuesday', name: 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡' }, { id: 'Wednesday', name: 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡' }, { id: 'Thursday', name: 'Ø§Ù„Ø®Ù…ÙŠØ³' }, { id: 'Friday', name: 'Ø§Ù„Ø¬Ù…Ø¹Ø©' }, { id: 'Saturday', name: 'Ø§Ù„Ø³Ø¨Øª' }];
    const dayMap = { 'Sunday': 'Ø§Ù„Ø£Ø­Ø¯', 'Monday': 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Tuesday': 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Wednesday': 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Thursday': 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Friday': 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Saturday': 'Ø§Ù„Ø³Ø¨Øª' };

    window.students = []; window.attendance = []; window.accounting = []; window.scheduleData = {};

    function getEgyptDate() {
        return new Date().toLocaleDateString('en-CA', { timeZone: 'Africa/Cairo' });
    }

    let today = getEgyptDate();
    let selectedAttendanceDate = today; let currentModalStudentId = null; let currentParentPhone = null; let currentScheduleLevel = null; let currentReportData = {};
    let loginMode = 'admin';
    let isPrinting = false; // Ù…ØªØºÙŠØ± Ù„Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©

    function normalizeArabic(text) { return text.replace(/[Ø£Ø¥Ø¢]/g, 'Ø§').replace(/Ø©/g, 'Ù‡').replace(/Ù‰/g, 'ÙŠ'); }

    window.onload = () => {
        today = getEgyptDate();
        document.getElementById('headerDate').innerText = today;
        document.getElementById('attendanceDate').value = today;
        document.getElementById('reportDate').value = today;
        document.getElementById('bulkDate').value = today;
        document.getElementById('msMonthInput').value = today.substring(0, 7);

        const savedLogin = localStorage.getItem('isLoggedIn');
        const savedMode = localStorage.getItem('loginMode');
        const savedTab = localStorage.getItem('activeTab');
        const savedStudentId = localStorage.getItem('currentStudentId');

        if (savedLogin === 'true') {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('appContent').classList.remove('hidden');
            loginMode = savedMode;
            if (loginMode === 'admin') {
                document.getElementById('navBar').classList.remove('hidden');
                showTab(savedTab || 'students', document.getElementById(`nav-${savedTab || 'students'}`));
            } else {
                document.getElementById('navBar').classList.add('hidden');
                setTimeout(() => { const student = window.students.find(s => s.id === savedStudentId); if(student) loadStudentDashboard(student); }, 1000);
            }
        } else {
            document.getElementById('loginOverlay').style.display = 'flex';
            showTab('students', document.getElementById('nav-students'));
        }
    };

    window.validatePhone = function(input) { let val = input.value.replace(/\D/g, ''); if (val.startsWith('0')) val = val.substring(1); if (val.length > 10) val = val.substring(0, 10); input.value = val; }
    window.setLoginMode = function(mode) { loginMode = mode; document.getElementById('tabAdmin').className = mode === 'admin' ? 'login-tab active' : 'login-tab'; document.getElementById('tabStudent').className = mode === 'student' ? 'login-tab active' : 'login-tab'; document.getElementById('loginCode').placeholder = mode === 'admin' ? 'ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©' : 'ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨'; }

    // --- ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
    window.handleLogin = async function() { 
        const code = document.getElementById('loginCode').value.trim(); 
        const pass = document.getElementById('loginPass').value.trim(); 
        const errorMsg = document.getElementById('loginError'); 

        if (loginMode === 'admin') { 
            // Ø§Ù„ÙƒÙˆØ¯: 1032 | Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯: 10321032
            if (code === '1032' && pass === '10321032') { 
                const adminEmail = "admin_pro@smartcenter.app"; 
                
                try {
                    await window.signInWithEmailAndPassword(window.auth, adminEmail, pass);
                    proceedLogin('admin');
                } catch (error) {
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                        try {
                            await window.createUserWithEmailAndPassword(window.auth, adminEmail, pass);
                            proceedLogin('admin');
                        } catch (createError) {
                            console.error("Create Admin Error:", createError);
                            errorMsg.innerText = "Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©";
                            errorMsg.classList.remove('hidden');
                        }
                    } else if (error.code === 'auth/wrong-password') {
                        errorMsg.innerText = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ù„Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„";
                        errorMsg.classList.remove('hidden');
                    } else {
                        console.error("Login Error:", error);
                        errorMsg.innerText = "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹";
                        errorMsg.classList.remove('hidden');
                    }
                }
            } else { 
                errorMsg.innerText = "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
                errorMsg.classList.remove('hidden'); 
            } 
        } else { 
            const student = window.students.find(s => s.id === code); 
            if (student && student.password === pass) { 
                try {
                    await window.signInWithEmailAndPassword(window.auth, `${code}@smartcenter.app`, pass);
                    localStorage.setItem('currentStudentId', student.id); 
                    proceedLogin('student');
                } catch (error) {
                    if (error.code === 'auth/user-not-found') {
                        try {
                            await window.createUserWithEmailAndPassword(window.auth, `${code}@smartcenter.app`, pass);
                            localStorage.setItem('currentStudentId', student.id);
                            proceedLogin('student');
                        } catch (createErr) {
                            errorMsg.classList.remove('hidden');
                        }
                    } else {
                        errorMsg.classList.remove('hidden');
                    }
                }
            } else { 
                errorMsg.classList.remove('hidden'); 
            } 
        } 
    }

    function proceedLogin(mode) {
        localStorage.setItem('isLoggedIn', 'true'); 
        localStorage.setItem('loginMode', mode); 
        document.getElementById('loginOverlay').style.display = 'none'; 
        document.getElementById('appContent').classList.remove('hidden'); 
        if (mode === 'admin') {
            document.getElementById('navBar').classList.remove('hidden'); 
            showTab('students', document.getElementById('nav-students')); 
        } else {
            document.getElementById('navBar').classList.add('hidden'); 
            const s = window.students.find(st => st.id === localStorage.getItem('currentStudentId'));
            if(s) loadStudentDashboard(s);
        }
    }

    window.logout = function() { localStorage.clear(); location.reload(); }

    function getStudentStatusForDate(student, dateStr) {
        const dateObj = new Date(dateStr + "T12:00:00");
        const dayName = dateObj.toLocaleDateString('en-US', {weekday: 'long'});
        const attendanceRecord = window.attendance.find(r => r.date === dateStr && r.studentId === student.id);
        const sessionRec = window.attendance.find(r => r.studentId === "SESSION_MARKER" && r.date === dateStr);
        const isGlobalExceptional = sessionRec && (!sessionRec.levels || sessionRec.levels.includes('all') || sessionRec.levels.includes(student.level));
        const studentSchedule = window.scheduleData[student.level] || { days: [] };
        const isScheduled = (studentSchedule.days || []).includes(dayName);

        if (attendanceRecord) { return { status: 'present', time: attendanceRecord.time, isExceptional: (!isScheduled || isGlobalExceptional) }; }

        if (isScheduled || isGlobalExceptional) { 
            return { status: 'absent', isExceptional: isGlobalExceptional }; 
        }

        return { status: 'none' };
    }

    function getDatesInRange(startDate, endDate) {
        const dates = [];
        let [sY, sM, sD] = startDate.split('-').map(Number);
        let [eY, eM, eD] = endDate.split('-').map(Number);
        let curr = new Date(sY, sM - 1, sD, 12, 0, 0);
        let last = new Date(eY, eM - 1, eD, 12, 0, 0);
        while (curr <= last) {
            const y = curr.getFullYear();
            const m = String(curr.getMonth() + 1).padStart(2, '0');
            const d = String(curr.getDate()).padStart(2, '0');
            dates.push(`${y}-${m}-${d}`);
            curr.setDate(curr.getDate() + 1);
        }
        return dates;
    }

    function calculateStudentStats(student) {
        let present = 0; let absent = 0; let history = [];
        const joinDate = student.date || '2020-01-01';

        const allDatesForStats = getDatesInRange(joinDate, today);
        allDatesForStats.forEach(dateStr => {
            const statusObj = getStudentStatusForDate(student, dateStr);
            if (statusObj.status === 'present') present++;
            else if (statusObj.status === 'absent') absent++;
        });

        const studentAtt = window.attendance.filter(a => a.studentId === student.id);
        const latestAttDate = studentAtt.length > 0 ? studentAtt.map(a => a.date).sort().reverse()[0] : today;
        const maxDateForHistory = latestAttDate > today ? latestAttDate : today;

        const allDatesForHistory = getDatesInRange(joinDate, maxDateForHistory);
        allDatesForHistory.forEach(dateStr => {
            const dayAr = new Date(dateStr + "T12:00:00").toLocaleDateString('ar-EG', {weekday: 'long'});
            const statusObj = getStudentStatusForDate(student, dateStr);
            if (statusObj.status === 'present' || (statusObj.status === 'absent' && dateStr <= today)) {
                history.push({ date: dateStr, day: dayAr, status: statusObj.status, isExceptional: statusObj.isExceptional });
            }
        });

        history.sort((a, b) => new Date(b.date) - new Date(a.date));
        return { present, absent, history };
    }

    function loadStudentDashboard(student) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById('studentDashboard').classList.add('active');
        document.getElementById('dashName').innerText = student.name;
        document.getElementById('dashCode').innerText = student.id;
        document.getElementById('dashLevel').innerText = stageMap[student.level];
        document.getElementById('dashJoinDate').innerText = student.date;
        const join = new Date(student.date); const now = new Date();
        const diffDays = Math.ceil(Math.abs(now - join) / (1000 * 60 * 60 * 24));
        document.getElementById('dashDuration').innerText = `${diffDays} ÙŠÙˆÙ…`;
        document.getElementById('dashQr').innerHTML = ''; new QRCode(document.getElementById("dashQr"), { text: student.id, width: 80, height: 80 });
        const stats = calculateStudentStats(student);
        document.getElementById('dashPresent').innerText = stats.present;
        document.getElementById('dashAbsent').innerText = stats.absent;
        const payments = window.accounting.filter(r => r.category === 'revenue' && r.stdId === student.id);
        const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
        document.getElementById('dashPaymentsTotal').innerText = `${totalPaid} Ø¬.Ù…`;
        const payTable = document.getElementById('dashPaymentsTable');
        if(payments.length > 0) { payTable.innerHTML = payments.map(p => `<tr><td>${p.date}</td><td>${p.type}</td><td class="text-green-600 font-bold">${p.amount}</td></tr>`).join(''); } else { payTable.innerHTML = '<tr><td colspan="3" class="text-center text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯ÙÙˆØ¹Ø§Øª</td></tr>'; }
        const exceptionalHistory = stats.history.filter(h => h.status === 'present' && h.isExceptional);
        const excTable = document.getElementById('dashExceptionalTable');
        if(exceptionalHistory.length > 0) { excTable.innerHTML = exceptionalHistory.map(h => `<tr><td>${h.date}</td><td>${h.day}</td><td class="text-green-600 font-bold">Ø­Ø¶ÙˆØ± Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠ</td></tr>`).join(''); } else { excTable.innerHTML = '<tr><td colspan="3" class="text-center text-gray-400">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¶ÙˆØ± Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠ</td></tr>'; }
        const historyHtml = stats.history.map(h => `<div class="flex justify-between border-b p-2 ${h.status === 'absent' ? 'bg-red-50' : 'bg-green-50'}"><span>${h.date} (${h.day})</span><span class="font-bold ${h.status === 'absent' ? 'text-red-600' : 'text-green-600'}">${h.status === 'absent' ? 'ØºÙŠØ§Ø¨' : 'Ø­Ø¶ÙˆØ±'} ${h.isExceptional ? '(Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠ)' : ''}</span></div>`).join('');
        document.getElementById('dashHistory').innerHTML = historyHtml || '<p class="text-center text-gray-400 text-xs">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„</p>';
    }

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…ÙˆØ­Ø¯ Ø§Ù„Ù…Ø­Ø³Ù† (Ù…Ø¹ Ù…Ù†Ø¹ Ø§Ù„ØªØ¬Ù…Ø¯) ---
    function printHTML(title, content) {
        if(isPrinting) return; // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
        if(!content) return; 
        
        isPrinting = true; // Ù‚ÙÙ„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
        
        const printContainer = document.getElementById('print-container');
        const date = new Date().toLocaleDateString('ar-EG');

        const template = `
            <div class="print-page">
                <div class="print-header">
                    <div class="print-meta-area">
                        <div>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${date}</div>
                        <div>Smart Center Pro</div>
                    </div>
                    <div class="print-title-area">
                        <h1 class="print-main-title">Smart Center</h1>
                        <h2 class="print-sub-title">${title}</h2>
                    </div>
                    <div class="print-logo-area">
                        <div style="font-size: 30px;">ğŸ“</div>
                    </div>
                </div>
                <div class="print-body">
                    ${content}
                </div>
            </div>
        `;

        printContainer.innerHTML = template;
        
        // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± (Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯) Ù‚Ø¨Ù„ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
        setTimeout(() => {
            window.print();
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙˆÙØªØ­ Ø§Ù„Ù‚ÙÙ„ Ø¨Ø¹Ø¯ ÙˆÙ‚Øª ÙƒØ§ÙÙ
            setTimeout(() => { 
                printContainer.innerHTML = ''; 
                isPrinting = false; 
            }, 1000);
        }, 500); 
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø§Ø±ÙƒÙˆØ¯ HTML Ø¬Ø§Ù‡Ø² (Ù…Ø­Ø³Ù†Ø© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø©)
    function generateQRHtml(text) {
        return new Promise((resolve) => {
            const holder = document.createElement('div');
            holder.style.position = 'absolute';
            holder.style.top = '-9999px';
            holder.style.left = '-9999px';
            document.body.appendChild(holder);

            new QRCode(holder, { 
                text: text, 
                width: 120, 
                height: 120,
                correctLevel : QRCode.CorrectLevel.H
            });
            
            setTimeout(() => {
                const canvas = holder.querySelector('canvas');
                const img = holder.querySelector('img');
                let html = '';
                
                if (canvas) {
                    const dataUrl = canvas.toDataURL("image/png");
                    html = `<img src="${dataUrl}" style="width:100px; height:100px; margin:0 auto;" />`;
                } else if (img) {
                    img.style.width = '100px';
                    img.style.height = '100px';
                    img.style.margin = '0 auto';
                    html = img.outerHTML;
                }

                document.body.removeChild(holder); // Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± ÙÙˆØ±Ø§Ù‹
                resolve(html);
            }, 300);
        });
    }

    // --- Ø¯Ø§Ù„Ø© Ø­ÙØ¸ PDF Ø¹Ø§Ù…Ø© ---
    function savePDF(title, content) {
        const pdfContainer = document.getElementById('pdf-generator-container');
        const date = new Date().toLocaleDateString('ar-EG');

        pdfContainer.innerHTML = `
            <div style="width: 210mm; padding: 20px; font-family: 'Cairo', sans-serif; background: white; direction: rtl; text-align: right;">
                <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px;">
                    <h1 style="font-size: 24px; font-weight: bold; margin: 0;">Smart Center</h1>
                    <h2 style="font-size: 18px; margin: 5px 0;">${title}</h2>
                    <p style="font-size: 12px; color: #666;">ØªØ§Ø±ÙŠØ®: ${date}</p>
                </div>
                <div style="width: 100%; margin: 0 auto;">
                    ${content}
                </div>
            </div>
        `;

        const tables = pdfContainer.querySelectorAll('table');
        tables.forEach(t => {
            t.style.width = '100%';
            t.style.borderCollapse = 'collapse';
            t.style.fontSize = '12px';
            t.querySelectorAll('th, td').forEach(c => {
                c.style.border = '1px solid #000';
                c.style.padding = '5px';
                c.style.textAlign = 'center';
            });
            t.querySelectorAll('th').forEach(h => h.style.backgroundColor = '#eee');
        });

        const element = pdfContainer.firstElementChild;
        const opt = {
            margin: 0,
            filename: `${title}_${date}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true, scrollX: 0, scrollY: 0 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        setTimeout(() => {
            html2pdf().set(opt).from(element).save().then(() => {
                pdfContainer.innerHTML = '';
            });
        }, 500);
    }

    window.printStudentDashboard = async function() {
        if(isPrinting) return;
        const name = document.getElementById('dashName').innerText;
        const code = document.getElementById('dashCode').innerText;
        
        if(!name || !code) { showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'error'); return; }
        showToast('Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©...', 'success');

        const level = document.getElementById('dashLevel').innerText;
        const joinDate = document.getElementById('dashJoinDate').innerText;
        const present = document.getElementById('dashPresent').innerText;
        const absent = document.getElementById('dashAbsent').innerText;
        const totalPaid = document.getElementById('dashPaymentsTotal').innerText;
        const paymentsHTML = document.getElementById('dashPaymentsTable').innerHTML;

        const qrImageHtml = await generateQRHtml(code);

        let historyTableRows = '';
        const historyDivs = document.getElementById('dashHistory').querySelectorAll('div');
        historyDivs.forEach(div => { 
            const spans = div.querySelectorAll('span'); 
            if(spans.length >= 2) { 
                historyTableRows += `<tr><td>${spans[0].innerText}</td><td>${spans[1].innerText}</td></tr>`; 
            } 
        });

        const content = `
            <div class="print-student-card">
                <div class="print-card-title">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</div>
                <div class="print-card-name">${name}</div>
                <div style="display:flex; justify-content:center; margin:10px 0;">${qrImageHtml}</div>
                <div class="print-card-row"><span>ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨:</span> <span>${code}</span></div>
                <div class="print-card-row"><span>Ø§Ù„Ù…Ø±Ø­Ù„Ø©:</span> <span>${level}</span></div>
                <div class="print-card-row"><span>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:</span> <span>${joinDate}</span></div>
                <div class="print-card-footer">Smart Center Pro</div>
            </div>
            
            <table class="print-stats-table">
                <tr>
                    <td class="print-stats-cell"><div class="print-box-title">Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</div><div class="print-box-val" style="color:green;">${present}</div></td>
                    <td class="print-stats-cell"><div class="print-box-title">Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨</div><div class="print-box-val" style="color:red;">${absent}</div></td>
                    <td class="print-stats-cell"><div class="print-box-title">Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</div><div class="print-box-val">${totalPaid}</div></td>
                </tr>
            </table>

            <h3 style="border-bottom: 2px solid #000; margin-top: 20px;">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</h3>
            <table class="print-table"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead><tbody>${paymentsHTML}</tbody></table>

            <h3 style="border-bottom: 2px solid #000; margin-top: 20px;">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</h3>
            <table class="print-table"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody>${historyTableRows || '<tr><td colspan="2">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„</td></tr>'}</tbody></table>
        `;

        printHTML('ØªÙ‚Ø±ÙŠØ± Ù…ØªØ§Ø¨Ø¹Ø© Ø·Ø§Ù„Ø¨', content);
    }

    window.pdfStudentDashboard = function() {
        const name = document.getElementById('dashName').innerText;
        const code = document.getElementById('dashCode').innerText;
        const level = document.getElementById('dashLevel').innerText;
        const joinDate = document.getElementById('dashJoinDate').innerText;
        const present = document.getElementById('dashPresent').innerText;
        const absent = document.getElementById('dashAbsent').innerText;
        const totalPaid = document.getElementById('dashPaymentsTotal').innerText;
        const paymentsHTML = document.getElementById('dashPaymentsTable').innerHTML;

        let historyTableRows = '';
        const historyDivs = document.getElementById('dashHistory').querySelectorAll('div');
        historyDivs.forEach(div => { 
            const spans = div.querySelectorAll('span'); 
            if(spans.length >= 2) { 
                historyTableRows += `<tr><td>${spans[0].innerText}</td><td>${spans[1].innerText}</td></tr>`; 
            } 
        });

        const content = `
            <div style="border: 4px double #000; padding: 15px; margin-bottom: 20px; text-align: center; border-radius: 15px; width: 300px; margin: 0 auto 20px auto;">
                <h3 style="margin:0 0 10px 0;">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
                <h2 style="margin:0 0 10px 0; border-bottom: 2px solid #000; padding-bottom: 5px;">${name}</h2>
                <div id="pdfDashQr" style="display:flex; justify-content:center; margin:10px 0;"></div>
                <p style="font-weight: bold;">Ø§Ù„ÙƒÙˆØ¯: ${code}</p>
                <p style="font-weight: bold;">Ø§Ù„Ù…Ø±Ø­Ù„Ø©: ${level}</p>
                <p style="font-weight: bold;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: ${joinDate}</p>
            </div>
            <table style="width:100%; margin-bottom:20px;">
                <tr>
                    <td style="background:#e6fffa; padding:10px; text-align:center; border: 1px solid #000;"><strong>Ø­Ø¶ÙˆØ±:</strong> ${present}</td>
                    <td style="background:#fff5f5; padding:10px; text-align:center; border: 1px solid #000;"><strong>ØºÙŠØ§Ø¨:</strong> ${absent}</td>
                    <td style="background:#ebf8ff; padding:10px; text-align:center; border: 1px solid #000;"><strong>Ù…Ø¯ÙÙˆØ¹Ø§Øª:</strong> ${totalPaid}</td>
                </tr>
            </table>
            <h3>Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</h3>
            <table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead><tbody>${paymentsHTML}</tbody></table>
            <h3>Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±</h3>
            <table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody>${historyTableRows}</tbody></table>
        `;

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = content;
        document.body.appendChild(tempDiv);
        new QRCode(tempDiv.querySelector("#pdfDashQr"), { text: code, width: 100, height: 100 });

        setTimeout(() => {
            savePDF(`ØªÙ‚Ø±ÙŠØ±_${name}`, tempDiv.innerHTML);
            document.body.removeChild(tempDiv);
        }, 500);
    }

    window.printStudentsList = function() {
        if(isPrinting) return;
        let rows = '';
        const filterStage = document.getElementById('studentListFilter').value;
        const query = normalizeArabic(document.getElementById('searchStd').value.toLowerCase());

        let filtered = window.students;
        if(filterStage !== 'all') { filtered = filtered.filter(s => s.level === filterStage); }
        if(query !== '') { filtered = filtered.filter(s => normalizeArabic(s.name.toLowerCase()).includes(query) || s.id.includes(query)); }

        filtered.forEach((s, i) => {
            rows += `<tr><td style="width:50px;">${i+1}</td><td style="width:100px;">${s.id}</td><td>${s.name}</td><td>${stageMap[s.level] || s.level}</td><td>${s.date}</td></tr>`;
        });

        const content = `
            <table class="print-table">
                <thead><tr><th style="width: 50px;">Ù…</th><th style="width: 100px;">Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</th></tr></thead>
                <tbody>${rows}</tbody>
            </table>
        `;
        printHTML('Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†', content);
    }

    window.pdfStudentsList = function() {
        let rows = '';
        const filterStage = document.getElementById('studentListFilter').value;
        const query = normalizeArabic(document.getElementById('searchStd').value.toLowerCase());

        let filtered = window.students;
        if(filterStage !== 'all') { filtered = filtered.filter(s => s.level === filterStage); }
        if(query !== '') { filtered = filtered.filter(s => normalizeArabic(s.name.toLowerCase()).includes(query) || s.id.includes(query)); }

        filtered.forEach((s, i) => {
            rows += `<tr><td style="width:50px;">${i+1}</td><td style="width:100px;">${s.id}</td><td>${s.name}</td><td>${stageMap[s.level] || s.level}</td><td>${s.date}</td></tr>`;
        });

        const content = `
            <table class="print-table">
                <thead><tr><th style="width: 50px;">Ù…</th><th style="width: 100px;">Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</th></tr></thead>
                <tbody>${rows}</tbody>
            </table>
        `;
        savePDF('Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†', content);
    }

    window.renderFormalSchedule = function() {
        const tbody = document.getElementById('formalScheduleBody');
        if(!tbody) return;
        tbody.innerHTML = '';
        Object.keys(stageMap).forEach(level => {
            const data = window.scheduleData[level] || { days: [], times: {} };
            const days = data.days || [];
            const times = data.times || {};

            if(days.length > 0) {
                const daysAr = days.map(d => `<div class="mb-1">${dayMap[d]}</div>`).join('');
                const timesAr = days.map(d => `<div class="mb-1">${times[d] || '-'}</div>`).join('');

                tbody.innerHTML += `<tr><td class="font-bold text-gray-900 align-top pt-2">${stageMap[level]}</td><td class="align-top pt-2">${daysAr}</td><td class="align-top pt-2">${timesAr}</td><td class="no-print align-middle"><button onclick="openMonthlySchedule('${level}')" class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-[9px] font-bold hover:bg-gray-200 border border-gray-300">ğŸ“… Ø£Ø¬Ù†Ø¯Ø© Ø§Ù„Ø´Ù‡Ø±</button></td></tr>`;
            }
        });
        if(tbody.innerHTML === '') tbody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-2">Ù„Ù… ÙŠØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø¹Ø¯</td></tr>';
    }

    window.printFormalSchedule = function() { 
        if(isPrinting) return;
        let cleanRows = '';
        Object.keys(stageMap).forEach(level => {
            const data = window.scheduleData[level] || { days: [], times: {} };
            const days = data.days || [];
            const times = data.times || {};
            if(days.length > 0) {
                const scheduleDetails = days.map(d => `<div style="display:flex; justify-content:space-between; border-bottom:1px dashed #ccc; padding:4px;"><span>${dayMap[d]}</span><span>${times[d] || '-'}</span></div>`).join('');
                cleanRows += `<tr><td style="vertical-align:middle; font-weight:bold; font-size:14pt;">${stageMap[level]}</td><td style="text-align:right; padding:10px;">${scheduleDetails}</td></tr>`;
            }
        });

        const content = `<table class="print-table"><thead><tr><th style="width: 30%;">Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</th><th>Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</th></tr></thead><tbody>${cleanRows || '<tr><td colspan="2">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆØ§Ø¹ÙŠØ¯</td></tr>'}</tbody></table>`;
        printHTML('Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø±Ø³Ù…ÙŠ', content);
    }

    window.pdfFormalSchedule = function() {
        let cleanRows = '';
        Object.keys(stageMap).forEach(level => {
            const data = window.scheduleData[level] || { days: [], times: {} };
            const days = data.days || [];
            const times = data.times || {};
            if(days.length > 0) {
                const scheduleDetails = days.map(d => `<div style="display:flex; justify-content:space-between; border-bottom:1px dashed #ccc; padding:4px;"><span>${dayMap[d]}</span><span>${times[d] || '-'}</span></div>`).join('');
                cleanRows += `<tr><td style="vertical-align:middle; font-weight:bold; font-size:14pt;">${stageMap[level]}</td><td style="text-align:right; padding:10px;">${scheduleDetails}</td></tr>`;
            }
        });
        const content = `<table class="print-table"><thead><tr><th style="width: 30%;">Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</th><th>Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</th></tr></thead><tbody>${cleanRows || '<tr><td colspan="2">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆØ§Ø¹ÙŠØ¯</td></tr>'}</tbody></table>`;
        savePDF('Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø±Ø³Ù…ÙŠ', content);
    }

    async function showTab(id, btn) { if(isScannerRunning) await stopScanner(); document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); if(btn) btn.classList.add('active'); localStorage.setItem('activeTab', id); if(id === 'attendance') window.renderFormalSchedule(); }

    async function registerStudent() { 
        const name = document.getElementById('stdName').value; 
        const level = document.getElementById('stdLevel').value; 
        let phone = document.getElementById('stdPhone').value; 
        if(!name || !level) return showToast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error'); 
        phone = phone.replace(/\D/g, ''); if(phone.startsWith('0')) phone = phone.substring(1); 

        let id; 
        do { id = Math.floor(1000 + Math.random() * 9000).toString(); } while (window.students.some(s => s.id === id)); 
        const password = Math.floor(100000 + Math.random() * 900000).toString(); 
        const createdAt = new Date().toISOString(); 

        try { 
            await window.createUserWithEmailAndPassword(window.auth, `${id}@smartcenter.app`, password);
            await window.addDoc(window.collection(window.db, "students"), { id, name, level, phone, date: today, password, createdAt }); 
            openStudentModal(id); 
            document.getElementById('stdName').value = ''; 
            document.getElementById('stdPhone').value = ''; 
            showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨', 'success'); 
        } catch (e) { 
            showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¬ÙˆØ¯', 'error'); 
        } 
    }

    window.renderStudents = function() {
        const query = normalizeArabic(document.getElementById('searchStd').value.toLowerCase());
        const filterStage = document.getElementById('studentListFilter').value;
        const tbody = document.getElementById('studentsTable');
        let filtered = window.students;
        if(filterStage !== 'all') { filtered = filtered.filter(s => s.level === filterStage); }
        if(query !== '') { filtered = filtered.filter(s => normalizeArabic(s.name.toLowerCase()).includes(query) || s.id.includes(query)); }
        filtered.sort((a, b) => { const dateA = a.createdAt ? new Date(a.createdAt) : new Date(a.date); const dateB = b.createdAt ? new Date(b.createdAt) : new Date(b.date); return dateB - dateA; });
        document.getElementById('stdCount').innerText = filtered.length;
        tbody.innerHTML = filtered.map((s, index) => `<tr class="cursor-pointer" onclick="openStudentModal('${s.id}')"><td class="col-index">${index + 1}</td><td class="col-code font-mono font-bold text-gray-900">${s.id}</td><td class="font-bold">${s.name}</td><td>${stageMap[s.level] || s.level}</td><td class="col-date text-gray-500">${s.date || '-'}</td><td class="no-print col-action" onclick="event.stopPropagation()"><button onclick="delStudent('${s.docId}', '${s.id}')" class="text-red-500 text-[10px] font-bold">Ø­Ø°Ù</button></td></tr>`).join('');
    }

    function openStudentModal(id) { 
        const s = window.students.find(st => st.id === id); if(!s) return; 
        currentModalStudentId = id; 

        // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…ÙˆØ­Ø¯Ø©
        const card = document.getElementById('studentCardDisplay');
        card.innerHTML = `
            <div class="unified-card-title">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</div>
            <div class="unified-card-name">${s.name}</div>
            <div id="modalQr" style="display:flex; justify-content:center; margin:10px 0;"></div>
            <div class="unified-card-row"><span>ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨:</span> <span>${s.id}</span></div>
            <div class="unified-card-row"><span>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:</span> <span>${s.password || '----'}</span></div>
            <div class="unified-card-row"><span>Ø§Ù„Ù…Ø±Ø­Ù„Ø©:</span> <span>${stageMap[s.level] || s.level}</span></div>
            <div class="unified-card-row"><span>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:</span> <span>${s.date}</span></div>
            <div class="unified-card-footer">Smart Center Pro</div>
        `;

        new QRCode(document.getElementById("modalQr"), { text: s.id, width: 100, height: 100 }); 
        document.getElementById('studentModal').classList.remove('hidden'); 
    }
    let html5QrCode = null; let isScannerRunning = false; let isPaused = false;
    window.changeAttendanceDate = function() { selectedAttendanceDate = document.getElementById('attendanceDate').value; window.updateCounters(); }
    window.confirmSessionDay = async function() {
        const date = document.getElementById('attendanceDate').value;
        const selectedLevel = document.getElementById('attendanceStage').value;
        if(!selectedLevel) { showToast('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹!', 'error'); return; }
        const sessionQuery = window.query(window.collection(window.db, "attendance"), window.where("studentId", "==", "SESSION_MARKER"), window.where("date", "==", date));
        const snapshot = await window.getDocs(sessionQuery);
        let newLevels = [];
        if (!snapshot.empty) { const docRef = snapshot.docs[0].ref; const currentData = snapshot.docs[0].data(); let currentLevels = currentData.levels || []; if (selectedLevel === 'all') { newLevels = ['all']; } else { if (currentLevels.includes('all')) currentLevels = []; if (!currentLevels.includes(selectedLevel)) currentLevels.push(selectedLevel); newLevels = currentLevels; } await window.updateDoc(docRef, { levels: newLevels }); } else { newLevels = selectedLevel === 'all' ? ['all'] : [selectedLevel]; await window.addDoc(window.collection(window.db, "attendance"), { date: date, studentId: "SESSION_MARKER", time: new Date().toLocaleTimeString('ar-EG'), levels: newLevels }); }
        showToast(`ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠ Ø¨Ù†Ø¬Ø§Ø­`, 'success'); window.updateCounters();
    }
    window.cancelSessionDay = async function() {
        const date = document.getElementById('attendanceDate').value;
        document.getElementById('exceptionalStatusIndicator').classList.add('hidden');
        window.attendance = window.attendance.filter(r => !(r.studentId === "SESSION_MARKER" && r.date === date));
        window.updateCounters();
        const sessionQuery = window.query(window.collection(window.db, "attendance"), window.where("studentId", "==", "SESSION_MARKER"), window.where("date", "==", date));
        const snapshot = await window.getDocs(sessionQuery);
        if (!snapshot.empty) { snapshot.forEach(async (doc) => { await window.deleteDoc(doc.ref); }); const attQuery = window.query(window.collection(window.db, "attendance"), window.where("date", "==", date)); const attSnapshot = await window.getDocs(attQuery); const dayName = new Date(date + "T12:00:00").toLocaleDateString('en-US', {weekday: 'long'}); attSnapshot.forEach(async (doc) => { const data = doc.data(); if (data.studentId === "SESSION_MARKER") return; const student = window.students.find(s => s.id === data.studentId); if (student) { const studentSchedule = window.scheduleData[student.level] || { days: [] }; if (!studentSchedule.days.includes(dayName)) { await window.deleteDoc(doc.ref); } } }); showToast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ«Ø¨ÙŠØª ÙˆØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³Ø¬Ù„Ø§Øª', 'success'); } else { showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ«Ø¨ÙŠØª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… Ù„Ø¥Ù„ØºØ§Ø¦Ù‡', 'warning'); }
    }
    window.repairSystemData = async function() { 
        if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØ¬Ù‡ÙŠØ² Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ.')) return; 
        showToast('Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...', 'success'); 
        window.students.forEach(async (s) => {
            if (!s.password) {
                const newPass = Math.floor(100000 + Math.random() * 900000).toString();
                await window.updateDoc(window.doc(window.db, "students", s.docId), { password: newPass });
            }
        });
        setTimeout(() => { showToast('ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù†Ø¸Ø§Ù…. Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø¯Ø®ÙˆÙ„Ù‡Ù….', 'success'); }, 2000); 
    }

    // --- ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ Ù„ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ---
    async function startScanner(elemId, mode) { 
        if(isScannerRunning && html5QrCode) {
            return;
        }

        html5QrCode = new Html5Qrcode(elemId); 
        
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­Ø³Ù†Ø© Ù„ØªØºØ·ÙŠØ© Ù…Ø³Ø§Ø­Ø© Ø£ÙƒØ¨Ø± (Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø¢ÙŠØ¨Ø§Ø¯)
        const qrboxFunction = function(viewfinderWidth, viewfinderHeight) {
            let minEdgePercentage = 0.85; // Ø§Ø³ØªØ®Ø¯Ø§Ù… 85% Ù…Ù† Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ø±Ø¶
            let minEdgeSize = Math.min(viewfinderWidth, viewfinderHeight);
            let qrboxSize = Math.floor(minEdgeSize * minEdgePercentage);
            return {
                width: qrboxSize,
                height: qrboxSize
            };
        };

        const config = { 
            fps: 20, 
            qrbox: qrboxFunction, 
            aspectRatio: 1.0, 
            disableFlip: false,
            focusMode: "continuous" 
        };

        try {
            await html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => { 
                if(isPaused) return; 
                isPaused = true;
                
                if(mode === 'attendance') handleAttendanceScan(decodedText); 
                else if(mode === 'payment') handlePaymentScan(decodedText); 
                else if(mode === 'check') handleCheckScan(decodedText);
                
                if(mode !== 'check' && mode !== 'payment') {
                     setTimeout(() => { isPaused = false; }, 1500);
                }
            }); 
            isScannerRunning = true; 
        } catch (err) { 
            console.error(err);
            showToast("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§", "error"); 
        }
    }

    async function stopScanner() { 
        if(html5QrCode) { 
            try {
                await html5QrCode.stop(); 
                html5QrCode.clear(); 
            } catch(e) { console.log(e); }
            html5QrCode = null; 
            isScannerRunning = false; 
        } 
    }

    // --- Ù…Ù†Ø·Ù‚ ÙØ­Øµ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ---
    window.startCheckScanner = function() {
        document.getElementById('checkReader').classList.remove('hidden');
        document.getElementById('btnStartCheck').classList.add('hidden');
        document.getElementById('btnStopCheck').classList.remove('hidden');
        startScanner('checkReader', 'check');
    }
    window.stopCheckScanner = function() {
        stopScanner();
        document.getElementById('checkReader').classList.add('hidden');
        document.getElementById('btnStartCheck').classList.remove('hidden');
        document.getElementById('btnStopCheck').classList.add('hidden');
    }
    function handleCheckScan(id) {
        isPaused = true;
        const student = window.students.find(s => s.id === id);
        if(student) {
            document.getElementById('checkResName').innerText = student.name;
            document.getElementById('checkResCode').innerText = student.id;
            document.getElementById('checkResPhone').innerText = student.phone;
            document.getElementById('checkResDate').innerText = student.date;
            document.getElementById('checkResLoginCode').innerText = student.id;
            document.getElementById('checkResPass').innerText = student.password || '----';

            document.getElementById('checkResultQr').innerHTML = '';
            new QRCode(document.getElementById("checkResultQr"), { text: student.id, width: 120, height: 120 });

            document.getElementById('checkResultModal').classList.remove('hidden');
            playSound('success');
        } else {
            showToast('Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
            setTimeout(() => { isPaused = false; }, 2000);
        }
    }
    window.closeModal = function(id) {
        document.getElementById(id).classList.add('hidden');
        if(id === 'checkResultModal') {
            isPaused = false; 
        }
    }

    function showCustomAlert(title, message) { document.getElementById('alertTitle').innerText = title; document.getElementById('alertMessage').innerText = message; document.getElementById('customAlertModal').style.display = 'flex'; playSound('error'); }
    window.closeCustomAlert = function() { document.getElementById('customAlertModal').style.display = 'none'; isPaused = false; }

    async function handleAttendanceScan(id) {
        isPaused = true;
        const date = selectedAttendanceDate;
        if (date > today) { showCustomAlert("ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­", "Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù…ÙˆØ¹Ø¯ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„."); return; }
        const student = window.students.find(s => s.id === id);
        if(student) {
            const selectedLevel = document.getElementById('attendanceStage').value;
            const statusObj = getStudentStatusForDate(student, date);
            if (statusObj.status === 'present') { showToast('Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹', 'warning'); playSound('error'); setTimeout(() => { isPaused = false; }, 2000); return; }
            const dateObj = new Date(date + "T12:00:00");
            const dayName = dateObj.toLocaleDateString('en-US', {weekday: 'long'});
            const studentSchedule = window.scheduleData[student.level] || { days: [] };
            const isScheduled = (studentSchedule.days || []).includes(dayName);
            const sessionRec = window.attendance.find(r => r.studentId === "SESSION_MARKER" && r.date === date);
            const isExceptional = sessionRec && (!sessionRec.levels || sessionRec.levels.includes('all') || sessionRec.levels.includes(student.level));
            if (!isScheduled && !isExceptional) { showCustomAlert("ÙŠÙˆÙ… Ø®Ø§Ø·Ø¦", `Ù‡Ø°Ø§ Ù„ÙŠØ³ ÙŠÙˆÙ… Ø­Ø¶ÙˆØ± Ø§Ù„Ø·Ø§Ù„Ø¨ (${student.name}) ÙˆÙ„Ù… ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ ØªØ«Ø¨ÙŠØª Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠ!`); return; }
            if(selectedLevel !== 'all' && selectedLevel && student.level !== selectedLevel && !isExceptional) { if(!confirm(`ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ø³Ø¬Ù„ ÙÙŠ ${stageMap[student.level]} ÙˆØ£Ù†Øª ØªØ³Ø¬Ù„ Ù„Ù€ ${stageMap[selectedLevel]}. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±ØŸ`)) { isPaused = false; return; } }
            await window.addDoc(window.collection(window.db, "attendance"), { date: date, studentId: id, time: new Date().toLocaleTimeString('ar-EG') }); showScanFeedback(true); playSound('success');
        } else { showToast('ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­', 'error'); playSound('error'); }
        setTimeout(() => { isPaused = false; showScanFeedback(false); }, 2000);
    }
    function showScanFeedback(show) { const el = document.getElementById('scanFeedback'); if(show) el.classList.remove('hidden'); else el.classList.add('hidden'); }
    function setAttMode(mode) { stopScanner().then(() => { const btnScan = document.getElementById('btnAttScan'); const btnManual = document.getElementById('btnAttManual'); if(mode === 'scan') { document.getElementById('attScanArea').classList.remove('hidden'); document.getElementById('attManualArea').classList.add('hidden'); btnScan.classList.add('active'); btnManual.classList.remove('active'); } else { document.getElementById('attScanArea').classList.add('hidden'); document.getElementById('attManualArea').classList.remove('hidden'); btnManual.classList.add('active'); btnScan.classList.remove('active'); } }); }
    function manualAttendance() { const id = document.getElementById('manualAttID').value; handleAttendanceScan(id); document.getElementById('manualAttID').value = ''; }
    let currentAttType = 'present';
    function openAttendanceModal(type) { currentAttType = type; const title = type === 'present' ? `Ø­Ø¶ÙˆØ± (${selectedAttendanceDate})` : `ØºÙŠØ§Ø¨ (${selectedAttendanceDate})`; document.getElementById('detailsTitle').innerText = title; const mainStage = document.getElementById('attendanceStage').value; const filterDropdown = document.getElementById('attFilterLevel'); if(mainStage) filterDropdown.value = mainStage; else filterDropdown.value = 'all'; document.getElementById('modalFilterContainer').classList.remove('hidden'); const thead = document.getElementById('detailsTableHead'); thead.innerHTML = `<tr><th class="col-index">Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>${type === 'present' ? 'ÙˆÙ‚Øª' : 'ØªØ§Ø±ÙŠØ®'}</th></tr>`; document.getElementById('detailsModal').classList.remove('hidden'); filterAttendanceList(); }
    function filterAttendanceList() {
        const levelFilter = document.getElementById('attFilterLevel').value;
        const tbody = document.getElementById('detailsTableBody');
        let targetStudents = window.students.filter(s => s.date <= selectedAttendanceDate);
        if(levelFilter !== 'all') targetStudents = targetStudents.filter(s => s.level === levelFilter);
        let list = [];
        targetStudents.forEach(student => { const statusObj = getStudentStatusForDate(student, selectedAttendanceDate); if (currentAttType === 'present' && statusObj.status === 'present') { list.push({ ...student, time: statusObj.time }); } else if (currentAttType === 'absent' && statusObj.status === 'absent') { list.push({ ...student, time: selectedAttendanceDate }); } });
        if(list.length === 0) tbody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
        else tbody.innerHTML = list.map((s, index) => `<tr class="cursor-pointer hover:bg-blue-50" onclick="openStudentModal('${s.id}')"><td class="col-index">${index + 1}</td><td class="font-bold">${s.name}</td><td class="font-mono text-blue-600">${s.id}</td><td>${stageMap[s.level] || s.level}</td><td class="${currentAttType === 'present' ? 'text-green-600' : 'text-red-600'}">${s.time}</td></tr>`).join(''); }
    window.updateCounters = function() {
        const selectedLevel = document.getElementById('attendanceStage').value;
        const date = selectedAttendanceDate;
        const sessionRec = window.attendance.find(r => r.studentId === "SESSION_MARKER" && r.date === date);
        const indicator = document.getElementById('exceptionalStatusIndicator');
        const levelNameSpan = document.getElementById('exceptionalLevelName');
        if (sessionRec) { let levelsText = ""; if (sessionRec.levels.includes('all')) levelsText = "Ø§Ù„ÙƒÙ„"; else levelsText = sessionRec.levels.map(l => stageMap[l]).join('ØŒ '); levelNameSpan.innerText = levelsText; indicator.classList.remove('hidden'); } else { indicator.classList.add('hidden'); }
        let targetStudents = window.students.filter(s => s.date <= date);
        if(selectedLevel !== 'all') targetStudents = targetStudents.filter(s => s.level === selectedLevel);
        let presentCount = 0; let absentCount = 0;
        targetStudents.forEach(student => { const statusObj = getStudentStatusForDate(student, date); if (statusObj.status === 'present') presentCount++; else if (statusObj.status === 'absent') absentCount++; });
        document.getElementById('presentCount').innerText = presentCount;
        document.getElementById('absentCount').innerText = absentCount;
    }
    function generateStudentReport() {
        const query = normalizeArabic(document.getElementById('reportStudentSearch').value.toLowerCase());
        const stage = document.getElementById('searchStage').value;
        let matches = window.students.filter(s => { const nameMatch = normalizeArabic(s.name.toLowerCase()).includes(query); const idMatch = s.id.includes(query); const stageMatch = stage === 'all' || s.level === stage; return (nameMatch || idMatch) && stageMatch; });
        const resDiv = document.getElementById('studentReportResult');
        if(matches.length === 0) { resDiv.innerHTML = '<p class="text-red-500 text-center font-bold">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬</p>'; resDiv.classList.remove('hidden'); return; }
        if(matches.length > 1) { let listHtml = `<div class="text-xs font-bold text-gray-900 mb-2">ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${matches.length} Ø·Ø§Ù„Ø¨:</div><div class="max-h-40 overflow-y-auto border rounded">`; matches.forEach(s => { listHtml += `<div onclick="showSingleReport('${s.id}')" class="p-2 border-b hover:bg-gray-50 cursor-pointer flex justify-between"><span>${s.name}</span><span class="text-gray-500 font-mono">${s.id} (${stageMap[s.level] || s.level})</span></div>`; }); listHtml += `</div>`; resDiv.innerHTML = listHtml; resDiv.classList.remove('hidden'); } else { showSingleReport(matches[0].id); }
    }

    window.showSingleReport = function(studentId) {
        const student = window.students.find(s => s.id === studentId);
        const resDiv = document.getElementById('studentReportResult');
        currentParentPhone = student.phone;
        const stats = calculateStudentStats(student);
        const exceptionalPresent = stats.history.filter(h => h.status === 'present' && h.isExceptional);
        const regularAbsence = stats.history.filter(h => h.status === 'absent');
        const payments = window.accounting.filter(r => r.category === 'revenue' && r.stdId === student.id);
        const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
        const absenceList = regularAbsence.map(h => `${h.date} ${h.isExceptional ? '(Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠ)' : ''}`).join('\n') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
        const presentList = exceptionalPresent.map(h => `${h.date} (Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠ)`).join('\n') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
        const paymentDetails = payments.map(p => `ğŸ’° ${p.amount} Ø¬.Ù… (${p.type}) - ${p.date}`).join('\n') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¯ÙÙˆØ¹Ø§Øª';
        currentStudentReport = `*ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø§Ù„Ø¨: ${student.name}*\nÙƒÙˆØ¯: ${student.id}\nØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: ${student.date}\n----------------\nâœ… Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±: ${stats.present}\nâŒ Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨: ${stats.absent}\nğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª: ${totalPaid} Ø¬.Ù…\n----------------\n*ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª:*\n${paymentDetails}\n\n*ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„ØºÙŠØ§Ø¨:*\n${absenceList}\n\n*ğŸŒŸ Ø­Ø¶ÙˆØ± Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠ:*\n${presentList}`;
        resDiv.innerHTML = `<div class="border-b pb-2 mb-2"><h4 class="font-bold text-lg text-gray-900">${student.name}</h4><p class="text-gray-500 text-xs">ÙƒÙˆØ¯: ${student.id} | ${stageMap[student.level]}</p></div><div class="grid grid-cols-2 gap-2 mb-4 text-center"><div class="bg-green-100 p-2 rounded"><div class="text-xs">Ø­Ø¶ÙˆØ±</div><div class="font-bold text-green-700">${stats.present}</div></div><div class="bg-red-100 p-2 rounded"><div class="text-xs">ØºÙŠØ§Ø¨</div><div class="font-bold text-red-700">${stats.absent}</div></div></div><div class="grid grid-cols-2 gap-2 mb-4"><div class="border rounded p-1"><h5 class="font-bold text-[10px] text-red-700 mb-1 border-b">Ø³Ø¬Ù„ Ø§Ù„ØºÙŠØ§Ø¨</h5><div class="max-h-24 overflow-y-auto text-[9px] text-red-600">${regularAbsence.map(h=>`<div>${h.date} (${h.day}) ${h.isExceptional ? '<span class="font-bold text-black">(Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠ)</span>' : ''}</div>`).join('') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</div></div><div class="border rounded p-1"><h5 class="font-bold text-[10px] text-black mb-1 border-b">Ø­Ø¶ÙˆØ± Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠ</h5><div class="max-h-24 overflow-y-auto text-[9px] text-black font-bold">${exceptionalPresent.map(h=>`<div>${h.date} (${h.day}) (Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠ)</div>`).join('') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</div></div></div><div class="mb-4"><h5 class="font-bold text-xs mb-1">Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª (${totalPaid} Ø¬.Ù…)</h5><div class="max-h-32 overflow-y-auto text-xs border rounded p-1">${payments.length ? payments.map(p => `<div class="flex justify-between border-b p-1"><span>${p.type}</span><span>${p.amount} (${p.date})</span></div>`).join('') : '<p class="text-center">Ù„Ø§ ÙŠÙˆØ¬Ø¯</p>'}</div></div><div class="flex gap-2"><button onclick="shareStudentReport()" class="flex-1 bg-green-700 text-white py-1.5 rounded text-xs font-bold flex items-center justify-center gap-2"><span>ğŸ“±</span> ÙˆØ§ØªØ³Ø§Ø¨</button><button onclick="pdfStudentDashboard()" class="flex-1 bg-red-700 text-white py-1.5 rounded text-xs font-bold flex items-center justify-center gap-2"><span>ğŸ“„</span> PDF</button><button onclick="printDetailedStudentReport('${student.id}')" class="flex-1 bg-gray-800 text-white py-1.5 rounded text-xs font-bold flex items-center justify-center gap-2"><span>ğŸ–¨ï¸</span> Ø·Ø¨Ø§Ø¹Ø©</button></div>`;
        resDiv.classList.remove('hidden');
    }

    window.printDetailedStudentReport = async function(studentId) {
        if(isPrinting) return;
        const s = window.students.find(st => st.id === studentId); if(!s) return;
        showToast('Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØªÙ‚Ø±ÙŠØ±...', 'success');
        const qrImageHtml = await generateQRHtml(s.id);
        const stats = calculateStudentStats(s);
        const payments = window.accounting.filter(r => r.category === 'revenue' && r.stdId === s.id);
        const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);

        const content = `
            <div class="print-student-card">
                <div class="print-card-title">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</div>
                <div class="print-card-name">${s.name}</div>
                <div style="display:flex; justify-content:center; margin:10px 0;">${qrImageHtml}</div>
                <div class="print-card-row"><span>ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨:</span> <span>${s.id}</span></div>
                <div class="print-card-row"><span>Ø§Ù„Ù…Ø±Ø­Ù„Ø©:</span> <span>${stageMap[s.level] || s.level}</span></div>
                <div class="print-card-row"><span>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…:</span> <span>${s.date}</span></div>
                <div class="print-card-footer">Smart Center Pro</div>
            </div>
            
            <table class="print-stats-table">
                <tr>
                    <td class="print-stats-cell"><div class="print-box-title">Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</div><div class="print-box-val">${stats.present}</div></td>
                    <td class="print-stats-cell"><div class="print-box-title">Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨</div><div class="print-box-val">${stats.absent}</div></td>
                    <td class="print-stats-cell"><div class="print-box-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</div><div class="print-box-val">${totalPaid} Ø¬.Ù…</div></td>
                </tr>
            </table>
            
            <h3 style="border-bottom: 2px solid #000; margin-top: 15px;">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</h3>
            <table class="print-table"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead><tbody>${payments.map(p => `<tr><td>${p.date}</td><td>${p.type}</td><td>${p.amount}</td></tr>`).join('') || '<tr><td colspan="3">Ù„Ø§ ÙŠÙˆØ¬Ø¯</td></tr>'}</tbody></table>
            
            <h3 style="border-bottom: 2px solid #000; margin-top: 15px;">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</h3>
            <table class="print-table"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙŠÙˆÙ…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead><tbody>${stats.history.map(h => `<tr><td>${h.date}</td><td>${h.day}</td><td>${h.status==='present'?'Ø­Ø¶ÙˆØ±':'ØºÙŠØ§Ø¨'}</td><td>${h.isExceptional?'Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠ':''}</td></tr>`).join('')}</tbody></table>
        `;

        printHTML('ØªÙ‚Ø±ÙŠØ± Ø·Ø§Ù„Ø¨ ØªÙØµÙŠÙ„ÙŠ', content);
    }

    // --- Ø¥ØµÙ„Ø§Ø­ Ù…Ù†Ø·Ù‚ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¹Ø§Ù…Ø© (ÙŠÙˆÙ…ÙŠ / Ø´Ù‡Ø±ÙŠ) ---
    function generateAdvancedReport() {
        const type = document.getElementById('reportType').value;
        const stage = document.getElementById('reportStage').value;
        const dateInput = document.getElementById('reportDate').value;
        const monthInput = document.getElementById('reportMonth').value;
        const category = document.getElementById('reportCategory').value;
        const resDiv = document.getElementById('reportResult');

        let totalRev = 0, totalExp = 0;
        // ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        currentReportData = { present: [], absent: [], revenues: [], expenses: [] };

        let targetStudents = window.students;
        if(stage !== 'all') targetStudents = window.students.filter(s => s.level === stage);

        if(type === 'daily') {
            if(!dateInput) return showToast('Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®', 'error');
            targetStudents = targetStudents.filter(s => s.date <= dateInput);
            targetStudents.forEach(student => {
                const statusObj = getStudentStatusForDate(student, dateInput);
                if (statusObj.status === 'present') { currentReportData.present.push({ ...student, time: statusObj.time }); }
                else if (statusObj.status === 'absent') { currentReportData.absent.push({ ...student, time: 'ØºÙŠØ§Ø¨' }); }
            });
            currentReportData.revenues = window.accounting.filter(r => r.category === 'revenue' && r.date === dateInput);
            currentReportData.expenses = window.accounting.filter(e => e.category === 'expense' && e.date === dateInput);
        } else {
            // Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø´Ù‡Ø±ÙŠ
            if(!monthInput) return showToast('Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±', 'error');
            const [year, month] = monthInput.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();
            const daysArray = [];
            for(let i=1; i<=daysInMonth; i++) {
                const d = String(i).padStart(2, '0');
                const m = String(month).padStart(2, '0');
                daysArray.push(`${year}-${m}-${d}`);
            }

            let monthlyStats = {};
            targetStudents.forEach(s => { monthlyStats[s.id] = { name: s.name, level: s.level, present: 0, absentDates: [], exceptionalDates: [] }; });

            targetStudents.forEach(student => {
                daysArray.forEach(dateStr => {
                    if (dateStr < student.date) return; // ØªØ®Ø·ÙŠ Ø§Ù„Ø£ÙŠØ§Ù… Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
                    const statusObj = getStudentStatusForDate(student, dateStr);
                    if (statusObj.status === 'present') {
                        monthlyStats[student.id].present++;
                        if (statusObj.isExceptional) { monthlyStats[student.id].exceptionalDates.push(dateStr); }
                    } else if (statusObj.status === 'absent') { 
                        let dateDisplay = dateStr;
                        if (statusObj.isExceptional) dateDisplay += ' (Ø«)';
                        monthlyStats[student.id].absentDates.push(dateDisplay); 
                    }
                });
            });

            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© Ù„Ù„Ø¹Ø±Ø¶
            currentReportData.present = Object.values(monthlyStats).filter(s => s.present > 0).map(s => ({ ...s, time: `${s.present} ÙŠÙˆÙ…`, exceptionalDates: s.exceptionalDates }));
            currentReportData.absent = Object.values(monthlyStats).filter(s => s.absentDates.length > 0).map(s => ({ ...s, time: `${s.absentDates.length} ÙŠÙˆÙ…`, absentDatesList: s.absentDates }));

            // ØªØµÙÙŠØ© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
            currentReportData.revenues = window.accounting.filter(r => r.category === 'revenue' && r.date.startsWith(monthInput));
            currentReportData.expenses = window.accounting.filter(e => e.category === 'expense' && e.date.startsWith(monthInput));
        }

        totalRev = currentReportData.revenues.reduce((a,b)=>a+b.amount,0);
        totalExp = currentReportData.expenses.reduce((a,b)=>a+b.amount,0);

        let html = `<h4 class="font-bold text-center border-b pb-2 mb-2">ØªÙ‚Ø±ÙŠØ± ${type === 'daily' ? dateInput : monthInput}</h4>`;

        if (category === 'attendance') {
            html += `<div class="grid grid-cols-2 gap-2 mb-4 text-center"><div onclick='openReportDetails("present")' class="bg-green-100 p-2 rounded cursor-pointer hover:bg-green-200"><div class="text-xs">Ø­Ø¶ÙˆØ±</div><div class="font-bold text-green-700">${currentReportData.present.length} Ø·Ø§Ù„Ø¨</div></div><div onclick='openReportDetails("absent")' class="bg-red-100 p-2 rounded cursor-pointer hover:bg-red-200"><div class="text-xs">ØºÙŠØ§Ø¨</div><div class="font-bold text-red-700">${currentReportData.absent.length} Ø·Ø§Ù„Ø¨</div></div></div>`;
        } else {
            html += `<div class="space-y-2"><div onclick='openReportDetails("revenues")' class="bg-green-50 p-2 rounded border border-green-200 cursor-pointer hover:bg-green-100 flex justify-between"><span class="text-xs text-gray-500">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</span><span class="font-bold text-green-700">${totalRev} Ø¬.Ù…</span></div><div onclick='openReportDetails("expenses")' class="bg-red-50 p-2 rounded border border-red-200 cursor-pointer hover:bg-red-100 flex justify-between"><span class="text-xs text-gray-500">Ù…ØµØ±ÙˆÙØ§Øª</span><span class="font-bold text-red-700">${totalExp} Ø¬.Ù…</span></div><div class="bg-gray-800 p-3 rounded shadow-lg text-center"><span class="text-xs text-gray-300">Ø§Ù„ØµØ§ÙÙŠ</span><span class="font-bold text-white text-xl block">${totalRev - totalExp} Ø¬.Ù…</span></div></div>`;
        }

        resDiv.innerHTML = html; resDiv.classList.remove('hidden');
    }

    window.toggleReportView = function() {
        if (!document.getElementById('reportResult').classList.contains('hidden')) {
            generateAdvancedReport();
        }
    }

    function toggleBulkInputs() { const type = document.getElementById('bulkType').value; if(type === 'daily') { document.getElementById('bulkDateDiv').classList.remove('hidden'); document.getElementById('bulkMonthDiv').classList.add('hidden'); } else { document.getElementById('bulkDateDiv').classList.add('hidden'); document.getElementById('bulkMonthDiv').classList.remove('hidden'); } }
    function getBulkStudents() { const stage = document.getElementById('bulkStage').value; let students = window.students; if(stage !== 'all') students = students.filter(s => s.level === stage); return students; }
    function exportBulkExcel() {
        const students = getBulkStudents(); const type = document.getElementById('bulkType').value; const dateVal = type === 'daily' ? document.getElementById('bulkDate').value : document.getElementById('bulkMonth').value; if(!dateVal) return showToast('Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®', 'error');
        let csvContent = "\uFEFF";
        if (type === 'daily') {
            csvContent += "Ø§Ù„ÙƒÙˆØ¯,Ø§Ù„Ø§Ø³Ù…,Ø§Ù„Ù…Ø±Ø­Ù„Ø©,Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ,Ø­Ø§Ù„Ø© Ø§Ù„ÙŠÙˆÙ…,ÙˆÙ‚Øª Ø§Ù„Ø­Ø¶ÙˆØ±,ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª\n";
            students.forEach(s => { const statusObj = getStudentStatusForDate(s, dateVal); let statusText = "ØºÙŠØ§Ø¨"; let timeText = "-"; if (statusObj.status === 'present') { statusText = statusObj.isExceptional ? "Ø­Ø¶ÙˆØ± (Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠ)" : "Ø­Ø¶ÙˆØ±"; timeText = statusObj.time; } else if (statusObj.status === 'none') { statusText = "Ù„ÙŠØ³ ÙŠÙˆÙ…Ù‡"; } const payments = window.accounting.filter(r => r.category === 'revenue' && r.stdId === s.id); const payDetails = payments.map(p => `${p.amount} (${p.type})`).join(' | '); csvContent += `${s.id},"${s.name}",${stageMap[s.level] || s.level}','${s.phone},${statusText},${timeText},"${payDetails}"\n`; });
        } else {
            csvContent += "Ø§Ù„ÙƒÙˆØ¯,Ø§Ù„Ø§Ø³Ù…,Ø§Ù„Ù…Ø±Ø­Ù„Ø©,Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ,Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±,Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨,Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª,ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª,ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠ,ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠ\n";
            students.forEach(s => { const stats = calculateStudentStats(s); const payments = window.accounting.filter(r => r.category === 'revenue' && r.stdId === s.id); const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0); const payDetails = payments.map(p => `${p.amount} (${p.type})`).join(' | '); const excPresent = stats.history.filter(h => h.status === 'present' && h.isExceptional).map(h => h.date).join(' | '); const excAbsent = stats.history.filter(h => h.status === 'absent' && h.isExceptional).map(h => h.date).join(' | '); csvContent += `${s.id},"${s.name}",${stageMap[s.level] || s.level}','${s.phone},${stats.present},${stats.absent},${totalPaid},"${payDetails}","${excPresent}","${excAbsent}"\n`; });
        }
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.setAttribute("href", url); link.setAttribute("download", `ØªÙ‚Ø±ÙŠØ±_Ø´Ø§Ù…Ù„_${dateVal}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }

    let bulkQueue = [];
    function openBulkWhatsAppModal() {
        const students = getBulkStudents(); if(students.length === 0) return showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨', 'error');
        bulkQueue = students;
        const container = document.getElementById('bulkListContainer');
        container.innerHTML = `<table class="w-full text-[10px] border-collapse">${students.map((s, i) => `<tr class="border-b hover:bg-gray-100" id="bulk-row-${i}"><td class="p-1 text-center w-8 font-bold text-gray-500">${i+1}</td><td class="p-1 font-bold">${s.name}</td><td class="p-1 text-center w-16"><button onclick="sendSingleWhatsApp(${i})" class="bg-green-700 text-white px-2 py-1 rounded shadow hover:bg-green-800 transition">Ø¥Ø±Ø³Ø§Ù„</button></td></tr>`).join('')}</table>`;
        document.getElementById('bulkWhatsAppModal').classList.remove('hidden');
    }
    window.sendSingleWhatsApp = function(index) {
        const student = bulkQueue[index]; const bulkType = document.getElementById('bulkType').value; let msg = "";
        if (bulkType === 'daily') {
            const dateVal = document.getElementById('bulkDate').value; const statusObj = getStudentStatusForDate(student, dateVal); let statusText = "ØºÙŠØ§Ø¨"; if (statusObj.status === 'present') statusText = "Ø­Ø¶ÙˆØ±";
            const payments = window.accounting.filter(r => r.category === 'revenue' && r.stdId === student.id && r.date === dateVal); let payText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯"; if (payments.length > 0) { payText = payments.map(p => `${p.amount} Ø¬.Ù… (${p.type})`).join(' + '); }
            msg = `*ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ: ${dateVal}*\nØ§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨: ${student.name}\nÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨: ${student.id}\nØ­Ø§Ù„Ø© Ø§Ù„ÙŠÙˆÙ…: ${statusText}\nØ§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª: ${payText}`;
        } else {
            const monthVal = document.getElementById('bulkMonth').value; const stats = calculateStudentStats(student);
            const monthPresent = stats.history.filter(h => h.date.startsWith(monthVal) && h.status === 'present').length;
            const monthAbsent = stats.history.filter(h => h.date.startsWith(monthVal) && h.status === 'absent').length;
            const payments = window.accounting.filter(r => r.category === 'revenue' && r.stdId === student.id && r.date.startsWith(monthVal));
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);

            const excPresentDates = stats.history.filter(h => h.date.startsWith(monthVal) && h.status === 'present' && h.isExceptional).map(h => h.date).join(', ') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
            const excAbsentDates = stats.history.filter(h => h.date.startsWith(monthVal) && h.status === 'absent' && h.isExceptional).map(h => h.date).join(', ') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
            const payDetails = payments.map(p => `${p.amount} Ø¬.Ù… (${p.type}) - ${p.date}`).join('\n') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';

            msg = `*ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±: ${monthVal}*\nØ§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨: ${student.name}\nÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨: ${student.id}\nØªØ§Ø±ÙŠØ® Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø·Ø§Ù„Ø¨: ${student.date}\n----------------\nØ¹Ø¯Ø¯ Ø§ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ: ${monthPresent}\nØ¹Ø¯Ø¯ Ø§ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ: ${monthAbsent}\nØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠ: ${excPresentDates}\nØªÙˆØ§Ø±ÙŠØ® Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠ: ${excAbsentDates}\n----------------\nØ§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª: ${totalPaid} Ø¬.Ù…\nØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª:\n${payDetails}`;
        }
        const url = `https://wa.me/20${student.phone}?text=${encodeURIComponent(msg)}`;
        window.open(url, '_blank');
        const row = document.getElementById(`bulk-row-${index}`); row.classList.add('bg-green-100'); const btn = row.querySelector('button'); btn.innerText = 'ØªÙ… âœ…'; btn.className = 'bg-gray-400 text-white px-2 py-1 rounded cursor-not-allowed'; btn.disabled = true;
        if(index + 1 < bulkQueue.length) { document.getElementById('bulkProgress').innerHTML = `Ø§Ù„ØªØ§Ù„ÙŠ: <button onclick="sendSingleWhatsApp(${index+1})" class="text-blue-600 underline font-bold">${bulkQueue[index+1].name}</button>`; } else { document.getElementById('bulkProgress').innerText = "ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©!"; }
    }

    window.openScheduleModal = function() {
        const container = document.getElementById('scheduleContainer'); container.innerHTML = '';
        Object.keys(stageMap).forEach(level => { 
            const data = window.scheduleData[level] || { days: [], times: {} };
            const savedDays = data.days || [];
            const savedTimes = data.times || {};

            let daysHtml = daysOfWeek.map(day => `
                <div class="flex items-center justify-between mb-2 border-b pb-2">
                    <label class="inline-flex items-center flex-1">
                        <input type="checkbox" class="form-checkbox h-4 w-4 text-gray-800" name="schedule_${level}" value="${day.id}" ${savedDays.includes(day.id) ? 'checked' : ''}>
                        <span class="mr-2 text-sm font-bold">${day.name}</span>
                    </label>
                    <input type="text" placeholder="Ù…Ø«Ø§Ù„: 2:00 Ù…" class="p-1 border rounded text-xs w-24 text-center" name="time_${level}_${day.id}" value="${savedTimes[day.id] || ''}">
                </div>
            `).join(''); 
            container.innerHTML += `<div class="bg-gray-50 p-3 rounded border mb-2"><div class="flex justify-between items-center mb-2"><h4 class="font-bold text-sm text-gray-900">${stageMap[level]}</h4></div><div>${daysHtml}</div></div>`; 
        });
        document.getElementById('scheduleModal').classList.remove('hidden');
    }

    window.saveSchedule = async function() {
        const newSchedule = {}; 
        Object.keys(stageMap).forEach(level => { 
            const checkboxes = document.querySelectorAll(`input[name="schedule_${level}"]:checked`); 
            const days = Array.from(checkboxes).map(cb => cb.value);
            const times = {};
            days.forEach(day => {
                const timeVal = document.querySelector(`input[name="time_${level}_${day}"]`).value;
                if(timeVal) times[day] = timeVal;
            });

            if(days.length > 0) newSchedule[level] = { days, times }; 
        });
        try { await window.setDoc(window.doc(window.db, "settings", "schedule"), newSchedule); window.scheduleData = newSchedule; closeModal('scheduleModal'); showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success'); window.renderFormalSchedule(); window.updateCounters(); } catch(e) { showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸', 'error'); }
    }
    window.openMonthlySchedule = function(level) { currentScheduleLevel = level; document.getElementById('msStageName').innerText = `Ø¬Ø¯ÙˆÙ„: ${stageMap[level]}`; renderMonthlySchedule(); document.getElementById('monthlyScheduleModal').classList.remove('hidden'); }
    window.renderMonthlySchedule = function() {
        if(!currentScheduleLevel) return;
        const monthInput = document.getElementById('msMonthInput').value; const [year, month] = monthInput.split('-').map(Number);
        const targetDays = window.scheduleData[currentScheduleLevel] || []; const listDiv = document.getElementById('msDatesList');
        if(targetDays.length === 0) { listDiv.innerHTML = '<p class="text-center text-gray-500">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠØ§Ù… Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø©</p>'; return; }
        const daysInMonth = new Date(year, month, 0).getDate();
        let dates = [];
        for(let i=1; i<=daysInMonth; i++) {
            const d = new Date(year, month - 1, i, 12, 0, 0);
            let dayName = d.toLocaleDateString('en-US', {weekday: 'long'});
            if (targetDays.days.includes(dayName)) {
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                dates.push({ date: `${y}-${m}-${day}`, dayAr: d.toLocaleDateString('ar-EG', {weekday: 'long'}) });
            }
        }
        listDiv.innerHTML = dates.map(d => `<div class="flex justify-between border-b border-gray-200 pb-1 last:border-0 agenda-row"><span class="font-bold text-gray-900">${d.dayAr}</span><span class="font-mono text-gray-600">${d.date}</span></div>`).join('');
    }
    window.printMonthlySchedule = function() { 
        if(isPrinting) return;
        const content = document.getElementById('monthlyScheduleCard').innerHTML; 
        printHTML('Ø£Ø¬Ù†Ø¯Ø© Ø§Ù„Ø´Ù‡Ø±', content);
    }
    window.pdfMonthlySchedule = function() { const element = document.getElementById('monthlyScheduleCard'); const opt = { margin: 10, filename: `Ø¬Ø¯ÙˆÙ„_${stageMap[currentScheduleLevel]}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a6', orientation: 'portrait' } }; html2pdf().set(opt).from(element).save(); }
    let currentPayStudent = null;
    function togglePayMethod(method) { const btnScan = document.getElementById('btnPayScan'); const btnManual = document.getElementById('btnPayManual'); if(method === 'scan') { document.getElementById('payScanDiv').classList.remove('hidden'); document.getElementById('payManualDiv').classList.add('hidden'); btnScan.classList.add('active'); btnManual.classList.remove('active'); } else { document.getElementById('payScanDiv').classList.add('hidden'); document.getElementById('payManualDiv').classList.remove('hidden'); btnManual.classList.add('active'); btnScan.classList.remove('active'); stopScanner(); } }

    function handlePaymentScan(id) { 
        if(!document.getElementById('paymentForm').classList.contains('hidden')) return; 
        const student = window.students.find(s => s.id === id); 
        if(student) { 
            currentPayStudent = student;
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¯ÙØ¹ (Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†)
            const lastPay = window.accounting
                .filter(a => a.stdId === id && a.date === today && a.category === 'revenue')
                .sort((a,b) => b.timestamp - a.timestamp)[0];

            if (lastPay && (Date.now() - (lastPay.timestamp || 0)) < 120000) { // 120000ms = 2 minutes
                document.getElementById('payConfirmMsg').innerText = `ØªÙ†Ø¨ÙŠÙ‡: ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ù†Ø° Ø£Ù‚Ù„ Ù…Ù† Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ† (${lastPay.amount} Ø¬.Ù…). Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`;
                document.getElementById('paymentConfirmModal').style.display = 'flex';
                isPaused = true;
                return;
            }
            showPaymentForm();
        } else { 
            showToast('Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error'); 
        } 
    }

    window.proceedWithPayment = function() {
        document.getElementById('paymentConfirmModal').style.display = 'none';
        isPaused = false;
        showPaymentForm();
    }

    window.closePaymentConfirm = function() {
        document.getElementById('paymentConfirmModal').style.display = 'none';
        isPaused = false;
    }

    window.cancelPayment = function() {
        document.getElementById('paymentForm').classList.add('hidden');
        document.getElementById('paySearchID').value = '';
        currentPayStudent = null;
    }

    function showPaymentForm() {
        document.getElementById('paymentForm').classList.remove('hidden'); 
        document.getElementById('payStdName').innerText = currentPayStudent.name; 
        document.getElementById('payStdID').innerText = currentPayStudent.id; 

        document.getElementById('payAmount').value = document.getElementById('defPayAmount').value;
        document.getElementById('payType').value = document.getElementById('defPayType').value;
        document.getElementById('payNote').value = document.getElementById('defPayNote').value;

        playSound('success'); 
    }

    function searchStudentForPay() { handlePaymentScan(document.getElementById('paySearchID').value); }
    async function confirmPayment() { 
        const amount = parseFloat(document.getElementById('payAmount').value); 
        const type = document.getElementById('payType').value; 
        const note = document.getElementById('payNote').value;
        const time = new Date().toLocaleTimeString('ar-EG'); 

        let typeText = type;
        if(note) typeText += ` (${note})`;

        await window.addDoc(window.collection(window.db, "accounting"), { 
            date: today, 
            time, 
            stdId: currentPayStudent.id, 
            name: currentPayStudent.name, 
            amount, 
            type: typeText, 
            category: 'revenue',
            timestamp: Date.now() // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ø¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠ Ù„Ù„ØªØ­Ù‚Ù‚
        }); 
        document.getElementById('paymentForm').classList.add('hidden'); 
        document.getElementById('paySearchID').value = ''; 
        showToast('ØªÙ… Ø§Ù„Ø¯ÙØ¹', 'success'); 
    }
    async function addExpense() { 
        const type = document.getElementById('expType').value; 
        const details = document.getElementById('expDetails').value;
        const note = document.getElementById('expNote').value; 
        const amount = parseFloat(document.getElementById('expAmount').value); 
        const time = new Date().toLocaleTimeString('ar-EG'); 

        if(!type || !amount) return showToast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error'); 

        let desc = type;
        if(details) desc += ` - ${details}`;
        if(note) desc += ` (${note})`;

        await window.addDoc(window.collection(window.db, "accounting"), { date: today, time, desc: desc, amount, category: 'expense' }); 
        document.getElementById('expType').value = ''; 
        document.getElementById('expDetails').value = '';
        document.getElementById('expNote').value = ''; 
        document.getElementById('expAmount').value = ''; 
        showToast('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„', 'success'); 
    }
    window.updateFinance = function() { 
        const revs = window.accounting.filter(a => a.category === 'revenue'); 
        const exps = window.accounting.filter(a => a.category === 'expense'); 
        const totalRev = revs.reduce((sum, r) => sum + r.amount, 0); 
        const totalExp = exps.reduce((sum, e) => sum + e.amount, 0); 
        document.getElementById('totalRev').innerText = totalRev; 
        document.getElementById('totalExp').innerText = totalExp; 
        document.getElementById('netProfit').innerText = (totalRev - totalExp); 

        const todayRevs = revs.filter(r => r.date === today); 
        const todayExps = exps.filter(e => e.date === today); 

        // ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ù„ÙŠØ¸Ù‡Ø± Ø§Ù„Ù†ÙˆØ¹ Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø§Ø³Ù…
        document.getElementById('todayRevList').innerHTML = todayRevs.map(r => `<div class="flex justify-between border-b border-white/10 pb-1"><span>${r.name} <span class="text-[9px] opacity-70">(${r.type})</span></span><span>${r.amount}</span></div>`).join('') || '<div class="text-center opacity-50">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div>'; 
        document.getElementById('todayExpList').innerHTML = todayExps.map(e => `<div class="flex justify-between border-b border-white/10 pb-1"><span>${e.desc}</span><span>${e.amount}</span></div>`).join('') || '<div class="text-center opacity-50">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div>'; 
    }
    function toggleReportInputs() { const type = document.getElementById('reportType').value; if(type === 'daily') { document.getElementById('divDateInput').classList.remove('hidden'); document.getElementById('divMonthInput').classList.add('hidden'); } else { document.getElementById('divDateInput').classList.add('hidden'); document.getElementById('divMonthInput').classList.remove('hidden'); } }
    function openReportDetails(key) { 
        const list = currentReportData[key]; 
        let title = ''; 
        if(key === 'present') title = 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±'; 
        else if(key === 'absent') title = 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨'; 
        else if(key === 'revenues') title = 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª'; 
        else title = 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª'; 

        document.getElementById('detailsTitle').innerText = title; 
        document.getElementById('modalFilterContainer').classList.add('hidden'); 
        const thead = document.getElementById('detailsTableHead'); 
        const tbody = document.getElementById('detailsTableBody'); 

        if(key === 'present' || key === 'absent') { 
            const isMonthly = document.getElementById('reportType').value === 'monthly'; 

            if (isMonthly) {
                if (key === 'present') {
                    thead.innerHTML = `<tr><th class="col-index">Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…</th><th>ØªÙˆØ§Ø±ÙŠØ® Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠØ©</th></tr>`;
                    if(list.length === 0) tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`; 
                    else tbody.innerHTML = list.map((s, i) => `<tr class="hover:bg-gray-50"><td class="text-gray-500">${i + 1}</td><td class="font-bold">${s.name}</td><td>${stageMap[s.level] || s.level}</td><td class="font-bold text-green-600">${s.time}</td><td class="text-[9px]">${s.exceptionalDates && s.exceptionalDates.length > 0 ? s.exceptionalDates.join('<br>') : '-'}</td></tr>`).join('');
                } else {
                    // Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ
                    thead.innerHTML = `<tr><th class="col-index">Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…</th><th>ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„ØºÙŠØ§Ø¨</th></tr>`;
                    if(list.length === 0) tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`; 
                    else tbody.innerHTML = list.map((s, i) => `<tr class="hover:bg-gray-50"><td class="text-gray-500">${i + 1}</td><td class="font-bold">${s.name}</td><td>${stageMap[s.level] || s.level}</td><td class="font-bold text-red-600">${s.time}</td><td class="text-[9px] text-red-600 font-bold">${s.absentDatesList ? s.absentDatesList.join('<br>') : '-'}</td></tr>`).join('');
                }
            } else {
                // ÙŠÙˆÙ…ÙŠ
                thead.innerHTML = `<tr><th class="col-index">Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>Ø§Ù„ÙˆÙ‚Øª</th></tr>`; 
                if(list.length === 0) tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`; 
                else tbody.innerHTML = list.map((s, i) => `<tr class="hover:bg-gray-50"><td class="text-gray-500">${i + 1}</td><td class="font-bold">${s.name}</td><td>${stageMap[s.level] || s.level}</td><td class="text-xs ${key === 'absent' ? 'text-red-600' : ''}">${s.time}</td></tr>`).join(''); 
            }
        } else if (key === 'revenues') {
            thead.innerHTML = `<tr><th class="col-index">Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr>`; 
            if(list.length === 0) tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`; 
            else tbody.innerHTML = list.map((item, i) => `<tr class="hover:bg-gray-50"><td class="text-gray-500">${i + 1}</td><td class="font-bold">${item.name}</td><td class="font-bold text-green-600">${item.amount}</td><td class="text-xs">${item.type}</td><td class="text-gray-500 text-xs">${item.date}</td></tr>`).join(''); 
        } else {
            thead.innerHTML = `<tr><th class="col-index">Ù…</th><th>Ø§Ù„Ø¨Ù†Ø¯</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr>`; 
            if(list.length === 0) tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`; 
            else tbody.innerHTML = list.map((item, i) => `<tr class="hover:bg-gray-50"><td class="text-gray-500">${i + 1}</td><td class="font-bold">${item.desc}</td><td class="text-gray-500 text-xs">${item.date}</td><td class="font-bold text-red-600">${item.amount}</td></tr>`).join(''); 
        } 
        document.getElementById('detailsModal').classList.remove('hidden'); 
    }
    function exportData() { const data = { students: window.students, attendance: window.attendance, accounting: window.accounting }; const blob = new Blob([JSON.stringify(data)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `backup_center_${today}.json`; a.click(); }
    function importData(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = async function(e) { try { const data = JSON.parse(e.target.result); if(data.students) { for(const s of data.students) await window.addDoc(window.collection(window.db, "students"), s); for(const a of data.attendance) await window.addDoc(window.collection(window.db, "attendance"), a); for(const c of data.accounting) await window.addDoc(window.collection(window.db, "accounting"), c); alert('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!'); } } catch(err) { alert('Ù…Ù„Ù ØªØ§Ù„Ù'); } }; reader.readAsText(file); }
    function showToast(msg, type) { const t = document.getElementById('toast'); t.innerText = msg; t.className = `fixed top-5 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-xl z-[200] font-bold text-sm text-white ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`; t.classList.remove('hidden'); setTimeout(() => t.classList.add('hidden'), 3000); }
    function playSound(type) { const ctx = new (window.AudioContext || window.webkitAudioContext)(); const osc = ctx.createOscillator(); osc.connect(ctx.destination); if(type === 'success') { osc.frequency.setValueAtTime(800, ctx.currentTime); osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.1); } else { osc.frequency.setValueAtTime(300, ctx.currentTime); osc.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.2); } osc.start(); osc.stop(ctx.currentTime + 0.2); }
    function shareStudentReport() { if(currentParentPhone) { const url = `https://wa.me/20${currentParentPhone}?text=${encodeURIComponent(currentStudentReport)}`; window.open(url, '_blank'); } else { alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø£Ù…Ø±'); } }
    function printContent(elementId, title) { 
        if(isPrinting) return;
        const content = document.getElementById(elementId).innerHTML; 
        printHTML(title, `<table class="print-table"><thead>${document.getElementById('detailsTableHead').innerHTML}</thead><tbody>${document.getElementById('detailsTableBody').innerHTML}</tbody></table>`);
    }
    function pdfContent(elementId, title) {
        const content = `<table class="print-table"><thead>${document.getElementById('detailsTableHead').innerHTML}</thead><tbody>${document.getElementById('detailsTableBody').innerHTML}</tbody></table>`;
        savePDF(title, content);
    }
    
    // --- ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ---
    window.printStudentCard = async function() { 
        if(isPrinting) return;
        const s = window.students.find(st => st.id === currentModalStudentId); 
        if(!s) return; 
        
        showToast('Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©...', 'success');
        const qrImageHtml = await generateQRHtml(s.id);

        const content = `
            <div class="print-student-card">
                <div class="print-card-title">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</div>
                <div class="print-card-name">${s.name}</div>
                <div style="display:flex; justify-content:center; margin:10px 0;">${qrImageHtml}</div>
                <div class="print-card-row"><span>ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨:</span> <span>${s.id}</span></div>
                <div class="print-card-row"><span>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:</span> <span>${s.password || '----'}</span></div>
                <div class="print-card-row"><span>Ø§Ù„Ù…Ø±Ø­Ù„Ø©:</span> <span>${stageMap[s.level] || s.level}</span></div>
                <div class="print-card-row"><span>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:</span> <span>${s.date}</span></div>
                <div class="print-card-footer">Smart Center Pro</div>
            </div>
        `;
        printHTML('Ø¨Ø·Ø§Ù‚Ø© Ø·Ø§Ù„Ø¨', content);
    }

    function printFinancialReport() { 
        if(isPrinting) return;
        const revs = window.accounting.filter(a => a.category === 'revenue' && a.date === today).sort((a,b) => a.time.localeCompare(b.time)); 
        const exps = window.accounting.filter(a => a.category === 'expense' && a.date === today).sort((a,b) => a.time.localeCompare(b.time)); 
        const totalRev = revs.reduce((sum, r) => sum + r.amount, 0); 
        const totalExp = exps.reduce((sum, e) => sum + e.amount, 0); 
        const net = totalRev - totalExp; 

        const content = `
            <table class="print-stats-table">
                <tr>
                    <td class="print-stats-cell"><div class="print-box-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ§Ø±Ø¯</div><div class="print-box-val" style="color:green;">${totalRev}</div></td>
                    <td class="print-stats-cell"><div class="print-box-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div><div class="print-box-val" style="color:red;">${totalExp}</div></td>
                    <td class="print-stats-cell"><div class="print-box-title">Ø§Ù„ØµØ§ÙÙŠ</div><div class="print-box-val">${net}</div></td>
                </tr>
            </table>
            
            <h3 style="border-bottom: 2px solid #000; margin-top: 20px;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</h3>
            <table class="print-table"><thead><tr><th>Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ù†ÙˆØ¹</th></tr></thead><tbody>${revs.map((r, i) => `<tr><td>${i+1}</td><td>${r.name}</td><td>${r.amount}</td><td>${r.type}</td></tr>`).join('') || '<tr><td colspan="4">Ù„Ø§ ÙŠÙˆØ¬Ø¯</td></tr>'}</tbody></table>
            
            <h3 style="border-bottom: 2px solid #000; margin-top: 20px;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>
            <table class="print-table"><thead><tr><th>Ù…</th><th>Ø§Ù„Ø¨Ù†Ø¯</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead><tbody>${exps.map((e, i) => `<tr><td>${i+1}</td><td>${e.desc}</td><td>${e.amount}</td></tr>`).join('') || '<tr><td colspan="3">Ù„Ø§ ÙŠÙˆØ¬Ø¯</td></tr>'}</tbody></table>
        `;
        printHTML('Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ', content);
    }
    function pdfFinancialReport() {
        const revs = window.accounting.filter(a => a.category === 'revenue' && a.date === today).sort((a,b) => a.time.localeCompare(b.time)); 
        const exps = window.accounting.filter(a => a.category === 'expense' && a.date === today).sort((a,b) => a.time.localeCompare(b.time)); 
        const totalRev = revs.reduce((sum, r) => sum + r.amount, 0); 
        const totalExp = exps.reduce((sum, e) => sum + e.amount, 0); 
        const net = totalRev - totalExp; 

        const content = `
            <table class="print-stats-table">
                <tr>
                    <td class="print-stats-cell"><div class="print-box-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ§Ø±Ø¯</div><div class="print-box-val" style="color:green;">${totalRev}</div></td>
                    <td class="print-stats-cell"><div class="print-box-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div><div class="print-box-val" style="color:red;">${totalExp}</div></td>
                    <td class="print-stats-cell"><div class="print-box-title">Ø§Ù„ØµØ§ÙÙŠ</div><div class="print-box-val">${net}</div></td>
                </tr>
            </table>
            
            <h3 style="border-bottom: 2px solid #000; margin-top: 20px;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</h3>
            <table class="print-table"><thead><tr><th>Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ù†ÙˆØ¹</th></tr></thead><tbody>${revs.map((r, i) => `<tr><td>${i+1}</td><td>${r.name}</td><td>${r.amount}</td><td>${r.type}</td></tr>`).join('') || '<tr><td colspan="4">Ù„Ø§ ÙŠÙˆØ¬Ø¯</td></tr>'}</tbody></table>
            
            <h3 style="border-bottom: 2px solid #000; margin-top: 20px;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>
            <table class="print-table"><thead><tr><th>Ù…</th><th>Ø§Ù„Ø¨Ù†Ø¯</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead><tbody>${exps.map((e, i) => `<tr><td>${i+1}</td><td>${e.desc}</td><td>${e.amount}</td></tr>`).join('') || '<tr><td colspan="3">Ù„Ø§ ÙŠÙˆØ¬Ø¯</td></tr>'}</tbody></table>
        `;
        savePDF('Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ', content);
    }
    function shareStudentPdf() { const s = window.students.find(st => st.id === currentModalStudentId); if(!s) return; const pdfContainer = document.getElementById('pdf-generator-container'); pdfContainer.innerHTML = `<div style="width: 300px; padding: 20px; border: 2px solid #1e3a8a; border-radius: 15px; text-align: center; font-family: 'Cairo', sans-serif; background: white;"><h3 style="color: #1e3a8a; margin-bottom: 10px; font-weight: bold;">Ø¨Ø·Ø§Ù‚Ø© Ø·Ø§Ù„Ø¨</h3><div id="pdfQr" style="display: flex; justify-content: center; margin-bottom: 10px;"></div><div style="font-size: 24px; font-weight: bold; color: #2563eb; font-family: monospace; margin-bottom: 5px;">${s.id}</div><div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">${s.name}</div><div style="color: #666; font-size: 12px; margin-bottom: 10px;">${stageMap[s.level] || s.level}</div>${s.password ? `<div style="background: #fef9c3; padding: 5px; border-radius: 5px; border: 1px solid #fde047; margin-top: 10px;"><div style="font-size: 10px; color: #666;">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</div><div style="font-weight: bold; color: #dc2626; font-size: 16px;">${s.password}</div></div>` : ''}<div style="margin-top: 15px; font-size: 10px; color: #999;">Smart Center Pro</div></div>`; new QRCode(document.getElementById("pdfQr"), { text: s.id, width: 100, height: 100 }); setTimeout(() => { const element = pdfContainer.firstElementChild; const opt = { margin: 10, filename: `Ø¨Ø·Ø§Ù‚Ø©_${s.name}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a6', orientation: 'portrait' } }; html2pdf().set(opt).from(element).save().then(() => { pdfContainer.innerHTML = ''; }); }, 300); }
    async function delStudent(docId, studentId) { if(!confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØ¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª Ø­Ø¶ÙˆØ±Ù‡ ÙˆÙ…Ø¯ÙÙˆØ¹Ø§ØªÙ‡! Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return; try { const attQuery = window.query(window.collection(window.db, "attendance"), window.where("studentId", "==", studentId)); const attSnapshot = await window.getDocs(attQuery); attSnapshot.forEach(doc => window.deleteDoc(doc.ref)); const accQuery = window.query(window.collection(window.db, "accounting"), window.where("stdId", "==", studentId)); const accSnapshot = await window.getDocs(accQuery); accSnapshot.forEach(doc => window.deleteDoc(doc.ref)); await window.deleteDoc(window.doc(window.db, "students", docId)); showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡', 'success'); } catch (e) { showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù', 'error'); } }
</script>
</body>
</html>
