<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>Ø§Ù„Ø³ÙˆÙ‚ ÙˆÙŠØ§Ùƒ | Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ø´Ø§Ù…Ù„</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ø§Ù„Ø³ÙˆÙ‚ ÙˆÙŠØ§Ùƒ">
    <link id="manifest-link" rel="manifest">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { 
                extend: { 
                    colors: { 
                        navy: '#0f172a', 
                        darkbg: '#1e293b',
                        primary: '#10b981', 
                        secondary: '#3b82f6' 
                    } 
                } 
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { 
            font-family: 'Cairo', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 100px;
            background-color: #f8fafc;
            /* ØªÙ… Ø­Ø°Ù overflow: hidden Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        }
        .dark body { background-color: #0f172a; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .gpu { transform: translateZ(0); will-change: transform; }
        .select-none { user-select: none; }

        @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
        .skeleton { animation: shimmer 2s infinite linear; background: linear-gradient(to right, #f1f5f9 4%, #e2e8f0 25%, #f1f5f9 36%); background-size: 1000px 100%; }
        .dark .skeleton { background: linear-gradient(to right, #1e293b 4%, #334155 25%, #1e293b 36%); }

        @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-pop { animation: popIn 0.15s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        .mobile-full-modal { position: fixed; inset: 0; z-index: 80; background-color: white; display: flex; flex-direction: column; height: 100dvh; }
        .dark .mobile-full-modal { background-color: #0f172a; }
        @media (min-width: 768px) { 
            .mobile-full-modal { position: relative; inset: auto; width: 100%; max-width: 28rem; height: 600px; max-height: 85vh; border-radius: 1.5rem; overflow: hidden; } 
            .modal-overlay { position: fixed; inset: 0; z-index: 80; background-color: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; padding: 1rem; } 
        }

        @keyframes slideInDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .toast { animation: slideInDown 0.2s ease-out forwards; }
        .toast.hiding { animation: fadeOut 0.2s ease-in forwards; }

        .form-label { display: block; font-size: 0.75rem; font-weight: 700; color: #475569; margin-bottom: 0.1rem; }
        .dark .form-label { color: #cbd5e1; }
        .form-input { width: 100%; background-color: #ffffff; border: 2px solid #cbd5e1; border-radius: 0.75rem; padding: 0.5rem 0.8rem; font-size: 0.8rem; font-weight: 600; color: #1e293b; outline: none; transition: all 0.2s; }
        .form-input:focus { border-color: #10b981; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }
        .dark .form-input { background-color: #1e293b; border-color: #475569; color: white; }
        .dark .form-input:focus { border-color: #10b981; }
        
        .size-checkbox:checked + div { background-color: #10b981; color: white; border-color: #10b981; }
        .chip-checkbox:checked + div { background-color: #10b981; color: white; border-color: #10b981; }

        .auth-input { width: 100%; background-color: #ffffff; border: 2px solid #cbd5e1; border-radius: 0.75rem; padding: 0.5rem 0.8rem; padding-right: 2.5rem; font-size: 0.9rem; font-weight: 600; color: #1e293b; outline: none; transition: all 0.2s; }
        .auth-input:focus { border-color: #10b981; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }

        @keyframes slideUpFilter { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .filter-sheet-content { animation: slideUpFilter 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .install-banner { animation: slideUp 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-navy dark:text-slate-100 select-none">

    <!-- INITIAL APP LOADER -->
    <div id="app-loader" class="fixed inset-0 z-[10000] bg-slate-50 dark:bg-navy flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>
        <h1 class="font-black text-xl text-navy dark:text-white">Ø§Ù„Ø³ÙˆÙ‚ <span class="text-primary">ÙˆÙŠØ§Ùƒ</span></h1>
    </div>

    <!-- AUTH MODAL -->
    <div id="auth-overlay" class="fixed inset-0 z-[9999] bg-slate-100 dark:bg-navy flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-white dark:bg-darkbg p-6 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 relative max-h-[90vh] overflow-y-auto">
            <div class="flex flex-col items-center gap-3 mb-4">
                <div class="bg-navy dark:bg-primary text-white p-4 rounded-2xl shadow-lg rotate-3">
                    <i data-lucide="shopping-bag" class="w-8 h-8"></i>
                </div>
                <h1 class="font-black text-2xl text-navy dark:text-white">Ø§Ù„Ø³ÙˆÙ‚ <span class="text-primary">ÙˆÙŠØ§Ùƒ</span></h1>
                <p class="text-slate-500 dark:text-slate-400 text-xs font-bold">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆØ­Ø¯Ø©</p>
            </div>

            <div id="role-switcher" class="hidden bg-slate-100 dark:bg-slate-800 p-1 rounded-xl flex mb-4 border border-slate-200 dark:border-slate-700">
                <button onclick="setAuthRole('customer')" id="btn-role-customer" class="flex-1 py-2.5 rounded-lg text-sm font-bold transition-all bg-navy text-white shadow-md"><div class="flex items-center justify-center gap-2"><i data-lucide="user" class="w-4 h-4"></i> Ø¹Ù…ÙŠÙ„</div></button>
                <button onclick="setAuthRole('marketer')" id="btn-role-marketer" class="flex-1 py-2.5 rounded-lg text-sm font-bold text-slate-500 dark:text-slate-400 transition-all hover:bg-white dark:hover:bg-slate-700"><div class="flex items-center justify-center gap-2"><i data-lucide="store" class="w-4 h-4"></i> Ù…Ù‚Ø¯Ù… Ø®Ø¯Ù…Ø©</div></button>
            </div>

            <div class="space-y-4">
                <div id="auth-image-field" class="hidden flex-col items-center justify-center gap-2 transition-all duration-300 w-full text-center">
                    <div class="relative group cursor-pointer mx-auto">
                        <input type="file" id="auth-img-input" accept="image/*" onchange="handleAuthImage(this)" class="absolute inset-0 opacity-0 z-10 cursor-pointer">
                        <div class="w-24 h-24 rounded-full bg-slate-50 dark:bg-slate-800 border-2 border-dashed border-primary/50 flex items-center justify-center overflow-hidden relative hover:bg-primary/5 transition mx-auto">
                            <img id="auth-img-preview" src="" class="w-full h-full object-cover hidden">
                            <div id="auth-img-placeholder" class="flex flex-col items-center text-slate-400"><i data-lucide="camera" class="w-8 h-8 mb-1"></i><span class="text-[10px] font-bold">ØµÙˆØ±Ø©</span></div>
                        </div>
                        <div class="absolute bottom-0 right-0 bg-navy text-white p-1.5 rounded-full shadow-sm pointer-events-none"><i data-lucide="plus" class="w-3 h-3"></i></div>
                    </div>
                    <span class="text-[10px] text-slate-400 font-bold block text-center w-full">Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
                </div>

                <div><label class="text-xs font-bold text-slate-600 dark:text-slate-300 mb-1 block mr-1">Ø§Ù„Ø§Ø³Ù…</label><div class="relative"><input id="auth-name" type="text" class="auth-input dark:bg-slate-800 dark:border-slate-600 dark:text-white" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§..."><i data-lucide="user" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i></div></div>
                <div><label class="text-xs font-bold text-slate-600 dark:text-slate-300 mb-1 block mr-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><div class="relative"><input id="auth-pass" type="password" class="auth-input dark:bg-slate-800 dark:border-slate-600 dark:text-white" placeholder="******"><i data-lucide="lock" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i></div></div>

                <div class="flex items-center justify-between pt-2 border-t border-slate-100 dark:border-slate-700 mt-4">
                    <span class="text-xs font-bold text-slate-500">Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨:</span>
                    <div class="flex bg-slate-100 dark:bg-slate-800 rounded-lg p-1 gap-1">
                        <button onclick="setAuthType('login')" id="btn-type-login" class="px-4 py-1.5 rounded-md text-[11px] font-bold bg-navy text-white shadow transition-all">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
                        <button onclick="setAuthType('signup')" id="btn-type-signup" class="px-4 py-1.5 rounded-md text-[11px] font-bold text-slate-500 transition-all hover:text-navy">Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
                    </div>
                </div>

                <button onclick="processAuth()" id="btn-auth-action" class="w-full bg-navy dark:bg-primary text-white py-3.5 rounded-xl font-bold shadow-lg shadow-navy/20 hover:opacity-90 transition-all active:scale-95 mt-2 flex justify-center items-center gap-2 text-sm"><span>Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø­Ø³Ø§Ø¨</span> <i data-lucide="log-in" class="w-4 h-4"></i></button>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed top-4 left-0 right-0 z-[220] flex flex-col items-center gap-2 pointer-events-none px-4"></div>

    <header class="fixed top-0 w-full z-[60] bg-white/90 dark:bg-navy/90 border-b border-slate-200 dark:border-slate-700 h-16 flex items-center justify-between px-4 shadow-sm backdrop-blur-md">
        <div class="flex items-center gap-2" id="logo-trigger">
            <div class="bg-navy dark:bg-primary text-white p-1.5 rounded-lg"><i data-lucide="shopping-bag" class="w-5 h-5"></i></div>
            <div class="flex flex-col">
                <div class="flex items-center gap-1"><span class="text-[10px] text-slate-400 font-bold">Ù…Ø±Ø­Ø¨Ø§Ù‹,</span><h1 id="header-username" class="font-bold text-xs text-primary">...</h1></div>
                <h1 class="font-bold text-base leading-none">Ø§Ù„Ø³ÙˆÙ‚ <span class="text-primary">ÙˆÙŠØ§Ùƒ</span></h1>
            </div>
        </div>
        <div class="flex gap-2 items-center">
            <a href="https://wa.me/201206244875" target="_blank" class="p-2 rounded-full bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400 hover:bg-green-100 border border-green-100 dark:border-green-900/50 transition shadow-sm"><i data-lucide="message-circle" class="w-5 h-5"></i></a>
            <!-- Added z-50 and cursor-pointer explicitly to ensure clickability -->
            <button onclick="window.toggleDarkMode()" class="p-2 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-yellow-400 hover:bg-slate-200 transition cursor-pointer z-50"><i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i><i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i></button>
            <button onclick="window.toggleFavView()" class="p-2 rounded-full bg-red-50 dark:bg-slate-800 text-red-500 hover:bg-red-100 relative transition cursor-pointer z-50"><i data-lucide="heart" class="w-5 h-5"></i><span id="fav-count" class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-600 rounded-full border-2 border-white dark:border-darkbg hidden"></span></button>
            <button onclick="window.toggleAdminPanel()" id="btn-admin-top" class="hidden bg-slate-100 dark:bg-slate-800 p-2 rounded-full text-slate-600 dark:text-white cursor-pointer z-50"><i data-lucide="shield" class="w-5 h-5"></i></button>
        </div>
    </header>

    <main class="pt-20 container mx-auto px-4 max-w-6xl min-h-screen">
        <div id="view-header" class="hidden flex items-center gap-3 pb-3">
            <button onclick="switchToHomeView()" class="bg-white dark:bg-slate-800 p-2 rounded-full border border-slate-200 dark:border-slate-700 shadow-sm"><i data-lucide="arrow-right" class="w-5 h-5 text-slate-600 dark:text-white"></i></button>
            <h2 id="view-title" class="text-xl font-bold text-slate-800 dark:text-white pt-1"></h2>
        </div>

        <div id="search-container" class="sticky top-16 z-[50] bg-slate-50/95 dark:bg-navy/95 backdrop-blur-lg pt-4 pb-3 -mx-4 px-4">
            <div class="relative max-w-3xl mx-auto flex gap-2">
                <div class="relative flex-1">
                    <input type="text" id="search-input" oninput="handleSearch()" placeholder="Ø§Ø¨Ø­Ø«..." class="w-full form-input pr-10 pl-4 !border-2 !border-black dark:!border-slate-500 shadow-lg">
                    <i data-lucide="search" class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
                </div>
                <button id="filter-btn-container" onclick="toggleFilterSheet()" class="hidden bg-navy dark:bg-primary text-white px-4 rounded-xl shadow-lg items-center justify-center gap-2 hover:opacity-90 transition active:scale-95">
                    <i data-lucide="sliders-horizontal" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <div id="categories-container" class="hidden justify-start gap-2 overflow-x-auto pt-2 pb-3 no-scrollbar"></div>
        <div id="grid-container" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 pb-10 mt-4"></div>
        <div id="loader" class="text-center py-20 hidden"><div class="w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-2"></div><p class="text-xs text-slate-400">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>
        <div id="empty-state" class="hidden text-center py-20 opacity-60 flex-col items-center"><div class="bg-slate-200 dark:bg-slate-800 p-4 rounded-full inline-block mb-2"><i data-lucide="shirt" class="w-8 h-8 text-slate-400"></i></div><p class="text-slate-500 dark:text-slate-400 font-bold text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p><button onclick="resetFilters()" class="mt-2 text-primary text-xs font-bold underline">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button></div>
    </main>

    <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[70] bg-white/90 dark:bg-slate-800/90 border border-slate-200 dark:border-slate-600 px-6 py-2 rounded-full flex items-center gap-8 shadow-lg transform transition-all hover:scale-105">
        <button onclick="switchToHomeView()" class="flex flex-col items-center gap-1 text-slate-500 dark:text-slate-400 hover:text-navy dark:hover:text-white transition group"><i data-lucide="home" class="w-6 h-6 group-hover:scale-110 transition"></i></button>
        <button onclick="toggleAddModal()" class="w-14 h-14 bg-navy dark:bg-primary text-white rounded-full flex items-center justify-center shadow-lg shadow-slate-900/20 transform -translate-y-6 border-4 border-slate-50 dark:border-navy hover:scale-110 transition active:scale-95 cursor-pointer"><i data-lucide="plus" class="w-7 h-7"></i></button>
        <button onclick="toggleChat()" class="flex flex-col items-center gap-1 text-slate-500 dark:text-slate-400 hover:text-navy dark:hover:text-white transition group relative"><div id="chat-badge" class="hidden absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border border-white dark:border-slate-800"></div><i data-lucide="message-circle" class="w-6 h-6 group-hover:scale-110 transition"></i></button>
    </nav>

    <div id="pwa-install-toast" class="hidden fixed bottom-24 left-4 right-4 bg-navy dark:bg-white dark:text-navy text-white p-4 rounded-xl shadow-2xl z-[110] flex items-center justify-between install-banner border dark:border-slate-200">
        <div class="flex items-center gap-3"><div class="bg-white/10 dark:bg-navy/10 p-2 rounded-lg"><i data-lucide="download" class="w-6 h-6"></i></div><div><h4 class="font-bold text-sm">ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h4><p class="text-xs opacity-80">Ø§Ù„Ø³ÙˆÙ‚ ÙˆÙŠØ§Ùƒ - ØªØ¬Ø±Ø¨Ø© Ø£Ø³Ø±Ø¹</p></div></div>
        <div class="flex gap-2"><button onclick="installPWA()" class="bg-primary text-white px-4 py-2 rounded-lg font-bold text-xs shadow-lg">ØªØ«Ø¨ÙŠØª</button><button onclick="closeInstall()" class="text-white dark:text-navy p-1"><i data-lucide="x" class="w-4 h-4"></i></button></div>
    </div>

    <!-- Add Modal (SMART FORM) -->
    <div id="add-modal" class="hidden modal-overlay">
        <div class="mobile-full-modal animate-pop border border-slate-200 dark:border-slate-700">
            <div class="p-3 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800 shrink-0">
                <h3 class="font-bold text-slate-800 dark:text-white text-base">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</h3>
                <button onclick="toggleAddModal()" class="bg-white dark:bg-slate-700 p-1.5 rounded-full border border-slate-200 dark:border-slate-600 text-slate-500 dark:text-white hover:text-red-500"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-2 bg-white dark:bg-darkbg">
                <div class="form-group"><span class="form-label">Ø§Ù„ØµÙˆØ± (max 7)</span><div class="grid grid-cols-4 gap-2"><label class="aspect-square border-2 border-dashed border-primary/40 bg-primary/5 dark:bg-primary/10 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:border-primary hover:bg-primary/10 transition text-primary relative overflow-hidden group"><input type="file" multiple accept="image/*" onchange="handleUpload(this)" class="absolute inset-0 opacity-0 z-10"><i data-lucide="camera" class="w-5 h-5 mb-1 group-hover:scale-110 transition"></i><span class="text-[9px] font-bold">Ø¥Ø¶Ø§ÙØ©</span></label><div id="preview-area" class="col-span-3 flex gap-2 overflow-x-auto no-scrollbar items-center"></div></div></div>
                <div class="form-group"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label><input id="in-title" class="form-input !border-2 !border-black dark:!border-slate-500" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬..."></div>
                <div class="grid grid-cols-2 gap-2 form-group"><div><label class="form-label">Ø§Ù„Ø³Ø¹Ø±</label><input id="in-price" type="number" class="form-input !border-2 !border-black dark:!border-slate-500" placeholder="0"></div><div><label class="form-label">Ø§Ù„Ù‚Ø³Ù…</label><select id="in-cat" onchange="updateFormFields()" class="form-input bg-gray-50 !border-2 !border-black dark:!border-slate-500"></select></div></div>
                
                <!-- Dynamic Fields Container -->
                <div id="dynamic-fields" class="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border border-slate-100 dark:border-slate-700 form-group space-y-3 hidden">
                    
                    <!-- Device Type Selector (Electronics Only) -->
                    <div id="field-elec-type" class="hidden">
                        <label class="form-label text-primary">Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø²</label>
                        <select id="in-elec-type" onchange="updateElecFields()" class="form-input !border-2 !border-black dark:!border-slate-500">
                            <option value="phone">Ù‡Ø§ØªÙ Ø°ÙƒÙŠ (Mobile)</option>
                            <option value="laptop">ÙƒÙ…Ø¨ÙŠÙˆØªØ± / Ù„Ø§Ø¨ØªÙˆØ¨</option>
                            <option value="tablet">ØªØ§Ø¨Ù„Øª / Ø¢ÙŠØ¨Ø§Ø¯</option>
                            <option value="accessories">Ø§ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª</option>
                        </select>
                    </div>

                    <!-- Condition (Hidden for Clothes/Shoes) -->
                    <div id="field-condition" class="hidden"><label class="form-label text-primary">Ø§Ù„Ø­Ø§Ù„Ø©</label><select id="in-condition" class="form-input !border-2 !border-black dark:!border-slate-500"><option value="new">Ø¬Ø¯ÙŠØ¯</option><option value="used">Ù…Ø³ØªØ¹Ù…Ù„</option><option value="openbox">ÙƒØ³Ø± Ø²ÙŠØ±Ùˆ</option></select></div>
                    
                    <!-- SIZES -->
                    <div id="field-sizes" class="hidden">
                        <label class="form-label text-primary" id="label-sizes">Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</label>
                        <div id="sizes-container" class="flex flex-wrap gap-2"></div>
                    </div>

                    <!-- CLOTHES RANGES (From - To) -->
                    <div id="field-clothes-ranges" class="hidden grid grid-cols-2 gap-3">
                        <!-- Weight -->
                        <div class="col-span-2 sm:col-span-1">
                            <label class="form-label text-primary">Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)</label>
                            <div class="flex gap-2 items-center">
                                <input id="in-weight-from" type="number" class="form-input text-center !px-1" placeholder="Ù…Ù†">
                                <span class="font-bold text-slate-400">-</span>
                                <input id="in-weight-to" type="number" class="form-input text-center !px-1" placeholder="Ø¥Ù„Ù‰">
                            </div>
                        </div>
                        <!-- Height -->
                        <div class="col-span-2 sm:col-span-1">
                            <label class="form-label text-primary">Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)</label>
                            <div class="flex gap-2 items-center">
                                <input id="in-height-from" type="number" class="form-input text-center !px-1" placeholder="Ù…Ù†">
                                <span class="font-bold text-slate-400">-</span>
                                <input id="in-height-to" type="number" class="form-input text-center !px-1" placeholder="Ø¥Ù„Ù‰">
                            </div>
                        </div>
                        <!-- Age (Kids Only) -->
                        <div id="subfield-age" class="col-span-2 hidden">
                            <label class="form-label text-primary">Ø§Ù„Ø¹Ù…Ø± (Ø³Ù†Ø©)</label>
                            <div class="flex gap-2 items-center">
                                <input id="in-age-from" type="number" class="form-input text-center !px-1" placeholder="Ù…Ù†">
                                <span class="font-bold text-slate-400">-</span>
                                <input id="in-age-to" type="number" class="form-input text-center !px-1" placeholder="Ø¥Ù„Ù‰">
                            </div>
                        </div>
                    </div>

                    <!-- ELECTRONICS DYNAMIC SPECS -->
                    <div id="field-elec-specs" class="hidden grid grid-cols-2 gap-2">
                        <!-- Fields toggled by JS based on sub-type -->
                        <div class="spec-field" data-for="phone tablet laptop"><label class="form-label text-primary">Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Storage)</label><select id="in-storage" class="form-input"><option value="">Ø§Ø®ØªØ±...</option><option value="64GB">64GB</option><option value="128GB">128GB</option><option value="256GB">256GB</option><option value="512GB">512GB</option><option value="1TB">1TB</option></select></div>
                        <div class="spec-field" data-for="phone tablet laptop"><label class="form-label text-primary">Ø§Ù„Ø±Ø§Ù… (RAM)</label><select id="in-ram" class="form-input"><option value="">Ø§Ø®ØªØ±...</option><option value="4GB">4GB</option><option value="6GB">6GB</option><option value="8GB">8GB</option><option value="16GB">16GB</option><option value="32GB">32GB</option></select></div>
                        <div class="spec-field col-span-2" data-for="phone tablet"><label class="form-label text-primary">Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© %</label><input id="in-battery" type="number" class="form-input" placeholder="Ù…Ø«Ø§Ù„: 85"></div>
                        <div class="spec-field col-span-2" data-for="laptop"><label class="form-label text-primary">Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬ (Processor)</label><input id="in-processor" type="text" class="form-input" placeholder="Ù…Ø«Ø§Ù„: Core i5 / M1"></div>
                        <div class="spec-field col-span-2" data-for="laptop"><label class="form-label text-primary">ÙƒØ§Ø±Øª Ø§Ù„Ø´Ø§Ø´Ø© (GPU)</label><input id="in-gpu" type="text" class="form-input" placeholder="Ù…Ø«Ø§Ù„: NVIDIA RTX 3050"></div>
                    </div>

                    <!-- BEAUTY FIELDS -->
                    <div id="field-beauty-specs" class="hidden">
                        <label class="form-label text-primary">Ø§Ù„Ø­Ø¬Ù… (Ù…Ù„)</label>
                        <input id="in-volume" type="number" class="form-input" placeholder="Ù…Ø«Ø§Ù„: 100">
                    </div>

                    <!-- FURNITURE FIELDS -->
                    <div id="field-furniture-specs" class="hidden">
                        <label class="form-label text-primary">Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ (Ø·ÙˆÙ„ x Ø¹Ø±Ø¶ x Ø§Ø±ØªÙØ§Ø¹)</label>
                        <input id="in-dimensions" type="text" class="form-input" placeholder="Ù…Ø«Ø§Ù„: 200x150x50 Ø³Ù…">
                    </div>

                </div>

                <div class="form-group"><label class="form-label">Ù…ÙˆØ§ØµÙØ§Øª:</label><div class="flex flex-wrap gap-1.5"><label class="cursor-pointer"><input type="checkbox" class="chip-checkbox hidden" value="Ø£ØµÙ„ÙŠ"><div class="border-2 border-slate-200 dark:border-slate-700 rounded-lg px-2 py-1 text-[10px] font-bold text-slate-500 dark:text-slate-400 transition hover:bg-slate-100">Ø£ØµÙ„ÙŠ</div></label><label class="cursor-pointer"><input type="checkbox" class="chip-checkbox hidden" value=" ÙƒÙˆØ¨ÙŠ"><div class="border-2 border-slate-200 dark:border-slate-700 rounded-lg px-2 py-1 text-[10px] font-bold text-slate-500 dark:text-slate-400 transition hover:bg-slate-100">Ù‡Ø§ÙŠ ÙƒÙˆØ¨ÙŠ</div></label><label class="cursor-pointer"><input type="checkbox" class="chip-checkbox hidden" value="Ø¶Ù…Ø§Ù†"><div class="border-2 border-slate-200 dark:border-slate-700 rounded-lg px-2 py-1 text-[10px] font-bold text-slate-500 dark:text-slate-400 transition hover:bg-slate-100">Ø¶Ù…Ø§Ù†</div></label><label class="cursor-pointer"><input type="checkbox" class="chip-checkbox hidden" value="ØªÙˆØµÙŠÙ„"><div class="border-2 border-slate-200 dark:border-slate-700 rounded-lg px-2 py-1 text-[10px] font-bold text-slate-500 dark:text-slate-400 transition hover:bg-slate-100">ØªÙˆØµÙŠÙ„</div></label><label class="cursor-pointer"><input type="checkbox" class="chip-checkbox hidden" value="ÙØ§ØªÙˆØ±Ø©"><div class="border-2 border-slate-200 dark:border-slate-700 rounded-lg px-2 py-1 text-[10px] font-bold text-slate-500 dark:text-slate-400 transition hover:bg-slate-100">ÙØ§ØªÙˆØ±Ø©</div></label></div></div>
                <div class="form-group"><label class="form-label">ØªÙ…ÙŠÙŠØ²:</label><div class="flex gap-2 p-1 bg-slate-100 dark:bg-slate-800 rounded-lg"><label class="flex-1 cursor-pointer text-center"><input type="radio" name="badge" value="none" checked class="hidden peer"><div class="text-center py-1.5 rounded-md text-[10px] font-bold text-slate-500 peer-checked:bg-white dark:peer-checked:bg-slate-700 peer-checked:shadow-sm peer-checked:text-navy dark:peer-checked:text-white transition">Ø¹Ø§Ø¯ÙŠ</div></label><label class="flex-1 cursor-pointer text-center"><input type="radio" name="badge" value="hot" class="hidden peer"><div class="text-center py-1.5 rounded-md text-[10px] font-bold text-slate-500 peer-checked:bg-orange-500 peer-checked:text-white transition">ğŸ”¥ Ø¹Ø±Ø¶</div></label></div></div>
                <div class="form-group"><label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input id="in-phone" type="tel" class="form-input !border-2 !border-black dark:!border-slate-500" placeholder="01xxxxxxxxx"></div>
                <div class="form-group"><label class="form-label">Ø§Ù„ÙˆØµÙ</label><textarea id="in-desc" rows="2" class="form-input !border-2 !border-black dark:!border-slate-500" placeholder="ØªÙØ§ØµÙŠÙ„..."></textarea></div>
            </div>
            <div class="p-3 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 shrink-0 pb-8 md:pb-3"><button onclick="submitListing()" id="btn-publish" class="w-full bg-navy dark:bg-primary text-white py-3 rounded-xl font-bold text-sm shadow-lg shadow-navy/20 hover:opacity-90 transition flex justify-center items-center gap-2"><span>Ù†Ø´Ø± Ø§Ù„Ø¢Ù†</span><i data-lucide="arrow-left" class="w-4 h-4"></i></button></div>
        </div>
    </div>

    <!-- Filter Sheet Modal -->
    <div id="filter-sheet" class="hidden fixed inset-0 z-[160] bg-black/50 flex flex-col justify-end" onclick="if(event.target === this) toggleFilterSheet()">
        <div class="bg-white dark:bg-darkbg w-full rounded-t-2xl p-5 pb-safe filter-sheet-content border-t border-slate-200 dark:border-slate-700 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-navy dark:text-white text-lg">ÙÙ„ØªØ±Ø© ÙˆØªØ±ØªÙŠØ¨</h3>
                <button onclick="toggleFilterSheet()" class="p-1 bg-slate-100 dark:bg-slate-800 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="space-y-2">
                <button onclick="applyFilterSort('newest')" class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-800 text-start font-bold text-sm hover:bg-slate-100 dark:hover:bg-slate-700 flex justify-between items-center"><span>Ø§Ù„Ø£Ø­Ø¯Ø« (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ)</span><i data-lucide="clock" class="w-4 h-4 opacity-50"></i></button>
                <button onclick="applyFilterSort('price_low')" class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-800 text-start font-bold text-sm hover:bg-slate-100 dark:hover:bg-slate-700 flex justify-between items-center"><span>Ø§Ù„Ø³Ø¹Ø±: Ù…Ù† Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø£Ø¹Ù„Ù‰</span><i data-lucide="arrow-up-0-1" class="w-4 h-4 opacity-50"></i></button>
                <button onclick="applyFilterSort('price_high')" class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-800 text-start font-bold text-sm hover:bg-slate-100 dark:hover:bg-slate-700 flex justify-between items-center"><span>Ø§Ù„Ø³Ø¹Ø±: Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø£Ù‚Ù„</span><i data-lucide="arrow-down-1-0" class="w-4 h-4 opacity-50"></i></button>
                <button onclick="applyFilterSort('newest')" class="w-full p-3 rounded-xl bg-red-50 text-red-600 text-start font-bold text-sm hover:bg-red-100 flex justify-between items-center mt-2 border border-red-100"><span>Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙÙ„ØªØ± / Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</span><i data-lucide="rotate-ccw" class="w-4 h-4"></i></button>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="details-modal" class="hidden modal-overlay">
        <div class="mobile-full-modal animate-pop border border-slate-200 dark:border-slate-700">
            <div class="relative h-72 bg-gray-100 dark:bg-slate-800 shrink-0 group">
                <button onclick="closeDetails()" class="absolute top-3 left-3 bg-white/80 dark:bg-black/50 text-slate-800 dark:text-white p-1.5 rounded-full z-20 shadow-sm"><i data-lucide="x" class="w-5 h-5"></i></button>
                <button onclick="shareListing()" class="absolute top-3 right-3 bg-white/80 dark:bg-black/50 text-slate-800 dark:text-white p-1.5 rounded-full z-20 shadow-sm"><i data-lucide="share-2" class="w-5 h-5"></i></button>
                <div id="details-slider-container" class="w-full h-full flex items-center justify-center bg-gray-100 dark:bg-slate-800"><img id="details-img" src="" class="w-full h-full object-cover cursor-pointer" onclick="openLightbox(this.src)"></div>
                <div id="details-arrows"><button onclick="scrollDetails(1)" class="absolute left-2 top-1/2 -translate-y-1/2 bg-black/30 text-white p-1 rounded-full z-10"><i data-lucide="chevron-left" class="w-5 h-5"></i></button><button onclick="scrollDetails(-1)" class="absolute right-2 top-1/2 -translate-y-1/2 bg-black/30 text-white p-1 rounded-full z-10"><i data-lucide="chevron-right" class="w-5 h-5"></i></button></div>
                <span id="d-time-badge" class="absolute top-3 right-12 bg-black/60 text-white px-2 py-1 rounded text-[10px] font-bold backdrop-blur-sm flex items-center gap-1 z-10"></span>
                <div id="details-dots" class="absolute bottom-3 left-1/2 -translate-x-1/2 z-20 flex gap-1.5"></div>
            </div>
            <div class="flex-1 overflow-y-auto p-5 bg-white dark:bg-darkbg">
                <div class="flex items-center gap-2 mb-3 p-2 bg-slate-50 dark:bg-slate-800 border border-slate-100 dark:border-slate-700 rounded-lg"><img id="d-author-img" src="" class="w-10 h-10 rounded-full object-cover border border-slate-200"><div><div class="flex items-center gap-1"><p id="d-author-name" class="text-xs font-bold text-navy dark:text-white">Ø§Ø³Ù… Ø§Ù„Ù†Ø§Ø´Ø±</p><i id="d-author-verify" data-lucide="check-circle" class="w-3 h-3 hidden"></i></div><p id="d-author-status" class="text-[10px] text-slate-500 dark:text-slate-400">...</p></div></div>
                <div class="flex justify-between items-start mb-2"><h2 id="d-title" class="text-lg font-bold text-slate-900 dark:text-white leading-snug w-3/4"></h2><span id="d-price" class="text-primary font-black text-xl whitespace-nowrap"></span></div>
                <div class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400 mb-4 pb-4 border-b border-slate-100 dark:border-slate-700"><span id="d-cat" class="bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded text-xs border border-slate-200 dark:border-slate-700"></span> <span id="d-cond" class="bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded text-xs border border-slate-200 dark:border-slate-700 font-bold"></span></div>
                <div id="d-features" class="flex flex-wrap gap-2 mb-5"></div>
                <div id="d-specs-area" class="mb-5 grid grid-cols-2 gap-2 text-xs text-slate-600 dark:text-slate-300"></div>
                <div class="space-y-2"><h3 class="text-xs font-bold text-slate-900 dark:text-slate-200 uppercase tracking-wider">Ø§Ù„ÙˆØµÙ</h3><p id="d-desc" class="text-sm text-slate-600 dark:text-slate-300 leading-relaxed whitespace-pre-wrap bg-slate-50 dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700 font-medium"></p></div>
            </div>
            <div class="p-4 border-t border-slate-100 dark:border-slate-700 bg-white dark:bg-darkbg flex gap-3 shrink-0 pb-8 md:pb-4"><a id="d-wa" href="#" target="_blank" class="flex-1 bg-[#25D366] text-white py-3 rounded-xl flex justify-center items-center gap-2 font-bold shadow-lg hover:opacity-90 transition"><i data-lucide="message-circle" class="w-5 h-5"></i> ÙˆØ§ØªØ³Ø§Ø¨</a><a id="d-call" href="#" class="flex-1 bg-navy dark:bg-primary text-white py-3 rounded-xl flex justify-center items-center gap-2 font-bold shadow-lg hover:opacity-90 transition"><i data-lucide="phone" class="w-5 h-5"></i> Ø§ØªØµØ§Ù„</a></div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chat-modal" class="hidden modal-overlay">
        <div class="mobile-full-modal animate-pop border border-slate-200 dark:border-slate-700">
            <div class="bg-navy dark:bg-primary p-3 text-white flex justify-between items-center shrink-0"><div class="flex items-center gap-2"><div class="bg-white/10 p-1.5 rounded-full"><i data-lucide="bot" class="w-5 h-5 text-yellow-400"></i></div><div><h4 class="font-bold text-xs">Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</h4></div></div><button onclick="toggleChat()" class="hover:bg-white/20 p-1 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <div id="chat-box" class="flex-1 bg-slate-100 dark:bg-slate-900 p-3 overflow-y-auto space-y-2 text-xs"></div>
            <div class="p-2 bg-white dark:bg-slate-800 border-t dark:border-slate-700 flex items-center gap-2 shrink-0 pb-safe"><input id="chat-msg" type="text" class="flex-1 bg-slate-100 dark:bg-slate-700 border-0 rounded-full px-4 py-3 text-sm outline-none dark:text-white font-bold" placeholder="Ø§ÙƒØªØ¨..."><button onclick="sendMsg()" class="w-8 h-8 bg-navy dark:bg-primary rounded-full text-white flex items-center justify-center shadow"><i data-lucide="send" class="w-4 h-4"></i></button></div>
        </div>
    </div>

    <!-- Lightbox & Admin Panel (Standard) -->
    <div id="lightbox" class="hidden fixed inset-0 bg-black/95 z-[150] flex flex-col items-center justify-center select-none">
        <button onclick="closeLightbox()" class="absolute top-4 left-4 bg-white/20 text-white p-2 rounded-full z-20"><i data-lucide="x" class="w-6 h-6"></i></button>
        <button onclick="navigateLightbox(-1)" class="absolute left-2 md:left-10 top-1/2 -translate-y-1/2 bg-black/30 text-white p-2 rounded-full z-20 hover:bg-black/50 transition"><i data-lucide="chevron-left" class="w-8 h-8"></i></button>
        <button onclick="navigateLightbox(1)" class="absolute right-2 md:right-10 top-1/2 -translate-y-1/2 bg-black/30 text-white p-2 rounded-full z-20 hover:bg-black/50 transition"><i data-lucide="chevron-right" class="w-8 h-8"></i></button>
        <div class="relative w-full h-full flex items-center justify-center"><img id="lightbox-img" src="" class="max-w-full max-h-[80vh] object-contain"></div>
    </div>

    <div id="admin-panel" class="hidden fixed inset-0 bg-navy z-[130] flex flex-col text-white"><div class="p-3 border-b border-white/10 flex justify-between items-center bg-[#001a38]"><h2 class="font-bold flex items-center gap-2 text-sm"><i data-lucide="shield" class="w-4 h-4 text-primary"></i> Ø§Ù„ØªØ­ÙƒÙ…</h2><div class="flex gap-3"><button onclick="refreshAdmin()"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button><button onclick="toggleAdminPanel()"><i data-lucide="x" class="w-5 h-5"></i></button></div></div><div class="flex-1 flex overflow-hidden"><div class="w-1/3 border-l border-white/10 bg-[#001f3f] overflow-y-auto p-2" id="admin-users-list"></div><div class="w-2/3 flex flex-col bg-navy relative"><div id="admin-chat-header" class="h-12 border-b border-white/10 flex items-center justify-between px-3 bg-[#001a38]"><span class="text-xs font-bold">Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø©</span><button onclick="kickUser()" id="btn-end-chat" class="hidden bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded flex items-center gap-1"><i data-lucide="slash" class="w-3 h-3"></i> Ø¥Ù†Ù‡Ø§Ø¡</button></div><div id="admin-msg-area" class="flex-1 p-3 overflow-y-auto space-y-2 text-xs"></div><div class="p-2 border-t border-white/10 flex gap-2 bg-[#001a38]"><input id="admin-input" class="flex-1 bg-white/5 border border-white/20 rounded px-3 py-1.5 text-xs text-white outline-none" placeholder="Ø§Ù„Ø±Ø¯..."><button onclick="sendAdminMsg()" class="bg-primary px-4 py-1.5 rounded text-xs font-bold">Ø¥Ø±Ø³Ø§Ù„</button></div></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, setPersistence, browserLocalPersistence, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyC7zHuH8LK-yQAKG-Nm7dh31fXtVLxuCLM", authDomain: "sharqia-81030.firebaseapp.com", databaseURL: "https://sharqia-81030-default-rtdb.firebaseio.com", projectId: "sharqia-81030", storageBucket: "sharqia-81030.firebasestorage.app", messagingSenderId: "581888625195", appId: "1:581888625195:web:1667ba1e439e8e6c1fb86e" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);

        // Attach to window for HTML access
        window.toggleDarkMode = () => { 
            document.documentElement.classList.toggle('dark'); 
            localStorage.setItem('souq_theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); 
            lucide.createIcons();
        };
        window.toggleFavView = () => { state.currentView='category'; state.currentFilter='fav'; renderView(); showToast("Ø§Ù„Ù…ÙØ¶Ù„Ø© â¤ï¸"); };
        window.toggleAdminPanel = () => { document.getElementById('admin-panel').classList.toggle('hidden'); if(!document.getElementById('admin-panel').classList.contains('hidden')) refreshAdmin(); };

        if(localStorage.getItem('souq_theme') === 'dark') document.documentElement.classList.add('dark');

        let state = { user: null, listings: [], images: [], chatId: null, chatStep: 0, tempName: '', activeAdminChat: null, activeAdminUser: null, isAdmin: false, welcomeSent: false, favorites: [], currentFilter: 'all', currentSort: 'newest', currentItem: null, currentView: 'home', lightboxImages: [], lightboxIndex: 0, detailsSliderIndex: 0, detailsSliderImages: [], authRole: 'customer', authType: 'login', authImage: null, currentUserProfile: null };

        const CATEGORIES = ["Ù…Ù„Ø§Ø¨Ø³ Ø±Ø¬Ø§Ù„ÙŠ", "Ù…Ù„Ø§Ø¨Ø³ Ø­Ø±ÙŠÙ…ÙŠ", "Ù…Ù„Ø§Ø¨Ø³ Ø§Ø·ÙØ§Ù„", "Ø§Ø­Ø°ÙŠØ© Ø±Ø¬Ø§Ù„ÙŠ", "Ø§Ø­Ø°ÙŠØ© Ø­Ø±ÙŠÙ…ÙŠ", "Ø§Ø­Ø°ÙŠØ© Ø§Ø·ÙØ§Ù„", "Ø§ÙƒØ³Ø³ÙˆØ±Ø§Øª Ø±Ø¬Ø§Ù„ÙŠ", "Ø§ÙƒØ³Ø³ÙˆØ±Ø§Øª Ø­Ø±ÙŠÙ…ÙŠ", "Ø§ÙƒØ³Ø³ÙˆØ±Ø§Øª Ø§Ø·ÙØ§Ù„", "Ø¨Ø±ÙØ§Ù†Ø§Øª Ø±Ø¬Ø§Ù„ÙŠ ÙˆØ­Ø±ÙŠÙ…ÙŠ", "Ø§Ù„Ø­Ù‚Ø§Ø¦Ø¨ Ø§Ù„Ø´Ø®ØµÙŠØ©", "Ø§Ù„Ù†Ø¸Ø§Ø±Ø§Øª", "Ù…Ø³ØªØ­Ø¶Ø±Ø§Øª Ø§Ù„ØªØ¬Ù…ÙŠÙ„", "Ø§Ø¯ÙˆØ§Øª Ø­Ù„Ø§Ù‚Ø© Ù„Ù„Ø±Ø¬Ø§Ù„", "Ù…ÙƒÙ…Ù„Ø§Øª ØºØ°Ø§Ø¦ÙŠØ©", "Ø§Ø¯ÙˆØ§Øª Ø±ÙŠØ§Ø¶ÙŠØ©", "Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø´Ø®ØµÙŠØ©", "Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ ÙˆØ§Ù„Ø§Ù„Ø¹Ø§Ø¨", "Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¹Ù†Ø§ÙŠØ© Ø¨Ø§Ù„Ø¨Ø´Ø±Ø©", "Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø§Ø·ÙØ§Ù„", "Ø§Ù‚Ù…Ø´Ø©", "Ø£Ø«Ø§Ø« Ù…Ù†Ø²Ù„ÙŠ", "Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª"];
        
        // Config for Smart Fields
        const FIELD_CONFIG = {
            'clothes_adult': { condition:false, sizes:true, clothes_range:true }, // No condition for clothes
            'clothes_kids': { condition:false, sizes:true, clothes_range:true, age:true }, // No condition for clothes
            'shoes': { condition:false, sizes:true }, // No condition for shoes
            'elec': { condition:true, elec_specs:true, elec_type:true },
            'beauty': { condition:false, beauty_specs:true },
            'furniture': { condition:true, furniture_specs:true }
        };

        const CAT_TYPE_MAP = {
            "Ù…Ù„Ø§Ø¨Ø³ Ø±Ø¬Ø§Ù„ÙŠ": 'clothes_adult', "Ù…Ù„Ø§Ø¨Ø³ Ø­Ø±ÙŠÙ…ÙŠ": 'clothes_adult', "Ù…Ù„Ø§Ø¨Ø³ Ø§Ø·ÙØ§Ù„": 'clothes_kids',
            "Ø§Ø­Ø°ÙŠØ© Ø±Ø¬Ø§Ù„ÙŠ": 'shoes', "Ø§Ø­Ø°ÙŠØ© Ø­Ø±ÙŠÙ…ÙŠ": 'shoes', "Ø§Ø­Ø°ÙŠØ© Ø§Ø·ÙØ§Ù„": 'shoes',
            "Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª": 'elec', "Ø¨Ø±ÙØ§Ù†Ø§Øª Ø±Ø¬Ø§Ù„ÙŠ ÙˆØ­Ø±ÙŠÙ…ÙŠ": 'beauty', "Ù…Ø³ØªØ­Ø¶Ø±Ø§Øª Ø§Ù„ØªØ¬Ù…ÙŠÙ„": 'beauty',
            "Ø£Ø«Ø§Ø« Ù…Ù†Ø²Ù„ÙŠ": 'furniture'
        };

        const SIZE_OPTIONS = {
            'clothes_adult': ['S','M','L','XL','2XL','3XL','4XL'],
            'clothes_kids': ['0-3M','3-6M','6-12M','1-2Y','2-4Y','4-6Y','6-8Y','8-10Y','10-12Y'],
            'shoes': ['36','37','38','39','40','41','42','43','44','45']
        };

        // Updated Images
        const CATEGORY_IMAGES = { 
            "Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª": "https://images.pexels.com/photos/3568520/pexels-photo-3568520.jpeg?auto=compress&cs=tinysrgb&w=400",
            "Ù…Ù„Ø§Ø¨Ø³ Ø±Ø¬Ø§Ù„ÙŠ": "https://images.unsplash.com/photo-1617137968427-85924c800a22?q=80&w=300&auto=format&fit=crop", "Ø¨Ø±ÙØ§Ù†Ø§Øª Ø±Ø¬Ø§Ù„ÙŠ ÙˆØ­Ø±ÙŠÙ…ÙŠ": "https://images.unsplash.com/photo-1541643600914-78b084683601?q=80&w=300&auto=format&fit=crop", "Ø§Ù„Ù†Ø¸Ø§Ø±Ø§Øª": "https://images.unsplash.com/photo-1572635196237-14b3f281503f?q=80&w=300&auto=format&fit=crop", "Ù…Ø³ØªØ­Ø¶Ø±Ø§Øª Ø§Ù„ØªØ¬Ù…ÙŠÙ„": "https://images.unsplash.com/photo-1596462502278-27bfdc403348?q=80&w=300&auto=format&fit=crop", "Ø§Ø¯ÙˆØ§Øª Ø­Ù„Ø§Ù‚Ø© Ù„Ù„Ø±Ø¬Ø§Ù„": "https://images.unsplash.com/photo-1621607512214-68297480165e?q=80&w=300&auto=format&fit=crop", "Ù…ÙƒÙ…Ù„Ø§Øª ØºØ°Ø§Ø¦ÙŠØ©": "https://images.unsplash.com/photo-1581009137042-c552e485697a?q=80&w=300&auto=format&fit=crop", "Ø§Ø­Ø°ÙŠØ© Ø­Ø±ÙŠÙ…ÙŠ": "https://images.unsplash.com/photo-1549298916-b41d501d3772?q=80&w=300&auto=format&fit=crop", "Ø§Ø¯ÙˆØ§Øª Ø±ÙŠØ§Ø¶ÙŠØ©": "https://images.unsplash.com/photo-1517836357463-d25dfeac3438?q=80&w=300&auto=format&fit=crop", "Ù…Ù„Ø§Ø¨Ø³ Ø­Ø±ÙŠÙ…ÙŠ": "https://images.pexels.com/photos/3772506/pexels-photo-3772506.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop", "Ø§Ø­Ø°ÙŠØ© Ø±Ø¬Ø§Ù„ÙŠ": "https://images.pexels.com/photos/5264901/pexels-photo-5264901.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop", "Ø§Ø­Ø°ÙŠØ© Ø§Ø·ÙØ§Ù„": "https://images.pexels.com/photos/29737094/pexels-photo-29737094.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop", "Ù…Ù„Ø§Ø¨Ø³ Ø§Ø·ÙØ§Ù„": "https://images.pexels.com/photos/1620758/pexels-photo-1620758.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop", "Ø§ÙƒØ³Ø³ÙˆØ±Ø§Øª Ø±Ø¬Ø§Ù„ÙŠ": "https://images.pexels.com/photos/3766112/pexels-photo-3766112.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop", "Ø§ÙƒØ³Ø³ÙˆØ±Ø§Øª Ø­Ø±ÙŠÙ…ÙŠ": "https://images.pexels.com/photos/17568000/pexels-photo-17568000.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop", "Ø§ÙƒØ³Ø³ÙˆØ±Ø§Øª Ø§Ø·ÙØ§Ù„": "https://images.pexels.com/photos/2848522/pexels-photo-2848522.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop", "Ø§Ù„Ø­Ù‚Ø§Ø¦Ø¨ Ø§Ù„Ø´Ø®ØµÙŠØ©": "https://images.pexels.com/photos/1986996/pexels-photo-1986996.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop", "Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø´Ø®ØµÙŠØ©": "https://images.pexels.com/photos/19066549/pexels-photo-19066549.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop", "Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ ÙˆØ§Ù„Ø§Ù„Ø¹Ø§Ø¨": "https://images.pexels.com/photos/4491662/pexels-photo-4491662.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop", "Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¹Ù†Ø§ÙŠØ© Ø¨Ø§Ù„Ø¨Ø´Ø±Ø©": "https://images.pexels.com/photos/10117729/pexels-photo-10117729.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop", "Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø§Ø·ÙØ§Ù„": "https://images.pexels.com/photos/26337029/pexels-photo-26337029.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop", "Ø§Ù‚Ù…Ø´Ø©": "https://images.pexels.com/photos/34636582/pexels-photo-34636582.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop", "Ø£Ø«Ø§Ø« Ù…Ù†Ø²Ù„ÙŠ": "https://images.unsplash.com/photo-1586023492125-27b2c045efd7?q=80&w=300&auto=format&fit=crop" 
        };

        function registerSW(){if('serviceWorker'in navigator){const blob=new Blob([`const CACHE_NAME='souq-cache-v1';self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE_NAME).then(c=>c.addAll(['/','https://cdn.tailwindcss.com','https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap','https://unpkg.com/lucide@latest'])))})`],{type:'application/javascript'});navigator.serviceWorker.register(URL.createObjectURL(blob))}}window.addEventListener('load',registerSW);
        function preloadCategoryImages(){Object.values(CATEGORY_IMAGES).forEach(u=>{(new Image()).src=u})}preloadCategoryImages();

        // AUTH
        setPersistence(auth, browserLocalPersistence).then(() => signInAnonymously(auth));
        onAuthStateChanged(auth, async (u) => { 
            if(u) { state.user = u; 
                const stored = localStorage.getItem('souq_user_profile');
                if(stored) { state.currentUserProfile = JSON.parse(stored); finishLogin(); } 
                else { 
                    document.getElementById('app-loader').classList.add('opacity-0','pointer-events-none');
                    setTimeout(()=>document.getElementById('app-loader').style.display='none',500);
                    document.getElementById('auth-overlay').classList.remove('hidden'); 
                    lucide.createIcons(); 
                }
            } 
        });

        setTimeout(() => {
            if(document.getElementById('app-loader').style.display !== 'none') {
                document.getElementById('app-loader').style.display = 'none';
                if(!state.currentUserProfile) document.getElementById('auth-overlay').classList.remove('hidden');
            }
        }, 3000);

        function finishLogin() {
            const l = document.getElementById('app-loader'); l.classList.add('opacity-0','pointer-events-none'); setTimeout(()=>l.style.display='none',500);
            document.getElementById('loader').classList.add('hidden'); document.getElementById('auth-overlay').classList.add('hidden'); 
            if(state.currentUserProfile?.name) document.getElementById('header-username').innerText = state.currentUserProfile.name;
            initCats(); loadListings(); checkUserChat(); initFavs(); checkAdminStatus(); 
        }

        window.setAuthRole=r=>{state.authRole=r;const c=document.getElementById('btn-role-customer'),m=document.getElementById('btn-role-marketer');if(r==='customer'){c.className="flex-1 py-2.5 rounded-lg text-sm font-bold transition-all bg-navy text-white shadow-md";m.className="flex-1 py-2.5 rounded-lg text-sm font-bold text-slate-500 dark:text-slate-400 transition-all hover:bg-white dark:hover:bg-slate-700"}else{m.className="flex-1 py-2.5 rounded-lg text-sm font-bold transition-all bg-navy text-white shadow-md";c.className="flex-1 py-2.5 rounded-lg text-sm font-bold text-slate-500 dark:text-slate-400 transition-all hover:bg-white dark:hover:bg-slate-700"}};
        window.setAuthType=t=>{state.authType=t;const l=document.getElementById('btn-type-login'),s=document.getElementById('btn-type-signup'),a=document.getElementById('btn-auth-action'),i=document.getElementById('auth-image-field'),r=document.getElementById('role-switcher');if(t==='login'){l.className="px-4 py-1.5 rounded-md text-[11px] font-bold bg-navy text-white shadow transition-all";s.className="px-4 py-1.5 rounded-md text-[11px] font-bold text-slate-500 transition-all hover:text-navy";a.innerHTML=`<span>Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø­Ø³Ø§Ø¨</span> <i data-lucide="log-in" class="w-4 h-4"></i>`;i.classList.add('hidden');r.classList.add('hidden')}else{s.className="px-4 py-1.5 rounded-md text-[11px] font-bold bg-navy text-white shadow transition-all";l.className="px-4 py-1.5 rounded-md text-[11px] font-bold text-slate-500 transition-all hover:text-navy";a.innerHTML=`<span>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</span> <i data-lucide="plus-circle" class="w-4 h-4"></i>`;i.classList.remove('hidden');i.classList.add('flex');r.classList.remove('hidden')}lucide.createIcons()};
        window.handleAuthImage=async i=>{if(i.files[0]){state.authImage=await compress(i.files[0]);document.getElementById('auth-img-preview').src=state.authImage;document.getElementById('auth-img-preview').classList.remove('hidden');document.getElementById('auth-img-placeholder').classList.add('hidden')}};
        window.processAuth=async()=>{const n=document.getElementById('auth-name').value.trim(),p=document.getElementById('auth-pass').value.trim(),b=document.getElementById('btn-auth-action');if(!n||!p)return showToast("Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©","e");const old=b.innerHTML;b.innerHTML="Ø¬Ø§Ø±ÙŠ...";b.disabled=true;try{if(state.authType==='signup'){const q=await getDocs(query(collection(db,"users"),where("name","==",n)));if(!q.empty){showToast("Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…","e");b.innerHTML=old;b.disabled=false;return}const d={name:n,password:p,role:state.authRole,image:state.authImage||'https://cdn-icons-png.flaticon.com/512/641/641813.png',joinedAt:new Date().toISOString(),uid:state.user.uid,isTrusted:false};await setDoc(doc(db,"users",state.user.uid),d);localStorage.setItem('souq_user_profile',JSON.stringify(d));state.currentUserProfile=d;finishLogin();showToast("ØªÙ… Ø§Ù„Ø­Ø³Ø§Ø¨")}else{const q=await getDocs(query(collection(db,"users"),where("name","==",n),where("password","==",p)));if(!q.empty){const d=q.docs[0].data();localStorage.setItem('souq_user_profile',JSON.stringify(d));state.currentUserProfile=d;finishLogin();showToast(`Ø£Ù‡Ù„Ø§Ù‹ ${n}`)}else{showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª","e");b.innerHTML=old;b.disabled=false}}}catch(e){console.log(e);b.disabled=false;b.innerHTML=old}};

        function initCats(){const c=document.getElementById('categories-container');c.innerHTML=`<button onclick="filter('all')" id="chip-all" class="chip-btn">Ø§Ù„ÙƒÙ„</button>`;const s=document.getElementById('in-cat');s.innerHTML='';CATEGORIES.forEach(x=>{const b=document.createElement('button');b.innerText=x;b.id=`chip-${x.replace(/\s/g,'')}`;b.className="px-4 py-1.5 rounded-full bg-white dark:bg-darkbg border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-300 text-xs font-bold whitespace-nowrap transition hover:border-primary hover:text-primary chip-btn";b.onclick=()=>filter(x);c.appendChild(b);const o=document.createElement('option');o.value=x;o.innerText=x;s.appendChild(o)})};
        function renderView(){const s=document.getElementById('search-container'),c=document.getElementById('categories-container'),v=document.getElementById('view-header'),g=document.getElementById('grid-container'),f=document.getElementById('filter-btn-container');if(state.currentView==='home'){v.classList.add('hidden');c.classList.add('hidden');s.classList.remove('hidden');g.className='grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 pb-10 mt-4';document.getElementById('search-input').placeholder='Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ø³Ù…...';f.classList.add('hidden');f.classList.remove('flex');renderCategoryCards()}else{v.classList.remove('hidden');document.getElementById('view-title').innerText=state.currentFilter==='all'?'ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª':state.currentFilter;if(state.currentFilter==='fav'){s.classList.add('hidden');c.classList.add('hidden')}else{s.classList.remove('hidden');document.getElementById('search-input').placeholder='Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬...';if(state.currentFilter==='all'){c.classList.remove('hidden');f.classList.add('flex');f.classList.remove('hidden')}else{c.classList.add('hidden');f.classList.add('flex');f.classList.remove('hidden')}}g.className='grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 pb-10';filter(state.currentFilter)}lucide.createIcons()};
        window.switchToCategoryView=c=>{state.currentView='category';state.currentFilter=c;document.getElementById('search-input').value='';window.scrollTo({top:0});renderView()};
        window.switchToHomeView=()=>{state.currentView='home';state.currentFilter='all';document.getElementById('search-input').value='';window.scrollTo({top:0});renderView()};
        function renderCategoryCards(){const q=normalizeText(document.getElementById('search-input').value),c=document.getElementById('grid-container');c.innerHTML='';const f=CATEGORIES.filter(x=>normalizeText(x).includes(q));if(!f.length)document.getElementById('empty-state').classList.remove('hidden');else{document.getElementById('empty-state').classList.add('hidden');f.forEach(x=>{c.innerHTML+=`<div onclick="switchToCategoryView('${x}')" class="relative rounded-xl overflow-hidden shadow-sm border-2 border-black dark:border-slate-700 h-28 cursor-pointer active:scale-95 transition-transform group flex items-center justify-center text-center p-2"><img src="${CATEGORY_IMAGES[x]||'https://via.placeholder.com/300'}" class="absolute inset-0 w-full h-full object-cover transition-transform duration-300 group-hover:scale-110"><div class="absolute inset-0 bg-black/50"></div><h3 class="relative z-10 font-bold text-white text-sm drop-shadow-md">${x}</h3></div>`})}};
        function loadListings(){showSkeletons();onSnapshot(query(collection(db,"listings")),s=>{state.listings=[];s.forEach(d=>state.listings.push({id:d.id,...d.data()}));state.listings.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));renderView()})};
        window.handleSearch=()=>{if(state.currentView==='home')renderCategoryCards();else renderProducts()};
        window.toggleFilterSheet=()=>{const s=document.getElementById('filter-sheet');s.classList.toggle('hidden');};
        window.applyFilterSort=t=>{state.currentSort=t;toggleFilterSheet();renderProducts();showToast("ØªÙ… Ø§Ù„ØªØ±ØªÙŠØ¨")};
        window.filter=t=>{state.currentFilter=t;document.querySelectorAll('#categories-container .chip-btn').forEach(b=>b.className="px-4 py-1.5 rounded-full bg-white dark:bg-darkbg border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-300 text-xs font-bold whitespace-nowrap transition hover:border-primary hover:text-primary chip-btn");const a=document.getElementById(t==='all'?'chip-all':`chip-${t.replace(/\s/g,'')}`);if(a){a.className="px-5 py-1.5 rounded-full bg-navy dark:bg-primary text-white text-xs font-bold shadow whitespace-nowrap transform scale-105 transition chip-btn";a.scrollIntoView({behavior:'smooth',inline:'center'})}if(state.currentView!=='category')state.currentView='category';document.getElementById('view-title').innerText=t;renderProducts()};
        function renderProducts(){const q=normalizeText(document.getElementById('search-input').value),c=document.getElementById('grid-container');c.innerHTML='';let f=state.listings.filter(i=>(state.currentFilter==='fav'?(state.favorites||[]).includes(i.id):(state.currentFilter==='all'||i.category===state.currentFilter))&&(normalizeText(i.title).includes(q)||normalizeText(i.category||'').includes(q)));if(state.currentSort==='price_low')f.sort((a,b)=>a.price-b.price);else if(state.currentSort==='price_high')f.sort((a,b)=>b.price-a.price);else f.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));if(!f.length)document.getElementById('empty-state').classList.remove('hidden');else{document.getElementById('empty-state').classList.add('hidden');f.forEach(i=>c.innerHTML+=createCard(i))}lucide.createIcons()};
        window.resetFilters=()=>{document.getElementById('search-input').value='';if(state.currentView==='category')filter('all');else renderCategoryCards()};
        
        function createCard(i){
            const s=i.status&&i.status!=='available';
            return `<div class="bg-white dark:bg-slate-800 rounded-lg overflow-hidden shadow-sm border-2 border-black dark:border-slate-700 flex flex-col h-full cursor-pointer active:scale-95 transition-transform group relative" onclick="${!s?`openDetails('${i.id}')`:''}"><div class="relative w-full h-32 sm:h-40 bg-gray-200 dark:bg-slate-700">${s?`<div class="absolute inset-0 z-20 bg-white/80 dark:bg-black/80 flex items-center justify-center"><span class="bg-red-600 text-white font-bold px-4 py-2 rounded-xl -rotate-12 text-sm">${i.status==='sold'?'Ù…Ø¨Ø§Ø¹':'ØºÙŠØ± Ù…ØªØ§Ø­'}</span></div>`:''}${state.isAdmin||state.user?.uid===i.authorId?`<div class="absolute top-1 right-1 z-20 flex gap-1"><button onclick="del(event,'${i.id}')" class="bg-white/80 text-red-500 p-1 rounded"><i data-lucide="trash-2" class="w-3 h-3"></i></button><button onclick="toggleStatus(event,'${i.id}','${i.status||'available'}')" class="bg-white/80 text-blue-600 p-1 rounded"><i data-lucide="edit-3" class="w-3 h-3"></i></button></div>`:''}<button onclick="toggleFav(event,'${i.id}')" class="absolute top-1 left-1 z-20 p-1.5 rounded-full bg-black/20 hover:bg-black/40"><i data-lucide="heart" class="w-4 h-4 ${state.favorites.includes(i.id)?'fill-red-500 text-red-500':'text-white'}"></i></button><img src="${i.images[0]}" class="w-full h-full object-cover"></div><div class="p-2 flex-1 flex flex-col"><div class="flex justify-between mb-1"><h3 class="font-bold text-slate-900 dark:text-white text-xs line-clamp-1">${i.title}</h3><span class="font-black text-primary text-xs">${Number(i.price).toLocaleString()} Ø¬.Ù…</span></div><div class="mt-auto pt-2 border-t border-slate-100 dark:border-slate-700"><a href="https://wa.me/20${i.phone}" target="_blank" class="flex-1 bg-primary text-white py-1.5 rounded flex justify-center items-center gap-1 text-[10px] font-bold"><i data-lucide="message-circle" class="w-3 h-3"></i> ÙˆØ§ØªØ³</a></div></div></div>`
        };

        window.openDetails=id=>{
            const i=state.listings.find(x=>x.id===id);if(!i)return;state.currentItem=i;
            document.getElementById('d-title').innerText=i.title;document.getElementById('d-price').innerText=Number(i.price).toLocaleString()+' Ø¬.Ù…';
            document.getElementById('d-cat').innerText=i.category;document.getElementById('d-desc').innerText=i.desc;
            
            // Author & Trust
            document.getElementById('d-author-name').innerText=i.authorName||'Ù…Ø¬Ù‡ÙˆÙ„';document.getElementById('d-author-img').src=i.authorImage||'https://cdn-icons-png.flaticon.com/512/641/641813.png';
            const v=document.getElementById('d-author-verify'),s=document.getElementById('d-author-status');
            if(i.authorTrusted){v.classList.remove('hidden');v.classList.add('text-primary','inline');s.innerHTML=`Ù†Ø§Ø´Ø± Ù…ÙˆØ«ÙˆÙ‚ <span class="text-primary">âœ“</span>`;s.className="text-[10px] text-navy dark:text-white font-bold"}
            else{v.classList.add('hidden');s.innerText="Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯ / ØºÙŠØ± Ù…ÙˆØ«ÙˆÙ‚";s.className="text-[10px] text-slate-500"}

            const f=document.getElementById('d-features');f.innerHTML='';
            // Multi Sizes
            if(i.sizes && Array.isArray(i.sizes)) i.sizes.forEach(z=>f.innerHTML+=`<span class="bg-slate-100 dark:bg-slate-700 dark:text-white px-2 py-1 rounded text-xs font-bold border border-slate-200 dark:border-slate-600">Ù…Ù‚Ø§Ø³: ${z}</span>`);
            
            // Features
            if(i.features)i.features.forEach(x=>f.innerHTML+=`<span class="bg-slate-100 dark:bg-slate-700 dark:text-white px-2 py-1 rounded text-xs border border-slate-200 dark:border-slate-600">${x}</span>`);

            // SPECS GRID
            const sp = document.getElementById('d-specs-area'); sp.innerHTML = '';
            if(i.weightFrom && i.weightTo) sp.innerHTML += `<div><span class="font-bold">Ø§Ù„ÙˆØ²Ù†:</span> ${i.weightFrom} - ${i.weightTo} ÙƒØ¬Ù…</div>`;
            if(i.heightFrom && i.heightTo) sp.innerHTML += `<div><span class="font-bold">Ø§Ù„Ø·ÙˆÙ„:</span> ${i.heightFrom} - ${i.heightTo} Ø³Ù…</div>`;
            if(i.ageFrom && i.ageTo) sp.innerHTML += `<div><span class="font-bold">Ø§Ù„Ø¹Ù…Ø±:</span> ${i.ageFrom} - ${i.ageTo} Ø³Ù†Ø©</div>`;
            if(i.storage) sp.innerHTML += `<div><span class="font-bold">Ø§Ù„Ù…Ø³Ø§Ø­Ø©:</span> ${i.storage}</div>`;
            if(i.ram) sp.innerHTML += `<div><span class="font-bold">Ø§Ù„Ø±Ø§Ù…:</span> ${i.ram}</div>`;
            if(i.battery) sp.innerHTML += `<div><span class="font-bold">Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©:</span> ${i.battery}%</div>`;
            if(i.volume) sp.innerHTML += `<div><span class="font-bold">Ø§Ù„Ø­Ø¬Ù…:</span> ${i.volume} Ù…Ù„</div>`;
            if(i.dimensions) sp.innerHTML += `<div><span class="font-bold">Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯:</span> ${i.dimensions}</div>`;
            if(i.elecType) sp.innerHTML += `<div><span class="font-bold">Ø§Ù„Ù†ÙˆØ¹:</span> ${i.elecType}</div>`;
            if(i.processor) sp.innerHTML += `<div><span class="font-bold">Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬:</span> ${i.processor}</div>`;
            if(i.gpu) sp.innerHTML += `<div><span class="font-bold">ÙƒØ§Ø±Øª Ø§Ù„Ø´Ø§Ø´Ø©:</span> ${i.gpu}</div>`;

            // Show Condition ONLY if available and not N/A
            const condEl = document.getElementById('d-cond');
            if(i.condition && i.condition !== 'undefined') {
                condEl.innerText = i.condition==='new'?'Ø¬Ø¯ÙŠØ¯':(i.condition==='openbox'?'ÙƒØ³Ø± Ø²ÙŠØ±Ùˆ':'Ù…Ø³ØªØ¹Ù…Ù„');
                condEl.parentElement.classList.remove('hidden');
            } else {
                condEl.parentElement.classList.add('hidden');
            }

            document.getElementById('d-wa').href=`https://wa.me/20${i.phone}?text=${i.title}`;document.getElementById('d-call').href=`tel:${i.phone}`;
            state.detailsSliderImages=i.images;goToDetailsSlide(0);document.getElementById('details-arrows').style.display=i.images.length>1?'block':'none';
            toggleModal('details-modal');lucide.createIcons();
        };

        window.updateFormFields=()=>{
            const c=document.getElementById('in-cat').value;
            const type = CAT_TYPE_MAP[c] || 'general';
            const conf = FIELD_CONFIG[type] || {};

            // Toggle Dynamic Container
            const dc = document.getElementById('dynamic-fields');
            if(Object.keys(conf).length > 0) dc.classList.remove('hidden'); else dc.classList.add('hidden');

            // Toggle Sections
            document.getElementById('field-condition').classList.toggle('hidden', !conf.condition);
            document.getElementById('field-sizes').classList.toggle('hidden', !conf.sizes);
            document.getElementById('field-clothes-ranges').classList.toggle('hidden', !conf.clothes_range);
            document.getElementById('subfield-age').classList.toggle('hidden', !conf.age);
            
            // Electronics Specifics
            document.getElementById('field-elec-type').classList.toggle('hidden', !conf.elec_type);
            document.getElementById('field-elec-specs').classList.toggle('hidden', !conf.elec_specs);
            
            document.getElementById('field-beauty-specs').classList.toggle('hidden', !conf.beauty_specs);
            document.getElementById('field-furniture-specs').classList.toggle('hidden', !conf.furniture_specs);

            // Update Sizes Options if visible
            if(conf.sizes) {
                const sc = document.getElementById('sizes-container');
                sc.innerHTML = '';
                const opts = SIZE_OPTIONS[type] || [];
                opts.forEach(sz => {
                    sc.innerHTML += `<label class="cursor-pointer"><input type="checkbox" class="size-checkbox hidden" value="${sz}"><div class="border-2 border-slate-300 dark:border-slate-600 rounded-lg px-3 py-1 text-xs font-bold text-slate-500 dark:text-slate-400 transition hover:bg-slate-100">${sz}</div></label>`;
                });
            }
            
            // Trigger Elec Fields update if elec
            if(conf.elec_type) window.updateElecFields();
        };

        window.updateElecFields = () => {
            const type = document.getElementById('in-elec-type').value;
            const fields = document.querySelectorAll('#field-elec-specs .spec-field');
            fields.forEach(f => {
                const allowed = f.getAttribute('data-for').split(' ');
                f.classList.toggle('hidden', !allowed.includes(type));
            });
        };

        window.submitListing=async()=>{
            if(!state.images.length)return showToast('ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹ Ø§Ù„Ø£Ù‚Ù„','e');
            const btn=document.getElementById('btn-publish');btn.innerHTML='Ø¬Ø§Ø±ÙŠ...';btn.disabled=true;
            
            // Gather Data
            const sizes=[]; document.querySelectorAll('.size-checkbox:checked').forEach(c=>sizes.push(c.value));
            const feats=[]; document.querySelectorAll('.chip-checkbox:checked').forEach(c=>feats.push(c.value));

            // Condition check
            const condEl = document.getElementById('in-condition');
            const condition = !condEl.parentElement.classList.contains('hidden') ? condEl.value : null;

            const d={
                title:document.getElementById('in-title').value, price:Number(document.getElementById('in-price').value),
                category:document.getElementById('in-cat').value, 
                condition:condition,
                phone:document.getElementById('in-phone').value, desc:document.getElementById('in-desc').value,
                features:feats, images:state.images, badge:document.querySelector('input[name="badge"]:checked').value,
                status:'available', createdAt:serverTimestamp(), authorId:state.user.uid,
                authorName:state.currentUserProfile?.name||'Ù…Ø¬Ù‡ÙˆÙ„', authorImage:state.currentUserProfile?.image,
                authorTrusted:state.currentUserProfile?.isTrusted||false,
                // New Fields
                sizes: sizes,
                weightFrom: document.getElementById('in-weight-from').value, weightTo: document.getElementById('in-weight-to').value,
                heightFrom: document.getElementById('in-height-from').value, heightTo: document.getElementById('in-height-to').value,
                ageFrom: document.getElementById('in-age-from').value, ageTo: document.getElementById('in-age-to').value,
                
                elecType: document.getElementById('in-elec-type').value,
                storage: document.getElementById('in-storage').value, ram: document.getElementById('in-ram').value,
                battery: document.getElementById('in-battery').value, volume: document.getElementById('in-volume').value,
                dimensions: document.getElementById('in-dimensions').value,
                processor: document.getElementById('in-processor').value, gpu: document.getElementById('in-gpu').value
            };
            await addDoc(collection(db,"listings"),d);
            showToast('ØªÙ… Ø§Ù„Ù†Ø´Ø±');toggleAddModal();btn.disabled=false;btn.innerHTML='<span>Ù†Ø´Ø±</span><i data-lucide="arrow-left" class="w-4 h-4"></i>';lucide.createIcons();
        };

        window.toggleAddModal = () => {
            if(toggleModal('add-modal')) { 
                state.images=[];
                document.getElementById('preview-area').innerHTML='';
                document.getElementById('in-title').value = '';
                document.getElementById('in-price').value = '';
                document.getElementById('in-phone').value = '';
                document.getElementById('in-desc').value = '';
                // Reset fields
                ['in-weight-from','in-weight-to','in-height-from','in-height-to','in-age-from','in-age-to','in-battery','in-volume','in-dimensions','in-processor','in-gpu'].forEach(id=>document.getElementById(id).value='');
                
                const catEl = document.getElementById('in-cat');
                if(catEl && catEl.options.length > 0) catEl.selectedIndex = 0;
                
                document.getElementById('in-condition').selectedIndex = 0;
                document.querySelectorAll('.chip-checkbox').forEach(c => c.checked = false);
                
                const badge = document.querySelector('input[name="badge"][value="none"]');
                if(badge) badge.checked = true;
                
                updateFormFields(); 
            }
        };

        // --- Chat System ---
        window.toggleChat=()=>{
            if(toggleModal('chat-modal')){
                if(!state.chatId && state.chatStep===0){
                    const name = state.currentUserProfile?.name || 'Ø²Ø§Ø¦Ø±';
                    botMsg(`Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ${name} ğŸ‘‹<br>ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒØŸ`, true); // true = show buttons
                }
            }
        };

        window.sendMsg=async(val)=>{
            let t = typeof val === 'string' ? val : document.getElementById('chat-msg').value.trim();
            if(!t)return;
            if(typeof val !== 'string') document.getElementById('chat-msg').value=''; // Clear input if typed
            
            // Render user msg
            userMsg(t);

            // Logic
            if(!state.chatId){
                // New Chat Creation
                const d = {
                    userId: state.user.uid, userName: state.currentUserProfile?.name || 'Ø²Ø§Ø¦Ø±',
                    lastMsg: t, status: t==='Ø·Ù„Ø¨ ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø­Ø³Ø§Ø¨'?'verification_request':'waiting', // Tag for Admin
                    messages: [
                        {s:'bot', t:`Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ${state.currentUserProfile?.name}`, d:new Date()},
                        {s:'user', t:t, d:new Date()} // First msg
                    ],
                    createdAt: serverTimestamp()
                };
                const r = await addDoc(collection(db,"chats"),d);
                state.chatId = r.id;
                listenChat(r.id);
                if(t==='Ø·Ù„Ø¨ ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø­Ø³Ø§Ø¨') botMsg("ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨ Ø§Ù„ØªÙˆØ«ÙŠÙ‚. Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ø¯Ø¹Ù… Ø¨Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡ Ù‚Ø±ÙŠØ¨Ø§Ù‹.");
                else botMsg("Ø³ÙŠÙ‚ÙˆÙ… Ø£Ø­Ø¯ Ù…Ù…Ø«Ù„ÙŠ Ø§Ù„Ø®Ø¯Ù…Ø© Ø¨Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹.");
            } else {
                // Existing Chat
                const s=await getDocs(query(collection(db,"chats"),where('__name__','==',state.chatId)));
                if(!s.empty){
                    const m=s.docs[0].data().messages; m.push({s:'user',t,d:new Date()});
                    await updateDoc(doc(db,"chats",state.chatId),{messages:m,lastMsg:t,status:'waiting'});
                }
            }
        };

        // Helper to show buttons
        function botMsg(t, showBtns=false){
            const d=document.createElement('div');d.className="flex flex-col items-end w-full";
            let btnsHtml = '';
            if(showBtns){
                btnsHtml = `
                <div class="flex gap-2 mt-2 w-full justify-end">
                    <button onclick="sendMsg('Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø´ÙƒØ§ÙˆÙŠ')" class="bg-slate-200 text-slate-700 text-[10px] font-bold px-3 py-2 rounded-lg hover:bg-slate-300 transition">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø´ÙƒØ§ÙˆÙŠ</button>
                    <button onclick="sendMsg('Ø·Ù„Ø¨ ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø­Ø³Ø§Ø¨')" class="bg-primary text-white text-[10px] font-bold px-3 py-2 rounded-lg hover:opacity-90 transition">Ø·Ù„Ø¨ ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø­Ø³Ø§Ø¨ ğŸ›¡ï¸</button>
                </div>`;
            }
            d.innerHTML=`<div class="bg-white dark:bg-slate-700 dark:text-white text-slate-800 px-3 py-2 rounded-xl rounded-tl-none shadow-sm text-xs max-w-[85%] self-end">${t}</div>${btnsHtml}`;
            document.getElementById('chat-box').appendChild(d);document.getElementById('chat-box').scrollTop=9999;
        }
        function userMsg(t){const d=document.createElement('div');d.className="flex justify-start";d.innerHTML=`<div class="bg-primary text-white px-3 py-2 rounded-xl rounded-tr-none shadow-sm text-xs max-w-[85%]">${t}</div>`;document.getElementById('chat-box').appendChild(d);document.getElementById('chat-box').scrollTop=9999}

        // --- Admin Panel ---
        window.loadAdmin=(id,n,uid,isVerifyReq)=>{
            state.activeAdminChat=id; state.activeAdminUser=uid;
            // Header with Buttons
            let btns = `<button onclick="kickUser()" class="bg-red-600 text-white text-[10px] px-2 py-1 rounded">Ø¥Ù†Ù‡Ø§Ø¡</button>`;
            if(isVerifyReq) {
                btns = `
                <div class="flex gap-1">
                    <button onclick="verifyUser('${uid}')" class="bg-green-500 text-white text-[10px] font-bold px-2 py-1 rounded flex gap-1 items-center"><i data-lucide="check" class="w-3 h-3"></i> Ù‚Ø¨ÙˆÙ„</button>
                    <button onclick="rejectVerify()" class="bg-red-500 text-white text-[10px] font-bold px-2 py-1 rounded flex gap-1 items-center"><i data-lucide="x" class="w-3 h-3"></i> Ø±ÙØ¶</button>
                </div> ` + btns;
            }
            document.getElementById('admin-chat-header').innerHTML=`<span>${n}</span>${btns}`;
            document.getElementById('btn-end-chat').classList.remove('hidden');
            
            onSnapshot(doc(db,"chats",id),s=>{
                const b=document.getElementById('admin-msg-area');b.innerHTML='';if(!s.exists())return;
                s.data().messages.forEach(m=>{b.innerHTML+=`<div class="${m.s==='support'?'text-left':'text-right'} mb-2"><span class="inline-block px-3 py-2 rounded-lg text-xs ${m.s==='support'?'bg-primary text-white':'bg-white/10'}">${m.t}</span></div>`});
                b.scrollTop=9999; lucide.createIcons();
            })
        };

        window.refreshAdmin=()=>{
            onSnapshot(query(collection(db,"chats"),where('status','!=','closed')),s=>{
                const l=document.getElementById('admin-users-list');l.innerHTML='';
                s.forEach(d=>{
                    const dt=d.data(); const isVerify = dt.status === 'verification_request';
                    l.innerHTML+=`<div onclick="loadAdmin('${d.id}','${dt.userName}','${dt.userId}', ${isVerify})" class="p-3 mb-2 bg-white/5 rounded-xl cursor-pointer border ${isVerify?'border-primary/50':'border-white/10'}"><div class="font-bold text-xs text-white flex justify-between"><span>${dt.userName}</span>${isVerify?'<span class="text-primary text-[9px]">Ø·Ù„Ø¨ ØªÙˆØ«ÙŠÙ‚</span>':''}</div><div class="text-[10px] text-gray-400 truncate mt-1">${dt.lastMsg}</div></div>`
                })
            })
        };

        // Verify Logic
        window.verifyUser = async (uid) => {
            if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªÙˆØ«ÙŠÙ‚ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ')) return;
            await setDoc(doc(db, "users", uid), { isTrusted: true }, { merge: true });
            const q = query(collection(db, "listings"), where("authorId", "==", uid));
            const snap = await getDocs(q);
            const batch = writeBatch(db);
            snap.forEach(doc => { batch.update(doc.ref, { authorTrusted: true }); });
            await batch.commit();
            sendAdminMsg("ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨ Ø§Ù„ØªÙˆØ«ÙŠÙ‚ âœ…. Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø¢Ù† Ù…ÙˆØ«ÙˆÙ‚.");
            await updateDoc(doc(db,"chats",state.activeAdminChat),{status:'active'});
            alert("ØªÙ… Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª");
        };

        window.rejectVerify = async () => {
            sendAdminMsg("Ø¹Ø°Ø±Ø§Ù‹ØŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ù„Ø¹Ø¯Ù… Ø§Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ø´Ø±ÙˆØ·.");
            await updateDoc(doc(db,"chats",state.activeAdminChat),{status:'active'});
        };

        window.sendAdminMsg=async()=>{const t=document.getElementById('admin-input').value;if(!t||!state.activeAdminChat)return;document.getElementById('admin-input').value='';const s=await getDocs(query(collection(db,"chats"),where('__name__','==',state.activeAdminChat)));const m=s.docs[0].data().messages;m.push({s:'support',t,d:new Date()});await updateDoc(doc(db,"chats",state.activeAdminChat),{messages:m,status:'active'})};
        window.kickUser=async()=>{if(confirm("Ø¥Ù†Ù‡Ø§Ø¡ØŸ")){await updateDoc(doc(db,"chats",state.activeAdminChat),{status:'closed'});document.getElementById('admin-msg-area').innerHTML='';document.getElementById('btn-end-chat').classList.add('hidden');state.activeAdminChat=null}};
        window.del=async(e,id)=>{e.stopPropagation();if(confirm('Ø­Ø°ÙØŸ')){await deleteDoc(doc(db,"listings",id));showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù')}};
        window.toggleStatus=async(e,id,c)=>{e.stopPropagation();let n=c==='available'?'sold':'available';await updateDoc(doc(db,"listings",id),{status:n});showToast('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„')};
        window.closeDetails=()=>{toggleModal('details-modal');state.currentItem=null;const u=new URL(window.location);u.searchParams.delete('product_id');window.history.replaceState({},'',u)};
        window.closeLightbox=()=>{document.getElementById('lightbox').classList.add('hidden');state.lightboxImages=[]};
        window.scrollDetails=d=>{if(state.detailsSliderImages.length<=1)return;goToDetailsSlide(state.detailsSliderIndex-d)};
        function goToDetailsSlide(i){const t=state.detailsSliderImages.length;if(t===0)return;if(i<0)i=t-1;if(i>=t)i=0;state.detailsSliderIndex=i;document.getElementById('details-img').src=state.detailsSliderImages[i];updateSliderDots()}
        function updateSliderDots(){if(state.detailsSliderImages.length<=1)return;document.getElementById('details-dots').innerHTML=state.detailsSliderImages.map((_,x)=>`<span class="w-2 h-2 rounded-full transition-all ${x===state.detailsSliderIndex?'bg-white w-4':'bg-white/40'}"></span>`).join('')}
        window.openLightbox=s=>{if(!s)return;state.lightboxImages=state.detailsSliderImages.length?state.detailsSliderImages:[s];state.lightboxIndex=state.lightboxImages.indexOf(s);if(state.lightboxIndex===-1)state.lightboxIndex=0;document.getElementById('lightbox-img').src=state.lightboxImages[state.lightboxIndex];document.getElementById('lightbox').classList.remove('hidden')}
        window.navigateLightbox=d=>{if(!state.lightboxImages.length)return;state.lightboxIndex+=d;if(state.lightboxIndex>=state.lightboxImages.length)state.lightboxIndex=0;else if(state.lightboxIndex<0)state.lightboxIndex=state.lightboxImages.length-1;document.getElementById('lightbox-img').src=state.lightboxImages[state.lightboxIndex]};
        function toggleModal(id){const m=document.getElementById(id);m.classList.toggle('hidden');if(!m.classList.contains('hidden'))document.body.classList.add('overflow-hidden');else document.body.classList.remove('overflow-hidden');return !m.classList.contains('hidden')}
        window.handleUpload=async(input)=>{if(input.files.length+state.images.length>7)return showToast('7 ØµÙˆØ± Ø¨Ø­Ø¯ Ø£Ù‚ØµÙ‰','e');for(let f of input.files){const c=await compress(f);state.images.push(c);document.getElementById('preview-area').innerHTML+=`<img src="${c}" class="w-14 h-14 rounded-xl object-cover border border-gray-200 shrink-0">`}}; 
        function compress(f){return new Promise(r=>{const d=new FileReader();d.readAsDataURL(f);d.onload=e=>{const i=new Image();i.src=e.target.result;i.onload=()=>{const c=document.createElement('canvas');const x=c.getContext('2d');const s=800/i.width;c.width=800;c.height=i.height*s;x.drawImage(i,0,0,c.width,c.height);r(c.toDataURL('image/jpeg',0.6))}}})};
        document.getElementById('logo-trigger').addEventListener('click',()=>{if(prompt('Code:')==='1532'){localStorage.setItem('souq_admin','true');state.isAdmin=true;document.getElementById('btn-admin-top').classList.remove('hidden');renderView();showToast('Admin Mode')}});
        window.showToast=(m,t='s')=>{const d=document.createElement('div');d.className=`toast fixed top-4 left-1/2 -translate-x-1/2 bg-white dark:bg-slate-800 shadow-xl px-4 py-2 rounded-lg border border-${t==='e'?'red':'primary'}-500 flex items-center gap-2 text-xs font-bold z-[250] text-slate-800 dark:text-white`;d.innerHTML=`<i data-lucide="${t==='e'?'alert-circle':'check-circle'}" class="w-4 h-4 text-${t==='e'?'red':'primary'}-500"></i> ${m}`;document.getElementById('toast-container').appendChild(d);lucide.createIcons();setTimeout(()=>{d.classList.add('hiding');setTimeout(()=>d.remove(),300)},3000)};
        function normalizeText(t){return t.replace(/[Ø£Ø¥Ø¢]/g,'Ø§').replace(/Ø©/g,'Ù‡').replace(/Ù‰/g,'ÙŠ').toLowerCase()}
        function showSkeletons(){const c=document.getElementById('grid-container');c.innerHTML='';for(let i=0;i<8;i++)c.innerHTML+=`<div class="bg-white dark:bg-slate-800 rounded-lg overflow-hidden shadow-sm border-2 border-slate-200 dark:border-slate-700 h-full"><div class="h-32 skeleton"></div><div class="p-2 space-y-2"><div class="h-4 rounded skeleton w-3/4"></div><div class="h-3 rounded skeleton w-1/2"></div></div></div>`}
        
        lucide.createIcons();
    </script>
</body>
</html>