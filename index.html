<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Smart Center Pro | System</title>

    <!-- ุงูููุชุจุงุช -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f1f5f9; padding-bottom: 80px; font-size: 12px; -webkit-tap-highlight-color: transparent; }
        .nav-item { transition: all 0.2s; opacity: 0.7; border-bottom: 3px solid transparent; }
        .nav-item.active { opacity: 1; background: white; color: #1e3a8a; font-weight: 700; border-bottom-color: #fbbf24; transform: translateY(-2px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tab-content { display: none; animation: fadeIn 0.2s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .scanner-wrapper { border-radius: 0.75rem; overflow: hidden; background: black; position: relative; }
        #html5-qrcode-button-camera-stop { display: none !important; }
        .glass-card { background: white; border-radius: 0.5rem; padding: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; margin-bottom: 0.5rem; }
        .custom-table { width: 100%; border-collapse: collapse; font-size: 10px; table-layout: fixed; }
        .custom-table thead { background-color: #f8fafc; color: #1e293b; font-weight: 700; border-bottom: 2px solid #e2e8f0; }
        .custom-table th, .custom-table td { padding: 8px 4px; border-bottom: 1px solid #e2e8f0; text-align: right; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .custom-table tr:last-child td { border-bottom: none; }
        .custom-table tbody tr:hover { background-color: #f1f5f9; }
        .col-index { width: 30px; text-align: center; color: #64748b; }
        .toggle-btn-active { background-color: #ffffff; color: #1d4ed8; box-shadow: 0 1px 2px rgba(0,0,0,0.1); font-weight: 700; }
        .toggle-btn-inactive { background-color: transparent; color: #6b7280; }
        #loadingOverlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; font-weight: bold; color: #1e3a8a; }
        
        /* Login Styles */
        #loginOverlay { position: fixed; inset: 0; background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%); z-index: 100000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-card { background: rgba(255, 255, 255, 0.95); width: 100%; max-width: 380px; border-radius: 20px; padding: 30px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); text-align: center; }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #cbd5e1; border-radius: 10px; font-size: 14px; outline: none; transition: all 0.3s; }
        .login-input:focus { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .login-btn { width: 100%; padding: 12px; background: #1e3a8a; color: white; border-radius: 10px; font-weight: bold; font-size: 14px; transition: transform 0.1s; }
        .login-btn:active { transform: scale(0.98); }
        .login-tab { flex: 1; padding: 10px; cursor: pointer; font-weight: bold; border-bottom: 3px solid transparent; color: #64748b; transition: all 0.3s; }
        .login-tab.active { color: #1e3a8a; border-bottom-color: #1e3a8a; background: #f1f5f9; border-radius: 5px 5px 0 0; }

        /* Formal Schedule Table */
        .schedule-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 10px; }
        .schedule-table thead { background-color: #1e3a8a; color: white; }
        .schedule-table th, .schedule-table td { padding: 10px; border: 1px solid #cbd5e1; text-align: center; }
        .schedule-table tbody tr:nth-child(even) { background-color: #f8fafc; }
        
        /* Student Dashboard Specifics */
        .std-dash-card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .std-info-row { display: flex; justify-content: space-between; border-bottom: 1px solid #f1f5f9; padding: 8px 0; font-size: 11px; }
        .std-info-label { color: #64748b; font-weight: 600; }
        .std-info-val { color: #0f172a; font-weight: 700; }

        /* Print Styles */
        #print-container { display: none; }
        @media print {
            body > *:not(#print-container) { display: none !important; }
            #print-container { display: block !important; position: absolute; top: 0; left: 0; width: 100%; background: white; padding: 20px; font-size: 11pt; color: black; }
            #print-container table { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: auto !important; }
            #print-container th, #print-container td { border: 1px solid #000; padding: 8px; text-align: center; font-size: 10pt; }
            #print-container th { background-color: #f0f0f0 !important; font-weight: bold; -webkit-print-color-adjust: exact; }
            .print-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
            .print-logo { font-size: 24px; font-weight: bold; color: #1e3a8a; }
            .no-print-in-paper { display: none !important; }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- LOGIN OVERLAY -->
    <div id="loginOverlay">
        <div class="login-card">
            <div class="mb-6">
                <h1 class="text-3xl font-black text-blue-900 mb-1">๐ Smart Center</h1>
                <p class="text-gray-500 text-xs font-bold">ูุธุงู ุงูุฅุฏุงุฑุฉ ุงูุชุนูููู ุงููุชุทูุฑ</p>
            </div>
            
            <div class="flex border-b mb-6">
                <div onclick="setLoginMode('admin')" id="tabAdmin" class="login-tab active">ุงูุฅุฏุงุฑุฉ</div>
                <div onclick="setLoginMode('student')" id="tabStudent" class="login-tab">ุงูุทุงูุจ</div>
            </div>

            <div id="loginForm">
                <input type="text" id="loginCode" class="login-input" placeholder="ููุฏ ุงูุฏุฎูู">
                <input type="password" id="loginPass" class="login-input" placeholder="ูููุฉ ุงููุฑูุฑ">
                <button onclick="handleLogin()" class="login-btn shadow-lg shadow-blue-900/30">ุชุณุฌูู ุงูุฏุฎูู</button>
            </div>
            <p id="loginError" class="text-red-500 text-xs mt-3 hidden font-bold bg-red-50 p-2 rounded">ุจูุงูุงุช ุงูุฏุฎูู ุบูุฑ ุตุญูุญุฉ</p>
        </div>
    </div>

    <div id="loadingOverlay" class="hidden">
        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-900 mb-4"></div>
        <div class="text-lg">ุฌุงุฑู ุชุญููู ุงููุธุงู...</div>
    </div>

    <div id="print-container"></div>

    <!-- APP CONTENT -->
    <div id="appContent" class="hidden">
        <header class="bg-blue-900 text-white shadow-md sticky top-0 z-50 no-print">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <h1 class="text-base font-bold flex items-center gap-2">๐ Smart Center <span class="text-[9px] bg-green-500 px-1.5 py-0.5 rounded text-white">Cloud</span></h1>
                <div class="flex items-center gap-3">
                    <div class="text-[10px] bg-blue-800 px-3 py-1 rounded-full font-mono border border-blue-700" id="headerDate">--/--/----</div>
                    <button onclick="logout()" class="text-[10px] bg-red-600 px-3 py-1 rounded font-bold hover:bg-red-700 transition">ุฎุฑูุฌ</button>
                </div>
            </div>
            <div class="bg-blue-800 border-t border-blue-700" id="navBar">
                <div class="container mx-auto px-2">
                    <div class="flex gap-1 overflow-x-auto py-2 no-scrollbar">
                        <button onclick="showTab('students', this)" class="nav-item active px-4 py-1.5 rounded text-xs text-blue-100 flex-shrink-0">ุงูุทูุงุจ</button>
                        <button onclick="showTab('attendance', this)" class="nav-item px-4 py-1.5 rounded text-xs text-blue-100 flex-shrink-0">ุงูุญุถูุฑ</button>
                        <button onclick="showTab('accounting', this)" class="nav-item px-4 py-1.5 rounded text-xs text-blue-100 flex-shrink-0">ุงููุญุงุณุจุฉ</button>
                        <button onclick="showTab('reports', this)" class="nav-item px-4 py-1.5 rounded text-xs text-blue-100 flex-shrink-0">ุงูุชูุงุฑูุฑ</button>
                    </div>
                </div>
            </div>
        </header>

        <main id="mainContent" class="container mx-auto p-3 max-w-4xl">

            <!-- STUDENT DASHBOARD (Formal Design) -->
            <section id="studentDashboard" class="tab-content">
                <div class="grid md:grid-cols-3 gap-4">
                    <!-- Profile Card -->
                    <div class="std-dash-card text-center md:col-span-1 border-t-4 border-blue-600">
                        <div class="mb-3 relative inline-block">
                            <div id="dashQr" class="p-2 bg-white border rounded-lg"></div>
                        </div>
                        <h2 class="text-xl font-bold text-blue-900" id="dashName"></h2>
                        <p class="text-gray-500 font-mono text-lg font-bold mb-2" id="dashCode"></p>
                        <div class="bg-blue-50 rounded-lg p-2 text-xs text-blue-800 font-bold mb-2" id="dashLevel"></div>
                        
                        <div class="grid grid-cols-2 gap-2 mt-4">
                            <div class="bg-green-50 p-2 rounded border border-green-100">
                                <div class="text-2xl font-bold text-green-600" id="dashPresent">0</div>
                                <div class="text-[10px] text-green-800">ุฃูุงู ุงูุญุถูุฑ</div>
                            </div>
                            <div class="bg-red-50 p-2 rounded border border-red-100">
                                <div class="text-2xl font-bold text-red-600" id="dashAbsent">0</div>
                                <div class="text-[10px] text-red-800">ุฃูุงู ุงูุบูุงุจ</div>
                            </div>
                        </div>
                    </div>

                    <!-- Details & Schedule -->
                    <div class="md:col-span-2 space-y-4">
                        <div class="std-dash-card">
                            <h3 class="font-bold text-sm text-gray-800 border-b pb-2 mb-2 flex items-center gap-2">๐ ุจูุงูุงุช ุงูุงุดุชุฑุงู</h3>
                            <div class="std-info-row"><span class="std-info-label">ุชุงุฑูุฎ ุงูุงูุถูุงู</span><span class="std-info-val" id="dashJoinDate"></span></div>
                            <div class="std-info-row"><span class="std-info-label">ูุฏุฉ ุงูุงุดุชุฑุงู</span><span class="std-info-val" id="dashDuration"></span></div>
                            <div class="std-info-row"><span class="std-info-label">ุฅุฌูุงูู ุงููุฏููุนุงุช</span><span class="std-info-val text-green-600" id="dashPaymentsTotal"></span></div>
                        </div>

                        <div class="std-dash-card">
                            <h3 class="font-bold text-sm text-gray-800 border-b pb-2 mb-2">๐ ุฌุฏูู ุงูุญุตุต</h3>
                            <div id="dashScheduleList" class="flex flex-wrap gap-2"></div>
                        </div>

                        <div class="std-dash-card">
                            <h3 class="font-bold text-sm text-gray-800 border-b pb-2 mb-2">๐ ุณุฌู ุงูุญุถูุฑ ูุงูุบูุงุจ</h3>
                            <div id="dashHistory" class="max-h-48 overflow-y-auto pr-1 space-y-1"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- STUDENTS TAB (Admin) -->
            <section id="students" class="tab-content active">
                <div class="glass-card border-r-4 border-blue-500 no-print">
                    <h2 class="font-bold text-blue-900 mb-2 text-xs">ุชุณุฌูู ุทุงูุจ ุฌุฏูุฏ</h2>
                    <div class="space-y-2">
                        <input type="text" id="stdName" class="w-full p-2 border rounded text-xs focus:ring-1 focus:ring-blue-500 outline-none" placeholder="ุงุณู ุงูุทุงูุจ ุฑุจุงุนู">
                        <div class="flex items-center border rounded bg-white overflow-hidden">
                            <span class="bg-gray-100 px-3 py-2 text-gray-600 text-[10px] font-bold border-l">+20</span>
                            <input type="tel" id="stdPhone" class="w-full p-2 text-xs outline-none" placeholder="ุฑูู ููู ุงูุฃูุฑ">
                        </div>
                        <select id="stdLevel" class="w-full p-2 border rounded bg-white text-xs">
                            <option value="">ุงุฎุชุฑ ุงููุฑุญูุฉ...</option>
                            <optgroup label="ุงูุงุจุชุฏุงุฆูุฉ"><option value="1ุจ">1ุจ</option><option value="2ุจ">2ุจ</option><option value="3ุจ">3ุจ</option><option value="4ุจ">4ุจ</option><option value="5ุจ">5ุจ</option><option value="6ุจ">6ุจ</option></optgroup>
                            <optgroup label="ุงูุฅุนุฏุงุฏูุฉ"><option value="1ุน">1ุน</option><option value="2ุน">2ุน</option><option value="3ุน">3ุน</option></optgroup>
                            <optgroup label="ุงูุซุงูููุฉ"><option value="1ุซ">1ุซ</option><option value="2ุซ">2ุซ</option><option value="3ุซ">3ุซ</option></optgroup>
                        </select>
                        <button onclick="registerStudent()" class="w-full bg-blue-600 text-white py-2 rounded font-bold shadow hover:bg-blue-700 text-xs transition">ุญูุธ ูุฅูุดุงุก ุญุณุงุจ</button>
                    </div>
                </div>
                <div class="glass-card">
                    <div class="flex justify-between items-center mb-2 no-print">
                        <h2 class="font-bold text-xs">ุงูุทูุงุจ (<span id="stdCount">0</span>)</h2>
                        <div class="flex gap-2">
                            <input type="text" id="searchStd" onkeyup="renderStudents()" placeholder="ุจุญุซ (ุงูุงุณู/ุงูููุฏ)..." class="text-[10px] p-1.5 border rounded w-32 focus:w-48 transition-all">
                            <button onclick="printContent('studentsListArea', 'ูุงุฆูุฉ ุงูุทูุงุจ ุงููุณุฌููู')" class="bg-gray-800 text-white px-2 py-1 rounded text-[10px]">๐จ๏ธ ุทุจุงุนุฉ</button>
                        </div>
                    </div>
                    <div id="studentsListArea" class="overflow-x-auto">
                        <table class="custom-table">
                            <thead><tr><th class="col-index">ู</th><th class="col-code">ุงูููุฏ</th><th>ุงูุงุณู</th><th>ุงููุฑุญูุฉ</th><th class="col-date">ุชุงุฑูุฎ</th><th class="no-print col-action">ุญุฐู</th></tr></thead>
                            <tbody id="studentsTable"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ATTENDANCE TAB (Admin) -->
            <section id="attendance" class="tab-content">
                <div class="glass-card text-center">
                    <h2 class="text-sm font-bold text-blue-900 mb-2">ุณุฌู ุงูุญุถูุฑ</h2>
                    <div class="mb-2 bg-blue-50 p-2 rounded border border-blue-200">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-[9px] text-blue-800 font-bold block mb-1">ุชุงุฑูุฎ ุงูููู</label>
                                <input type="date" id="attendanceDate" onchange="changeAttendanceDate()" class="w-full p-1.5 border rounded text-center font-bold text-blue-900 text-xs">
                            </div>
                            <div>
                                <label class="text-[9px] text-blue-800 font-bold block mb-1">ุงููุฑุญูุฉ (ูุงู)</label>
                                <select id="attendanceStage" onchange="updateCounters()" class="w-full p-1.5 border rounded text-center font-bold text-blue-900 text-xs">
                                    <option value="">-- ุงุฎุชุฑ ุงููุฑุญูุฉ --</option>
                                    <optgroup label="ุงูุงุจุชุฏุงุฆูุฉ"><option value="1ุจ">1ุจ</option><option value="2ุจ">2ุจ</option><option value="3ุจ">3ุจ</option><option value="4ุจ">4ุจ</option><option value="5ุจ">5ุจ</option><option value="6ุจ">6ุจ</option></optgroup>
                                    <optgroup label="ุงูุฅุนุฏุงุฏูุฉ"><option value="1ุน">1ุน</option><option value="2ุน">2ุน</option><option value="3ุน">3ุน</option></optgroup>
                                    <optgroup label="ุงูุซุงูููุฉ"><option value="1ุซ">1ุซ</option><option value="2ุซ">2ุซ</option><option value="3ุซ">3ุซ</option></optgroup>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-2 no-print">
                        <button onclick="openScheduleModal()" class="bg-purple-100 text-purple-800 border border-purple-300 py-1.5 rounded font-bold text-[10px] hover:bg-purple-200">๐ ุฅุนุฏุงุฏ ุงูุฌุฏูู</button>
                        <button onclick="confirmSessionDay()" class="bg-indigo-100 text-indigo-800 border border-indigo-300 py-1.5 rounded font-bold text-[10px] hover:bg-indigo-200">โ ุชุซุจูุช ุงุณุชุซูุงุฆู</button>
                    </div>
                    <div class="flex bg-gray-100 p-1 rounded mb-2 no-print">
                        <button onclick="setAttMode('scan')" id="btnAttScan" class="flex-1 py-1.5 rounded text-[10px] toggle-btn-active transition-all">๐ท ูุงููุฑุง</button>
                        <button onclick="setAttMode('manual')" id="btnAttManual" class="flex-1 py-1.5 rounded text-[10px] toggle-btn-inactive transition-all">โจ๏ธ ูุฏูู</button>
                    </div>
                    <div id="attScanArea" class="relative">
                        <div id="reader" class="scanner-wrapper h-48 w-full mb-2"></div>
                        <div id="scanFeedback" class="absolute inset-0 flex items-center justify-center bg-green-500/90 hidden z-10 rounded-lg"><div class="text-white font-bold text-lg animate-bounce">โ ุชู ุงูุชุณุฌูู</div></div>
                        <div class="flex justify-center gap-2 no-print">
                            <button onclick="startScanner('reader', 'attendance')" class="bg-blue-600 text-white px-4 py-1.5 rounded shadow text-[10px]">ุชุดุบูู</button>
                            <button onclick="stopScanner()" class="bg-red-100 text-red-600 px-4 py-1.5 rounded text-[10px]">ุฅููุงู</button>
                        </div>
                    </div>
                    <div id="attManualArea" class="hidden">
                        <input type="number" id="manualAttID" placeholder="ุงูููุฏ" class="w-full text-center text-xl font-bold p-2 border-2 border-blue-200 rounded mb-2 font-mono">
                        <button onclick="manualAttendance()" class="w-full bg-blue-600 text-white py-2 rounded font-bold text-xs">ุชุณุฌูู</button>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-3 no-print">
                        <div onclick="openAttendanceModal('present')" class="bg-green-50 p-2 rounded border border-green-200 cursor-pointer hover:bg-green-100 transition">
                            <span class="block text-lg font-bold text-green-600" id="presentCount">0</span>
                            <span class="text-[10px] text-green-800 font-bold">ุญุถูุฑ</span>
                        </div>
                        <div onclick="openAttendanceModal('absent')" class="bg-red-50 p-2 rounded border border-red-200 cursor-pointer hover:bg-red-100 transition">
                            <span class="block text-lg font-bold text-red-600" id="absentCount">0</span>
                            <span class="text-[10px] text-red-800 font-bold">ุบูุงุจ</span>
                        </div>
                    </div>

                    <!-- Formal Schedule Table -->
                    <div class="mt-6 border-t pt-4" id="formalScheduleContainer">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-sm text-blue-900">ุฌุฏูู ุงูุญุตุต ุงูุฑุณูู</h3>
                            <div class="flex gap-2">
                                <button onclick="printFormalSchedule()" class="bg-gray-800 text-white px-2 py-1 rounded text-[10px]">๐จ๏ธ ุทุจุงุนุฉ</button>
                                <button onclick="pdfFormalSchedule()" class="bg-red-600 text-white px-2 py-1 rounded text-[10px]">๐ PDF</button>
                            </div>
                        </div>
                        <div id="formalSchedulePrintArea" class="overflow-x-auto rounded border border-gray-200 bg-white p-2">
                            <div class="hidden print-only-header text-center mb-4">
                                <h1 class="text-xl font-bold text-blue-900">Smart Center</h1>
                                <p class="text-sm text-gray-500">ุฌุฏูู ุงูููุงุนูุฏ ุงูุฑุณูู</p>
                            </div>
                            <table class="schedule-table">
                                <thead>
                                    <tr>
                                        <th>ุงููุฑุญูุฉ</th>
                                        <th>ุฃูุงู ุงูุญุถูุฑ</th>
                                        <th class="no-print">ุฃุฌูุฏุฉ ุงูุดูุฑ</th>
                                    </tr>
                                </thead>
                                <tbody id="formalScheduleBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ACCOUNTING TAB (Admin) -->
            <section id="accounting" class="tab-content">
                <div class="grid md:grid-cols-2 gap-2">
                    <div class="glass-card border-t-4 border-green-500">
                        <h3 class="font-bold text-green-700 mb-2 text-xs">๐ต ุงุณุชูุงู ููุฏูุฉ</h3>
                        <div class="flex gap-2 mb-2 no-print">
                            <button onclick="togglePayMethod('scan')" id="btnPayScan" class="flex-1 py-1 rounded text-[10px] font-bold toggle-btn-active">ุจุงุฑููุฏ</button>
                            <button onclick="togglePayMethod('manual')" id="btnPayManual" class="flex-1 py-1 rounded text-[10px] font-bold toggle-btn-inactive">ููุฏ</button>
                        </div>
                        <div id="payScanDiv" class="mb-2">
                            <div id="payReader" class="scanner-wrapper h-24 mb-2"></div>
                            <button onclick="startScanner('payReader', 'payment')" class="w-full bg-green-600 text-white py-1 rounded text-[10px] no-print">ุชุดุบูู</button>
                        </div>
                        <div id="payManualDiv" class="hidden flex gap-2 mb-2">
                            <input type="number" id="paySearchID" placeholder="ููุฏ ุงูุทุงูุจ" class="flex-1 p-1 border rounded text-center font-bold text-xs">
                            <button onclick="searchStudentForPay()" class="bg-green-600 text-white px-2 rounded text-xs">๐</button>
                        </div>
                        <div id="paymentForm" class="hidden bg-yellow-50 p-2 rounded border border-yellow-200">
                            <div class="flex justify-between text-[10px] mb-1 font-bold"><span id="payStdName"></span><span id="payStdID" class="font-mono bg-white px-1 rounded"></span></div>
                            <div class="flex gap-1 mb-1">
                                <input type="number" id="payAmount" value="100" class="w-1/3 p-1 border rounded text-center font-bold text-xs">
                                <select id="payType" class="w-2/3 p-1 border rounded text-[10px]"><option value="ุดูุฑูุฉ">ุงุดุชุฑุงู</option><option value="ูุฐูุฑุฉ">ูุฐูุฑุฉ</option><option value="ุฃุฎุฑู">ุฃุฎุฑู</option></select>
                            </div>
                            <button onclick="confirmPayment()" class="w-full bg-green-600 text-white py-1 rounded font-bold shadow text-[10px]">ุชุฃููุฏ</button>
                        </div>
                    </div>
                    <div class="glass-card border-t-4 border-red-500">
                        <h3 class="font-bold text-red-700 mb-2 text-xs">๐ ูุตุฑููุงุช</h3>
                        <div class="space-y-2">
                            <select id="expType" class="w-full p-1 border rounded text-[10px] bg-white"><option value="">ุงูุจูุฏ...</option><option value="ุฑูุงุชุจ">ุฑูุงุชุจ</option><option value="ููุฑุจุงุก">ููุฑุจุงุก</option><option value="ุฅูุฌุงุฑ">ุฅูุฌุงุฑ</option><option value="ุตูุงูุฉ">ุตูุงูุฉ</option><option value="ุทุจุงุนุฉ">ุทุจุงุนุฉ</option><option value="ุจูููู">ุจูููู</option><option value="ูุซุฑูุงุช">ูุซุฑูุงุช</option></select>
                            <div class="flex gap-2"><input type="number" id="expAmount" placeholder="ุงููุจูุบ" class="flex-1 p-1 border rounded text-[10px]"><input type="text" id="expNote" placeholder="ููุงุญุธุฉ" class="flex-[1.5] p-1 border rounded text-[10px]"></div>
                            <button onclick="addExpense()" class="w-full bg-red-50 text-red-600 border border-red-200 py-1 rounded font-bold hover:bg-red-100 text-[10px]">ุชุณุฌูู</button>
                        </div>
                    </div>
                </div>
                <div class="bg-slate-800 text-white p-3 rounded-xl shadow-lg mt-2">
                    <div class="flex justify-between items-end mb-2">
                        <div><p class="text-[10px] opacity-70">ุงูุตุงูู</p><p class="text-xl font-bold" id="netProfit">0</p></div>
                        <div class="text-left text-[10px]"><div class="text-green-400">ูุงุฑุฏ: <span id="totalRev">0</span></div><div class="text-red-400">ุตุงุฏุฑ: <span id="totalExp">0</span></div></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="bg-white/10 p-1.5 rounded"><h4 class="text-[10px] font-bold text-green-300 mb-1 border-b border-white/20">ุฅูุฑุงุฏุงุช ุงูููู</h4><div id="todayRevList" class="h-20 overflow-y-auto text-[9px] space-y-1"></div></div>
                        <div class="bg-white/10 p-1.5 rounded"><h4 class="text-[10px] font-bold text-red-300 mb-1 border-b border-white/20">ูุตุฑููุงุช ุงูููู</h4><div id="todayExpList" class="h-20 overflow-y-auto text-[9px] space-y-1"></div></div>
                    </div>
                    <button onclick="printFinancialReport()" class="w-full mt-2 bg-white/20 text-white py-1 rounded text-[10px] hover:bg-white/30">๐จ๏ธ ุทุจุงุนุฉ ุชูุฑูุฑ ุงูููู</button>
                </div>
            </section>

            <!-- REPORTS TAB (Admin) -->
            <section id="reports" class="tab-content">
                <div class="glass-card border-t-4 border-blue-600 mb-2">
                    <h3 class="font-bold mb-2 text-blue-900 flex items-center gap-2 text-xs"><span>๐ค</span> ุจุญุซ ุทุงูุจ</h3>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="reportStudentSearch" placeholder="ุงุณู/ููุฏ" class="flex-1 p-1 border rounded text-xs">
                        <button onclick="generateStudentReport()" class="bg-blue-600 text-white px-3 rounded font-bold text-[10px]">ุจุญุซ</button>
                    </div>
                    <div id="studentReportResult" class="hidden bg-gray-50 p-2 rounded border border-gray-200 text-[10px]"></div>
                </div>
                <div class="glass-card border-t-4 border-indigo-500 mb-2">
                    <h3 class="font-bold mb-2 text-indigo-900 text-xs">๐ ุชูุงุฑูุฑ ุนุงูุฉ</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
                        <div><label class="text-[9px] text-gray-500 block mb-1">ุงูููุน</label><select id="reportType" onchange="toggleReportInputs()" class="w-full p-1 border rounded bg-white text-[10px]"><option value="daily">ูููู</option><option value="monthly">ุดูุฑู</option></select></div>
                        <div><label class="text-[9px] text-gray-500 block mb-1">ุงููุฑุญูุฉ</label><select id="reportStage" class="w-full p-1 border rounded bg-white text-[10px]"><option value="all">ุงููู</option><optgroup label="ุงูุงุจุชุฏุงุฆูุฉ"><option value="1ุจ">1ุจ</option><option value="2ุจ">2ุจ</option><option value="3ุจ">3ุจ</option><option value="4ุจ">4ุจ</option><option value="5ุจ">5ุจ</option><option value="6ุจ">6ุจ</option></optgroup><optgroup label="ุงูุฅุนุฏุงุฏูุฉ"><option value="1ุน">1ุน</option><option value="2ุน">2ุน</option><option value="3ุน">3ุน</option></optgroup><optgroup label="ุงูุซุงูููุฉ"><option value="1ุซ">1ุซ</option><option value="2ุซ">2ุซ</option><option value="3ุซ">3ุซ</option></optgroup></select></div>
                        <div id="divDateInput"><label class="text-[9px] text-gray-500 block mb-1">ุงูููู</label><input type="date" id="reportDate" class="w-full p-1 border rounded text-[10px]"></div>
                        <div id="divMonthInput" class="hidden"><label class="text-[9px] text-gray-500 block mb-1">ุงูุดูุฑ</label><input type="month" id="reportMonth" class="w-full p-1 border rounded text-[10px]"></div>
                    </div>
                    <button onclick="generateAdvancedReport()" class="w-full bg-indigo-600 text-white py-1 rounded font-bold shadow hover:bg-indigo-700 text-[10px]">ุนุฑุถ</button>
                    <div id="reportResult" class="mt-2 hidden bg-gray-50 p-2 rounded border border-gray-200 text-[10px]"></div>
                </div>
                <div class="glass-card border-t-4 border-yellow-500">
                    <h3 class="font-bold mb-2 flex items-center gap-2 text-yellow-800 text-xs"><span>๐พ</span> ุงููุณุฎ ุงูุงุญุชูุงุทู</h3>
                    <div class="flex gap-2">
                        <button onclick="exportData()" class="flex-1 bg-yellow-100 text-yellow-800 py-1 rounded font-bold text-[10px] border border-yellow-300">ุชุญููู</button>
                        <div class="relative flex-1"><input type="file" id="importFile" onchange="importData(this)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"><button class="w-full bg-gray-100 text-gray-700 py-1 rounded font-bold text-[10px] border border-gray-300">ุงุณุชุนุงุฏุฉ</button></div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- MODALS -->
    <div id="scheduleModal" class="fixed inset-0 bg-black/80 hidden z-[200] flex items-center justify-center p-4 no-print">
        <div class="bg-white rounded-xl w-full max-w-md p-4 shadow-2xl h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-2"><h3 class="font-bold text-lg text-purple-900">๐ ุฅุนุฏุงุฏ ุฌุฏูู ุงูุญุตุต</h3><button onclick="closeModal('scheduleModal')" class="text-red-500 font-bold text-xl">&times;</button></div>
            <div class="overflow-y-auto flex-1 p-2 space-y-4" id="scheduleContainer"></div>
            <button onclick="saveSchedule()" class="w-full bg-purple-600 text-white py-2 rounded font-bold mt-2">ุญูุธ ุงูุชุบููุฑุงุช</button>
        </div>
    </div>

    <div id="monthlyScheduleModal" class="fixed inset-0 bg-black/80 hidden z-[210] flex items-center justify-center p-4 no-print">
        <div class="bg-white rounded-xl w-full max-w-sm p-4 shadow-2xl relative">
            <button onclick="closeModal('monthlyScheduleModal')" class="absolute top-2 right-3 text-gray-500 text-xl font-bold">&times;</button>
            <div id="monthlyScheduleCard">
                <div class="text-center border-b pb-2 mb-2"><h3 class="font-bold text-lg text-blue-900" id="msStageName"></h3><input type="month" id="msMonthInput" onchange="renderMonthlySchedule()" class="mt-1 p-1 border rounded text-xs"></div>
                <div id="msDatesList" class="max-h-60 overflow-y-auto text-sm space-y-1 p-2 border rounded bg-gray-50"></div>
            </div>
            <div class="grid grid-cols-2 gap-2 mt-3"><button onclick="printMonthlySchedule()" class="bg-gray-800 text-white py-1.5 rounded text-xs font-bold">๐จ๏ธ ุทุจุงุนุฉ</button><button onclick="pdfMonthlySchedule()" class="bg-red-600 text-white py-1.5 rounded text-xs font-bold">๐ PDF</button></div>
        </div>
    </div>

    <div id="studentModal" class="fixed inset-0 bg-black/80 hidden z-[150] flex items-center justify-center p-4 no-print">
        <div class="bg-white rounded-xl w-full max-w-xs p-4 text-center relative shadow-2xl">
            <button onclick="closeModal('studentModal')" class="absolute top-2 right-3 text-gray-500 text-xl font-bold">&times;</button>
            <div id="studentCardDisplay" class="border-4 border-double border-blue-200 p-3 rounded-xl bg-white mb-3">
                <h3 class="font-bold text-sm mb-1 text-blue-900">ุจุทุงูุฉ ุทุงูุจ</h3>
                <div id="modalQr" class="flex justify-center mb-1"></div>
                <p id="modalCode" class="text-xl font-black font-mono text-blue-600 mb-0"></p>
                <h2 id="modalName" class="text-base font-bold mb-0"></h2>
                <p id="modalLevel" class="text-gray-500 text-xs"></p>
                <div id="modalPasswordArea" class="mt-2 bg-yellow-50 p-1 rounded border border-yellow-200 hidden">
                    <p class="text-[9px] text-gray-500">ูููุฉ ุงููุฑูุฑ (ููุทุงูุจ)</p>
                    <p class="font-mono font-bold text-lg text-red-600" id="modalPassword"></p>
                </div>
                <p class="text-[9px] text-gray-400 mt-1">Smart Center</p>
            </div>
            <div class="grid grid-cols-2 gap-2"><button onclick="printStudentCard()" class="bg-gray-800 text-white py-1 rounded text-[10px] font-bold">๐จ๏ธ ุทุจุงุนุฉ</button><button onclick="shareStudentPdf()" class="bg-red-600 text-white py-1 rounded text-[10px] font-bold">๐ PDF</button></div>
        </div>
    </div>

    <div id="detailsModal" class="fixed inset-0 bg-black/80 hidden z-[100] flex items-center justify-center p-4 no-print">
        <div class="bg-white rounded-xl w-full max-w-xl p-0 h-[80vh] flex flex-col shadow-2xl overflow-hidden">
            <div class="flex justify-between items-center p-3 border-b bg-gray-50"><h3 id="detailsTitle" class="font-bold text-sm text-gray-800"></h3><div class="flex gap-2"><button onclick="printContent('detailsTableArea', document.getElementById('detailsTitle').innerText)" class="bg-gray-800 text-white px-2 py-1 rounded text-[10px]">๐จ๏ธ ุทุจุงุนุฉ</button><button onclick="closeModal('detailsModal')" class="text-red-500 font-bold text-lg">&times;</button></div></div>
            <div id="modalFilterContainer" class="p-2 bg-gray-100 border-b hidden"><select id="attFilterLevel" onchange="filterAttendanceList()" class="w-full p-1 border rounded bg-white text-[10px]"><option value="all">ูู ุงููุฑุงุญู</option><optgroup label="ุงูุงุจุชุฏุงุฆูุฉ"><option value="1ุจ">1ุจ</option><option value="2ุจ">2ุจ</option><option value="3ุจ">3ุจ</option><option value="4ุจ">4ุจ</option><option value="5ุจ">5ุจ</option><option value="6ุจ">6ุจ</option></optgroup><optgroup label="ุงูุฅุนุฏุงุฏูุฉ"><option value="1ุน">1ุน</option><option value="2ุน">2ุน</option><option value="3ุน">3ุน</option></optgroup><optgroup label="ุงูุซุงูููุฉ"><option value="1ุซ">1ุซ</option><option value="2ุซ">2ุซ</option><option value="3ุซ">3ุซ</option></optgroup></select></div>
            <div id="detailsTableArea" class="overflow-y-auto flex-1 p-0"><table class="custom-table"><thead id="detailsTableHead"></thead><tbody id="detailsTableBody"></tbody></table></div>
        </div>
    </div>

    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-xl z-[200] hidden font-bold text-xs"></div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, onSnapshot, query, where, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        const firebaseConfig = { apiKey: "AIzaSyAttesgksSJWs--veymN8PTRNHBX9r27V0", authDomain: "system-a8c1e.firebaseapp.com", projectId: "system-a8c1e", storageBucket: "system-a8c1e.firebasestorage.app", messagingSenderId: "674440908222", appId: "1:674440908222:web:31221baab0048ee8c63def" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);
        window.db = db; window.collection = collection; window.addDoc = addDoc; window.getDocs = getDocs; window.doc = doc; window.deleteDoc = deleteDoc; window.onSnapshot = onSnapshot; window.query = query; window.where = where; window.setDoc = setDoc;
        const loading = document.getElementById('loadingOverlay');
        
        // Load Data
        onSnapshot(collection(db, "students"), (snapshot) => { window.students = []; snapshot.forEach(doc => window.students.push({ ...doc.data(), docId: doc.id })); window.renderStudents(); loading.style.display = 'none'; });
        onSnapshot(collection(db, "attendance"), (snapshot) => { window.attendance = []; snapshot.forEach(doc => window.attendance.push({ ...doc.data(), docId: doc.id })); window.updateCounters(); window.renderFormalSchedule(); });
        onSnapshot(collection(db, "accounting"), (snapshot) => { window.accounting = []; snapshot.forEach(doc => window.accounting.push({ ...doc.data(), docId: doc.id })); window.updateFinance(); });
        onSnapshot(doc(db, "settings", "schedule"), (doc) => { if(doc.exists()) window.scheduleData = doc.data(); else window.scheduleData = {}; window.renderFormalSchedule(); });
    </script>

    <script>
        const stageMap = { "1ุจ": "ุงูุฃูู ุงูุงุจุชุฏุงุฆู", "2ุจ": "ุงูุซุงูู ุงูุงุจุชุฏุงุฆู", "3ุจ": "ุงูุซุงูุซ ุงูุงุจุชุฏุงุฆู", "4ุจ": "ุงูุฑุงุจุน ุงูุงุจุชุฏุงุฆู", "5ุจ": "ุงูุฎุงูุณ ุงูุงุจุชุฏุงุฆู", "6ุจ": "ุงูุณุงุฏุณ ุงูุงุจุชุฏุงุฆู", "1ุน": "ุงูุฃูู ุงูุฅุนุฏุงุฏู", "2ุน": "ุงูุซุงูู ุงูุฅุนุฏุงุฏู", "3ุน": "ุงูุซุงูุซ ุงูุฅุนุฏุงุฏู", "1ุซ": "ุงูุฃูู ุงูุซุงููู", "2ุซ": "ุงูุซุงูู ุงูุซุงููู", "3ุซ": "ุงูุซุงูุซ ุงูุซุงููู" };
        const daysOfWeek = [{ id: 'Sunday', name: 'ุงูุฃุญุฏ' }, { id: 'Monday', name: 'ุงูุงุซููู' }, { id: 'Tuesday', name: 'ุงูุซูุงุซุงุก' }, { id: 'Wednesday', name: 'ุงูุฃุฑุจุนุงุก' }, { id: 'Thursday', name: 'ุงูุฎููุณ' }, { id: 'Friday', name: 'ุงูุฌูุนุฉ' }, { id: 'Saturday', name: 'ุงูุณุจุช' }];
        const dayMap = { 'Sunday': 'ุงูุฃุญุฏ', 'Monday': 'ุงูุงุซููู', 'Tuesday': 'ุงูุซูุงุซุงุก', 'Wednesday': 'ุงูุฃุฑุจุนุงุก', 'Thursday': 'ุงูุฎููุณ', 'Friday': 'ุงูุฌูุนุฉ', 'Saturday': 'ุงูุณุจุช' };
        
        window.students = []; window.attendance = []; window.accounting = []; window.scheduleData = {};
        const today = new Date().toISOString().split('T')[0];
        let selectedAttendanceDate = today; let currentModalStudentId = null; let currentParentPhone = null; let currentScheduleLevel = null; let currentReportData = {};
        let loginMode = 'admin';

        // --- Helper: Normalize Arabic Text for Search ---
        function normalizeArabic(text) {
            return text.replace(/[ุฃุฅุข]/g, 'ุง').replace(/ุฉ/g, 'ู').replace(/ู/g, 'ู');
        }

        window.onload = () => {
            document.getElementById('headerDate').innerText = today;
            document.getElementById('attendanceDate').value = today;
            document.getElementById('reportDate').value = today;
            document.getElementById('msMonthInput').value = today.substring(0, 7);
            document.getElementById('loginOverlay').style.display = 'flex';
        };

        // --- Login Logic ---
        window.setLoginMode = function(mode) {
            loginMode = mode;
            document.getElementById('tabAdmin').className = mode === 'admin' ? 'login-tab active' : 'login-tab';
            document.getElementById('tabStudent').className = mode === 'student' ? 'login-tab active' : 'login-tab';
            document.getElementById('loginCode').placeholder = mode === 'admin' ? 'ููุฏ ุงูุฅุฏุงุฑุฉ' : 'ููุฏ ุงูุทุงูุจ';
        }

        window.handleLogin = function() {
            const code = document.getElementById('loginCode').value;
            const pass = document.getElementById('loginPass').value;
            const errorMsg = document.getElementById('loginError');

            if (loginMode === 'admin') {
                // Admin Code Hash Check (Simulated for security as requested)
                // 1032 hash simulation
                if (btoa(code) === 'MTAzMg==' && btoa(pass) === 'MTAzMjEwMzI=') {
                    document.getElementById('loginOverlay').style.display = 'none';
                    document.getElementById('appContent').classList.remove('hidden');
                    document.getElementById('navBar').classList.remove('hidden');
                    showTab('students');
                } else {
                    errorMsg.classList.remove('hidden');
                }
            } else {
                const student = window.students.find(s => s.id === code);
                if (student && student.password === pass) {
                    document.getElementById('loginOverlay').style.display = 'none';
                    document.getElementById('appContent').classList.remove('hidden');
                    document.getElementById('navBar').classList.add('hidden');
                    loadStudentDashboard(student);
                } else {
                    errorMsg.classList.remove('hidden');
                }
            }
        }

        window.logout = function() { location.reload(); }

        // --- Student Dashboard ---
        function loadStudentDashboard(student) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('studentDashboard').classList.add('active');
            
            document.getElementById('dashName').innerText = student.name;
            document.getElementById('dashCode').innerText = student.id;
            document.getElementById('dashLevel').innerText = stageMap[student.level];
            document.getElementById('dashJoinDate').innerText = student.date;
            
            // Duration
            const join = new Date(student.date);
            const now = new Date();
            const diffTime = Math.abs(now - join);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            document.getElementById('dashDuration').innerText = `${diffDays} ููู`;

            document.getElementById('dashQr').innerHTML = '';
            new QRCode(document.getElementById("dashQr"), { text: student.id, width: 80, height: 80 });

            const stats = calculateStudentStats(student);
            document.getElementById('dashPresent').innerText = stats.present;
            document.getElementById('dashAbsent').innerText = stats.absent;

            // Payments
            const payments = window.accounting.filter(r => r.category === 'revenue' && r.stdId === student.id);
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
            document.getElementById('dashPaymentsTotal').innerText = `${totalPaid} ุฌ.ู`;
            
            // Schedule List
            const days = window.scheduleData[student.level] || [];
            const scheduleHtml = days.map(d => `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-bold">${dayMap[d]}</span>`).join('');
            document.getElementById('dashScheduleList').innerHTML = scheduleHtml || '<span class="text-gray-400 text-xs">ูู ูุญุฏุฏ ุจุนุฏ</span>';

            // History
            const historyHtml = stats.history.map(h => `
                <div class="flex justify-between border-b p-2 ${h.status === 'absent' ? 'bg-red-50' : 'bg-green-50'}">
                    <span>${h.date} (${h.day})</span>
                    <span class="font-bold ${h.status === 'absent' ? 'text-red-600' : 'text-green-600'}">
                        ${h.status === 'absent' ? 'ุบูุงุจ' : 'ุญุถูุฑ'} ${h.isExceptional ? '(ุงุณุชุซูุงุฆู)' : ''}
                    </span>
                </div>
            `).join('');
            document.getElementById('dashHistory').innerHTML = historyHtml || '<p class="text-center text-gray-400 text-xs">ูุง ููุฌุฏ ุณุฌู</p>';
        }

        // --- Core Logic: Stats Calculation ---
        function calculateStudentStats(student) {
            let present = 0;
            let absent = 0;
            let history = [];
            
            const studentSchedule = window.scheduleData[student.level] || [];
            const joinDate = student.date || '2020-01-01';
            const allDates = getDatesInRange(joinDate, today);

            allDates.forEach(dateStr => {
                const dateObj = new Date(dateStr);
                const dayName = dateObj.toLocaleDateString('en-US', {weekday: 'long'});
                const dayAr = dateObj.toLocaleDateString('ar-EG', {weekday: 'long'});

                const isScheduled = studentSchedule.includes(dayName);
                const sessionRec = window.attendance.find(r => r.studentId === "SESSION_MARKER" && r.date === dateStr);
                const isExceptional = sessionRec && (!sessionRec.levels || sessionRec.levels.includes(student.level));

                if (isScheduled || isExceptional) {
                    const isPresent = window.attendance.some(r => r.date === dateStr && r.studentId === student.id);
                    
                    if (isPresent) {
                        present++;
                        history.push({ date: dateStr, day: dayAr, status: 'present', isExceptional });
                    } else {
                        // Only count absent if it was their scheduled day OR an exceptional day they missed
                        absent++;
                        history.push({ date: dateStr, day: dayAr, status: 'absent', isExceptional });
                    }
                }
            });

            history.sort((a, b) => new Date(b.date) - new Date(a.date));
            return { present, absent, history };
        }

        // --- Formal Schedule Table Logic ---
        window.renderFormalSchedule = function() {
            const tbody = document.getElementById('formalScheduleBody');
            if(!tbody) return;
            tbody.innerHTML = '';

            Object.keys(stageMap).forEach(level => {
                const days = window.scheduleData[level] || [];
                if(days.length > 0) {
                    const daysAr = days.map(d => dayMap[d]).join('ุ ');
                    tbody.innerHTML += `
                        <tr>
                            <td class="font-bold text-blue-900">${stageMap[level]}</td>
                            <td>${daysAr}</td>
                            <td class="no-print">
                                <button onclick="openMonthlySchedule('${level}')" class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-[9px] font-bold hover:bg-blue-200 border border-blue-200">
                                    ๐ ุฃุฌูุฏุฉ ุงูุดูุฑ
                                </button>
                            </td>
                        </tr>
                    `;
                }
            });
            
            if(tbody.innerHTML === '') {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-2">ูู ูุชู ุฅุนุฏุงุฏ ุงูุฌุฏูู ุจุนุฏ</td></tr>';
            }
        }

        window.printFormalSchedule = function() {
            const content = document.getElementById('formalSchedulePrintArea').innerHTML;
            const printContainer = document.getElementById('print-container');
            printContainer.innerHTML = `
                <div class="print-header">
                    <h1>Smart Center</h1>
                    <h2>ุฌุฏูู ุงูููุงุนูุฏ ุงูุฑุณูู</h2>
                    <p>ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: ${new Date().toLocaleDateString('ar-EG')}</p>
                </div>
                ${content}
            `;
            window.print();
            setTimeout(() => printContainer.innerHTML = '', 1000);
        }

        window.pdfFormalSchedule = function() {
            const element = document.getElementById('formalSchedulePrintArea');
            // Temporarily show header for PDF
            const header = element.querySelector('.print-only-header');
            header.classList.remove('hidden');
            
            const opt = {
                margin: 10,
                filename: `ุฌุฏูู_ุงูุญุตุต_${today}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save().then(() => {
                header.classList.add('hidden');
            });
        }

        // --- Standard Functions ---
        async function showTab(id, btn) {
            if(isScannerRunning) await stopScanner();
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(btn) btn.classList.add('active');
            if(id === 'attendance') window.renderFormalSchedule();
        }

        async function registerStudent() {
            const name = document.getElementById('stdName').value; const level = document.getElementById('stdLevel').value; let phone = document.getElementById('stdPhone').value;
            if(!name || !level) return showToast('ุฃููู ุงูุจูุงูุงุช', 'error');
            if(phone.startsWith('0')) phone = phone.substring(1);
            
            let id; do { id = Math.floor(1000 + Math.random() * 9000).toString(); } while (window.students.some(s => s.id === id));
            // Generate Random Password
            const password = Math.floor(100000 + Math.random() * 900000).toString();

            try { 
                await window.addDoc(window.collection(window.db, "students"), { id, name, level, phone, date: today, password }); 
                openStudentModal(id); 
                document.getElementById('stdName').value = ''; 
                document.getElementById('stdPhone').value = ''; 
                showToast('ุชู ุงูุญูุธ ูุฅูุดุงุก ุงูุญุณุงุจ', 'success'); 
            } catch (e) { showToast('ุฎุทุฃ ูู ุงูุงุชุตุงู', 'error'); }
        }

        window.renderStudents = function() {
            const query = normalizeArabic(document.getElementById('searchStd').value.toLowerCase());
            const tbody = document.getElementById('studentsTable');
            
            if(query === '') { tbody.innerHTML = ''; return; } // Don't show all by default

            const filtered = window.students.filter(s => normalizeArabic(s.name.toLowerCase()).includes(query) || s.id.includes(query));
            document.getElementById('stdCount').innerText = filtered.length;
            tbody.innerHTML = filtered.map((s, index) => `<tr class="cursor-pointer" onclick="openStudentModal('${s.id}')"><td class="col-index">${index + 1}</td><td class="col-code font-mono font-bold text-blue-600">${s.id}</td><td class="font-bold">${s.name}</td><td>${stageMap[s.level] || s.level}</td><td class="col-date text-gray-500">${s.date || '-'}</td><td class="no-print col-action" onclick="event.stopPropagation()"><button onclick="delStudent('${s.docId}', '${s.id}')" class="text-red-500 text-[10px] font-bold">ุญุฐู</button></td></tr>`).join('');
        }

        function openStudentModal(id) {
            const s = window.students.find(st => st.id === id); if(!s) return;
            currentModalStudentId = id;
            document.getElementById('modalName').innerText = s.name; document.getElementById('modalCode').innerText = s.id; document.getElementById('modalLevel').innerText = stageMap[s.level] || s.level;
            
            // Show Password
            const passArea = document.getElementById('modalPasswordArea');
            const passTxt = document.getElementById('modalPassword');
            if(s.password) {
                passArea.classList.remove('hidden');
                passTxt.innerText = s.password;
            } else {
                passArea.classList.add('hidden');
            }

            document.getElementById('modalQr').innerHTML = ''; new QRCode(document.getElementById("modalQr"), { text: s.id, width: 100, height: 100 });
            document.getElementById('studentModal').classList.remove('hidden');
        }

        // --- Attendance Logic (Strict Mode) ---
        let html5QrCode = null; let isScannerRunning = false; let isPaused = false;
        window.changeAttendanceDate = function() { selectedAttendanceDate = document.getElementById('attendanceDate').value; window.updateCounters(); }

        window.confirmSessionDay = async function() {
            const date = document.getElementById('attendanceDate').value;
            const selectedLevel = document.getElementById('attendanceStage').value;
            if(!selectedLevel) { showToast('ูุฌุจ ุงุฎุชูุงุฑ ุงููุฑุญูุฉ ุฃููุงู ูุชุซุจูุช ุงูููู!', 'error'); return; }
            const sessionRecords = window.attendance.filter(r => r.date === date && r.studentId === "SESSION_MARKER");
            const alreadyFixed = sessionRecords.some(r => r.levels && r.levels.includes(selectedLevel));
            if(alreadyFixed) { showToast(`ุชู ุชุซุจูุช ูุฐุง ุงูููู ููุฑุญูุฉ ${stageMap[selectedLevel]} ูุณุจูุงู`, 'warning'); return; }
            if(confirm(`ูู ุชุฑูุฏ ุชุซุจูุช ุชุงุฑูุฎ ${date} ูููู ุนูู ุงุณุชุซูุงุฆู ููุฑุญูุฉ ${stageMap[selectedLevel]}ุ`)) {
                try { await window.addDoc(window.collection(window.db, "attendance"), { date: date, studentId: "SESSION_MARKER", time: new Date().toLocaleTimeString('ar-EG'), levels: [selectedLevel] }); showToast('ุชู ุงูุชุซุจูุช ุจูุฌุงุญ', 'success'); } catch(e) { showToast('ุญุฏุซ ุฎุทุฃ', 'error'); }
            }
        }

        async function startScanner(elemId, mode) {
            if(isScannerRunning) return;
            html5QrCode = new Html5Qrcode(elemId);
            await html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => {
                if(isPaused) return;
                if(mode === 'attendance') handleAttendanceScan(decodedText); else if(mode === 'payment') handlePaymentScan(decodedText);
            });
            isScannerRunning = true;
        }
        async function stopScanner() { if(html5QrCode) { await html5QrCode.stop(); html5QrCode.clear(); html5QrCode = null; isScannerRunning = false; } }

        async function handleAttendanceScan(id) {
            isPaused = true;
            const student = window.students.find(s => s.id === id);
            
            if(student) {
                const selectedLevel = document.getElementById('attendanceStage').value;
                const date = selectedAttendanceDate;
                const dateObj = new Date(date);
                const dayName = dateObj.toLocaleDateString('en-US', {weekday: 'long'});

                // STRICT CHECK LOGIC
                // 1. Check if it's a regular scheduled day
                const studentSchedule = window.scheduleData[student.level] || [];
                const isScheduled = studentSchedule.includes(dayName);

                // 2. Check if it's an exceptional fixed day
                const sessionRec = window.attendance.find(r => r.studentId === "SESSION_MARKER" && r.date === date);
                const isExceptional = sessionRec && (!sessionRec.levels || sessionRec.levels.includes(student.level));

                // If neither, BLOCK
                if (!isScheduled && !isExceptional) {
                    alert(`โ๏ธ ุชูุจูู: ูุฐุง ููุณ ููู ุญุถูุฑ ุงูุทุงูุจ (${student.name}) ููู ูุชู ุชูุนูู ุชุซุจูุช ุงุณุชุซูุงุฆู ููุฐุง ุงูููู!`);
                    isPaused = false;
                    return;
                }

                // Level Mismatch Warning
                if(selectedLevel && student.level !== selectedLevel) { 
                    if(!confirm(`ุชูุจูู: ุงูุทุงูุจ ูุณุฌู ูู ${stageMap[student.level]} ูุฃูุช ุชุณุฌู ูู ${stageMap[selectedLevel]}. ูู ุชุฑูุฏ ุงูุงุณุชูุฑุงุฑุ`)) { isPaused = false; return; } 
                }

                const isPresent = window.attendance.some(r => r.date === date && r.studentId === id);
                if(!isPresent) { 
                    await window.addDoc(window.collection(window.db, "attendance"), { date: date, studentId: id, time: new Date().toLocaleTimeString('ar-EG') }); 
                    showScanFeedback(true); playSound('success'); 
                } else { 
                    showToast('ูุณุฌู ูุณุจูุงู', 'warning'); playSound('error'); 
                }
            } else { 
                showToast('ููุฏ ุบูุฑ ุตุญูุญ', 'error'); playSound('error'); 
            }
            setTimeout(() => { isPaused = false; showScanFeedback(false); }, 2000);
        }
        function showScanFeedback(show) { const el = document.getElementById('scanFeedback'); if(show) el.classList.remove('hidden'); else el.classList.add('hidden'); }
        function setAttMode(mode) { stopScanner().then(() => { const btnScan = document.getElementById('btnAttScan'); const btnManual = document.getElementById('btnAttManual'); if(mode === 'scan') { document.getElementById('attScanArea').classList.remove('hidden'); document.getElementById('attManualArea').classList.add('hidden'); btnScan.classList.add('toggle-btn-active'); btnScan.classList.remove('toggle-btn-inactive'); btnManual.classList.add('toggle-btn-inactive'); btnManual.classList.remove('toggle-btn-active'); } else { document.getElementById('attScanArea').classList.add('hidden'); document.getElementById('attManualArea').classList.remove('hidden'); btnManual.classList.add('toggle-btn-active'); btnManual.classList.remove('toggle-btn-inactive'); btnScan.classList.add('toggle-btn-inactive'); btnScan.classList.remove('toggle-btn-active'); } }); }
        function manualAttendance() { const id = document.getElementById('manualAttID').value; handleAttendanceScan(id); document.getElementById('manualAttID').value = ''; }

        let currentAttType = 'present';
        function openAttendanceModal(type) {
            currentAttType = type;
            const title = type === 'present' ? `ุญุถูุฑ (${selectedAttendanceDate})` : `ุบูุงุจ (${selectedAttendanceDate})`;
            document.getElementById('detailsTitle').innerText = title;
            const mainStage = document.getElementById('attendanceStage').value;
            const filterDropdown = document.getElementById('attFilterLevel');
            if(mainStage) filterDropdown.value = mainStage; else filterDropdown.value = 'all';
            document.getElementById('modalFilterContainer').classList.remove('hidden');
            const thead = document.getElementById('detailsTableHead');
            thead.innerHTML = `<tr><th class="col-index">ู</th><th>ุงูุงุณู</th><th>ุงูููุฏ</th><th>ุงููุฑุญูุฉ</th><th>${type === 'present' ? 'ููุช' : 'ุชุงุฑูุฎ'}</th></tr>`;
            document.getElementById('detailsModal').classList.remove('hidden');
            filterAttendanceList();
        }

        function filterAttendanceList() {
            const levelFilter = document.getElementById('attFilterLevel').value;
            const dayRecords = window.attendance.filter(r => r.date === selectedAttendanceDate);
            const presentIds = dayRecords.map(r => r.studentId).filter(id => id !== "SESSION_MARKER");
            const tbody = document.getElementById('detailsTableBody');
            let filteredStudents = window.students.filter(s => s.date <= selectedAttendanceDate);
            if(levelFilter !== 'all') filteredStudents = filteredStudents.filter(s => s.level === levelFilter);
            let list = [];
            if(currentAttType === 'present') {
                list = filteredStudents.filter(s => presentIds.includes(s.id)).map(s => { const rec = dayRecords.find(r => r.studentId === s.id); return { ...s, time: rec.time || '-' }; });
            } else {
                // Only show absent if it was actually their day!
                const dateObj = new Date(selectedAttendanceDate);
                const dayName = dateObj.toLocaleDateString('en-US', {weekday: 'long'});
                const sessionRec = window.attendance.find(r => r.studentId === "SESSION_MARKER" && r.date === selectedAttendanceDate);

                list = filteredStudents.filter(s => {
                    if(presentIds.includes(s.id)) return false; // Already present
                    
                    const isScheduled = (window.scheduleData[s.level] || []).includes(dayName);
                    const isExceptional = sessionRec && (!sessionRec.levels || sessionRec.levels.includes(s.level));
                    
                    return isScheduled || isExceptional;
                }).map(s => ({ ...s, time: selectedAttendanceDate }));
            }
            if(list.length === 0) tbody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 py-4">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
            else tbody.innerHTML = list.map((s, index) => `<tr class="cursor-pointer hover:bg-blue-50" onclick="openStudentModal('${s.id}')"><td class="col-index">${index + 1}</td><td class="font-bold">${s.name}</td><td class="font-mono text-blue-600">${s.id}</td><td>${stageMap[s.level] || s.level}</td><td class="${currentAttType === 'present' ? 'text-green-600' : 'text-red-600'}">${s.time}</td></tr>`).join('');
        }

        window.updateCounters = function() {
            const dayRecords = window.attendance.filter(r => r.date === selectedAttendanceDate);
            const presentIds = dayRecords.map(r => r.studentId).filter(id => id !== "SESSION_MARKER");
            const selectedLevel = document.getElementById('attendanceStage').value;
            let targetStudents = window.students.filter(s => s.date <= selectedAttendanceDate);
            if(selectedLevel) targetStudents = targetStudents.filter(s => s.level === selectedLevel);
            
            // Filter target students to only those who SHOULD attend
            const dateObj = new Date(selectedAttendanceDate);
            const dayName = dateObj.toLocaleDateString('en-US', {weekday: 'long'});
            const sessionRec = window.attendance.find(r => r.studentId === "SESSION_MARKER" && r.date === selectedAttendanceDate);

            const eligibleStudents = targetStudents.filter(s => {
                const isScheduled = (window.scheduleData[s.level] || []).includes(dayName);
                const isExceptional = sessionRec && (!sessionRec.levels || sessionRec.levels.includes(s.level));
                return isScheduled || isExceptional;
            });

            const presentCount = eligibleStudents.filter(s => presentIds.includes(s.id)).length;
            document.getElementById('presentCount').innerText = presentCount;
            document.getElementById('absentCount').innerText = eligibleStudents.length - presentCount;
        }

        // --- Reports ---
        function getDatesInRange(startDate, endDate) {
            const date = new Date(startDate); const end = new Date(endDate); const dates = [];
            while (date <= end) { dates.push(new Date(date).toISOString().split('T')[0]); date.setDate(date.getDate() + 1); }
            return dates;
        }

        function generateStudentReport() {
            const query = normalizeArabic(document.getElementById('reportStudentSearch').value.toLowerCase());
            const student = window.students.find(s => normalizeArabic(s.name.toLowerCase()).includes(query) || s.id === query);
            const resDiv = document.getElementById('studentReportResult');
            if(!student) { resDiv.innerHTML = '<p class="text-red-500 text-center">ูู ูุชู ุงูุนุซูุฑ</p>'; resDiv.classList.remove('hidden'); return; }
            currentParentPhone = student.phone;

            const stats = calculateStudentStats(student);
            const exceptionalAbsence = stats.history.filter(h => h.status === 'absent' && h.isExceptional);
            const exceptionalPresent = stats.history.filter(h => h.status === 'present' && h.isExceptional);
            const regularAbsence = stats.history.filter(h => h.status === 'absent' && !h.isExceptional);

            const payments = window.accounting.filter(r => r.category === 'revenue' && r.stdId === student.id);
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);

            // WhatsApp Text Update
            currentStudentReport = `*ุชูุฑูุฑ ุงูุทุงูุจ: ${student.name}*\nููุฏ: ${student.id}\nุชุงุฑูุฎ ุงูุงุดุชุฑุงู: ${student.date}\n----------------\nโ ุฃูุงู ุงูุญุถูุฑ: ${stats.present}\nโ ุฃูุงู ุงูุบูุงุจ: ${stats.absent}\n๐ฐ ุฅุฌูุงูู ุงููุฏููุนุงุช: ${totalPaid} ุฌ.ู\n----------------\n*ุชูุงุฑูุฎ ุงูุบูุงุจ:*\n${regularAbsence.map(h=>h.date).join('\n') || 'ูุง ููุฌุฏ'}\n\n*๐ ุญุถูุฑ ุงุณุชุซูุงุฆู:*\n${exceptionalPresent.map(h=>h.date).join('\n') || 'ูุง ููุฌุฏ'}`;
            
            resDiv.innerHTML = `
                <div class="border-b pb-2 mb-2"><h4 class="font-bold text-lg text-blue-900">${student.name}</h4><p class="text-gray-500 text-xs">ููุฏ: ${student.id} | ${stageMap[student.level]}</p></div>
                <div class="grid grid-cols-2 gap-2 mb-4 text-center"><div class="bg-green-100 p-2 rounded"><div class="text-xs">ุญุถูุฑ</div><div class="font-bold text-green-700">${stats.present}</div></div><div class="bg-red-100 p-2 rounded"><div class="text-xs">ุบูุงุจ</div><div class="font-bold text-red-700">${stats.absent}</div></div></div>
                
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <div class="border rounded p-1">
                        <h5 class="font-bold text-[10px] text-red-700 mb-1 border-b">ุณุฌู ุงูุบูุงุจ</h5>
                        <div class="max-h-24 overflow-y-auto text-[9px] text-red-600">${regularAbsence.map(h=>`<div>${h.date} (${h.day})</div>`).join('') || 'ูุง ููุฌุฏ'}</div>
                    </div>
                    <div class="border rounded p-1">
                        <h5 class="font-bold text-[10px] text-black mb-1 border-b">ุญุถูุฑ ุงุณุชุซูุงุฆู</h5>
                        <div class="max-h-24 overflow-y-auto text-[9px] text-black font-bold">${exceptionalPresent.map(h=>`<div>${h.date} (${h.day})</div>`).join('') || 'ูุง ููุฌุฏ'}</div>
                    </div>
                </div>

                ${exceptionalAbsence.length > 0 ? `<div class="bg-yellow-50 p-2 rounded border border-yellow-200 mb-2 text-[10px] text-yellow-800 font-bold">โ๏ธ ุบูุงุจ ุงุณุชุซูุงุฆู: ${exceptionalAbsence.map(d=>d.date).join(', ')}</div>` : ''}
                
                <div class="mb-4"><h5 class="font-bold text-xs mb-1">ุงููุฏููุนุงุช (${totalPaid} ุฌ.ู)</h5><div class="max-h-32 overflow-y-auto text-xs border rounded p-1">${payments.length ? payments.map(p => `<div class="flex justify-between border-b p-1"><span>${p.type}</span><span>${p.amount} (${p.date})</span></div>`).join('') : '<p class="text-center">ูุง ููุฌุฏ</p>'}</div></div>
                <div class="flex gap-2"><button onclick="shareStudentReport()" class="flex-1 bg-green-600 text-white py-1.5 rounded text-xs font-bold flex items-center justify-center gap-2"><span>๐ฑ</span> ูุงุชุณุงุจ</button><button onclick="printDetailedStudentReport('${student.id}')" class="flex-1 bg-gray-800 text-white py-1.5 rounded text-xs font-bold flex items-center justify-center gap-2"><span>๐จ๏ธ</span> ุทุจุงุนุฉ</button></div>
            `;
            resDiv.classList.remove('hidden');
        }

        function printDetailedStudentReport(studentId) {
            const s = window.students.find(st => st.id === studentId); if(!s) return;
            const stats = calculateStudentStats(s);
            const payments = window.accounting.filter(r => r.category === 'revenue' && r.stdId === s.id);
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);

            const printContainer = document.getElementById('print-container');
            printContainer.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;"><h1>Smart Center</h1><h2>ุชูุฑูุฑ ุทุงูุจ ุชูุตููู</h2><p>ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: ${new Date().toLocaleDateString('ar-EG')}</p></div>
                <div class="student-report-print">
                    <h4>${s.name} <span style="font-size:12pt">(${s.id})</span></h4><p>ุงููุฑุญูุฉ: ${stageMap[s.level] || s.level}</p><p>ุชุงุฑูุฎ ุงูุงูุถูุงู: ${s.date}</p>
                    <div class="stats-grid"><div>ุนุฏุฏ ุฃูุงู ุงูุญุถูุฑ: <strong>${stats.present}</strong></div><div>ุนุฏุฏ ุฃูุงู ุงูุบูุงุจ: <strong>${stats.absent}</strong></div><div>ุฅุฌูุงูู ุงููุฏููุนุงุช: <strong>${totalPaid} ุฌ.ู</strong></div></div>
                    <h3 style="margin-top:15px; border-bottom:1px solid #000;">ุณุฌู ุงููุฏููุนุงุช</h3><table><thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงูููุน</th><th>ุงููุจูุบ</th></tr></thead><tbody>${payments.map(p => `<tr><td>${p.date}</td><td>${p.type}</td><td>${p.amount}</td></tr>`).join('') || '<tr><td colspan="3">ูุง ููุฌุฏ</td></tr>'}</tbody></table>
                    <h3 style="margin-top:15px; border-bottom:1px solid #000;">ุณุฌู ุงูุญุถูุฑ ูุงูุบูุงุจ</h3>
                    <table><thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงูููู</th><th>ุงูุญุงูุฉ</th><th>ููุงุญุธุงุช</th></tr></thead><tbody>
                    ${stats.history.map(h => `<tr><td>${h.date}</td><td>${h.day}</td><td>${h.status==='present'?'ุญุถูุฑ':'ุบูุงุจ'}</td><td>${h.isExceptional?'ุงุณุชุซูุงุฆู':''}</td></tr>`).join('')}
                    </tbody></table>
                </div>
            `;
            window.print(); setTimeout(() => { printContainer.innerHTML = ''; }, 1000);
        }

        // --- Advanced Report (Monthly) ---
        function generateAdvancedReport() {
            const type = document.getElementById('reportType').value;
            const stage = document.getElementById('reportStage').value;
            const dateInput = document.getElementById('reportDate').value;
            const monthInput = document.getElementById('reportMonth').value;
            const resDiv = document.getElementById('reportResult');

            let totalRev = 0, totalExp = 0;
            currentReportData = { present: [], absent: [], revenues: [], expenses: [] };

            let targetStudents = window.students;
            if(stage !== 'all') targetStudents = window.students.filter(s => s.level === stage);

            if(type === 'daily') {
                if(!dateInput) return showToast('ุงุฎุชุฑ ุงูุชุงุฑูุฎ', 'error');
                targetStudents = targetStudents.filter(s => s.date <= dateInput);
                const dayRecords = window.attendance.filter(r => r.date === dateInput);
                const presentIds = dayRecords.map(r => r.studentId);
                currentReportData.present = targetStudents.filter(s => presentIds.includes(s.id)).map(s => { const rec = dayRecords.find(r => r.studentId === s.id); return { ...s, time: rec.time || '-' }; });
                currentReportData.absent = targetStudents.filter(s => !presentIds.includes(s.id)).map(s => ({ ...s, time: 'ุบูุงุจ' }));
                currentReportData.revenues = window.accounting.filter(r => r.category === 'revenue' && r.date === dateInput);
                currentReportData.expenses = window.accounting.filter(e => e.category === 'expense' && e.date === dateInput);
            } else {
                if(!monthInput) return showToast('ุงุฎุชุฑ ุงูุดูุฑ', 'error');
                const [year, month] = monthInput.split('-').map(Number);
                const daysInMonth = []; const date = new Date(year, month - 1, 1);
                while (date.getMonth() === month - 1) { daysInMonth.push(new Date(date)); date.setDate(date.getDate() + 1); }

                let monthlyStats = {};
                targetStudents.forEach(s => { monthlyStats[s.id] = { name: s.name, level: s.level, present: 0, absentDates: [], exceptionalDates: [] }; });

                targetStudents.forEach(student => {
                    const studentSchedule = window.scheduleData[student.level] || [];
                    daysInMonth.forEach(dayObj => {
                        const dateStr = dayObj.toISOString().split('T')[0];
                        if (dateStr < student.date) return;

                        const dayName = dayObj.toLocaleDateString('en-US', {weekday: 'long'});
                        const isScheduled = studentSchedule.includes(dayName);
                        const sessionRec = window.attendance.find(r => r.studentId === "SESSION_MARKER" && r.date === dateStr);
                        const isFixed = sessionRec && (!sessionRec.levels || sessionRec.levels.includes(student.level));

                        if (isScheduled || isFixed) {
                            const didAttend = window.attendance.some(r => r.date === dateStr && r.studentId === student.id);
                            if (didAttend) {
                                monthlyStats[student.id].present++;
                                if(isFixed) monthlyStats[student.id].exceptionalDates.push(dateStr);
                            } else {
                                monthlyStats[student.id].absentDates.push(dateStr);
                            }
                        }
                    });
                });

                currentReportData.present = Object.values(monthlyStats).map(s => ({ ...s, time: `${s.present} ููู ${s.exceptionalDates.length > 0 ? '<br><span class="text-[8px] text-black font-bold">ุงุณุชุซูุงุฆู: '+s.exceptionalDates.join(',')+'</span>' : ''}` }));
                currentReportData.absent = Object.values(monthlyStats).filter(s => s.absentDates.length > 0).map(s => ({ ...s, time: s.absentDates.join('<br>') }));
                currentReportData.revenues = window.accounting.filter(r => r.category === 'revenue' && r.date.startsWith(monthInput));
                currentReportData.expenses = window.accounting.filter(e => e.category === 'expense' && e.date.startsWith(monthInput));
            }

            totalRev = currentReportData.revenues.reduce((a,b)=>a+b.amount,0);
            totalExp = currentReportData.expenses.reduce((a,b)=>a+b.amount,0);

            let html = `<h4 class="font-bold text-center border-b pb-2 mb-2">ุชูุฑูุฑ ${type === 'daily' ? dateInput : monthInput}</h4><div class="grid grid-cols-2 gap-2 mb-4 text-center"><div onclick='openReportDetails("present")' class="bg-green-100 p-2 rounded cursor-pointer hover:bg-green-200"><div class="text-xs">ุญุถูุฑ</div><div class="font-bold text-green-700">${type === 'daily' ? currentReportData.present.length : 'ุนุฑุถ'}</div></div><div onclick='openReportDetails("absent")' class="bg-red-100 p-2 rounded cursor-pointer hover:bg-red-200"><div class="text-xs">ุบูุงุจ</div><div class="font-bold text-red-700">${type === 'daily' ? currentReportData.absent.length : 'ุนุฑุถ'}</div></div></div><div class="space-y-2"><div onclick='openReportDetails("revenues")' class="bg-green-50 p-2 rounded border border-green-200 cursor-pointer hover:bg-green-100 flex justify-between"><span class="text-xs text-gray-500">ุฅูุฑุงุฏุงุช</span><span class="font-bold text-green-700">${totalRev} ุฌ.ู</span></div><div onclick='openReportDetails("expenses")' class="bg-red-50 p-2 rounded border border-red-200 cursor-pointer hover:bg-red-100 flex justify-between"><span class="text-xs text-gray-500">ูุตุฑููุงุช</span><span class="font-bold text-red-700">${totalExp} ุฌ.ู</span></div><div class="bg-blue-50 p-2 rounded border border-blue-200 text-center"><span class="text-xs text-gray-500">ุงูุตุงูู</span><span class="font-bold text-blue-900 text-lg block">${totalRev - totalExp} ุฌ.ู</span></div></div>`;
            resDiv.innerHTML = html;
            resDiv.classList.remove('hidden');
        }

        // --- Other Functions (Schedule, Accounting, etc.) ---
        window.openScheduleModal = function() {
            const container = document.getElementById('scheduleContainer'); container.innerHTML = '';
            Object.keys(stageMap).forEach(level => {
                const savedDays = window.scheduleData[level] || [];
                let daysHtml = daysOfWeek.map(day => `<label class="inline-flex items-center ml-2 mb-1"><input type="checkbox" class="form-checkbox h-3 w-3 text-purple-600" name="schedule_${level}" value="${day.id}" ${savedDays.includes(day.id) ? 'checked' : ''}><span class="mr-1 text-[10px]">${day.name}</span></label>`).join('');
                container.innerHTML += `<div class="bg-gray-50 p-2 rounded border"><div class="flex justify-between items-center mb-1"><h4 class="font-bold text-xs text-blue-900">${stageMap[level]}</h4></div><div class="flex flex-wrap">${daysHtml}</div></div>`;
            });
            document.getElementById('scheduleModal').classList.remove('hidden');
        }
        window.saveSchedule = async function() {
            const newSchedule = {};
            Object.keys(stageMap).forEach(level => { const checkboxes = document.querySelectorAll(`input[name="schedule_${level}"]:checked`); if(checkboxes.length > 0) newSchedule[level] = Array.from(checkboxes).map(cb => cb.value); });
            try { await window.setDoc(window.doc(window.db, "settings", "schedule"), newSchedule); window.scheduleData = newSchedule; closeModal('scheduleModal'); showToast('ุชู ุญูุธ ุงูุฌุฏูู ุจูุฌุงุญ', 'success'); window.renderFormalSchedule(); } catch(e) { showToast('ุฎุทุฃ ูู ุงูุญูุธ', 'error'); }
        }
        window.openMonthlySchedule = function(level) { currentScheduleLevel = level; document.getElementById('msStageName').innerText = `ุฌุฏูู: ${stageMap[level]}`; renderMonthlySchedule(); document.getElementById('monthlyScheduleModal').classList.remove('hidden'); }
        window.renderMonthlySchedule = function() {
            if(!currentScheduleLevel) return;
            const monthInput = document.getElementById('msMonthInput').value; const [year, month] = monthInput.split('-').map(Number);
            const targetDays = window.scheduleData[currentScheduleLevel] || []; const listDiv = document.getElementById('msDatesList');
            if(targetDays.length === 0) { listDiv.innerHTML = '<p class="text-center text-gray-500">ูู ูุชู ุชุญุฏูุฏ ุฃูุงู ููุฐู ุงููุฑุญูุฉ</p>'; return; }
            let dates = []; let date = new Date(year, month - 1, 1);
            while (date.getMonth() === month - 1) {
                let dayName = date.toLocaleDateString('en-US', {weekday: 'long'});
                if (targetDays.includes(dayName)) dates.push({ date: date.toISOString().split('T')[0], dayAr: date.toLocaleDateString('ar-EG', {weekday: 'long'}) });
                date.setDate(date.getDate() + 1);
            }
            listDiv.innerHTML = dates.map(d => `<div class="flex justify-between border-b border-gray-200 pb-1 last:border-0"><span class="font-bold text-blue-900">${d.dayAr}</span><span class="font-mono text-gray-600">${d.date}</span></div>`).join('');
        }
        window.printMonthlySchedule = function() { const content = document.getElementById('monthlyScheduleCard').innerHTML; const printContainer = document.getElementById('print-container'); printContainer.innerHTML = `<div class="print-card-wrapper" style="width: 400px;"><h2>Smart Center</h2>${content}</div>`; window.print(); setTimeout(() => { printContainer.innerHTML = ''; }, 1000); }
        window.pdfMonthlySchedule = function() { const element = document.getElementById('monthlyScheduleCard'); const opt = { margin: 10, filename: `ุฌุฏูู_${stageMap[currentScheduleLevel]}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a6', orientation: 'portrait' } }; html2pdf().set(opt).from(element).save(); }
        
        // Accounting & Utils
        let currentPayStudent = null;
        function togglePayMethod(method) { const btnScan = document.getElementById('btnPayScan'); const btnManual = document.getElementById('btnPayManual'); if(method === 'scan') { document.getElementById('payScanDiv').classList.remove('hidden'); document.getElementById('payManualDiv').classList.add('hidden'); btnScan.classList.add('toggle-btn-active'); btnScan.classList.remove('toggle-btn-inactive'); btnManual.classList.add('toggle-btn-inactive'); btnManual.classList.remove('toggle-btn-active'); } else { document.getElementById('payScanDiv').classList.add('hidden'); document.getElementById('payManualDiv').classList.remove('hidden'); btnManual.classList.add('toggle-btn-active'); btnManual.classList.remove('toggle-btn-inactive'); btnScan.classList.add('toggle-btn-inactive'); btnScan.classList.remove('toggle-btn-active'); stopScanner(); } }
        function handlePaymentScan(id) { if(!document.getElementById('paymentForm').classList.contains('hidden')) return; const student = window.students.find(s => s.id === id); if(student) { currentPayStudent = student; document.getElementById('paymentForm').classList.remove('hidden'); document.getElementById('payStdName').innerText = student.name; document.getElementById('payStdID').innerText = student.id; playSound('success'); } else { showToast('ุทุงูุจ ุบูุฑ ููุฌูุฏ', 'error'); } }
        function searchStudentForPay() { handlePaymentScan(document.getElementById('paySearchID').value); }
        async function confirmPayment() { const amount = parseFloat(document.getElementById('payAmount').value); const type = document.getElementById('payType').value; const time = new Date().toLocaleTimeString('ar-EG'); await window.addDoc(window.collection(window.db, "accounting"), { date: today, time, stdId: currentPayStudent.id, name: currentPayStudent.name, amount, type, category: 'revenue' }); document.getElementById('paymentForm').classList.add('hidden'); document.getElementById('paySearchID').value = ''; showToast('ุชู ุงูุฏูุน', 'success'); }
        async function addExpense() { const type = document.getElementById('expType').value; const note = document.getElementById('expNote').value; const amount = parseFloat(document.getElementById('expAmount').value); const time = new Date().toLocaleTimeString('ar-EG'); if(!type || !amount) return showToast('ุฃููู ุงูุจูุงูุงุช', 'error'); await window.addDoc(window.collection(window.db, "accounting"), { date: today, time, desc: `${type} ${note ? '- '+note : ''}`, amount, category: 'expense' }); document.getElementById('expType').value = ''; document.getElementById('expNote').value = ''; document.getElementById('expAmount').value = ''; showToast('ุชู ุงูุชุณุฌูู', 'success'); }
        window.updateFinance = function() { const revs = window.accounting.filter(a => a.category === 'revenue'); const exps = window.accounting.filter(a => a.category === 'expense'); const totalRev = revs.reduce((sum, r) => sum + r.amount, 0); const totalExp = exps.reduce((sum, e) => sum + e.amount, 0); document.getElementById('totalRev').innerText = totalRev; document.getElementById('totalExp').innerText = totalExp; document.getElementById('netProfit').innerText = (totalRev - totalExp); const todayRevs = revs.filter(r => r.date === today); const todayExps = exps.filter(e => e.date === today); document.getElementById('todayRevList').innerHTML = todayRevs.map(r => `<div class="flex justify-between border-b border-white/10 pb-1"><span>${r.name}</span><span>${r.amount}</span></div>`).join('') || '<div class="text-center opacity-50">ูุง ููุฌุฏ</div>'; document.getElementById('todayExpList').innerHTML = todayExps.map(e => `<div class="flex justify-between border-b border-white/10 pb-1"><span>${e.desc}</span><span>${e.amount}</span></div>`).join('') || '<div class="text-center opacity-50">ูุง ููุฌุฏ</div>'; }
        function toggleReportInputs() { const type = document.getElementById('reportType').value; if(type === 'daily') { document.getElementById('divDateInput').classList.remove('hidden'); document.getElementById('divMonthInput').classList.add('hidden'); } else { document.getElementById('divDateInput').classList.add('hidden'); document.getElementById('divMonthInput').classList.remove('hidden'); } }
        
        function openReportDetails(key) { const list = currentReportData[key]; let title = ''; if(key === 'present') title = 'ุชูุงุตูู ุงูุญุถูุฑ'; else if(key === 'absent') title = 'ุชูุงุตูู ุงูุบูุงุจ'; else if(key === 'revenues') title = 'ุชูุงุตูู ุงูุฅูุฑุงุฏุงุช'; else title = 'ุชูุงุตูู ุงููุตุฑููุงุช'; document.getElementById('detailsTitle').innerText = title; document.getElementById('modalFilterContainer').classList.add('hidden'); const thead = document.getElementById('detailsTableHead'); const tbody = document.getElementById('detailsTableBody'); if(key === 'present' || key === 'absent') { const isMonthly = document.getElementById('reportType').value === 'monthly'; const lastCol = isMonthly ? (key === 'present' ? 'ุนุฏุฏ ุงูุฃูุงู' : 'ุชูุงุฑูุฎ ุงูุบูุงุจ') : 'ุงูููุช'; thead.innerHTML = `<tr><th class="col-index">ู</th><th>ุงูุงุณู</th><th>ุงููุฑุญูุฉ</th><th>${lastCol}</th></tr>`; if(list.length === 0) tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`; else tbody.innerHTML = list.map((s, i) => `<tr class="hover:bg-gray-50"><td class="text-gray-500">${i + 1}</td><td class="font-bold">${s.name}</td><td>${stageMap[s.level] || s.level}</td><td class="text-xs ${key === 'absent' ? 'text-red-600' : ''}">${s.time}</td></tr>`).join(''); } else { thead.innerHTML = `<tr><th class="col-index">ู</th><th>ุงูุจูุฏ/ุงูุทุงูุจ</th><th>ุงูููุช</th><th>ุงููุจูุบ</th></tr>`; if(list.length === 0) tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`; else tbody.innerHTML = list.map((item, i) => `<tr class="hover:bg-gray-50"><td class="text-gray-500">${i + 1}</td><td class="font-bold">${item.name || item.desc}</td><td class="text-gray-500 text-xs">${item.date} | ${item.time || '-'}</td><td class="font-bold ${key === 'revenues' ? 'text-green-600' : 'text-red-600'}">${item.amount}</td></tr>`).join(''); } document.getElementById('detailsModal').classList.remove('hidden'); }
        function exportData() { const data = { students: window.students, attendance: window.attendance, accounting: window.accounting }; const blob = new Blob([JSON.stringify(data)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `backup_center_${today}.json`; a.click(); }
        function importData(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = async function(e) { try { const data = JSON.parse(e.target.result); if(data.students) { for(const s of data.students) await window.addDoc(window.collection(window.db, "students"), s); for(const a of data.attendance) await window.addDoc(window.collection(window.db, "attendance"), a); for(const c of data.accounting) await window.addDoc(window.collection(window.db, "accounting"), c); alert('ุชู ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ!'); } } catch(err) { alert('ููู ุชุงูู'); } }; reader.readAsText(file); }
        function clearAllData() { if(confirm('ุญุฐู ุงูููุ')) { localStorage.clear(); location.reload(); } }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function showToast(msg, type) { const t = document.getElementById('toast'); t.innerText = msg; t.className = `fixed top-5 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-xl z-[200] font-bold text-sm text-white ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`; t.classList.remove('hidden'); setTimeout(() => t.classList.add('hidden'), 3000); }
        function playSound(type) { const ctx = new (window.AudioContext || window.webkitAudioContext)(); const osc = ctx.createOscillator(); osc.connect(ctx.destination); if(type === 'success') { osc.frequency.setValueAtTime(800, ctx.currentTime); osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.1); } else { osc.frequency.setValueAtTime(300, ctx.currentTime); osc.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.2); } osc.start(); osc.stop(ctx.currentTime + 0.2); }
        function shareStudentReport() { if(currentParentPhone) { const url = `https://wa.me/20${currentParentPhone}?text=${encodeURIComponent(currentStudentReport)}`; window.open(url, '_blank'); } else { alert('ูุง ููุฌุฏ ุฑูู ููู ุฃูุฑ'); } }
        function printContent(elementId, title) { const content = document.getElementById(elementId).innerHTML; const printContainer = document.getElementById('print-container'); printContainer.innerHTML = `<div style="text-align: center; margin-bottom: 20px;"><h1 style="font-size: 20px; font-weight: bold;">Smart Center</h1><h2 style="font-size: 16px;">${title}</h2><p style="font-size: 12px;">ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: ${new Date().toLocaleDateString('ar-EG')}</p></div><div class="print-table-wrapper">${content}</div>`; const noPrintElements = printContainer.querySelectorAll('.no-print, .no-print-in-paper, button'); noPrintElements.forEach(el => el.remove()); window.print(); setTimeout(() => { printContainer.innerHTML = ''; }, 1000); }
        function printStudentCard() { const s = window.students.find(st => st.id === currentModalStudentId); if(!s) return; const printContainer = document.getElementById('print-container'); printContainer.innerHTML = `<div class="print-card-wrapper"><h2>Smart Center</h2><div id="printQr" style="margin: 10px auto;"></div><div class="code">${s.id}</div><h2>${s.name}</h2><p>${stageMap[s.level] || s.level}</p><p style="margin-top: 10px; font-size: 10px;">ุจุทุงูุฉ ูููุฉ ุงูุทุงูุจ</p></div>`; new QRCode(document.getElementById("printQr"), { text: s.id, width: 150, height: 150 }); window.print(); setTimeout(() => { printContainer.innerHTML = ''; }, 1000); }
        function printFinancialReport() { const revs = window.accounting.filter(a => a.category === 'revenue' && a.date === today); const exps = window.accounting.filter(a => a.category === 'expense' && a.date === today); const totalRev = revs.reduce((sum, r) => sum + r.amount, 0); const totalExp = exps.reduce((sum, e) => sum + e.amount, 0); const net = totalRev - totalExp; let html = `<div style="border: 1px solid #000; padding: 10px; margin-bottom: 20px;"><h3>ููุฎุต ุงูููู (${today})</h3><p>ุฅุฌูุงูู ุงููุงุฑุฏ: <strong>${totalRev}</strong></p><p>ุฅุฌูุงูู ุงููุตุฑููุงุช: <strong>${totalExp}</strong></p><p>ุงูุตุงูู: <strong>${net}</strong></p></div><h3>ุชูุงุตูู ุงูุฅูุฑุงุฏุงุช</h3><table style="width:100%; border-collapse:collapse; margin-bottom:20px;"><thead><tr><th>ุงูุงุณู</th><th>ุงููุจูุบ</th><th>ุงูููุน</th></tr></thead><tbody>${revs.map(r => `<tr><td>${r.name}</td><td>${r.amount}</td><td>${r.type}</td></tr>`).join('') || '<tr><td colspan="3">ูุง ููุฌุฏ</td></tr>'}</tbody></table><h3>ุชูุงุตูู ุงููุตุฑููุงุช</h3><table style="width:100%; border-collapse:collapse;"><thead><tr><th>ุงูุจูุฏ</th><th>ุงููุจูุบ</th></tr></thead><tbody>${exps.map(e => `<tr><td>${e.desc}</td><td>${e.amount}</td></tr>`).join('') || '<tr><td colspan="2">ูุง ููุฌุฏ</td></tr>'}</tbody></table>`; const printContainer = document.getElementById('print-container'); printContainer.innerHTML = `<div style="text-align: center; margin-bottom: 20px;"><h1>Smart Center</h1><h2>ุงูุชูุฑูุฑ ุงููุงูู ุงููููู</h2></div>${html}`; window.print(); setTimeout(() => { printContainer.innerHTML = ''; }, 1000); }
        function shareStudentPdf() { const s = window.students.find(st => st.id === currentModalStudentId); const element = document.getElementById('studentCardDisplay'); const opt = { margin: 10, filename: `ุจุทุงูุฉ_${s.name}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a6', orientation: 'portrait' } }; html2pdf().set(opt).from(element).save(); }
        async function delStudent(docId, studentId) { if(!confirm('ุณูุชู ุญุฐู ุงูุทุงูุจ ูุฌููุน ุณุฌูุงุช ุญุถูุฑู ููุฏููุนุงุชู! ูู ุฃูุช ูุชุฃูุฏุ')) return; try { const attQuery = window.query(window.collection(window.db, "attendance"), window.where("studentId", "==", studentId)); const attSnapshot = await window.getDocs(attQuery); attSnapshot.forEach(doc => window.deleteDoc(doc.ref)); const accQuery = window.query(window.collection(window.db, "accounting"), window.where("stdId", "==", studentId)); const accSnapshot = await window.getDocs(accQuery); accSnapshot.forEach(doc => window.deleteDoc(doc.ref)); await window.deleteDoc(window.doc(window.db, "students", docId)); showToast('ุชู ุญุฐู ุงูุทุงูุจ ููู ุจูุงูุงุชู', 'success'); } catch (e) { showToast('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญุฐู', 'error'); } }
    </script>
</body>
</html>