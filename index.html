<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1e3a8a">
    <title>Smart Center | Pro v1.8</title>

    <!-- Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¹Ø§Ù…Ø© ÙˆØªØµØºÙŠØ± Ø§Ù„Ø®Ø·ÙˆØ· Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        body { font-family: 'Cairo', sans-serif; background-color: #f1f5f9; padding-bottom: 100px; font-size: 11px; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        
        /* ØªØ®ØµÙŠØµ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        select, input { font-size: 11px !important; }
        select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%231e3a8a' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: left 0.5rem center; background-repeat: no-repeat; background-size: 1.2em 1.2em; padding-left: 2rem !important; appearance: none; }
        
        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© */
        .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(30, 58, 138, 0.95); backdrop-filter: blur(10px); padding: 8px 12px; border-radius: 25px; display: flex; gap: 8px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3); z-index: 9000; border: 1px solid rgba(255,255,255,0.1); width: 90%; max-width: 400px; justify-content: space-between; }
        .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #93c5fd; padding: 6px 0; border-radius: 15px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; }
        .nav-btn svg { width: 20px; height: 20px; margin-bottom: 2px; transition: transform 0.2s; }
        .nav-btn span { font-size: 9px; font-weight: 700; }
        .nav-btn.active { background: white; color: #1e3a8a; transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .nav-btn.active svg { transform: scale(1.1); }
        
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
        .glass-card { background: white; border-radius: 12px; padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; margin-bottom: 8px; }
        .scanner-wrapper { border-radius: 12px; overflow: hidden; background: black; position: relative; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); }
        
        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        .custom-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 10px; table-layout: fixed; }
        .custom-table thead th { background-color: #f8fafc; color: #475569; font-weight: 800; padding: 8px 4px; border-bottom: 2px solid #e2e8f0; text-align: center; }
        .custom-table tbody td { padding: 6px 4px; border-bottom: 1px solid #f1f5f9; text-align: center; vertical-align: middle; }
        .custom-table tbody tr:last-child td { border-bottom: none; }
        .col-code { width: 45px; font-family: monospace; font-weight: bold; color: #2563eb; }
        
        /* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Ø´Ø§Ø´Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #loadingOverlay { position: fixed; inset: 0; background: rgba(255,255,255,0.98); z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #loginOverlay { position: fixed; inset: 0; background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%); z-index: 100000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-card { background: rgba(255, 255, 255, 0.95); width: 100%; max-width: 350px; border-radius: 24px; padding: 25px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); text-align: center; }
        
        /* Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
        #print-container { display: none; }
        @media print {
            body { background: white; padding: 0; }
            .no-print, .bottom-nav, header { display: none !important; }
            #print-container { display: block !important; position: absolute; top: 0; left: 0; width: 100%; }
            @page { margin: 0.5cm; size: A4; }
            /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙƒÙ…Ø§ Ù‡ÙŠ ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© */
            .official-report { width: 100%; font-family: 'Cairo', sans-serif; color: #000; }
            .report-header-box { text-align: center; border-bottom: 3px double #000; padding-bottom: 10px; margin-bottom: 15px; position: relative; }
            .report-title { font-size: 20pt; font-weight: 900; }
            .print-table { width: 100%; border-collapse: collapse; font-size: 10pt; }
            .print-table th, .print-table td { border: 1px solid #000; padding: 5px; text-align: center; }
        }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù„ÙˆØ­ÙŠØ© ÙˆØ§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± */
        @media (min-width: 768px) {
            body { font-size: 12px; padding-bottom: 20px; }
            .bottom-nav { bottom: 30px; max-width: 500px; padding: 10px 20px; }
            .nav-btn span { font-size: 11px; }
            .nav-btn svg { width: 24px; height: 24px; }
            .glass-card { padding: 20px; }
        }
    </style>
</head>
<body class="text-slate-800">

<!-- Login Overlay -->
<div id="loginOverlay">
    <div class="login-card">
        <div class="mb-6">
            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3 shadow-inner">
                <span class="text-3xl">ğŸ“</span>
            </div>
            <h1 class="text-2xl font-black text-blue-900">Smart Center</h1>
            <p class="text-gray-500 text-[10px] font-bold mt-1">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ Ø§Ù„Ù…ØªØ·ÙˆØ±</p>
        </div>
        <div class="flex bg-gray-100 p-1 rounded-xl mb-6">
            <div onclick="setLoginMode('admin')" id="tabAdmin" class="flex-1 py-2 text-center cursor-pointer rounded-lg font-bold text-xs transition-all bg-white text-blue-900 shadow-sm">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
            <div onclick="setLoginMode('student')" id="tabStudent" class="flex-1 py-2 text-center cursor-pointer rounded-lg font-bold text-xs text-gray-500 transition-all">Ø§Ù„Ø·Ø§Ù„Ø¨</div>
        </div>
        <div id="loginForm" class="space-y-3">
            <input type="text" id="loginCode" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-center font-bold text-sm focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„">
            <input type="password" id="loginPass" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-center font-bold text-sm focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button onclick="handleLogin()" class="w-full py-3 bg-blue-900 text-white rounded-xl font-bold text-sm shadow-lg shadow-blue-900/30 hover:scale-[1.02] transition-transform">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        </div>
        <p id="loginError" class="text-red-500 text-[10px] mt-4 hidden font-bold bg-red-50 p-2 rounded-lg border border-red-100">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©</p>
    </div>
</div>

<!-- Loading -->
<div id="loadingOverlay" class="hidden">
    <div class="animate-spin rounded-full h-10 w-10 border-4 border-blue-100 border-t-blue-900 mb-4"></div>
    <div class="text-sm font-bold text-blue-900">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
</div>

<!-- Print Container -->
<div id="print-container"></div>

<!-- Main App -->
<div id="appContent" class="hidden">
    <!-- Top Header (Minimal) -->
    <header class="bg-white/80 backdrop-blur-md border-b border-gray-200 sticky top-0 z-40 no-print">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-blue-900 rounded-lg flex items-center justify-center text-white font-bold text-xs shadow-lg shadow-blue-900/20">SC</div>
                <div>
                    <h1 class="text-sm font-black text-slate-800 leading-tight">Smart Center</h1>
                    <div class="text-[9px] text-gray-500 font-bold flex items-center gap-1">
                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> v1.8 Pro
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <div class="text-[10px] font-mono font-bold bg-gray-100 px-2 py-1 rounded text-gray-600 border border-gray-200" id="headerDate">--/--</div>
                <button onclick="logout()" class="w-7 h-7 bg-red-50 text-red-600 rounded-lg flex items-center justify-center hover:bg-red-100 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                </button>
            </div>
        </div>
    </header>

    <main id="mainContent" class="container mx-auto p-3 max-w-5xl">
        
        <!-- STUDENT DASHBOARD (For Student Login) -->
        <section id="studentDashboard" class="tab-content">
            <!-- Ù†ÙØ³ ÙƒÙˆØ¯ Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø·ÙÙŠÙØ© ÙÙŠ Ø§Ù„ØªØµÙ…ÙŠÙ… -->
            <div class="flex justify-end mb-2 no-print"><button onclick="printStudentDashboard()" class="bg-slate-800 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold shadow hover:bg-slate-700">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ±</button></div>
            <div class="grid md:grid-cols-3 gap-3" id="stdDashContainer">
                <div class="glass-card text-center md:col-span-1 border-t-4 border-blue-600 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-400 to-blue-600"></div>
                    <div class="mb-3 relative inline-block p-1 border-2 border-dashed border-gray-200 rounded-xl"><div id="dashQr"></div></div>
                    <h2 class="text-lg font-black text-slate-800" id="dashName"></h2>
                    <p class="text-blue-600 font-mono text-sm font-bold mb-2 bg-blue-50 inline-block px-2 py-0.5 rounded" id="dashCode"></p>
                    <div class="grid grid-cols-2 gap-2 mt-3">
                        <div class="bg-green-50 p-2 rounded-lg border border-green-100"><div class="text-xl font-black text-green-600" id="dashPresent">0</div><div class="text-[9px] text-green-800 font-bold">Ø­Ø¶ÙˆØ±</div></div>
                        <div class="bg-red-50 p-2 rounded-lg border border-red-100"><div class="text-xl font-black text-red-600" id="dashAbsent">0</div><div class="text-[9px] text-red-800 font-bold">ØºÙŠØ§Ø¨</div></div>
                    </div>
                </div>
                <div class="md:col-span-2 space-y-3">
                    <div class="glass-card">
                        <h3 class="font-bold text-xs text-slate-700 border-b pb-2 mb-2">ğŸ’° Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</h3>
                        <div class="overflow-x-auto"><table class="custom-table"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead><tbody id="dashPaymentsTable"></tbody></table></div>
                    </div>
                    <div class="glass-card">
                        <h3 class="font-bold text-xs text-slate-700 border-b pb-2 mb-2">ğŸ“œ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ</h3>
                        <div id="dashHistory" class="max-h-40 overflow-y-auto pr-1 space-y-1"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- STUDENTS TAB -->
        <section id="students" class="tab-content">
            <div class="grid lg:grid-cols-3 gap-3">
                <!-- ØªØ³Ø¬ÙŠÙ„ Ø·Ø§Ù„Ø¨ -->
                <div class="glass-card lg:col-span-1 border-r-4 border-blue-500 no-print">
                    <h2 class="font-bold text-blue-900 mb-3 text-xs flex items-center gap-2"><span class="bg-blue-100 p-1 rounded">ğŸ‘¤</span> ØªØ³Ø¬ÙŠÙ„ Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
                    <div class="space-y-2.5">
                        <input type="text" id="stdName" class="w-full p-2.5 border border-gray-300 rounded-lg text-xs focus:ring-2 focus:ring-blue-500 outline-none transition bg-gray-50 focus:bg-white" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø±Ø¨Ø§Ø¹ÙŠ">
                        <div class="flex items-center border border-gray-300 rounded-lg bg-white overflow-hidden focus-within:ring-2 focus-within:ring-blue-500 transition">
                            <span class="bg-gray-100 px-2 py-2.5 text-gray-500 text-[10px] font-bold border-l">+20</span>
                            <input type="tel" id="stdPhone" oninput="validatePhone(this)" class="w-full p-2.5 text-xs outline-none bg-transparent" placeholder="Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±">
                        </div>
                        <select id="stdLevel" class="w-full p-2.5 border border-gray-300 rounded-lg bg-gray-50 text-xs focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©...</option>
                            <option value="1Ø«">Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                            <option value="2Ø«">Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                            <option value="3Ø«">Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                        </select>
                        <button onclick="registerStudent()" class="w-full bg-blue-600 text-white py-2.5 rounded-lg font-bold shadow-lg shadow-blue-600/20 hover:bg-blue-700 text-xs transition active:scale-95">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                    </div>
                </div>

                <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ -->
                <div class="glass-card lg:col-span-2">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-3 gap-2 no-print">
                        <div class="flex items-center gap-2 w-full sm:w-auto">
                            <h2 class="font-bold text-xs whitespace-nowrap">Ø§Ù„Ø·Ù„Ø§Ø¨ (<span id="stdCount" class="text-blue-600">0</span>)</h2>
                            <select id="studentListFilter" onchange="renderStudents()" class="p-1.5 border rounded-lg text-[10px] bg-white font-bold text-gray-600 w-full sm:w-auto">
                                <option value="all">Ø§Ù„ÙƒÙ„</option>
                                <option value="1Ø«">1Ø«</option>
                                <option value="2Ø«">2Ø«</option>
                                <option value="3Ø«">3Ø«</option>
                            </select>
                        </div>
                        <div class="flex gap-2 w-full sm:w-auto">
                            <input type="text" id="searchStd" onkeyup="renderStudents()" placeholder="Ø¨Ø­Ø«..." class="p-1.5 border rounded-lg text-[10px] w-full focus:ring-1 focus:ring-blue-500 outline-none">
                            <button onclick="printContent('studentsListArea', 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨')" class="bg-slate-800 text-white px-3 py-1.5 rounded-lg text-[10px] shadow hover:bg-slate-700">ğŸ–¨ï¸</button>
                        </div>
                    </div>
                    <div id="studentsListArea" class="overflow-x-auto max-h-[60vh] overflow-y-auto rounded-lg border border-gray-200">
                        <table class="custom-table">
                            <thead class="sticky top-0 z-10"><tr><th class="col-index">#</th><th class="col-code">Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th class="no-print w-10"></th></tr></thead>
                            <tbody id="studentsTable" class="bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- ATTENDANCE TAB -->
        <section id="attendance" class="tab-content">
            <div class="grid md:grid-cols-2 gap-3">
                <div class="glass-card">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-xs font-bold text-blue-900 flex items-center gap-1"><span class="bg-blue-100 p-1 rounded">ğŸ“…</span> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</h2>
                        <input type="date" id="attendanceDate" onchange="changeAttendanceDate()" class="p-1 border rounded text-[10px] font-bold text-blue-900 bg-blue-50">
                    </div>
                    
                    <div id="exceptionalStatusIndicator" class="hidden bg-indigo-50 border border-indigo-200 text-indigo-800 p-2 rounded-lg mb-2 text-[10px] font-bold flex items-center gap-2 animate-pulse">
                        <span>ğŸŒŸ</span> <span>ÙˆØ¶Ø¹ Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠ: <span id="exceptionalLevelName"></span></span>
                    </div>

                    <div class="mb-2">
                        <select id="attendanceStage" onchange="updateCounters()" class="w-full p-2 border rounded-lg text-xs font-bold text-blue-900 bg-white shadow-sm">
                            <option value="all" selected>Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„</option>
                            <option value="1Ø«">Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                            <option value="2Ø«">Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                            <option value="3Ø«">Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                        </select>
                    </div>

                    <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… -->
                    <div class="flex gap-1 mb-2 no-print overflow-x-auto pb-1">
                        <button onclick="openScheduleModal()" class="flex-1 bg-purple-50 text-purple-700 border border-purple-200 py-1.5 rounded-lg font-bold text-[9px] whitespace-nowrap hover:bg-purple-100">ğŸ“… Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
                        <button onclick="confirmSessionDay()" class="flex-1 bg-indigo-50 text-indigo-700 border border-indigo-200 py-1.5 rounded-lg font-bold text-[9px] whitespace-nowrap hover:bg-indigo-100">âœ… ØªØ«Ø¨ÙŠØª</button>
                        <button onclick="cancelSessionDay()" class="flex-1 bg-red-50 text-red-700 border border-red-200 py-1.5 rounded-lg font-bold text-[9px] whitespace-nowrap hover:bg-red-100">âŒ Ø¥Ù„ØºØ§Ø¡</button>
                    </div>

                    <!-- Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ -->
                    <div class="bg-gray-100 p-1 rounded-lg mb-2 flex no-print">
                        <button onclick="setAttMode('scan')" id="btnAttScan" class="flex-1 py-1.5 rounded-md text-[10px] font-bold transition-all bg-white text-blue-600 shadow-sm">ğŸ“· ÙƒØ§Ù…ÙŠØ±Ø§</button>
                        <button onclick="setAttMode('manual')" id="btnAttManual" class="flex-1 py-1.5 rounded-md text-[10px] font-bold transition-all text-gray-500">âŒ¨ï¸ ÙŠØ¯ÙˆÙŠ</button>
                    </div>

                    <div id="attScanArea" class="relative rounded-xl overflow-hidden bg-black">
                        <div id="reader" class="w-full h-48 object-cover"></div>
                        <div id="scanFeedback" class="absolute inset-0 flex items-center justify-center bg-green-500/90 hidden z-20 backdrop-blur-sm"><div class="text-white font-black text-xl animate-bounce drop-shadow-md">âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„</div></div>
                        <div class="absolute bottom-2 left-0 right-0 flex justify-center gap-2 z-10 no-print">
                            <button onclick="startScanner('reader', 'attendance')" class="bg-blue-600/90 backdrop-blur text-white px-4 py-1 rounded-full shadow text-[10px] font-bold">ØªØ´ØºÙŠÙ„</button>
                            <button onclick="stopScanner()" class="bg-red-600/90 backdrop-blur text-white px-4 py-1 rounded-full shadow text-[10px] font-bold">Ø¥ÙŠÙ‚Ø§Ù</button>
                        </div>
                    </div>

                    <div id="attManualArea" class="hidden space-y-2">
                        <input type="number" id="manualAttID" placeholder="Ø§ÙƒØªØ¨ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨" class="w-full text-center text-lg font-bold p-3 border-2 border-blue-100 rounded-xl focus:border-blue-500 outline-none font-mono">
                        <button onclick="manualAttendance()" class="w-full bg-blue-600 text-white py-2 rounded-xl font-bold text-xs shadow hover:bg-blue-700">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</button>
                    </div>

                    <!-- Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª -->
                    <div class="grid grid-cols-2 gap-2 mt-3 no-print">
                        <div onclick="openAttendanceModal('present')" class="bg-green-50 p-3 rounded-xl border border-green-100 cursor-pointer hover:bg-green-100 transition text-center group">
                            <span class="block text-2xl font-black text-green-600 group-hover:scale-110 transition-transform" id="presentCount">0</span>
                            <span class="text-[10px] text-green-800 font-bold">Ø­Ø¶ÙˆØ±</span>
                        </div>
                        <div onclick="openAttendanceModal('absent')" class="bg-red-50 p-3 rounded-xl border border-red-100 cursor-pointer hover:bg-red-100 transition text-center group">
                            <span class="block text-2xl font-black text-red-600 group-hover:scale-110 transition-transform" id="absentCount">0</span>
                            <span class="text-[10px] text-red-800 font-bold">ØºÙŠØ§Ø¨</span>
                        </div>
                    </div>
                </div>

                <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø³Ù…ÙŠ -->
                <div class="glass-card flex flex-col">
                    <div class="flex justify-between items-center mb-2 border-b pb-2">
                        <h3 class="font-bold text-xs text-slate-700">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­ØµØµ Ø§Ù„Ø±Ø³Ù…ÙŠ</h3>
                        <button onclick="printFormalSchedule()" class="bg-gray-800 text-white px-2 py-1 rounded text-[9px]">ğŸ–¨ï¸</button>
                    </div>
                    <div id="formalSchedulePrintArea" class="flex-1 overflow-auto">
                        <table class="custom-table">
                            <thead><tr><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>Ø§Ù„Ø£ÙŠØ§Ù…</th><th class="no-print w-16">Ø£Ø¬Ù†Ø¯Ø©</th></tr></thead>
                            <tbody id="formalScheduleBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- ACCOUNTING TAB -->
        <section id="accounting" class="tab-content">
            <div class="grid md:grid-cols-2 gap-3">
                <!-- Ø§Ø³ØªÙ„Ø§Ù… Ù†Ù‚Ø¯ÙŠØ© -->
                <div class="glass-card border-t-4 border-green-500">
                    <h3 class="font-bold text-green-800 mb-2 text-xs flex items-center gap-2"><span class="bg-green-100 p-1 rounded">ğŸ’µ</span> Ø§Ø³ØªÙ„Ø§Ù… Ù†Ù‚Ø¯ÙŠØ©</h3>
                    <div class="flex bg-gray-100 p-1 rounded-lg mb-2 no-print">
                        <button onclick="togglePayMethod('scan')" id="btnPayScan" class="flex-1 py-1 rounded-md text-[10px] font-bold bg-white text-green-700 shadow-sm transition-all">Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
                        <button onclick="togglePayMethod('manual')" id="btnPayManual" class="flex-1 py-1 rounded-md text-[10px] font-bold text-gray-500 transition-all">ÙƒÙˆØ¯</button>
                    </div>
                    
                    <div id="payScanDiv" class="mb-2 relative">
                        <div id="payReader" class="scanner-wrapper h-32 w-full"></div>
                        <button onclick="startScanner('payReader', 'payment')" class="absolute bottom-2 left-1/2 transform -translate-x-1/2 bg-green-600/90 text-white px-3 py-1 rounded-full text-[9px] font-bold no-print shadow">ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
                    </div>
                    
                    <div id="payManualDiv" class="hidden flex gap-2 mb-2">
                        <input type="number" id="paySearchID" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨" class="flex-1 p-2 border rounded-lg text-center font-bold text-xs outline-none focus:ring-1 focus:ring-green-500">
                        <button onclick="searchStudentForPay()" class="bg-green-600 text-white px-3 rounded-lg text-xs shadow">ğŸ”</button>
                    </div>

                    <div id="paymentForm" class="hidden bg-yellow-50 p-3 rounded-xl border border-yellow-200 animate-fadeIn">
                        <div class="flex justify-between text-[10px] mb-2 font-bold text-yellow-900 border-b border-yellow-200 pb-1">
                            <span id="payStdName"></span>
                            <span id="payStdID" class="font-mono bg-white px-1 rounded border border-yellow-100"></span>
                        </div>
                        <div class="flex gap-2 mb-2">
                            <input type="number" id="payAmount" value="100" class="w-1/3 p-2 border border-yellow-300 rounded-lg text-center font-bold text-xs text-green-700">
                            <select id="payType" class="w-2/3 p-2 border border-yellow-300 rounded-lg text-[10px] bg-white">
                                <option value="Ø´Ù‡Ø±ÙŠØ©">Ø§Ø´ØªØ±Ø§Ùƒ Ø´Ù‡Ø±ÙŠ</option>
                                <option value="Ù…Ø°ÙƒØ±Ø©">Ù…Ø°ÙƒØ±Ø© / ÙƒØªØ§Ø¨</option>
                                <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                            </select>
                        </div>
                        <button onclick="confirmPayment()" class="w-full bg-green-600 text-white py-2 rounded-lg font-bold shadow-lg shadow-green-600/20 text-xs hover:bg-green-700 transition">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹</button>
                    </div>
                </div>

                <!-- Ù…ØµØ±ÙˆÙØ§Øª -->
                <div class="glass-card border-t-4 border-red-500">
                    <h3 class="font-bold text-red-800 mb-2 text-xs flex items-center gap-2"><span class="bg-red-100 p-1 rounded">ğŸ“‰</span> ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ</h3>
                    <div class="space-y-2">
                        <select id="expType" class="w-full p-2 border rounded-lg text-[10px] bg-white outline-none">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù†Ø¯...</option>
                            <option value="Ø±ÙˆØ§ØªØ¨">Ø±ÙˆØ§ØªØ¨ ÙˆØ£Ø¬ÙˆØ±</option>
                            <option value="ÙƒÙ‡Ø±Ø¨Ø§Ø¡">ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙˆÙ…Ø±Ø§ÙÙ‚</option>
                            <option value="Ø¥ÙŠØ¬Ø§Ø±">Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ù…ÙƒØ§Ù†</option>
                            <option value="ØµÙŠØ§Ù†Ø©">ØµÙŠØ§Ù†Ø© ÙˆØ¥ØµÙ„Ø§Ø­Ø§Øª</option>
                            <option value="Ø·Ø¨Ø§Ø¹Ø©">Ø·Ø¨Ø§Ø¹Ø© ÙˆØªØµÙˆÙŠØ±</option>
                            <option value="Ø¨ÙˆÙÙŠÙ‡">Ø¨ÙˆÙÙŠÙ‡ ÙˆØ¶ÙŠØ§ÙØ©</option>
                            <option value="Ù†Ø«Ø±ÙŠØ§Øª">Ù†Ø«Ø±ÙŠØ§Øª Ø£Ø®Ø±Ù‰</option>
                        </select>
                        <div class="flex gap-2">
                            <input type="number" id="expAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" class="flex-1 p-2 border rounded-lg text-[10px] font-bold">
                            <input type="text" id="expNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" class="flex-[1.5] p-2 border rounded-lg text-[10px]">
                        </div>
                        <button onclick="addExpense()" class="w-full bg-red-50 text-red-600 border border-red-200 py-2 rounded-lg font-bold hover:bg-red-100 text-[10px] transition">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
                    </div>
                </div>
            </div>

            <!-- Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ -->
            <div class="bg-slate-800 text-white p-4 rounded-2xl shadow-xl mt-3 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-20 h-20 bg-white/5 rounded-full -mr-10 -mt-10 blur-xl"></div>
                <div class="flex justify-between items-end mb-3 relative z-10">
                    <div>
                        <p class="text-[10px] text-slate-400 font-bold">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙŠÙˆÙ…</p>
                        <p class="text-2xl font-black tracking-tight" id="netProfit">0</p>
                    </div>
                    <div class="text-left text-[10px] font-mono">
                        <div class="text-green-400 bg-green-400/10 px-2 py-0.5 rounded mb-1">ÙˆØ§Ø±Ø¯: <span id="totalRev">0</span></div>
                        <div class="text-red-400 bg-red-400/10 px-2 py-0.5 rounded">ØµØ§Ø¯Ø±: <span id="totalExp">0</span></div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3 relative z-10">
                    <div class="bg-slate-700/50 p-2 rounded-lg border border-slate-600">
                        <h4 class="text-[9px] font-bold text-green-300 mb-1 border-b border-slate-600 pb-1">Ø¢Ø®Ø± Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</h4>
                        <div id="todayRevList" class="h-16 overflow-y-auto text-[9px] space-y-1 pr-1 custom-scrollbar"></div>
                    </div>
                    <div class="bg-slate-700/50 p-2 rounded-lg border border-slate-600">
                        <h4 class="text-[9px] font-bold text-red-300 mb-1 border-b border-slate-600 pb-1">Ø¢Ø®Ø± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h4>
                        <div id="todayExpList" class="h-16 overflow-y-auto text-[9px] space-y-1 pr-1 custom-scrollbar"></div>
                    </div>
                </div>
                <button onclick="printFinancialReport()" class="w-full mt-3 bg-white/10 text-white py-1.5 rounded-lg text-[10px] font-bold hover:bg-white/20 transition border border-white/10">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</button>
            </div>
        </section>

        <!-- REPORTS TAB -->
        <section id="reports" class="tab-content">
            <div class="grid md:grid-cols-2 gap-3">
                <div class="glass-card border-l-4 border-blue-600">
                    <h3 class="font-bold mb-2 text-blue-900 flex items-center gap-2 text-xs"><span>ğŸ‘¤</span> Ø¨Ø­Ø« Ø·Ø§Ù„Ø¨</h3>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="reportStudentSearch" placeholder="Ø§Ø³Ù… Ø£Ùˆ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨" class="flex-1 p-2 border rounded-lg text-xs outline-none focus:ring-1 focus:ring-blue-500">
                        <button onclick="generateStudentReport()" class="bg-blue-600 text-white px-4 rounded-lg font-bold text-[10px] shadow">Ø¨Ø­Ø«</button>
                    </div>
                    <div id="studentReportResult" class="hidden bg-gray-50 p-2 rounded-lg border border-gray-200 text-[10px]"></div>
                </div>

                <div class="glass-card border-l-4 border-indigo-500">
                    <h3 class="font-bold mb-2 text-indigo-900 text-xs">ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ± Ø¹Ø§Ù…Ø©</h3>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <select id="reportType" onchange="toggleReportInputs()" class="p-1.5 border rounded-lg bg-white text-[10px]"><option value="daily">ÙŠÙˆÙ…ÙŠ</option><option value="monthly">Ø´Ù‡Ø±ÙŠ</option></select>
                        <select id="reportStage" class="p-1.5 border rounded-lg bg-white text-[10px]"><option value="all">ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„</option><option value="1Ø«">1Ø«</option><option value="2Ø«">2Ø«</option><option value="3Ø«">3Ø«</option></select>
                    </div>
                    <div id="divDateInput" class="mb-2"><input type="date" id="reportDate" class="w-full p-1.5 border rounded-lg text-[10px]"></div>
                    <div id="divMonthInput" class="hidden mb-2"><input type="month" id="reportMonth" class="w-full p-1.5 border rounded-lg text-[10px]"></div>
                    <button onclick="generateAdvancedReport()" class="w-full bg-indigo-600 text-white py-1.5 rounded-lg font-bold shadow hover:bg-indigo-700 text-[10px]">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                    <div id="reportResult" class="mt-2 hidden bg-gray-50 p-2 rounded-lg border border-gray-200 text-[10px]"></div>
                </div>

                <div class="glass-card border-l-4 border-purple-600 md:col-span-2">
                    <h3 class="font-bold mb-2 text-purple-900 flex items-center gap-2 text-xs"><span>ğŸ“¢</span> Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¬Ù…Ø§Ø¹ÙŠØ©</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-2">
                        <select id="bulkStage" class="p-1.5 border rounded-lg bg-white text-[10px]"><option value="all">Ø§Ù„ÙƒÙ„</option><option value="1Ø«">1Ø«</option><option value="2Ø«">2Ø«</option><option value="3Ø«">3Ø«</option></select>
                        <select id="bulkType" onchange="toggleBulkInputs()" class="p-1.5 border rounded-lg bg-white text-[10px]"><option value="daily">ÙŠÙˆÙ…ÙŠ</option><option value="monthly">Ø´Ù‡Ø±ÙŠ</option></select>
                        <div id="bulkDateDiv" class="md:col-span-2"><input type="date" id="bulkDate" class="w-full p-1.5 border rounded-lg text-[10px]"></div>
                        <div id="bulkMonthDiv" class="hidden md:col-span-2"><input type="month" id="bulkMonth" class="w-full p-1.5 border rounded-lg text-[10px]"></div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openBulkWhatsAppModal()" class="flex-1 bg-green-600 text-white py-2 rounded-lg font-bold shadow hover:bg-green-700 text-[10px] flex items-center justify-center gap-1"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg> ÙˆØ§ØªØ³Ø§Ø¨</button>
                        <button onclick="exportBulkExcel()" class="flex-1 bg-green-800 text-white py-2 rounded-lg font-bold shadow hover:bg-green-900 text-[10px]">ğŸ“Š Excel</button>
                    </div>
                </div>

                <div class="glass-card border-l-4 border-yellow-500 md:col-span-2">
                    <h3 class="font-bold mb-2 flex items-center gap-2 text-yellow-800 text-xs"><span>ğŸ’¾</span> Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
                    <div class="flex gap-2">
                        <button onclick="exportData()" class="flex-1 bg-yellow-50 text-yellow-700 py-1.5 rounded-lg font-bold text-[10px] border border-yellow-200 hover:bg-yellow-100">Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</button>
                        <div class="relative flex-1">
                            <input type="file" id="importFile" onchange="importData(this)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                            <button class="w-full bg-gray-100 text-gray-700 py-1.5 rounded-lg font-bold text-[10px] border border-gray-200 hover:bg-gray-200">Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button>
                        </div>
                        <button onclick="repairSystemData()" class="flex-1 bg-red-50 text-red-600 py-1.5 rounded-lg font-bold text-[10px] border border-red-200 hover:bg-red-100">Ø¥ØµÙ„Ø§Ø­</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- FLOATING BOTTOM NAVIGATION -->
    <nav class="bottom-nav no-print" id="bottomNav">
        <button onclick="showTab('students', this)" id="nav-students" class="nav-btn active">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
            <span>Ø§Ù„Ø·Ù„Ø§Ø¨</span>
        </button>
        <button onclick="showTab('attendance', this)" id="nav-attendance" class="nav-btn">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>
            <span>Ø§Ù„Ø­Ø¶ÙˆØ±</span>
        </button>
        <button onclick="showTab('accounting', this)" id="nav-accounting" class="nav-btn">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <span>Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©</span>
        </button>
        <button onclick="showTab('reports', this)" id="nav-reports" class="nav-btn">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 002 2h2a2 2 0 002-2z" /></svg>
            <span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
        </button>
    </nav>
</div>

<!-- MODALS (Ù†ÙØ³ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø·ÙÙŠÙØ©) -->
<div id="scheduleModal" class="fixed inset-0 bg-black/80 hidden z-[200] flex items-center justify-center p-4 no-print backdrop-blur-sm">
    <div class="bg-white rounded-2xl w-full max-w-md p-4 shadow-2xl h-[70vh] flex flex-col">
        <div class="flex justify-between items-center mb-4 border-b pb-2"><h3 class="font-bold text-lg text-purple-900">ğŸ“… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„</h3><button onclick="closeModal('scheduleModal')" class="text-gray-400 hover:text-red-500 font-bold text-2xl">&times;</button></div>
        <div class="overflow-y-auto flex-1 p-1 space-y-3" id="scheduleContainer"></div>
        <button onclick="saveSchedule()" class="w-full bg-purple-600 text-white py-2.5 rounded-xl font-bold mt-2 shadow">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
    </div>
</div>

<div id="monthlyScheduleModal" class="fixed inset-0 bg-black/80 hidden z-[210] flex items-center justify-center p-4 no-print backdrop-blur-sm">
    <div class="bg-white rounded-2xl w-full max-w-sm p-4 shadow-2xl relative">
        <button onclick="closeModal('monthlyScheduleModal')" class="absolute top-3 right-4 text-gray-400 hover:text-red-500 text-xl font-bold">&times;</button>
        <div id="monthlyScheduleCard">
            <div class="text-center border-b pb-2 mb-2"><h3 class="font-bold text-lg text-blue-900" id="msStageName"></h3><input type="month" id="msMonthInput" onchange="renderMonthlySchedule()" class="mt-1 p-1 border rounded text-xs"></div>
            <div id="msDatesList" class="max-h-60 overflow-y-auto text-sm space-y-1 p-2 border rounded bg-gray-50"></div>
        </div>
        <div class="grid grid-cols-2 gap-2 mt-3"><button onclick="printMonthlySchedule()" class="bg-gray-800 text-white py-2 rounded-lg text-xs font-bold">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button><button onclick="pdfMonthlySchedule()" class="bg-red-600 text-white py-2 rounded-lg text-xs font-bold">ğŸ“„ PDF</button></div>
    </div>
</div>

<div id="studentModal" class="fixed inset-0 bg-black/80 hidden z-[150] flex items-center justify-center p-4 no-print backdrop-blur-sm">
    <div class="bg-white rounded-2xl w-full max-w-xs p-5 text-center relative shadow-2xl">
        <button onclick="closeModal('studentModal')" class="absolute top-3 right-4 text-gray-400 hover:text-red-500 text-xl font-bold">&times;</button>
        <div id="studentCardDisplay" class="border-4 border-double border-blue-100 p-4 rounded-2xl bg-white mb-4 shadow-sm">
            <h3 class="font-bold text-sm mb-2 text-blue-900">Ø¨Ø·Ø§Ù‚Ø© Ø·Ø§Ù„Ø¨</h3>
            <div id="modalQr" class="flex justify-center mb-2"></div>
            <p id="modalCode" class="text-xl font-black font-mono text-blue-600 mb-0 tracking-wider"></p>
            <h2 id="modalName" class="text-lg font-bold mb-0 text-slate-800"></h2>
            <p id="modalLevel" class="text-gray-500 text-xs font-bold"></p>
            <div id="modalPasswordArea" class="mt-3 bg-yellow-50 p-2 rounded-lg border border-yellow-200 hidden"><p class="text-[9px] text-gray-500 font-bold">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</p><p class="font-mono font-bold text-lg text-red-600" id="modalPassword"></p></div>
        </div>
        <div class="grid grid-cols-2 gap-2"><button onclick="printStudentCard()" class="bg-slate-800 text-white py-2 rounded-lg text-[10px] font-bold shadow">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button><button onclick="shareStudentPdf()" class="bg-red-600 text-white py-2 rounded-lg text-[10px] font-bold shadow">ğŸ“„ PDF</button></div>
    </div>
</div>

<div id="detailsModal" class="fixed inset-0 bg-black/80 hidden z-[100] flex items-center justify-center p-4 no-print backdrop-blur-sm">
    <div class="bg-white rounded-2xl w-full max-w-xl p-0 h-[80vh] flex flex-col shadow-2xl overflow-hidden">
        <div class="flex justify-between items-center p-4 border-b bg-gray-50"><h3 id="detailsTitle" class="font-bold text-sm text-gray-800"></h3><div class="flex gap-2"><button onclick="printContent('detailsTableArea', document.getElementById('detailsTitle').innerText)" class="bg-gray-800 text-white px-3 py-1 rounded-lg text-[10px]">ğŸ–¨ï¸</button><button onclick="closeModal('detailsModal')" class="text-red-500 font-bold text-xl hover:bg-red-50 w-8 h-8 rounded-full">&times;</button></div></div>
        <div id="modalFilterContainer" class="p-2 bg-gray-100 border-b hidden">
            <select id="attFilterLevel" onchange="filterAttendanceList()" class="w-full p-2 border rounded-lg bg-white text-[10px]">
                <option value="all">ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„</option>
                <option value="1Ø«">Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                <option value="2Ø«">Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                <option value="3Ø«">Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
            </select>
        </div>
        <div id="detailsTableArea" class="overflow-y-auto flex-1 p-0"><table class="custom-table"><thead id="detailsTableHead"></thead><tbody id="detailsTableBody"></tbody></table></div>
    </div>
</div>

<div id="bulkWhatsAppModal" class="fixed inset-0 bg-black/80 hidden z-[250] flex items-center justify-center p-4 no-print backdrop-blur-sm">
    <div class="bg-white rounded-2xl w-full max-w-md p-4 shadow-2xl h-[80vh] flex flex-col">
        <div class="flex justify-between items-center mb-4 border-b pb-2"><h3 class="font-bold text-lg text-green-900">ğŸ“± Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨ Ø¬Ù…Ø§Ø¹ÙŠ</h3><button onclick="closeModal('bulkWhatsAppModal')" class="text-gray-400 hover:text-red-500 font-bold text-xl">&times;</button></div>
        <div class="bg-yellow-50 p-2 rounded-lg border border-yellow-200 mb-2 text-[10px] text-yellow-800 font-bold">ØªÙ†Ø¨ÙŠÙ‡: Ø³ÙŠØªÙ… ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©.</div>
        <div class="grid grid-cols-12 gap-1 bg-gray-100 p-2 rounded-t-lg font-bold text-xs border-b">
            <div class="col-span-2 text-center">Ù…</div>
            <div class="col-span-7">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</div>
            <div class="col-span-3 text-center">Ø¥Ø¬Ø±Ø§Ø¡</div>
        </div>
        <div id="bulkListContainer" class="overflow-y-auto flex-1 p-2 space-y-1 border rounded-b-lg bg-gray-50"></div>
        <div class="mt-2 pt-2 border-t text-center"><p id="bulkProgress" class="text-xs font-bold text-gray-600 mb-2">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ø±Ø³Ø§Ù„</p></div>
    </div>
</div>

<div id="customAlertModal" class="fixed inset-0 bg-black/80 hidden z-[200000] flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white rounded-2xl p-6 width-full max-w-xs text-center shadow-2xl transform scale-100 transition-transform">
        <div id="alertIcon" class="text-4xl mb-3">âš ï¸</div>
        <h3 id="alertTitle" class="text-lg font-bold text-gray-800 mb-2">ØªÙ†Ø¨ÙŠÙ‡</h3>
        <p id="alertMessage" class="text-sm text-gray-600 font-bold mb-5 leading-relaxed"></p>
        <button onclick="closeCustomAlert()" class="w-full bg-slate-800 text-white py-2.5 rounded-xl font-bold shadow-lg hover:bg-slate-700 transition">Ø­Ø³Ù†Ø§Ù‹</button>
    </div>
</div>

<div id="pdf-generator-container" style="position: absolute; top: -9999px; left: -9999px;"></div>
<div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl z-[200] hidden font-bold text-xs flex items-center gap-2 border border-slate-700"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, onSnapshot, query, where, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    const firebaseConfig = { apiKey: "AIzaSyAttesgksSJWs--veymN8PTRNHBX9r27V0", authDomain: "system-a8c1e.firebaseapp.com", projectId: "system-a8c1e", storageBucket: "system-a8c1e.firebasestorage.app", messagingSenderId: "674440908222", appId: "1:674440908222:web:31221baab0048ee8c63def" };
    const app = initializeApp(firebaseConfig); const db = getFirestore(app);
    window.db = db; window.collection = collection; window.addDoc = addDoc; window.getDocs = getDocs; window.doc = doc; window.deleteDoc = deleteDoc; window.onSnapshot = onSnapshot; window.query = query; window.where = where; window.setDoc = setDoc; window.updateDoc = updateDoc;
    const loading = document.getElementById('loadingOverlay');
    onSnapshot(collection(db, "students"), (snapshot) => { window.students = []; snapshot.forEach(doc => window.students.push({ ...doc.data(), docId: doc.id })); window.renderStudents(); window.updateCounters(); loading.style.display = 'none'; });
    onSnapshot(collection(db, "attendance"), (snapshot) => { window.attendance = []; snapshot.forEach(doc => window.attendance.push({ ...doc.data(), docId: doc.id })); window.updateCounters(); window.renderFormalSchedule(); });
    onSnapshot(collection(db, "accounting"), (snapshot) => { window.accounting = []; snapshot.forEach(doc => window.accounting.push({ ...doc.data(), docId: doc.id })); window.updateFinance(); });
    onSnapshot(doc(db, "settings", "schedule"), (doc) => { if(doc.exists()) window.scheduleData = doc.data(); else window.scheduleData = {}; window.renderFormalSchedule(); window.updateCounters(); });
</script>

<script>
    const stageMap = { "1Ø«": "Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ", "2Ø«": "Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ", "3Ø«": "Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ" };
    const daysOfWeek = [{ id: 'Sunday', name: 'Ø§Ù„Ø£Ø­Ø¯' }, { id: 'Monday', name: 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†' }, { id: 'Tuesday', name: 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡' }, { id: 'Wednesday', name: 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡' }, { id: 'Thursday', name: 'Ø§Ù„Ø®Ù…ÙŠØ³' }, { id: 'Friday', name: 'Ø§Ù„Ø¬Ù…Ø¹Ø©' }, { id: 'Saturday', name: 'Ø§Ù„Ø³Ø¨Øª' }];
    const dayMap = { 'Sunday': 'Ø§Ù„Ø£Ø­Ø¯', 'Monday': 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Tuesday': 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Wednesday': 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Thursday': 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Friday': 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Saturday': 'Ø§Ù„Ø³Ø¨Øª' };

    window.students = []; window.attendance = []; window.accounting = []; window.scheduleData = {};
    
    function getEgyptDate() { return new Date().toLocaleDateString('en-CA', { timeZone: 'Africa/Cairo' }); }
    
    let today = getEgyptDate();
    let selectedAttendanceDate = today; let currentModalStudentId = null; let currentParentPhone = null; let currentScheduleLevel = null; let currentReportData = {};
    let loginMode = 'admin';

    function normalizeArabic(text) { return text.replace(/[Ø£Ø¥Ø¢]/g, 'Ø§').replace(/Ø©/g, 'Ù‡').replace(/Ù‰/g, 'ÙŠ'); }

    window.onload = () => {
        today = getEgyptDate();
        document.getElementById('headerDate').innerText = today;
        document.getElementById('attendanceDate').value = today;
        document.getElementById('reportDate').value = today;
        document.getElementById('bulkDate').value = today;
        document.getElementById('msMonthInput').value = today.substring(0, 7);

        const savedLogin = localStorage.getItem('isLoggedIn');
        const savedMode = localStorage.getItem('loginMode');
        const savedTab = localStorage.getItem('activeTab');
        const savedStudentId = localStorage.getItem('currentStudentId');

        if (savedLogin === 'true') {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('appContent').classList.remove('hidden');
            loginMode = savedMode;
            if (loginMode === 'admin') {
                document.getElementById('bottomNav').classList.remove('hidden');
                showTab(savedTab || 'students', document.getElementById(`nav-${savedTab || 'students'}`));
            } else {
                document.getElementById('bottomNav').classList.add('hidden');
                setTimeout(() => { const student = window.students.find(s => s.id === savedStudentId); if(student) loadStudentDashboard(student); }, 1000);
            }
        } else {
            document.getElementById('loginOverlay').style.display = 'flex';
            showTab('students', document.getElementById('nav-students'));
        }
    };

    window.validatePhone = function(input) { let val = input.value.replace(/\D/g, ''); if (val.startsWith('0')) val = val.substring(1); if (val.length > 10) val = val.substring(0, 10); input.value = val; }
    window.setLoginMode = function(mode) { loginMode = mode; document.getElementById('tabAdmin').className = mode === 'admin' ? 'flex-1 py-2 text-center cursor-pointer rounded-lg font-bold text-xs transition-all bg-white text-blue-900 shadow-sm' : 'flex-1 py-2 text-center cursor-pointer rounded-lg font-bold text-xs text-gray-500 transition-all'; document.getElementById('tabStudent').className = mode === 'student' ? 'flex-1 py-2 text-center cursor-pointer rounded-lg font-bold text-xs transition-all bg-white text-blue-900 shadow-sm' : 'flex-1 py-2 text-center cursor-pointer rounded-lg font-bold text-xs text-gray-500 transition-all'; document.getElementById('loginCode').placeholder = mode === 'admin' ? 'ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©' : 'ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨'; }
    window.handleLogin = function() { const code = document.getElementById('loginCode').value; const pass = document.getElementById('loginPass').value; const errorMsg = document.getElementById('loginError'); if (loginMode === 'admin') { if (code === '1032' && pass === '10321032') { localStorage.setItem('isLoggedIn', 'true'); localStorage.setItem('loginMode', 'admin'); document.getElementById('loginOverlay').style.display = 'none'; document.getElementById('appContent').classList.remove('hidden'); document.getElementById('bottomNav').classList.remove('hidden'); showTab('students', document.getElementById('nav-students')); } else { errorMsg.classList.remove('hidden'); } } else { const student = window.students.find(s => s.id === code); if (student && student.password === pass) { localStorage.setItem('isLoggedIn', 'true'); localStorage.setItem('loginMode', 'student'); localStorage.setItem('currentStudentId', student.id); document.getElementById('loginOverlay').style.display = 'none'; document.getElementById('appContent').classList.remove('hidden'); document.getElementById('bottomNav').classList.add('hidden'); loadStudentDashboard(student); } else { errorMsg.classList.remove('hidden'); } } }
    window.logout = function() { localStorage.clear(); location.reload(); }

    function getStudentStatusForDate(student, dateStr) {
        const dateObj = new Date(dateStr + "T12:00:00");
        const dayName = dateObj.toLocaleDateString('en-US', {weekday: 'long'});
        const attendanceRecord = window.attendance.find(r => r.date === dateStr && r.studentId === student.id);
        const sessionRec = window.attendance.find(r => r.studentId === "SESSION_MARKER" && r.date === dateStr);
        const isGlobalExceptional = sessionRec && (!sessionRec.levels || sessionRec.levels.includes('all') || sessionRec.levels.includes(student.level));
        const studentSchedule = window.scheduleData[student.level] || [];
        const isScheduled = studentSchedule.includes(dayName);
        if (attendanceRecord) { return { status: 'present', time: attendanceRecord.time, isExceptional: (!isScheduled || isGlobalExceptional) }; }
        if (isScheduled || isGlobalExceptional) { return { status: 'absent', isExceptional: isGlobalExceptional }; }
        return { status: 'none' };
    }

    function getDatesInRange(startDate, endDate) {
        const dates = []; let [sY, sM, sD] = startDate.split('-').map(Number); let [eY, eM, eD] = endDate.split('-').map(Number); let curr = new Date(sY, sM - 1, sD, 12, 0, 0); let last = new Date(eY, eM - 1, eD, 12, 0, 0);
        while (curr <= last) { const y = curr.getFullYear(); const m = String(curr.getMonth() + 1).padStart(2, '0'); const d = String(curr.getDate()).padStart(2, '0'); dates.push(`${y}-${m}-${d}`); curr.setDate(curr.getDate() + 1); }
        return dates;
    }

    function calculateStudentStats(student) {
        let present = 0; let absent = 0; let history = []; const joinDate = student.date || '2020-01-01';
        const allDatesForStats = getDatesInRange(joinDate, today);
        allDatesForStats.forEach(dateStr => { const statusObj = getStudentStatusForDate(student, dateStr); if (statusObj.status === 'present') present++; else if (statusObj.status === 'absent') absent++; });
        const studentAtt = window.attendance.filter(a => a.studentId === student.id); const latestAttDate = studentAtt.length > 0 ? studentAtt.map(a => a.date).sort().reverse()[0] : today; const maxDateForHistory = latestAttDate > today ? latestAttDate : today;
        const allDatesForHistory = getDatesInRange(joinDate, maxDateForHistory);
        allDatesForHistory.forEach(dateStr => { const dayAr = new Date(dateStr + "T12:00:00").toLocaleDateString('ar-EG', {weekday: 'long'}); const statusObj = getStudentStatusForDate(student, dateStr); if (statusObj.status === 'present' || (statusObj.status === 'absent' && dateStr <= today)) { history.push({ date: dateStr, day: dayAr, status: statusObj.status, isExceptional: statusObj.isExceptional }); } });
        history.sort((a, b) => new Date(b.date) - new Date(a.date));
        return { present, absent, history };
    }

    function loadStudentDashboard(student) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active')); document.getElementById('studentDashboard').classList.add('active');
        document.getElementById('dashName').innerText = student.name; document.getElementById('dashCode').innerText = student.id;
        document.getElementById('dashQr').innerHTML = ''; new QRCode(document.getElementById("dashQr"), { text: student.id, width: 80, height: 80 });
        const stats = calculateStudentStats(student); document.getElementById('dashPresent').innerText = stats.present; document.getElementById('dashAbsent').innerText = stats.absent;
        const payments = window.accounting.filter(r => r.category === 'revenue' && r.stdId === student.id);
        const payTable = document.getElementById('dashPaymentsTable');
        if(payments.length > 0) { payTable.innerHTML = payments.map(p => `<tr><td>${p.date}</td><td>${p.type}</td><td class="text-green-600 font-bold">${p.amount}</td></tr>`).join(''); } else { payTable.innerHTML = '<tr><td colspan="3" class="text-center text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯ÙÙˆØ¹Ø§Øª</td></tr>'; }
        const historyHtml = stats.history.map(h => `<div class="flex justify-between border-b p-2 ${h.status === 'absent' ? 'bg-red-50' : 'bg-green-50'}"><span>${h.date} (${h.day})</span><span class="font-bold ${h.status === 'absent' ? 'text-red-600' : 'text-green-600'}">${h.status === 'absent' ? 'ØºÙŠØ§Ø¨' : 'Ø­Ø¶ÙˆØ±'} ${h.isExceptional ? '(Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠ)' : ''}</span></div>`).join('');
        document.getElementById('dashHistory').innerHTML = historyHtml || '<p class="text-center text-gray-400 text-xs">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„</p>';
    }

    window.printStudentDashboard = function() {
        const name = document.getElementById('dashName').innerText; const code = document.getElementById('dashCode').innerText;
        const printContainer = document.getElementById('print-container');
        printContainer.innerHTML = `<div class="official-report"><div class="report-header-box"><div class="report-title">Smart Center</div><div class="report-subtitle">ØªÙ‚Ø±ÙŠØ± Ø·Ø§Ù„Ø¨</div></div><div style="text-align:center; margin-bottom:20px;"><h2>${name}</h2><h3>${code}</h3></div>${document.getElementById('dashPaymentsTable').parentElement.innerHTML}${document.getElementById('dashHistory').innerHTML}</div>`;
        window.print(); setTimeout(() => printContainer.innerHTML = '', 1000);
    }

    window.renderFormalSchedule = function() {
        const tbody = document.getElementById('formalScheduleBody'); if(!tbody) return; tbody.innerHTML = '';
        Object.keys(stageMap).forEach(level => { const days = window.scheduleData[level] || []; if(days.length > 0) { const daysAr = days.map(d => dayMap[d]).join('ØŒ '); tbody.innerHTML += `<tr><td class="font-bold text-blue-900">${stageMap[level]}</td><td>${daysAr}</td><td class="no-print"><button onclick="openMonthlySchedule('${level}')" class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-[9px] font-bold hover:bg-blue-200 border border-blue-200">ğŸ“…</button></td></tr>`; } });
        if(tbody.innerHTML === '') tbody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-2">Ù„Ù… ÙŠØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø¹Ø¯</td></tr>';
    }

    window.printFormalSchedule = function() { const content = document.getElementById('formalSchedulePrintArea').innerHTML; const printContainer = document.getElementById('print-container'); printContainer.innerHTML = `<div class="report-print-container"><div class="report-header"><h1>Smart Center</h1><h2>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø±Ø³Ù…ÙŠ</h2></div>${content}</div>`; window.print(); setTimeout(() => printContainer.innerHTML = '', 1000); }
    
    async function showTab(id, btn) {
        if(isScannerRunning) await stopScanner();
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        if(btn) btn.classList.add('active');
        localStorage.setItem('activeTab', id);
        if(id === 'attendance') window.renderFormalSchedule();
    }

    async function registerStudent() { const name = document.getElementById('stdName').value; const level = document.getElementById('stdLevel').value; let phone = document.getElementById('stdPhone').value; if(!name || !level) return showToast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error'); phone = phone.replace(/\D/g, ''); if(phone.startsWith('0')) phone = phone.substring(1); let id; do { id = Math.floor(1000 + Math.random() * 9000).toString(); } while (window.students.some(s => s.id === id)); const password = Math.floor(100000 + Math.random() * 900000).toString(); const createdAt = new Date().toISOString(); try { await window.addDoc(window.collection(window.db, "students"), { id, name, level, phone, date: today, password, createdAt }); openStudentModal(id); document.getElementById('stdName').value = ''; document.getElementById('stdPhone').value = ''; showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨', 'success'); } catch (e) { showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error'); } }
    
    window.renderStudents = function() {
        const query = normalizeArabic(document.getElementById('searchStd').value.toLowerCase()); const filterStage = document.getElementById('studentListFilter').value; const tbody = document.getElementById('studentsTable');
        let filtered = window.students; if(filterStage !== 'all') { filtered = filtered.filter(s => s.level === filterStage); } if(query !== '') { filtered = filtered.filter(s => normalizeArabic(s.name.toLowerCase()).includes(query) || s.id.includes(query)); }
        filtered.sort((a, b) => { const dateA = a.createdAt ? new Date(a.createdAt) : new Date(a.date); const dateB = b.createdAt ? new Date(b.createdAt) : new Date(b.date); return dateB - dateA; });
        document.getElementById('stdCount').innerText = filtered.length;
        tbody.innerHTML = filtered.map((s, index) => `<tr class="cursor-pointer hover:bg-blue-50 transition" onclick="openStudentModal('${s.id}')"><td class="col-index text-gray-400">${index + 1}</td><td class="col-code">${s.id}</td><td class="font-bold text-slate-700">${s.name}</td><td>${stageMap[s.level] || s.level}</td><td class="no-print" onclick="event.stopPropagation()"><button onclick="delStudent('${s.docId}', '${s.id}')" class="text-red-400 hover:text-red-600 text-[10px] font-bold">ğŸ—‘ï¸</button></td></tr>`).join('');
    }

    function openStudentModal(id) { const s = window.students.find(st => st.id === id); if(!s) return; currentModalStudentId = id; document.getElementById('modalName').innerText = s.name; document.getElementById('modalCode').innerText = s.id; document.getElementById('modalLevel').innerText = stageMap[s.level] || s.level; const passArea = document.getElementById('modalPasswordArea'); const passTxt = document.getElementById('modalPassword'); if(s.password) { passArea.classList.remove('hidden'); passTxt.innerText = s.password; } else { passArea.classList.add('hidden'); } document.getElementById('modalQr').innerHTML = ''; new QRCode(document.getElementById("modalQr"), { text: s.id, width: 100, height: 100 }); document.getElementById('studentModal').classList.remove('hidden'); }
    
    let html5QrCode = null; let isScannerRunning = false; let isPaused = false;
    window.changeAttendanceDate = function() { selectedAttendanceDate = document.getElementById('attendanceDate').value; window.updateCounters(); }
    window.confirmSessionDay = async function() { const date = document.getElementById('attendanceDate').value; const selectedLevel = document.getElementById('attendanceStage').value; if(!selectedLevel) { showToast('Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø©', 'error'); return; } const sessionQuery = window.query(window.collection(window.db, "attendance"), window.where("studentId", "==", "SESSION_MARKER"), window.where("date", "==", date)); const snapshot = await window.getDocs(sessionQuery); let newLevels = []; if (!snapshot.empty) { const docRef = snapshot.docs[0].ref; const currentData = snapshot.docs[0].data(); let currentLevels = currentData.levels || []; if (selectedLevel === 'all') { newLevels = ['all']; } else { if (currentLevels.includes('all')) currentLevels = []; if (!currentLevels.includes(selectedLevel)) currentLevels.push(selectedLevel); newLevels = currentLevels; } await window.updateDoc(docRef, { levels: newLevels }); } else { newLevels = selectedLevel === 'all' ? ['all'] : [selectedLevel]; await window.addDoc(window.collection(window.db, "attendance"), { date: date, studentId: "SESSION_MARKER", time: new Date().toLocaleTimeString('ar-EG'), levels: newLevels }); } showToast(`ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª`, 'success'); window.updateCounters(); }
    window.cancelSessionDay = async function() { const date = document.getElementById('attendanceDate').value; document.getElementById('exceptionalStatusIndicator').classList.add('hidden'); window.attendance = window.attendance.filter(r => !(r.studentId === "SESSION_MARKER" && r.date === date)); window.updateCounters(); const sessionQuery = window.query(window.collection(window.db, "attendance"), window.where("studentId", "==", "SESSION_MARKER"), window.where("date", "==", date)); const snapshot = await window.getDocs(sessionQuery); if (!snapshot.empty) { snapshot.forEach(async (doc) => { await window.deleteDoc(doc.ref); }); showToast('ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡', 'success'); } }
    window.repairSystemData = async function() { if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return; showToast('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­...', 'success'); setTimeout(() => { showToast('ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­', 'success'); location.reload(); }, 1500); }
    
    async function startScanner(elemId, mode) { if(isScannerRunning) return; html5QrCode = new Html5Qrcode(elemId); await html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => { if(isPaused) return; if(mode === 'attendance') handleAttendanceScan(decodedText); else if(mode === 'payment') handlePaymentScan(decodedText); }); isScannerRunning = true; }
    async function stopScanner() { if(html5QrCode && isScannerRunning) { try { await html5QrCode.stop(); html5QrCode.clear(); } catch(e) {} html5QrCode = null; isScannerRunning = false; } }
    
    function showCustomAlert(title, message) { document.getElementById('alertTitle').innerText = title; document.getElementById('alertMessage').innerText = message; document.getElementById('customAlertModal').style.display = 'flex'; playSound('error'); }
    window.closeCustomAlert = function() { document.getElementById('customAlertModal').style.display = 'none'; isPaused = false; }
    
    async function handleAttendanceScan(id) {
        isPaused = true; const student = window.students.find(s => s.id === id);
        if(student) {
            const selectedLevel = document.getElementById('attendanceStage').value; const date = selectedAttendanceDate; const statusObj = getStudentStatusForDate(student, date);
            if (statusObj.status === 'present') { showToast('Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹', 'warning'); playSound('error'); setTimeout(() => { isPaused = false; }, 2000); return; }
            const dateObj = new Date(date + "T12:00:00"); const dayName = dateObj.toLocaleDateString('en-US', {weekday: 'long'}); const studentSchedule = window.scheduleData[student.level] || []; const isScheduled = studentSchedule.includes(dayName); const sessionRec = window.attendance.find(r => r.studentId === "SESSION_MARKER" && r.date === date); const isExceptional = sessionRec && (!sessionRec.levels || sessionRec.levels.includes('all') || sessionRec.levels.includes(student.level));
            if (!isScheduled && !isExceptional) { showCustomAlert("ÙŠÙˆÙ… Ø®Ø§Ø·Ø¦", `Ù„ÙŠØ³ ÙŠÙˆÙ… Ø­Ø¶ÙˆØ± Ø§Ù„Ø·Ø§Ù„Ø¨ (${student.name})`); return; }
            if(selectedLevel !== 'all' && selectedLevel && student.level !== selectedLevel && !isExceptional) { if(!confirm(`Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ ${stageMap[student.level]} ÙˆØ£Ù†Øª ØªØ³Ø¬Ù„ Ù„Ù€ ${stageMap[selectedLevel]}. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`)) { isPaused = false; return; } }
            await window.addDoc(window.collection(window.db, "attendance"), { date: date, studentId: id, time: new Date().toLocaleTimeString('ar-EG') }); showScanFeedback(true); playSound('success');
        } else { showToast('ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­', 'error'); playSound('error'); }
        setTimeout(() => { isPaused = false; showScanFeedback(false); }, 2000);
    }
    function showScanFeedback(show) { const el = document.getElementById('scanFeedback'); if(show) el.classList.remove('hidden'); else el.classList.add('hidden'); }
    function setAttMode(mode) { stopScanner().then(() => { const btnScan = document.getElementById('btnAttScan'); const btnManual = document.getElementById('btnAttManual'); if(mode === 'scan') { document.getElementById('attScanArea').classList.remove('hidden'); document.getElementById('attManualArea').classList.add('hidden'); btnScan.classList.add('bg-white', 'text-blue-600', 'shadow-sm'); btnScan.classList.remove('text-gray-500'); btnManual.classList.add('text-gray-500'); btnManual.classList.remove('bg-white', 'text-blue-600', 'shadow-sm'); } else { document.getElementById('attScanArea').classList.add('hidden'); document.getElementById('attManualArea').classList.remove('hidden'); btnManual.classList.add('bg-white', 'text-blue-600', 'shadow-sm'); btnManual.classList.remove('text-gray-500'); btnScan.classList.add('text-gray-500'); btnScan.classList.remove('bg-white', 'text-blue-600', 'shadow-sm'); } }); }
    function manualAttendance() { const id = document.getElementById('manualAttID').value; handleAttendanceScan(id); document.getElementById('manualAttID').value = ''; }
    
    let currentAttType = 'present';
    function openAttendanceModal(type) { currentAttType = type; const title = type === 'present' ? `Ø­Ø¶ÙˆØ± (${selectedAttendanceDate})` : `ØºÙŠØ§Ø¨ (${selectedAttendanceDate})`; document.getElementById('detailsTitle').innerText = title; const mainStage = document.getElementById('attendanceStage').value; document.getElementById('attFilterLevel').value = mainStage || 'all'; document.getElementById('modalFilterContainer').classList.remove('hidden'); const thead = document.getElementById('detailsTableHead'); thead.innerHTML = `<tr><th class="col-index">Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>${type === 'present' ? 'ÙˆÙ‚Øª' : 'ØªØ§Ø±ÙŠØ®'}</th></tr>`; document.getElementById('detailsModal').classList.remove('hidden'); filterAttendanceList(); }
    function filterAttendanceList() {
        const levelFilter = document.getElementById('attFilterLevel').value; const tbody = document.getElementById('detailsTableBody');
        let targetStudents = window.students.filter(s => s.date <= selectedAttendanceDate); if(levelFilter !== 'all') targetStudents = targetStudents.filter(s => s.level === levelFilter);
        let list = []; targetStudents.forEach(student => { const statusObj = getStudentStatusForDate(student, selectedAttendanceDate); if (currentAttType === 'present' && statusObj.status === 'present') { list.push({ ...student, time: statusObj.time }); } else if (currentAttType === 'absent' && statusObj.status === 'absent') { list.push({ ...student, time: selectedAttendanceDate }); } });
        if(list.length === 0) tbody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`; else tbody.innerHTML = list.map((s, index) => `<tr class="cursor-pointer hover:bg-blue-50" onclick="openStudentModal('${s.id}')"><td class="col-index">${index + 1}</td><td class="font-bold">${s.name}</td><td class="font-mono text-blue-600">${s.id}</td><td>${stageMap[s.level] || s.level}</td><td class="${currentAttType === 'present' ? 'text-green-600' : 'text-red-600'}">${s.time}</td></tr>`).join('');
    }
    
    window.updateCounters = function() {
        const selectedLevel = document.getElementById('attendanceStage').value; const date = selectedAttendanceDate; const sessionRec = window.attendance.find(r => r.studentId === "SESSION_MARKER" && r.date === date); const indicator = document.getElementById('exceptionalStatusIndicator'); const levelNameSpan = document.getElementById('exceptionalLevelName');
        if (sessionRec) { let levelsText = ""; if (sessionRec.levels.includes('all')) levelsText = "Ø§Ù„ÙƒÙ„"; else levelsText = sessionRec.levels.map(l => stageMap[l]).join('ØŒ '); levelNameSpan.innerText = levelsText; indicator.classList.remove('hidden'); } else { indicator.classList.add('hidden'); }
        let targetStudents = window.students.filter(s => s.date <= date); if(selectedLevel !== 'all') targetStudents = targetStudents.filter(s => s.level === selectedLevel);
        let presentCount = 0; let absentCount = 0; targetStudents.forEach(student => { const statusObj = getStudentStatusForDate(student, date); if (statusObj.status === 'present') presentCount++; else if (statusObj.status === 'absent') absentCount++; });
        document.getElementById('presentCount').innerText = presentCount; document.getElementById('absentCount').innerText = absentCount;
    }

    function generateStudentReport() {
        const query = normalizeArabic(document.getElementById('reportStudentSearch').value.toLowerCase()); const student = window.students.find(s => normalizeArabic(s.name.toLowerCase()).includes(query) || s.id === query); const resDiv = document.getElementById('studentReportResult');
        if(!student) { resDiv.innerHTML = '<p class="text-red-500 text-center">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ±</p>'; resDiv.classList.remove('hidden'); return; }
        currentParentPhone = student.phone; const stats = calculateStudentStats(student); const payments = window.accounting.filter(r => r.category === 'revenue' && r.stdId === student.id); const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
        resDiv.innerHTML = `<div class="border-b pb-2 mb-2"><h4 class="font-bold text-lg text-blue-900">${student.name}</h4><p class="text-gray-500 text-xs">ÙƒÙˆØ¯: ${student.id} | ${stageMap[student.level]}</p></div><div class="grid grid-cols-2 gap-2 mb-4 text-center"><div class="bg-green-100 p-2 rounded"><div class="text-xs">Ø­Ø¶ÙˆØ±</div><div class="font-bold text-green-700">${stats.present}</div></div><div class="bg-red-100 p-2 rounded"><div class="text-xs">ØºÙŠØ§Ø¨</div><div class="font-bold text-red-700">${stats.absent}</div></div></div><div class="mb-2"><h5 class="font-bold text-xs mb-1">Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª (${totalPaid} Ø¬.Ù…)</h5><div class="max-h-24 overflow-y-auto text-xs border rounded p-1">${payments.length ? payments.map(p => `<div class="flex justify-between border-b p-1"><span>${p.type}</span><span>${p.amount}</span></div>`).join('') : '<p class="text-center">Ù„Ø§ ÙŠÙˆØ¬Ø¯</p>'}</div></div><div class="flex gap-2"><button onclick="shareStudentReport()" class="flex-1 bg-green-600 text-white py-1.5 rounded text-xs font-bold">ÙˆØ§ØªØ³Ø§Ø¨</button><button onclick="printDetailedStudentReport('${student.id}')" class="flex-1 bg-gray-800 text-white py-1.5 rounded text-xs font-bold">Ø·Ø¨Ø§Ø¹Ø©</button></div>`; resDiv.classList.remove('hidden');
    }

    function printDetailedStudentReport(studentId) { const s = window.students.find(st => st.id === studentId); if(!s) return; const stats = calculateStudentStats(s); const payments = window.accounting.filter(r => r.category === 'revenue' && r.stdId === s.id); const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0); const printContainer = document.getElementById('print-container'); printContainer.innerHTML = `<div class="report-print-container"><div class="report-header"><h1>Smart Center</h1><h2>ØªÙ‚Ø±ÙŠØ± Ø·Ø§Ù„Ø¨ ØªÙØµÙŠÙ„ÙŠ</h2></div><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;"><div><h4>${s.name} (${s.id})</h4><p>${stageMap[s.level] || s.level}</p></div><div id="printReportQr"></div></div><div class="stats-grid"><div>Ø­Ø¶ÙˆØ±: <strong>${stats.present}</strong></div><div>ØºÙŠØ§Ø¨: <strong>${stats.absent}</strong></div><div>Ù…Ø¯ÙÙˆØ¹Ø§Øª: <strong>${totalPaid} Ø¬.Ù…</strong></div></div><h3 style="margin-top:15px; border-bottom:1px solid #000;">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</h3><table class="report-table"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead><tbody>${payments.map(p => `<tr><td>${p.date}</td><td>${p.type}</td><td>${p.amount}</td></tr>`).join('') || '<tr><td colspan="3">Ù„Ø§ ÙŠÙˆØ¬Ø¯</td></tr>'}</tbody></table></div>`; new QRCode(document.getElementById("printReportQr"), { text: s.id, width: 80, height: 80 }); setTimeout(() => { window.print(); setTimeout(() => { printContainer.innerHTML = ''; }, 1000); }, 500); }

    function generateAdvancedReport() {
        const type = document.getElementById('reportType').value; const stage = document.getElementById('reportStage').value; const dateInput = document.getElementById('reportDate').value; const monthInput = document.getElementById('reportMonth').value; const resDiv = document.getElementById('reportResult');
        let totalRev = 0, totalExp = 0; currentReportData = { present: [], absent: [], revenues: [], expenses: [] }; let targetStudents = window.students; if(stage !== 'all') targetStudents = window.students.filter(s => s.level === stage);
        if(type === 'daily') { if(!dateInput) return showToast('Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®', 'error'); targetStudents = targetStudents.filter(s => s.date <= dateInput); targetStudents.forEach(student => { const statusObj = getStudentStatusForDate(student, dateInput); if (statusObj.status === 'present') { currentReportData.present.push({ ...student, time: statusObj.time }); } else if (statusObj.status === 'absent') { currentReportData.absent.push({ ...student, time: 'ØºÙŠØ§Ø¨' }); } }); currentReportData.revenues = window.accounting.filter(r => r.category === 'revenue' && r.date === dateInput); currentReportData.expenses = window.accounting.filter(e => e.category === 'expense' && e.date === dateInput); } else { if(!monthInput) return showToast('Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±', 'error'); const [year, month] = monthInput.split('-').map(Number); const daysInMonth = new Date(year, month, 0).getDate(); const daysArray = []; for(let i=1; i<=daysInMonth; i++) { const d = String(i).padStart(2, '0'); const m = String(month).padStart(2, '0'); daysArray.push(`${year}-${m}-${d}`); } let monthlyStats = {}; targetStudents.forEach(s => { monthlyStats[s.id] = { name: s.name, level: s.level, present: 0, absentDates: [] }; }); targetStudents.forEach(student => { daysArray.forEach(dateStr => { if (dateStr < student.date) return; const statusObj = getStudentStatusForDate(student, dateStr); if (statusObj.status === 'present') monthlyStats[student.id].present++; else if (statusObj.status === 'absent') monthlyStats[student.id].absentDates.push(dateStr); }); }); currentReportData.present = Object.values(monthlyStats).map(s => ({ ...s, time: `${s.present} ÙŠÙˆÙ…` })); currentReportData.absent = Object.values(monthlyStats).filter(s => s.absentDates.length > 0).map(s => ({ ...s, time: s.absentDates.join('<br>') })); currentReportData.revenues = window.accounting.filter(r => r.category === 'revenue' && r.date.startsWith(monthInput)); currentReportData.expenses = window.accounting.filter(e => e.category === 'expense' && e.date.startsWith(monthInput)); }
        totalRev = currentReportData.revenues.reduce((a,b)=>a+b.amount,0); totalExp = currentReportData.expenses.reduce((a,b)=>a+b.amount,0);
        let html = `<h4 class="font-bold text-center border-b pb-2 mb-2">ØªÙ‚Ø±ÙŠØ± ${type === 'daily' ? dateInput : monthInput}</h4><div class="grid grid-cols-2 gap-2 mb-4 text-center"><div onclick='openReportDetails("present")' class="bg-green-100 p-2 rounded cursor-pointer hover:bg-green-200"><div class="text-xs">Ø­Ø¶ÙˆØ±</div><div class="font-bold text-green-700">${type === 'daily' ? currentReportData.present.length : 'Ø¹Ø±Ø¶'}</div></div><div onclick='openReportDetails("absent")' class="bg-red-100 p-2 rounded cursor-pointer hover:bg-red-200"><div class="text-xs">ØºÙŠØ§Ø¨</div><div class="font-bold text-red-700">${type === 'daily' ? currentReportData.absent.length : 'Ø¹Ø±Ø¶'}</div></div></div><div class="space-y-2"><div onclick='openReportDetails("revenues")' class="bg-green-50 p-2 rounded border border-green-200 cursor-pointer hover:bg-green-100 flex justify-between"><span class="text-xs text-gray-500">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</span><span class="font-bold text-green-700">${totalRev} Ø¬.Ù…</span></div><div onclick='openReportDetails("expenses")' class="bg-red-50 p-2 rounded border border-red-200 cursor-pointer hover:bg-red-100 flex justify-between"><span class="text-xs text-gray-500">Ù…ØµØ±ÙˆÙØ§Øª</span><span class="font-bold text-red-700">${totalExp} Ø¬.Ù…</span></div><div class="bg-blue-50 p-2 rounded border border-blue-200 text-center"><span class="text-xs text-gray-500">Ø§Ù„ØµØ§ÙÙŠ</span><span class="font-bold text-blue-900 text-lg block">${totalRev - totalExp} Ø¬.Ù…</span></div></div>`; resDiv.innerHTML = html; resDiv.classList.remove('hidden');
    }

    function toggleBulkInputs() { const type = document.getElementById('bulkType').value; if(type === 'daily') { document.getElementById('bulkDateDiv').classList.remove('hidden'); document.getElementById('bulkMonthDiv').classList.add('hidden'); } else { document.getElementById('bulkDateDiv').classList.add('hidden'); document.getElementById('bulkMonthDiv').classList.remove('hidden'); } }
    function getBulkStudents() { const stage = document.getElementById('bulkStage').value; let students = window.students; if(stage !== 'all') students = students.filter(s => s.level === stage); return students; }
    function exportBulkExcel() { const students = getBulkStudents(); const type = document.getElementById('bulkType').value; const dateVal = type === 'daily' ? document.getElementById('bulkDate').value : document.getElementById('bulkMonth').value; if(!dateVal) return showToast('Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®', 'error'); let csvContent = "\uFEFF"; if (type === 'daily') { csvContent += "Ø§Ù„ÙƒÙˆØ¯,Ø§Ù„Ø§Ø³Ù…,Ø§Ù„Ù…Ø±Ø­Ù„Ø©,Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ,Ø­Ø§Ù„Ø© Ø§Ù„ÙŠÙˆÙ…,ÙˆÙ‚Øª Ø§Ù„Ø­Ø¶ÙˆØ±,ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª\n"; students.forEach(s => { const statusObj = getStudentStatusForDate(s, dateVal); let statusText = "ØºÙŠØ§Ø¨"; let timeText = "-"; if (statusObj.status === 'present') { statusText = statusObj.isExceptional ? "Ø­Ø¶ÙˆØ± (Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠ)" : "Ø­Ø¶ÙˆØ±"; timeText = statusObj.time; } else if (statusObj.status === 'none') { statusText = "Ù„ÙŠØ³ ÙŠÙˆÙ…Ù‡"; } const payments = window.accounting.filter(r => r.category === 'revenue' && r.stdId === s.id); const payDetails = payments.map(p => `${p.amount} (${p.type})`).join(' | '); csvContent += `${s.id},"${s.name}",${stageMap[s.level] || s.level}','${s.phone},${statusText},${timeText},"${payDetails}"\n`; }); } else { csvContent += "Ø§Ù„ÙƒÙˆØ¯,Ø§Ù„Ø§Ø³Ù…,Ø§Ù„Ù…Ø±Ø­Ù„Ø©,Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ,Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±,Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨,Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª\n"; students.forEach(s => { const stats = calculateStudentStats(s); const payments = window.accounting.filter(r => r.category === 'revenue' && r.stdId === s.id); const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0); csvContent += `${s.id},"${s.name}",${stageMap[s.level] || s.level}','${s.phone},${stats.present},${stats.absent},${totalPaid}\n`; }); } const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.setAttribute("href", url); link.setAttribute("download", `ØªÙ‚Ø±ÙŠØ±_Ø´Ø§Ù…Ù„_${dateVal}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); }

    let bulkQueue = [];
    function openBulkWhatsAppModal() { const students = getBulkStudents(); if(students.length === 0) return showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨', 'error'); bulkQueue = students; const container = document.getElementById('bulkListContainer'); container.innerHTML = `<table class="w-full text-[10px] border-collapse">${students.map((s, i) => `<tr class="border-b hover:bg-gray-100" id="bulk-row-${i}"><td class="p-1 text-center w-8 font-bold text-gray-500">${i+1}</td><td class="p-1 font-bold">${s.name}</td><td class="p-1 text-center w-16"><button onclick="sendSingleWhatsApp(${i})" class="bg-green-600 text-white px-2 py-1 rounded shadow hover:bg-green-700 transition">Ø¥Ø±Ø³Ø§Ù„</button></td></tr>`).join('')}</table>`; document.getElementById('bulkWhatsAppModal').classList.remove('hidden'); }
    window.sendSingleWhatsApp = function(index) { const student = bulkQueue[index]; const bulkType = document.getElementById('bulkType').value; let msg = ""; if (bulkType === 'daily') { const dateVal = document.getElementById('bulkDate').value; const statusObj = getStudentStatusForDate(student, dateVal); let statusText = "ØºÙŠØ§Ø¨"; if (statusObj.status === 'present') statusText = "Ø­Ø¶ÙˆØ±"; const payments = window.accounting.filter(r => r.category === 'revenue' && r.stdId === student.id && r.date === dateVal); let payText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯"; if (payments.length > 0) { payText = payments.map(p => `${p.amount} Ø¬.Ù… (${p.type})`).join(' + '); } msg = `${student.name}\n${student.id}\n${dateVal}\nØ­Ø§Ù„Ø© Ø§Ù„ÙŠÙˆÙ…: ${statusText}\nØ§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª: ${payText}`; } else { const monthVal = document.getElementById('bulkMonth').value; const stats = calculateStudentStats(student); const monthPresent = stats.history.filter(h => h.date.startsWith(monthVal) && h.status === 'present').length; const monthAbsent = stats.history.filter(h => h.date.startsWith(monthVal) && h.status === 'absent').length; const payments = window.accounting.filter(r => r.category === 'revenue' && r.stdId === student.id && r.date.startsWith(monthVal)); const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0); msg = `*ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±: ${monthVal}*\nØ§Ù„Ø·Ø§Ù„Ø¨: ${student.name}\n----------------\nâœ… Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±: ${monthPresent}\nâŒ Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨: ${monthAbsent}\nğŸ’° Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª: ${totalPaid} Ø¬.Ù…`; } const url = `https://wa.me/20${student.phone}?text=${encodeURIComponent(msg)}`; window.open(url, '_blank'); const row = document.getElementById(`bulk-row-${index}`); row.classList.add('bg-green-100'); const btn = row.querySelector('button'); btn.innerText = 'ØªÙ… âœ…'; btn.className = 'bg-gray-400 text-white px-2 py-1 rounded cursor-not-allowed'; btn.disabled = true; if(index + 1 < bulkQueue.length) { document.getElementById('bulkProgress').innerHTML = `Ø§Ù„ØªØ§Ù„ÙŠ: <button onclick="sendSingleWhatsApp(${index+1})" class="text-blue-600 underline font-bold">${bulkQueue[index+1].name}</button>`; } else { document.getElementById('bulkProgress').innerText = "ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©!"; } }

    window.openScheduleModal = function() { const container = document.getElementById('scheduleContainer'); container.innerHTML = ''; Object.keys(stageMap).forEach(level => { const savedDays = window.scheduleData[level] || []; let daysHtml = daysOfWeek.map(day => `<label class="inline-flex items-center ml-2 mb-1"><input type="checkbox" class="form-checkbox h-3 w-3 text-purple-600" name="schedule_${level}" value="${day.id}" ${savedDays.includes(day.id) ? 'checked' : ''}><span class="mr-1 text-[10px]">${day.name}</span></label>`).join(''); container.innerHTML += `<div class="bg-gray-50 p-2 rounded border"><div class="flex justify-between items-center mb-1"><h4 class="font-bold text-xs text-blue-900">${stageMap[level]}</h4></div><div class="flex flex-wrap">${daysHtml}</div></div>`; }); document.getElementById('scheduleModal').classList.remove('hidden'); }
    window.saveSchedule = async function() { const newSchedule = {}; Object.keys(stageMap).forEach(level => { const checkboxes = document.querySelectorAll(`input[name="schedule_${level}"]:checked`); if(checkboxes.length > 0) newSchedule[level] = Array.from(checkboxes).map(cb => cb.value); }); try { await window.setDoc(window.doc(window.db, "settings", "schedule"), newSchedule); window.scheduleData = newSchedule; closeModal('scheduleModal'); showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙˆÙ„', 'success'); window.renderFormalSchedule(); window.updateCounters(); } catch(e) { showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸', 'error'); } }
    window.openMonthlySchedule = function(level) { currentScheduleLevel = level; document.getElementById('msStageName').innerText = `Ø¬Ø¯ÙˆÙ„: ${stageMap[level]}`; renderMonthlySchedule(); document.getElementById('monthlyScheduleModal').classList.remove('hidden'); }
    window.renderMonthlySchedule = function() { if(!currentScheduleLevel) return; const monthInput = document.getElementById('msMonthInput').value; const [year, month] = monthInput.split('-').map(Number); const targetDays = window.scheduleData[currentScheduleLevel] || []; const listDiv = document.getElementById('msDatesList'); if(targetDays.length === 0) { listDiv.innerHTML = '<p class="text-center text-gray-500">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠØ§Ù…</p>'; return; } const daysInMonth = new Date(year, month, 0).getDate(); let dates = []; for(let i=1; i<=daysInMonth; i++) { const d = new Date(year, month - 1, i, 12, 0, 0); let dayName = d.toLocaleDateString('en-US', {weekday: 'long'}); if (targetDays.includes(dayName)) { const y = d.getFullYear(); const m = String(d.getMonth() + 1).padStart(2, '0'); const day = String(d.getDate()).padStart(2, '0'); dates.push({ date: `${y}-${m}-${day}`, dayAr: d.toLocaleDateString('ar-EG', {weekday: 'long'}) }); } } listDiv.innerHTML = dates.map(d => `<div class="flex justify-between border-b border-gray-200 pb-1 last:border-0"><span class="font-bold text-blue-900">${d.dayAr}</span><span class="font-mono text-gray-600">${d.date}</span></div>`).join(''); }
    window.printMonthlySchedule = function() { const content = document.getElementById('monthlyScheduleCard').innerHTML; const printContainer = document.getElementById('print-container'); printContainer.innerHTML = `<div class="agenda-print-wrapper"><h2>Smart Center</h2>${content}</div>`; window.print(); setTimeout(() => { printContainer.innerHTML = ''; }, 1000); }
    window.pdfMonthlySchedule = function() { const element = document.getElementById('monthlyScheduleCard'); const opt = { margin: 10, filename: `Ø¬Ø¯ÙˆÙ„_${stageMap[currentScheduleLevel]}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a6', orientation: 'portrait' } }; html2pdf().set(opt).from(element).save(); }
    
    let currentPayStudent = null;
    function togglePayMethod(method) { const btnScan = document.getElementById('btnPayScan'); const btnManual = document.getElementById('btnPayManual'); if(method === 'scan') { document.getElementById('payScanDiv').classList.remove('hidden'); document.getElementById('payManualDiv').classList.add('hidden'); btnScan.classList.add('bg-white', 'text-green-700', 'shadow-sm'); btnScan.classList.remove('text-gray-500'); btnManual.classList.add('text-gray-500'); btnManual.classList.remove('bg-white', 'text-green-700', 'shadow-sm'); } else { document.getElementById('payScanDiv').classList.add('hidden'); document.getElementById('payManualDiv').classList.remove('hidden'); btnManual.classList.add('bg-white', 'text-green-700', 'shadow-sm'); btnManual.classList.remove('text-gray-500'); btnScan.classList.add('text-gray-500'); btnScan.classList.remove('bg-white', 'text-green-700', 'shadow-sm'); stopScanner(); } }
    function handlePaymentScan(id) { if(!document.getElementById('paymentForm').classList.contains('hidden')) return; const student = window.students.find(s => s.id === id); if(student) { currentPayStudent = student; document.getElementById('paymentForm').classList.remove('hidden'); document.getElementById('payStdName').innerText = student.name; document.getElementById('payStdID').innerText = student.id; playSound('success'); } else { showToast('Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error'); } }
    function searchStudentForPay() { handlePaymentScan(document.getElementById('paySearchID').value); }
    async function confirmPayment() { const amount = parseFloat(document.getElementById('payAmount').value); const type = document.getElementById('payType').value; const time = new Date().toLocaleTimeString('ar-EG'); await window.addDoc(window.collection(window.db, "accounting"), { date: today, time, stdId: currentPayStudent.id, name: currentPayStudent.name, amount, type, category: 'revenue' }); document.getElementById('paymentForm').classList.add('hidden'); document.getElementById('paySearchID').value = ''; showToast('ØªÙ… Ø§Ù„Ø¯ÙØ¹', 'success'); }
    async function addExpense() { const type = document.getElementById('expType').value; const note = document.getElementById('expNote').value; const amount = parseFloat(document.getElementById('expAmount').value); const time = new Date().toLocaleTimeString('ar-EG'); if(!type || !amount) return showToast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error'); await window.addDoc(window.collection(window.db, "accounting"), { date: today, time, desc: `${type} ${note ? '- '+note : ''}`, amount, category: 'expense' }); document.getElementById('expType').value = ''; document.getElementById('expNote').value = ''; document.getElementById('expAmount').value = ''; showToast('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„', 'success'); }
    window.updateFinance = function() { const revs = window.accounting.filter(a => a.category === 'revenue'); const exps = window.accounting.filter(a => a.category === 'expense'); const totalRev = revs.reduce((sum, r) => sum + r.amount, 0); const totalExp = exps.reduce((sum, e) => sum + e.amount, 0); document.getElementById('totalRev').innerText = totalRev; document.getElementById('totalExp').innerText = totalExp; document.getElementById('netProfit').innerText = (totalRev - totalExp); const todayRevs = revs.filter(r => r.date === today); const todayExps = exps.filter(e => e.date === today); document.getElementById('todayRevList').innerHTML = todayRevs.map(r => `<div class="flex justify-between border-b border-white/10 pb-1"><span>${r.name}</span><span>${r.amount}</span></div>`).join('') || '<div class="text-center opacity-50">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div>'; document.getElementById('todayExpList').innerHTML = todayExps.map(e => `<div class="flex justify-between border-b border-white/10 pb-1"><span>${e.desc}</span><span>${e.amount}</span></div>`).join('') || '<div class="text-center opacity-50">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div>'; }
    function openReportDetails(key) { const list = currentReportData[key]; let title = ''; if(key === 'present') title = 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±'; else if(key === 'absent') title = 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨'; else if(key === 'revenues') title = 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª'; else title = 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª'; document.getElementById('detailsTitle').innerText = title; document.getElementById('modalFilterContainer').classList.add('hidden'); const thead = document.getElementById('detailsTableHead'); const tbody = document.getElementById('detailsTableBody'); if(key === 'present' || key === 'absent') { const isMonthly = document.getElementById('reportType').value === 'monthly'; const lastCol = isMonthly ? (key === 'present' ? 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…' : 'ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„ØºÙŠØ§Ø¨') : 'Ø§Ù„ÙˆÙ‚Øª'; thead.innerHTML = `<tr><th class="col-index">Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>${lastCol}</th></tr>`; if(list.length === 0) tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`; else tbody.innerHTML = list.map((s, i) => `<tr class="hover:bg-gray-50"><td class="text-gray-500">${i + 1}</td><td class="font-bold">${s.name}</td><td>${stageMap[s.level] || s.level}</td><td class="text-xs ${key === 'absent' ? 'text-red-600' : ''}">${s.time}</td></tr>`).join(''); } else { thead.innerHTML = `<tr><th class="col-index">Ù…</th><th>Ø§Ù„Ø¨Ù†Ø¯/Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr>`; if(list.length === 0) tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`; else tbody.innerHTML = list.map((item, i) => `<tr class="hover:bg-gray-50"><td class="text-gray-500">${i + 1}</td><td class="font-bold">${item.name || item.desc}</td><td class="text-gray-500 text-xs">${item.date} | ${item.time || '-'}</td><td class="font-bold ${key === 'revenues' ? 'text-green-600' : 'text-red-600'}">${item.amount}</td></tr>`).join(''); } document.getElementById('detailsModal').classList.remove('hidden'); }
    function exportData() { const data = { students: window.students, attendance: window.attendance, accounting: window.accounting }; const blob = new Blob([JSON.stringify(data)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `backup_center_${today}.json`; a.click(); }
    function importData(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = async function(e) { try { const data = JSON.parse(e.target.result); if(data.students) { for(const s of data.students) await window.addDoc(window.collection(window.db, "students"), s); for(const a of data.attendance) await window.addDoc(window.collection(window.db, "attendance"), a); for(const c of data.accounting) await window.addDoc(window.collection(window.db, "accounting"), c); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©!'); } } catch(err) { alert('Ù…Ù„Ù ØªØ§Ù„Ù'); } }; reader.readAsText(file); }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    function showToast(msg, type) { const t = document.getElementById('toast'); t.innerHTML = type === 'success' ? 'âœ… ' + msg : 'âš ï¸ ' + msg; t.className = `fixed top-5 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-2xl z-[200] font-bold text-xs flex items-center gap-2 border ${type === 'success' ? 'bg-green-600 border-green-500' : 'bg-red-600 border-red-500'} text-white`; t.classList.remove('hidden'); setTimeout(() => t.classList.add('hidden'), 3000); }
    function playSound(type) { const ctx = new (window.AudioContext || window.webkitAudioContext)(); const osc = ctx.createOscillator(); const gain = ctx.createGain(); osc.connect(gain); gain.connect(ctx.destination); if(type === 'success') { osc.frequency.setValueAtTime(800, ctx.currentTime); osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.1); } else { osc.frequency.setValueAtTime(300, ctx.currentTime); osc.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.2); } osc.start(); gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.2); osc.stop(ctx.currentTime + 0.2); setTimeout(() => { ctx.close(); }, 300); }
    function shareStudentReport() { if(currentParentPhone) { const url = `https://wa.me/20${currentParentPhone}?text=${encodeURIComponent(currentStudentReport)}`; window.open(url, '_blank'); } else { alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù…'); } }
    function printContent(elementId, title) { const content = document.getElementById(elementId).innerHTML; const printContainer = document.getElementById('print-container'); printContainer.innerHTML = `<div style="text-align: center; margin-bottom: 20px;"><h1 style="font-size: 20px; font-weight: bold;">Smart Center</h1><h2 style="font-size: 16px;">${title}</h2><p style="font-size: 12px;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${new Date().toLocaleDateString('ar-EG')}</p></div><div class="print-table-wrapper">${content}</div>`; const noPrintElements = printContainer.querySelectorAll('.no-print, .no-print-in-paper, button'); noPrintElements.forEach(el => el.remove()); window.print(); setTimeout(() => { printContainer.innerHTML = ''; }, 1000); }
    function printStudentCard() { const s = window.students.find(st => st.id === currentModalStudentId); if(!s) return; const printContainer = document.getElementById('print-container'); printContainer.innerHTML = `<div class="student-card-center"><div class="card-qr-box" id="printQr"></div><div class="card-name-lg">${s.name}</div><div class="card-details-box"><div class="card-row"><span>Ø§Ù„ÙƒÙˆØ¯:</span> <span>${s.id}</span></div><div class="card-row"><span>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:</span> <span>${s.password || '----'}</span></div></div><div class="card-row"><span>Ø§Ù„Ù…Ø±Ø­Ù„Ø©:</span> <span>${stageMap[s.level] || s.level}</span></div><div class="card-row" style="font-size: 10pt; color: #666;"><span>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:</span> <span>${s.date}</span></div><div class="card-footer">Smart Center Pro</div></div>`; new QRCode(document.getElementById("printQr"), { text: s.id, width: 120, height: 120 }); window.print(); setTimeout(() => { printContainer.innerHTML = ''; }, 1000); }
    function printFinancialReport() { const revs = window.accounting.filter(a => a.category === 'revenue' && a.date === today); const exps = window.accounting.filter(a => a.category === 'expense' && a.date === today); const totalRev = revs.reduce((sum, r) => sum + r.amount, 0); const totalExp = exps.reduce((sum, e) => sum + e.amount, 0); const net = totalRev - totalExp; let html = `<div style="border: 1px solid #000; padding: 10px; margin-bottom: 20px;"><h3>Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ… (${today})</h3><p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ§Ø±Ø¯: <strong>${totalRev}</strong></p><p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: <strong>${totalExp}</strong></p><p>Ø§Ù„ØµØ§ÙÙŠ: <strong>${net}</strong></p></div><h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</h3><table class="report-table"><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ù†ÙˆØ¹</th></tr></thead><tbody>${revs.map(r => `<tr><td>${r.name}</td><td>${r.amount}</td><td>${r.type}</td></tr>`).join('') || '<tr><td colspan="3">Ù„Ø§ ÙŠÙˆØ¬Ø¯</td></tr>'}</tbody></table><h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3><table class="report-table"><thead><tr><th>Ø§Ù„Ø¨Ù†Ø¯</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead><tbody>${exps.map(e => `<tr><td>${e.desc}</td><td>${e.amount}</td></tr>`).join('') || '<tr><td colspan="2">Ù„Ø§ ÙŠÙˆØ¬Ø¯</td></tr>'}</tbody></table>`; const printContainer = document.getElementById('print-container'); printContainer.innerHTML = `<div class="report-print-container"><div class="report-header"><h1>Smart Center</h1><h2>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h2></div>${html}</div>`; window.print(); setTimeout(() => { printContainer.innerHTML = ''; }, 1000); }
    function shareStudentPdf() { const s = window.students.find(st => st.id === currentModalStudentId); if(!s) return; const pdfContainer = document.getElementById('pdf-generator-container'); pdfContainer.innerHTML = `<div style="width: 300px; padding: 20px; border: 2px solid #1e3a8a; border-radius: 15px; text-align: center; font-family: 'Cairo', sans-serif; background: white;"><h3 style="color: #1e3a8a; margin-bottom: 10px; font-weight: bold;">Ø¨Ø·Ø§Ù‚Ø© Ø·Ø§Ù„Ø¨</h3><div id="pdfQr" style="display: flex; justify-content: center; margin-bottom: 10px;"></div><div style="font-size: 24px; font-weight: bold; color: #2563eb; font-family: monospace; margin-bottom: 5px;">${s.id}</div><div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">${s.name}</div><div style="color: #666; font-size: 12px; margin-bottom: 10px;">${stageMap[s.level] || s.level}</div>${s.password ? `<div style="background: #fef9c3; padding: 5px; border-radius: 5px; border: 1px solid #fde047; margin-top: 10px;"><div style="font-size: 10px; color: #666;">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</div><div style="font-weight: bold; color: #dc2626; font-size: 16px;">${s.password}</div></div>` : ''}<div style="margin-top: 15px; font-size: 10px; color: #999;">Smart Center Pro</div></div>`; new QRCode(document.getElementById("pdfQr"), { text: s.id, width: 100, height: 100 }); setTimeout(() => { const element = pdfContainer.firstElementChild; const opt = { margin: 10, filename: `Ø¨Ø·Ø§Ù‚Ø©_${s.name}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a6', orientation: 'portrait' } }; html2pdf().set(opt).from(element).save().then(() => { pdfContainer.innerHTML = ''; }); }, 300); }
    async function delStudent(docId, studentId) { if(!confirm('Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØ¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ØŸ')) return; try { const attQuery = window.query(window.collection(window.db, "attendance"), window.where("studentId", "==", studentId)); const attSnapshot = await window.getDocs(attQuery); attSnapshot.forEach(doc => window.deleteDoc(doc.ref)); const accQuery = window.query(window.collection(window.db, "accounting"), window.where("stdId", "==", studentId)); const accSnapshot = await window.getDocs(accQuery); accSnapshot.forEach(doc => window.deleteDoc(doc.ref)); await window.deleteDoc(window.doc(window.db, "students", docId)); showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'success'); } catch (e) { showToast('Ø®Ø·Ø£', 'error'); } }
</script>
</body>
</html> 