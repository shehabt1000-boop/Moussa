<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Smart Center Pro | Firebase</title>
    
    <!-- Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f8fafc; padding-bottom: 80px; font-size: 12px; -webkit-tap-highlight-color: transparent; }
        
        /* Navigation */
        .nav-item { transition: all 0.2s; opacity: 0.7; border-bottom: 3px solid transparent; }
        .nav-item.active { opacity: 1; background: white; color: #1e3a8a; font-weight: 700; border-bottom-color: #fbbf24; transform: translateY(-2px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        /* Tabs */
        .tab-content { display: none; animation: fadeIn 0.2s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Scanner */
        .scanner-wrapper { border-radius: 0.75rem; overflow: hidden; background: black; position: relative; }
        #html5-qrcode-button-camera-stop { display: none !important; }

        /* Cards */
        .glass-card { background: white; border-radius: 0.5rem; padding: 0.75rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; margin-bottom: 0.5rem; }

        /* Tables - Compact & Single Line */
        .custom-table { width: 100%; border-collapse: collapse; font-size: 10px; table-layout: fixed; }
        .custom-table thead { background-color: #f1f5f9; color: #1e293b; font-weight: 700; }
        .custom-table th, .custom-table td { 
            padding: 4px 2px; 
            border-bottom: 1px solid #e2e8f0; 
            text-align: right; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        .custom-table tr:last-child td { border-bottom: none; }
        .custom-table tbody tr:hover { background-color: #f8fafc; }
        
        /* Column Widths */
        .col-index { width: 20px; text-align: center; color: #64748b; }
        .col-code { width: 40px; }
        .col-action { width: 35px; text-align: center; }
        .col-date { width: 60px; }

        /* Print */
        @media print {
            .no-print { display: none !important; }
            .print-area { position: absolute; top: 0; left: 0; width: 100%; background: white; z-index: 9999; }
        }

        /* Toggle Buttons */
        .toggle-btn-active { background-color: #ffffff; color: #1d4ed8; box-shadow: 0 1px 2px rgba(0,0,0,0.1); font-weight: 700; }
        .toggle-btn-inactive { background-color: transparent; color: #6b7280; }
        
        /* Loading Overlay */
        #loadingOverlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; font-weight: bold; color: #1e3a8a; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div id="loadingOverlay">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-900 mb-2"></div>
        Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
    </div>

    <!-- Header -->
    <header class="bg-blue-900 text-white shadow-md sticky top-0 z-50 no-print">
        <div class="container mx-auto px-4 py-2 flex justify-between items-center">
            <h1 class="text-sm font-bold flex items-center gap-2">ğŸ“ Smart Center <span class="text-[9px] bg-green-500 px-1 rounded">Cloud</span></h1>
            <div class="text-[10px] bg-blue-800 px-2 py-1 rounded-full font-mono" id="headerDate">--/--/----</div>
        </div>
        <div class="bg-blue-800 border-t border-blue-700">
            <div class="container mx-auto px-2">
                <div class="flex gap-1 overflow-x-auto py-2 no-scrollbar">
                    <button onclick="showTab('students', this)" class="nav-item active px-3 py-1.5 rounded text-xs text-blue-100 flex-shrink-0">Ø§Ù„Ø·Ù„Ø§Ø¨</button>
                    <button onclick="showTab('attendance', this)" class="nav-item px-3 py-1.5 rounded text-xs text-blue-100 flex-shrink-0">Ø§Ù„Ø­Ø¶ÙˆØ±</button>
                    <button onclick="showTab('accounting', this)" class="nav-item px-3 py-1.5 rounded text-xs text-blue-100 flex-shrink-0">Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©</button>
                    <button onclick="showTab('reports', this)" class="nav-item px-3 py-1.5 rounded text-xs text-blue-100 flex-shrink-0">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-2 max-w-4xl">
        
        <!-- ================= STUDENTS ================= -->
        <section id="students" class="tab-content active">
            <div class="glass-card border-r-4 border-blue-500 no-print">
                <h2 class="font-bold text-blue-900 mb-2 text-xs">ØªØ³Ø¬ÙŠÙ„ Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
                <div class="space-y-2">
                    <input type="text" id="stdName" class="w-full p-1.5 border rounded text-xs focus:ring-1 focus:ring-blue-500 outline-none" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø±Ø¨Ø§Ø¹ÙŠ">
                    
                    <div class="flex items-center border rounded bg-white overflow-hidden">
                        <span class="bg-gray-100 px-2 py-1.5 text-gray-600 text-[10px] font-bold border-l">+20</span>
                        <input type="tel" id="stdPhone" class="w-full p-1.5 text-xs outline-none" placeholder="Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±">
                    </div>

                    <select id="stdLevel" class="w-full p-1.5 border rounded bg-white text-xs">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø©...</option>
                        <optgroup label="Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©"><option value="1Ø¨">1Ø¨</option><option value="2Ø¨">2Ø¨</option><option value="3Ø¨">3Ø¨</option><option value="4Ø¨">4Ø¨</option><option value="5Ø¨">5Ø¨</option><option value="6Ø¨">6Ø¨</option></optgroup>
                        <optgroup label="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©"><option value="1Ø¹">1Ø¹</option><option value="2Ø¹">2Ø¹</option><option value="3Ø¹">3Ø¹</option></optgroup>
                        <optgroup label="Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©"><option value="1Ø«">1Ø«</option><option value="2Ø«">2Ø«</option><option value="3Ø«">3Ø«</option></optgroup>
                    </select>
                    <button onclick="registerStudent()" class="w-full bg-blue-600 text-white py-1.5 rounded font-bold shadow hover:bg-blue-700 text-xs">Ø­ÙØ¸</button>
                </div>
            </div>

            <div class="glass-card">
                <div class="flex justify-between items-center mb-2 no-print">
                    <h2 class="font-bold text-xs">Ø§Ù„Ø·Ù„Ø§Ø¨ (<span id="stdCount">0</span>)</h2>
                    <div class="flex gap-2">
                        <input type="text" id="searchStd" onkeyup="renderStudents()" placeholder="Ø¨Ø­Ø«..." class="text-[10px] p-1 border rounded w-20">
                        <button onclick="printElement('studentsListArea')" class="bg-gray-800 text-white px-2 py-1 rounded text-[10px]">Ø·Ø¨Ø§Ø¹Ø©</button>
                    </div>
                </div>
                
                <div id="studentsListArea" class="overflow-x-auto">
                    <h2 class="text-center font-bold text-lg mb-2 hidden print-header">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
                    <table class="custom-table">
                        <thead>
                            <tr><th class="col-index">Ù…</th><th class="col-code">Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th class="col-date">ØªØ§Ø±ÙŠØ®</th><th class="no-print col-action">Ø­Ø°Ù</th></tr>
                        </thead>
                        <tbody id="studentsTable"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- ================= ATTENDANCE ================= -->
        <section id="attendance" class="tab-content">
            <div class="glass-card text-center">
                <h2 class="text-sm font-bold text-blue-900 mb-2">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±</h2>
                
                <div class="mb-2 bg-blue-50 p-1.5 rounded border border-blue-200">
                    <label class="text-[10px] text-blue-800 font-bold block mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</label>
                    <input type="date" id="attendanceDate" onchange="changeAttendanceDate()" class="w-full p-1 border rounded text-center font-bold text-blue-900 text-xs">
                </div>

                <div class="flex bg-gray-100 p-1 rounded mb-2 no-print">
                    <button onclick="setAttMode('scan')" id="btnAttScan" class="flex-1 py-1 rounded text-[10px] toggle-btn-active transition-all">ğŸ“· ÙƒØ§Ù…ÙŠØ±Ø§</button>
                    <button onclick="setAttMode('manual')" id="btnAttManual" class="flex-1 py-1 rounded text-[10px] toggle-btn-inactive transition-all">âŒ¨ï¸ ÙŠØ¯ÙˆÙŠ</button>
                </div>

                <div id="attScanArea" class="relative">
                    <div id="reader" class="scanner-wrapper h-48 w-full mb-2"></div>
                    <div id="scanFeedback" class="absolute inset-0 flex items-center justify-center bg-green-500/90 hidden z-10 rounded-lg">
                        <div class="text-white font-bold text-lg animate-bounce">âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„</div>
                    </div>
                    <div class="flex justify-center gap-2 no-print">
                        <button onclick="startScanner('reader', 'attendance')" class="bg-blue-600 text-white px-3 py-1 rounded shadow text-[10px]">ØªØ´ØºÙŠÙ„</button>
                        <button onclick="stopScanner()" class="bg-red-100 text-red-600 px-3 py-1 rounded text-[10px]">Ø¥ÙŠÙ‚Ø§Ù</button>
                    </div>
                </div>

                <div id="attManualArea" class="hidden">
                    <input type="number" id="manualAttID" placeholder="Ø§Ù„ÙƒÙˆØ¯" class="w-full text-center text-xl font-bold p-2 border-2 border-blue-200 rounded mb-2 font-mono">
                    <button onclick="manualAttendance()" class="w-full bg-blue-600 text-white py-1.5 rounded font-bold text-xs">ØªØ³Ø¬ÙŠÙ„</button>
                </div>

                <div class="grid grid-cols-2 gap-2 mt-3 no-print">
                    <div onclick="openAttendanceModal('present')" class="bg-green-50 p-2 rounded border border-green-200 cursor-pointer hover:bg-green-100 transition">
                        <span class="block text-lg font-bold text-green-600" id="presentCount">0</span>
                        <span class="text-[10px] text-green-800 font-bold">Ø­Ø¶ÙˆØ±</span>
                    </div>
                    <div onclick="openAttendanceModal('absent')" class="bg-red-50 p-2 rounded border border-red-200 cursor-pointer hover:bg-red-100 transition">
                        <span class="block text-lg font-bold text-red-600" id="absentCount">0</span>
                        <span class="text-[10px] text-red-800 font-bold">ØºÙŠØ§Ø¨</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- ================= ACCOUNTING ================= -->
        <section id="accounting" class="tab-content">
            <div class="grid md:grid-cols-2 gap-2">
                <div class="glass-card border-t-4 border-green-500">
                    <h3 class="font-bold text-green-700 mb-2 text-xs">ğŸ’µ Ø§Ø³ØªÙ„Ø§Ù… Ù†Ù‚Ø¯ÙŠØ©</h3>
                    <div class="flex gap-2 mb-2 no-print">
                        <button onclick="togglePayMethod('scan')" id="btnPayScan" class="flex-1 py-1 rounded text-[10px] font-bold toggle-btn-active">Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
                        <button onclick="togglePayMethod('manual')" id="btnPayManual" class="flex-1 py-1 rounded text-[10px] font-bold toggle-btn-inactive">ÙƒÙˆØ¯</button>
                    </div>
                    <div id="payScanDiv" class="mb-2">
                        <div id="payReader" class="scanner-wrapper h-24 mb-2"></div>
                        <button onclick="startScanner('payReader', 'payment')" class="w-full bg-green-600 text-white py-1 rounded text-[10px] no-print">ØªØ´ØºÙŠÙ„</button>
                    </div>
                    <div id="payManualDiv" class="hidden flex gap-2 mb-2">
                        <input type="number" id="paySearchID" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨" class="flex-1 p-1 border rounded text-center font-bold text-xs">
                        <button onclick="searchStudentForPay()" class="bg-green-600 text-white px-2 rounded text-xs">ğŸ”</button>
                    </div>
                    <div id="paymentForm" class="hidden bg-yellow-50 p-2 rounded border border-yellow-200">
                        <div class="flex justify-between text-[10px] mb-1 font-bold">
                            <span id="payStdName"></span>
                            <span id="payStdID" class="font-mono bg-white px-1 rounded"></span>
                        </div>
                        <div class="flex gap-1 mb-1">
                            <input type="number" id="payAmount" value="100" class="w-1/3 p-1 border rounded text-center font-bold text-xs">
                            <select id="payType" class="w-2/3 p-1 border rounded text-[10px]">
                                <option value="Ø´Ù‡Ø±ÙŠØ©">Ø§Ø´ØªØ±Ø§Ùƒ</option>
                                <option value="Ù…Ø°ÙƒØ±Ø©">Ù…Ø°ÙƒØ±Ø©</option>
                                <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                            </select>
                        </div>
                        <button onclick="confirmPayment()" class="w-full bg-green-600 text-white py-1 rounded font-bold shadow text-[10px]">ØªØ£ÙƒÙŠØ¯</button>
                    </div>
                </div>

                <div class="glass-card border-t-4 border-red-500">
                    <h3 class="font-bold text-red-700 mb-2 text-xs">ğŸ“‰ Ù…ØµØ±ÙˆÙØ§Øª</h3>
                    <div class="space-y-2">
                        <select id="expType" class="w-full p-1 border rounded text-[10px] bg-white">
                            <option value="">Ø§Ù„Ø¨Ù†Ø¯...</option>
                            <option value="Ø±ÙˆØ§ØªØ¨">Ø±ÙˆØ§ØªØ¨</option>
                            <option value="ÙƒÙ‡Ø±Ø¨Ø§Ø¡">ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
                            <option value="Ø¥ÙŠØ¬Ø§Ø±">Ø¥ÙŠØ¬Ø§Ø±</option>
                            <option value="ØµÙŠØ§Ù†Ø©">ØµÙŠØ§Ù†Ø©</option>
                            <option value="Ø·Ø¨Ø§Ø¹Ø©">Ø·Ø¨Ø§Ø¹Ø©</option>
                            <option value="Ø¨ÙˆÙÙŠÙ‡">Ø¨ÙˆÙÙŠÙ‡</option>
                            <option value="Ù†Ø«Ø±ÙŠØ§Øª">Ù†Ø«Ø±ÙŠØ§Øª</option>
                        </select>
                        <div class="flex gap-2">
                            <input type="number" id="expAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" class="flex-1 p-1 border rounded text-[10px]">
                            <input type="text" id="expNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø©" class="flex-[1.5] p-1 border rounded text-[10px]">
                        </div>
                        <button onclick="addExpense()" class="w-full bg-red-50 text-red-600 border border-red-200 py-1 rounded font-bold hover:bg-red-100 text-[10px]">ØªØ³Ø¬ÙŠÙ„</button>
                    </div>
                </div>
            </div>
            
            <div class="bg-slate-800 text-white p-3 rounded-xl shadow-lg mt-2">
                <div class="flex justify-between items-end mb-2">
                    <div>
                        <p class="text-[10px] opacity-70">Ø§Ù„ØµØ§ÙÙŠ</p>
                        <p class="text-xl font-bold" id="netProfit">0</p>
                    </div>
                    <div class="text-left text-[10px]">
                        <div class="text-green-400">ÙˆØ§Ø±Ø¯: <span id="totalRev">0</span></div>
                        <div class="text-red-400">ØµØ§Ø¯Ø±: <span id="totalExp">0</span></div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-white/10 p-1.5 rounded">
                        <h4 class="text-[10px] font-bold text-green-300 mb-1 border-b border-white/20">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h4>
                        <div id="todayRevList" class="h-20 overflow-y-auto text-[9px] space-y-1"></div>
                    </div>
                    <div class="bg-white/10 p-1.5 rounded">
                        <h4 class="text-[10px] font-bold text-red-300 mb-1 border-b border-white/20">Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙŠÙˆÙ…</h4>
                        <div id="todayExpList" class="h-20 overflow-y-auto text-[9px] space-y-1"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ================= REPORTS ================= -->
        <section id="reports" class="tab-content">
            
            <div class="glass-card border-t-4 border-blue-600 mb-2">
                <h3 class="font-bold mb-2 text-blue-900 flex items-center gap-2 text-xs">
                    <span>ğŸ‘¤</span> Ø¨Ø­Ø« Ø·Ø§Ù„Ø¨
                </h3>
                <div class="flex gap-2 mb-2">
                    <input type="text" id="reportStudentSearch" placeholder="Ø§Ø³Ù…/ÙƒÙˆØ¯" class="flex-1 p-1 border rounded text-xs">
                    <button onclick="generateStudentReport()" class="bg-blue-600 text-white px-3 rounded font-bold text-[10px]">Ø¨Ø­Ø«</button>
                </div>
                <div id="studentReportResult" class="hidden bg-gray-50 p-2 rounded border border-gray-200 text-[10px]"></div>
            </div>

            <div class="glass-card border-t-4 border-indigo-500 mb-2">
                <h3 class="font-bold mb-2 text-indigo-900 text-xs">ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ± Ø¹Ø§Ù…Ø©</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
                    <div>
                        <label class="text-[9px] text-gray-500 block mb-1">Ø§Ù„Ù†ÙˆØ¹</label>
                        <select id="reportType" onchange="toggleReportInputs()" class="w-full p-1 border rounded bg-white text-[10px]">
                            <option value="daily">ÙŠÙˆÙ…ÙŠ</option>
                            <option value="monthly">Ø´Ù‡Ø±ÙŠ</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[9px] text-gray-500 block mb-1">Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label>
                        <select id="reportStage" class="w-full p-1 border rounded bg-white text-[10px]">
                            <option value="all">Ø§Ù„ÙƒÙ„</option>
                            <optgroup label="Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©"><option value="1Ø¨">1Ø¨</option><option value="2Ø¨">2Ø¨</option><option value="3Ø¨">3Ø¨</option><option value="4Ø¨">4Ø¨</option><option value="5Ø¨">5Ø¨</option><option value="6Ø¨">6Ø¨</option></optgroup>
                            <optgroup label="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©"><option value="1Ø¹">1Ø¹</option><option value="2Ø¹">2Ø¹</option><option value="3Ø¹">3Ø¹</option></optgroup>
                            <optgroup label="Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©"><option value="1Ø«">1Ø«</option><option value="2Ø«">2Ø«</option><option value="3Ø«">3Ø«</option></optgroup>
                        </select>
                    </div>
                    <div id="divDateInput">
                        <label class="text-[9px] text-gray-500 block mb-1">Ø§Ù„ÙŠÙˆÙ…</label>
                        <input type="date" id="reportDate" class="w-full p-1 border rounded text-[10px]">
                    </div>
                    <div id="divMonthInput" class="hidden">
                        <label class="text-[9px] text-gray-500 block mb-1">Ø§Ù„Ø´Ù‡Ø±</label>
                        <input type="month" id="reportMonth" class="w-full p-1 border rounded text-[10px]">
                    </div>
                </div>
                <button onclick="generateAdvancedReport()" class="w-full bg-indigo-600 text-white py-1 rounded font-bold shadow hover:bg-indigo-700 text-[10px]">Ø¹Ø±Ø¶</button>
                
                <div id="reportResult" class="mt-2 hidden bg-gray-50 p-2 rounded border border-gray-200 text-[10px]"></div>
            </div>

            <div class="glass-card border-t-4 border-yellow-500">
                <h3 class="font-bold mb-2 flex items-center gap-2 text-yellow-800 text-xs"><span>ğŸ’¾</span> Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h3>
                <div class="flex gap-2">
                    <button onclick="exportData()" class="flex-1 bg-yellow-100 text-yellow-800 py-1 rounded font-bold text-[10px] border border-yellow-300">ØªØ­Ù…ÙŠÙ„</button>
                    <div class="relative flex-1">
                        <input type="file" id="importFile" onchange="importData(this)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <button class="w-full bg-gray-100 text-gray-700 py-1 rounded font-bold text-[10px] border border-gray-300">Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- MODAL: Student Card -->
    <div id="studentModal" class="fixed inset-0 bg-black/80 hidden z-[150] flex items-center justify-center p-4 no-print">
        <div class="bg-white rounded-xl w-full max-w-xs p-4 text-center relative shadow-2xl">
            <button onclick="closeModal('studentModal')" class="absolute top-2 right-3 text-gray-500 text-xl font-bold">&times;</button>
            
            <div id="studentCardPrintArea" class="border-4 border-double border-blue-200 p-3 rounded-xl bg-white mb-3">
                <h3 class="font-bold text-sm mb-1 text-blue-900">Ø¨Ø·Ø§Ù‚Ø© Ø·Ø§Ù„Ø¨</h3>
                <div id="modalQr" class="flex justify-center mb-1"></div>
                <p id="modalCode" class="text-xl font-black font-mono text-blue-600 mb-0"></p>
                <h2 id="modalName" class="text-base font-bold mb-0"></h2>
                <p id="modalLevel" class="text-gray-500 text-xs"></p>
                <p class="text-[9px] text-gray-400 mt-1">Smart Center</p>
            </div>

            <div class="grid grid-cols-2 gap-2">
                <button onclick="printStudentCard()" class="bg-gray-800 text-white py-1 rounded text-[10px] font-bold">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                <button onclick="shareStudentPdf()" class="bg-red-600 text-white py-1 rounded text-[10px] font-bold">ğŸ“„ PDF</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Lists -->
    <div id="detailsModal" class="fixed inset-0 bg-black/80 hidden z-[100] flex items-center justify-center p-4 no-print">
        <div class="bg-white rounded-xl w-full max-w-xl p-0 h-[80vh] flex flex-col shadow-2xl overflow-hidden">
            <div class="flex justify-between items-center p-3 border-b bg-gray-50">
                <h3 id="detailsTitle" class="font-bold text-sm text-gray-800"></h3>
                <button onclick="closeModal('detailsModal')" class="text-red-500 font-bold text-lg">&times;</button>
            </div>
            
            <div id="modalFilterContainer" class="p-2 bg-gray-100 border-b hidden">
                <select id="attFilterLevel" onchange="filterAttendanceList()" class="w-full p-1 border rounded bg-white text-[10px]">
                    <option value="all">ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„</option>
                    <optgroup label="Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©"><option value="1Ø¨">1Ø¨</option><option value="2Ø¨">2Ø¨</option><option value="3Ø¨">3Ø¨</option><option value="4Ø¨">4Ø¨</option><option value="5Ø¨">5Ø¨</option><option value="6Ø¨">6Ø¨</option></optgroup>
                    <optgroup label="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©"><option value="1Ø¹">1Ø¹</option><option value="2Ø¹">2Ø¹</option><option value="3Ø¹">3Ø¹</option></optgroup>
                    <optgroup label="Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©"><option value="1Ø«">1Ø«</option><option value="2Ø«">2Ø«</option><option value="3Ø«">3Ø«</option></optgroup>
                </select>
            </div>

            <div class="overflow-y-auto flex-1 p-0">
                <table class="custom-table">
                    <thead id="detailsTableHead"></thead>
                    <tbody id="detailsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-xl z-[200] hidden font-bold text-xs"></div>

    <!-- FIREBASE MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAttesgksSJWs--veymN8PTRNHBX9r27V0",
            authDomain: "system-a8c1e.firebaseapp.com",
            projectId: "system-a8c1e",
            storageBucket: "system-a8c1e.firebasestorage.app",
            messagingSenderId: "674440908222",
            appId: "1:674440908222:web:31221baab0048ee8c63def"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Expose functions
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.doc = doc;
        window.deleteDoc = deleteDoc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.where = where;

        const loading = document.getElementById('loadingOverlay');
        
        onSnapshot(collection(db, "students"), (snapshot) => {
            window.students = [];
            snapshot.forEach(doc => window.students.push({ ...doc.data(), docId: doc.id }));
            window.renderStudents();
            loading.style.display = 'none';
        });

        onSnapshot(collection(db, "attendance"), (snapshot) => {
            window.attendance = [];
            snapshot.forEach(doc => window.attendance.push({ ...doc.data(), docId: doc.id }));
            window.updateCounters();
        });

        onSnapshot(collection(db, "accounting"), (snapshot) => {
            window.accounting = [];
            snapshot.forEach(doc => window.accounting.push({ ...doc.data(), docId: doc.id }));
            window.updateFinance();
        });
    </script>

    <!-- APP LOGIC -->
    <script>
        // --- Config ---
        const stageMap = {
            "1Ø¨": "Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "2Ø¨": "Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "3Ø¨": "Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ",
            "4Ø¨": "Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "5Ø¨": "Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "6Ø¨": "Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ",
            "1Ø¹": "Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ", "2Ø¹": "Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ", "3Ø¹": "Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ",
            "1Ø«": "Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ", "2Ø«": "Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ", "3Ø«": "Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ"
        };

        // --- Global State ---
        window.students = [];
        window.attendance = [];
        window.accounting = [];
        
        const today = new Date().toISOString().split('T')[0];
        let selectedAttendanceDate = today;
        let currentReportData = { present: [], absent: [], revenues: [], expenses: [] };
        let currentStudentReport = null; 
        let currentModalStudentId = null;
        let currentParentPhone = null;

        // --- Init ---
        window.onload = () => {
            document.getElementById('headerDate').innerText = today;
            document.getElementById('attendanceDate').value = today;
            document.getElementById('reportDate').value = today;
        };

        // --- Navigation ---
        async function showTab(id, btn) {
            if(isScannerRunning) await stopScanner();
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(btn) btn.classList.add('active');
        }

        // --- Students ---
        async function registerStudent() {
            const name = document.getElementById('stdName').value;
            const level = document.getElementById('stdLevel').value;
            let phone = document.getElementById('stdPhone').value;

            if(!name || !level) return showToast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            if(phone.startsWith('0')) phone = phone.substring(1);

            let id;
            do { id = Math.floor(1000 + Math.random() * 9000).toString(); } 
            while (window.students.some(s => s.id === id));

            try {
                await window.addDoc(window.collection(window.db, "students"), { id, name, level, phone, date: today });
                openStudentModal(id);
                document.getElementById('stdName').value = '';
                document.getElementById('stdPhone').value = '';
                showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸', 'success');
            } catch (e) { showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error'); }
        }

        window.renderStudents = function() {
            const query = document.getElementById('searchStd').value.toLowerCase();
            const tbody = document.getElementById('studentsTable');
            const filtered = window.students.filter(s => s.name.toLowerCase().includes(query) || s.id.includes(query));
            
            document.getElementById('stdCount').innerText = filtered.length;
            
            tbody.innerHTML = filtered.map((s, index) => `
                <tr class="cursor-pointer" onclick="openStudentModal('${s.id}')">
                    <td class="col-index">${index + 1}</td>
                    <td class="col-code font-mono font-bold text-blue-600">${s.id}</td>
                    <td class="font-bold">${s.name}</td>
                    <td>${stageMap[s.level] || s.level}</td>
                    <td class="col-date text-gray-500">${s.date || '-'}</td>
                    <td class="no-print col-action" onclick="event.stopPropagation()">
                        <button onclick="delStudent('${s.docId}', '${s.id}')" class="text-red-500 text-[10px] font-bold">Ø­Ø°Ù</button>
                    </td>
                </tr>
            `).join('');
        }

        // --- Student Modal & Printing ---
        function openStudentModal(id) {
            const s = window.students.find(st => st.id === id);
            if(!s) return;
            currentModalStudentId = id;
            document.getElementById('modalName').innerText = s.name;
            document.getElementById('modalCode').innerText = s.id;
            document.getElementById('modalLevel').innerText = stageMap[s.level] || s.level;
            document.getElementById('modalQr').innerHTML = '';
            new QRCode(document.getElementById("modalQr"), { text: s.id, width: 100, height: 100 });
            document.getElementById('studentModal').classList.remove('hidden');
        }

        function printElement(elemId) {
            const content = document.getElementById(elemId);
            content.classList.add('print-area');
            window.print();
            content.classList.remove('print-area');
        }

        function shareStudentPdf() {
            const s = window.students.find(st => st.id === currentModalStudentId);
            const element = document.getElementById('studentCardPrintArea');
            const opt = { margin: 10, filename: `Ø¨Ø·Ø§Ù‚Ø©_${s.name}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a6', orientation: 'portrait' } };
            html2pdf().set(opt).from(element).save();
        }

        async function delStudent(docId, studentId) {
            if(!confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØ¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª Ø­Ø¶ÙˆØ±Ù‡ ÙˆÙ…Ø¯ÙÙˆØ¹Ø§ØªÙ‡! Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;

            try {
                const attQuery = window.query(window.collection(window.db, "attendance"), window.where("studentId", "==", studentId));
                const attSnapshot = await window.getDocs(attQuery);
                attSnapshot.forEach(doc => window.deleteDoc(doc.ref));

                const accQuery = window.query(window.collection(window.db, "accounting"), window.where("stdId", "==", studentId));
                const accSnapshot = await window.getDocs(accQuery);
                accSnapshot.forEach(doc => window.deleteDoc(doc.ref));

                await window.deleteDoc(window.doc(window.db, "students", docId));
                
                showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡', 'success');
            } catch (e) {
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù', 'error');
            }
        }

        // --- Attendance ---
        let html5QrCode = null;
        let isScannerRunning = false;
        let isPaused = false;

        window.changeAttendanceDate = function() {
            selectedAttendanceDate = document.getElementById('attendanceDate').value;
            window.updateCounters();
        }

        async function startScanner(elemId, mode) {
            if(isScannerRunning) return;
            html5QrCode = new Html5Qrcode(elemId);
            await html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => {
                if(isPaused) return;
                if(mode === 'attendance') handleAttendanceScan(decodedText);
                else if(mode === 'payment') handlePaymentScan(decodedText);
            });
            isScannerRunning = true;
        }

        async function stopScanner() {
            if(html5QrCode) { await html5QrCode.stop(); html5QrCode.clear(); html5QrCode = null; isScannerRunning = false; }
        }

        async function handleAttendanceScan(id) {
            isPaused = true;
            const student = window.students.find(s => s.id === id);
            if(student) {
                const isPresent = window.attendance.some(r => r.date === selectedAttendanceDate && r.studentId === id);
                if(!isPresent) {
                    await window.addDoc(window.collection(window.db, "attendance"), {
                        date: selectedAttendanceDate,
                        studentId: id,
                        time: new Date().toLocaleTimeString('ar-EG')
                    });
                    showScanFeedback(true);
                    playSound('success');
                } else { showToast('Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹', 'warning'); playSound('error'); }
            } else { showToast('ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­', 'error'); playSound('error'); }
            setTimeout(() => { isPaused = false; showScanFeedback(false); }, 2000);
        }

        function showScanFeedback(show) {
            const el = document.getElementById('scanFeedback');
            if(show) el.classList.remove('hidden'); else el.classList.add('hidden');
        }

        function setAttMode(mode) {
            stopScanner().then(() => {
                const btnScan = document.getElementById('btnAttScan');
                const btnManual = document.getElementById('btnAttManual');
                if(mode === 'scan') {
                    document.getElementById('attScanArea').classList.remove('hidden');
                    document.getElementById('attManualArea').classList.add('hidden');
                    btnScan.classList.add('toggle-btn-active'); btnScan.classList.remove('toggle-btn-inactive');
                    btnManual.classList.add('toggle-btn-inactive'); btnManual.classList.remove('toggle-btn-active');
                } else {
                    document.getElementById('attScanArea').classList.add('hidden');
                    document.getElementById('attManualArea').classList.remove('hidden');
                    btnManual.classList.add('toggle-btn-active'); btnManual.classList.remove('toggle-btn-inactive');
                    btnScan.classList.add('toggle-btn-inactive'); btnScan.classList.remove('toggle-btn-active');
                }
            });
        }

        function manualAttendance() {
            const id = document.getElementById('manualAttID').value;
            handleAttendanceScan(id);
            document.getElementById('manualAttID').value = '';
        }

        // --- Attendance List Modal ---
        let currentAttType = 'present';
        
        function openAttendanceModal(type) {
            currentAttType = type;
            const title = type === 'present' ? `Ø­Ø¶ÙˆØ± (${selectedAttendanceDate})` : `ØºÙŠØ§Ø¨ (${selectedAttendanceDate})`;
            document.getElementById('detailsTitle').innerText = title;
            document.getElementById('modalFilterContainer').classList.remove('hidden');
            
            const thead = document.getElementById('detailsTableHead');
            thead.innerHTML = `<tr><th class="col-index">Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>${type === 'present' ? 'ÙˆÙ‚Øª' : 'ØªØ§Ø±ÙŠØ®'}</th></tr>`;
            
            document.getElementById('detailsModal').classList.remove('hidden');
            filterAttendanceList();
        }

        function filterAttendanceList() {
            const levelFilter = document.getElementById('attFilterLevel').value;
            const dayRecords = window.attendance.filter(r => r.date === selectedAttendanceDate);
            const presentIds = dayRecords.map(r => r.studentId);
            const tbody = document.getElementById('detailsTableBody');
            
            let list = [];
            let filteredStudents = window.students;
            
            if(levelFilter !== 'all') {
                filteredStudents = window.students.filter(s => s.level === levelFilter);
            }

            if(currentAttType === 'present') {
                list = filteredStudents.filter(s => presentIds.includes(s.id)).map(s => {
                    const rec = dayRecords.find(r => r.studentId === s.id);
                    return { ...s, time: rec.time || '-' };
                });
            } else {
                list = filteredStudents.filter(s => !presentIds.includes(s.id)).map(s => ({ ...s, time: selectedAttendanceDate }));
            }

            if(list.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
            } else {
                tbody.innerHTML = list.map((s, index) => `
                    <tr class="cursor-pointer hover:bg-blue-50" onclick="openStudentModal('${s.id}')">
                        <td class="col-index">${index + 1}</td>
                        <td class="font-bold">${s.name}</td>
                        <td class="font-mono text-blue-600">${s.id}</td>
                        <td>${stageMap[s.level] || s.level}</td>
                        <td class="${currentAttType === 'present' ? 'text-green-600' : 'text-red-600'}">${s.time}</td>
                    </tr>
                `).join('');
            }
        }

        window.updateCounters = function() {
            const dayRecords = window.attendance.filter(r => r.date === selectedAttendanceDate);
            const presentIds = dayRecords.map(r => r.studentId);
            
            // Count only existing students
            const presentCount = window.students.filter(s => presentIds.includes(s.id)).length;
            
            document.getElementById('presentCount').innerText = presentCount;
            document.getElementById('absentCount').innerText = window.students.length - presentCount;
        }

        // --- Accounting ---
        let currentPayStudent = null;
        function togglePayMethod(method) {
            const btnScan = document.getElementById('btnPayScan');
            const btnManual = document.getElementById('btnPayManual');
            if(method === 'scan') {
                document.getElementById('payScanDiv').classList.remove('hidden');
                document.getElementById('payManualDiv').classList.add('hidden');
                btnScan.classList.add('toggle-btn-active'); btnScan.classList.remove('toggle-btn-inactive');
                btnManual.classList.add('toggle-btn-inactive'); btnManual.classList.remove('toggle-btn-active');
            } else {
                document.getElementById('payScanDiv').classList.add('hidden');
                document.getElementById('payManualDiv').classList.remove('hidden');
                btnManual.classList.add('toggle-btn-active'); btnManual.classList.remove('toggle-btn-inactive');
                btnScan.classList.add('toggle-btn-inactive'); btnScan.classList.remove('toggle-btn-active');
                stopScanner();
            }
        }

        function handlePaymentScan(id) {
            if(!document.getElementById('paymentForm').classList.contains('hidden')) return;
            const student = window.students.find(s => s.id === id);
            if(student) {
                currentPayStudent = student;
                document.getElementById('paymentForm').classList.remove('hidden');
                document.getElementById('payStdName').innerText = student.name;
                document.getElementById('payStdID').innerText = student.id;
                playSound('success');
            } else { showToast('Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error'); }
        }

        function searchStudentForPay() { handlePaymentScan(document.getElementById('paySearchID').value); }

        async function confirmPayment() {
            const amount = parseFloat(document.getElementById('payAmount').value);
            const type = document.getElementById('payType').value;
            const time = new Date().toLocaleTimeString('ar-EG');
            
            await window.addDoc(window.collection(window.db, "accounting"), {
                date: today, time, stdId: currentPayStudent.id, name: currentPayStudent.name, amount, type, category: 'revenue'
            });
            
            document.getElementById('paymentForm').classList.add('hidden');
            document.getElementById('paySearchID').value = '';
            showToast('ØªÙ… Ø§Ù„Ø¯ÙØ¹', 'success');
        }

        async function addExpense() {
            const type = document.getElementById('expType').value;
            const note = document.getElementById('expNote').value;
            const amount = parseFloat(document.getElementById('expAmount').value);
            const time = new Date().toLocaleTimeString('ar-EG');
            if(!type || !amount) return showToast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            
            await window.addDoc(window.collection(window.db, "accounting"), {
                date: today, time, desc: `${type} ${note ? '- '+note : ''}`, amount, category: 'expense'
            });
            
            document.getElementById('expType').value = ''; document.getElementById('expNote').value = ''; document.getElementById('expAmount').value = '';
            showToast('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„', 'success');
        }

        window.updateFinance = function() {
            const revs = window.accounting.filter(a => a.category === 'revenue');
            const exps = window.accounting.filter(a => a.category === 'expense');
            
            const totalRev = revs.reduce((sum, r) => sum + r.amount, 0);
            const totalExp = exps.reduce((sum, e) => sum + e.amount, 0);
            
            document.getElementById('totalRev').innerText = totalRev;
            document.getElementById('totalExp').innerText = totalExp;
            document.getElementById('netProfit').innerText = (totalRev - totalExp);

            const todayRevs = revs.filter(r => r.date === today);
            const todayExps = exps.filter(e => e.date === today);

            document.getElementById('todayRevList').innerHTML = todayRevs.map(r => 
                `<div class="flex justify-between border-b border-white/10 pb-1"><span>${r.name}</span><span>${r.amount}</span></div>`
            ).join('') || '<div class="text-center opacity-50">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div>';

            document.getElementById('todayExpList').innerHTML = todayExps.map(e => 
                `<div class="flex justify-between border-b border-white/10 pb-1"><span>${e.desc}</span><span>${e.amount}</span></div>`
            ).join('') || '<div class="text-center opacity-50">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div>';
        }

        // --- Reports ---
        function toggleReportInputs() {
            const type = document.getElementById('reportType').value;
            if(type === 'daily') {
                document.getElementById('divDateInput').classList.remove('hidden');
                document.getElementById('divMonthInput').classList.add('hidden');
            } else {
                document.getElementById('divDateInput').classList.add('hidden');
                document.getElementById('divMonthInput').classList.remove('hidden');
            }
        }

        function generateStudentReport() {
            const query = document.getElementById('reportStudentSearch').value.toLowerCase();
            const student = window.students.find(s => s.name.toLowerCase().includes(query) || s.id === query);
            const resDiv = document.getElementById('studentReportResult');

            if(!student) {
                resDiv.innerHTML = '<p class="text-red-500 text-center">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ±</p>';
                resDiv.classList.remove('hidden');
                return;
            }

            currentParentPhone = student.phone;

            let presentDays = 0;
            let absentDays = 0;
            let absentDates = [];
            let totalPaid = 0;
            let payments = [];

            const joinDate = new Date(student.date);
            const now = new Date();
            const diffTime = Math.abs(now - joinDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

            const uniqueDates = [...new Set(window.attendance.map(r => r.date))];
            
            uniqueDates.forEach(date => {
                if(date >= student.date) {
                    const isPresent = window.attendance.some(r => r.date === date && r.studentId === student.id);
                    if(isPresent) presentDays++;
                    else {
                        absentDays++;
                        absentDates.push(date);
                    }
                }
            });

            payments = window.accounting.filter(r => r.category === 'revenue' && r.stdId === student.id);
            totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);

            currentStudentReport = `*ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø§Ù„Ø¨: ${student.name}*\n` +
                                   `Ø§Ù„ÙƒÙˆØ¯: ${student.id}\n` +
                                   `Ø§Ù„Ù…Ø±Ø­Ù„Ø©: ${stageMap[student.level]}\n` +
                                   `ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…: ${student.date}\n` +
                                   `Ù…Ø¯Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: ${diffDays} ÙŠÙˆÙ…\n` +
                                   `----------------\n` +
                                   `*Ø§Ù„ØºÙŠØ§Ø¨ (${absentDays} ÙŠÙˆÙ…):*\n` +
                                   (absentDates.length ? absentDates.join('\n') : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØºÙŠØ§Ø¨') + `\n` +
                                   `----------------\n` +
                                   `*Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª (${totalPaid} Ø¬.Ù…):*\n` +
                                   (payments.length ? payments.map(p => `${p.type}: ${p.amount} (${p.date})`).join('\n') : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¯ÙÙˆØ¹Ø§Øª');

            resDiv.innerHTML = `
                <div class="border-b pb-2 mb-2">
                    <h4 class="font-bold text-lg text-blue-900">${student.name}</h4>
                    <p class="text-gray-500 text-xs">ÙƒÙˆØ¯: ${student.id} | ${stageMap[student.level]}</p>
                    <p class="text-gray-400 text-[10px]">Ø§Ù†Ø¶Ù…: ${student.date} (Ù…Ù†Ø° ${diffDays} ÙŠÙˆÙ…)</p>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-4 text-center">
                    <div class="bg-green-100 p-2 rounded"><div class="text-xs">Ø­Ø¶ÙˆØ±</div><div class="font-bold text-green-700">${presentDays}</div></div>
                    <div class="bg-red-100 p-2 rounded"><div class="text-xs">ØºÙŠØ§Ø¨</div><div class="font-bold text-red-700">${absentDays}</div></div>
                </div>
                <div class="mb-4"><h5 class="font-bold text-xs mb-1">Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª (${totalPaid} Ø¬.Ù…)</h5><div class="max-h-32 overflow-y-auto text-xs border rounded p-1">${payments.length ? payments.map(p => `<div class="flex justify-between border-b p-1"><span>${p.type}</span><span>${p.amount} (${p.date})</span></div>`).join('') : '<p class="text-center">Ù„Ø§ ÙŠÙˆØ¬Ø¯</p>'}</div></div>
                <div class="mb-4"><h5 class="font-bold text-xs mb-1">Ø³Ø¬Ù„ Ø§Ù„ØºÙŠØ§Ø¨</h5><div class="max-h-32 overflow-y-auto text-xs border rounded p-1 text-red-600">${absentDates.length ? absentDates.join('<br>') : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØºÙŠØ§Ø¨'}</div></div>
                <button onclick="shareStudentReport()" class="w-full bg-green-600 text-white py-1.5 rounded text-xs font-bold flex items-center justify-center gap-2"><span>ğŸ“±</span> Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨</button>
            `;
            resDiv.classList.remove('hidden');
        }

        function shareStudentReport() {
            if(currentParentPhone) {
                const url = `https://wa.me/20${currentParentPhone}?text=${encodeURIComponent(currentStudentReport)}`;
                window.open(url, '_blank');
            } else { alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø£Ù…Ø±'); }
        }

        function generateAdvancedReport() {
            const type = document.getElementById('reportType').value;
            const stage = document.getElementById('reportStage').value;
            const dateInput = document.getElementById('reportDate').value;
            const monthInput = document.getElementById('reportMonth').value;
            const resDiv = document.getElementById('reportResult');

            let totalRev = 0, totalExp = 0;
            currentReportData = { present: [], absent: [], revenues: [], expenses: [] };

            let targetStudents = window.students;
            if(stage !== 'all') targetStudents = window.students.filter(s => s.level === stage);

            if(type === 'daily') {
                if(!dateInput) return showToast('Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®', 'error');
                const dayRecords = window.attendance.filter(r => r.date === dateInput);
                const presentIds = dayRecords.map(r => r.studentId);
                
                currentReportData.present = targetStudents.filter(s => presentIds.includes(s.id)).map(s => {
                    const rec = dayRecords.find(r => r.studentId === s.id);
                    return { ...s, time: rec.time || '-' };
                });
                currentReportData.absent = targetStudents.filter(s => !presentIds.includes(s.id)).map(s => ({ ...s, time: 'ØºÙŠØ§Ø¨' }));
                currentReportData.revenues = window.accounting.filter(r => r.category === 'revenue' && r.date === dateInput);
                currentReportData.expenses = window.accounting.filter(e => e.category === 'expense' && e.date === dateInput);
            } else {
                if(!monthInput) return showToast('Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±', 'error');
                
                currentReportData.revenues = window.accounting.filter(r => r.category === 'revenue' && r.date.startsWith(monthInput));
                currentReportData.expenses = window.accounting.filter(e => e.category === 'expense' && e.date.startsWith(monthInput));

                let monthlyStats = {};
                targetStudents.forEach(s => { monthlyStats[s.id] = { name: s.name, level: s.level, present: 0, absentDates: [] }; });

                const monthDates = [...new Set(window.attendance.filter(r => r.date.startsWith(monthInput)).map(r => r.date))];

                monthDates.forEach(date => {
                    const dayRecords = window.attendance.filter(r => r.date === date);
                    const presentIds = dayRecords.map(r => r.studentId);
                    
                    targetStudents.forEach(s => {
                        if(date >= s.date) {
                            if(presentIds.includes(s.id)) monthlyStats[s.id].present++;
                            else monthlyStats[s.id].absentDates.push(date);
                        }
                    });
                });

                currentReportData.present = Object.values(monthlyStats).map(s => ({ ...s, time: `${s.present} ÙŠÙˆÙ…` }));
                currentReportData.absent = Object.values(monthlyStats).filter(s => s.absentDates.length > 0).map(s => ({ ...s, time: s.absentDates.join('<br>') }));
            }

            totalRev = currentReportData.revenues.reduce((a,b)=>a+b.amount,0);
            totalExp = currentReportData.expenses.reduce((a,b)=>a+b.amount,0);

            let html = `
                <h4 class="font-bold text-center border-b pb-2 mb-2">ØªÙ‚Ø±ÙŠØ± ${type === 'daily' ? dateInput : monthInput}</h4>
                <div class="grid grid-cols-2 gap-2 mb-4 text-center">
                    <div onclick='openReportDetails("present")' class="bg-green-100 p-2 rounded cursor-pointer hover:bg-green-200"><div class="text-xs">Ø­Ø¶ÙˆØ±</div><div class="font-bold text-green-700">${type === 'daily' ? currentReportData.present.length : 'Ø¹Ø±Ø¶'}</div></div>
                    <div onclick='openReportDetails("absent")' class="bg-red-100 p-2 rounded cursor-pointer hover:bg-red-200"><div class="text-xs">ØºÙŠØ§Ø¨</div><div class="font-bold text-red-700">${type === 'daily' ? currentReportData.absent.length : 'Ø¹Ø±Ø¶'}</div></div>
                </div>
                <div class="space-y-2">
                    <div onclick='openReportDetails("revenues")' class="bg-green-50 p-2 rounded border border-green-200 cursor-pointer hover:bg-green-100 flex justify-between"><span class="text-xs text-gray-500">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</span><span class="font-bold text-green-700">${totalRev} Ø¬.Ù…</span></div>
                    <div onclick='openReportDetails("expenses")' class="bg-red-50 p-2 rounded border border-red-200 cursor-pointer hover:bg-red-100 flex justify-between"><span class="text-xs text-gray-500">Ù…ØµØ±ÙˆÙØ§Øª</span><span class="font-bold text-red-700">${totalExp} Ø¬.Ù…</span></div>
                    <div class="bg-blue-50 p-2 rounded border border-blue-200 text-center"><span class="text-xs text-gray-500">Ø§Ù„ØµØ§ÙÙŠ</span><span class="font-bold text-blue-900 text-lg block">${totalRev - totalExp} Ø¬.Ù…</span></div>
                </div>
            `;
            resDiv.innerHTML = html;
            resDiv.classList.remove('hidden');
        }

        function openReportDetails(key) {
            const list = currentReportData[key];
            let title = '';
            if(key === 'present') title = 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±';
            else if(key === 'absent') title = 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨';
            else if(key === 'revenues') title = 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª';
            else title = 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª';

            document.getElementById('detailsTitle').innerText = title;
            document.getElementById('modalFilterContainer').classList.add('hidden');
            
            const thead = document.getElementById('detailsTableHead');
            const tbody = document.getElementById('detailsTableBody');

            if(key === 'present' || key === 'absent') {
                const isMonthly = document.getElementById('reportType').value === 'monthly';
                const lastCol = isMonthly ? (key === 'present' ? 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…' : 'ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„ØºÙŠØ§Ø¨') : 'Ø§Ù„ÙˆÙ‚Øª';
                thead.innerHTML = `<tr><th class="col-index">Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>${lastCol}</th></tr>`;
                if(list.length === 0) tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
                else {
                    tbody.innerHTML = list.map((s, i) => `
                        <tr class="hover:bg-gray-50">
                            <td class="text-gray-500">${i + 1}</td>
                            <td class="font-bold">${s.name}</td>
                            <td>${stageMap[s.level] || s.level}</td>
                            <td class="text-xs ${key === 'absent' ? 'text-red-600' : ''}">${s.time}</td>
                        </tr>
                    `).join('');
                }
            } else {
                thead.innerHTML = `<tr><th class="col-index">Ù…</th><th>Ø§Ù„Ø¨Ù†Ø¯/Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr>`;
                if(list.length === 0) tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
                else {
                    tbody.innerHTML = list.map((item, i) => `
                        <tr class="hover:bg-gray-50">
                            <td class="text-gray-500">${i + 1}</td>
                            <td class="font-bold">${item.name || item.desc}</td>
                            <td class="text-gray-500 text-xs">${item.date} | ${item.time || '-'}</td>
                            <td class="font-bold ${key === 'revenues' ? 'text-green-600' : 'text-red-600'}">${item.amount}</td>
                        </tr>
                    `).join('');
                }
            }
            document.getElementById('detailsModal').classList.remove('hidden');
        }

        // --- Backup ---
        function exportData() {
            const data = { students: window.students, attendance: window.attendance, accounting: window.accounting };
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `backup_center_${today}.json`; a.click();
        }
        function importData(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.students) {
                        for(const s of data.students) await window.addDoc(window.collection(window.db, "students"), s);
                        for(const a of data.attendance) await window.addDoc(window.collection(window.db, "attendance"), a);
                        for(const c of data.accounting) await window.addDoc(window.collection(window.db, "accounting"), c);
                        alert('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
                    }
                } catch(err) { alert('Ù…Ù„Ù ØªØ§Ù„Ù'); }
            }; reader.readAsText(file);
        }
        function clearAllData() { if(confirm('Ø­Ø°Ù Ø§Ù„ÙƒÙ„ØŸ')) { localStorage.clear(); location.reload(); } }

        // --- Utils ---
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function showToast(msg, type) {
            const t = document.getElementById('toast'); t.innerText = msg;
            t.className = `fixed top-5 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-xl z-[200] font-bold text-sm text-white ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
            t.classList.remove('hidden'); setTimeout(() => t.classList.add('hidden'), 3000);
        }
        function playSound(type) {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator(); osc.connect(ctx.destination);
            if(type === 'success') { osc.frequency.setValueAtTime(800, ctx.currentTime); osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.1); }
            else { osc.frequency.setValueAtTime(300, ctx.currentTime); osc.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.2); }
            osc.start(); osc.stop(ctx.currentTime + 0.2);
        }
    </script>
</body>
</html>