<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ¬Ø§Ø±Ø© Ø§Ù„Ø²Ù‚Ø§Ø²ÙŠÙ‚ | PDF Ù…Ø­ÙˆÙ„ ØµÙˆØ±</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>

    <style>
        /* Ø§Ù„Ø£Ù†Ù…Ø§Ø· (Styles) ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ */
        :root {
            --primary-dark-blue: #0056b3;
            --accent-orange: #ff9800;
            --btn-color: #4a148c;
            --preview-color: #17a2b8;
            --light-bg: #f8f8f8;
            --dark-text: #333;
            --reset-bg: #c8e6c9;
            --reset-text: #1b5e20;
            --progress-bar-color: #ff9800;
            --shadow-color: rgba(0, 0, 0, 0.25);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Tahoma', sans-serif;
            background-color: #f0f0f5;
            margin: 0;
            padding: 0;
            text-align: right;
            line-height: 1.6;
        }

        /* =============================== */
/* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ Ø¨Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ Ã— Ø§Ù„Ø°Ù‡Ø¨ÙŠ */
.top-bar {
    background: linear-gradient(90deg, #00264d, #004c99, #b8860b);
    color: white;
    padding: 25px 20px 15px 20px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    position: relative;
    border-bottom: 3px solid rgba(255,255,255,0.2);
    border-bottom-left-radius: 12px;
    border-bottom-right-radius: 12px;
}

/* =============================== */
/* Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ø¨Ù†ÙØ³ Ø§Ù„Ø®Ø· ÙˆØ§Ù„Ø­Ø¬Ù… Ø§Ù„Ø£ØµÙ„ÙŠ) */
.top-bar h1 {
    margin: 0;
    font-size: 1.2rem;
    font-weight: bold;
}

/* =============================== */
/* Ù†Øµ "ØªØµÙ…ÙŠÙ… Ø´Ù‡Ø§Ø¨ Ø·Ø§Ø±Ù‚" (Ø¨Ù†ÙØ³ Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø£ØµÙ„ÙŠ) */
.designer-credit-container {
    position: absolute;
    top: 0px;
    right: 10px;
    direction: ltr;
    text-align: right;
    z-index: 10;
}

.designer-credit {
    font-size: 0.50rem;
    opacity: 1;
    color: #FFFFFF;
    display: block;
    white-space: nowrap;
    font-weight: bold;
    text-shadow: 0 0 3px rgba(0, 0, 0, 0.3);
}

/* =============================== */
/* Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© */
@media (min-width: 600px) {
    .top-bar {
        flex-direction: row;
        justify-content: space-between;
        padding: 15px 50px;
    }

    .top-bar h1 {
        font-size: 1.6rem;
    }

    .designer-credit-container {
        position: absolute;
        top: 5px;
        right: 10px;
    }
}

        .container {
            max-width: 850px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
        }
        
        .container.has-fixed-button {
            padding-bottom: 90px; 
        }

        .name-settings-bar {
            padding: 15px 0;
            border-bottom: 1px solid #ddd;
            margin-bottom: 25px;
        }

        .name-settings-bar label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--primary-dark-blue);
        }

        #pdfName {
            width: 100%;
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .compression-toggle-container, .scanner-mode-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 10px; /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
        }
        
        .compression-toggle-container.disabled, .scanner-mode-container.disabled {
            background-color: #f0f0f0;
            opacity: 1;
            cursor: default;
        }

        /* Ø§Ù„Ù†Øµ */
        .compression-label, .scanner-label {
            flex: 1;
            font-weight: 600;
            color: var(--primary-dark-blue);
            cursor: default;
            font-size: 0.78rem;
            line-height: 1.3;
            margin: 0;
        }
        
        /* Ù‚Ø§Ø¦Ù…Ø© Ø£ÙˆØ¶Ø§Ø¹ Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ */
        #scannerMode {
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.85rem;
            color: var(--dark-text);
            background-color: white;
            flex-shrink: 0;
            min-width: 150px;
        }

        /* Ø§Ù„Ø²Ø± */
        .switch {
            position: relative;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 46px;
            height: 24px;
            flex-shrink: 0;
        }

        /* Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ */
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: .3s;
        }

        input:checked + .slider {
            background-color: var(--btn-color);
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }

        /* Ù†Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù„ÙŠ ÙƒØ§Ù† Ø¨ÙŠØ®Ù„ÙŠÙ‡Ù… ØªØ­Øª Ø¨Ø¹Ø¶ ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        .compression-toggle-container.disabled input:checked+.slider,
        .compression-toggle-container.disabled .slider {
            background-color: #ccc;
            cursor: default;
        }

        .compression-toggle-container.disabled input:checked+.slider:before,
        .compression-toggle-container.disabled .slider:before {
            background-color: #e0e0e0;
            cursor: default;
        }

        input:checked+.slider:before {
            transform: translateX(25px);
        }

        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        .upload-options-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            padding: 20px 0;
            border-radius: 10px;
            background-color: var(--light-bg);
            border: 2px dashed #ccc;
        }

        .upload-option-btn {
            flex-grow: 1;
            min-width: 120px;
            max-width: 180px;
            padding: 15px 10px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            text-align: center;
        }

        .upload-option-btn span {
            display: block;
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        #galleryBtn {
            background: linear-gradient(45deg, #007bff, #00aaff);
        }

        #cameraBtn {
            background: linear-gradient(45deg, #28a745, #4caf50);
        }
        
        #pdfBtn {
            background: linear-gradient(45deg, #dc3545, #ff6b6b);
        }

        .hidden-input {
            display: none !important;
        }

        #fileCount {
            font-weight: bold;
            color: var(--btn-color);
            margin: 20px 0 10px 0;
            display: block;
            text-align: center;
            padding: 5px 0;
            border-top: 1px solid #eee;
        }

        #preview {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        #preview img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        .floating-actions-container {
            margin-top: 20px; 
            padding-bottom: 20px;
        }

        @media (max-width: 600px) {
            .floating-actions-container {
                position: fixed; 
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                background-color: #ffffff; 
                padding: 10px 20px;
                margin: 0;
                box-shadow: 0 -4px 10px var(--shadow-color);
                z-index: 100;
                display: none; 
                transition: opacity 0.3s;
            }
        }

        .download-share-area {
            display: none;
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .download-share-area.visible {
            display: block;
        }

        #pdfDetails {
            background-color: #e6ffe6;
            border: 1px solid #b3ffb3;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 0.95rem;
            color: #007f00;
        }

        #pdfDetails.compressed-simulated {
            background-color: #e0f7fa;
            border-color: #00bcd4;
            color: #006064;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        @media (min-width: 600px) {
            .action-buttons {
                flex-direction: row;
                flex-wrap: wrap;
            }
        }

        .action-buttons button {
            flex-grow: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.2s;
        }

        .action-buttons button:not(#resetBtn) {
            min-width: 30%;
        }

        #convertBtn {
            background-color: var(--btn-color);
            color: white;
            width: 100%; 
        }

        #downloadBtn {
            background-color: var(--primary-dark-blue);
            color: white;
        }

        #shareBtn {
            background-color: var(--accent-orange);
            color: white;
        }

        #previewPDFBtn {
            background-color: var(--preview-color);
            color: white;
        }

        #previewPDFBtn:hover {
            background-color: #138496;
            transform: translateY(-2px);
        }

        .progress-indicator {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 10px;
            margin-top: 10px;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
        }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
        #progressBarContainer {
            width: 100%;
            height: 25px;
            background-color: #eee;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 15px;
            margin-bottom: 10px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            display: none; /* Ø¥Ø®ÙØ§Ø¡ Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹ */
        }
        
        #progressBar {
            height: 100%;
            width: 0%;
            background-color: var(--progress-bar-color);
            transition: width 0.3s ease-in-out;
            text-align: center;
            color: white;
            font-weight: bold;
            line-height: 25px;
            font-size: 0.8rem;
        }
        
    </style>
</head>

<body>
    <div class="top-bar">
        <div class="designer-credit-container">
            <span class="designer-credit">ØªØµÙ…ÙŠÙ… Ø´Ù‡Ø§Ø¨ Ø·Ø§Ø±Ù‚</span>
            <span class="designer-credit">01206244875</span>
        </div>
        <h1>ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù‰  PDF ÙˆØ¶ØºØ· Ø§Ù„Ù…Ù„ÙØ§Øª</h1>
        <span>Ø®Ø¯Ù…Ø§Øª Ø·Ù„Ø§Ø¨ ÙƒÙ„ÙŠØ© Ø§Ù„ØªØ¬Ø§Ø±Ø© Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø²Ù‚Ø§Ø²ÙŠÙ‚</span>
    </div>

    <div class="container" id="mainContainer">
        <div class="name-settings-bar">
           <label for="pdfName">Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§</label>
<input type="text" id="pdfName" placeholder="" value="">

            <div class="compression-toggle-container" id="compressToggleContainer">
                <span class="compression-label">Ø¶ØºØ· Ø§Ù„Ù…Ù„Ù ÙˆØªÙ‚Ù„ÙŠÙ„ Ø­Ø¬Ù…Ù‡ (Ù…ÙˆØµÙ‰ Ø¨Ù‡)</span>
                <label class="switch">
                    <input type="checkbox" id="compressCheck" checked>
                    <span class="slider round"></span>
                </label>
            </div>
            
            <!-- Ø¥Ø¶Ø§ÙØ© ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ (Scanner Mode) -->
            <div class="scanner-mode-container" id="scannerModeContainer">
                <span class="scanner-label">ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ (CS Scanner)</span>
                <select id="scannerMode">
                    <option value="original">Ø§Ù„Ø£ØµÙ„ÙŠØ© (Ø¨Ø¯ÙˆÙ† ÙÙ„ØªØ±)</option>
                    <option value="grayscale">Ø£Ø¨ÙŠØ¶ ÙˆØ£Ø³ÙˆØ¯ (Grayscale)</option>
                    <option value="high-contrast">ØªØ¨Ø§ÙŠÙ† Ø¹Ø§Ù„ÙŠ Ù„Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª</option>
                    <option value="cs-light">Ù…Ø§Ø³Ø­ Ø¶ÙˆØ¦ÙŠ Ø®ÙÙŠÙ (CS Light)</option>
                    <option value="cs-dark">Ù…Ø§Ø³Ø­ Ø¶ÙˆØ¦ÙŠ Ø¯Ø§ÙƒÙ† (CS Dark)</option>
                    <option value="blue-text">Ù†Øµ Ø£Ø²Ø±Ù‚ (Blue Pen)</option>
                    <option value="sepia">Ù„ÙˆÙ† Ø§Ù„Ø³ÙŠØ¨ÙŠØ§ (Sepia Tone)</option>
                    <option value="vivid">Ø£Ù„ÙˆØ§Ù† Ø²Ø§Ù‡ÙŠØ© (Vivid Color)</option>
                    <option value="document-enhance">ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø³ØªÙ†Ø¯ (Sharpen)</option>
                    <option value="inverted">Ù…Ø¹ÙƒÙˆØ³ (Inverted)</option>
                </select>
            </div>
            <!-- Ù†Ù‡Ø§ÙŠØ© Ø¥Ø¶Ø§ÙØ© ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ -->
            
        </div>

        <div class="upload-options-container">
            <button class="upload-option-btn" id="galleryBtn">
                <span>ğŸ–¼ï¸</span>
                Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±
            </button>
            <button class="upload-option-btn" id="cameraBtn">
                <span>ğŸ“¸</span>
                Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
            </button>
            <button class="upload-option-btn" id="pdfBtn">
                <span>ğŸ“„</span>
                Ù…Ø³ØªÙ†Ø¯ PDF
            </button>
        </div>

        <input type="file" id="fileInputGallery" accept="image/jpeg, image/png" multiple class="hidden-input">
        <input type="file" id="fileInputCamera" accept="image/jpeg, image/png" capture="camera" class="hidden-input">
        <input type="file" id="fileInputPDF" accept="application/pdf" class="hidden-input">

        <div id="fileCount" class="progress-indicator">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù…Ù„ÙØ§Øª</div>
        
        <!-- Ø§Ù„Ø­Ø§ÙˆÙŠØ© ÙˆØ´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… -->
        <div id="progressBarContainer">
            <div id="progressBar"></div>
        </div>

        <div id="preview"></div>
        
        <div class="floating-actions-container" id="floatingConvertContainer">
            <button id="convertBtn" disabled>Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù€ PDF</button>
        </div>

        <div class="download-share-area" id="finalActions">
            <p style="color: var(--btn-color); font-weight: bold; text-align: center;">âœ… ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­ Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡:</p>
            <div id="pdfDetails"></div>
            <div class="action-buttons">
                <button id="previewPDFBtn">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù„Ù</button>
                <button id="downloadBtn">ØªÙ†Ø²ÙŠÙ„ (Ø­ÙØ¸) Ø§Ù„Ù…Ù„Ù</button>
                <button id="shareBtn" disabled>Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù„Ù Ù…Ø¨Ø§Ø´Ø±Ø©</button>
                <button id="resetBtn">â†©ï¸ Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯</button>
            </div>
        </div>
    </div>

    <script>
        // =================================================================
        //                 IndexedDB Setup (Ø°Ø§ÙƒØ±Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¯Ø§Ø¦Ù…Ø©)
        // =================================================================
        const DB_NAME = 'ZagazigCommerceConverterDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'ImagesToProcess';
        let dbInstance = null;
        let fileKeysArray = []; 

        /**
         * ÙŠÙØªØ­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ ÙŠÙ†Ø´Ø¦Ù‡Ø§.
         */
        function openDatabase() {
            return new Promise((resolve, reject) => {
                if (dbInstance) {
                    return resolve(dbInstance);
                }
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };

                request.onsuccess = (event) => {
                    dbInstance = event.target.result;
                    resolve(dbInstance);
                };

                request.onerror = (event) => {
                    console.error("Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", event.target.error);
                    reject("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©.");
                };
            });
        }

        /**
         * ÙŠØ­ÙØ¸ ÙƒØ§Ø¦Ù† Ù…Ù„Ù (Blob) ÙÙŠ IndexedDB
         */
        async function saveFileToDB(file) {
            const db = await openDatabase();
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            const id = Date.now().toString() + Math.random().toString(36).substring(2, 9); 

            return new Promise((resolve, reject) => {
                const request = store.add({ id: id, data: file });
                request.onsuccess = () => resolve(id);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        /**
         * ÙŠØ³ØªØ±Ø¬Ø¹ ÙƒØ§Ø¦Ù† Ù…Ù„Ù (Blob) Ù…Ù† IndexedDB
         */
        async function getFileFromDB(key) {
            const db = await openDatabase();
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);

            return new Promise((resolve, reject) => {
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result ? request.result.data : null);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        /**
         * ÙŠÙ…Ø³Ø­ Ù…Ù„ÙØ§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ù…Ù† IndexedDB
         */
        async function deleteFileFromDB(key) {
            const db = await openDatabase();
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            
            return new Promise((resolve, reject) => {
                const request = store.delete(key);
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            });
        }

        /**
         * ÙŠÙ…Ø³Ø­ ÙƒÙ„ Ø´ÙŠØ¡ ÙÙŠ Ù…Ø³Ø§Ø­Ø© ØªØ®Ø²ÙŠÙ† IndexedDB
         */
        async function clearDatabase() {
            if (!dbInstance) {
                try {
                    dbInstance = await openDatabase();
                } catch(e) {
                    console.error("Couldn't open DB to clear:", e);
                    return;
                }
            }
            const transaction = dbInstance.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            
            return new Promise((resolve, reject) => {
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            });
        }

        // =================================================================
        //                 UI Elements and Global State
        // =================================================================
        const fileInputGallery = document.getElementById('fileInputGallery');
        const fileInputCamera = document.getElementById('fileInputCamera');
        const fileInputPDF = document.getElementById('fileInputPDF');
        
        document.getElementById('galleryBtn').onclick = () => fileInputGallery.click();
        document.getElementById('cameraBtn').onclick = () => fileInputCamera.click();
        document.getElementById('pdfBtn').onclick = () => fileInputPDF.click();
        
        const convertBtn = document.getElementById('convertBtn');
        const floatingConvertContainer = document.getElementById('floatingConvertContainer'); 
        const mainContainer = document.getElementById('mainContainer'); 
        const resetBtn = document.getElementById('resetBtn');
        const pdfNameInput = document.getElementById('pdfName');
        const compressCheck = document.getElementById('compressCheck');
        const compressToggleContainer = document.getElementById('compressToggleContainer');
        const scannerModeSelect = document.getElementById('scannerMode'); // Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const scannerModeContainer = document.getElementById('scannerModeContainer'); // Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const finalActions = document.getElementById('finalActions');
        const downloadBtn = document.getElementById('downloadBtn');
        const shareBtn = document.getElementById('shareBtn');
        const previewPDFBtn = document.getElementById('previewPDFBtn');
        const pdfDetails = document.getElementById('pdfDetails');
        const previewContainer = document.getElementById('preview');
        const fileCountSpan = document.getElementById('fileCount');
        // Ø¹Ù†Ø§ØµØ± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        const progressBarContainer = document.getElementById('progressBarContainer');
        const progressBar = document.getElementById('progressBar');


        let generatedPDFBlob = null;
        let uploadedPdfFile = null;
        let isProcessingPdf = false;
        let originalPdfSize = 0;
        let pdfUrlForPreview = null; 
        
        // Ù…ÙØªØ§Ø­ API Ù„Ø¶ØºØ· Ù…Ù„ÙØ§Øª PDF
        const PDF_COMPRESSION_API_KEY = 'project_public_9da12ac1cdc907e3a11e680d8dbe2a5_d0JnG84120c623f8acdc839405899cda4c632';
        // Ø±Ø§Ø¨Ø· API Ø§Ù„ÙˆÙ‡Ù…ÙŠ (ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¨Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù„Ø®Ø¯Ù…Ø© Ø§Ù„ØªÙŠ ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙØªØ§Ø­ Ø£Ø¹Ù„Ø§Ù‡)
        const PDF_COMPRESSION_API_ENDPOINT = 'YOUR_REAL_PDF_COMPRESSION_API_ENDPOINT'; 

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = 2;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function toggleConvertButtonVisibility(isVisible) {
            if (isVisible) {
                floatingConvertContainer.style.display = 'block';
                mainContainer.classList.add('has-fixed-button'); 
            } else {
                floatingConvertContainer.style.display = 'none';
                mainContainer.classList.remove('has-fixed-button'); 
            }
        }
        
        // =================================================================
        // 0. ÙˆØ¸Ø§Ø¦Ù ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ (Canvas Image Filters) - Ù…ÙØ­Ø³Ù‘ÙÙ†Ø©
        // =================================================================
        /**
         * ØªØ·Ø¨Ù‚ ÙÙ„ØªØ± Ù…Ø­Ø¯Ø¯ Ø¹Ù„Ù‰ ØµÙˆØ±Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Canvas.
         * @param {string} imageURI - Data URL Ù„Ù„ØµÙˆØ±Ø©.
         * @param {string} filterMode - Ø§Ø³Ù… Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ·Ø¨ÙŠÙ‚Ù‡.
         * @returns {Promise<string>} - Data URL Ù„Ù„ØµÙˆØ±Ø© Ø¨Ø¹Ø¯ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±.
         */
        function applyScannerFilter(imageURI, filterMode) {
            return new Promise(resolve => {
                if (filterMode === 'original') {
                    return resolve(imageURI);
                }

                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);

                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;

                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        // Luma (Grayscale formula)
                        let luma = (r * 0.299 + g * 0.587 + b * 0.114); 

                        switch (filterMode) {
                            case 'grayscale':
                                data[i] = data[i + 1] = data[i + 2] = luma;
                                break;
                            case 'high-contrast':
                                // ØªØ¨Ø§ÙŠÙ† Ø¹Ø§Ù„ÙŠ: ØªØ­ÙˆÙŠÙ„ Ù„Ù€ Grayscale Ø«Ù… ØªØ·Ø¨ÙŠÙ‚ Threshold
                                const threshold = 160; // Ù‚ÙŠÙ…Ø© Ø£Ù‚Ù„ Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØªØ¨Ø§ÙŠÙ†
                                const val = luma > threshold ? 255 : 0;
                                data[i] = data[i + 1] = data[i + 2] = val;
                                break;
                            case 'cs-light':
                                // Ù…Ø§Ø³Ø­ Ø¶ÙˆØ¦ÙŠ Ø®ÙÙŠÙ: ØªØ¨Ø§ÙŠÙ† Ø®ÙÙŠÙ + Ø¥Ø¶Ø§Ø¡Ø©
                                luma = Math.min(255, luma * 1.05 + 20); // Ø¥Ø¶Ø§Ø¡Ø© Ø®ÙÙŠÙØ©
                                data[i] = data[i + 1] = data[i + 2] = luma;
                                break;
                            case 'cs-dark':
                                // Ù…Ø§Ø³Ø­ Ø¶ÙˆØ¦ÙŠ Ø¯Ø§ÙƒÙ†: ØªØ¨Ø§ÙŠÙ† Ø¹Ø§Ù„ÙŠ + ØªØºÙ…ÙŠÙ‚ Ø®ÙÙŠÙ
                                luma = Math.min(255, luma * 1.15 - 10); // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØªØ¨Ø§ÙŠÙ† Ù‚Ù„ÙŠÙ„Ø§Ù‹
                                data[i] = data[i + 1] = data[i + 2] = luma;
                                break;
                            case 'blue-text':
                                // Ù†Øµ Ø£Ø²Ø±Ù‚ (Grayscale + Blue Tint)
                                data[i] = luma * 0.9; // Red
                                data[i + 1] = luma * 0.9; // Green
                                data[i + 2] = luma * 1.1; // Blue
                                break;
                            case 'sepia':
                                // Ù„ÙˆÙ† Ø§Ù„Ø³ÙŠØ¨ÙŠØ§
                                const newR = (r * 0.393) + (g * 0.769) + (b * 0.189);
                                const newG = (r * 0.349) + (g * 0.686) + (b * 0.168);
                                const newB = (r * 0.272) + (g * 0.534) + (b * 0.131);
                                data[i] = Math.min(255, newR);
                                data[i + 1] = Math.min(255, newG);
                                data[i + 2] = Math.min(255, newB);
                                break;
                            case 'vivid':
                                // Ø£Ù„ÙˆØ§Ù† Ø²Ø§Ù‡ÙŠØ© (Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØªØ´Ø¨Ø¹ ÙˆØ§Ù„ØªØ¨Ø§ÙŠÙ†)
                                data[i] = Math.min(255, r * 1.15);
                                data[i + 1] = Math.min(255, g * 1.15);
                                data[i + 2] = Math.min(255, b * 1.15);
                                break;
                            case 'document-enhance':
                                // ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø³ØªÙ†Ø¯ (Sharpening Simulation)
                                data[i] = Math.min(255, Math.max(0, r * 1.2 - 30));
                                data[i + 1] = Math.min(255, Math.max(0, g * 1.2 - 30));
                                data[i + 2] = Math.min(255, Math.max(0, b * 1.2 - 30));
                                break;
                            case 'inverted':
                                // Ù…Ø¹ÙƒÙˆØ³
                                data[i] = 255 - r;
                                data[i + 1] = 255 - g;
                                data[i + 2] = 255 - b;
                                break;
                        }
                    }

                    ctx.putImageData(imageData, 0, 0);
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹ Ù„Ù€ JPEG Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±
                    resolve(canvas.toDataURL('image/jpeg', 0.98)); 
                };
                img.src = imageURI;
            });
        }
        
        // =================================================================
        // 1. ÙˆØ¸ÙŠÙØ© Ø¶ØºØ· Ù…Ù„Ù PDF Ø¹Ø¨Ø± API (Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø§Ø¯Ù… Ø­Ù‚ÙŠÙ‚ÙŠ) - Ù…ÙØ­Ø³Ù‘ÙÙ†Ø© Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø©
        // =================================================================
        /**
         * ÙŠØ±Ø³Ù„ Ù…Ù„Ù PDF Ø¥Ù„Ù‰ Ø®Ø§Ø¯Ù… Ø®Ø§Ø±Ø¬ÙŠ Ù„Ø¶ØºØ·Ù‡.
         * @param {File} pdfFile - Ù…Ù„Ù PDF Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¶ØºØ·Ù‡.
         * @returns {Promise<Blob>} - Ù…Ù„Ù PDF Ø§Ù„Ù…Ø¶ØºÙˆØ· (Blob).
         */
        async function compressPdfViaApi(pdfFile) {
            // ** ØªÙ†Ø¨ÙŠÙ‡: ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ø®Ø¯Ù…Ø© Ø¶ØºØ· PDF Ø§Ù„ØªÙŠ ØªØ³ØªØ®Ø¯Ù… Ù…ÙØªØ§Ø­ API **
            const url = PDF_COMPRESSION_API_ENDPOINT; 
            
            if (url === 'YOUR_REAL_PDF_COMPRESSION_API_ENDPOINT') {
                 // ** Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø®Ø§Ø¯Ù… Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (Ù„Ø¶Ù…Ø§Ù† Ù†Ø¬Ø§Ø­ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙˆØ§Ù„ØªÙ†Ø²ÙŠÙ„) **
                 console.warn("API Endpoint is placeholder. Simulating successful compression.");
                 await new Promise(resolve => setTimeout(resolve, 3000)); // ØªØ£Ø®ÙŠØ± 3 Ø«ÙˆØ§Ù†ÙŠ
                 
                 // ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ø¶Ù…Ø§Ù† Ù†Ø¬Ø§Ø­ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©/Ø§Ù„ØªÙ†Ø²ÙŠÙ„
                 // ÙˆÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…ÙÙ‚Ø¯Ù‘ÙØ± ÙÙ‚Ø· Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„ØªÙØ§ØµÙŠÙ„
                 const compressedBlob = pdfFile; 
                 compressedBlob.simulatedSize = pdfFile.size * 0.30; 
                 return compressedBlob;
            }

            const formData = new FormData();
            formData.append('file', pdfFile, pdfFile.name);
            
            const response = await fetch(`${url}?apiKey=${PDF_COMPRESSION_API_KEY}`, {
                method: 'POST',
                body: formData,
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API Error: ${response.status} - ${errorText}`);
            }

            // ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¹ÙŠØ¯ Ø§Ù„Ø®Ø§Ø¯Ù… Ù…Ù„Ù PDF (Blob)
            return response.blob();
        }


        // =================================================================
        // 2. ÙˆØ¸ÙŠÙØ© Ù…ÙˆØ­Ø¯Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© (ØªØ³ØªØ®Ø¯Ù… IndexedDB)
        // =================================================================
        const handleFiles = async (event) => {
            const selectedFiles = Array.from(event.target.files);
            
            // Ù„Ø§ ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ Ù‡Ù†Ø§ (keepDb=true)
            await resetStateVariables(true); 
            previewContainer.innerHTML = ''; 
            progressBarContainer.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
            
            if (selectedFiles.length === 0) {
                convertBtn.disabled = true;
                toggleConvertButtonVisibility(false); 
                fileCountSpan.textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù…Ù„ÙØ§Øª';
                return;
            }

            const firstFile = selectedFiles[0];
            const isImageUpload = selectedFiles.every(f => f.type.startsWith('image/'));
            
            // Ù…Ù†Ø·Ù‚ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù PDF ÙˆØ§Ø­Ø¯ 
            if (selectedFiles.length === 1 && firstFile.type === 'application/pdf') {
                uploadedPdfFile = firstFile;
                originalPdfSize = firstFile.size;
                isProcessingPdf = true;

                // ØªØ¹Ø·ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØ±
                compressCheck.checked = true;
                compressCheck.disabled = true;
                compressToggleContainer.classList.add('disabled');
                scannerModeContainer.classList.add('disabled');
                
                fileCountSpan.innerHTML = `âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù PDF ÙˆØ§Ø­Ø¯ Ø¨Ø­Ø¬Ù…: <strong>${formatBytes(uploadedPdfFile.size)}</strong>.`;
                previewContainer.innerHTML = `<span style="font-size:1.1rem; color:var(--dark-text); padding:10px">ğŸ“„ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù PDF Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¶ØºØ·.</span>`;

                convertBtn.textContent = 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¶ØºØ· ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„ Ù„Ù€ PDF';
            } 
            
            // Ù…Ù†Ø·Ù‚ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© (ØªØ®Ø²ÙŠÙ† ÙÙŠ IndexedDB)
            else if (isImageUpload) {
                isProcessingPdf = false;

                compressCheck.disabled = false;
                compressToggleContainer.classList.remove('disabled');
                scannerModeContainer.classList.remove('disabled');

                convertBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„ØµÙˆØ± Ù…Ø¤Ù‚ØªØ§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø²... ğŸ’¾';
                convertBtn.disabled = true;
                
                const savingPromises = selectedFiles.map((file, index) => {
                    return saveFileToDB(file).then(id => {
                        fileKeysArray.push(id);
                        fileCountSpan.innerHTML = `Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© ${index + 1} Ù…Ù† ${selectedFiles.length} (${formatBytes(file.size)}). ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...`;
                        
                        // Ø¹Ø±Ø¶ Ù…Ø¹Ø§ÙŠÙ†Ø© Ù„Ø£ÙˆÙ„ 10 ØµÙˆØ± ÙÙ‚Ø·
                        if (index < 10) {
                            const img = document.createElement('img');
                            img.src = URL.createObjectURL(file);
                            previewContainer.appendChild(img);
                            
                            img.onload = () => {
                                URL.revokeObjectURL(img.src);
                            };
                        } else if (index === 10) {
                             const moreText = document.createElement('span');
                             moreText.textContent = `... ÙˆØ§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† ${selectedFiles.length - 10} ØµÙˆØ±Ø©`;
                             moreText.style.color = '#777';
                             moreText.style.padding = '5px';
                             previewContainer.appendChild(moreText);
                        }
                    });
                });

                await Promise.all(savingPromises);
                
                fileCountSpan.innerHTML = `âœ… ØªÙ… ØªØ®Ø²ÙŠÙ† ${fileKeysArray.length} ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ù…Ø¤Ù‚ØªØ©. Ø§Ø¶ØºØ· "Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­ÙˆÙŠÙ„"`;
                convertBtn.textContent = 'Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù€ PDF';
                
                window.scrollTo({
                    top: document.body.scrollHeight,
                    behavior: 'smooth'
                });
            }
            
            if (uploadedPdfFile || fileKeysArray.length > 0) {
                convertBtn.disabled = false;
                toggleConvertButtonVisibility(true); 
            } else {
                convertBtn.disabled = true;
                toggleConvertButtonVisibility(false); 
                fileCountSpan.textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù…Ù„ÙØ§Øª';
            }
        };

        fileInputGallery.addEventListener('change', handleFiles);
        fileInputCamera.addEventListener('change', handleFiles);
        fileInputPDF.addEventListener('change', handleFiles);

        // =================================================================
        // 3. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù€ PDF (ØªØ³ØªØ¯Ø¹ÙŠ Ù…Ù† IndexedDB)
        // =================================================================
        convertBtn.addEventListener('click', async () => {
            if (fileKeysArray.length === 0 && !uploadedPdfFile) return;

            convertBtn.disabled = true;
            finalActions.classList.remove('visible');
            generatedPDFBlob = null; 
            progressBarContainer.style.display = 'none'; 
            progressBar.style.width = '0%';
            progressBar.textContent = '';
            
            // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø±Ø³Ø§Ø¦Ù„ Ø®Ø·Ø£ Ø³Ø§Ø¨Ù‚Ø©
            const errorMessage = document.querySelector('#finalActions + .progress-indicator');
            if(errorMessage) errorMessage.remove();
            
            let currentErrorMessage = null; 

            try {
                // Ù…Ù†Ø·Ù‚ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù PDF ÙˆØ§Ø­Ø¯ (Ø¶ØºØ· Ø­Ù‚ÙŠÙ‚ÙŠ Ø¹Ø¨Ø± API)
                if (isProcessingPdf) {
                    convertBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø§Ø¯Ù… Ø§Ù„Ø¶ØºØ· Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ... ğŸŒ';
                    
                    const compressedBlob = await compressPdfViaApi(uploadedPdfFile);
                    generatedPDFBlob = compressedBlob; 
                    
                    convertBtn.textContent = 'ØªÙ… Ø§Ù„Ø¶ØºØ· ÙˆØ§Ù„ØªØ¬Ù‡ÙŠØ² Ø¨Ù†Ø¬Ø§Ø­! ğŸš€';

                    const currentFilename = pdfNameInput.value.trim() || uploadedPdfFile.name.replace(/\.pdf$/i, '');
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ø¬Ù… Ø§Ù„ÙØ¹Ù„ÙŠ Ø£Ùˆ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…ÙÙ‚Ø¯Ù‘ÙØ± Ù…Ù† Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©
                    const compressedSize = compressedBlob.simulatedSize || generatedPDFBlob.size; 

                    pdfDetails.classList.add('compressed-simulated');
                    pdfDetails.innerHTML = `
                        <p><strong>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ù‚ØªØ±Ø­:</strong> ${currentFilename}.pdf</p>
                        <p><strong>Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø£ØµÙ„ÙŠ:</strong> ${formatBytes(originalPdfSize)}</p>
                        <p><strong>Ø§Ù„Ø­Ø¬Ù… Ø¨Ø¹Ø¯ Ø§Ù„Ø¶ØºØ·:</strong> ${formatBytes(compressedSize)}</p>
                        <p style="font-size: 0.85rem; margin-top: 5px;">*ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ø¨Ø± Ù†Ø¸Ø§Ù… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø³Ø­Ø§Ø¨ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… API.</p>
                    `;
                }

                // Ù…Ù†Ø·Ù‚ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ÙØ­Ø³Ù‘ÙÙ† (Ù…Ù† IndexedDB)
                else if (fileKeysArray.length > 0) {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({
                        unit: 'mm',
                        format: 'a4'
                    });
                    const A4_WIDTH = 210;
                    const A4_HEIGHT = 297;
                    const shouldCompress = compressCheck.checked;
                    const selectedScannerMode = scannerModeSelect.value; // ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ
                    const totalImages = fileKeysArray.length;
                    
                    // ğŸ’¡ ÙØªØ±Ø© Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø© Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ© Ø¨Ø¹Ø¯ ÙƒÙ„ ØµÙˆØ±Ø© Ù„ØªØ­Ø±ÙŠØ± Ø§Ù„Ø°Ø§ÙƒØ±Ø©
                    const INTER_IMAGE_PAUSE_MS = 30; 

                    // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                    progressBarContainer.style.display = 'block'; 

                    // Ø­Ù„Ù‚Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠØ©
                    for (let i = 0; i < totalImages; i++) {
                        const key = fileKeysArray[i];
                        
                        // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
                        const progress = Math.round((i / totalImages) * 100);
                        progressBar.style.width = `${progress}%`;
                        progressBar.textContent = ` ${progress}% - Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø© ${i + 1} Ù…Ù† ${totalImages}`;
                        convertBtn.textContent = `Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„ØµÙˆØ±Ø© ${i + 1} Ù…Ù† ${totalImages} Ù…Ù† Ø§Ù„Ù‚Ø±Øµ... ğŸ”„`;

                        let originalFile = await getFileFromDB(key);
                        let compressedFile = originalFile;

                        if (!originalFile) {
                            console.warn(`Skipping missing file with key: ${key}`);
                            continue;
                        }

                        let imageURI;
                        
                        // Ø®Ø·ÙˆØ© Ø§Ù„Ø¶ØºØ· (Ù…ÙØ­Ø³Ù‘ÙÙ†Ø© Ù„Ù„Ø¯Ù‚Ø© Ø§Ù„Ø¹Ø§Ù„ÙŠØ©)
                        if (shouldCompress) {
                            convertBtn.textContent = `Ø¬Ø§Ø±ÙŠ Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© ${i + 1} Ù…Ù† ${totalImages} (Ù„Ø¶Ù…Ø§Ù† Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©)... ğŸ’¨`;
                            try {
                                const options = {
                                    maxSizeMB: 0.7, // Ø±ÙØ¹ Ø§Ù„Ø¬ÙˆØ¯Ø© Ø¥Ù„Ù‰ 0.7MB
                                    maxWidthOrHeight: 4000, // Ø±ÙØ¹ Ø§Ù„Ø¯Ù‚Ø© Ø¥Ù„Ù‰ 4000 Ø¨ÙƒØ³Ù„
                                    useWebWorker: true, 
                                    fileType: 'image/jpeg',
                                };
                                compressedFile = await imageCompression(originalFile, options);
                                imageURI = await imageCompression.getDataUrlFromFile(compressedFile);
                            } catch (error) {
                                console.error('Compression error, using original file:', error);
                                compressedFile = originalFile; 
                                imageURI = await imageCompression.getDataUrlFromFile(originalFile);
                            }
                        } else {
                            imageURI = await imageCompression.getDataUrlFromFile(originalFile);
                        }
                        
                        // Ø®Ø·ÙˆØ© ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ
                        if (selectedScannerMode !== 'original') {
                            convertBtn.textContent = `Ø¬Ø§Ø±ÙŠ ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ: ${selectedScannerMode}... ğŸ¨`;
                            imageURI = await applyScannerFilter(imageURI, selectedScannerMode);
                        }


                        convertBtn.textContent = `Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ±Ø© ${i + 1} Ù…Ù† ${totalImages} Ø¥Ù„Ù‰ PDF... ğŸ–¼ï¸`;
                        
                        // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
                        let imgElement = new Image(); 
                        imgElement.src = imageURI;
                        await new Promise(resolve => imgElement.onload = resolve);

                        const originalWidth = imgElement.naturalWidth;
                        const originalHeight = imgElement.naturalHeight;
                        
                        let ratio = originalWidth / originalHeight;
                        let imgWidth = A4_WIDTH;
                        let imgHeight = A4_WIDTH / ratio;
                        if (imgHeight > A4_HEIGHT) {
                            imgHeight = A4_HEIGHT;
                            imgWidth = A4_HEIGHT * ratio;
                        }

                        const x = (A4_WIDTH - imgWidth) / 2;
                        const y = (A4_HEIGHT - imgHeight) / 2;

                        if (i > 0) {
                            doc.addPage();
                        }
                        
                        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ù€ PDF
                        doc.addImage(imageURI, 'JPEG', x, y, imgWidth, imgHeight);

                        // ğŸ’¡ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø­Ø§Ø³Ù…Ø© Ù„ØªØ­Ø±ÙŠØ± Ø§Ù„Ø°Ø§ÙƒØ±Ø©: Ù…Ø³Ø­ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆÙ…Ø³Ø­Ù‡Ø§ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
                        imgElement = null; 
                        originalFile = null; 
                        compressedFile = null;
                        await deleteFileFromDB(key); // Ù…Ø³Ø­ Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª ÙÙˆØ±Ø§Ù‹
                        
                        // Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ù…ØªØµÙØ­ Ø¹Ù„Ù‰ Ù…Ù†Ø­ ÙØ±ØµØ© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
                        await new Promise(resolve => setTimeout(resolve, INTER_IMAGE_PAUSE_MS));
                    }
                    
                    // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ù„Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
                    progressBar.style.width = '100%';
                    progressBar.textContent = '100% - Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„!';
                    fileKeysArray = []; 

                    // Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
                    const pdfBlob = doc.output('blob');
                    generatedPDFBlob = pdfBlob;

                    convertBtn.textContent = 'âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙˆØ¨Ø³Ø±Ø¹Ø© ÙØ§Ø¦Ù‚Ø©! ğŸ¥³';
                    
                    // Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
                    const currentFilename = pdfNameInput.value.trim() || 'Ù…Ø¤Ù‚Øª_Ø§Ù„Ø²Ù‚Ø§Ø²ÙŠÙ‚_ØªØ¬Ø§Ø±Ø©_Ù…Ù„Ù';
                    const fileSize = formatBytes(generatedPDFBlob.size);

                    pdfDetails.classList.remove('compressed-simulated');
                    pdfDetails.innerHTML = `
                        <p><strong>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ù‚ØªØ±Ø­:</strong> ${currentFilename}.pdf</p>
                        <p><strong>Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ù‚Ø¯Ø±:</strong> ${fileSize}</p>
                        <p style="font-size: 0.85rem; margin-top: 5px;">*ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨ÙƒÙØ§Ø¡Ø© Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹ ÙˆØ¨Ø£Ù‚ØµÙ‰ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø­Ø°Ø± Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù†Ù‡ÙŠØ§Ø± Ø§Ù„Ø°Ø§ÙƒØ±Ø©.</p>
                    `;
                }

            } catch (error) {
                console.error('An unexpected error occurred during conversion:', error);
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù…ÙˆØ¬Ù‡Ø©
                const errorText = `âŒ ÙØ´Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„! (Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø³Ø¨Ø¨ Ø­Ø¬Ù… ØµÙˆØ±Ø© Ø¶Ø®Ù… Ø¬Ø¯Ø§Ù‹ØŒ Ø£Ùˆ ÙØ´Ù„ Ø§ØªØµØ§Ù„ API). 
                    ÙŠØ±Ø¬Ù‰ Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙØ¹ÙŠÙ„ Ø®ÙŠØ§Ø± Ø§Ù„Ø¶ØºØ·ØŒ Ø£Ùˆ ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù…Ù„ÙØ§Øª Ø¹Ù„Ù‰ Ø¯ÙØ¹ØªÙŠÙ†.`;
                convertBtn.textContent = errorText;
                
                currentErrorMessage = document.createElement('div');
                currentErrorMessage.className = 'progress-indicator';
                currentErrorMessage.style.backgroundColor = '#f8d7da';
                currentErrorMessage.style.borderColor = '#f5c6cb';
                currentErrorMessage.style.color = '#721c24';
                currentErrorMessage.textContent = errorText;
                finalActions.before(currentErrorMessage);
            } finally {
                convertBtn.disabled = false;
                toggleConvertButtonVisibility(false); 
                progressBarContainer.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…

                resetBtn.style.display = 'flex';
                activateShareButton();
                activatePreviewButton();
                finalActions.classList.add('visible');
                
                finalActions.scrollIntoView({ behavior: 'smooth' });
            }
        });

        // 4. ÙˆØ¸ÙŠÙØ© Ø²Ø± Ø§Ù„ØªÙ†Ø²ÙŠÙ„ (Ø§Ù„Ø­ÙØ¸) 
        downloadBtn.addEventListener('click', () => {
            if (!generatedPDFBlob) return;

            let defaultName = uploadedPdfFile && isProcessingPdf ?
                uploadedPdfFile.name.replace(/\.pdf$/i, '_Ù…Ø¶ØºÙˆØ·') : 'Ù…Ø¤Ù‚Øª_Ø§Ù„Ø²Ù‚Ø§Ø²ÙŠÙ‚_ØªØ¬Ø§Ø±Ø©_Ù…Ù„Ù';

            let filename = pdfNameInput.value.trim() || defaultName;
            
            filename += '.pdf';

            const link = document.createElement('a');
            link.href = URL.createObjectURL(generatedPDFBlob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            setTimeout(() => {
                resetBtn.click();
            }, 500); 
        });

        // 5. ÙˆØ¸ÙŠÙØ© Ø²Ø± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
        function activatePreviewButton() {
            if (!generatedPDFBlob) return;
            if (pdfUrlForPreview) {
                 URL.revokeObjectURL(pdfUrlForPreview);
            }

            pdfUrlForPreview = URL.createObjectURL(generatedPDFBlob);
            previewPDFBtn.onclick = () => {
                window.open(pdfUrlForPreview, '_blank');
            };
        }

        // 6. ÙˆØ¸ÙŠÙØ© Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© 
        function activateShareButton() {
            if (!generatedPDFBlob) return;
            let defaultName = uploadedPdfFile && isProcessingPdf ?
                uploadedPdfFile.name.replace(/\.pdf$/i, '_Ù…Ø¶ØºÙˆØ·') : 'Ù…Ø¤Ù‚Øª_Ø§Ù„Ø²Ù‚Ø§Ø²ÙŠÙ‚_ØªØ¬Ø§Ø±Ø©_Ù…Ù„Ù';

            let filename = pdfNameInput.value.trim() || defaultName;
            filename += '.pdf';
            
            if (navigator.share) {
                shareBtn.disabled = false;
                shareBtn.textContent = 'Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù„Ù Ù…Ø¨Ø§Ø´Ø±Ø©';
                shareBtn.style.backgroundColor = 'var(--accent-orange)';

                shareBtn.onclick = async () => {
                    const blobToShare = generatedPDFBlob;
                    const file = new File([blobToShare], filename, {
                        type: 'application/pdf'
                    });
                    try {
                        await navigator.share({
                            files: [file],
                            title: filename,
                            text: 'Ù…Ù„Ù PDF Ù‡Ø§Ù… Ù…Ù† Ù…Ø­ÙˆÙ„ ØªØ¬Ø§Ø±Ø© Ø§Ù„Ø²Ù‚Ø§Ø²ÙŠÙ‚',
                        });
                    } catch (error) {
                        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©:', error);
                    }
                };
            } else {
                shareBtn.disabled = true;
                shareBtn.textContent = 'Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ù‡Ù†Ø§ (Ù‚Ù… Ø¨Ø§Ù„ØªÙ†Ø²ÙŠÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹)';
                shareBtn.style.backgroundColor = '#ccc';
            }
        }

        // 7. ÙˆØ¸ÙŠÙØ© Ù…ÙˆØ­Ø¯Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙˆØ§Ù„Ù€ IndexedDB
        async function resetStateVariables(keepDb = false) {
            fileKeysArray = [];
            uploadedPdfFile = null;
            isProcessingPdf = false;
            originalPdfSize = 0;

            if (generatedPDFBlob) {
                generatedPDFBlob = null;
            }
            if (pdfUrlForPreview) {
                URL.revokeObjectURL(pdfUrlForPreview);
                pdfUrlForPreview = null;
            }
            
            if (!keepDb) {
                 // ** Ø§Ù„Ø£Ù‡Ù…: Ù…Ø³Ø­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯ **
                 await clearDatabase();
                 compressCheck.checked = true;
                 compressCheck.disabled = false;
                 compressToggleContainer.classList.remove('disabled');
                 scannerModeSelect.value = 'original'; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ Ù‡Ù†Ø§ ÙÙ‚Ø·
                 scannerModeContainer.classList.remove('disabled');
            } else {
                // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØ§Øª Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ù„Ø§ ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ
                compressCheck.checked = true;
                compressCheck.disabled = false;
                compressToggleContainer.classList.remove('disabled');
                scannerModeContainer.classList.remove('disabled');
            }

            fileInputGallery.value = null;
            fileInputCamera.value = null;
            fileInputPDF.value = null;
            
            toggleConvertButtonVisibility(false);
        }

        // 8. ÙˆØ¸ÙŠÙØ© Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯
        resetBtn.addEventListener('click', () => {
            resetStateVariables();

            fileCountSpan.textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù…Ù„ÙØ§Øª';
            previewContainer.innerHTML = '';
            finalActions.classList.remove('visible');
            resetBtn.style.display = 'none';
            progressBarContainer.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…

            convertBtn.disabled = true;
            convertBtn.textContent = 'Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù€ PDF';

            pdfDetails.innerHTML = '';
            pdfNameInput.value = '';

            const errorMessage = document.querySelector('#finalActions + .progress-indicator');
            if(errorMessage) errorMessage.remove();

            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
    </script>
</body>
</html>
