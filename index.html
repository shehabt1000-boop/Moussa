<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro CV Builder - السيرة الذاتية المحترفة</title>
    
    <!-- خطوط عربية وأيقونات -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- مكتبات JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --primary: #2c3e50;    /* كحلي غامق */
            --secondary: #d35400;  /* برتقالي محروق */
            --bg-light: #f8f9fa;
            --border-color: #e9ecef;
            --paper-w: 210mm;
            --paper-h: 297mm;
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; outline: none; }
        body { margin: 0; padding: 0; background-color: #eef2f3; height: 100vh; overflow: hidden; }

        /* --- الهيكل العام --- */
        .app-container { display: flex; height: 100%; }

        /* --- 1. لوحة التحكم (يمين) --- */
        .editor-panel {
            width: 400px;
            background: white;
            border-left: 1px solid #ccc;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 100px; /* مساحة للأزرار */
            z-index: 10;
            box-shadow: 5px 0 15px rgba(0,0,0,0.05);
        }

        .section-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 25px; margin-bottom: 15px; padding-bottom: 5px;
            border-bottom: 2px solid var(--primary); color: var(--primary);
        }
        .section-header h3 { margin: 0; font-size: 16px; font-weight: 700; }
        .btn-add {
            background: var(--primary); color: white; border: none; padding: 5px 10px;
            border-radius: 4px; cursor: pointer; font-size: 12px;
        }

        .input-group { margin-bottom: 12px; }
        .input-group label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px; color: #666; }
        .input-group input, .input-group textarea {
            width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;
            font-size: 13px; transition: 0.2s; background: #fafafa;
        }
        .input-group input:focus { border-color: var(--secondary); background: white; }

        /* كروت الإضافة الديناميكية */
        .dynamic-card {
            background: #f8f9fa; border: 1px solid #e9ecef; padding: 10px;
            border-radius: 6px; margin-bottom: 10px; position: relative;
        }
        .btn-remove {
            position: absolute; top: 5px; left: 5px; color: #c0392b;
            background: none; border: none; cursor: pointer; font-size: 14px;
        }

        /* أزرار الرفع */
        .upload-area {
            border: 2px dashed #ccc; padding: 15px; text-align: center; border-radius: 8px;
            cursor: pointer; transition: 0.3s; position: relative;
        }
        .upload-area:hover { border-color: var(--secondary); background: #fff5f0; }
        .upload-area input { position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer; }
        
        /* --- 2. لوحة المعاينة (يسار) --- */
        .preview-panel {
            flex: 1; background: #525659; display: flex; justify-content: center;
            overflow-y: auto; padding: 30px;
        }

        /* ورقة الـ CV */
        .cv-paper {
            width: var(--paper-w); min-height: var(--paper-h);
            background: white; box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: flex; flex-direction: column;
            transform-origin: top center; /* للتصغير */
        }

        /* --- تصميم الـ CV الداخلي (Modern Clean) --- */
        .cv-header {
            background: var(--primary); color: white; padding: 30px 40px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-txt h1 { margin: 0; font-size: 36px; font-weight: 800; line-height: 1.2; }
        .header-txt h2 { margin: 5px 0 0; font-size: 18px; font-weight: 400; opacity: 0.9; color: var(--secondary); }
        
        .header-img {
            width: 130px; height: 130px; border-radius: 50%; border: 5px solid rgba(255,255,255,0.2);
            overflow: hidden; background: #fff;
        }
        .header-img img { width: 100%; height: 100%; object-fit: cover; }

        .cv-body { display: flex; flex: 1; }
        
        /* العمود الجانبي */
        .cv-sidebar {
            width: 32%; background: #f4f6f7; padding: 25px; border-left: 1px solid #e0e0e0;
        }
        
        /* العمود الرئيسي */
        .cv-main { width: 68%; padding: 30px; }

        /* عناوين الأقسام */
        .cv-title {
            font-size: 15px; font-weight: 700; color: var(--primary); text-transform: uppercase;
            border-bottom: 2px solid #ddd; padding-bottom: 5px; margin-bottom: 15px; margin-top: 25px;
            display: flex; align-items: center;
        }
        .cv-title i { margin-left: 8px; color: var(--secondary); }
        .cv-title:first-child { margin-top: 0; }

        /* عناصر الجانبي */
        .contact-item { display: flex; align-items: center; margin-bottom: 12px; font-size: 12px; color: #444; }
        .contact-item i { width: 25px; color: var(--primary); }

        .skill-tag {
            display: inline-block; background: white; border: 1px solid #ddd;
            padding: 4px 8px; border-radius: 4px; font-size: 11px; margin: 2px;
            font-weight: 600; color: #333;
        }

        .qr-section {
            background: white; padding: 15px; border-radius: 8px; text-align: center;
            border: 1px solid #ddd; margin-top: 20px;
        }
        .qr-section p { font-size: 10px; margin: 5px 0 0; color: #666; }

        /* عناصر الرئيسي (Timeline) */
        .timeline-item {
            position: relative; padding-right: 20px; margin-bottom: 20px; border-right: 2px solid #e0e0e0;
        }
        .timeline-item::after {
            content: ''; position: absolute; right: -6px; top: 5px;
            width: 10px; height: 10px; background: var(--secondary); border-radius: 50%;
        }
        .timeline-item h4 { margin: 0; font-size: 16px; color: #222; font-weight: 700; }
        .timeline-item .sub-title { font-size: 13px; color: var(--primary); font-weight: 600; margin: 2px 0; }
        .timeline-item .date { font-size: 11px; color: #888; font-style: italic; display: block; margin-bottom: 5px; }
        .timeline-item p { margin: 0; font-size: 13px; line-height: 1.6; color: #555; text-align: justify; }

        /* --- الموبايل --- */
        .mobile-nav {
            display: none; position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; border-top: 1px solid #ddd; z-index: 100;
        }
        .nav-btn {
            flex: 1; padding: 15px; border: none; background: none; font-weight: bold; color: #777;
        }
        .nav-btn.active { color: var(--primary); border-top: 3px solid var(--secondary); background: #f9f9f9; }

        .fab-save {
            position: fixed; bottom: 30px; left: 30px; background: var(--secondary); color: white;
            padding: 12px 25px; border-radius: 30px; box-shadow: 0 4px 15px rgba(211, 84, 0, 0.4);
            cursor: pointer; font-weight: bold; z-index: 90; display: flex; align-items: center; gap: 10px;
            transition: transform 0.2s;
        }
        .fab-save:active { transform: scale(0.95); }

        @media (max-width: 900px) {
            .app-container { display: block; }
            .editor-panel { width: 100%; height: 100vh; padding-bottom: 80px; }
            .preview-panel {
                display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
                z-index: 50; padding: 10px; align-items: flex-start;
            }
            .preview-panel.active { display: flex; }
            .mobile-nav { display: flex; }
            
            /* تصغير الورقة للموبايل */
            .cv-paper { transform: scale(0.44); margin-top: -240px; }
            .fab-save { bottom: 80px; left: 20px; width: 50px; height: 50px; justify-content: center; padding: 0; }
            .fab-save span { display: none; }
        }

    </style>
</head>
<body>

<div class="app-container">
    
    <!-- 1. المحرر -->
    <div id="editor" class="editor-panel">
        <div style="text-align: center; margin-bottom: 20px;">
            <h2 style="color: var(--primary); margin: 0;">CV Maker <span style="color: var(--secondary)">Pro</span></h2>
            <p style="font-size: 12px; color: #777;">اصنع مستقبلك باحترافية</p>
        </div>

        <!-- المعلومات الأساسية -->
        <div class="section-header">
            <h3><i class="fas fa-user-circle"></i> المعلومات الشخصية</h3>
        </div>
        <div class="input-group">
            <label>الاسم بالكامل</label>
            <input type="text" id="inName" placeholder="محمد أحمد" oninput="renderCV()">
        </div>
        <div class="input-group">
            <label>المسمى الوظيفي</label>
            <input type="text" id="inTitle" placeholder="Software Engineer" oninput="renderCV()">
        </div>
        
        <div style="display: flex; gap: 10px;">
            <div class="input-group" style="flex:1">
                <label>الصورة الشخصية</label>
                <div class="upload-area">
                    <i class="fas fa-camera"></i>
                    <input type="file" id="uplImage" accept="image/*">
                </div>
                <small id="stImg" style="display:block; text-align:center; font-size:10px;">اختر صورة</small>
            </div>
            <div class="input-group" style="flex:1">
                <label>فيديو (QR Code)</label>
                <div class="upload-area">
                    <i class="fas fa-video"></i>
                    <input type="file" id="uplVideo" accept="video/*">
                </div>
                <small id="stVid" style="display:block; text-align:center; font-size:10px;">اختر فيديو</small>
            </div>
        </div>

        <div class="input-group">
            <label>رقم الهاتف</label>
            <input type="text" id="inPhone" placeholder="010xxxxxxx" oninput="renderCV()">
        </div>
        <div class="input-group">
            <label>البريد الإلكتروني</label>
            <input type="email" id="inEmail" placeholder="example@mail.com" oninput="renderCV()">
        </div>
        <div class="input-group">
            <label>العنوان / الموقع</label>
            <input type="text" id="inLoc" placeholder="القاهرة، مصر" oninput="renderCV()">
        </div>

        <!-- نبذة -->
        <div class="section-header">
            <h3><i class="fas fa-align-right"></i> الملخص المهني</h3>
        </div>
        <div class="input-group">
            <textarea id="inSummary" rows="4" placeholder="اكتب ملخصاً قوياً يجذب صاحب العمل..." oninput="renderCV()"></textarea>
        </div>

        <!-- الخبرات (ديناميكي) -->
        <div class="section-header">
            <h3><i class="fas fa-briefcase"></i> الخبرات العملية</h3>
            <button class="btn-add" onclick="addExperienceField()">+ إضافة</button>
        </div>
        <div id="expContainer"></div>

        <!-- التعليم (ديناميكي) -->
        <div class="section-header">
            <h3><i class="fas fa-graduation-cap"></i> المؤهلات الدراسية</h3>
            <button class="btn-add" onclick="addEduField()">+ إضافة</button>
        </div>
        <div id="eduContainer"></div>

        <!-- المهارات -->
        <div class="section-header">
            <h3><i class="fas fa-star"></i> المهارات</h3>
        </div>
        <div class="input-group">
            <label>اكتب المهارات مفصولة بفاصلة</label>
            <textarea id="inSkills" rows="2" placeholder="HTML, CSS, Leadership, Sales" oninput="renderCV()"></textarea>
        </div>
    </div>

    <!-- 2. المعاينة -->
    <div id="preview" class="preview-panel">
        <div id="cvTemplate" class="cv-paper">
            <!-- رأس الصفحة -->
            <div class="cv-header">
                <div class="header-txt">
                    <h1 id="outName">الاسم هنا</h1>
                    <h2 id="outTitle">المسمى الوظيفي</h2>
                </div>
                <div class="header-img">
                    <img id="outImg" src="https://via.placeholder.com/150" alt="Profile">
                </div>
            </div>

            <div class="cv-body">
                <!-- الجانبي -->
                <div class="cv-sidebar">
                    <div class="cv-title"><i class="fas fa-address-card"></i> التواصل</div>
                    <div class="contact-item"><i class="fas fa-phone-alt"></i> <span id="outPhone">---</span></div>
                    <div class="contact-item"><i class="fas fa-envelope"></i> <span id="outEmail">---</span></div>
                    <div class="contact-item"><i class="fas fa-map-marker-alt"></i> <span id="outLoc">---</span></div>

                    <div class="cv-title"><i class="fas fa-lightbulb"></i> المهارات</div>
                    <div id="outSkills"></div>

                    <div class="qr-section" id="qrSection" style="display:none;">
                        <div id="qrcode"></div>
                        <p>شاهد الفيديو التعريفي</p>
                    </div>
                </div>

                <!-- الرئيسي -->
                <div class="cv-main">
                    <div class="cv-title"><i class="fas fa-user"></i> نبذة عني</div>
                    <p id="outSummary" style="font-size: 13px; color: #555; line-height: 1.6;">...</p>

                    <div class="cv-title"><i class="fas fa-briefcase"></i> الخبرات العملية</div>
                    <div id="outExp">
                        <!-- الخبرات ستظهر هنا -->
                        <p style="color:#999; font-size:12px;">أضف خبراتك من القائمة الجانبية</p>
                    </div>

                    <div class="cv-title"><i class="fas fa-university"></i> التعليم</div>
                    <div id="outEdu">
                        <!-- التعليم سيظهر هنا -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- زر الحفظ العائم -->
    <div class="fab-save" onclick="downloadPDF()">
        <i class="fas fa-file-download"></i>
        <span>تحميل PDF</span>
    </div>

    <!-- تنقل الموبايل -->
    <div class="mobile-nav">
        <button class="nav-btn active" onclick="setTab('edit')"><i class="fas fa-pen"></i> تعديل</button>
        <button class="nav-btn" onclick="setTab('view')"><i class="fas fa-eye"></i> معاينة</button>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // إعدادات Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDn6kABt5ISTZUIc12nik0s3_OmnL0PRVU",
      authDomain: "occasions-pwa.firebaseapp.com",
      projectId: "occasions-pwa",
      storageBucket: "occasions-pwa.firebasestorage.app",
      messagingSenderId: "271278039483",
      appId: "1:271278039483:web:999409ab6fddd9853ca49e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const CLOUD_NAME = "db9h7zm1h";
    const UPLOAD_PRESET = "souq_upload";

    // --- إدارة البيانات الديناميكية ---
    window.expList = [];
    window.eduList = [];

    // إضافة حقل خبرة جديد
    window.addExperienceField = () => {
        const id = Date.now();
        window.expList.push({ id, role: '', company: '', date: '', desc: '' });
        renderExpInputs();
    };

    // إضافة حقل تعليم جديد
    window.addEduField = () => {
        const id = Date.now();
        window.eduList.push({ id, degree: '', school: '', date: '' });
        renderEduInputs();
    };

    // رسم حقول الإدخال للخبرات
    function renderExpInputs() {
        const container = document.getElementById('expContainer');
        container.innerHTML = window.expList.map(item => `
            <div class="dynamic-card">
                <button class="btn-remove" onclick="removeExp(${item.id})"><i class="fas fa-trash"></i></button>
                <div class="input-group">
                    <input type="text" placeholder="المسمى الوظيفي" value="${item.role}" oninput="updateExp(${item.id}, 'role', this.value)">
                </div>
                <div class="input-group">
                    <input type="text" placeholder="اسم الشركة" value="${item.company}" oninput="updateExp(${item.id}, 'company', this.value)">
                </div>
                <div class="input-group">
                    <input type="text" placeholder="الفترة (مثال: 2020 - الآن)" value="${item.date}" oninput="updateExp(${item.id}, 'date', this.value)">
                </div>
                <div class="input-group">
                    <textarea rows="2" placeholder="وصف المهام..." oninput="updateExp(${item.id}, 'desc', this.value)">${item.desc}</textarea>
                </div>
            </div>
        `).join('');
        renderCV(); // تحديث المعاينة
    }

    // رسم حقول الإدخال للتعليم
    function renderEduInputs() {
        const container = document.getElementById('eduContainer');
        container.innerHTML = window.eduList.map(item => `
            <div class="dynamic-card">
                <button class="btn-remove" onclick="removeEdu(${item.id})"><i class="fas fa-trash"></i></button>
                <div class="input-group">
                    <input type="text" placeholder="الدرجة العلمية" value="${item.degree}" oninput="updateEdu(${item.id}, 'degree', this.value)">
                </div>
                <div class="input-group">
                    <input type="text" placeholder="الجامعة / المدرسة" value="${item.school}" oninput="updateEdu(${item.id}, 'school', this.value)">
                </div>
                <div class="input-group">
                    <input type="text" placeholder="سنة التخرج" value="${item.date}" oninput="updateEdu(${item.id}, 'date', this.value)">
                </div>
            </div>
        `).join('');
        renderCV();
    }

    // دوال مساعدة للتحديث والحذف
    window.removeExp = (id) => { window.expList = window.expList.filter(x => x.id !== id); renderExpInputs(); };
    window.removeEdu = (id) => { window.eduList = window.eduList.filter(x => x.id !== id); renderEduInputs(); };
    
    window.updateExp = (id, field, val) => {
        const item = window.expList.find(x => x.id === id);
        if(item) { item[field] = val; renderCV(); }
    };
    window.updateEdu = (id, field, val) => {
        const item = window.eduList.find(x => x.id === id);
        if(item) { item[field] = val; renderCV(); }
    };

    // --- دالة رسم الـ CV (المعاينة) ---
    window.renderCV = () => {
        // النصوص الأساسية
        document.getElementById('outName').innerText = document.getElementById('inName').value || "الاسم هنا";
        document.getElementById('outTitle').innerText = document.getElementById('inTitle').value || "المسمى الوظيفي";
        document.getElementById('outPhone').innerText = document.getElementById('inPhone').value || "---";
        document.getElementById('outEmail').innerText = document.getElementById('inEmail').value || "---";
        document.getElementById('outLoc').innerText = document.getElementById('inLoc').value || "---";
        document.getElementById('outSummary').innerText = document.getElementById('inSummary').value || "اكتب نبذة عنك...";

        // المهارات
        const skillsDiv = document.getElementById('outSkills');
        skillsDiv.innerHTML = "";
        const skillsTxt = document.getElementById('inSkills').value;
        if(skillsTxt) {
            skillsTxt.split(/,|،/).forEach(s => {
                if(s.trim()) {
                    const span = document.createElement('span');
                    span.className = 'skill-tag';
                    span.innerText = s.trim();
                    skillsDiv.appendChild(span);
                }
            });
        }

        // الخبرات (Timeline)
        const expDiv = document.getElementById('outExp');
        if(window.expList.length > 0) {
            expDiv.innerHTML = window.expList.map(item => `
                <div class="timeline-item">
                    <h4>${item.role}</h4>
                    <div class="sub-title">${item.company}</div>
                    <span class="date">${item.date}</span>
                    <p>${item.desc}</p>
                </div>
            `).join('');
        } else {
            expDiv.innerHTML = '<p style="color:#ccc; font-size:12px;">لا توجد خبرات مضافة</p>';
        }

        // التعليم
        const eduDiv = document.getElementById('outEdu');
        if(window.eduList.length > 0) {
            eduDiv.innerHTML = window.eduList.map(item => `
                <div class="timeline-item" style="border:none; padding-bottom:0;">
                    <h4>${item.degree}</h4>
                    <div class="sub-title">${item.school}</div>
                    <span class="date">${item.date}</span>
                </div>
            `).join('');
        } else {
            eduDiv.innerHTML = '<p style="color:#ccc; font-size:12px;">لا يوجد تعليم مضاف</p>';
        }
    };

    // --- رفع الملفات (Cloudinary) ---
    async function uploadFile(file, type, statusId) {
        const status = document.getElementById(statusId);
        status.innerText = "جاري الرفع... ⏳"; status.style.color = "orange";
        
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", UPLOAD_PRESET);

        try {
            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/${type}/upload`, { method: "POST", body: formData });
            const data = await res.json();
            status.innerText = "تم الرفع ✅"; status.style.color = "green";
            return data.secure_url;
        } catch (e) {
            status.innerText = "فشل ❌"; status.style.color = "red";
            return null;
        }
    }

    document.getElementById('uplImage').addEventListener('change', async (e) => {
        const url = await uploadFile(e.target.files[0], 'image', 'stImg');
        if(url) document.getElementById('outImg').src = url;
    });

    document.getElementById('uplVideo').addEventListener('change', async (e) => {
        const url = await uploadFile(e.target.files[0], 'video', 'stVid');
        if(url) {
            document.getElementById('qrSection').style.display = 'block';
            const qrBox = document.getElementById("qrcode");
            qrBox.innerHTML = "";
            new QRCode(qrBox, { text: url, width: 90, height: 90 });
            window.videoUrl = url;
        }
    });

    // --- تحميل PDF ---
    window.downloadPDF = async () => {
        const element = document.getElementById('cvTemplate');
        
        // حفظ في Firebase
        try {
            await addDoc(collection(db, "pro_resumes"), {
                name: document.getElementById('inName').value,
                createdAt: new Date(),
                video: window.videoUrl || ""
            });
        } catch(e) { console.log("Offline save"); }

        const opt = {
            margin: 0,
            filename: 'Professional_CV.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        const btn = document.querySelector('.fab-save');
        btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i>";
        
        await html2pdf().set(opt).from(element).save();
        
        btn.innerHTML = "<i class='fas fa-file-download'></i> <span>تحميل PDF</span>";
    };

    // --- التبديل للموبايل ---
    window.setTab = (mode) => {
        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview');
        const btns = document.querySelectorAll('.nav-btn');
        
        if(mode === 'edit') {
            editor.style.display = 'block';
            preview.classList.remove('active');
            btns[0].classList.add('active'); btns[1].classList.remove('active');
        } else {
            editor.style.display = 'none';
            preview.classList.add('active');
            btns[0].classList.remove('active'); btns[1].classList.add('active');
        }
    };

    // تشغيل مبدئي لإضافة حقل واحد
    window.addExperienceField();
    window.addEduField();
</script>

</body>
</html>