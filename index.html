<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
	<title>Ø§Ù„Ø³ÙˆÙ‚ ÙˆÙŠØ§Ùƒ | 2026</title>


	<meta property="og:image" content="https://raw.githubusercontent.com/shehabt1000-boop/Moussa/main/647557c3-c686-4ae6-925e-9fd3765180a7.jpeg">
	<meta property="og:title" content="Ø§Ù„Ø³ÙˆÙ‚ ÙˆÙŠØ§Ùƒ">
	<meta property="og:description" content="ØªØµÙØ­ Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø­ØµØ±ÙŠØ©">
	<meta property="og:type" content="website">
	<meta name="twitter:card" content="summary_large_image">
	<meta name="twitter:image" content="https://raw.githubusercontent.com/shehabt1000-boop/Moussa/main/647557c3-c686-4ae6-925e-9fd3765180a7.jpeg">


	<meta name="theme-color" content="#0f172a">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="apple-mobile-web-app-title" content="Ø§Ù„Ø³ÙˆÙ‚ ÙˆÙŠØ§Ùƒ">
	<link id="manifest-link" rel="manifest">




	<script src="https://cdn.tailwindcss.com"></script>
	<script>
    	tailwind.config = {
        	darkMode: 'class',
        	theme: { 
            	extend: { 
                	colors: { 
                    	navy: '#0f172a', 
                    	darkbg: '#1e293b', 
                    	primary: '#10b981', 
                    	secondary: '#3b82f6' 
                	},
                	fontFamily: {
                    	cairo: ['Cairo', 'sans-serif']
                	}
            	} 
        	}
    	}
	</script>
	<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
	<script src="https://unpkg.com/lucide@latest"></script>




	<style>
    	body { 
        	font-family: 'Cairo', sans-serif; 
        	-webkit-tap-highlight-color: transparent;
        	padding-bottom: 80px;
        	overscroll-behavior-y: none;
        	background-color: #f8fafc;
    	}
    	.dark body { background-color: #0f172a; }




    	.no-scrollbar::-webkit-scrollbar { display: none; }
    	.select-none { user-select: none; }




    	/* Custom Scrollbar */
    	.custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
    	.custom-scroll::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 4px; }
    	.custom-scroll::-webkit-scrollbar-thumb { background: #0f172a; border-radius: 10px; border: 1px solid white; }
    	.dark .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
    	.dark .custom-scroll::-webkit-scrollbar-thumb { background: #94a3b8; border: 1px solid #0f172a; }




    	@keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    	.animate-pop { animation: popIn 0.1s cubic-bezier(0.16, 1, 0.3, 1) forwards; }




    	.mobile-full-modal { position: fixed; inset: 0; z-index: 80; background-color: white; display: flex; flex-direction: column; height: 100dvh; }
    	.dark .mobile-full-modal { background-color: #0f172a; }




    	#profile-modal .mobile-full-modal, #order-modal .mobile-full-modal { z-index: 90; } 
    	#profile-modal.modal-overlay, #order-modal.modal-overlay { z-index: 90; }




    	@media (min-width: 768px) { 
        	.mobile-full-modal { position: relative; inset: auto; width: 100%; max-width: 28rem; height: 600px; max-height: 85vh; border-radius: 1.5rem; overflow: hidden; } 
        	.modal-overlay { position: fixed; inset: 0; z-index: 80; background-color: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; padding: 1rem; } 
    	}




    	/* Modern Toast */
    	@keyframes slideInDown { from { transform: translate(-50%, -100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
    	@keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    	.toast { 
        	animation: slideInDown 0.2s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; 
        	position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999;
        	width: max-content; max-width: 90vw; 
        	box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.2);
        	backdrop-filter: blur(8px);
    	}
    	.toast.hiding { animation: fadeOut 0.1s ease-in forwards; }




    	.form-label { display: block; font-size: 0.7rem; font-weight: 800; color: #334155; margin-bottom: 0.1rem; }
    	.dark .form-label { color: #cbd5e1; }




    	.form-input { 
        	width: 100%; background-color: #ffffff; border: 1px solid #000000 !important; border-radius: 0.5rem; 
        	padding: 0 0.5rem; height: 2.25rem; display: flex; align-items: center; font-size: 0.75rem; 
        	font-weight: 600; color: #1e293b; outline: none; transition: all 0.1s; line-height: normal; 
    	}
    	select.form-input {
        	padding-top: 0; padding-bottom: 0; -webkit-appearance: none; 
        	background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        	background-position: left 0.5rem center; background-repeat: no-repeat; background-size: 1.2em 1.2em; padding-left: 2rem; 
    	}
    	textarea.form-input { height: auto; padding-top: 0.5rem; padding-bottom: 0.5rem; }
    	.form-input:focus { border-color: #10b981 !important; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1); }
    	.dark .form-input { background-color: #1e293b; border-color: #94a3b8 !important; color: white; }
    	.dark .form-input:focus { border-color: #10b981 !important; }




    	.chip-checkbox:checked + div { background-color: #10b981; color: white; border-color: #10b981; }
    	.smart-option:checked + div { background-color: #0f172a; color: white; border-color: #0f172a; }
    	.dark .smart-option:checked + div { background-color: #10b981; border-color: #10b981; }




    	.star-rating input { display: none; }
    	.star-rating label { cursor: pointer; color: #cbd5e1; transition: color 0.1s; }
    	.star-rating input:checked ~ label, .star-rating label:hover, .star-rating label:hover ~ label { color: #fbbf24; }
    	.star-rating { display: flex; flex-direction: row-reverse; justify-content: flex-end; }




    	@keyframes slideUp { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    	.install-banner { animation: slideUp 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; }




    	#login-view { position: fixed; inset: 0; z-index: 200; background-color: #f1f5f9; display: flex; align-items: center; justify-content: center; padding: 1rem; }
    	#login-view.hidden { display: none !important; } 
    	.dark #login-view { background-color: #0f172a; }
    	.login-scroll { max-height: 65vh; overflow-y: auto; padding: 2px; }
    	.spinner { border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 2px solid #fff; width: 16px; height: 16px; animation: spin 1s linear infinite; }
    	@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }


    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-navy dark:text-slate-100 select-none">



	<!-- LOGIN VIEW -->
	<div id="login-view" class="hidden">
    	<div class="w-full max-w-md bg-white dark:bg-darkbg p-4 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 flex flex-col max-h-[95vh]">
        	<div class="flex flex-col items-center gap-1 mb-3 shrink-0">
            	<div class="bg-navy dark:bg-primary text-white p-2 rounded-xl shadow-lg rotate-3">
                	<i data-lucide="shopping-bag" class="w-5 h-5"></i>
            	</div>
            	<h1 class="font-black text-lg text-navy dark:text-white">Ø§Ù„Ø³ÙˆÙ‚ <span class="text-primary">ÙˆÙŠØ§Ùƒ</span></h1>
        	</div>

        	<div class="bg-slate-100 dark:bg-slate-800 p-1 rounded-xl flex mb-2 border border-slate-200 dark:border-slate-700 shrink-0">
            	<button onclick="setAuthType('login')" id="btn-type-login" class="flex-1 py-1.5 rounded-lg text-xs font-bold transition-all bg-navy dark:bg-primary text-white shadow-md">
                	ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
            	</button>
            	<button onclick="setAuthType('signup')" id="btn-type-signup" class="flex-1 py-1.5 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:text-navy dark:hover:text-white">
                	Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
            	</button>
        	</div>




        	<div class="bg-slate-100 dark:bg-slate-800 p-1 rounded-xl flex mb-3 border border-slate-200 dark:border-slate-700 shrink-0">
            	<button onclick="setAuthRole('customer')" id="btn-role-customer" class="flex-1 py-1.5 rounded-lg text-xs font-bold transition-all bg-navy text-white shadow-md">
                	<div class="flex items-center justify-center gap-2"><i data-lucide="user" class="w-3 h-3"></i> Ø¹Ù…ÙŠÙ„</div>
            	</button>
            	<button onclick="setAuthRole('marketer')" id="btn-role-marketer" class="flex-1 py-1.5 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:bg-white dark:hover:bg-slate-700">
                	<div class="flex items-center justify-center gap-2"><i data-lucide="store" class="w-3 h-3"></i> Ù…Ù‚Ø¯Ù… Ø®Ø¯Ù…Ø©</div>
            	</button>
        	</div>




        	<div class="login-scroll no-scrollbar space-y-2 flex-1">
            	<div id="auth-image-field" class="hidden flex-col items-center gap-2 transition-all duration-300">
                	<div class="relative group cursor-pointer">
                    	<input type="file" id="auth-img-input" accept="image/*" onchange="handleAuthImage(this)" class="absolute inset-0 opacity-0 z-10 cursor-pointer">
                    	<div class="w-16 h-16 rounded-full bg-slate-50 dark:bg-slate-800 border-2 border-dashed border-primary/50 flex items-center justify-center overflow-hidden relative hover:bg-primary/5 transition">
                        	<img id="auth-img-preview" src="" class="w-full h-full object-cover hidden">
                        	<div id="auth-img-placeholder" class="flex flex-col items-center text-slate-400">
                            	<i data-lucide="camera" class="w-5 h-5 mb-1"></i>
                            	<span class="text-[8px] font-bold">ØµÙˆØ±Ø©</span>
                        	</div>
                    	</div>
                    	<div class="absolute bottom-0 right-0 bg-navy dark:bg-primary text-white p-1 rounded-full shadow-sm pointer-events-none"><i data-lucide="plus" class="w-3 h-3"></i></div>
                	</div>
            	</div>




            	<div>
                	<label id="lbl-username" class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-0.5 block mr-1">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label>
                	<div class="relative">
                    	<input id="auth-username" type="text" class="form-input text-left" placeholder="username" style="direction: ltr;">
                    	<i data-lucide="at-sign" class="absolute right-3 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-400 pointer-events-none"></i>
                	</div>
            	</div>




            	<div>
                	<label class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-0.5 block mr-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                	<div class="relative">
                    	<input id="auth-pass" type="password" class="form-input" placeholder="******">
                    	<i data-lucide="lock" class="absolute right-3 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-400 pointer-events-none"></i>
                	</div>
            	</div>




            	<div id="signup-fields" class="hidden space-y-2 border-t border-slate-100 dark:border-slate-700 pt-2 mt-1">
                	<div>
                    	<label class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-0.5 block mr-1">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ (Ø¹Ø±Ø¨ÙŠ)</label>
                    	<input id="auth-name-ar" type="text" class="form-input" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯">
                	</div>
                	<div>
                    	<label class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-0.5 block mr-1">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                    	<input id="auth-phone" type="tel" class="form-input" placeholder="01xxxxxxxxx">
                	</div>




                	<div class="grid grid-cols-2 gap-2">
                    	<div>
                        	<label class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-0.5 block mr-1">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label>
                        	<select id="auth-gov" onchange="updateCities()" class="form-input text-xs"></select>
                    	</div>
                    	<div>
                        	<label class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-0.5 block mr-1">Ø§Ù„Ù…Ø±ÙƒØ²/Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
                        	<select id="auth-city" class="form-input text-xs">
                            	<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>
                        	</select>
                    	</div>
                	</div>
                	<div>
                    	<label class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-0.5 block mr-1">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„</label>
                    	<input id="auth-address" type="text" class="form-input" placeholder="Ø§Ù„Ø´Ø§Ø±Ø¹ØŒ Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø²Ù„...">
                	</div>
            	</div>
        	</div>




        	<div class="mt-3 pt-2 border-t border-slate-100 dark:border-slate-700 shrink-0">
            	<button onclick="processAuth()" id="btn-auth-action" class="w-full bg-navy dark:bg-primary text-white py-2.5 rounded-xl font-bold shadow-lg shadow-navy/20 hover:opacity-90 transition-all active:scale-95 flex justify-center items-center gap-2 text-sm">
                	<span>Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø­Ø³Ø§Ø¨</span> <i data-lucide="arrow-left" class="w-4 h-4"></i>
            	</button>
            	<div id="auth-error" class="text-red-600 dark:text-red-400 text-[10px] font-bold text-center hidden bg-red-50 dark:bg-red-900/20 p-2 rounded-lg border border-red-200 dark:border-red-800 mt-2 break-words" dir="ltr"></div>
        	</div>
    	</div>
	</div>




	<!-- APP CONTENT -->
	<div id="app-content" class="hidden">
    	<div id="toast-container" class="fixed top-4 left-0 right-0 z-[120] flex flex-col items-center gap-2 pointer-events-none px-4"></div>




    	<!-- Header -->
    	<header class="fixed top-0 w-full z-[60] bg-white/95 dark:bg-navy/95 border-b border-slate-200 dark:border-slate-700 flex flex-col justify-center px-4 shadow-sm backdrop-blur-md h-12">
        	<div class="flex items-center justify-between w-full">
            	<div class="flex items-center gap-2" id="logo-trigger">
                	<div class="bg-navy dark:bg-primary text-white p-1 rounded-md"><i data-lucide="shopping-bag" class="w-4 h-4"></i></div>
                	<div class="flex flex-col leading-none">
                    	<h1 class="font-bold text-sm">Ø§Ù„Ø³ÙˆÙ‚ <span class="text-primary">ÙˆÙŠØ§Ùƒ</span></h1>
                    	<div id="welcome-text" class="hidden text-[10px] font-bold mt-0.5">
                         	<span class="text-navy dark:text-white">Ø£Ù‡Ù„Ø§Ù‹: </span><span id="header-username" class="text-primary"></span>
                    	</div>
                	</div>
            	</div>




            	<div class="flex gap-1.5 items-center">
                	<button onclick="toggleProfile(null)" class="p-1.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-white hover:bg-slate-200 transition"><i data-lucide="user" class="w-4 h-4"></i></button>
                	<button onclick="toggleDarkMode()" class="p-1.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-yellow-400 hover:bg-slate-200 transition"><i data-lucide="moon" class="w-4 h-4 block dark:hidden"></i><i data-lucide="sun" class="w-4 h-4 hidden dark:block"></i></button>
                	<button onclick="toggleAdminPanel()" id="btn-admin-top" class="hidden bg-slate-100 dark:bg-slate-800 p-1.5 rounded-full text-slate-600 dark:text-white"><i data-lucide="shield" class="w-4 h-4"></i></button>
                	<button onclick="logout()" class="p-1.5 rounded-full bg-slate-100 dark:bg-slate-800 text-red-600 hover:bg-red-100 transition"><i data-lucide="log-out" class="w-4 h-4"></i></button>
            	</div>
        	</div>
    	</header>




    	<main class="pt-14 container mx-auto px-4 max-w-6xl min-h-screen">
        	<div id="view-header" class="hidden flex items-center gap-2 pb-1">
            	<button onclick="switchToHomeView()" class="bg-white dark:bg-slate-800 p-1.5 rounded-full border border-slate-200 dark:border-slate-700 shadow-sm"><i data-lucide="arrow-right" class="w-4 h-4 text-slate-600 dark:text-white"></i></button>
            	<h2 id="view-title" class="text-base font-bold text-slate-800 dark:text-white pt-0.5"></h2>
        	</div>




        	<div id="search-container" class="sticky top-12 z-[50] bg-slate-50/95 dark:bg-navy/95 backdrop-blur-lg pt-1.5 pb-1.5 -mx-4 px-4 transition-all">
            	<div class="relative max-w-3xl mx-auto flex gap-2 items-center">
                	<div class="relative flex-1">
                    	<input type="text" id="search-input" oninput="handleSearch()" placeholder="Ø§Ø¨Ø­Ø«..." class="w-full form-input pr-9 pl-20 h-8 shadow-sm text-xs">
                    	<i data-lucide="search" class="absolute right-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-400"></i>




                    	<div class="absolute left-2 top-1/2 -translate-y-1/2 flex items-center gap-1 z-10">
                        	<button id="btn-filter-toggle" onclick="toggleFilterPanel()" class="hidden text-secondary dark:text-blue-400 p-2 hover:scale-110 transition">
                            	<i data-lucide="sliders-horizontal" class="w-3.5 h-3.5"></i>
                        	</button>
                        	<button onclick="toggleFavView()" class="relative text-red-500 p-2hover:scale-110 transition">
                            	<i data-lucide="heart" class="w-3.5 h-3.5"></i>
                            	<span id="fav-count" class="absolute top-0 right-0 w-1.5 h-1.5 bg-red-600 rounded-full border border-white dark:border-darkbg hidden"></span>
                        	</button>
                    	</div>
                	</div>
            	</div>




            	<div id="filter-panel" class="hidden mt-1 bg-white dark:bg-darkbg p-2 rounded-xl border border-slate-200 dark:border-slate-700 shadow-xl animate-pop relative z-50">
                	<div class="flex justify-between items-center mb-1">
                    	<span class="font-bold text-[10px]">ØªØµÙÙŠØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬</span>
                    	<button onclick="resetFilters()" class="text-[10px] text-red-500 font-bold underline cursor-pointer p-1">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
                	</div>
                	<div class="grid grid-cols-2 gap-2">
                    	<select id="filter-gov" onchange="applyFilters()" class="form-input text-xs h-7">
                        	<option value="">ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª</option>
                    	</select>
                    	<select id="filter-price" onchange="applyFilters()" class="form-input text-xs h-7">
                        	<option value="">ÙƒÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</option>
                        	<option value="low">Ø§Ù„Ø£Ù‚Ù„ Ø³Ø¹Ø±Ø§Ù‹</option>
                        	<option value="high">Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø±Ø§Ù‹</option>
                    	</select>
                	</div>
            	</div>
        	</div>


       <div id="categories-container" class="hidden justify-start gap-2 overflow-x-auto pt-1 pb-2 no-scrollbar"></div>

        <div id="home-grid" class="hidden grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 pb-10 mt-4"></div>

        <div id="grid-container" class="hidden grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 pb-10 mt-2"></div>

        <div id="loader" class="text-center py-20"><div class="w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-2"></div><p class="text-xs text-slate-400">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>
        <div id="empty-state" class="hidden text-center py-20 opacity-60 flex-col items-center"><div class="bg-slate-200 dark:bg-slate-800 p-4 rounded-full inline-block mb-2"><i data-lucide="shirt" class="w-8 h-8 text-slate-400"></i></div><p class="text-slate-500 dark:text-slate-400 font-bold text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p><button onclick="resetFilters()" class="mt-2 text-primary text-xs font-bold underline">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button></div>
    </main>


    	<!-- NAV BAR -->
    	<nav class="fixed bottom-4 left-1/2 -translate-x-1/2 z-[70] bg-white/90 dark:bg-slate-800/90 border border-slate-200 dark:border-slate-600 px-6 py-2 rounded-full flex items-center gap-8 shadow-lg transform transition-all hover:scale-105">
        	<button onclick="switchToHomeView()" class="flex flex-col items-center gap-1 text-slate-500 dark:text-slate-400 hover:text-navy dark:hover:text-white transition group"><i data-lucide="home" class="w-5 h-5 group-hover:scale-110 transition"></i></button>
        	<button id="nav-add-btn" onclick="toggleAddModal()" class="w-12 h-12 bg-navy dark:bg-primary text-white rounded-full flex items-center justify-center shadow-lg shadow-slate-900/20 transform -translate-y-5 border-4 border-slate-50 dark:border-navy hover:scale-110 transition active:scale-90"><i data-lucide="plus" class="w-6 h-6"></i></button>
        	<button onclick="toggleChat()" class="flex flex-col items-center gap-1 text-slate-500 dark:text-slate-400 hover:text-navy dark:hover:text-white transition group relative"><div id="chat-badge" class="hidden absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border border-white dark:border-slate-800"></div><i data-lucide="message-circle" class="w-5 h-5 group-hover:scale-110 transition"></i></button>
    	</nav>




    	<!-- PWA Install Banner (Top) -->
    	<div id="install-banner" class="hidden fixed top-0 left-0 right-0 bg-navy dark:bg-white dark:text-navy text-white p-3 shadow-2xl z-[110] flex items-center justify-between install-banner border-b dark:border-slate-200">
        	<div class="flex items-center gap-3">
            	<div class="bg-white/10 dark:bg-navy/10 p-2 rounded-lg"><i data-lucide="download" class="w-5 h-5"></i></div>
            	<div>
                	<h4 class="font-bold text-xs">ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h4>
                	<p class="text-[10px] opacity-80">ØªØ¬Ø±Ø¨Ø© Ø£Ø³Ø±Ø¹ ÙˆØ£Ø³Ù‡Ù„</p>
            	</div>
        	</div>
        	<div class="flex gap-2">
            	<button onclick="installPWA()" class="bg-primary text-white px-3 py-1.5 rounded-lg font-bold text-xs shadow-lg">ØªØ«Ø¨ÙŠØª</button>
            	<button onclick="closeInstall()" class="text-white dark:text-navy p-1"><i data-lucide="x" class="w-4 h-4"></i></button>
        	</div>
    	</div>
	</div>




	<!-- Profile Modal -->
	<div id="profile-modal" class="hidden modal-overlay">
    	<div class="mobile-full-modal animate-pop border border-slate-200 dark:border-slate-700">
        	<div class="bg-navy dark:bg-primary p-3 text-white flex justify-between items-center shrink-0">
            	<h3 class="font-bold text-sm">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
            	<button onclick="toggleProfile()" class="bg-red-500 hover:bg-red-600 p-1.5 rounded-full text-white shadow-sm"><i data-lucide="x" class="w-4 h-4"></i></button>
        	</div>
        	<div class="flex-1 overflow-y-auto p-4 bg-white dark:bg-darkbg custom-scroll">




            	<!-- VIEW MODE -->
            	<div id="prof-view-mode">
                	<div class="flex flex-col items-center gap-3 mb-6">
                    	<div id="prof-img-container" class="w-24 h-24 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center overflow-hidden border-4 border-primary shadow-lg">
                        	<i data-lucide="user" class="w-10 h-10 text-slate-400"></i>
                    	</div>
                    	<div class="text-center w-full">
                        	<div class="flex items-center justify-center gap-2">
                            	<h2 id="prof-name" class="font-black text-xl text-navy dark:text-white">...</h2>
                            	<button id="global-edit-btn" onclick="toggleEditMode()" class="hidden flex items-center gap-1 text-primary hover:text-primary/80 bg-primary/10 px-2 py-0.5 rounded-full transition">
                                	<i data-lucide="pen-tool" class="w-3 h-3"></i> <span class="text-[10px] font-bold">ØªØ¹Ø¯ÙŠÙ„</span>
                            	</button>
                        	</div>




                        	<div id="prof-rating-display" class="flex justify-center items-center gap-1 mt-1 text-yellow-400 text-xs font-bold hidden">
                            	<span>â˜…</span> <span id="prof-rating-val">0.0</span>
                        	</div>
                        	<span id="prof-role" class="text-xs bg-slate-100 dark:bg-slate-700 px-3 py-1 rounded-full text-slate-500 dark:text-slate-300 font-bold mt-1 inline-block">...</span>
                        	<p id="prof-joined" class="text-[10px] text-slate-400 mt-1 text-black dark:text-white font-bold"></p>
                    	</div>
                	</div>




                	<div class="space-y-3 mb-6">
                    	<div class="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border border-slate-100 dark:border-slate-700">
                        	<label class="text-[10px] font-bold text-slate-400 mb-1 block">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                        	<div class="flex items-center gap-2 font-bold text-sm text-navy dark:text-white">
                            	<i data-lucide="phone" class="w-4 h-4 text-primary"></i>
                            	<span id="prof-phone">...</span>
                        	</div>
                    	</div>




                    	<div class="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border border-slate-100 dark:border-slate-700">
                        	<label class="text-[10px] font-bold text-slate-400 mb-1 block">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„</label>
                        	<div class="flex items-center gap-2 font-bold text-sm text-navy dark:text-white">
                            	<i data-lucide="map-pin" class="w-4 h-4 text-primary"></i>
                            	<span id="prof-address">...</span>
                        	</div>
                    	</div>




                    	<div id="prof-rate-user-section" class="hidden bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border border-slate-100 dark:border-slate-700 mt-2">
                        	<label class="text-[10px] font-bold text-slate-400 mb-2 block">Ù‚ÙŠÙ… Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                        	<div class="flex flex-col gap-2">
                            	<div class="star-rating text-lg self-end">
                                	<input type="radio" id="u-star5" name="u-rating" value="5" onclick="setUserRating(5)"><label for="u-star5">â˜…</label>
                                	<input type="radio" id="u-star4" name="u-rating" value="4" onclick="setUserRating(4)"><label for="u-star4">â˜…</label>
                                	<input type="radio" id="u-star3" name="u-rating" value="3" onclick="setUserRating(3)"><label for="u-star3">â˜…</label>
                                	<input type="radio" id="u-star2" name="u-rating" value="2" onclick="setUserRating(2)"><label for="u-star2">â˜…</label>
                                	<input type="radio" id="u-star1" name="u-rating" value="1" onclick="setUserRating(1)"><label for="u-star1">â˜…</label>
                            	</div>
                            	<textarea id="user-review-text" class="form-input text-xs w-full" rows="2" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ..."></textarea>
                            	<button onclick="submitUserReview()" class="bg-primary text-white px-3 py-1.5 rounded-lg text-xs font-bold w-full">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
                        	</div>
                    	</div>
                	</div>




                	<div id="prof-reviews-section" class="hidden">
                    	<h3 class="font-bold text-sm text-navy dark:text-white mb-3 border-b pb-2 border-slate-100 dark:border-slate-700">Ø¢Ø±Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
                    	<div id="prof-reviews-list" class="space-y-3"></div>
                    	<div class="flex gap-2 mt-2">
                        	<button id="prof-reviews-more" onclick="loadProfileReviews(true)" class="hidden flex-1 text-center text-xs text-primary font-bold py-2 bg-slate-50 dark:bg-slate-800 rounded-lg">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯</button>
                        	<button id="prof-reviews-less" onclick="loadProfileReviews(false, true)" class="hidden flex-1 text-center text-xs text-red-500 font-bold py-2 bg-slate-50 dark:bg-slate-800 rounded-lg">Ø¹Ø±Ø¶ Ø£Ù‚Ù„</button>
                    	</div>
                	</div>
            	</div>




            	<!-- EDIT MODE -->
            	<div id="prof-edit-mode" class="hidden space-y-3">
                	<div class="flex flex-col items-center gap-2 mb-4">
                    	<div class="w-24 h-24 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center overflow-hidden border-4 border-primary shadow-lg relative group">
                        	<img id="edit-img-preview" src="" class="w-full h-full object-cover hidden">
                        	<div id="edit-img-placeholder" class="flex flex-col items-center text-slate-400">
                            	<i data-lucide="camera" class="w-8 h-8"></i>
                        	</div>
                        	<input type="file" id="edit-img-input" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleEditImage(this)">
                    	</div>
                    	<span class="text-[10px] text-primary font-bold">Ø§Ø¶ØºØ· Ù„ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©</span>
                	</div>




                	<div>
                    	<label class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-1 block">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                    	<input id="edit-name" type="text" class="form-input">
                	</div>
                	<div>
                    	<label class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-1 block">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                    	<input id="edit-phone" type="tel" class="form-input">
                	</div>
                	<div class="grid grid-cols-2 gap-2">
                    	<div>
                        	<label class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-1 block">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label>
                        	<select id="edit-gov" onchange="updateEditCities()" class="form-input text-xs"></select>
                    	</div>
                    	<div>
                        	<label class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-1 block">Ø§Ù„Ù…Ø±ÙƒØ²/Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
                        	<select id="edit-city" class="form-input text-xs"></select>
                    	</div>
                	</div>
                	<div>
                    	<label class="text-[10px] font-bold text-slate-600 dark:text-slate-300 mb-1 block">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„</label>
                    	<input id="edit-address" type="text" class="form-input">
                	</div>




                	<div id="prof-password-section" class="hidden bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border border-slate-100 dark:border-slate-700 mt-4">
                    	<label class="text-[10px] font-bold text-slate-400 mb-2 block">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    	<div class="flex gap-2">
                        	<input id="new-password" type="password" class="form-input text-xs" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
                        	<button onclick="changePassword()" class="bg-navy dark:bg-primary text-white px-3 py-1 rounded-lg text-xs font-bold whitespace-nowrap">ØªØ­Ø¯ÙŠØ«</button>
                    	</div>
                	</div>




                	<div class="flex gap-2 pt-4">
                    	<button onclick="saveProfile()" class="flex-1 bg-primary text-white py-2 rounded-xl font-bold text-sm shadow-lg">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                    	<button onclick="toggleEditMode()" class="flex-1 bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-white py-2 rounded-xl font-bold text-sm">Ø¥Ù„ØºØ§Ø¡</button>
                	</div>
            	</div>




        	</div>
    	</div>
	</div>




	<!-- Order Modal (Req 7) -->
	<div id="order-modal" class="hidden modal-overlay">
    	<div class="mobile-full-modal animate-pop border border-slate-200 dark:border-slate-700">
        	<div class="bg-primary p-3 text-white flex justify-between items-center shrink-0">
            	<h3 class="font-bold text-sm">Ø·Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬</h3>
            	<button onclick="toggleOrderModal()" class="hover:bg-white/20 p-1 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
        	</div>
        	<div class="flex-1 overflow-y-auto p-4 bg-white dark:bg-darkbg custom-scroll">
            	<div class="mb-4 p-2 bg-slate-50 dark:bg-slate-800 rounded-lg flex gap-3 items-center">
                	<img id="ord-img" src="" class="w-12 h-12 rounded object-cover">
                	<div>
                    	<h4 id="ord-title" class="font-bold text-xs text-navy dark:text-white"></h4>
                    	<span id="ord-price" class="text-primary font-black text-sm"></span>
                	</div>
            	</div>




            	<div id="order-items-container" class="space-y-3">
                	<!-- Items will be added here -->
            	</div>




            	<button onclick="addOrderItem()" class="w-full py-2 mt-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl text-slate-500 text-xs font-bold hover:border-primary hover:text-primary transition flex items-center justify-center gap-1">
                	<i data-lucide="plus" class="w-3 h-3"></i> Ø¥Ø¶Ø§ÙØ© Ù‚Ø·Ø¹Ø© Ø£Ø®Ø±Ù‰
            	</button>




            	<div class="mt-6 space-y-3 border-t border-slate-100 dark:border-slate-700 pt-4">
                	<div class="grid grid-cols-2 gap-2">
                    	<div>
                        	<label class="form-label">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label>
                        	<select id="ord-gov" onchange="updateOrderCities()" class="form-input text-xs"></select>
                    	</div>
                    	<div>
                        	<label class="form-label">Ø§Ù„Ù…Ø±ÙƒØ²/Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
                        	<select id="ord-city" class="form-input text-xs"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option></select>
                    	</div>
                	</div>
                	<div>
                    	<label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„</label>
                    	<input id="ord-address" type="text" class="form-input text-xs" placeholder="Ø§Ù„Ø´Ø§Ø±Ø¹ØŒ Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø²Ù„...">
                	</div>
                	<div>
                    	<label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                    	<input id="ord-phone" type="tel" class="form-input text-xs" placeholder="01xxxxxxxxx">
                	</div>
            	</div>
        	</div>
        	<div class="p-3 border-t border-slate-100 dark:border-slate-700 bg-white dark:bg-darkbg shrink-0">
            	<div class="flex justify-between items-center mb-2">
                	<span class="text-xs font-bold text-slate-500">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
                	<span id="ord-total" class="text-lg font-black text-primary">0 Ø¬.Ù…</span>
            	</div>
            	<button onclick="confirmOrder()" class="w-full bg-navy dark:bg-primary text-white py-3 rounded-xl font-bold text-sm shadow-lg">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</button>
        	</div>
    	</div>
	</div>




	<!-- Add Modal -->
	<div id="add-modal" class="hidden modal-overlay">
    	<div class="mobile-full-modal animate-pop border border-slate-200 dark:border-slate-700">
        	<div class="p-3 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800 shrink-0 h-12">
            	<h3 class="font-bold text-slate-800 dark:text-white text-sm">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</h3>
            	<button onclick="toggleAddModal()" class="bg-white dark:bg-slate-700 p-1 rounded-full border border-slate-200 dark:border-slate-600 text-slate-500 dark:text-white hover:text-red-500"><i data-lucide="x" class="w-4 h-4"></i></button>
        	</div>




        	<div class="flex-1 overflow-y-auto p-3 space-y-2 bg-white dark:bg-darkbg custom-scroll">
            	<div class="form-group"><span class="form-label">Ø§Ù„ØµÙˆØ± (max 7)</span><div class="grid grid-cols-4 gap-2"><label class="aspect-square border-2 border-dashed border-primary/40 bg-primary/5 dark:bg-primary/10 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:border-primary hover:bg-primary/10 transition text-primary relative overflow-hidden group"><input type="file" multiple accept="image/*" onchange="handleUpload(this)" class="absolute inset-0 opacity-0 z-10"><i data-lucide="camera" class="w-5 h-5 mb-1 group-hover:scale-110 transition"></i><span class="text-[9px] font-bold">Ø¥Ø¶Ø§ÙØ©</span></label><div id="preview-area" class="col-span-3 flex gap-2 overflow-x-auto no-scrollbar items-center"></div></div></div>




            	<div class="grid grid-cols-2 gap-2">
                	<div class="form-group"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label><input id="in-title" class="form-input h-9 text-xs" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬..."></div>
                	<div class="form-group"><label class="form-label">Ø§Ù„Ø³Ø¹Ø±</label><input id="in-price" type="number" class="form-input h-9 text-xs" placeholder="0"></div>
            	</div>




            	<div class="grid grid-cols-2 gap-2">
                	<div class="form-group"><label class="form-label">Ø§Ù„Ù‚Ø³Ù…</label><select id="in-cat" onchange="updateFormFields()" class="form-input h-9 text-xs bg-gray-50"></select></div>
                	<div id="field-condition" class="form-group hidden"><label class="form-label">Ø§Ù„Ø­Ø§Ù„Ø©</label><select id="in-condition" class="form-input h-9 text-xs"><option value="new">Ø¬Ø¯ÙŠØ¯</option><option value="used">Ù…Ø³ØªØ¹Ù…Ù„</option><option value="openbox">ÙƒØ³Ø± Ø²ÙŠØ±Ùˆ</option></select></div>
            	</div>




            	<div id="dynamic-fields" class="bg-slate-50 dark:bg-slate-800/50 p-2 rounded-lg border border-slate-100 dark:border-slate-700 form-group space-y-2 hidden">
                	<div id="field-size-chips" class="hidden">
                    	<label class="form-label text-primary">Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</label>
                    	<div id="size-chips-container" class="flex flex-wrap gap-1.5"></div>
                	</div>
                	<div id="field-color-chips" class="hidden">
                    	<label class="form-label text-primary">Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ØªØ§Ø­Ø©</label>
                    	<div id="color-chips-container" class="flex flex-wrap gap-1.5"></div>
                	</div>
            	</div>




            	<div class="form-group bg-slate-50 dark:bg-slate-800/50 p-2 rounded-lg border border-slate-100 dark:border-slate-700">
                	<label class="form-label mb-1">Ø£Ù…Ø§ÙƒÙ† Ø§Ù„Ø´Ø­Ù†</label>
                	<div class="flex gap-2 mb-2">
                    	<label class="flex-1 cursor-pointer"><input type="radio" name="ship-mode" value="all" onchange="toggleShipGov()" checked class="hidden peer"><div class="text-center py-1.5 rounded-lg border border-slate-300 dark:border-slate-600 text-[10px] font-bold text-slate-500 peer-checked:border-primary peer-checked:text-primary peer-checked:bg-white dark:peer-checked:bg-slate-700 transition">ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª</div></label>
                    	<label class="flex-1 cursor-pointer"><input type="radio" name="ship-mode" value="specific" onchange="toggleShipGov()" class="hidden peer"><div class="text-center py-1.5 rounded-lg border border-slate-300 dark:border-slate-600 text-[10px] font-bold text-slate-500 peer-checked:border-primary peer-checked:text-primary peer-checked:bg-white dark:peer-checked:bg-slate-700 transition">Ù…Ø­Ø§ÙØ¸Ø§Øª Ù…Ø­Ø¯Ø¯Ø©</div></label>
                	</div>
                	<div id="ship-gov-container" class="hidden">
                    	<div class="text-[10px] mb-1 text-slate-400">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:</div>
                    	<div id="ship-gov-list" class="max-h-24 overflow-y-auto custom-scroll grid grid-cols-2 gap-1 p-1 bg-white dark:bg-darkbg border border-slate-200 dark:border-slate-600 rounded-lg">
                    	</div>
                	</div>
            	</div>




            	<div class="form-group"><label class="form-label">Ù…ÙˆØ§ØµÙØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©:</label><div class="flex flex-wrap gap-1.5"><label class="cursor-pointer"><input type="checkbox" class="chip-checkbox hidden" value="Ø£ØµÙ„ÙŠ"><div class="border border-slate-300 dark:border-slate-600 rounded-lg px-2 py-1 text-[10px] font-bold text-slate-500 dark:text-slate-400 transition hover:bg-slate-100">Ø£ØµÙ„ÙŠ</div></label><label class="cursor-pointer"><input type="checkbox" class="chip-checkbox hidden" value="Ù…ØªÙˆÙØ± ÙØ§ØªÙˆØ±Ø©"><div class="border border-slate-300 dark:border-slate-600 rounded-lg px-2 py-1 text-[10px] font-bold text-slate-500 dark:text-slate-400 transition hover:bg-slate-100">Ù…ØªÙˆÙØ± ÙØ§ØªÙˆØ±Ø©</div></label><label class="cursor-pointer"><input type="checkbox" class="chip-checkbox hidden" value="Ø¶Ù…Ø§Ù†"><div class="border border-slate-300 dark:border-slate-600 rounded-lg px-2 py-1 text-[10px] font-bold text-slate-500 dark:text-slate-400 transition hover:bg-slate-100">Ø¶Ù…Ø§Ù†</div></label><label class="cursor-pointer"><input type="checkbox" class="chip-checkbox hidden" value="ØªÙˆØµÙŠÙ„"><div class="border border-slate-300 dark:border-slate-600 rounded-lg px-2 py-1 text-[10px] font-bold text-slate-500 dark:text-slate-400 transition hover:bg-slate-100">ØªÙˆØµÙŠÙ„</div></label></div></div>




            	<div class="form-group"><label class="form-label">ØªÙ…ÙŠÙŠØ²:</label><div class="flex gap-2 p-1 bg-slate-100 dark:bg-slate-800 rounded-lg"><label class="flex-1 cursor-pointer text-center"><input type="radio" name="badge" value="none" checked class="hidden peer"><div class="text-center py-1 rounded-md text-[10px] font-bold text-slate-500 peer-checked:bg-white dark:peer-checked:bg-slate-700 peer-checked:shadow-sm peer-checked:text-navy dark:peer-checked:text-white transition">Ø¹Ø§Ø¯ÙŠ</div></label><label class="flex-1 cursor-pointer text-center"><input type="radio" name="badge" value="hot" class="hidden peer"><div class="text-center py-1 rounded-md text-[10px] font-bold text-slate-500 peer-checked:bg-orange-500 peer-checked:text-white transition">ğŸ”¥ Ø¹Ø±Ø¶</div></label></div></div>




            	<div class="grid grid-cols-3 gap-2">
                	<div class="form-group col-span-1"><label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input id="in-phone" type="tel" class="form-input h-9 text-xs" placeholder="01xxxxxxxxx"></div>
                	<div class="form-group col-span-2"><label class="form-label">Ø§Ù„ÙˆØµÙ</label><textarea id="in-desc" rows="1" class="form-input text-xs" placeholder="ØªÙØ§ØµÙŠÙ„..."></textarea></div>
            	</div>
        	</div>
        	<div class="p-3 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 shrink-0 pb-8 md:pb-3"><button onclick="submitListing()" id="btn-publish" class="w-full bg-navy dark:bg-primary text-white py-3 rounded-xl font-bold text-sm shadow-lg shadow-navy/20 hover:opacity-90 transition flex justify-center items-center gap-2"><span>Ù†Ø´Ø± Ø§Ù„Ø¢Ù†</span><i data-lucide="arrow-left" class="w-4 h-4"></i></button></div>
    	</div>
	</div>




	<!-- Details Modal -->
	<div id="details-modal" class="hidden modal-overlay">
    	<div class="mobile-full-modal animate-pop border border-slate-200 dark:border-slate-700">
        	<div class="relative h-72 bg-gray-100 dark:bg-slate-800 shrink-0 group">
            	<button onclick="closeDetails()" class="absolute top-3 left-3 bg-white/80 dark:bg-black/50 text-slate-800 dark:text-white p-1.5 rounded-full z-20 shadow-sm"><i data-lucide="x" class="w-5 h-5"></i></button>
            	
           <div class="absolute top-3 right-3 flex gap-2 z-20">
                <div id="d-admin-controls" class="flex gap-2"></div>

                <button onclick="copyDetails()" class="bg-white/80 dark:bg-black/50 text-slate-800 dark:text-white p-1.5 rounded-full shadow-sm hover:bg-white hover:text-primary transition"><i data-lucide="copy" class="w-5 h-5"></i></button>
                <button onclick="shareListing()" class="bg-white/80 dark:bg-black/50 text-slate-800 dark:text-white p-1.5 rounded-full shadow-sm"><i data-lucide="share-2" class="w-5 h-5"></i></button>
            </div>
            	<div id="details-slider-container" class="w-full h-full flex items-center justify-center bg-gray-100 dark:bg-slate-800">
                	<img id="details-img" src="" class="w-full h-full object-cover cursor-pointer" onclick="openLightbox(this.src)">
            	</div>
            	<div id="details-arrows"><button onclick="scrollDetails(1)" class="absolute left-2 top-1/2 -translate-y-1/2 bg-black/30 text-white p-1 rounded-full z-10"><i data-lucide="chevron-left" class="w-5 h-5"></i></button><button onclick="scrollDetails(-1)" class="absolute right-2 top-1/2 -translate-y-1/2 bg-black/30 text-white p-1 rounded-full z-10"><i data-lucide="chevron-right" class="w-5 h-5"></i></button></div>
            	<div id="details-dots" class="absolute bottom-3 left-1/2 -translate-x-1/2 z-20 flex gap-1.5"></div>
        	</div>
        	<div class="flex-1 overflow-y-auto p-4 bg-white dark:bg-darkbg custom-scroll">
            	<!-- Req 5: Order Button -->
            	<button onclick="toggleOrderModal()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold text-sm shadow-lg mb-4 flex items-center justify-center gap-2 animate-pulse">
                	<i data-lucide="shopping-cart" class="w-5 h-5"></i> Ø·Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬
            	</button>




            	<div id="d-pub-bar" class="flex items-center justify-between mb-2 p-1.5 bg-slate-100 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 h-auto cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-700/80 transition">
                 	<div class="flex items-center gap-2">
                     	<div id="d-pub-img" class="w-7 h-7 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center overflow-hidden"><i data-lucide="user" class="w-3 h-3 text-slate-400"></i></div>
                     	<div class="flex flex-col justify-center">
                         	<h4 id="d-pub-name" class="font-bold text-[10px] text-navy dark:text-white leading-tight">...</h4>
                         	<span class="text-[8px] text-slate-400">Ø§Ø¶ØºØ· Ù„Ø¹Ø±Ø¶ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø§Ø´Ø± </span>
                     	</div>
                 	</div>
                 	<div id="d-shipping-info" class="flex flex-wrap items-center gap-1 text-[9px] font-bold text-slate-500 bg-white dark:bg-slate-700 px-1.5 py-0.5 rounded border border-slate-200 dark:border-slate-600 max-w-[55%] justify-end leading-tight"></div>
            	</div>




            	<div class="flex justify-between items-start mb-2 bg-slate-100 dark:bg-slate-800 p-2 rounded-lg"><h2 id="d-title" class="text-base font-bold text-slate-900 dark:text-white leading-snug w-3/4 select-text"></h2><span id="d-price" class="text-primary font-black text-lg whitespace-nowrap select-text"></span></div>
            	<div class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400 mb-3 pb-2 border-b border-slate-100 dark:border-slate-700">
                	<span id="d-cat" class="bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded text-[10px] border border-slate-200 dark:border-slate-700"></span> 
                	<span id="d-cond" class="bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded text-[10px] border border-slate-200 dark:border-slate-700 font-bold"></span>
                	<span id="d-date" class="text-[10px] text-black dark:text-white font-bold mr-auto"></span>
            	</div>




            	<div id="d-variants-container" class="space-y-2 mb-4">
                	<div id="d-sizes-row" class="hidden flex flex-wrap items-center gap-2 bg-slate-100 dark:bg-slate-800 p-2 rounded-lg">
                    	<span class="text-[10px] font-bold text-slate-400 shrink-0">Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª:</span>
                    	<div id="d-sizes-list" class="flex flex-wrap gap-1"></div>
                	</div>
                	<div id="d-colors-row" class="hidden flex flex-wrap items-center gap-2 bg-slate-100 dark:bg-slate-800 p-2 rounded-lg">
                    	<span class="text-[10px] font-bold text-slate-400 shrink-0">Ø§Ù„Ø£Ù„ÙˆØ§Ù†:</span>
                    	<div id="d-colors-list" class="flex flex-wrap gap-1"></div>
                	</div>
            	</div>




            	<div id="d-features" class="flex flex-wrap gap-2 mb-4"></div>




            	<div class="space-y-1 mb-6"><h3 class="text-xs font-bold text-slate-900 dark:text-slate-200 uppercase tracking-wider">Ø§Ù„ÙˆØµÙ</h3><p id="d-desc" class="text-xs text-slate-600 dark:text-slate-300 leading-relaxed whitespace-pre-wrap bg-slate-100 dark:bg-slate-800 p-3 rounded-xl border border-slate-200 dark:border-slate-700 font-medium select-text"></p></div>




            	<div class="border-t border-slate-100 dark:border-slate-700 pt-4">
                	<h3 class="text-xs font-bold text-slate-900 dark:text-white mb-3">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h3>




                	<div id="product-reviews-list" class="space-y-3 mb-3"></div>
                	<div class="flex gap-2 mt-2">
                    	<button id="load-more-reviews" onclick="loadProductReviews(true)" class="hidden flex-1 text-center text-xs text-primary font-bold py-2 bg-slate-50 dark:bg-slate-800 rounded-lg">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯</button>
                    	<button id="load-less-reviews" onclick="loadProductReviews(false, true)" class="hidden flex-1 text-center text-xs text-red-500 font-bold py-2 bg-slate-50 dark:bg-slate-800 rounded-lg">Ø¹Ø±Ø¶ Ø£Ù‚Ù„</button>
                	</div>




                	<div id="add-review-form" class="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border border-slate-100 dark:border-slate-700 mt-2">
                    	<div class="flex justify-between items-center mb-2">
                        	<span class="text-[10px] font-bold">Ø£Ø¶Ù ØªÙ‚ÙŠÙŠÙ…Ùƒ</span>
                        	<div class="star-rating text-lg">
                            	<input type="radio" id="star5" name="rating" value="5" onclick="setRating(5)"><label for="star5">â˜…</label>
                            	<input type="radio" id="star4" name="rating" value="4" onclick="setRating(4)"><label for="star4">â˜…</label>
                            	<input type="radio" id="star3" name="rating" value="3" onclick="setRating(3)"><label for="star3">â˜…</label>
                            	<input type="radio" id="star2" name="rating" value="2" onclick="setRating(2)"><label for="star2">â˜…</label>
                            	<input type="radio" id="star1" name="rating" value="1" onclick="setRating(1)"><label for="star1">â˜…</label>
                        	</div>
                    	</div>
                    	<textarea id="review-text" class="form-input text-xs w-full mb-2" rows="2" placeholder="Ø§ÙƒØªØ¨ Ø±Ø£ÙŠÙƒ Ù‡Ù†Ø§..."></textarea>
                    	<button onclick="submitProductReview()" class="bg-navy dark:bg-primary text-white px-3 py-1.5 rounded-lg text-xs font-bold w-full">Ù†Ø´Ø± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
                	</div>
            	</div>
        	</div>
        	<div class="p-3 border-t border-slate-100 dark:border-slate-700 bg-white dark:bg-darkbg flex gap-2 shrink-0 pb-8 md:pb-3"><a id="d-wa" href="#" target="_blank" class="flex-1 bg-[#25D366] text-white py-2.5 rounded-xl flex justify-center items-center gap-2 font-bold shadow-lg hover:opacity-90 transition text-sm"><i data-lucide="message-circle" class="w-4 h-4"></i> ÙˆØ§ØªØ³Ø§Ø¨</a><a id="d-call" href="#" class="flex-1 bg-navy dark:bg-primary text-white py-2.5 rounded-xl flex justify-center items-center gap-2 font-bold shadow-lg hover:opacity-90 transition text-sm"><i data-lucide="phone" class="w-4 h-4"></i> Ø§ØªØµØ§Ù„</a></div>
    	</div>
	</div>




	<!-- Chat Modal -->
	<div id="chat-modal" class="hidden modal-overlay">
    	<div class="mobile-full-modal animate-pop border border-slate-200 dark:border-slate-700">
        	<div class="bg-navy dark:bg-primary p-3 text-white flex justify-between items-center shrink-0">
            	<div class="flex items-center gap-2">
                	<div class="bg-white/10 p-1.5 rounded-full"><i data-lucide="bot" class="w-5 h-5 text-yellow-400"></i></div>
                	<div><h4 class="font-bold text-xs">Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</h4></div>
            	</div>
            	<div class="flex items-center gap-2">
                	<a href="https://wa.me/201206244875" target="_blank" class="bg-[#25D366] px-2 py-1 rounded-full flex items-center gap-1 text-[10px] font-bold hover:opacity-90 transition">
                    	<i data-lucide="message-circle" class="w-3 h-3"></i> Ù„Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ 
                	</a>
                	<button onclick="toggleChat()" class="hover:bg-white/20 p-1 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            	</div>
        	</div>
        	<div id="chat-box" class="flex-1 bg-slate-100 dark:bg-slate-900 p-3 overflow-y-auto space-y-2 text-xs"></div>
        	<div class="p-2 bg-white dark:bg-slate-800 border-t dark:border-slate-700 flex items-center gap-2 shrink-0 pb-safe"><input id="chat-msg" type="text" class="flex-1 bg-slate-100 dark:bg-slate-700 border-0 rounded-full px-4 py-3 text-sm outline-none dark:text-white font-bold" placeholder="Ø§ÙƒØªØ¨..."><button onclick="sendMsg()" class="w-8 h-8 bg-navy dark:bg-primary rounded-full text-white flex items-center justify-center shadow"><i data-lucide="send" class="w-4 h-4"></i></button></div>
    	</div>
	</div>




	<!-- Lightbox -->
	<div id="lightbox" class="hidden fixed inset-0 bg-black/95 z-[150] flex flex-col items-center justify-center select-none">
    	<button onclick="closeLightbox()" class="absolute top-4 left-4 bg-white/20 text-white p-2 rounded-full z-20"><i data-lucide="x" class="w-6 h-6"></i></button>
    	<button onclick="navigateLightbox(-1)" class="absolute left-2 md:left-10 top-1/2 -translate-y-1/2 bg-black/30 text-white p-2 rounded-full z-20 hover:bg-black/50 transition"><i data-lucide="chevron-left" class="w-8 h-8"></i></button>
    	<button onclick="navigateLightbox(1)" class="absolute right-2 md:right-10 top-1/2 -translate-y-1/2 bg-black/30 text-white p-2 rounded-full z-20 hover:bg-black/50 transition"><i data-lucide="chevron-right" class="w-8 h-8"></i></button>
    	<div class="relative w-full h-full flex items-center justify-center"><img id="lightbox-img" src="" class="max-w-full max-h-[80vh] object-contain"></div>
	</div>




	<!-- Admin Panel -->
	<div id="admin-panel" class="hidden fixed inset-0 bg-navy z-[130] flex flex-col text-white"><div class="p-3 border-b border-white/10 flex justify-between items-center bg-[#001a38]"><h2 class="font-bold flex items-center gap-2 text-sm"><i data-lucide="shield" class="w-4 h-4 text-primary"></i> Ø§Ù„ØªØ­ÙƒÙ…</h2><div class="flex gap-3"><button onclick="refreshAdmin()"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button><button onclick="toggleAdminPanel()"><i data-lucide="x" class="w-5 h-5"></i></button></div></div><div class="flex-1 flex overflow-hidden"><div class="w-1/3 border-l border-white/10 bg-[#001f3f] overflow-y-auto p-2" id="admin-users-list"></div><div class="w-2/3 flex flex-col bg-navy relative"><div id="admin-chat-header" class="h-12 border-b border-white/10 flex items-center justify-between px-3 bg-[#001a38]"><span class="text-xs font-bold">Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø©</span><button onclick="kickUser()" id="btn-end-chat" class="hidden bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded flex items-center gap-1"><i data-lucide="slash" class="w-3 h-3"></i> Ø¥Ù†Ù‡Ø§Ø¡</button></div><div id="admin-msg-area" class="flex-1 p-3 overflow-y-auto space-y-2 text-xs"></div><div class="p-2 border-t border-white/10 flex gap-2 bg-[#001a38]"><input id="admin-input" class="flex-1 bg-white/5 border border-white/20 rounded px-3 py-1.5 text-xs text-white outline-none" placeholder="Ø§Ù„Ø±Ø¯..."><button onclick="sendAdminMsg()" class="bg-primary px-4 py-1.5 rounded text-xs font-bold">Ø¥Ø±Ø³Ø§Ù„</button></div></div></div></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    // ğŸ‘‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„: Ø¶ÙÙ†Ø§ enableIndexedDbPersistence
    import { getFirestore, doc, setDoc, getDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp, getDocs, limit, orderBy, startAfter, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Req 4: Service Worker Registration (Ù†Ø³Ø®Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù‚ÙˆÙŠ v2)
    if ('serviceWorker' in navigator) {
        const swCode = `
            const CACHE_NAME = 'souq-v2'; // ØºÙŠØ±Ù†Ø§ Ø§Ù„Ø§Ø³Ù… Ø¹Ø´Ø§Ù† Ù†Ø­Ø¯Ø« Ø§Ù„ÙƒØ§Ø´
            const ASSETS = [
                'https://cdn.tailwindcss.com',
                'https://unpkg.com/lucide@latest',
                'https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap'
            ];

            self.addEventListener('install', e => e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(ASSETS))));
            
            self.addEventListener('fetch', e => {
                const url = new URL(e.request.url);
                
                // Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©: Ø§Ù„ÙƒØ§Ø´ Ø£ÙˆÙ„Ø§Ù‹ (Ù„Ù„ØµÙˆØ± ÙˆØ§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ©)
                // Ø¯Ù‡ Ø§Ù„Ù„ÙŠ Ù‡ÙŠØ®Ù„ÙŠ Ø§Ù„ØµÙˆØ± ØªØ¸Ù‡Ø± ÙÙˆØ±Ø§Ù‹ Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ù†Øª Ø¶Ø¹ÙŠÙ Ø£Ùˆ Ù…Ù‚Ø·ÙˆØ¹
                if (e.request.destination === 'image' || e.request.destination === 'style' || e.request.destination === 'script' || e.request.destination === 'font') {
                    e.respondWith(
                        caches.match(e.request).then(cachedResponse => {
                            if (cachedResponse) return cachedResponse;
                            return fetch(e.request).then(networkResponse => {
                                return caches.open(CACHE_NAME).then(cache => {
                                    cache.put(e.request, networkResponse.clone());
                                    return networkResponse;
                                });
                            });
                        })
                    );
                } 
                // Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©: Ø§Ù„Ø´Ø¨ÙƒØ© Ø£ÙˆÙ„Ø§Ù‹ (Ù„Ø£ÙŠ Ø­Ø§Ø¬Ø© ØªØ§Ù†ÙŠØ© Ø²ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙŠØ©)
                else {
                    e.respondWith(fetch(e.request).catch(() => caches.match(e.request)));
                }
            });
        `;
        const blob = new Blob([swCode], {type: 'application/javascript'});
        navigator.serviceWorker.register(URL.createObjectURL(blob));
    }

    // PWA Install Logic
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        if(!localStorage.getItem('pwa_installed')) {
            document.getElementById('install-banner').classList.remove('hidden');
        }
    });

    window.installPWA = async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                localStorage.setItem('pwa_installed', 'true');
            }
            deferredPrompt = null;
            document.getElementById('install-banner').classList.add('hidden');
        }
    }

    window.closeInstall = () => {
        document.getElementById('install-banner').classList.add('hidden');
    }

    	const EGYPT_DATA = {
        	"Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©": ["Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±", "Ù…ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ", "Ø§Ù„ØªØ¬Ù…Ø¹ Ø§Ù„Ø®Ø§Ù…Ø³", "Ø´Ø¨Ø±Ø§", "Ø¹ÙŠÙ† Ø´Ù…Ø³", "Ø§Ù„Ù…Ø±Ø¬", "Ø­Ù„ÙˆØ§Ù†", "ÙˆØ³Ø· Ø§Ù„Ø¨Ù„Ø¯", "Ø§Ù„Ø²Ù…Ø§Ù„Ùƒ", "Ø§Ù„Ù…Ù†ÙŠÙ„", "Ø§Ù„Ø¹Ø¨Ø§Ø³ÙŠØ©", "Ø§Ù„Ø²ÙŠØªÙˆÙ†", "Ø­Ø¯Ø§Ø¦Ù‚ Ø§Ù„Ù‚Ø¨Ø©", "Ø§Ù„Ø³ÙŠØ¯Ø© Ø²ÙŠÙ†Ø¨"],
        	"Ø§Ù„Ø¬ÙŠØ²Ø©": ["Ø§Ù„Ù‡Ø±Ù…", "ÙÙŠØµÙ„", "6 Ø£ÙƒØªÙˆØ¨Ø±", "Ø§Ù„Ø´ÙŠØ® Ø²Ø§ÙŠØ¯", "Ø§Ù„Ø¯Ù‚ÙŠ", "Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†", "Ø§Ù„Ø¹Ø¬ÙˆØ²Ø©", "Ø¥Ù…Ø¨Ø§Ø¨Ø©", "Ø§Ù„ÙˆØ±Ø§Ù‚", "Ø¨ÙˆÙ„Ø§Ù‚ Ø§Ù„Ø¯ÙƒØ±ÙˆØ±", "Ø§Ù„Ø¹Ù…Ø±Ø§Ù†ÙŠØ©", "Ø§Ù„Ù…Ù†ÙŠØ¨", "Ø§Ù„Ø¨Ø¯Ø±Ø´ÙŠÙ†", "Ø§Ù„Ø­ÙˆØ§Ù…Ø¯ÙŠØ©", "Ø§Ù„ØµÙ", "Ø£Ø·ÙÙŠØ­"],
        	"Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©": ["Ø³Ù…ÙˆØ­Ø©", "Ù…ÙŠØ§Ù…ÙŠ", "Ø§Ù„Ù…Ù†ØªØ²Ù‡", "Ø³ÙŠØ¯ÙŠ Ø¨Ø´Ø±", "Ø§Ù„Ø¹ØµØ§ÙØ±Ø©", "Ø§Ù„Ù…Ù†Ø¯Ø±Ø©", "ÙÙŠÙƒØªÙˆØ±ÙŠØ§", "Ø¬Ù„ÙŠÙ…", "Ø³ØªØ§Ù†Ù„ÙŠ", "Ø±Ø´Ø¯ÙŠ", "ÙƒÙØ± Ø¹Ø¨Ø¯Ù‡", "Ù…Ø­Ø±Ù… Ø¨Ùƒ", "Ø§Ù„Ø¹Ø¬Ù…ÙŠ", "Ø§Ù„Ø¨ÙŠØ·Ø§Ø´", "Ø§Ù„Ù‡Ø§Ù†ÙˆÙÙŠÙ„", "Ø¨Ø±Ø¬ Ø§Ù„Ø¹Ø±Ø¨"],
        	"Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©": ["Ø§Ù„Ù…Ù†ØµÙˆØ±Ø©", "Ø·Ù„Ø®Ø§", "Ù…ÙŠØª ØºÙ…Ø±", "Ø¯ÙƒØ±Ù†Ø³", "Ø´Ø±Ø¨ÙŠÙ†", "Ø§Ù„Ø³Ù†Ø¨Ù„Ø§ÙˆÙŠÙ†", "Ø£Ø¬Ø§", "Ø¨Ù„Ù‚Ø§Ø³", "Ù…Ù†ÙŠØ© Ø§Ù„Ù†ØµØ±", "Ø§Ù„Ù…Ø·Ø±ÙŠØ©", "Ø§Ù„Ø¬Ù…Ø§Ù„ÙŠØ©", "Ø¨Ù†ÙŠ Ø¹Ø¨ÙŠØ¯"],
        	"Ø§Ù„Ø´Ø±Ù‚ÙŠØ©": ["Ø§Ù„Ø²Ù‚Ø§Ø²ÙŠÙ‚", "Ø§Ù„Ø¹Ø´Ø± Ù…Ù† Ø±Ù…Ø¶Ø§Ù†", "Ù…Ù†ÙŠØ§ Ø§Ù„Ù‚Ù…Ø­", "Ø¨Ù„Ø¨ÙŠØ³", "ÙØ§Ù‚ÙˆØ³", "Ø£Ø¨Ùˆ Ø­Ù…Ø§Ø¯", "Ø§Ù„Ø­Ø³ÙŠÙ†ÙŠØ©", "ÙƒÙØ± ØµÙ‚Ø±", "Ø£Ø¨Ùˆ ÙƒØ¨ÙŠØ±", "Ø¯ÙŠØ±Ø¨ Ù†Ø¬Ù…", "Ù…Ø´ØªÙˆÙ„ Ø§Ù„Ø³ÙˆÙ‚", "Ù‡Ù‡ÙŠØ§"],
        	"Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©": ["Ø´Ø¨ÙŠÙ† Ø§Ù„ÙƒÙˆÙ…", "Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø³Ø§Ø¯Ø§Øª", "Ù…Ù†ÙˆÙ", "Ø£Ø´Ù…ÙˆÙ†", "Ù‚ÙˆÙŠØ³Ù†Ø§", "Ø¨Ø±ÙƒØ© Ø§Ù„Ø³Ø¨Ø¹", "ØªÙ„Ø§", "Ø§Ù„Ø´Ù‡Ø¯Ø§Ø¡", "Ø§Ù„Ø¨Ø§Ø¬ÙˆØ±", "Ø³Ø±Ø³ Ø§Ù„Ù„ÙŠØ§Ù†"],
        	"Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©": ["Ø¨Ù†Ù‡Ø§", "Ø´Ø¨Ø±Ø§ Ø§Ù„Ø®ÙŠÙ…Ø©", "Ù‚Ù„ÙŠÙˆØ¨", "Ø§Ù„Ù‚Ù†Ø§Ø·Ø± Ø§Ù„Ø®ÙŠØ±ÙŠØ©", "Ø§Ù„Ø®Ø§Ù†ÙƒØ©", "ÙƒÙØ± Ø´ÙƒØ±", "Ø·ÙˆØ®", "Ø§Ù„Ø¹Ø¨ÙˆØ±", "Ø´Ø¨ÙŠÙ† Ø§Ù„Ù‚Ù†Ø§Ø·Ø±", "Ø§Ù„Ø®ØµÙˆØµ"],
        	"Ø§Ù„Ø¨Ø­ÙŠØ±Ø©": ["Ø¯Ù…Ù†Ù‡ÙˆØ±", "ÙƒÙØ± Ø§Ù„Ø¯ÙˆØ§Ø±", "Ø¥ÙŠØªØ§ÙŠ Ø§Ù„Ø¨Ø§Ø±ÙˆØ¯", "Ø£Ø¨Ùˆ Ø­Ù…Øµ", "ÙƒÙˆÙ… Ø­Ù…Ø§Ø¯Ø©", "Ø§Ù„Ø¯Ù„Ù†Ø¬Ø§Øª", "Ø­ÙˆØ´ Ø¹ÙŠØ³Ù‰", "Ø±Ø´ÙŠØ¯", "Ø¥Ø¯ÙƒÙˆ", "Ø§Ù„Ù…Ø­Ù…ÙˆØ¯ÙŠØ©", "Ø§Ù„Ø±Ø­Ù…Ø§Ù†ÙŠØ©", "Ø§Ù„Ù†ÙˆØ¨Ø§Ø±ÙŠØ©"],
        	"Ø§Ù„ØºØ±Ø¨ÙŠØ©": ["Ø·Ù†Ø·Ø§", "Ø§Ù„Ù…Ø­Ù„Ø© Ø§Ù„ÙƒØ¨Ø±Ù‰", "ÙƒÙØ± Ø§Ù„Ø²ÙŠØ§Øª", "Ø²ÙØªÙ‰", "Ø§Ù„Ø³Ù†Ø·Ø©", "Ù‚Ø·ÙˆØ±", "Ø¨Ø³ÙŠÙˆÙ†", "Ø³Ù…Ù†ÙˆØ¯"],
        	"Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯": ["Ø­ÙŠ Ø§Ù„Ø´Ø±Ù‚", "Ø­ÙŠ Ø§Ù„Ø¹Ø±Ø¨", "Ø­ÙŠ Ø§Ù„Ù…Ù†Ø§Ø®", "Ø­ÙŠ Ø§Ù„Ø¶ÙˆØ§Ø­ÙŠ", "Ø­ÙŠ Ø§Ù„Ø¬Ù†ÙˆØ¨", "Ø­ÙŠ Ø§Ù„Ø²Ù‡ÙˆØ±", "Ø¨ÙˆØ±ÙØ¤Ø§Ø¯"],
        	"Ø¯Ù…ÙŠØ§Ø·": ["Ø¯Ù…ÙŠØ§Ø·", "Ø±Ø£Ø³ Ø§Ù„Ø¨Ø±", "Ø¯Ù…ÙŠØ§Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "ÙØ§Ø±Ø³ÙƒÙˆØ±", "Ø§Ù„Ø²Ø±Ù‚Ø§", "ÙƒÙØ± Ø³Ø¹Ø¯", "Ø§Ù„Ø±ÙˆØ¶Ø©", "Ø§Ù„Ø³Ø±Ùˆ", "Ø¹Ø²Ø¨Ø© Ø§Ù„Ø¨Ø±Ø¬", "Ù…ÙŠØª Ø£Ø¨Ùˆ ØºØ§Ù„Ø¨"],
        	"Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©": ["Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©", "Ø§Ù„Ù‚ØµØ§ØµÙŠÙ†", "Ø§Ù„ØªÙ„ Ø§Ù„ÙƒØ¨ÙŠØ±", "ÙØ§ÙŠØ¯", "Ø§Ù„Ù‚Ù†Ø·Ø±Ø© Ø´Ø±Ù‚", "Ø§Ù„Ù‚Ù†Ø·Ø±Ø© ØºØ±Ø¨", "Ø£Ø¨Ùˆ ØµÙˆÙŠØ±"],
        	"Ø§Ù„Ø³ÙˆÙŠØ³": ["Ø­ÙŠ Ø§Ù„Ø³ÙˆÙŠØ³", "Ø­ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø¹ÙŠÙ†", "Ø­ÙŠ Ø¹ØªØ§Ù‚Ø©", "Ø­ÙŠ Ø§Ù„Ø¬Ù†Ø§ÙŠÙ†", "Ø­ÙŠ ÙÙŠØµÙ„"],
        	"ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®": ["ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®", "Ø¯Ø³ÙˆÙ‚", "ÙÙˆÙ‡", "Ù…Ø·ÙˆØ¨Ø³", "Ø¨Ù„Ø·ÙŠÙ…", "Ù…ØµÙŠÙ Ø¨Ù„Ø·ÙŠÙ…", "Ø§Ù„Ø­Ø§Ù…ÙˆÙ„", "Ø¨ÙŠÙ„Ø§", "Ø§Ù„Ø±ÙŠØ§Ø¶", "Ø³ÙŠØ¯ÙŠ Ø³Ø§Ù„Ù…", "Ù‚Ù„ÙŠÙ†"],
        	"Ø§Ù„ÙÙŠÙˆÙ…": ["Ø§Ù„ÙÙŠÙˆÙ…", "Ø§Ù„ÙÙŠÙˆÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø·Ø§Ù…ÙŠØ©", "Ø³Ù†ÙˆØ±Ø³", "Ø¥Ø·Ø³Ø§", "Ø¥Ø¨Ø´ÙˆØ§ÙŠ", "ÙŠÙˆØ³Ù Ø§Ù„ØµØ¯ÙŠÙ‚"],
        	"Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ": ["Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ", "Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø§Ù„ÙˆØ§Ø³Ø·Ù‰", "Ù†Ø§ØµØ±", "Ø¥Ù‡Ù†Ø§Ø³ÙŠØ§", "Ø¨Ø¨Ø§", "Ø§Ù„ÙØ´Ù†", "Ø³Ù…Ø³Ø·Ø§"],
        	"Ø§Ù„Ù…Ù†ÙŠØ§": ["Ø§Ù„Ù…Ù†ÙŠØ§", "Ø§Ù„Ù…Ù†ÙŠØ§ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø§Ù„Ø¹Ø¯ÙˆØ©", "Ù…ØºØ§ØºØ©", "Ø¨Ù†ÙŠ Ù…Ø²Ø§Ø±", "Ù…Ø·Ø§ÙŠ", "Ø³Ù…Ø§Ù„ÙˆØ·", "Ø£Ø¨Ùˆ Ù‚Ø±Ù‚Ø§Øµ", "Ù…Ù„ÙˆÙŠ", "Ø¯ÙŠØ± Ù…ÙˆØ§Ø³"],
        	"Ø£Ø³ÙŠÙˆØ·": ["Ø£Ø³ÙŠÙˆØ·", "Ø£Ø³ÙŠÙˆØ· Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø¯ÙŠØ±ÙˆØ·", "Ø§Ù„Ù‚ÙˆØµÙŠØ©", "Ø£Ø¨Ù†ÙˆØ¨", "Ù…Ù†ÙÙ„ÙˆØ·", "Ø£Ø¨Ùˆ ØªÙŠØ¬", "Ø§Ù„ØºÙ†Ø§ÙŠÙ…", "Ø³Ø§Ø­Ù„ Ø³Ù„ÙŠÙ…", "Ø§Ù„Ø¨Ø¯Ø§Ø±ÙŠ", "ØµØ¯ÙØ§"],
        	"Ø³ÙˆÙ‡Ø§Ø¬": ["Ø³ÙˆÙ‡Ø§Ø¬", "Ø³ÙˆÙ‡Ø§Ø¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø£Ø®Ù…ÙŠÙ…", "Ø£Ø®Ù…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø§Ù„Ø¨Ù„ÙŠÙ†Ø§", "Ø§Ù„Ù…Ø±Ø§ØºØ©", "Ø§Ù„Ù…Ù†Ø´Ø£Ø©", "Ø¯Ø§Ø± Ø§Ù„Ø³Ù„Ø§Ù…", "Ø¬Ø±Ø¬Ø§", "Ø¬Ù‡ÙŠÙ†Ø©", "Ø³Ø§Ù‚Ù„ØªØ©", "Ø·Ù…Ø§", "Ø·Ù‡Ø·Ø§"],
        	"Ù‚Ù†Ø§": ["Ù‚Ù†Ø§", "Ù‚Ù†Ø§ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø£Ø¨Ùˆ ØªØ´Øª", "Ù†Ø¬Ø¹ Ø­Ù…Ø§Ø¯ÙŠ", "Ø¯Ø´Ù†Ø§", "Ø§Ù„ÙˆÙ‚Ù", "Ù‚ÙØ·", "Ù‚ÙˆØµ", "Ù†Ù‚Ø§Ø¯Ø©", "ÙØ±Ø´ÙˆØ·"],
        	"Ø§Ù„Ø£Ù‚ØµØ±": ["Ø§Ù„Ø£Ù‚ØµØ±", "Ø¥Ø³Ù†Ø§", "Ø£Ø±Ù…Ù†Øª", "Ø§Ù„Ù‚Ø±Ù†Ø©", "Ø§Ù„Ø¨ÙŠØ§Ø¶ÙŠØ©", "Ø§Ù„Ø²ÙŠÙ†ÙŠØ©", "Ø§Ù„Ø·ÙˆØ¯"],
        	"Ø£Ø³ÙˆØ§Ù†": ["Ø£Ø³ÙˆØ§Ù†", "Ø£Ø³ÙˆØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "Ø¯Ø±Ø§Ùˆ", "ÙƒÙˆÙ… Ø£Ù…Ø¨Ùˆ", "Ù†ØµØ± Ø§Ù„Ù†ÙˆØ¨Ø©", "Ø¥Ø¯ÙÙˆ"],
        	"Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±": ["Ø§Ù„ØºØ±Ø¯Ù‚Ø©", "Ø±Ø£Ø³ ØºØ§Ø±Ø¨", "Ø³ÙØ§Ø¬Ø§", "Ø§Ù„Ù‚ØµÙŠØ±", "Ù…Ø±Ø³Ù‰ Ø¹Ù„Ù…", "Ø´Ù„Ø§ØªÙŠÙ†", "Ø­Ù„Ø§ÙŠØ¨"],
        	"Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯": ["Ø§Ù„Ø®Ø§Ø±Ø¬Ø©", "Ø§Ù„Ø¯Ø§Ø®Ù„Ø©", "Ø§Ù„ÙØ±Ø§ÙØ±Ø©", "Ø¨Ø§Ø±ÙŠØ³", "Ø¨Ù„Ø§Ø·"],
        	"Ù…Ø·Ø±ÙˆØ­": ["Ù…Ø±Ø³Ù‰ Ù…Ø·Ø±ÙˆØ­", "Ø§Ù„Ø­Ù…Ø§Ù…", "Ø§Ù„Ø¹Ù„Ù…ÙŠÙ†", "Ø§Ù„Ø¶Ø¨Ø¹Ø©", "Ø§Ù„Ù†Ø¬ÙŠÙ„Ø©", "Ø³ÙŠØ¯ÙŠ Ø¨Ø±Ø§Ù†ÙŠ", "Ø§Ù„Ø³Ù„ÙˆÙ…", "Ø³ÙŠÙˆØ©"],
        	"Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡": ["Ø§Ù„Ø¹Ø±ÙŠØ´", "Ø¨Ø¦Ø± Ø§Ù„Ø¹Ø¨Ø¯", "Ø§Ù„Ø´ÙŠØ® Ø²ÙˆÙŠØ¯", "Ø±ÙØ­", "Ø§Ù„Ø­Ø³Ù†Ø©", "Ù†Ø®Ù„"],
        	"Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡": ["Ø§Ù„Ø·ÙˆØ±", "Ø´Ø±Ù… Ø§Ù„Ø´ÙŠØ®", "Ø¯Ù‡Ø¨", "Ù†ÙˆÙŠØ¨Ø¹", "Ø·Ø§Ø¨Ø§", "Ø³Ø§Ù†Øª ÙƒØ§ØªØ±ÙŠÙ†", "Ø£Ø¨Ùˆ Ø±Ø¯ÙŠØ³", "Ø£Ø¨Ùˆ Ø²Ù†ÙŠÙ…Ø©", "Ø±Ø£Ø³ Ø³Ø¯Ø±"]
    	};




    	const pwaManifest = {
        	"name": "Ø§Ù„Ø³ÙˆÙ‚ ÙˆÙŠØ§Ùƒ",
        	"short_name": "Ø§Ù„Ø³ÙˆÙ‚ ÙˆÙŠØ§Ùƒ",
        	"start_url": ".",
        	"display": "standalone",
        	"background_color": "#0f172a",
        	"theme_color": "#0f172a",
        	"orientation": "portrait",
        	"scope": "/",
        	"description": "Ù…ØªØ¬Ø± Ø§ÙƒØªØ±ÙˆÙ†ÙŠ Ø¹ØµØ±ÙŠ",
        	"icons": [
            	{
                	"src": "https://cdn-icons-png.flaticon.com/512/641/641813.png",
                	"sizes": "192x192",
                	"type": "image/png"
            	},
             	{
                	"src": "https://cdn-icons-png.flaticon.com/512/641/641813.png",
                	"sizes": "512x512",
                	"type": "image/png"
            	}
        	]
    	};
    	const stringManifest = JSON.stringify(pwaManifest);
    	const blob = new Blob([stringManifest], {type: 'application/json'});
    	const manifestURL = URL.createObjectURL(blob);
    	document.querySelector('#manifest-link').setAttribute('href', manifestURL);

    	const firebaseConfig = {
      	apiKey: "AIzaSyA5OiTcX95GBgiJoDHnY3y7N23o-j8hsQ8",
      	authDomain: "services-cef84.firebaseapp.com",
      	databaseURL: "https://services-cef84-default-rtdb.firebaseio.com",
      	projectId: "services-cef84",
      	storageBucket: "services-cef84.firebasestorage.app",
      	messagingSenderId: "902396219187",
      	appId: "1:902396219187:web:3ba084a724266afa8bb846"
    	};

    	const app = initializeApp(firebaseConfig); 
    	const db = getFirestore(app); 
    	const auth = getAuth(app);

        // ğŸ”¥ ÙƒÙˆØ¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø°Ø§ÙƒØ±Ø© (Ø¹Ø´Ø§Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¨Ù‚Ù‰ Ø·ÙŠØ§Ø±Ø©)
        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') {
                console.log('Multiple tabs open, persistence can only be enabled in one tab at a a time.');
            } else if (err.code == 'unimplemented') {
                console.log('The current browser does not support all of the features required to enable persistence');
            }
        });


   	let state = { 
        	user: null, 
        	userData: null,
        	listings: [], 
        	images: [], 
        	chatId: null, 
        	chatStep: 0, 
        	tempName: '', 
        	activeAdminChat: null, 
        	isAdmin: false, 
        	welcomeSent: false, 
        	favorites: [], 
            
            // --- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø¨Ù†Ù‚Ø±Ø£ Ø¢Ø®Ø± Ù…ÙƒØ§Ù† Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© ---
        	currentFilter: localStorage.getItem('last_filter') || 'all', 
        	currentView: localStorage.getItem('last_view') || 'home', 
            // -------------------------------------------

        	currentItem: null, 
        	lightboxImages: [], 
        	lightboxIndex: 0,
        	detailsSliderIndex: 0, 
        	detailsSliderImages: [],
        	authRole: 'customer',
        	authType: 'login',
        	authImageBase64: null,
        	userRole: 'customer',
        	currentRating: 0,
        	currentUserRating: 0,
        	productReviews: [],
        	productReviewsLimit: 1,
        	profileReviews: [],
        	profileReviewsLimit: 3,
        	viewingProfileId: null,
        	orderItems: [] // Req 7
    	};



    	function initGovs() {
        	const govSelect = document.getElementById('auth-gov');
        	const filterGov = document.getElementById('filter-gov');
        	const shipGovList = document.getElementById('ship-gov-list'); 
        	const editGov = document.getElementById('edit-gov'); 
        	const ordGov = document.getElementById('ord-gov'); // Req 7




        	govSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>';
        	filterGov.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª</option>';
        	editGov.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>';
        	ordGov.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>';
        	shipGovList.innerHTML = '';




        	Object.keys(EGYPT_DATA).forEach(gov => {
            	govSelect.innerHTML += `<option value="${gov}">${gov}</option>`;
            	filterGov.innerHTML += `<option value="${gov}">${gov}</option>`;
            	editGov.innerHTML += `<option value="${gov}">${gov}</option>`;
            	ordGov.innerHTML += `<option value="${gov}">${gov}</option>`;
            	shipGovList.innerHTML += `
                	<label class="flex items-center gap-1 cursor-pointer hover:bg-slate-50 p-1 rounded">
                    	<input type="checkbox" name="ship-gov-check" value="${gov}" class="w-3 h-3 rounded border-gray-300 text-primary focus:ring-primary">
                    	<span class="text-[10px] font-bold text-slate-600">${gov}</span>
                	</label>
            	`;
        	});
    	}
    	initGovs();




    	window.updateCities = () => {
        	const gov = document.getElementById('auth-gov').value;
        	const citySelect = document.getElementById('auth-city');
        	citySelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²/Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</option>';
        	if(gov && EGYPT_DATA[gov]) {
            	EGYPT_DATA[gov].forEach(city => {
                	citySelect.innerHTML += `<option value="${city}">${city}</option>`;
            	});
        	}
    	}




    	window.updateEditCities = () => {
        	const gov = document.getElementById('edit-gov').value;
        	const citySelect = document.getElementById('edit-city');
        	citySelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²/Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</option>';
        	if(gov && EGYPT_DATA[gov]) {
            	EGYPT_DATA[gov].forEach(city => {
                	citySelect.innerHTML += `<option value="${city}">${city}</option>`;
            	});
        	}
    	}




    	// Req 3: Order Cities
    	window.updateOrderCities = () => {
        	const gov = document.getElementById('ord-gov').value;
        	const citySelect = document.getElementById('ord-city');
        	citySelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²/Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</option>';
        	if(gov && EGYPT_DATA[gov]) {
            	EGYPT_DATA[gov].forEach(city => {
                	citySelect.innerHTML += `<option value="${city}">${city}</option>`;
            	});
        	}
    	}
   	onAuthStateChanged(auth, async (u) => { 
        	if(u) { 
            	state.user = u;
            	try {
                	const userDoc = await getDoc(doc(db, "users", u.uid));
                	if (userDoc.exists()) {
                    	const data = userDoc.data();
                    	state.userData = data;
                    	state.userRole = data.role || 'customer';
                    	state.isAdmin = data.isAdmin === true;
                    	document.getElementById('header-username').innerText = data.name || u.displayName;
                    	document.getElementById('welcome-text').classList.remove('hidden');

                    	if(state.isAdmin) {
                        	document.getElementById('btn-admin-top').classList.remove('hidden');
                    	} else {
                         	document.getElementById('btn-admin-top').classList.add('hidden');
                    	}
                	}
            	} catch(e) {
                	console.warn("Role fetch failed", e);
            	}
            	
                // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø´Ø§Ø´Ø§Øª (Ø¨Ø¯ÙŠÙ„ forceSwitchToApp)
            	const loginView = document.getElementById('login-view');
            	loginView.classList.add('hidden');
            	loginView.style.setProperty('display', 'none', 'important');
            	document.getElementById('app-content').classList.remove('hidden');
                const loader = document.getElementById('loader');
                if(loader) loader.classList.add('hidden');

            	loadListings(); 
            	checkUserChat(); 
            	initFavs(); 
            	initCats(); 
        	} else {
            	state.user = null;
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© (Ø¨Ø¯ÙˆÙ† Ø³Ø¨Ù„Ø§Ø´ Ø³ÙƒØ±ÙŠÙ†)
            	const loginView = document.getElementById('login-view');
            	loginView.classList.remove('hidden');
            	loginView.style.removeProperty('display');
            	document.getElementById('app-content').classList.add('hidden');
        	}
    	});




    	window.setAuthRole = (role) => {
        	state.authRole = role;
        	const btnCust = document.getElementById('btn-role-customer');
        	const btnMark = document.getElementById('btn-role-marketer');
        	if (role === 'customer') {
            	btnCust.className = "flex-1 py-1.5 rounded-lg text-xs font-bold transition-all bg-navy dark:bg-primary text-white shadow-md";
            	btnMark.className = "flex-1 py-1.5 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:bg-white dark:hover:bg-slate-700";
        	} else {
            	btnMark.className = "flex-1 py-1.5 rounded-lg text-xs font-bold transition-all bg-navy dark:bg-primary text-white shadow-md";
            	btnCust.className = "flex-1 py-1.5 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:bg-white dark:hover:bg-slate-700";
        	}
    	}




    	window.setAuthType = (type) => {
        	state.authType = type;
        	const btnLogin = document.getElementById('btn-type-login');
        	const btnSignup = document.getElementById('btn-type-signup');
        	const actionBtn = document.getElementById('btn-auth-action');
        	const imgField = document.getElementById('auth-image-field');
        	const signupFields = document.getElementById('signup-fields');
        	const usernameLabel = document.getElementById('lbl-username');




        	if (type === 'login') {
            	btnLogin.className = "flex-1 py-1.5 rounded-lg text-xs font-bold transition-all bg-navy dark:bg-primary text-white shadow-md";
            	btnSignup.className = "flex-1 py-1.5 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:text-navy dark:hover:text-white";
            	actionBtn.innerHTML = `<span>Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø­Ø³Ø§Ø¨</span> <i data-lucide="arrow-left" class="w-4 h-4"></i>`;
            	imgField.classList.add('hidden');
            	imgField.classList.remove('flex');
            	signupFields.classList.add('hidden');
            	usernameLabel.innerText = "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)";
        	} else {
            	btnSignup.className = "flex-1 py-1.5 rounded-lg text-xs font-bold transition-all bg-navy dark:bg-primary text-white shadow-md";
            	btnLogin.className = "flex-1 py-1.5 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:text-navy dark:hover:text-white";
            	actionBtn.innerHTML = `<span>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</span> <i data-lucide="plus-circle" class="w-4 h-4"></i>`;
            	imgField.classList.remove('hidden');
            	imgField.classList.add('flex');
            	signupFields.classList.remove('hidden');
            	usernameLabel.innerText = "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)";
        	}
        	lucide.createIcons();
    	}




    	window.handleAuthImage = async (input) => {
        	if (input.files && input.files[0]) {
            	const c = await compress(input.files[0]);
            	state.authImageBase64 = c;
            	const preview = document.getElementById('auth-img-preview');
            	const placeholder = document.getElementById('auth-img-placeholder');
            	preview.src = c;
            	preview.classList.remove('hidden');
            	placeholder.classList.add('hidden');
        	}
    	}




    	window.processAuth = async () => {
        	const username = document.getElementById('auth-username').value.trim().toLowerCase();
        	const pass = document.getElementById('auth-pass').value;
        	const errDiv = document.getElementById('auth-error');
        	const btn = document.getElementById('btn-auth-action');




        	errDiv.classList.add('hidden');
        	errDiv.innerText = "";




        	if (!username || !pass) {
            	errDiv.innerText = "ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±";
            	errDiv.classList.remove('hidden');
            	return;
        	}




        	const usernameRegex = /^[a-z0-9_]+$/;
        	if (!usernameRegex.test(username)) {
            	errDiv.innerText = "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø­Ø±ÙˆÙ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙˆØ£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·";
            	errDiv.classList.remove('hidden');
            	return;
        	}




        	if (pass.length < 6) {
            	errDiv.innerText = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø±Ù‚Ø§Ù…/Ø­Ø±ÙˆÙ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„";
            	errDiv.classList.remove('hidden');
            	return;
        	}




        	const email = `${username}@souq.local`;
        	const originalBtnText = btn.innerHTML;
        	btn.disabled = true;
        	btn.innerHTML = `<div class="spinner"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...`;




        	try {
            	if (state.authType === 'signup') {
                	const nameAr = document.getElementById('auth-name-ar').value.trim();
                	const phone = document.getElementById('auth-phone').value.trim();
                	const gov = document.getElementById('auth-gov').value;
                	const city = document.getElementById('auth-city').value;
                	const address = document.getElementById('auth-address').value.trim();




                	if (!nameAr || !gov || !city || !address || !phone) {
                    	throw new Error("missing_fields");
                	}




                	const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                	const user = userCredential.user;




                	await updateProfile(user, { displayName: nameAr });




                	const newUser = {
                    	username: username,
                    	name: nameAr,
                    	phone: phone,
                    	email: email,
                    	role: state.authRole,
                    	governorate: gov,
                    	city: city,
                    	address: address,
                    	isAdmin: false,
                    	image: state.authImageBase64 || null, 
                    	createdAt: serverTimestamp()
                	};




                	await setDoc(doc(db, "users", user.uid), newUser);




                	state.userData = newUser;
                	state.userRole = state.authRole;
                	document.getElementById('header-username').innerText = nameAr;
                	document.getElementById('welcome-text').classList.remove('hidden');




            	} else {
                	await signInWithEmailAndPassword(auth, email, pass);
            	}




            	btn.innerHTML = `ØªÙ… Ø¨Ù†Ø¬Ø§Ø­ <i data-lucide="check" class="w-4 h-4"></i>`;
            	btn.classList.replace('bg-navy', 'bg-green-600');


setTimeout(() => {
    // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ
    document.getElementById('login-view').classList.add('hidden');
    document.getElementById('app-content').classList.remove('hidden');
    showToast(`Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚ ÙˆÙŠØ§Ùƒ ğŸ‘‹`, 's');
}, 500);


        	} catch (error) {
            	console.error("Auth Error:", error);
            	let msg = `Ø­Ø¯Ø« Ø®Ø·Ø£: ${error.code}`; 
            	if(error.message === "missing_fields") msg = "ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
            	else if(error.code === 'auth/email-already-in-use') msg = "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„";
            	else if(error.code === 'auth/wrong-password') msg = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
            	else if(error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') msg = "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
            	errDiv.innerText = msg;
            	errDiv.classList.remove('hidden');
            	btn.disabled = false;
            	btn.innerHTML = originalBtnText;
            	lucide.createIcons();
        	}
    	}




    	window.logout = () => {
        	signOut(auth).then(() => {
            	window.location.reload();
        	});
    	}




    	const CATEGORIES = [
        	"Ù…Ù„Ø§Ø¨Ø³ Ø±Ø¬Ø§Ù„ÙŠ", "Ù…Ù„Ø§Ø¨Ø³ Ø­Ø±ÙŠÙ…ÙŠ", "Ù…Ù„Ø§Ø¨Ø³ Ø§Ø·ÙØ§Ù„", "Ø§Ø­Ø°ÙŠØ© Ø±Ø¬Ø§Ù„ÙŠ", "Ø§Ø­Ø°ÙŠØ© Ø­Ø±ÙŠÙ…ÙŠ", "Ø§Ø­Ø°ÙŠØ© Ø§Ø·ÙØ§Ù„", 
        	"Ø§ÙƒØ³Ø³ÙˆØ±Ø§Øª Ø±Ø¬Ø§Ù„ÙŠ", "Ø§ÙƒØ³Ø³ÙˆØ±Ø§Øª Ø­Ø±ÙŠÙ…ÙŠ", "Ø§ÙƒØ³Ø³ÙˆØ±Ø§Øª Ø§Ø·ÙØ§Ù„", "Ø¨Ø±ÙØ§Ù†Ø§Øª Ø±Ø¬Ø§Ù„ÙŠ ÙˆØ­Ø±ÙŠÙ…ÙŠ", "Ø§Ù„Ø­Ù‚Ø§Ø¦Ø¨ Ø§Ù„Ø´Ø®ØµÙŠØ©",
        	"Ø§Ù„Ù†Ø¸Ø§Ø±Ø§Øª", "Ù…Ø³ØªØ­Ø¶Ø±Ø§Øª Ø§Ù„ØªØ¬Ù…ÙŠÙ„", "Ø§Ø¯ÙˆØ§Øª Ø­Ù„Ø§Ù‚Ø© Ù„Ù„Ø±Ø¬Ø§Ù„", "Ù…ÙƒÙ…Ù„Ø§Øª ØºØ°Ø§Ø¦ÙŠØ©", "Ø§Ø¯ÙˆØ§Øª Ø±ÙŠØ§Ø¶ÙŠØ©",
        	"Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø´Ø®ØµÙŠØ©", "Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ ÙˆØ§Ù„Ø§Ù„Ø¹Ø§Ø¨", "Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¹Ù†Ø§ÙŠØ© Ø¨Ø§Ù„Ø¨Ø´Ø±Ø©", "Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø§Ø·ÙØ§Ù„", "Ø§Ù‚Ù…Ø´Ø©"
    	];




    	const USED_CATS = ["Ø§Ù„Ù†Ø¸Ø§Ø±Ø§Øª", "Ø§ÙƒØ³Ø³ÙˆØ±Ø§Øª Ø±Ø¬Ø§Ù„ÙŠ", "Ø§ÙƒØ³Ø³ÙˆØ±Ø§Øª Ø­Ø±ÙŠÙ…ÙŠ", "Ø§ÙƒØ³Ø³ÙˆØ±Ø§Øª Ø§Ø·ÙØ§Ù„"];
    	const CLOTHES_CATS = ["Ù…Ù„Ø§Ø¨Ø³ Ø±Ø¬Ø§Ù„ÙŠ", "Ù…Ù„Ø§Ø¨Ø³ Ø­Ø±ÙŠÙ…ÙŠ", "Ù…Ù„Ø§Ø¨Ø³ Ø§Ø·ÙØ§Ù„", "Ø§Ù‚Ù…Ø´Ø©"];
    	const SHOES_CATS = ["Ø§Ø­Ø°ÙŠØ© Ø±Ø¬Ø§Ù„ÙŠ", "Ø§Ø­Ø°ÙŠØ© Ø­Ø±ÙŠÙ…ÙŠ", "Ø§Ø­Ø°ÙŠØ© Ø§Ø·ÙØ§Ù„"];




    	const SIZES_MEN = ["S", "M", "L", "XL", "2XL", "3XL", "4XL", "FreeSize"];
    	const SIZES_WOMEN = ["XS", "S", "M", "L", "XL", "2XL", "FreeSize"];
    	const SIZES_KIDS = ["1y", "2y", "4y", "6y", "8y", "10y", "12y", "14y", "16y"];
    	const SIZES_SHOES_ADULT = ["37", "38", "39", "40", "41", "42", "43", "44", "45"];
    	const SIZES_SHOES_KIDS = ["20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35"];




    	const BASIC_COLORS = ["Ø£Ø¨ÙŠØ¶", "Ø£Ø³ÙˆØ¯", "Ø±Ù…Ø§Ø¯ÙŠ", "ÙƒØ­Ù„ÙŠ", "Ø£Ø­Ù…Ø±", "Ø£Ø²Ø±Ù‚", "Ø¨ÙŠØ¬", "Ø£Ø®Ø¶Ø±", "Ø£ØµÙØ±", "Ø¨Ù†ÙŠ"];




     	const CATEGORY_IMAGES = {
        	"Ù…Ù„Ø§Ø¨Ø³ Ø±Ø¬Ø§Ù„ÙŠ": "https://images.unsplash.com/photo-1617137968427-85924c800a22?q=80&w=300&auto=format&fit=crop",
        	"Ø¨Ø±ÙØ§Ù†Ø§Øª Ø±Ø¬Ø§Ù„ÙŠ ÙˆØ­Ø±ÙŠÙ…ÙŠ": "https://images.unsplash.com/photo-1541643600914-78b084683601?q=80&w=300&auto=format&fit=crop",
        	"Ø§Ù„Ù†Ø¸Ø§Ø±Ø§Øª": "https://images.unsplash.com/photo-1572635196237-14b3f281503f?q=80&w=300&auto=format&fit=crop",
        	"Ù…Ø³ØªØ­Ø¶Ø±Ø§Øª Ø§Ù„ØªØ¬Ù…ÙŠÙ„": "https://images.unsplash.com/photo-1596462502278-27bfdc403348?q=80&w=300&auto=format&fit=crop",
        	"Ø§Ø¯ÙˆØ§Øª Ø­Ù„Ø§Ù‚Ø© Ù„Ù„Ø±Ø¬Ø§Ù„": "https://images.unsplash.com/photo-1621607512214-68297480165e?q=80&w=300&auto=format&fit=crop",
        	"Ù…ÙƒÙ…Ù„Ø§Øª ØºØ°Ø§Ø¦ÙŠØ©": "https://images.unsplash.com/photo-1581009137042-c552e485697a?q=80&w=300&auto=format&fit=crop",
        	"Ø§Ø­Ø°ÙŠØ© Ø­Ø±ÙŠÙ…ÙŠ": "https://images.unsplash.com/photo-1549298916-b41d501d3772?q=80&w=300&auto=format&fit=crop",
        	"Ø§Ø¯ÙˆØ§Øª Ø±ÙŠØ§Ø¶ÙŠØ©": "https://images.unsplash.com/photo-1517836357463-d25dfeac3438?q=80&w=300&auto=format&fit=crop",
        	"Ù…Ù„Ø§Ø¨Ø³ Ø­Ø±ÙŠÙ…ÙŠ": "https://images.pexels.com/photos/3772506/pexels-photo-3772506.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
        	"Ø§Ø­Ø°ÙŠØ© Ø±Ø¬Ø§Ù„ÙŠ": "https://images.pexels.com/photos/5264901/pexels-photo-5264901.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
        	"Ø§Ø­Ø°ÙŠØ© Ø§Ø·ÙØ§Ù„": "https://images.pexels.com/photos/29737094/pexels-photo-29737094.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
        	"Ù…Ù„Ø§Ø¨Ø³ Ø§Ø·ÙØ§Ù„": "https://images.pexels.com/photos/1620758/pexels-photo-1620758.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
        	"Ø§ÙƒØ³Ø³ÙˆØ±Ø§Øª Ø±Ø¬Ø§Ù„ÙŠ": "https://images.pexels.com/photos/3766112/pexels-photo-3766112.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
        	"Ø§ÙƒØ³Ø³ÙˆØ±Ø§Øª Ø­Ø±ÙŠÙ…ÙŠ": "https://images.pexels.com/photos/17568000/pexels-photo-17568000.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
        	"Ø§ÙƒØ³Ø³ÙˆØ±Ø§Øª Ø§Ø·ÙØ§Ù„": "https://images.pexels.com/photos/2848522/pexels-photo-2848522.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
        	"Ø§Ù„Ø­Ù‚Ø§Ø¦Ø¨ Ø§Ù„Ø´Ø®ØµÙŠØ©": "https://images.pexels.com/photos/1986996/pexels-photo-1986996.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
        	"Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø´Ø®ØµÙŠØ©": "https://images.pexels.com/photos/19066549/pexels-photo-19066549.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
        	"Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ ÙˆØ§Ù„Ø§Ù„Ø¹Ø§Ø¨": "https://images.pexels.com/photos/4491662/pexels-photo-4491662.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
        	"Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¹Ù†Ø§ÙŠØ© Ø¨Ø§Ù„Ø¨Ø´Ø±Ø©": "https://images.pexels.com/photos/10117729/pexels-photo-10117729.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
        	"Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø§Ø·ÙØ§Ù„": "https://images.pexels.com/photos/26337029/pexels-photo-26337029.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
        	"Ø§Ù‚Ù…Ø´Ø©": "https://images.pexels.com/photos/34636582/pexels-photo-34636582.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop"
    	};




    	function preloadCategoryImages() {
        	Object.values(CATEGORY_IMAGES).forEach(url => {
            	const img = new Image();
            	img.src = url;
        	});
    	}
    	preloadCategoryImages();




    	function initCats() {
        	const cont = document.getElementById('categories-container');
        	cont.innerHTML = `<button onclick="filter('all')" id="chip-all" class="chip-btn">Ø§Ù„ÙƒÙ„</button>`;
        	const sel = document.getElementById('in-cat');
        	sel.innerHTML = '';
        	CATEGORIES.forEach(c => {
            	const btn = document.createElement('button'); 
            	btn.innerText = c; 
            	btn.id = `chip-${c.replace(/\s/g, '')}`;
            	btn.className = "px-4 py-1.5 rounded-full bg-white dark:bg-darkbg border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-300 text-xs font-bold whitespace-nowrap transition hover:border-primary hover:text-primary chip-btn";
            	btn.onclick = () => filter(c); 
            	cont.appendChild(btn);
            	const opt = document.createElement('option'); 
            	opt.value = c; 
            	opt.innerText = c; 
            	sel.appendChild(opt);
        	});
    	}

function renderView() {
    // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
    localStorage.setItem('last_view', state.currentView);
    localStorage.setItem('last_filter', state.currentFilter);

    // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    const searchInput = document.getElementById('search-input');
    const catContainer = document.getElementById('categories-container');
    const searchContainer = document.getElementById('search-container');
    const viewHeader = document.getElementById('view-header');
    const filterBtn = document.getElementById('btn-filter-toggle');
    const filterPanel = document.getElementById('filter-panel');
    
    // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª
    const homeGrid = document.getElementById('home-grid');
    const prodGrid = document.getElementById('grid-container');
    
    // ğŸ‘‡ (1) ØªØ¹Ø±ÙŠÙ Ø¹Ù†ØµØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ÙØ§Ø±ØºØ©
    const emptyState = document.getElementById('empty-state'); 

    // Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø§Ù†Ù„ Ø§Ù„ÙÙ„ØªØ± Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ØªÙ†Ù‚Ù„
    filterPanel.classList.add('hidden');

    if (state.currentView === 'home') {
        // === ÙˆØ¶Ø¹ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ===
        
        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª
        if(homeGrid) homeGrid.classList.remove('hidden'); 
        prodGrid.classList.add('hidden');
        
        // ğŸ‘‡ (2) Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ù„Ø© "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬" Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        if(emptyState) emptyState.classList.add('hidden'); 

        // Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‡ÙŠØ¯Ø± ØºÙŠØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        viewHeader.classList.add('hidden');
        catContainer.classList.add('hidden');
        filterBtn.classList.add('hidden'); 
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨Ø­Ø«
        searchContainer.classList.remove('hidden');
        searchInput.placeholder = 'Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ø³Ù…...';

    } else if (state.currentView === 'category') {
        // === ÙˆØ¶Ø¹ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ===

        if(homeGrid) homeGrid.classList.add('hidden');
        prodGrid.classList.remove('hidden');

        viewHeader.classList.remove('hidden');
        const title = state.currentFilter === 'all' ? 'ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª' : (state.currentFilter === 'fav' ? 'Ø§Ù„Ù…ÙØ¶Ù„Ø©' : state.currentFilter);
        document.getElementById('view-title').innerText = title;

        if (state.currentFilter === 'fav') {
            searchContainer.classList.add('hidden');
            catContainer.classList.add('hidden');
        } else {
            searchContainer.classList.remove('hidden');
            filterBtn.classList.remove('hidden'); 
            searchInput.placeholder = 'Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬...';
            
            if (state.currentFilter === 'all') {
                catContainer.classList.remove('hidden');
            } else {
                catContainer.classList.add('hidden');
            }
        }

        prodGrid.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 pb-10';
        filter(state.currentFilter);
    }
    
    lucide.createIcons();

}

    	window.applyFilters = () => {
        	renderProducts();
    	}

    // ğŸ‘‡ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ù„Ø© ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ„ØªØ±Ø© Ù‡Ù†Ø§
    window.toggleFilterPanel = () => {
        document.getElementById('filter-panel').classList.toggle('hidden');
    }

   // Fix 5: Reset Button Logic (ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)
    window.resetFilters = () => {
        // 1. ØªÙØ±ÙŠØº Ø®Ø§Ù†Ø§Øª Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±
        document.getElementById('search-input').value = '';
        document.getElementById('filter-price').value = '';
        document.getElementById('filter-gov').value = '';

        // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        if (state.currentView === 'home') {
            // Ù„Ùˆ Ø¥Ù†Øª ÙÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©ØŒ Ø£Ø¸Ù‡Ø± Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ØªØ§Ù†ÙŠ
            renderCategoryCards();
        } else {
            // Ù„Ùˆ Ø¥Ù†Øª Ø¬ÙˆÙ‡ Ù‚Ø³Ù… Ø£Ùˆ Ø¨ØªØ¹Ø±Ø¶ Ù…Ù†ØªØ¬Ø§ØªØŒ Ø¹ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ù†ÙØ³ Ù…ÙƒØ§Ù†Ùƒ
            renderProducts();
        }
    };
 
    	window.switchToCategoryView = (category) => {
        	state.currentView = 'category';
        	state.currentFilter = category;
        	document.getElementById('search-input').value = '';
        	window.scrollTo({ top: 0, behavior: 'smooth' });
        	renderView();
    	}




    	window.switchToHomeView = () => {
        	state.currentView = 'home';
        	state.currentFilter = 'all';
        	document.getElementById('search-input').value = '';
        	window.scrollTo({ top: 0, behavior: 'smooth' });
        	renderView();
        	const url = new URL(window.location);
        	url.searchParams.delete('product_id');
        	window.history.replaceState({}, '', url);
    	}

function renderCategoryCards() {
    // ğŸ‘‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„: Ù†Ø³ØªÙ‡Ø¯Ù Ø§Ù„Ø¯ÙŠÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø®ØµØµ Ù„Ù„Ø£Ù‚Ø³Ø§Ù…
    const cont = document.getElementById('home-grid'); 
    
    const q = normalizeText(document.getElementById('search-input').value);
    
    // ğŸ‘‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†ØµØ± Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
    if (!cont) return;

    cont.innerHTML = '';
    const filteredCats = CATEGORIES.filter(c => normalizeText(c).includes(q));

    if (!filteredCats.length) {
        document.getElementById('empty-state').classList.remove('hidden');
    } else {
        document.getElementById('empty-state').classList.add('hidden');
        
        // Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙƒØ±ÙˆØª (Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆÙ„ÙƒÙ† Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… map Ùˆ join Ø£Ø³Ø±Ø¹ Ù„Ù„Ø£Ø¯Ø§Ø¡ Ù…Ù† innerHTML +=
        cont.innerHTML = filteredCats.map(cat => {
            const imageUrl = CATEGORY_IMAGES[cat] || 'https://images.unsplash.com/photo-1523275335684-37898b6baf30?q=80&w=300&auto=format&fit=crop';
            return `
                <div onclick="switchToCategoryView('${cat}')" class="relative rounded-xl overflow-hidden shadow-sm border-2 border-black dark:border-slate-700 h-28 cursor-pointer active:scale-95 transition-transform group flex items-center justify-center text-center p-2">
                    <img src="${imageUrl}" class="absolute inset-0 w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" loading="lazy">
                    <div class="absolute inset-0 bg-black/50"></div>
                    <h3 class="relative z-10 font-bold text-white text-sm drop-shadow-md">${cat}</h3>
                </div>`;
        }).join('');
    }
}

// ğŸ‘‡ Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹: Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù†Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ø±Ø³Ù… Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
// Ø¶Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ù…Ù„Ù Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø£Ùˆ Ø¨Ø¹Ø¯ ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
renderCategoryCards();



    	function loadListings() { 
        	showSkeletons(); 
        	onSnapshot(query(collection(db, "listings")), (snap) => { 
            	state.listings = []; 
            	snap.forEach(d => state.listings.push({id: d.id, ...d.data()})); 
            	state.listings.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); 




            	const params = new URLSearchParams(window.location.search);
            	const linkedProdId = params.get('product_id');
            	if(linkedProdId && !state.currentItem) {
               	const item = state.listings.find(i => i.id === linkedProdId);
               	if(item) openDetails(item.id);
            	}
            	renderView();
        	}); 
    	}




    	window.handleSearch = () => {
        	if (state.currentView === 'home') {
            	renderCategoryCards();
        	} else {
            	renderProducts();
        	}
    	};




    	window.filter = (type) => { 
        	state.currentFilter = type; 
        	document.querySelectorAll('#categories-container .chip-btn').forEach(btn => {
            	btn.className = "px-4 py-1.5 rounded-full bg-white dark:bg-darkbg border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-300 text-xs font-bold whitespace-nowrap transition hover:border-primary hover:text-primary chip-btn";
        	});
        	const activeId = type === 'all' ? 'chip-all' : `chip-${type.replace(/\s/g, '')}`;
        	const activeBtn = document.getElementById(activeId);
        	if(activeBtn) {
            	activeBtn.className = "px-5 py-1.5 rounded-full bg-navy dark:bg-primary text-white text-xs font-bold shadow whitespace-nowrap transform scale-105 transition chip-btn";
            	activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        	}
        	if (state.currentView !== 'category') {
            	state.currentView = 'category';
        	}
        	const title = type === 'all' ? 'ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª' : (type === 'fav' ? 'Ø§Ù„Ù…ÙØ¶Ù„Ø©' : type);
        	document.getElementById('view-title').innerText = title;
        	renderProducts(); 
    	};

   function renderProducts() {
        const q = normalizeText(document.getElementById('search-input').value);
        const priceFilter = document.getElementById('filter-price').value;
        const govFilter = document.getElementById('filter-gov').value;

        const cont = document.getElementById('grid-container'); 
        
        // 1. Ø§Ù„ØªØµÙÙŠØ© (Filtering)
        let filtered = state.listings.filter(item => { 
            let matchType = true; 
            if (state.currentFilter === 'fav') {
                matchType = (state.favorites || []).includes(item.id);
            } else {
                matchType = state.currentFilter === 'all' || item.category === state.currentFilter; 
            }
            
            const matchText = normalizeText(item.title).includes(q) || normalizeText(item.category || '').includes(q); 
            
            let matchGov = true;
            if(govFilter && item.governorate) {
                matchGov = item.governorate === govFilter;
            }

            return matchType && matchText && matchGov; 
        }); 

        // 2. Ø§Ù„ØªØ±ØªÙŠØ¨ (Sorting)
        if (priceFilter === 'low') {
            filtered.sort((a, b) => a.price - b.price);
        } else if (priceFilter === 'high') {
            filtered.sort((a, b) => b.price - a.price);
        }

        // 3. Ø§Ù„Ø±Ø³Ù… (Rendering) - Ø§Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙƒØ¨ÙŠØ± Ù‡Ù†Ø§ ğŸš€
        if(!filtered.length) {
            cont.innerHTML = ''; 
            document.getElementById('empty-state').classList.remove('hidden'); 
        } else { 
            document.getElementById('empty-state').classList.add('hidden'); 
            
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… map Ùˆ join Ø£Ø³Ø±Ø¹ Ø¨ÙƒØªÙŠØ± Ù…Ù† forEach Ùˆ innerHTML+=
            // Ø¯Ù‡ Ø¨ÙŠØ®Ù„ÙŠ Ø§Ù„Ù…ØªØµÙØ­ ÙŠØ±Ø³Ù… Ø§Ù„ØµÙØ­Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø³ Ø¨Ø¯Ù„ Ù…Ø§ ÙŠØ±Ø³Ù…Ù‡Ø§ Ù…Ø¹ ÙƒÙ„ Ù…Ù†ØªØ¬
            const cardsHTML = filtered.map(item => createCard(item)).join('');
            cont.innerHTML = cardsHTML;
        } 
        
        lucide.createIcons(); 
    }

    // Ø¯Ø§Ù„Ø© ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø³ÙŠØ¨Ù‡Ø§ Ø²ÙŠ Ù…Ø§ Ù‡ÙŠ)
    function formatDate(timestamp) {
        if (!timestamp) return '';
        const date = timestamp.toDate();
        const now = new Date();
        const diff = Math.floor((now - date) / 1000); // seconds

        if (diff < 60) return 'Ù…Ù†Ø° Ù„Ø­Ø¸Ø§Øª';
        if (diff < 3600) return `Ù…Ù†Ø° ${Math.floor(diff / 60)} Ø¯Ù‚ÙŠÙ‚Ø©`;
        if (diff < 86400) return `Ù…Ù†Ø° ${Math.floor(diff / 3600)} Ø³Ø§Ø¹Ø©`;
        if (diff < 604800) return `Ù…Ù†Ø° ${Math.floor(diff / 86400)} ÙŠÙˆÙ…`;
        return date.toLocaleDateString('ar-EG');
    }


   function createCard(item) {

        const imgs = Array.isArray(item.images) ? item.images : [item.image];
        const isFav = (state.favorites || []).includes(item.id);
        const heartClass = isFav ? "fill-red-500 text-red-500" : "text-white";
        
        // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: ØºÙŠØ±Ù†Ø§ left-1 Ø¥Ù„Ù‰ right-1
        let badge = item.badge === 'hot' ? `<span class="absolute top-1 right-1 bg-orange-500 text-white text-[9px] font-bold px-2 py-0.5 rounded shadow animate-pulse z-10">ğŸ”¥ Ø¹Ø±Ø¶</span>` : '';
        
        let statusOverlay = ''; 
        let isClickable = true; 
        
        if(item.status && item.status !== 'available') { 
            const txt = item.status === 'sold' ? 'ØªÙ… Ø§Ù„Ø¨ÙŠØ¹' : 'ØºÙŠØ± Ù…ØªØ§Ø­'; 
            statusOverlay = `<div class="absolute inset-0 z-20 bg-white/80 dark:bg-black/80 backdrop-blur-sm flex items-center justify-center"><span class="bg-red-600 text-white font-bold px-4 py-2 rounded-xl shadow-xl transform -rotate-12 text-sm">${txt}</span></div>`; 
        }

        return `<div class="bg-white dark:bg-slate-800 rounded-lg overflow-hidden shadow-sm border-2 border-black dark:border-slate-700 flex flex-col h-full cursor-pointer active:scale-95 transition-transform group relative" onclick="${isClickable ? `openDetails('${item.id}')` : ''}"><div class="relative w-full h-28 sm:h-36 bg-gray-200 dark:bg-slate-700">${statusOverlay} ${!statusOverlay ? badge : ''}<button onclick="toggleFav(event, '${item.id}')" class="absolute top-1 left-1 z-20 p-1.5 rounded-full bg-black/20 hover:bg-black/40"><i data-lucide="heart" class="w-3.5 h-3.5 ${heartClass}"></i></button><span class="absolute bottom-1 left-1 bg-white/80 text-black text-[8px] font-bold px-1 rounded z-10">${formatDate(item.createdAt)}</span><div id="slider-${item.id}" class="flex w-full h-full overflow-x-auto no-scrollbar snap-x snap-mandatory scroll-smooth">${imgs.map(src => `<img src="${src}" class="w-full h-full object-cover shrink-0 snap-center ${statusOverlay?'grayscale':''}" loading="lazy">`).join('')}</div><span class="absolute bottom-1 right-1 bg-white/90 dark:bg-black/60 text-slate-800 dark:text-white px-1.5 py-0.5 rounded text-[8px] font-bold shadow z-10">${item.category}</span></div><div class="p-1.5 flex-1 flex flex-col"><div class="flex justify-between items-start mb-0.5"><h3 class="font-bold text-slate-900 dark:text-white text-[10px] line-clamp-1">${item.title}</h3><span class="font-black text-primary text-[10px] whitespace-nowrap">${Number(item.price).toLocaleString()} Ø¬.Ù…</span></div><div class="text-[8px] text-slate-500 dark:text-slate-400 mb-1 flex gap-1 items-center"><span class="bg-slate-100 dark:bg-white/5 px-1 rounded">${item.condition==='new'?'Ø¬Ø¯ÙŠØ¯':(item.condition==='openbox'?'ÙƒØ³Ø± Ø²ÙŠØ±Ùˆ':'Ù…Ø³ØªØ¹Ù…Ù„')}</span></div><div class="mt-auto flex gap-1 pt-1 border-t border-slate-100 dark:border-slate-700"><a href="https://wa.me/20${item.phone}" target="_blank" onclick="event.stopPropagation()" class="flex-1 bg-primary text-white py-1 rounded flex justify-center items-center gap-1 text-[9px] font-bold"><i data-lucide="message-circle" class="w-3 h-3"></i> ÙˆØ§ØªØ³</a></div></div></div>`;

    }

    	function goToDetailsSlide(index, behavior = 'auto') {
        	const total = state.detailsSliderImages.length;
        	if (total === 0) return;
        	if (index < 0) index = total - 1;
        	if (index >= total) index = 0;
        	state.detailsSliderIndex = index;
        	const imgEl = document.getElementById('details-img');
        	if (imgEl) {
            	imgEl.src = state.detailsSliderImages[state.detailsSliderIndex];
        	}
        	updateSliderDots();
    	}




    	window.scrollDetails = (dir) => { 
        	const total = state.detailsSliderImages.length;
        	if (total <= 1) return;
        	let dirAmount = -dir;
        	let newIndex = state.detailsSliderIndex + dirAmount;
        	goToDetailsSlide(newIndex);
    	}




    	function updateSliderDots() {
        	if (state.detailsSliderImages.length <= 1) return;
        	for (let i = 0; i < state.detailsSliderImages.length; i++) {
            	const dot = document.getElementById(`dot-${i}`);
            	if (dot) {
                	dot.className = i === state.detailsSliderIndex 
                    	? 'w-4 h-2 rounded-full bg-white shadow transition-all' 
                    	: 'w-2 h-2 rounded-full bg-white/40 transition-all';
            	}
        	}
    	}




    	window.copyDetails = () => {
        	if(!state.currentItem) return;




        	const text = `Ø§Ù„Ù…Ù†ØªØ¬: ${state.currentItem.title}\nØ§Ù„Ø³Ø¹Ø±: ${Number(state.currentItem.price).toLocaleString()} Ø¬.Ù…\nØ§Ù„ÙˆØµÙ: ${state.currentItem.desc}\nÙ„Ù„ØªÙˆØ§ØµÙ„: ${state.currentItem.phone}`;




        	navigator.clipboard.writeText(text).then(() => {
            	showToast('ØªÙ… Ù†Ø³Ø® Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…');
        	}).catch(err => {
            	showToast('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®', 'e');
        	});
    	}
   window.openDetails = (id) => {
        // 1. Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙˆØ±Ø§Ù‹
        const item = state.listings.find(i => i.id === id); 
        if(!item) return;
        state.currentItem = item; 

        // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (ØªØ¸Ù‡Ø± ÙÙˆØ±Ø§Ù‹)
        document.getElementById('d-title').innerText = item.title; 
        document.getElementById('d-price').innerText = Number(item.price).toLocaleString() + ' Ø¬.Ù…'; 
        document.getElementById('d-cat').innerText = item.category; 
        document.getElementById('d-desc').innerText = item.desc;
        document.getElementById('d-cond').innerText = item.condition === 'new' ? 'Ø¬Ø¯ÙŠØ¯' : (item.condition === 'openbox' ? 'ÙƒØ³Ø± Ø²ÙŠØ±Ùˆ' : 'Ù…Ø³ØªØ¹Ù…Ù„');
        document.getElementById('d-date').innerText = formatDate(item.createdAt);

        // --- (Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©) Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø© ---
        const adminControls = document.getElementById('d-admin-controls');
        if(adminControls) {
            adminControls.innerHTML = ''; // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            const isOwner = state.user && state.user.uid === item.authorId;
            
            if (state.isAdmin || isOwner) {
                adminControls.innerHTML = `
                    <button onclick="del(null, '${item.id}')" class="bg-white/80 dark:bg-black/50 text-red-500 p-1.5 rounded-full shadow-sm hover:bg-white transition"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                    <button onclick="toggleStatus(event, '${item.id}', '${item.status || 'available'}')" class="bg-white/80 dark:bg-black/50 text-blue-500 p-1.5 rounded-full shadow-sm hover:bg-white transition"><i data-lucide="edit-3" class="w-5 h-5"></i></button>
                `;
            }
        }
        // ---------------------------------------------------

        // 3. ÙˆØ¶Ø¹ "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„" Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ù…Ø¤Ù‚ØªØ§Ù‹
        const pubName = document.getElementById('d-pub-name');
        const pubImg = document.getElementById('d-pub-img');
        pubName.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
        pubImg.innerHTML = `<div class="animate-pulse bg-slate-300 w-full h-full"></div>`; // Skeleton loader
        
        // ØªØ¬Ù‡ÙŠØ² Ø²Ø± Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
        document.getElementById('d-pub-bar').onclick = () => toggleProfile(item.authorId);

        // 4. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ù…Ù‚Ø§Ø³Ø§Øª
        const amCont = document.getElementById('d-features'); 
        amCont.innerHTML=''; 
        const sizeRow = document.getElementById('d-sizes-row');
        const sizeList = document.getElementById('d-sizes-list');
        const colorRow = document.getElementById('d-colors-row');
        const colorList = document.getElementById('d-colors-list');

        sizeRow.classList.add('hidden');
        colorRow.classList.add('hidden');
        sizeList.innerHTML = '';
        colorList.innerHTML = '';

        if(item.size && Array.isArray(item.size) && item.size.length > 0) {
             sizeRow.classList.remove('hidden');
             item.size.forEach(s => {
                 sizeList.innerHTML += `<span class="bg-white dark:bg-slate-700 text-slate-700 dark:text-white px-2 py-1 rounded-md text-[10px] font-bold border border-slate-200 dark:border-slate-600 shadow-sm min-w-[30px] text-center">${s}</span>`;
             });
        }

        if(item.color && Array.isArray(item.color) && item.color.length > 0) {
             colorRow.classList.remove('hidden');
             item.color.forEach(c => {
                 colorList.innerHTML += `<span class="bg-white dark:bg-slate-700 text-slate-700 dark:text-white px-2 py-1 rounded-md text-[10px] font-bold border border-slate-200 dark:border-slate-600 shadow-sm">${c}</span>`;
             });
        }

        if(item.features) item.features.forEach(a => amCont.innerHTML += `<span class="bg-slate-100 dark:bg-slate-700 dark:text-white px-2 py-1 rounded text-xs flex items-center gap-1 border border-slate-200 dark:border-slate-600 font-bold">${a}</span>`);

        // 5. Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø­Ù† ÙˆØ§Ù„Ø§ØªØµØ§Ù„
        const shipInfo = document.getElementById('d-shipping-info');
        if(item.shippingMode === 'specific' && item.shippingGov) {
             let govText = Array.isArray(item.shippingGov) ? item.shippingGov.join('ØŒ ') : item.shippingGov;
             shipInfo.innerHTML = `<i data-lucide="truck" class="w-3 h-3 shrink-0"></i> <span class="whitespace-normal leading-tight text-right">Ø§Ù„Ø´Ø­Ù† Ù…ØªØ§Ø­ Ù„Ù€: ${govText}</span>`;
        } else {
            shipInfo.innerHTML = `<i data-lucide="truck" class="w-3 h-3 shrink-0"></i> Ø´Ø­Ù† Ù„ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª`;
        }

        document.getElementById('d-wa').href = `https://wa.me/20${item.phone}?text=Ø§Ø³ØªÙØ³Ø§Ø± Ø¨Ø®ØµÙˆØµ: ${item.title}`; 
        document.getElementById('d-call').href = `tel:${item.phone}`;

        // 6. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ø³Ù„Ø§ÙŠØ¯Ø±
        const imgs = Array.isArray(item.images) ? item.images : [item.image]; 
        state.detailsSliderImages = imgs; 
        state.detailsSliderIndex = 0;   

        const dotsContainer = document.getElementById('details-dots');
        const imgEl = document.getElementById('details-img');
        if (imgEl) {
            imgEl.src = imgs.length > 0 ? imgs[0] : 'https://placehold.co/400x300/e2e8f0/94a3b8?text=No+Image';
            imgEl.onclick = () => openLightbox(imgEl.src); 
        }

        dotsContainer.innerHTML = ''; 
        if (imgs.length > 1) {
            dotsContainer.innerHTML = imgs.map((_, index) => 
                `<span id="dot-${index}" class="w-2 h-2 rounded-full bg-white/40 transition-all"></span>`
            ).join('');
        }
        document.getElementById('details-arrows').style.display = imgs.length > 1 ? 'block' : 'none';

        // 7. ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙÙˆØ±Ø§Ø§Ø§Ø§Ù‹
        toggleModal('details-modal'); 
        goToDetailsSlide(0, 'auto'); 
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø§Ø¨Ø·
        const url = new URL(window.location);
        url.searchParams.set('product_id', id);
        window.history.replaceState({}, '', url);

        // 8. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø§Ø¦Ø¹ ÙˆØ§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© (Lazy Loading)
        (async () => {
            try {
                // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø§Ø¦Ø¹
                const uSnap = await getDoc(doc(db, "users", item.authorId));
                if(uSnap.exists()) {
                    const uData = uSnap.data();
                    state.currentAuthor = uData;
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„Ù…Ø§ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙˆØµÙ„
                    if(document.getElementById('details-modal').classList.contains('hidden')) return; // Ù„Ùˆ Ù‚ÙÙ„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù‚Ø¨Ù„ Ù…Ø§ ØªØ®Ù„Øµ
                    
                    pubName.innerText = uData.name || "Ù…Ø³ØªØ®Ø¯Ù…";
                    if(uData.image) {
                        pubImg.innerHTML = `<img src="${uData.image}" class="w-full h-full object-cover">`;
                    } else {
                        pubImg.innerHTML = `<i data-lucide="user" class="w-4 h-4 text-slate-400"></i>`;
                        lucide.createIcons();
                    }
                } else {
                    pubName.innerText = "Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
                    state.currentAuthor = null;
                }
            } catch(e) {
                pubName.innerText = "Ù†Ø§Ø´Ø±";
                state.currentAuthor = null;
            }
            
            // Ø¬Ù„Ø¨ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
            state.productReviewsLimit = 1;
            loadProductReviews(false);
            lucide.createIcons(); // Ù„ØªØ­Ø¯ÙŠØ« Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„ØªØ­ÙƒÙ…
        })();
        
        lucide.createIcons(); // Ù„Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙˆØ± Ø§Ù„ÙØªØ­
    }

    	window.closeDetails = () => {
         	toggleModal('details-modal');
         	state.currentItem = null; 
         	document.getElementById('details-dots').innerHTML = ''; 
         	const imgEl = document.getElementById('details-img');
         	if (imgEl) { imgEl.src = ''; }
         	const url = new URL(window.location);
         	url.searchParams.delete('product_id');
         	window.history.replaceState({}, '', url);
    	}




    	function initFavs() { try { state.favorites = JSON.parse(localStorage.getItem('souq_favs') || '[]'); } catch(e){ state.favorites = []; } updateFavBadge(); }
    	window.toggleFav = (e, id) => { e.stopPropagation(); if(state.favorites.includes(id)) state.favorites = state.favorites.filter(i => i !== id); else state.favorites.push(id); localStorage.setItem('souq_favs', JSON.stringify(state.favorites)); updateFavBadge(); if(state.currentView === 'category') renderProducts(); };
    	function updateFavBadge() { const b = document.getElementById('fav-count'); if(b){ if(state.favorites.length) b.classList.remove('hidden'); else b.classList.add('hidden'); }}
    	window.toggleFavView = () => { 
        	state.currentView = 'category';
        	state.currentFilter = 'fav';
        	renderView();
        	showToast("Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙØ¶Ù„Ø© â¤ï¸"); 
    	};




    	window.updateFormFields = () => {
        	const cat = document.getElementById('in-cat').value;
        	document.getElementById('field-condition').classList.toggle('hidden', !USED_CATS.includes(cat));




        	const isClothes = CLOTHES_CATS.includes(cat);
        	const isShoes = SHOES_CATS.includes(cat);




        	const sizeContainer = document.getElementById('field-size-chips');
        	const sizeChips = document.getElementById('size-chips-container');
        	const colorContainer = document.getElementById('field-color-chips');
        	const colorChips = document.getElementById('color-chips-container');
        	const dynamicFields = document.getElementById('dynamic-fields');




        	sizeContainer.classList.add('hidden');
        	colorContainer.classList.add('hidden');
        	dynamicFields.classList.add('hidden');
        	sizeChips.innerHTML = '';
        	colorChips.innerHTML = '';




        	if (isClothes || isShoes) {
            	dynamicFields.classList.remove('hidden');
            	sizeContainer.classList.remove('hidden');




            	let sizes = [];
            	if (cat.includes("Ø§Ø·ÙØ§Ù„")) {
                	sizes = isShoes ? SIZES_SHOES_KIDS : SIZES_KIDS;
            	} else if (cat.includes("Ø­Ø±ÙŠÙ…ÙŠ")) {
                	sizes = isShoes ? SIZES_SHOES_ADULT : SIZES_WOMEN;
            	} else {
                	sizes = isShoes ? SIZES_SHOES_ADULT : SIZES_MEN;
            	}




            	sizes.forEach(s => {
                	sizeChips.innerHTML += `<label class="cursor-pointer"><input type="checkbox" name="smart-size" value="${s}" class="smart-option hidden"><div class="px-2 py-1 rounded-lg border border-slate-300 dark:border-slate-600 font-bold text-[10px] text-slate-500 hover:border-navy transition min-w-[30px] text-center">${s}</div></label>`;
            	});
        	}




        	if (isClothes) {
            	colorContainer.classList.remove('hidden');
            	BASIC_COLORS.forEach(c => {
                	colorChips.innerHTML += `<label class="cursor-pointer"><input type="checkbox" name="smart-color" value="${c}" class="smart-option hidden"><div class="px-2 py-1 rounded-lg border border-slate-300 dark:border-slate-600 font-bold text-[10px] text-slate-500 hover:border-navy transition">${c}</div></label>`;
            	});
        	}
    	}




    	window.toggleShipGov = () => {
         	const mode = document.querySelector('input[name="ship-mode"]:checked').value;
         	const container = document.getElementById('ship-gov-container');
         	if(mode === 'specific') {
             	container.classList.remove('hidden');
         	} else {
             	container.classList.add('hidden');
         	}
    	}




    	window.submitListing=async()=>{
        	if(!state.images.length)return showToast('Ù…Ø·Ù„ÙˆØ¨ ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„','e');
        	const btn = document.getElementById('btn-publish');
        	btn.disabled = true;
        	btn.innerHTML = '<span>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø´Ø±...</span>';
        	const bdg=document.querySelector('input[name="badge"]:checked').value;
        	const cond=document.getElementById('in-condition').value;
        	const cat=document.getElementById('in-cat').value;
        	const feats=[]; document.querySelectorAll('.chip-checkbox:checked').forEach(c=>feats.push(c.value));




        	const sizes = []; document.querySelectorAll('input[name="smart-size"]:checked').forEach(c => sizes.push(c.value));
        	const colors = []; document.querySelectorAll('input[name="smart-color"]:checked').forEach(c => colors.push(c.value));




        	const shipMode = document.querySelector('input[name="ship-mode"]:checked').value;
        	let shipGovs = [];
        	if(shipMode === 'specific') {
            	document.querySelectorAll('input[name="ship-gov-check"]:checked').forEach(c => shipGovs.push(c.value));
            	if(shipGovs.length === 0) {
                	showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø­Ø§ÙØ¸Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø´Ø­Ù†', 'e');
                	btn.disabled = false;
                	btn.innerHTML = '<span>Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬</span>';
                	return;
            	}
        	}




        	const userGov = state.userData ? state.userData.governorate : '';




        	await addDoc(collection(db,"listings"),{
            	title:document.getElementById('in-title').value,
            	price:Number(document.getElementById('in-price').value),
            	category:cat,
            	condition:cond,
            	size: sizes.length > 0 ? sizes : null, 
            	color: colors.length > 0 ? colors : null, 
            	shippingMode: shipMode,
            	shippingGov: shipMode === 'specific' ? shipGovs : null, 
            	phone:document.getElementById('in-phone').value,
            	desc:document.getElementById('in-desc').value,
            	features:feats,
            	images:state.images,
            	badge:bdg,
            	status:'available',
            	governorate: userGov,
            	createdAt:serverTimestamp(),
            	authorId:state.user.uid
        	});
        	showToast('ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­');
        	toggleAddModal();
        	btn.disabled = false;
        	btn.innerHTML = '<span>Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬</span><i data-lucide="arrow-left" class="w-4 h-4"></i>';
        	lucide.createIcons();
    	};




       // Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù (ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ù„ØªØºÙ„Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù)
    window.del = async (e, id) => {
        if(e) e.stopPropagation(); // Ù…Ù†Ø¹ ØªØ¹Ø§Ø±Ø¶ Ø§Ù„Ù†Ù‚Ø±Ø§Øª
        
        if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) {
            await deleteDoc(doc(db, "listings", id));
            showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­');
            closeDetails(); // <-- Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø©: Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù
        }
    };

    // Ø¯Ø§Ù„Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© (Ù…ØªØ§Ø­/Ù…Ø¨Ø§Ø¹)
    window.toggleStatus = async (e, id, currentStatus) => {
        if(e) e.stopPropagation();
        
        let nextStatus = currentStatus === 'available' ? 'sold' : 'available';
        await updateDoc(doc(db, "listings", id), { status: nextStatus });
        
        showToast(`ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰: ${nextStatus === 'available' ? 'Ù…ØªØ§Ø­' : 'Ù…ÙØ¨Ø§Ø¹'}`);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ùˆ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
        if(!document.getElementById('details-modal').classList.contains('hidden')) {
             openDetails(id); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø± ÙˆØ§Ù„Ø­Ø§Ù„Ø©
        }
    };



    	window.toggleDarkMode = () => { 
        	document.documentElement.classList.toggle('dark'); 
        	localStorage.setItem('souq_theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); 
    	}
    	if(localStorage.getItem('souq_theme') === 'dark') document.documentElement.classList.add('dark');




    	window.showToast=(m,t='s')=>{
        	const d=document.createElement('div');
        	const bgClass = t==='e' ? 'bg-red-600 text-white' : 'bg-green-600 text-white';
        	d.className=`toast px-6 py-3 rounded-full shadow-2xl flex items-center gap-2 text-xs font-bold ${bgClass}`;
        	d.innerHTML=`<i data-lucide="${t==='e'?'alert-circle':'check-circle'}" class="w-4 h-4"></i> ${m}`;
        	document.getElementById('toast-container').appendChild(d);
        	lucide.createIcons();
        	setTimeout(()=>{d.classList.add('hiding');setTimeout(()=>d.remove(),300)},3000)
    	};




    	function normalizeText(t) { return t.replace(/[Ø£Ø¥Ø¢]/g,'Ø§').replace(/Ø©/g,'Ù‡').replace(/Ù‰/g,'ÙŠ').toLowerCase(); }
    	function showSkeletons() { const c=document.getElementById('grid-container'); c.innerHTML=''; for(let i=0;i<8;i++) c.innerHTML+=`<div class="bg-white dark:bg-slate-800 rounded-lg overflow-hidden shadow-sm border-2 border-slate-200 dark:border-slate-700 h-full"><div class="h-32 skeleton"></div><div class="p-2 space-y-2"><div class="h-4 rounded skeleton w-3/4"></div><div class="h-3 rounded skeleton w-1/2"></div></div></div>`; }




    	window.shareListing = async () => { 
        	if(!state.currentItem) return; 
        	const directLink = `${window.location.origin}${window.location.pathname}?product_id=${state.currentItem.id}`;
        	const d = { title: 'Ø§Ù„Ø³ÙˆÙ‚ ÙˆÙŠØ§Ùƒ', text: `Ø´Ø§Ù‡Ø¯ Ø§Ù„Ù…Ù†ØªØ¬: ${state.currentItem.title}`, url: directLink }; 
        	try { await navigator.share(d); showToast('ØªÙ…Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­'); } catch(e) { navigator.clipboard.writeText(d.url); showToast('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·'); } 
    	};




    	window.scrollCard = (e, id, dir) => { 
        	e.stopPropagation(); 
        	const s = document.getElementById(`slider-${id}`);
        	if (!s) return;
        	const totalImages = s.children.length;
        	if (totalImages <= 1) return;
        	const imgWidth = s.clientWidth;
        	let currentIndex = Math.round(s.scrollLeft / imgWidth);
        	let nextIndex = currentIndex - dir; 
        	if (nextIndex >= totalImages) { nextIndex = 0; } else if (nextIndex < 0) { nextIndex = totalImages - 1; }
        	s.scrollTo({ left: nextIndex * imgWidth, behavior: 'smooth' });
    	}




    	window.openLightbox = (src) => {
        	if (!src || src.endsWith('?text=No+Image')) return; 
        	if(state.currentItem && document.getElementById('details-modal').classList.contains('hidden') === false) {
             	state.lightboxImages = state.detailsSliderImages;
        	} else {
             	state.lightboxImages = state.detailsSliderImages.length ? state.detailsSliderImages : [];
             	if(!state.lightboxImages.length && state.currentItem) {
                 	state.lightboxImages = Array.isArray(state.currentItem.images) ? state.currentItem.images : [state.currentItem.image].filter(Boolean);
             	}
        	}
        	state.lightboxIndex = state.lightboxImages.indexOf(src);
        	if (state.lightboxIndex === -1) state.lightboxIndex = 0; 
        	if (state.lightboxImages.length > 0) {
            	document.getElementById('lightbox-img').src = state.lightboxImages[state.lightboxIndex];
            	document.getElementById('lightbox').classList.remove('hidden');
            	lucide.createIcons(); 
        	}
    	}




    	window.navigateLightbox = (dir) => {
        	if (!state.lightboxImages.length) return;
        	state.lightboxIndex += dir;
        	if (state.lightboxIndex >= state.lightboxImages.length) {
            	state.lightboxIndex = 0;
        	} else if (state.lightboxIndex < 0) {
            	state.lightboxIndex = state.lightboxImages.length - 1;
        	}
        	document.getElementById('lightbox-img').src = state.lightboxImages[state.lightboxIndex];
    	}




    	window.closeLightbox = () => {
        	document.getElementById('lightbox').classList.add('hidden');
        	state.lightboxImages = [];
        	state.lightboxIndex = 0;
    	}




    	function toggleModal(id) { const m=document.getElementById(id); m.classList.toggle('hidden'); if(!m.classList.contains('hidden')) document.body.style.overflow='hidden'; else document.body.style.overflow=''; return !m.classList.contains('hidden'); }




    	window.toggleAddModal=()=>{
        	if(state.userRole !== 'marketer') {
            	if(confirm("Ø¹ÙÙˆØ§Ù‹ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„ØºÙŠØ± Ø§Ù„Ù…Ø³ÙˆÙ‚ÙŠÙ† ÙˆØ£ØµØ­Ø§Ø¨ Ø§Ù„Ø¹Ù…Ù„.\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø£Ù† ØªØµØ¨Ø­ Ù…Ø³ÙˆÙ‚ØŸ")) {
                	state.userRole = 'marketer';
                	updateDoc(doc(db, "users", state.user.uid), { role: 'marketer' }).then(() => {
                     	showToast(`Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø´Ø±ÙƒØªÙ†Ø§ ğŸ‘‹`, 's');
                     	openAddModalLogic();
                	});
            	} else {
                	showToast("Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ù…Ø³ÙˆÙ‚ÙŠÙ† ÙˆÙ…Ù‚Ø¯Ù…ÙŠ Ø§Ù„Ø®Ø¯Ù…Ø§Øª", 'e');
            	}
        	} else {
            	openAddModalLogic();
        	}
    	};




    	function openAddModalLogic() {
        	if(toggleModal('add-modal')) { 
            	state.images=[];
            	document.getElementById('preview-area').innerHTML='';
            	document.getElementById('in-title').value = '';
            	document.getElementById('in-price').value = '';
            	document.getElementById('in-phone').value = '';
            	document.getElementById('in-desc').value = '';
            	document.getElementById('in-cat').selectedIndex = 0;
            	document.getElementById('in-condition').selectedIndex = 0;
            	document.querySelectorAll('.chip-checkbox').forEach(c => c.checked = false);
            	document.querySelector('input[name="badge"][value="none"]').checked = true;




            	document.querySelectorAll('.smart-option').forEach(c => c.checked = false);
            	document.querySelector('input[name="ship-mode"][value="all"]').checked = true;
            	document.querySelectorAll('input[name="ship-gov-check"]').forEach(c => c.checked = false);
            	toggleShipGov();




            	updateFormFields(); 
        	}
    	}

// ğŸ‘‡ ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø«ÙˆØ§Ø¨Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù€ Cloudinary (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚ÙŠÙ…Ùƒ Ø§Ù„Ø®Ø§ØµØ©)
const CLOUDINARY_CLOUD_NAME = 'db6h7zmth';
const CLOUDINARY_UPLOAD_PRESET = 'souq_upload';


// ğŸ‘‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: ØªØ±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø®Ø§Ù… Ù…Ø¨Ø§Ø´Ø±Ø© (Ø¨Ø¯ÙˆÙ† Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ compress)
window.handleUpload = async (input) => {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ØµÙˆØ±
    if (input.files.length + state.images.length > 7) return showToast('7 ØµÙˆØ± Ø¨Ø­Ø¯ Ø£Ù‚ØµÙ‰', 'e');
    
    // ÙˆØ¹Ø§Ø¡ Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±
    const previewArea = document.getElementById('preview-area');
    
    for (let f of input.files) {
        
        // 1. Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Skeleton Loader)
        const loadingImage = document.createElement('div');
        loadingImage.className = "w-14 h-14 rounded-xl object-cover border border-gray-200 shrink-0 flex items-center justify-center bg-slate-200 dark:bg-slate-700";
        loadingImage.innerHTML = `<div class="w-5 h-5 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>`;
        previewArea.appendChild(loadingImage);

        // 2. Ø¨Ù†Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ø±ÙØ¹ ØºÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Unsigned Upload)
        const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;
        const formData = new FormData();
        
        // ğŸ’¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ù†Ø³ØªØ®Ø¯Ù… Ù…Ù„Ù Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø®Ø§Ù… (f) Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Base64
        formData.append('file', f); 
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

        try {
            console.log("Cloudinary: Sending raw file upload request...");
            console.log("Cloudinary URL:", url);
            
            const response = await fetch(url, {
                method: 'POST',
                body: formData,
            });
            
            const data = await response.json();
            
            if (response.ok && data.secure_url) {
                // Ù†Ø¬Ø§Ø­ Ø§Ù„Ø±ÙØ¹
                state.images.push(data.secure_url);
                
                const uploadedImage = document.createElement('img');
                uploadedImage.src = data.secure_url;
                uploadedImage.className = "w-14 h-14 rounded-xl object-cover border border-gray-200 shrink-0";
                
                previewArea.replaceChild(uploadedImage, loadingImage);

                showToast('ØªÙ… Ø§Ù„Ø±ÙØ¹ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ…');
            } else {
                // ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹ - Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ù…Ù† Cloudinary ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„
                console.error("Cloudinary Upload Failed:", data);
                let errorMsg = data.error && data.error.message ? data.error.message : 'Unknown Cloudinary error. Check console.';
                showToast(`ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: ${errorMsg}`, 'e');
                loadingImage.remove();
            }
        } catch (error) {
            console.error("Cloudinary Network Error:", error);
            showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ© (ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„)', 'e');
            loadingImage.remove();
        }
    }
};

    	
    	window.toggleChat=()=>{
        	if(toggleModal('chat-modal')){
            	if(!state.chatId&&state.chatStep===0&&!state.welcomeSent){
                	state.welcomeSent=true;
                	const name = state.user.displayName || 'ÙŠØ§ ØµØ¯ÙŠÙ‚ÙŠ';
                	setTimeout(()=>botMsg(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${name} ğŸ‘‹<br>Ù…Ø¹Ùƒ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ø³ÙˆÙ‚  ÙˆÙŠØ§Ùƒ Ø§Ø®Ø¨Ø±Ù†ÙŠ Ø¨Ø·Ù„Ø¨Ùƒ Ù„ØªØ­ÙˆÙŠÙ„Ùƒ Ù„Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠØŸ`),100);
            	}
        	}
    	};




    	window.sendMsg=async()=>{
        	const t=document.getElementById('chat-msg').value.trim();
        	if(!t)return;
        	document.getElementById('chat-msg').value='';
        	userMsg(t);




        	if(!state.chatId){
            	if(state.chatStep===0){
                	state.chatStep=2;
                	try {
                    	const r=await addDoc(collection(db,"chats"),{
                        	userId:state.user.uid, 
                        	userName:state.user.displayName || state.user.email,
                        	lastMsg:t,
                        	status:'waiting',
                        	messages:[
                            	{s:'bot',t:`Ø§Ù„Ø§Ø³Ù…: ${state.user.displayName}`,d:new Date()},
                            	{s:'user',t,d:new Date()},
                            	{s:'bot',t:'ØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ù„Ø§Ø­Ø¯ Ù…Ù…Ø«Ù„ÙŠ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù†ØªØ¸Ø±  Ø§Ù„Ø±Ø¯',d:new Date()}
                        	],
                        	createdAt:serverTimestamp()
                    	});
                    	state.chatId=r.id;
                    	listenChat(r.id);
                	} catch (err) {
                    	console.error("Chat creation failed:", err);
                    	botMsg("Ø¹ÙÙˆØ§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙˆØµÙŠÙ„Ùƒ Ø¨Ø§Ù„Ø¯Ø¹Ù….");
                	}
            	}
        	} else {
            	const s=await getDocs(query(collection(db,"chats"),where('__name__','==',state.chatId)));
            	if(!s.empty){
                	const m=s.docs[0].data().messages;
                	m.push({s:'user',t,d:new Date()});
                	await updateDoc(doc(db,"chats",state.chatId),{messages:m,lastMsg:t,status:'waiting'});
            	}
        	}
    	};




    	function listenChat(id){onSnapshot(doc(db,"chats",id),s=>{if(s.exists()){const d=s.data();if(d.status==='closed'){state.chatId=null;state.chatStep=0;state.welcomeSent=false;document.getElementById('chat-box').innerHTML='';showToast("ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©");toggleModal('chat-modal');return}document.getElementById('chat-box').innerHTML='';d.messages.forEach(m=>{if(!m.t.startsWith('Ø§Ù„Ø§Ø³Ù…'))(m.s==='user'?userMsg:botMsg)(m.t)})}})};
    	function checkUserChat(){onSnapshot(query(collection(db,"chats"),where('userId','==',state.user.uid),where('status','!=','closed')),s=>{if(!s.empty){state.chatId=s.docs[0].id;state.chatStep=2;listenChat(state.chatId)}})};
    	function userMsg(t){const d=document.createElement('div');d.className="flex justify-start";d.innerHTML=`<div class="bg-primary text-white px-3 py-2 rounded-xl rounded-tr-none shadow-sm text-xs max-w-[85%]">${t}</div>`;document.getElementById('chat-box').appendChild(d);document.getElementById('chat-box').scrollTop=9999}
    	function botMsg(t){const d=document.createElement('div');d.className="flex justify-end";d.innerHTML=`<div class="bg-white dark:bg-slate-700 dark:text-white text-slate-800 px-3 py-2 rounded-xl rounded-tl-none shadow-sm text-xs max-w-[85%]">${t}</div>`;document.getElementById('chat-box').appendChild(d);document.getElementById('chat-box').scrollTop=9999}




    	window.toggleAdminPanel=()=>{document.getElementById('admin-panel').classList.toggle('hidden');if(!document.getElementById('admin-panel').classList.contains('hidden'))refreshAdmin()};




    	document.getElementById('logo-trigger').addEventListener('click',()=>{
        	if(prompt('Code:')==='1532'){
            	if(state.user) {
                	state.isAdmin = true;
                	document.getElementById('btn-admin-top').classList.remove('hidden');
                	showToast('ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø£Ø¯Ù…Ù† (Ù…Ø­Ù„ÙŠ)');
                	updateDoc(doc(db, "users", state.user.uid), { isAdmin: true }).catch(e => console.log("DB Update blocked by rules, local admin active"));
            	} else {
                	showToast("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹", "e");
            	}
        	}
    	});




    	window.refreshAdmin=()=>{
        	onSnapshot(query(collection(db,"chats"),where('status','!=','closed')),s=>{
            	const l=document.getElementById('admin-users-list');
            	l.innerHTML='';
            	let chats = [];
            	s.forEach(d => chats.push({id: d.id, ...d.data()}));
            	chats.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
            	chats.forEach(dt => {
                	l.innerHTML+=`<div onclick="loadAdmin('${dt.id}','${dt.userName}')" class="p-3 mb-2 bg-white/5 rounded-xl cursor-pointer border border-white/10"><div class="font-bold text-xs text-white flex justify-between"><span>${dt.userName}</span>${dt.status==='waiting'?'<span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>':''}</div><div class="text-[10px] text-gray-400 truncate mt-1">${dt.lastMsg}</div></div>`
            	});
        	})
    	};




    	window.loadAdmin=(id,n)=>{state.activeAdminChat=id;document.getElementById('admin-chat-header').innerHTML=`<span>${n}</span><button onclick="kickUser()" id="btn-end-chat" class="hidden bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded flex items-center gap-1"><i data-lucide="slash" class="w-3 h-3"></i> Ø¥Ù†Ù‡Ø§Ø¡</button>`;document.getElementById('btn-end-chat').classList.remove('hidden');onSnapshot(doc(db,"chats",id),s=>{const b=document.getElementById('admin-msg-area');b.innerHTML='';if(!s.exists())return;s.data().messages.forEach(m=>{b.innerHTML+=`<div class="${m.s==='support'?'text-left':'text-right'} mb-2"><span class="inline-block px-3 py-2 rounded-lg text-xs ${m.s==='support'?'bg-primary text-white':'bg-white/10'}">${m.t}</span></div>`});b.scrollTop=9999})};
    	window.sendAdminMsg=async()=>{const t=document.getElementById('admin-input').value;if(!t||!state.activeAdminChat)return;document.getElementById('admin-input').value='';const s=await getDocs(query(collection(db,"chats"),where('__name__','==',state.activeAdminChat)));const m=s.docs[0].data().messages;m.push({s:'support',t,d:new Date()});await updateDoc(doc(db,"chats",state.activeAdminChat),{messages:m,status:'active'})};
    	window.kickUser=async()=>{if(confirm("Ø¥Ù†Ù‡Ø§Ø¡ØŸ")){await updateDoc(doc(db,"chats",state.activeAdminChat),{status:'closed'});document.getElementById('admin-msg-area').innerHTML='';document.getElementById('btn-end-chat').classList.add('hidden');state.activeAdminChat=null}};




    	// Profile Logic (Updated)
    	window.toggleProfile = async (userId = null) => {
        	if(toggleModal('profile-modal')) {
            	const targetId = userId || (auth.currentUser ? auth.currentUser.uid : null);
            	if(!targetId) return;




            	state.viewingProfileId = targetId;
            	const isOwner = auth.currentUser && auth.currentUser.uid === targetId;




            	// Reset UI
            	document.getElementById('prof-name').innerText = '...';
            	document.getElementById('prof-role').innerText = '...';
            	document.getElementById('prof-phone').innerText = '...';
            	document.getElementById('prof-address').innerText = '...';
            	document.getElementById('prof-joined').innerText = '';
            	document.getElementById('prof-img-container').innerHTML = `<i data-lucide="user" class="w-10 h-10 text-slate-400"></i>`;
            	document.getElementById('prof-password-section').classList.add('hidden');
            	document.getElementById('prof-reviews-section').classList.add('hidden');
            	document.getElementById('prof-rate-user-section').classList.add('hidden');
            	document.getElementById('prof-rating-display').classList.add('hidden');
            	document.getElementById('global-edit-btn').classList.add('hidden');




            	// Ensure View Mode is active
            	document.getElementById('prof-view-mode').classList.remove('hidden');
            	document.getElementById('prof-edit-mode').classList.add('hidden');




            	try {
                	let data = null;
                	if(isOwner && state.userData) {
                    	data = state.userData;
                	} else {
                    	const snap = await getDoc(doc(db, "users", targetId));
                    	if(snap.exists()) data = snap.data();
                	}




                	if(data) {
                    	document.getElementById('prof-name').innerText = data.name || 'Ù…Ø³ØªØ®Ø¯Ù…';
                    	document.getElementById('prof-role').innerText = data.role === 'marketer' ? 'Ù…Ø³ÙˆÙ‚ / Ø¨Ø§Ø¦Ø¹' : 'Ø¹Ù…ÙŠÙ„';
                    	document.getElementById('prof-phone').innerText = data.phone || 'ØºÙŠØ± Ù…Ø³Ø¬Ù„';
                    	document.getElementById('prof-address').innerText = (data.address || '') + ' - ' + (data.governorate || '');
                    	document.getElementById('prof-joined').innerText = 'Ø§Ù†Ø¶Ù…: ' + formatDate(data.createdAt); // Req 10




                    	if(data.image) {
                        	document.getElementById('prof-img-container').innerHTML = `<img src="${data.image}" class="w-full h-full object-cover">`;
                    	}




                    	calculateUserRating(targetId);




                    	if(isOwner) {
                        	document.getElementById('global-edit-btn').classList.remove('hidden');
                        	document.getElementById('prof-password-section').classList.remove('hidden');
                    	} else {
                        	document.getElementById('prof-rate-user-section').classList.remove('hidden');
                    	}




                    	if(data.role === 'marketer') {
                         	document.getElementById('prof-reviews-section').classList.remove('hidden');
                         	state.profileReviewsLimit = 3;
                         	loadProfileReviews(false);
                    	}
                	}
            	} catch(e) {
                	console.error(e);
            	}
            	lucide.createIcons();
        	}
    	}




    	// Req 1: Full Edit Form Logic
    	window.toggleEditMode = () => {
        	const viewMode = document.getElementById('prof-view-mode');
        	const editMode = document.getElementById('prof-edit-mode');




        	if(editMode.classList.contains('hidden')) {
            	// Switch to Edit
            	viewMode.classList.add('hidden');
            	editMode.classList.remove('hidden');




            	// Pre-fill data
            	document.getElementById('edit-name').value = state.userData.name || '';
            	document.getElementById('edit-phone').value = state.userData.phone || '';
            	document.getElementById('edit-address').value = state.userData.address || '';
            	document.getElementById('edit-gov').value = state.userData.governorate || '';
            	updateEditCities();
            	document.getElementById('edit-city').value = state.userData.city || '';




            	if(state.userData.image) {
                	document.getElementById('edit-img-preview').src = state.userData.image;
                	document.getElementById('edit-img-preview').classList.remove('hidden');
                	document.getElementById('edit-img-placeholder').classList.add('hidden');
            	}
        	} else {
            	// Switch to View
            	editMode.classList.add('hidden');
            	viewMode.classList.remove('hidden');
        	}
    	}




    	window.handleEditImage = async (input) => {
        	if (input.files && input.files[0]) {
            	const c = await compress(input.files[0]);
            	document.getElementById('edit-img-preview').src = c;
            	document.getElementById('edit-img-preview').classList.remove('hidden');
            	document.getElementById('edit-img-placeholder').classList.add('hidden');
            	// Store temporarily
            	state.tempEditImage = c;
        	}
    	}




    	window.saveProfile = async () => {
        	const name = document.getElementById('edit-name').value.trim();
        	const phone = document.getElementById('edit-phone').value.trim();
        	const address = document.getElementById('edit-address').value.trim();
        	const gov = document.getElementById('edit-gov').value;
        	const city = document.getElementById('edit-city').value;




        	if(!name || !phone || !address || !gov || !city) return showToast("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„", "e");




        	const updateData = {
            	name, phone, address, governorate: gov, city
        	};




        	if(state.tempEditImage) {
            	updateData.image = state.tempEditImage;
        	}




        	try {
            	await updateDoc(doc(db, "users", state.user.uid), updateData);




            	// Update local state
            	state.userData = { ...state.userData, ...updateData };
            	state.tempEditImage = null;




            	// Update View
            	document.getElementById('prof-name').innerText = name;
            	document.getElementById('prof-phone').innerText = phone;
            	document.getElementById('prof-address').innerText = address + ' - ' + gov;
            	if(updateData.image) {
                	document.getElementById('prof-img-container').innerHTML = `<img src="${updateData.image}" class="w-full h-full object-cover">`;
            	}




            	showToast("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
            	toggleEditMode(); // Switch back to view
        	} catch(e) {
            	showToast("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸", "e");
        	}
    	}




    	window.changePassword = async () => {
        	const newPass = document.getElementById('new-password').value;
        	if(!newPass || newPass.length < 6) return showToast("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‚ØµÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹", "e");
        	try {
            	await updatePassword(auth.currentUser, newPass);
            	showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­");
            	document.getElementById('new-password').value = '';
        	} catch(e) {
            	showToast("ÙŠØ¬Ø¨ Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", "e");
        	}
    	}




    	// User Rating Logic
    	window.setUserRating = (n) => { state.currentUserRating = n; }




    	window.submitUserReview = async () => {
        	if(!state.user) return showToast("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØªÙ‚ÙŠÙŠÙ…", "e");
        	if(!state.viewingProfileId) return;
        	if(state.currentUserRating === 0) return showToast("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø¬ÙˆÙ…", "e");




        	const text = document.getElementById('user-review-text').value;




        	await addDoc(collection(db, "user_reviews"), {
            	targetUserId: state.viewingProfileId,
            	reviewerId: state.user.uid,
            	reviewerName: state.userData.name || 'Ù…Ø³ØªØ®Ø¯Ù…',
            	reviewerImage: state.userData.image || null,
            	rating: state.currentUserRating,
            	text: text,
            	timestamp: serverTimestamp()
        	});




        	showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…");
        	document.getElementById('user-review-text').value = '';
        	calculateUserRating(state.viewingProfileId);




        	// Refresh reviews
        	state.profileReviewsLimit = 3;
        	loadProfileReviews(false);
    	}




    	async function calculateUserRating(userId) {
        	const q = query(collection(db, "user_reviews"), where("targetUserId", "==", userId));
        	const snap = await getDocs(q);
        	if(!snap.empty) {
            	let total = 0;
            	snap.forEach(d => total += d.data().rating);
            	const avg = (total / snap.size).toFixed(1);
            	document.getElementById('prof-rating-val').innerText = avg;
            	document.getElementById('prof-rating-display').classList.remove('hidden');
        	} else {
            	document.getElementById('prof-rating-display').classList.add('hidden');
        	}
    	}




    	// Product Reviews Logic
    	window.setRating = (n) => { state.currentRating = n; }




    	window.submitProductReview = async () => {
        	if(!state.user) return showToast("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØªÙ‚ÙŠÙŠÙ…", "e");
        	if(!state.currentItem) return;
        	if(state.currentRating === 0) return showToast("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø¬ÙˆÙ…", "e");




        	const text = document.getElementById('review-text').value;




        	await addDoc(collection(db, "product_reviews"), {
            	productId: state.currentItem.id,
            	productAuthorId: state.currentItem.authorId, 
            	userId: state.user.uid,
            	userName: state.userData.name || 'Ù…Ø³ØªØ®Ø¯Ù…',
            	userImage: state.userData.image || null,
            	rating: state.currentRating,
            	text: text,
            	timestamp: serverTimestamp()
        	});




        	showToast("ØªÙ… Ù†Ø´Ø± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…");
        	document.getElementById('review-text').value = '';
        	state.productReviewsLimit = 1;
        	loadProductReviews(false);
    	}




    	// Req 3: Pagination Logic (Show More / Show Less)
    	window.loadProductReviews = async (append = false, reduce = false) => {
        	if(!state.currentItem) return;
        	const list = document.getElementById('product-reviews-list');
        	const btnMore = document.getElementById('load-more-reviews');
        	const btnLess = document.getElementById('load-less-reviews');




        	if(reduce) {
            	state.productReviewsLimit = 1;
            	append = false;
        	} else if(append) {
            	state.productReviewsLimit += 3;
        	}




        	const q = query(
            	collection(db, "product_reviews"), 
            	where("productId", "==", state.currentItem.id),
            	orderBy("timestamp", "desc"),
            	limit(state.productReviewsLimit + 1) 
        	);




        	const snap = await getDocs(q);
        	if(!append) list.innerHTML = '';




        	let count = 0;
        	snap.forEach(doc => {
            	if(count < state.productReviewsLimit) {
                	const r = doc.data();
                	const stars = "â˜…".repeat(r.rating) + "â˜†".repeat(5 - r.rating);
                	const img = r.userImage ? `<img src="${r.userImage}" class="w-full h-full object-cover">` : `<i data-lucide="user" class="w-4 h-4 text-slate-400"></i>`;




                	if(append && list.innerHTML.includes(r.text)) return; 




                	list.innerHTML += `
                    	<div class="bg-slate-50 dark:bg-slate-800/50 p-2 rounded-lg border border-slate-100 dark:border-slate-700">
                        	<div class="flex items-center gap-2 mb-1">
                            	<div class="w-6 h-6 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center overflow-hidden">${img}</div>
                            	<span class="text-[10px] font-bold text-navy dark:text-white">${r.userName}</span>
                            	<span class="text-yellow-400 text-xs tracking-tighter">${stars}</span>
                            	<span class="text-[8px] text-slate-300 mr-auto">${formatDate(r.timestamp)}</span>
                        	</div>
                        	<p class="text-[10px] text-slate-600 dark:text-slate-300 pr-8">${r.text || ''}</p>
                    	</div>
                	`;
            	}
            	count++;
        	});




        	if(snap.size > state.productReviewsLimit) {
            	btnMore.classList.remove('hidden');
        	} else {
            	btnMore.classList.add('hidden');
        	}




        	if(state.productReviewsLimit > 1) {
            	btnLess.classList.remove('hidden');
        	} else {
            	btnLess.classList.add('hidden');
        	}
        	lucide.createIcons();
    	}




    	window.loadProfileReviews = async (append = false, reduce = false) => {
        	if(!state.viewingProfileId) return;
        	const list = document.getElementById('prof-reviews-list');
        	const btnMore = document.getElementById('prof-reviews-more');
        	const btnLess = document.getElementById('prof-reviews-less');




        	if(reduce) {
            	state.profileReviewsLimit = 3;
            	append = false;
        	} else if(append) {
            	state.profileReviewsLimit += 3;
        	}




        	const q = query(
            	collection(db, "user_reviews"),
            	where("targetUserId", "==", state.viewingProfileId),
            	orderBy("timestamp", "desc"),
            	limit(state.profileReviewsLimit + 1)
        	);




        	try {
            	const snap = await getDocs(q);
            	if(!append) list.innerHTML = '';




            	if(snap.empty) {
                	list.innerHTML = '<p class="text-[10px] text-slate-400 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯</p>';
                	btnMore.classList.add('hidden');
                	btnLess.classList.add('hidden');
                	return;
            	}




            	let count = 0;
            	snap.forEach(doc => {
                	if(count < state.profileReviewsLimit) {
                    	const r = doc.data();
                    	const stars = "â˜…".repeat(r.rating);
                    	const img = r.reviewerImage ? `<img src="${r.reviewerImage}" class="w-full h-full object-cover">` : `<i data-lucide="user" class="w-4 h-4 text-slate-400"></i>`;




                    	list.innerHTML += `
                        	<div class="bg-slate-50 dark:bg-slate-800/50 p-2 rounded-lg text-xs">
                            	<div class="flex justify-between mb-1">
                                	<div class="flex items-center gap-2">
                                     	<div class="w-6 h-6 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center overflow-hidden">${img}</div>
                                     	<span class="font-bold">${r.reviewerName || 'Ù…Ø³ØªØ®Ø¯Ù…'}</span>
                                	</div>
                                	<span class="text-yellow-400">${stars}</span>
                            	</div>
                            	<p class="text-slate-600 dark:text-slate-300 pr-8">${r.text}</p>
                            	<span class="text-[8px] text-slate-300 block mt-1">${formatDate(r.timestamp)}</span>
                        	</div>
                    	`;
                	}
                	count++;
            	});




            	if(snap.size > state.profileReviewsLimit) btnMore.classList.remove('hidden');
            	else btnMore.classList.add('hidden');




            	if(state.profileReviewsLimit > 3) btnLess.classList.remove('hidden');
            	else btnLess.classList.add('hidden');




        	} catch(e) {
            	console.log("Index might be missing for profile reviews", e);
            	list.innerHTML = '<p class="text-[10px] text-slate-400 text-center">Ø¬Ø§Ø±ÙŠ ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª...</p>';
        	}
    	}




    	// Req 7: Smart Order Logic
    	window.toggleOrderModal = () => {
        	if(toggleModal('order-modal')) {
            	if(!state.currentItem) return;




            	document.getElementById('ord-img').src = Array.isArray(state.currentItem.images) ? state.currentItem.images[0] : state.currentItem.image;
            	document.getElementById('ord-title').innerText = state.currentItem.title;
            	document.getElementById('ord-price').innerText = Number(state.currentItem.price).toLocaleString() + ' Ø¬.Ù…';




            	// Pre-fill user data
            	if(state.userData) {
                	document.getElementById('ord-phone').value = state.userData.phone || '';
                	document.getElementById('ord-gov').value = state.userData.governorate || '';
                	updateOrderCities();
                	document.getElementById('ord-city').value = state.userData.city || '';
                	document.getElementById('ord-address').value = state.userData.address || '';
            	}




            	state.orderItems = [];
            	document.getElementById('order-items-container').innerHTML = '';
            	addOrderItem(); // Add first item
        	}
    	}




    	window.addOrderItem = () => {
        	const index = state.orderItems.length;
        	state.orderItems.push({ qty: 1, size: '', color: '' });




        	const container = document.getElementById('order-items-container');
        	const itemDiv = document.createElement('div');
        	itemDiv.className = "bg-slate-50 dark:bg-slate-800 p-2 rounded-lg border border-slate-200 dark:border-slate-600 relative";
        	itemDiv.id = `ord-item-${index}`;




        	let sizeOptions = '';
        	if(state.currentItem.size && Array.isArray(state.currentItem.size)) {
            	sizeOptions = `<select onchange="updateOrderItem(${index}, 'size', this.value)" class="form-input text-xs h-8 w-full mb-1"><option value="">Ø§Ù„Ù…Ù‚Ø§Ø³</option>${state.currentItem.size.map(s => `<option value="${s}">${s}</option>`).join('')}</select>`;
        	}




        	let colorOptions = '';
        	if(state.currentItem.color && Array.isArray(state.currentItem.color)) {
            	colorOptions = `<select onchange="updateOrderItem(${index}, 'color', this.value)" class="form-input text-xs h-8 w-full mb-1"><option value="">Ø§Ù„Ù„ÙˆÙ†</option>${state.currentItem.color.map(c => `<option value="${c}">${c}</option>`).join('')}</select>`;
        	}




        	itemDiv.innerHTML = `
            	<div class="flex justify-between items-center mb-2">
                	<span class="text-xs font-bold text-primary">Ø§Ù„Ù…Ù†ØªØ¬ #${index + 1}</span>
                	${index > 0 ? `<button onclick="removeOrderItem(${index})" class="text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
            	</div>
            	<div class="grid grid-cols-3 gap-2">
                	<input type="number" value="" min="1" onchange="updateOrderItem(${index}, 'qty', this.value)" class="form-input text-xs h-8 text-center" placeholder="Ø§Ù„Ø¹Ø¯Ø¯">
                	<div class="col-span-2 flex gap-1">
                    	${sizeOptions}
                    	${colorOptions}
                	</div>
            	</div>
        	`;
        	container.appendChild(itemDiv);
        	calculateOrderTotal();
        	lucide.createIcons();
    	}




    	window.updateOrderItem = (index, field, value) => {
        	if(state.orderItems[index]) {
            	state.orderItems[index][field] = field === 'qty' ? Number(value) : value;
            	calculateOrderTotal();
        	}
    	}




    	window.removeOrderItem = (index) => {
        	document.getElementById(`ord-item-${index}`).classList.add('hidden');
        	state.orderItems[index].qty = 0;
        	calculateOrderTotal();
    	}




    	window.calculateOrderTotal = () => {
        	let totalQty = 0;
        	state.orderItems.forEach(i => totalQty += i.qty);
        	const total = totalQty * Number(state.currentItem.price);
        	document.getElementById('ord-total').innerText = total.toLocaleString() + ' Ø¬.Ù…';
    	}


           	window.confirmOrder = () => {
        	const phone = document.getElementById('ord-phone').value;
        	const gov = document.getElementById('ord-gov').value;
        	const city = document.getElementById('ord-city').value;
        	const address = document.getElementById('ord-address').value;


        	if(!phone || !gov || !city || !address) return showToast("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "e");


        	// Ø¬Ù„Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ø§Ù„Ø®Ø§Ù… (Ù‚Ø¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 0 Ø£Ùˆ 20 Ø£Ùˆ Ù…Ø³Ø§ÙØ§Øª)
        	const sellerPhoneRaw = state.currentItem.phone || (state.currentAuthor ? state.currentAuthor.phone : '');
        	if(!sellerPhoneRaw) return showToast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù„Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¨Ø§Ø¦Ø¹", "e");
            
            // ğŸ’¡ Ø§Ù„ØªØµØ­ÙŠØ­ ÙŠØ¨Ø¯Ø£ Ù…Ù† Ù‡Ù†Ø§: ØªÙ†Ù‚ÙŠØ© Ø§Ù„Ø±Ù‚Ù…
            // 1. Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø­Ø±ÙˆÙ Ø£Ùˆ Ù…Ø³Ø§ÙØ§Øª (ØªØ¨Ù‚Ù‰ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·)
            let finalPhone = sellerPhoneRaw.replace(/\D/g, ''); 

            // 2. Ø¥Ø²Ø§Ù„Ø© Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø© (20) Ø£Ùˆ Ø§Ù„ØµÙØ± Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ (0) Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø±Ù‚Ù…
            if (finalPhone.startsWith('20')) {
                finalPhone = finalPhone.substring(2);
            } else if (finalPhone.startsWith('0')) {
                finalPhone = finalPhone.substring(1);
            }

            // 3. ØªØ­Ù‚Ù‚ Ø£Ø®ÙŠØ± Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡
            if (finalPhone.length < 9) return showToast("Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹ ØºÙŠØ± ØµØ­ÙŠØ­ Ù„Ù„ØªÙˆØ§ØµÙ„", "e");
            
            // ğŸ’¡ Ø§Ù„ØªØµØ­ÙŠØ­ ÙŠÙ†ØªÙ‡ÙŠ Ù‡Ù†Ø§
            
        	// 1. ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
        	const now = new Date();
        	const dateStr = now.toLocaleDateString('ar-EG');
        	const timeStr = now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });


        	// 2. ØªØ¬Ù‡ÙŠØ² Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†ØªØ¬
        	const productUrl = `${window.location.origin}${window.location.pathname}?product_id=${state.currentItem.id}`;


        	// --- Ø¨Ù†Ø§Ø¡ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ---
        	let msg = `Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø³ÙˆÙ‚ ÙˆÙŠØ§ÙƒğŸ ğŸ“¥\n`;
        	msg += `ğŸ“… ÙˆÙ‚Øª Ø§Ù„Ø·Ù„Ø¨: ${dateStr} - ${timeStr}\n\n`;


        	msg += `ğŸ“¦ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬:\n`;
        	msg += `*Ø§Ù„Ø§Ø³Ù…:* ${state.currentItem.title}\n`;
        	msg += `*Ø§Ù„Ù‚Ø³Ù…:* ${state.currentItem.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n`;
        	msg += `*Ø³Ø¹Ø± Ø§Ù„Ù‚Ø·Ø¹Ø©:* ${Number(state.currentItem.price).toLocaleString()} Ø¬.Ù…\n\n`;


        	msg += `ğŸ“ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨:\n`;
        	
        	let totalQty = 0;
        	state.orderItems.forEach((item, idx) => {
            	if(item.qty > 0) {
                	// ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø³Ø·Ø± Ø§Ù„ÙˆØ§Ø­Ø¯ Ù„ÙƒÙ„ Ø®ÙŠØ§Ø±
                	msg += `Ø§Ø®ØªÙŠØ§Ø± #${idx+1}:  	(Ø¹Ø¯Ø¯ ${item.qty})`;
                	
                	if(item.size) msg += ` | Ù…Ù‚Ø§Ø³: ${item.size}`;
                	if(item.color) msg += ` | Ù„ÙˆÙ†: ${item.color}`;
                	
                	msg += `\n`;
                	totalQty += item.qty;
            	}
        	});


        	if(totalQty === 0) return showToast("ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ù‚Ø·Ø¹Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„", "e");


        	msg += `\nØ§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ${(totalQty * state.currentItem.price).toLocaleString()} Ø¬.Ù…\n`;
        	msg += `----------------\n`;
        	
        	msg += `ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„:\n`;
        	msg += `Ø§Ù„Ø§Ø³Ù…: ${state.userData ? state.userData.name : 'Ø¶ÙŠÙ'}\n`;
        	msg += `Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ${phone}\n`;
        	msg += `Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${gov} - ${city} - ${address}\n\n`;


        	// ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        	msg += `ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†ØªØ¬: ${productUrl}`;


        	// ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨
            // Ù†Ø³ØªØ®Ø¯Ù… finalPhone Ø§Ù„Ù†Ø¸ÙŠÙ ÙˆØ§Ù„Ù‚ÙŠØ§Ø³ÙŠØŒ ÙˆÙ†Ø¶ÙŠÙ Ø§Ù„Ù€ 20 Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·
        	const url = `https://wa.me/20${finalPhone}?text=${encodeURIComponent(msg)}`;
        	window.open(url, '_blank');
        	toggleOrderModal();
    	}


lucide.createIcons();
	</script>
</body>
</html>

