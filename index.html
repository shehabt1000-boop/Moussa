<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>السوق وياك | المتجر الشامل</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="السوق وياك">
    <link id="manifest-link" rel="manifest">

    <!-- Preload Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { 
                extend: { 
                    colors: { 
                        navy: '#0f172a', 
                        darkbg: '#1e293b', 
                        primary: '#10b981', 
                        secondary: '#3b82f6' 
                    },
                    fontFamily: {
                        cairo: ['Cairo', 'sans-serif']
                    }
                } 
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { 
            font-family: 'Cairo', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 80px;
            overscroll-behavior-y: none;
            background-color: #f8fafc;
        }
        .dark body { background-color: #0f172a; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .select-none { user-select: none; }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #e2e8f0; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #0f172a; border-radius: 10px; }
        .dark .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .dark .custom-scroll::-webkit-scrollbar-thumb { background: #94a3b8; }

        @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-pop { animation: popIn 0.15s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        .mobile-full-modal { position: fixed; inset: 0; z-index: 80; background-color: white; display: flex; flex-direction: column; height: 100dvh; }
        .dark .mobile-full-modal { background-color: #0f172a; }
        
        /* Z-Index Layers */
        .z-modal { z-index: 90; }
        .z-toast { z-index: 100; }
        .z-splash { z-index: 200; }

        @media (min-width: 768px) { 
            .mobile-full-modal { position: relative; inset: auto; width: 100%; max-width: 28rem; height: 600px; max-height: 85vh; border-radius: 1.5rem; overflow: hidden; } 
            .modal-overlay { position: fixed; inset: 0; z-index: 80; background-color: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; padding: 1rem; } 
        }

        /* Modern Toast */
        @keyframes slideInDown { from { transform: translate(-50%, -100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .toast { 
            animation: slideInDown 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; 
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 100;
            width: max-content; max-width: 90vw; 
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(8px);
        }
        .toast.hiding { animation: fadeOut 0.3s ease-in forwards; }

        .form-input { 
            width: 100%; background-color: #ffffff; border: 1px solid #000000 !important; border-radius: 0.5rem; 
            padding: 0 0.5rem; height: 2.25rem; display: flex; align-items: center; font-size: 0.75rem; 
            font-weight: 600; color: #1e293b; outline: none; transition: all 0.2s; line-height: normal; 
        }
        select.form-input { padding-left: 1.5rem; }
        textarea.form-input { height: auto; padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .form-input:focus { border-color: #10b981 !important; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1); }
        .dark .form-input { background-color: #1e293b; border-color: #94a3b8 !important; color: white; }
        .dark .form-input:focus { border-color: #10b981 !important; }
        
        .chip-checkbox:checked + div { background-color: #10b981; color: white; border-color: #10b981; }
        .smart-option:checked + div { background-color: #0f172a; color: white; border-color: #0f172a; }
        .dark .smart-option:checked + div { background-color: #10b981; border-color: #10b981; }

        .star-rating input { display: none; }
        .star-rating label { cursor: pointer; color: #cbd5e1; transition: color 0.2s; }
        .star-rating input:checked ~ label, .star-rating label:hover, .star-rating label:hover ~ label { color: #fbbf24; }
        .star-rating { display: flex; flex-direction: row-reverse; justify-content: flex-end; }

        @keyframes slideUp { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .install-banner { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        /* Splash Screen */
        #splash-screen { position: fixed; inset: 0; z-index: 200; background-color: #0f172a; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s ease-out; }
        #splash-screen.fade-out { opacity: 0; pointer-events: none; }
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid #10b981; width: 24px; height: 24px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Floating Support Button */
        .floating-support {
            position: fixed; left: 10px; bottom: 100px; z-index: 60;
            display: flex; flex-direction: column; align-items: center; gap: 2px;
        }
        .floating-btn {
            background: linear-gradient(135deg, #0f172a, #1e293b);
            color: white; p: 0.75rem; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 2px solid #10b981; transition: transform 0.2s;
        }
        .floating-btn:active { transform: scale(0.9); }
        .support-label { font-size: 0.5rem; color: #ef4444; font-weight: 900; background: white; padding: 1px 4px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* Notification Badge */
        .notif-dot { position: absolute; top: 0; right: 0; width: 8px; height: 8px; background-color: #ef4444; border-radius: 50%; border: 1px solid white; }
        
        /* Unread Message Card */
        .chat-card.unread { border: 1px solid #3b82f6; background-color: rgba(59, 130, 246, 0.05); }
        .chat-card.unread .last-msg { color: #3b82f6; font-weight: 800; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-navy dark:text-slate-100 select-none">

    <!-- Splash Screen (No Delay) -->
    <div id="splash-screen">
        <div class="bg-white/10 p-4 rounded-full shadow-2xl mb-4 backdrop-blur-sm">
            <i data-lucide="shopping-bag" class="w-16 h-16 text-primary"></i>
        </div>
        <h1 class="text-3xl font-black text-white mb-4 tracking-tight">السوق <span class="text-primary">وياك</span></h1>
        <div class="spinner"></div>
    </div>

    <!-- Floating Support Button -->
    <div class="floating-support">
        <button onclick="toggleSupportChat()" class="floating-btn">
            <i data-lucide="headset" class="w-6 h-6"></i>
        </button>
        <span class="support-label">الدعم الفني</span>
    </div>

    <!-- LOGIN VIEW -->
    <div id="login-view" class="hidden fixed inset-0 z-[150] bg-[#f8fafc] dark:bg-[#0f172a] flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white dark:bg-darkbg p-5 rounded-3xl shadow-2xl border border-slate-100 dark:border-slate-700 flex flex-col max-h-[90vh]">
            <div class="flex flex-col items-center gap-1 mb-4 shrink-0">
                <div class="bg-navy dark:bg-primary text-white p-2.5 rounded-2xl shadow-lg -rotate-3">
                    <i data-lucide="shopping-bag" class="w-6 h-6"></i>
                </div>
                <h1 class="font-black text-xl text-navy dark:text-white mt-2">السوق <span class="text-primary">وياك</span></h1>
            </div>

            <div class="bg-slate-100 dark:bg-slate-800 p-1 rounded-xl flex mb-3 border border-slate-200 dark:border-slate-700 shrink-0">
                <button onclick="setAuthType('login')" id="btn-type-login" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-navy dark:bg-primary text-white shadow-md">تسجيل دخول</button>
                <button onclick="setAuthType('signup')" id="btn-type-signup" class="flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:text-navy dark:hover:text-white">إنشاء حساب</button>
            </div>

            <div class="bg-slate-100 dark:bg-slate-800 p-1 rounded-xl flex mb-4 border border-slate-200 dark:border-slate-700 shrink-0">
                <button onclick="setAuthRole('customer')" id="btn-role-customer" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-navy text-white shadow-md"><div class="flex items-center justify-center gap-2"><i data-lucide="user" class="w-3 h-3"></i> عميل</div></button>
                <button onclick="setAuthRole('marketer')" id="btn-role-marketer" class="flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:bg-white dark:hover:bg-slate-700"><div class="flex items-center justify-center gap-2"><i data-lucide="store" class="w-3 h-3"></i> مقدم خدمة</div></button>
            </div>

            <div class="login-scroll no-scrollbar space-y-3 flex-1 overflow-y-auto p-1">
                <div id="auth-image-field" class="hidden flex-col items-center gap-2 transition-all duration-300">
                    <div class="relative group cursor-pointer">
                        <input type="file" id="auth-img-input" accept="image/*" onchange="handleAuthImage(this)" class="absolute inset-0 opacity-0 z-10 cursor-pointer">
                        <div class="w-20 h-20 rounded-full bg-slate-50 dark:bg-slate-800 border-2 border-dashed border-primary/50 flex items-center justify-center overflow-hidden relative hover:bg-primary/5 transition">
                            <img id="auth-img-preview" src="" class="w-full h-full object-cover hidden">
                            <div id="auth-img-placeholder" class="flex flex-col items-center text-slate-400"><i data-lucide="camera" class="w-6 h-6 mb-1"></i><span class="text-[9px] font-bold">صورة</span></div>
                        </div>
                        <div class="absolute bottom-0 right-0 bg-navy dark:bg-primary text-white p-1 rounded-full shadow-sm pointer-events-none"><i data-lucide="plus" class="w-3 h-3"></i></div>
                    </div>
                </div>

                <div><label class="form-label">اسم المستخدم (إنجليزي)</label><div class="relative"><input id="auth-username" type="text" class="form-input text-left" placeholder="username" style="direction: ltr;"><i data-lucide="at-sign" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i></div></div>
                <div><label class="form-label">كلمة المرور</label><div class="relative"><input id="auth-pass" type="password" class="form-input" placeholder="******"><i data-lucide="lock" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i></div></div>

                <div id="signup-fields" class="hidden space-y-3 border-t border-slate-100 dark:border-slate-700 pt-3 mt-2">
                    <div><label class="form-label">الاسم الكامل (عربي)</label><input id="auth-name-ar" type="text" class="form-input" placeholder="مثال: أحمد محمد"></div>
                    <div><label class="form-label">رقم الهاتف</label><input id="auth-phone" type="tel" class="form-input" placeholder="01xxxxxxxxx"></div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="form-label">المحافظة</label><select id="auth-gov" onchange="updateCities()" class="form-input text-xs"></select></div>
                        <div><label class="form-label">المركز/المدينة</label><select id="auth-city" class="form-input text-xs"><option value="">اختر المحافظة</option></select></div>
                    </div>
                    <div><label class="form-label">العنوان بالتفصيل</label><input id="auth-address" type="text" class="form-input" placeholder="الشارع، رقم المنزل..."></div>
                </div>
            </div>

            <div class="mt-4 pt-3 border-t border-slate-100 dark:border-slate-700 shrink-0">
                <button onclick="processAuth()" id="btn-auth-action" class="w-full bg-navy dark:bg-primary text-white py-3 rounded-xl font-bold shadow-lg shadow-navy/20 hover:opacity-90 transition-all active:scale-95 flex justify-center items-center gap-2 text-sm"><span>دخول للحساب</span> <i data-lucide="arrow-left" class="w-4 h-4"></i></button>
                <div id="auth-error" class="text-red-600 dark:text-red-400 text-[10px] font-bold text-center hidden bg-red-50 dark:bg-red-900/20 p-2 rounded-lg border border-red-200 dark:border-red-800 mt-2 break-words" dir="ltr"></div>
            </div>
        </div>
    </div>

    <!-- APP CONTENT -->
    <div id="app-content" class="hidden">
        <div id="toast-container" class="fixed top-4 left-0 right-0 z-[120] flex flex-col items-center gap-2 pointer-events-none px-4"></div>

        <!-- Header -->
        <header class="fixed top-0 w-full z-[60] bg-white/95 dark:bg-navy/95 border-b border-slate-200 dark:border-slate-700 flex flex-col justify-center px-4 shadow-sm backdrop-blur-md h-14">
            <div class="flex items-center justify-between w-full">
                <div class="flex items-center gap-2" id="logo-trigger">
                    <div class="bg-navy dark:bg-primary text-white p-1.5 rounded-lg"><i data-lucide="shopping-bag" class="w-5 h-5"></i></div>
                    <div class="flex flex-col leading-none">
                        <h1 class="font-bold text-sm">السوق <span class="text-primary">وياك</span></h1>
                        <div id="welcome-text" class="hidden text-[10px] font-bold mt-0.5">
                             <span class="text-navy dark:text-white">أهلاً: </span><span id="header-username" class="text-primary"></span>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-2 items-center">
                    <!-- Notification Bell -->
                    <div class="relative">
                        <button onclick="toggleNotifications()" class="p-2 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-white hover:bg-slate-200 transition"><i data-lucide="bell" class="w-5 h-5"></i></button>
                        <div id="notif-badge" class="hidden absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white dark:border-navy"></div>
                        <!-- Dropdown -->
                        <div id="notif-dropdown" class="hidden absolute top-12 left-0 w-64 bg-white dark:bg-darkbg rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 p-2 max-h-60 overflow-y-auto z-50">
                            <h4 class="text-xs font-bold mb-2 px-2">الإشعارات</h4>
                            <div id="notif-list" class="space-y-1"></div>
                        </div>
                    </div>

                    <button onclick="toggleProfile(null)" class="p-2 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-white hover:bg-slate-200 transition"><i data-lucide="user" class="w-5 h-5"></i></button>
                    <button onclick="toggleDarkMode()" class="p-2 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-yellow-400 hover:bg-slate-200 transition"><i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i><i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i></button>
                    <button onclick="toggleAdminPanel()" id="btn-admin-top" class="hidden bg-slate-100 dark:bg-slate-800 p-2 rounded-full text-slate-600 dark:text-white"><i data-lucide="shield" class="w-5 h-5"></i></button>
                    <button onclick="logout()" class="p-2 rounded-full bg-slate-100 dark:bg-slate-800 text-red-600 hover:bg-red-100 transition"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                </div>
            </div>
        </header>

        <main class="pt-16 container mx-auto px-4 max-w-6xl min-h-screen">
            <div id="view-header" class="hidden flex items-center gap-2 pb-2">
                <button onclick="switchToHomeView()" class="bg-white dark:bg-slate-800 p-2 rounded-full border border-slate-200 dark:border-slate-700 shadow-sm"><i data-lucide="arrow-right" class="w-4 h-4 text-slate-600 dark:text-white"></i></button>
                <h2 id="view-title" class="text-lg font-bold text-slate-800 dark:text-white pt-0.5"></h2>
            </div>

            <div id="search-container" class="sticky top-14 z-[50] bg-slate-50/95 dark:bg-navy/95 backdrop-blur-lg pt-2 pb-2 -mx-4 px-4 transition-all">
                <div class="relative max-w-3xl mx-auto flex gap-2 items-center">
                    <div class="relative flex-1">
                        <input type="text" id="search-input" oninput="handleSearch()" placeholder="ابحث..." class="w-full form-input pr-10 pl-24 h-10 shadow-sm text-sm">
                        <i data-lucide="search" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                        
                        <div class="absolute left-2 top-1/2 -translate-y-1/2 flex items-center gap-1 z-10">
                            <button id="btn-filter-toggle" onclick="toggleFilterPanel()" class="hidden text-secondary dark:text-blue-400 p-1.5 hover:scale-110 transition">
                                <i data-lucide="sliders-horizontal" class="w-4 h-4"></i>
                            </button>
                            <button onclick="toggleFavView()" class="relative text-red-500 p-1.5 hover:scale-110 transition">
                                <i data-lucide="heart" class="w-4 h-4"></i>
                                <span id="fav-count" class="absolute top-0 right-0 w-2 h-2 bg-red-600 rounded-full border border-white dark:border-darkbg hidden"></span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="filter-panel" class="hidden mt-2 bg-white dark:bg-darkbg p-3 rounded-xl border border-slate-200 dark:border-slate-700 shadow-xl animate-pop relative z-50">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-xs">تصفية النتائج</span>
                        <button onclick="resetFilters()" class="text-xs text-red-500 font-bold underline cursor-pointer p-1">إعادة تعيين</button>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <select id="filter-gov" onchange="applyFilters()" class="form-input text-xs h-8"><option value="">كل المحافظات</option></select>
                        <select id="filter-price" onchange="applyFilters()" class="form-input text-xs h-8">
                            <option value="">كل الأسعار</option>
                            <option value="low">الأقل سعراً</option>
                            <option value="high">الأعلى سعراً</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="categories-container" class="hidden justify-start gap-2 overflow-x-auto pt-2 pb-3 no-scrollbar"></div>

            <div id="grid-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 pb-10 mt-2"></div>

            <div id="loader" class="text-center py-20"><div class="w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-2"></div><p class="text-xs text-slate-400">جاري التحميل...</p></div>
            <div id="empty-state" class="hidden text-center py-20 opacity-60 flex-col items-center"><div class="bg-slate-200 dark:bg-slate-800 p-4 rounded-full inline-block mb-2"><i data-lucide="shirt" class="w-8 h-8 text-slate-400"></i></div><p class="text-slate-500 dark:text-slate-400 font-bold text-sm">لا توجد نتائج</p><button onclick="resetFilters()" class="mt-2 text-primary text-xs font-bold underline">إعادة تعيين</button></div>
        </main>

        <!-- NAV BAR -->
        <nav class="fixed bottom-4 left-1/2 -translate-x-1/2 z-[70] bg-white/90 dark:bg-slate-800/90 border border-slate-200 dark:border-slate-600 px-6 py-2 rounded-full flex items-center gap-8 shadow-lg transform transition-all hover:scale-105">
            <button onclick="switchToHomeView()" class="flex flex-col items-center gap-1 text-slate-500 dark:text-slate-400 hover:text-navy dark:hover:text-white transition group"><i data-lucide="home" class="w-6 h-6 group-hover:scale-110 transition"></i></button>
            <button id="nav-add-btn" onclick="toggleAddModal()" class="w-14 h-14 bg-navy dark:bg-primary text-white rounded-full flex items-center justify-center shadow-lg shadow-slate-900/20 transform -translate-y-6 border-4 border-slate-50 dark:border-navy hover:scale-110 transition active:scale-90"><i data-lucide="plus" class="w-7 h-7"></i></button>
            <!-- New Chat Button -->
            <button onclick="toggleChatList()" class="flex flex-col items-center gap-1 text-slate-500 dark:text-slate-400 hover:text-navy dark:hover:text-white transition group relative">
                <div id="msg-badge" class="hidden absolute top-0 right-0 w-2.5 h-2.5 bg-blue-500 rounded-full border border-white dark:border-slate-800"></div>
                <i data-lucide="message-circle" class="w-6 h-6 group-hover:scale-110 transition"></i>
            </button>
        </nav>

        <!-- PWA Install Banner (Top) -->
        <div id="install-banner" class="hidden fixed top-0 left-0 right-0 bg-navy dark:bg-white dark:text-navy text-white p-3 shadow-2xl z-[110] flex items-center justify-between install-banner border-b dark:border-slate-200">
            <div class="flex items-center gap-3">
                <div class="bg-white/10 dark:bg-navy/10 p-2 rounded-lg"><i data-lucide="download" class="w-5 h-5"></i></div>
                <div>
                    <h4 class="font-bold text-xs">تثبيت التطبيق</h4>
                    <p class="text-[10px] opacity-80">تجربة أسرع وأسهل</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="installPWA()" class="bg-primary text-white px-3 py-1.5 rounded-lg font-bold text-xs shadow-lg">تثبيت</button>
                <button onclick="closeInstall()" class="text-white dark:text-navy p-1"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
        </div>
    </div>

    <!-- Chat List Modal (New) -->
    <div id="chat-list-modal" class="hidden modal-overlay">
        <div class="mobile-full-modal animate-pop border border-slate-200 dark:border-slate-700">
            <div class="bg-navy dark:bg-primary p-4 text-white flex justify-between items-center shrink-0">
                <h3 class="font-bold text-base">الرسائل</h3>
                <button onclick="toggleChatList()" class="hover:bg-white/20 p-1 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="chat-list-container" class="flex-1 overflow-y-auto p-3 space-y-2 bg-white dark:bg-darkbg custom-scroll">
                <!-- Chat items will be here -->
            </div>
        </div>
    </div>

    <!-- Private Chat Modal (New) -->
    <div id="private-chat-modal" class="hidden modal-overlay">
        <div class="mobile-full-modal animate-pop border border-slate-200 dark:border-slate-700">
            <div class="bg-navy dark:bg-primary p-2 text-white flex justify-between items-center shrink-0">
                <div class="flex items-center gap-3 cursor-pointer" onclick="toggleProfile(state.activeChatUser.uid)">
                    <div class="relative">
                        <img id="chat-header-img" src="" class="w-10 h-10 rounded-full object-cover bg-white/10">
                        <div id="chat-header-status" class="absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-navy"></div>
                    </div>
                    <div>
                        <h4 id="chat-header-name" class="font-bold text-sm">...</h4>
                        <span id="chat-header-seen" class="text-[10px] opacity-80">...</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleChatOptions()" class="hover:bg-white/20 p-1.5 rounded-full"><i data-lucide="more-vertical" class="w-5 h-5"></i></button>
                    <button onclick="closePrivateChat()" class="hover:bg-white/20 p-1.5 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
            </div>
            
            <!-- Chat Options Dropdown -->
            <div id="chat-options-menu" class="hidden absolute top-14 left-4 bg-white dark:bg-slate-800 shadow-xl rounded-xl border border-slate-200 dark:border-slate-600 z-50 w-40 overflow-hidden">
                <button onclick="deleteChat()" class="w-full text-right px-4 py-3 text-xs font-bold hover:bg-slate-50 dark:hover:bg-slate-700 text-red-500 flex items-center gap-2"><i data-lucide="trash-2" class="w-4 h-4"></i> حذف المحادثة</button>
                <button onclick="blockUser()" class="w-full text-right px-4 py-3 text-xs font-bold hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-white flex items-center gap-2"><i data-lucide="slash" class="w-4 h-4"></i> حظر المستخدم</button>
                <button onclick="rateUserFromChat()" class="w-full text-right px-4 py-3 text-xs font-bold hover:bg-slate-50 dark:hover:bg-slate-700 text-yellow-500 flex items-center gap-2"><i data-lucide="star" class="w-4 h-4"></i> تقييم المستخدم</button>
            </div>

            <div id="private-chat-box" class="flex-1 bg-slate-100 dark:bg-slate-900 p-3 overflow-y-auto space-y-2 text-xs"></div>
            
            <div class="p-2 bg-white dark:bg-slate-800 border-t dark:border-slate-700 flex items-center gap-2 shrink-0 pb-safe">
                <input id="private-chat-input" type="text" class="flex-1 bg-slate-100 dark:bg-slate-700 border-0 rounded-full px-4 py-3 text-sm outline-none dark:text-white font-bold" placeholder="اكتب رسالة...">
                <button onclick="sendPrivateMessage()" class="w-10 h-10 bg-navy dark:bg-primary rounded-full text-white flex items-center justify-center shadow hover:scale-105 transition"><i data-lucide="send" class="w-5 h-5"></i></button>
            </div>
        </div>
    </div>

    <!-- Support Chat Modal (Floating) -->
    <div id="support-chat-modal" class="hidden modal-overlay">
        <div class="mobile-full-modal animate-pop border border-slate-200 dark:border-slate-700">
            <div class="bg-navy dark:bg-primary p-3 text-white flex justify-between items-center shrink-0">
                <div class="flex items-center gap-2">
                    <div class="bg-white/10 p-1.5 rounded-full"><i data-lucide="bot" class="w-5 h-5 text-yellow-400"></i></div>
                    <div><h4 class="font-bold text-xs">الدعم الفني</h4></div>
                </div>
                <div class="flex items-center gap-2">
                    <a href="https://wa.me/201206244875" target="_blank" class="bg-[#25D366] px-2 py-1 rounded-full flex items-center gap-1 text-[10px] font-bold hover:opacity-90 transition">
                        <i data-lucide="message-circle" class="w-3 h-3"></i> 01206244875
                    </a>
                    <button onclick="toggleSupportChat()" class="hover:bg-white/20 p-1 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
            </div>
            <div id="support-chat-box" class="flex-1 bg-slate-100 dark:bg-slate-900 p-3 overflow-y-auto space-y-2 text-xs"></div>
            <div class="p-2 bg-white dark:bg-slate-800 border-t dark:border-slate-700 flex items-center gap-2 shrink-0 pb-safe"><input id="support-chat-msg" type="text" class="flex-1 bg-slate-100 dark:bg-slate-700 border-0 rounded-full px-4 py-3 text-sm outline-none dark:text-white font-bold" placeholder="اكتب..."><button onclick="sendSupportMsg()" class="w-8 h-8 bg-navy dark:bg-primary rounded-full text-white flex items-center justify-center shadow"><i data-lucide="send" class="w-4 h-4"></i></button></div>
        </div>
    </div>

    <!-- Profile Modal (Same as before but updated Z-Index) -->
    <div id="profile-modal" class="hidden modal-overlay">
        <div class="mobile-full-modal animate-pop border border-slate-200 dark:border-slate-700">
            <div class="bg-navy dark:bg-primary p-3 text-white flex justify-between items-center shrink-0">
                <h3 class="font-bold text-sm">الملف الشخصي</h3>
                <button onclick="toggleProfile()" class="bg-red-500 hover:bg-red-600 p-1.5 rounded-full text-white shadow-sm"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 bg-white dark:bg-darkbg custom-scroll">
                <!-- View Mode -->
                <div id="prof-view-mode">
                    <div class="flex flex-col items-center gap-3 mb-6">
                        <div id="prof-img-container" class="w-24 h-24 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center overflow-hidden border-4 border-primary shadow-lg">
                            <i data-lucide="user" class="w-10 h-10 text-slate-400"></i>
                        </div>
                        <div class="text-center w-full">
                            <div class="flex items-center justify-center gap-2">
                                <h2 id="prof-name" class="font-black text-xl text-navy dark:text-white">...</h2>
                                <button id="global-edit-btn" onclick="toggleEditMode()" class="hidden flex items-center gap-1 text-primary hover:text-primary/80 bg-primary/10 px-2 py-0.5 rounded-full transition">
                                    <i data-lucide="pen-tool" class="w-3 h-3"></i> <span class="text-[10px] font-bold">تعديل</span>
                                </button>
                            </div>
                            <div id="prof-rating-display" class="flex justify-center items-center gap-1 mt-1 text-yellow-400 text-xs font-bold hidden">
                                <span>★</span> <span id="prof-rating-val">0.0</span>
                            </div>
                            <span id="prof-role" class="text-xs bg-slate-100 dark:bg-slate-700 px-3 py-1 rounded-full text-slate-500 dark:text-slate-300 font-bold mt-1 inline-block">...</span>
                            <p id="prof-joined" class="text-[10px] text-slate-400 mt-1 text-black dark:text-white font-bold"></p>
                        </div>
                    </div>

                    <div class="space-y-3 mb-6">
                        <div class="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border border-slate-100 dark:border-slate-700">
                            <label class="text-[10px] font-bold text-slate-400 mb-1 block">رقم الهاتف</label>
                            <div class="flex items-center gap-2 font-bold text-sm text-navy dark:text-white">
                                <i data-lucide="phone" class="w-4 h-4 text-primary"></i>
                                <span id="prof-phone">...</span>
                            </div>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border border-slate-100 dark:border-slate-700">
                            <label class="text-[10px] font-bold text-slate-400 mb-1 block">العنوان بالتفصيل</label>
                            <div class="flex items-center gap-2 font-bold text-sm text-navy dark:text-white">
                                <i data-lucide="map-pin" class="w-4 h-4 text-primary"></i>
                                <span id="prof-address">...</span>
                            </div>
                        </div>
                        
                        <div id="prof-rate-user-section" class="hidden bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border border-slate-100 dark:border-slate-700 mt-2">
                            <label class="text-[10px] font-bold text-slate-400 mb-2 block">قيم هذا المستخدم</label>
                            <div class="flex flex-col gap-2">
                                <div class="star-rating text-lg self-end">
                                    <input type="radio" id="u-star5" name="u-rating" value="5" onclick="setUserRating(5)"><label for="u-star5">★</label>
                                    <input type="radio" id="u-star4" name="u-rating" value="4" onclick="setUserRating(4)"><label for="u-star4">★</label>
                                    <input type="radio" id="u-star3" name="u-rating" value="3" onclick="setUserRating(3)"><label for="u-star3">★</label>
                                    <input type="radio" id="u-star2" name="u-rating" value="2" onclick="setUserRating(2)"><label for="u-star2">★</label>
                                    <input type="radio" id="u-star1" name="u-rating" value="1" onclick="setUserRating(1)"><label for="u-star1">★</label>
                                </div>
                                <textarea id="user-review-text" class="form-input text-xs w-full" rows="2" placeholder="اكتب تعليقك..."></textarea>
                                <button onclick="submitUserReview()" class="bg-primary text-white px-3 py-1.5 rounded-lg text-xs font-bold w-full">إرسال التقييم</button>
                            </div>
                        </div>
                    </div>

                    <div id="prof-reviews-section" class="hidden">
                        <h3 class="font-bold text-sm text-navy dark:text-white mb-3 border-b pb-2 border-slate-100 dark:border-slate-700">آراء العملاء</h3>
                        <div id="prof-reviews-list" class="space-y-3"></div>
                        <div class="flex gap-2 mt-2">
                            <button id="prof-reviews-more" onclick="loadProfileReviews(true)" class="hidden flex-1 text-center text-xs text-primary font-bold py-2 bg-slate-50 dark:bg-slate-800 rounded-lg">عرض المزيد</button>
                            <button id="prof-reviews-less" onclick="loadProfileReviews(false, true)" class="hidden flex-1 text-center text-xs text-red-500 font-bold py-2 bg-slate-50 dark:bg-slate-800 rounded-lg">عرض أقل</button>
                        </div>
                    </div>
                </div>

                <!-- Edit Mode -->
                <div id="prof-edit-mode" class="hidden space-y-3">
                    <div class="flex flex-col items-center gap-2 mb-4">
                        <div class="w-24 h-24 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center overflow-hidden border-4 border-primary shadow-lg relative group">
                            <img id="edit-img-preview" src="" class="w-full h-full object-cover hidden">
                            <div id="edit-img-placeholder" class="flex flex-col items-center text-slate-400">
                                <i data-lucide="camera" class="w-8 h-8"></i>
                            </div>
                            <input type="file" id="edit-img-input" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleEditImage(this)">
                        </div>
                        <span class="text-[10px] text-primary font-bold">اضغط لتغيير الصورة</span>
                    </div>

                    <div><label class="form-label">الاسم الكامل</label><input id="edit-name" type="text" class="form-input"></div>
                    <div><label class="form-label">رقم الهاتف</label><input id="edit-phone" type="tel" class="form-input"></div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="form-label">المحافظة</label><select id="edit-gov" onchange="updateEditCities()" class="form-input text-xs"></select></div>
                        <div><label class="form-label">المركز/المدينة</label><select id="edit-city" class="form-input text-xs"></select></div>
                    </div>
                    <div><label class="form-label">العنوان بالتفصيل</label><input id="edit-address" type="text" class="form-input"></div>

                    <div id="prof-password-section" class="hidden bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border border-slate-100 dark:border-slate-700 mt-4">
                        <label class="text-[10px] font-bold text-slate-400 mb-2 block">تغيير كلمة المرور</label>
                        <div class="flex gap-2">
                            <input id="new-password" type="password" class="form-input text-xs" placeholder="كلمة المرور الجديدة">
                            <button onclick="changePassword()" class="bg-navy dark:bg-primary text-white px-3 py-1 rounded-lg text-xs font-bold whitespace-nowrap">تحديث</button>
                        </div>
                    </div>

                    <div class="flex gap-2 pt-4">
                        <button onclick="saveProfile()" class="flex-1 bg-primary text-white py-2 rounded-xl font-bold text-sm shadow-lg">حفظ التعديلات</button>
                        <button onclick="toggleEditMode()" class="flex-1 bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-white py-2 rounded-xl font-bold text-sm">إلغاء</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Modal -->
    <div id="order-modal" class="hidden modal-overlay">
        <div class="mobile-full-modal animate-pop border border-slate-200 dark:border-slate-700">
            <div class="bg-primary p-3 text-white flex justify-between items-center shrink-0">
                <h3 class="font-bold text-sm">طلب المنتج</h3>
                <button onclick="toggleOrderModal()" class="hover:bg-white/20 p-1 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 bg-white dark:bg-darkbg custom-scroll">
                <div class="mb-4 p-2 bg-slate-50 dark:bg-slate-800 rounded-lg flex gap-3 items-center">
                    <img id="ord-img" src="" class="w-12 h-12 rounded object-cover">
                    <div>
                        <h4 id="ord-title" class="font-bold text-xs text-navy dark:text-white"></h4>
                        <span id="ord-price" class="text-primary font-black text-sm"></span>
                    </div>
                </div>

                <div id="order-items-container" class="space-y-3"></div>

                <button onclick="addOrderItem()" class="w-full py-2 mt-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl text-slate-500 text-xs font-bold hover:border-primary hover:text-primary transition flex items-center justify-center gap-1">
                    <i data-lucide="plus" class="w-3 h-3"></i> إضافة قطعة أخرى
                </button>

                <div class="mt-6 space-y-3 border-t border-slate-100 dark:border-slate-700 pt-4">
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="form-label">المحافظة</label><select id="ord-gov" onchange="updateOrderCities()" class="form-input text-xs"></select></div>
                        <div><label class="form-label">المركز/المدينة</label><select id="ord-city" class="form-input text-xs"><option value="">اختر المحافظة</option></select></div>
                    </div>
                    <div><label class="form-label">العنوان بالتفصيل</label><input id="ord-address" type="text" class="form-input text-xs" placeholder="الشارع، رقم المنزل..."></div>
                    <div><label class="form-label">رقم الهاتف</label><input id="ord-phone" type="tel" class="form-input text-xs" placeholder="01xxxxxxxxx"></div>
                </div>
            </div>
            <div class="p-3 border-t border-slate-100 dark:border-slate-700 bg-white dark:bg-darkbg shrink-0 space-y-2">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-bold text-slate-500">الإجمالي:</span>
                    <span id="ord-total" class="text-lg font-black text-primary">0 ج.م</span>
                </div>
                <button onclick="confirmOrder('whatsapp')" class="w-full bg-[#25D366] text-white py-3 rounded-xl font-bold text-sm shadow-lg flex justify-center items-center gap-2"><i data-lucide="message-circle" class="w-4 h-4"></i> تأكيد عبر واتساب</button>
                <button onclick="confirmOrder('chat')" class="w-full bg-navy dark:bg-primary text-white py-3 rounded-xl font-bold text-sm shadow-lg flex justify-center items-center gap-2"><i data-lucide="message-square" class="w-4 h-4"></i> تأكيد عبر المحادثة</button>
            </div>
        </div>
    </div>

    <!-- Details Modal (Updated) -->
    <div id="details-modal" class="hidden modal-overlay">
        <div class="mobile-full-modal animate-pop border border-slate-200 dark:border-slate-700">
            <div class="relative h-72 bg-gray-100 dark:bg-slate-800 shrink-0 group">
                <button onclick="closeDetails()" class="absolute top-3 left-3 bg-white/80 dark:bg-black/50 text-slate-800 dark:text-white p-1.5 rounded-full z-20 shadow-sm"><i data-lucide="x" class="w-5 h-5"></i></button>
                <!-- Edit/Delete Buttons (Req 3) -->
                <div id="product-controls" class="hidden absolute top-3 left-12 z-20 flex gap-2">
                    <button onclick="editProduct()" class="bg-white/80 text-blue-600 p-1.5 rounded-full shadow"><i data-lucide="edit-3" class="w-5 h-5"></i></button>
                    <button onclick="deleteProduct()" class="bg-white/80 text-red-500 p-1.5 rounded-full shadow"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                </div>
                <div class="absolute top-3 right-3 flex gap-2 z-20">
                    <button onclick="copyDetails()" class="bg-white/80 dark:bg-black/50 text-slate-800 dark:text-white p-1.5 rounded-full shadow-sm hover:bg-white hover:text-primary transition"><i data-lucide="copy" class="w-5 h-5"></i></button>
                    <button onclick="shareListing()" class="bg-white/80 dark:bg-black/50 text-slate-800 dark:text-white p-1.5 rounded-full shadow-sm"><i data-lucide="share-2" class="w-5 h-5"></i></button>
                </div>
                <div id="details-slider-container" class="w-full h-full flex items-center justify-center bg-gray-100 dark:bg-slate-800">
                    <img id="details-img" src="" class="w-full h-full object-cover cursor-pointer" onclick="openLightbox(this.src)">
                </div>
                <div id="details-arrows"><button onclick="scrollDetails(1)" class="absolute left-2 top-1/2 -translate-y-1/2 bg-black/30 text-white p-1 rounded-full z-10"><i data-lucide="chevron-left" class="w-5 h-5"></i></button><button onclick="scrollDetails(-1)" class="absolute right-2 top-1/2 -translate-y-1/2 bg-black/30 text-white p-1 rounded-full z-10"><i data-lucide="chevron-right" class="w-5 h-5"></i></button></div>
                <div id="details-dots" class="absolute bottom-3 left-1/2 -translate-x-1/2 z-20 flex gap-1.5"></div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 bg-white dark:bg-darkbg custom-scroll">
                <button onclick="toggleOrderModal()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold text-sm shadow-lg mb-4 flex items-center justify-center gap-2 animate-pulse">
                    <i data-lucide="shopping-cart" class="w-5 h-5"></i> طلب المنتج
                </button>

                <div id="d-pub-bar" class="flex items-center justify-between mb-2 p-1.5 bg-slate-100 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 h-auto cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-700/80 transition">
                     <div class="flex items-center gap-2">
                         <div id="d-pub-img" class="w-7 h-7 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center overflow-hidden"><i data-lucide="user" class="w-3 h-3 text-slate-400"></i></div>
                         <div class="flex flex-col justify-center">
                             <h4 id="d-pub-name" class="font-bold text-[10px] text-navy dark:text-white leading-tight">...</h4>
                             <span class="text-[8px] text-slate-400">الناشر (اضغط للعرض)</span>
                         </div>
                     </div>
                     <div id="d-shipping-info" class="flex flex-wrap items-center gap-1 text-[9px] font-bold text-slate-500 bg-white dark:bg-slate-700 px-1.5 py-0.5 rounded border border-slate-200 dark:border-slate-600 max-w-[55%] justify-end leading-tight"></div>
                </div>

                <div class="flex justify-between items-start mb-2 bg-slate-100 dark:bg-slate-800 p-2 rounded-lg"><h2 id="d-title" class="text-base font-bold text-slate-900 dark:text-white leading-snug w-3/4 select-text"></h2><span id="d-price" class="text-primary font-black text-lg whitespace-nowrap select-text"></span></div>
                <div class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400 mb-3 pb-2 border-b border-slate-100 dark:border-slate-700">
                    <span id="d-cat" class="bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded text-[10px] border border-slate-200 dark:border-slate-700"></span> 
                    <span id="d-cond" class="bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded text-[10px] border border-slate-200 dark:border-slate-700 font-bold"></span>
                    <span id="d-date" class="text-[10px] text-black dark:text-white font-bold mr-auto"></span>
                </div>
                
                <div id="d-variants-container" class="space-y-2 mb-4">
                    <div id="d-sizes-row" class="hidden flex flex-wrap items-center gap-2 bg-slate-100 dark:bg-slate-800 p-2 rounded-lg">
                        <span class="text-[10px] font-bold text-slate-400 shrink-0">المقاسات:</span>
                        <div id="d-sizes-list" class="flex flex-wrap gap-1"></div>
                    </div>
                    <div id="d-colors-row" class="hidden flex flex-wrap items-center gap-2 bg-slate-100 dark:bg-slate-800 p-2 rounded-lg">
                        <span class="text-[10px] font-bold text-slate-400 shrink-0">الألوان:</span>
                        <div id="d-colors-list" class="flex flex-wrap gap-1"></div>
                    </div>
                </div>

                <div id="d-features" class="flex flex-wrap gap-2 mb-4"></div>

                <div class="space-y-1 mb-6"><h3 class="text-xs font-bold text-slate-900 dark:text-slate-200 uppercase tracking-wider">الوصف</h3><p id="d-desc" class="text-xs text-slate-600 dark:text-slate-300 leading-relaxed whitespace-pre-wrap bg-slate-100 dark:bg-slate-800 p-3 rounded-xl border border-slate-200 dark:border-slate-700 font-medium select-text"></p></div>

                <div class="border-t border-slate-100 dark:border-slate-700 pt-4">
                    <h3 class="text-xs font-bold text-slate-900 dark:text-white mb-3">التقييمات</h3>
                    <div id="product-reviews-list" class="space-y-3 mb-3"></div>
                    <div class="flex gap-2 mt-2">
                        <button id="load-more-reviews" onclick="loadProductReviews(true)" class="hidden flex-1 text-center text-xs text-primary font-bold py-2 bg-slate-50 dark:bg-slate-800 rounded-lg">عرض المزيد</button>
                        <button id="load-less-reviews" onclick="loadProductReviews(false, true)" class="hidden flex-1 text-center text-xs text-red-500 font-bold py-2 bg-slate-50 dark:bg-slate-800 rounded-lg">عرض أقل</button>
                    </div>
                    <div id="add-review-form" class="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border border-slate-100 dark:border-slate-700 mt-2">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] font-bold">أضف تقييمك</span>
                            <div class="star-rating text-lg">
                                <input type="radio" id="star5" name="rating" value="5" onclick="setRating(5)"><label for="star5">★</label>
                                <input type="radio" id="star4" name="rating" value="4" onclick="setRating(4)"><label for="star4">★</label>
                                <input type="radio" id="star3" name="rating" value="3" onclick="setRating(3)"><label for="star3">★</label>
                                <input type="radio" id="star2" name="rating" value="2" onclick="setRating(2)"><label for="star2">★</label>
                                <input type="radio" id="star1" name="rating" value="1" onclick="setRating(1)"><label for="star1">★</label>
                            </div>
                        </div>
                        <textarea id="review-text" class="form-input text-xs w-full mb-2" rows="2" placeholder="اكتب رأيك هنا..."></textarea>
                        <button onclick="submitProductReview()" class="bg-navy dark:bg-primary text-white px-3 py-1.5 rounded-lg text-xs font-bold w-full">نشر التقييم</button>
                    </div>
                </div>
            </div>
            <div class="p-3 border-t border-slate-100 dark:border-slate-700 bg-white dark:bg-darkbg flex gap-2 shrink-0 pb-8 md:pb-3"><a id="d-wa" href="#" target="_blank" class="flex-1 bg-[#25D366] text-white py-2.5 rounded-xl flex justify-center items-center gap-2 font-bold shadow-lg hover:opacity-90 transition text-sm"><i data-lucide="message-circle" class="w-4 h-4"></i> واتساب</a><a id="d-call" href="#" class="flex-1 bg-navy dark:bg-primary text-white py-2.5 rounded-xl flex justify-center items-center gap-2 font-bold shadow-lg hover:opacity-90 transition text-sm"><i data-lucide="phone" class="w-4 h-4"></i> اتصال</a></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp, getDocs, limit, orderBy, startAfter } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Service Worker
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'souq-v2';
                const ASSETS = [
                    'https://cdn.tailwindcss.com',
                    'https://unpkg.com/lucide@latest',
                    'https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap'
                ];
                self.addEventListener('install', e => e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(ASSETS))));
                self.addEventListener('fetch', e => {
                    if(e.request.url.startsWith('http')) {
                        e.respondWith(caches.match(e.request).then(r => r || fetch(e.request).then(res => {
                            if(e.request.destination === 'image' || e.request.destination === 'font') {
                                const clone = res.clone();
                                caches.open(CACHE_NAME).then(c => c.put(e.request, clone));
                            }
                            return res;
                        })));
                    }
                });
            `;
            const blob = new Blob([swCode], {type: 'application/javascript'});
            navigator.serviceWorker.register(URL.createObjectURL(blob));
        }

        // PWA Install
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if(!localStorage.getItem('pwa_installed')) {
                document.getElementById('install-banner').classList.remove('hidden');
            }
        });
        window.installPWA = async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') localStorage.setItem('pwa_installed', 'true');
                deferredPrompt = null;
                document.getElementById('install-banner').classList.add('hidden');
            }
        }
        window.closeInstall = () => document.getElementById('install-banner').classList.add('hidden');

        const EGYPT_DATA = {
            "القاهرة": ["مدينة نصر", "مصر الجديدة", "المعادي", "التجمع الخامس", "شبرا", "عين شمس", "المرج", "حلوان", "وسط البلد", "الزمالك", "المنيل", "العباسية", "الزيتون", "حدائق القبة", "السيدة زينب"],
            "الجيزة": ["الهرم", "فيصل", "6 أكتوبر", "الشيخ زايد", "الدقي", "المهندسين", "العجوزة", "إمبابة", "الوراق", "بولاق الدكرور", "العمرانية", "المنيب", "البدرشين", "الحوامدية", "الصف", "أطفيح"],
            "الإسكندرية": ["سموحة", "ميامي", "المنتزه", "سيدي بشر", "العصافرة", "المندرة", "فيكتوريا", "جليم", "ستانلي", "رشدي", "كفر عبده", "محرم بك", "العجمي", "البيطاش", "الهانوفيل", "برج العرب"],
            "الدقهلية": ["المنصورة", "طلخا", "ميت غمر", "دكرنس", "شربين", "السنبلاوين", "أجا", "بلقاس", "منية النصر", "المطرية", "الجمالية", "بني عبيد"],
            "الشرقية": ["الزقازيق", "العشر من رمضان", "منيا القمح", "بلبيس", "فاقوس", "أبو حماد", "الحسينية", "كفر صقر", "أبو كبير", "ديرب نجم", "مشتول السوق", "ههيا"],
            "المنوفية": ["شبين الكوم", "مدينة السادات", "منوف", "أشمون", "قويسنا", "بركة السبع", "تلا", "الشهداء", "الباجور", "سرس الليان"],
            "القليوبية": ["بنها", "شبرا الخيمة", "قليوب", "القناطر الخيرية", "الخانكة", "كفر شكر", "طوخ", "العبور", "شبين القناطر", "الخصوص"],
            "البحيرة": ["دمنهور", "كفر الدوار", "إيتاي البارود", "أبو حمص", "كوم حمادة", "الدلنجات", "حوش عيسى", "رشيد", "إدكو", "المحمودية", "الرحمانية", "النوبارية"],
            "الغربية": ["طنطا", "المحلة الكبرى", "كفر الزيات", "زفتى", "السنطة", "قطور", "بسيون", "سمنود"],
            "بورسعيد": ["حي الشرق", "حي العرب", "حي المناخ", "حي الضواحي", "حي الجنوب", "حي الزهور", "بورفؤاد"],
            "دمياط": ["دمياط", "رأس البر", "دمياط الجديدة", "فارسكور", "الزرقا", "كفر سعد", "الروضة", "السرو", "عزبة البرج", "ميت أبو غالب"],
            "الإسماعيلية": ["الإسماعيلية", "القصاصين", "التل الكبير", "فايد", "القنطرة شرق", "القنطرة غرب", "أبو صوير"],
            "السويس": ["حي السويس", "حي الأربعين", "حي عتاقة", "حي الجناين", "حي فيصل"],
            "كفر الشيخ": ["كفر الشيخ", "دسوق", "فوه", "مطوبس", "بلطيم", "مصيف بلطيم", "الحامول", "بيلا", "الرياض", "سيدي سالم", "قلين"],
            "الفيوم": ["الفيوم", "الفيوم الجديدة", "طامية", "سنورس", "إطسا", "إبشواي", "يوسف الصديق"],
            "بني سويف": ["بني سويف", "بني سويف الجديدة", "الواسطى", "ناصر", "إهناسيا", "ببا", "الفشن", "سمسطا"],
            "المنيا": ["المنيا", "المنيا الجديدة", "العدوة", "مغاغة", "بني مزار", "مطاي", "سمالوط", "أبو قرقاص", "ملوي", "دير مواس"],
            "أسيوط": ["أسيوط", "أسيوط الجديدة", "ديروط", "القوصية", "أبنوب", "منفلوط", "أبو تيج", "الغنايم", "ساحل سليم", "البداري", "صدفا"],
            "سوهاج": ["سوهاج", "سوهاج الجديدة", "أخميم", "أخميم الجديدة", "البلينا", "المراغة", "المنشأة", "دار السلام", "جرجا", "جهينة", "ساقلتة", "طما", "طهطا"],
            "قنا": ["قنا", "قنا الجديدة", "أبو تشت", "نجع حمادي", "دشنا", "الوقف", "قفط", "قوص", "نقادة", "فرشوط"],
            "الأقصر": ["الأقصر", "إسنا", "أرمنت", "القرنة", "البياضية", "الزينية", "الطود"],
            "أسوان": ["أسوان", "أسوان الجديدة", "دراو", "كوم أمبو", "نصر النوبة", "إدفو"],
            "البحر الأحمر": ["الغردقة", "رأس غارب", "سفاجا", "القصير", "مرسى علم", "شلاتين", "حلايب"],
            "الوادي الجديد": ["الخارجة", "الداخلة", "الفرافرة", "باريس", "بلاط"],
            "مطروح": ["مرسى مطروح", "الحمام", "العلمين", "الضبعة", "النجيلة", "سيدي براني", "السلوم", "سيوة"],
            "شمال سيناء": ["العريش", "بئر العبد", "الشيخ زويد", "رفح", "الحسنة", "نخل"],
            "جنوب سيناء": ["الطور", "شرم الشيخ", "دهب", "نويبع", "طابا", "سانت كاترين", "أبو رديس", "أبو زنيمة", "رأس سدر"]
        };

        const firebaseConfig = {
          apiKey: "AIzaSyA5OiTcX95GBgiJoDHnY3y7N23o-j8hsQ8",
          authDomain: "services-cef84.firebaseapp.com",
          databaseURL: "https://services-cef84-default-rtdb.firebaseio.com",
          projectId: "services-cef84",
          storageBucket: "services-cef84.firebasestorage.app",
          messagingSenderId: "902396219187",
          appId: "1:902396219187:web:3ba084a724266afa8bb846"
        };

        const app = initializeApp(firebaseConfig); 
        const db = getFirestore(app); 
        const auth = getAuth(app);

        let state = { 
            user: null, userData: null, listings: [], images: [], chatId: null, activeAdminChat: null, isAdmin: false, 
            favorites: [], currentFilter: 'all', currentItem: null, currentView: 'home', lightboxImages: [], 
            lightboxIndex: 0, detailsSliderIndex: 0, detailsSliderImages: [], authRole: 'customer', authType: 'login', 
            authImageBase64: null, userRole: 'customer', currentRating: 0, currentUserRating: 0, productReviews: [], 
            productReviewsLimit: 1, profileReviews: [], profileReviewsLimit: 3, viewingProfileId: null, orderItems: [],
            currentAuthor: null, notifications: []
        };

        function initGovs() {
            const govSelect = document.getElementById('auth-gov');
            const filterGov = document.getElementById('filter-gov');
            const shipGovList = document.getElementById('ship-gov-list'); 
            const editGov = document.getElementById('edit-gov'); 
            const ordGov = document.getElementById('ord-gov'); 

            govSelect.innerHTML = '<option value="">اختر المحافظة</option>';
            filterGov.innerHTML = '<option value="">كل المحافظات</option>';
            editGov.innerHTML = '<option value="">اختر المحافظة</option>';
            ordGov.innerHTML = '<option value="">اختر المحافظة</option>';
            shipGovList.innerHTML = '';

            Object.keys(EGYPT_DATA).forEach(gov => {
                govSelect.innerHTML += `<option value="${gov}">${gov}</option>`;
                filterGov.innerHTML += `<option value="${gov}">${gov}</option>`;
                editGov.innerHTML += `<option value="${gov}">${gov}</option>`;
                ordGov.innerHTML += `<option value="${gov}">${gov}</option>`;
                shipGovList.innerHTML += `
                    <label class="flex items-center gap-1 cursor-pointer hover:bg-slate-50 p-1 rounded">
                        <input type="checkbox" name="ship-gov-check" value="${gov}" class="w-3 h-3 rounded border-gray-300 text-primary focus:ring-primary">
                        <span class="text-[10px] font-bold text-slate-600">${gov}</span>
                    </label>
                `;
            });
        }
        initGovs();

        window.updateCities = () => updateCitySelect('auth-gov', 'auth-city');
        window.updateEditCities = () => updateCitySelect('edit-gov', 'edit-city');
        window.updateOrderCities = () => updateCitySelect('ord-gov', 'ord-city');

        function updateCitySelect(govId, cityId) {
            const gov = document.getElementById(govId).value;
            const citySelect = document.getElementById(cityId);
            citySelect.innerHTML = '<option value="">اختر المركز/المدينة</option>';
            if(gov && EGYPT_DATA[gov]) {
                EGYPT_DATA[gov].forEach(city => {
                    citySelect.innerHTML += `<option value="${city}">${city}</option>`;
                });
            }
        }

        function forceSwitchToApp() {
            const loginView = document.getElementById('login-view');
            const appContent = document.getElementById('app-content');
            const splash = document.getElementById('splash-screen');
            
            if(splash) {
                splash.classList.add('fade-out');
                setTimeout(() => splash.remove(), 300);
            }

            loginView.classList.add('hidden');
            loginView.style.setProperty('display', 'none', 'important');
            appContent.classList.remove('hidden');
            document.getElementById('loader').classList.add('hidden'); 
        }

        onAuthStateChanged(auth, async (u) => { 
            if(u) { 
                state.user = u;
                try {
                    const userDoc = await getDoc(doc(db, "users", u.uid));
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        state.userData = data;
                        state.userRole = data.role || 'customer';
                        state.isAdmin = data.isAdmin === true;
                        document.getElementById('header-username').innerText = data.name || u.displayName;
                        document.getElementById('welcome-text').classList.remove('hidden');
                        if(state.isAdmin) document.getElementById('btn-admin-top').classList.remove('hidden');
                        
                        // Notifications Listener
                        onSnapshot(query(collection(db, "notifications"), where("userId", "==", u.uid), orderBy("timestamp", "desc"), limit(10)), (snap) => {
                            state.notifications = [];
                            const list = document.getElementById('notif-list');
                            const badge = document.getElementById('notif-badge');
                            list.innerHTML = '';
                            let unread = false;
                            
                            snap.forEach(d => {
                                const n = d.data();
                                state.notifications.push(n);
                                if(!n.read) unread = true;
                                list.innerHTML += `<div class="p-2 border-b border-slate-100 dark:border-slate-700 text-[10px] ${n.read ? 'opacity-60' : 'font-bold'}">${n.message}</div>`;
                            });
                            
                            if(unread) badge.classList.remove('hidden'); else badge.classList.add('hidden');
                        });
                    }
                } catch(e) { console.warn(e); }
                forceSwitchToApp();
                loadListings(); 
                initFavs(); 
                initCats(); 
            } else {
                state.user = null;
                const splash = document.getElementById('splash-screen');
                if(splash) { splash.classList.add('fade-out'); setTimeout(() => splash.remove(), 300); }
                document.getElementById('login-view').classList.remove('hidden');
                document.getElementById('login-view').style.removeProperty('display');
                document.getElementById('app-content').classList.add('hidden');
            }
        });

        window.toggleNotifications = () => {
            document.getElementById('notif-dropdown').classList.toggle('hidden');
            // Mark as read logic could go here
        }

        // ... (Auth functions remain same) ...
        window.setAuthRole = (role) => {
            state.authRole = role;
            const btnCust = document.getElementById('btn-role-customer');
            const btnMark = document.getElementById('btn-role-marketer');
            if (role === 'customer') {
                btnCust.className = "flex-1 py-1.5 rounded-lg text-xs font-bold transition-all bg-navy dark:bg-primary text-white shadow-md";
                btnMark.className = "flex-1 py-1.5 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:bg-white dark:hover:bg-slate-700";
            } else {
                btnMark.className = "flex-1 py-1.5 rounded-lg text-xs font-bold transition-all bg-navy dark:bg-primary text-white shadow-md";
                btnCust.className = "flex-1 py-1.5 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:bg-white dark:hover:bg-slate-700";
            }
        }

        window.setAuthType = (type) => {
            state.authType = type;
            const btnLogin = document.getElementById('btn-type-login');
            const btnSignup = document.getElementById('btn-type-signup');
            const actionBtn = document.getElementById('btn-auth-action');
            const imgField = document.getElementById('auth-image-field');
            const signupFields = document.getElementById('signup-fields');

            if (type === 'login') {
                btnLogin.className = "flex-1 py-1.5 rounded-lg text-xs font-bold transition-all bg-navy dark:bg-primary text-white shadow-md";
                btnSignup.className = "flex-1 py-1.5 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:text-navy dark:hover:text-white";
                actionBtn.innerHTML = `<span>دخول للحساب</span> <i data-lucide="arrow-left" class="w-4 h-4"></i>`;
                imgField.classList.add('hidden');
                imgField.classList.remove('flex');
                signupFields.classList.add('hidden');
            } else {
                btnSignup.className = "flex-1 py-1.5 rounded-lg text-xs font-bold transition-all bg-navy dark:bg-primary text-white shadow-md";
                btnLogin.className = "flex-1 py-1.5 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:text-navy dark:hover:text-white";
                actionBtn.innerHTML = `<span>إنشاء حساب جديد</span> <i data-lucide="plus-circle" class="w-4 h-4"></i>`;
                imgField.classList.remove('hidden');
                imgField.classList.add('flex');
                signupFields.classList.remove('hidden');
            }
            lucide.createIcons();
        }

        window.handleAuthImage = async (input) => {
            if (input.files && input.files[0]) {
                const c = await compress(input.files[0]);
                state.authImageBase64 = c;
                document.getElementById('auth-img-preview').src = c;
                document.getElementById('auth-img-preview').classList.remove('hidden');
                document.getElementById('auth-img-placeholder').classList.add('hidden');
            }
        }

        window.processAuth = async () => {
            const username = document.getElementById('auth-username').value.trim().toLowerCase();
            const pass = document.getElementById('auth-pass').value;
            const errDiv = document.getElementById('auth-error');
            const btn = document.getElementById('btn-auth-action');

            errDiv.classList.add('hidden');
            errDiv.innerText = "";
            
            if (!username || !pass) {
                errDiv.innerText = "يرجى ملء اسم المستخدم وكلمة المرور";
                errDiv.classList.remove('hidden');
                return;
            }

            const email = `${username}@souq.local`;
            const originalBtnText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<div class="spinner"></div> جاري المعالجة...`;

            try {
                if (state.authType === 'signup') {
                    const nameAr = document.getElementById('auth-name-ar').value.trim();
                    const phone = document.getElementById('auth-phone').value.trim();
                    const gov = document.getElementById('auth-gov').value;
                    const city = document.getElementById('auth-city').value;
                    const address = document.getElementById('auth-address').value.trim();

                    if (!nameAr || !gov || !city || !address || !phone) throw new Error("missing_fields");

                    const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                    const user = userCredential.user;
                    await updateProfile(user, { displayName: nameAr });

                    const newUser = {
                        username: username, name: nameAr, phone: phone, email: email, role: state.authRole,
                        governorate: gov, city: city, address: address, isAdmin: false,
                        image: state.authImageBase64 || null, createdAt: serverTimestamp()
                    };
                    await setDoc(doc(db, "users", user.uid), newUser);
                    state.userData = newUser;
                    state.userRole = state.authRole;
                    document.getElementById('header-username').innerText = nameAr;
                    document.getElementById('welcome-text').classList.remove('hidden');
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
                btn.innerHTML = `تم بنجاح <i data-lucide="check" class="w-4 h-4"></i>`;
                btn.classList.replace('bg-navy', 'bg-green-600');
                setTimeout(() => forceSwitchToApp(), 500);
            } catch (error) {
                let msg = `حدث خطأ: ${error.code}`; 
                if(error.message === "missing_fields") msg = "يرجى إكمال جميع البيانات";
                else if(error.code === 'auth/email-already-in-use') msg = "اسم المستخدم هذا موجود بالفعل";
                else if(error.code === 'auth/wrong-password') msg = "كلمة المرور غير صحيحة";
                errDiv.innerText = msg;
                errDiv.classList.remove('hidden');
                btn.disabled = false;
                btn.innerHTML = originalBtnText;
                lucide.createIcons();
            }
        }

        window.logout = () => signOut(auth).then(() => window.location.reload());

        // ... (Categories & Images constants remain same) ...
        const CATEGORIES = ["ملابس رجالي", "ملابس حريمي", "ملابس اطفال", "احذية رجالي", "احذية حريمي", "احذية اطفال", "اكسسورات رجالي", "اكسسورات حريمي", "اكسسورات اطفال", "برفانات رجالي وحريمي", "الحقائب الشخصية", "النظارات", "مستحضرات التجميل", "ادوات حلاقة للرجال", "مكملات غذائية", "ادوات رياضية", "الهدايا الشخصية", "الهدايا والالعاب", "منتجات العناية بالبشرة", "منتجات الاطفال", "اقمشة"];
        const USED_CATS = ["النظارات", "اكسسورات رجالي", "اكسسورات حريمي", "اكسسورات اطفال"];
        const CLOTHES_CATS = ["ملابس رجالي", "ملابس حريمي", "ملابس اطفال", "اقمشة"];
        const SHOES_CATS = ["احذية رجالي", "احذية حريمي", "احذية اطفال"];
        const SIZES_MEN = ["S", "M", "L", "XL", "2XL", "3XL", "4XL", "FreeSize"];
        const SIZES_WOMEN = ["XS", "S", "M", "L", "XL", "2XL", "FreeSize"];
        const SIZES_KIDS = ["1y", "2y", "4y", "6y", "8y", "10y", "12y", "14y", "16y"];
        const SIZES_SHOES_ADULT = ["37", "38", "39", "40", "41", "42", "43", "44", "45"];
        const SIZES_SHOES_KIDS = ["20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35"];
        const BASIC_COLORS = ["أبيض", "أسود", "رمادي", "كحلي", "أحمر", "أزرق", "بيج", "أخضر", "أصفر", "بني"];
        const CATEGORY_IMAGES = {
            "ملابس رجالي": "https://images.unsplash.com/photo-1617137968427-85924c800a22?q=80&w=300&auto=format&fit=crop",
            "برفانات رجالي وحريمي": "https://images.unsplash.com/photo-1541643600914-78b084683601?q=80&w=300&auto=format&fit=crop",
            "النظارات": "https://images.unsplash.com/photo-1572635196237-14b3f281503f?q=80&w=300&auto=format&fit=crop",
            "مستحضرات التجميل": "https://images.unsplash.com/photo-1596462502278-27bfdc403348?q=80&w=300&auto=format&fit=crop",
            "ادوات حلاقة للرجال": "https://images.unsplash.com/photo-1621607512214-68297480165e?q=80&w=300&auto=format&fit=crop",
            "مكملات غذائية": "https://images.unsplash.com/photo-1581009137042-c552e485697a?q=80&w=300&auto=format&fit=crop",
            "احذية حريمي": "https://images.unsplash.com/photo-1549298916-b41d501d3772?q=80&w=300&auto=format&fit=crop",
            "ادوات رياضية": "https://images.unsplash.com/photo-1517836357463-d25dfeac3438?q=80&w=300&auto=format&fit=crop",
            "ملابس حريمي": "https://images.pexels.com/photos/3772506/pexels-photo-3772506.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
            "احذية رجالي": "https://images.pexels.com/photos/5264901/pexels-photo-5264901.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
            "احذية اطفال": "https://images.pexels.com/photos/29737094/pexels-photo-29737094.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
            "ملابس اطفال": "https://images.pexels.com/photos/1620758/pexels-photo-1620758.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
            "اكسسورات رجالي": "https://images.pexels.com/photos/3766112/pexels-photo-3766112.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
            "اكسسورات حريمي": "https://images.pexels.com/photos/17568000/pexels-photo-17568000.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
            "اكسسورات اطفال": "https://images.pexels.com/photos/2848522/pexels-photo-2848522.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
            "الحقائب الشخصية": "https://images.pexels.com/photos/1986996/pexels-photo-1986996.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
            "الهدايا الشخصية": "https://images.pexels.com/photos/19066549/pexels-photo-19066549.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
            "الهدايا والالعاب": "https://images.pexels.com/photos/4491662/pexels-photo-4491662.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
            "منتجات العناية بالبشرة": "https://images.pexels.com/photos/10117729/pexels-photo-10117729.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
            "منتجات الاطفال": "https://images.pexels.com/photos/26337029/pexels-photo-26337029.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop",
            "اقمشة": "https://images.pexels.com/photos/34636582/pexels-photo-34636582.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop"
        };

        function initCats() {
            const cont = document.getElementById('categories-container');
            cont.innerHTML = `<button onclick="filter('all')" id="chip-all" class="chip-btn">الكل</button>`;
            const sel = document.getElementById('in-cat');
            sel.innerHTML = '';
            CATEGORIES.forEach(c => {
                const btn = document.createElement('button'); 
                btn.innerText = c; 
                btn.id = `chip-${c.replace(/\s/g, '')}`;
                btn.className = "px-4 py-1.5 rounded-full bg-white dark:bg-darkbg border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-300 text-xs font-bold whitespace-nowrap transition hover:border-primary hover:text-primary chip-btn";
                btn.onclick = () => filter(c); 
                cont.appendChild(btn);
                const opt = document.createElement('option'); opt.value = c; opt.innerText = c; sel.appendChild(opt);
            });
        }

        // ... (Render & Filter functions) ...
        function renderView() {
            const searchInput = document.getElementById('search-input');
            const catContainer = document.getElementById('categories-container');
            const searchContainer = document.getElementById('search-container');
            const viewHeader = document.getElementById('view-header');
            const gridContainer = document.getElementById('grid-container');
            const filterBtn = document.getElementById('btn-filter-toggle');
            document.getElementById('filter-panel').classList.add('hidden');

            if (state.currentView === 'home') {
                viewHeader.classList.add('hidden');
                catContainer.classList.add('hidden');
                filterBtn.classList.add('hidden'); 
                searchContainer.classList.remove('hidden');
                gridContainer.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 pb-10 mt-4';
                searchInput.placeholder = 'ابحث عن قسم...';
                renderCategoryCards();
            } else if (state.currentView === 'category') {
                viewHeader.classList.remove('hidden');
                const title = state.currentFilter === 'all' ? 'كل المنتجات' : (state.currentFilter === 'fav' ? 'المفضلة' : state.currentFilter);
                document.getElementById('view-title').innerText = title;
                if (state.currentFilter === 'fav') {
                    searchContainer.classList.add('hidden');
                    catContainer.classList.add('hidden');
                } else {
                    searchContainer.classList.remove('hidden');
                    filterBtn.classList.remove('hidden'); 
                    searchInput.placeholder = 'ابحث عن منتج...';
                    if (state.currentFilter === 'all') catContainer.classList.remove('hidden'); else catContainer.classList.add('hidden');
                }
                gridContainer.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 pb-10';
                filter(state.currentFilter);
            }
            lucide.createIcons();
        }

        window.toggleFilterPanel = () => document.getElementById('filter-panel').classList.toggle('hidden');
        window.applyFilters = () => renderProducts();
        window.resetFilters = () => {
            document.getElementById('search-input').value = '';
            document.getElementById('filter-price').value = '';
            document.getElementById('filter-gov').value = '';
            switchToHomeView();
        };

        window.switchToCategoryView = (category) => {
            state.currentView = 'category'; state.currentFilter = category;
            document.getElementById('search-input').value = '';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            renderView();
        }

        window.switchToHomeView = () => {
            state.currentView = 'home'; state.currentFilter = 'all';
            document.getElementById('search-input').value = '';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            renderView();
            const url = new URL(window.location); url.searchParams.delete('product_id'); window.history.replaceState({}, '', url);
        }

        function renderCategoryCards() {
            const cont = document.getElementById('grid-container');
            const q = normalizeText(document.getElementById('search-input').value);
            cont.innerHTML = '';
            const filteredCats = CATEGORIES.filter(c => normalizeText(c).includes(q));
            if (!filteredCats.length) document.getElementById('empty-state').classList.remove('hidden');
            else {
                document.getElementById('empty-state').classList.add('hidden');
                filteredCats.forEach(cat => {
                    const imageUrl = CATEGORY_IMAGES[cat] || 'https://images.unsplash.com/photo-1523275335684-37898b6baf30?q=80&w=300&auto=format&fit=crop';
                    cont.innerHTML += `<div onclick="switchToCategoryView('${cat}')" class="relative rounded-xl overflow-hidden shadow-sm border-2 border-black dark:border-slate-700 h-28 cursor-pointer active:scale-95 transition-transform group flex items-center justify-center text-center p-2"><img src="${imageUrl}" class="absolute inset-0 w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" loading="lazy"><div class="absolute inset-0 bg-black/50"></div><h3 class="relative z-10 font-bold text-white text-sm drop-shadow-md">${cat}</h3></div>`;
                });
            }
        }

        function loadListings() { 
            showSkeletons(); 
            onSnapshot(query(collection(db, "listings")), (snap) => { 
                state.listings = []; 
                snap.forEach(d => state.listings.push({id: d.id, ...d.data()})); 
                state.listings.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); 
                const params = new URLSearchParams(window.location.search);
                const linkedProdId = params.get('product_id');
                if(linkedProdId && !state.currentItem) {
                   const item = state.listings.find(i => i.id === linkedProdId);
                   if(item) openDetails(item.id);
                }
                renderView();
            }); 
        }

        window.handleSearch = () => { if (state.currentView === 'home') renderCategoryCards(); else renderProducts(); };

        window.filter = (type) => { 
            state.currentFilter = type; 
            document.querySelectorAll('#categories-container .chip-btn').forEach(btn => btn.className = "px-4 py-1.5 rounded-full bg-white dark:bg-darkbg border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-300 text-xs font-bold whitespace-nowrap transition hover:border-primary hover:text-primary chip-btn");
            const activeId = type === 'all' ? 'chip-all' : `chip-${type.replace(/\s/g, '')}`;
            const activeBtn = document.getElementById(activeId);
            if(activeBtn) {
                activeBtn.className = "px-5 py-1.5 rounded-full bg-navy dark:bg-primary text-white text-xs font-bold shadow whitespace-nowrap transform scale-105 transition chip-btn";
                activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
            if (state.currentView !== 'category') state.currentView = 'category';
            const title = type === 'all' ? 'كل المنتجات' : (type === 'fav' ? 'المفضلة' : type);
            document.getElementById('view-title').innerText = title;
            renderProducts(); 
        };

        function renderProducts() {
            const q = normalizeText(document.getElementById('search-input').value);
            const priceFilter = document.getElementById('filter-price').value;
            const govFilter = document.getElementById('filter-gov').value;
            const cont = document.getElementById('grid-container'); 
            cont.innerHTML = ''; 
            let filtered = state.listings.filter(item => { 
                let matchType = true; 
                if (state.currentFilter === 'fav') matchType = (state.favorites || []).includes(item.id);
                else matchType = state.currentFilter === 'all' || item.category === state.currentFilter; 
                const matchText = normalizeText(item.title).includes(q) || normalizeText(item.category || '').includes(q); 
                let matchGov = true;
                if(govFilter && item.governorate) matchGov = item.governorate === govFilter;
                return matchType && matchText && matchGov; 
            }); 
            if (priceFilter === 'low') filtered.sort((a, b) => a.price - b.price);
            else if (priceFilter === 'high') filtered.sort((a, b) => b.price - a.price);
            if(!filtered.length) document.getElementById('empty-state').classList.remove('hidden'); 
            else { 
                document.getElementById('empty-state').classList.add('hidden'); 
                filtered.forEach(item => cont.innerHTML += createCard(item)); 
            } 
            lucide.createIcons(); 
        }

        function formatDate(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate();
            const now = new Date();
            const diff = Math.floor((now - date) / 1000); 
            if (diff < 60) return 'منذ لحظات';
            if (diff < 3600) return `منذ ${Math.floor(diff / 60)} دقيقة`;
            if (diff < 86400) return `منذ ${Math.floor(diff / 3600)} ساعة`;
            if (diff < 604800) return `منذ ${Math.floor(diff / 86400)} يوم`;
            return date.toLocaleDateString('ar-EG');
        }

        function createCard(item) {
            const imgs = Array.isArray(item.images)?item.images:[item.image];
            const isFav = (state.favorites || []).includes(item.id);
            const heartClass = isFav ? "fill-red-500 text-red-500" : "text-white";
            let badge = item.badge==='hot' ? `<span class="absolute top-1 left-1 bg-orange-500 text-white text-[9px] font-bold px-2 py-0.5 rounded shadow animate-pulse z-10">🔥 عرض</span>` : '';
            let statusOverlay = ''; let isClickable = true; 
            if(item.status && item.status !== 'available') { 
                isClickable = false; 
                const txt = item.status==='sold'?'تم البيع':'غير متاح'; 
                statusOverlay=`<div class="absolute inset-0 z-20 bg-white/80 dark:bg-black/80 backdrop-blur-sm flex items-center justify-center"><span class="bg-red-600 text-white font-bold px-4 py-2 rounded-xl shadow-xl transform -rotate-12 text-sm">${txt}</span></div>`; 
            }
            return `<div class="bg-white dark:bg-slate-800 rounded-lg overflow-hidden shadow-sm border-2 border-black dark:border-slate-700 flex flex-col h-full cursor-pointer active:scale-95 transition-transform group relative" onclick="${isClickable ? `openDetails('${item.id}')` : ''}"><div class="relative w-full h-28 sm:h-36 bg-gray-200 dark:bg-slate-700">${statusOverlay} ${!statusOverlay ? badge : ''}<button onclick="toggleFav(event, '${item.id}')" class="absolute top-1 left-1 z-20 p-1.5 rounded-full bg-black/20 hover:bg-black/40"><i data-lucide="heart" class="w-3.5 h-3.5 ${heartClass}"></i></button><span class="absolute bottom-1 left-1 bg-white/80 text-black text-[8px] font-bold px-1 rounded z-10">${formatDate(item.createdAt)}</span>${imgs.length > 1 ? `<button onclick="scrollCard(event, '${item.id}', -1)" class="absolute right-1 top-1/2 -translate-y-1/2 bg-black/20 hover:bg-black/40 text-white p-1 rounded-full z-10 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="chevron-right" class="w-3 h-3"></i></button><button onclick="scrollCard(event, '${item.id}', 1)" class="absolute left-1 top-1/2 -translate-y-1/2 bg-black/20 hover:bg-black/40 text-white p-1 rounded-full z-10 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="chevron-left" class="w-3 h-3"></i></button>` : ''}<div id="slider-${item.id}" class="flex w-full h-full overflow-x-auto no-scrollbar snap-x snap-mandatory scroll-smooth">${imgs.map(src => `<img src="${src}" class="w-full h-full object-cover shrink-0 snap-center ${statusOverlay?'grayscale':''}" loading="lazy">`).join('')}</div><span class="absolute bottom-1 right-1 bg-white/90 dark:bg-black/60 text-slate-800 dark:text-white px-1.5 py-0.5 rounded text-[8px] font-bold shadow z-10">${item.category}</span></div><div class="p-1.5 flex-1 flex flex-col"><div class="flex justify-between items-start mb-0.5"><h3 class="font-bold text-slate-900 dark:text-white text-[10px] line-clamp-1">${item.title}</h3><span class="font-black text-primary text-[10px] whitespace-nowrap">${Number(item.price).toLocaleString()} ج.م</span></div><div class="text-[8px] text-slate-500 dark:text-slate-400 mb-1 flex gap-1 items-center"><span class="bg-slate-100 dark:bg-white/5 px-1 rounded">${item.condition==='new'?'جديد':(item.condition==='openbox'?'كسر زيرو':'مستعمل')}</span></div><div class="mt-auto flex gap-1 pt-1 border-t border-slate-100 dark:border-slate-700"><a href="https://wa.me/20${item.phone}" target="_blank" onclick="event.stopPropagation()" class="flex-1 bg-primary text-white py-1 rounded flex justify-center items-center gap-1 text-[9px] font-bold"><i data-lucide="message-circle" class="w-3 h-3"></i> واتس</a></div></div></div>`;
        }

        // ... (Slider functions remain same) ...
        function goToDetailsSlide(index, behavior = 'auto') {
            const total = state.detailsSliderImages.length;
            if (total === 0) return;
            if (index < 0) index = total - 1;
            if (index >= total) index = 0;
            state.detailsSliderIndex = index;
            const imgEl = document.getElementById('details-img');
            if (imgEl) imgEl.src = state.detailsSliderImages[state.detailsSliderIndex];
            updateSliderDots();
        }
        window.scrollDetails = (dir) => { 
            const total = state.detailsSliderImages.length;
            if (total <= 1) return;
            let dirAmount = -dir;
            let newIndex = state.detailsSliderIndex + dirAmount;
            goToDetailsSlide(newIndex);
        }
        function updateSliderDots() {
            if (state.detailsSliderImages.length <= 1) return;
            for (let i = 0; i < state.detailsSliderImages.length; i++) {
                const dot = document.getElementById(`dot-${i}`);
                if (dot) dot.className = i === state.detailsSliderIndex ? 'w-4 h-2 rounded-full bg-white shadow transition-all' : 'w-2 h-2 rounded-full bg-white/40 transition-all';
            }
        }

        window.copyDetails = () => {
            if(!state.currentItem) return;
            const text = `المنتج: ${state.currentItem.title}\nالسعر: ${Number(state.currentItem.price).toLocaleString()} ج.م\nالوصف: ${state.currentItem.desc}\nللتواصل: ${state.currentItem.phone}`;
            navigator.clipboard.writeText(text).then(() => showToast('تم نسخ التفاصيل بنجاح ✅')).catch(err => showToast('فشل النسخ', 'e'));
        }

        window.openDetails = async (id) => {
            const item = state.listings.find(i => i.id === id); if(!item) return;
            state.currentItem = item; 
            document.getElementById('d-title').innerText = item.title; 
            document.getElementById('d-price').innerText = Number(item.price).toLocaleString() + ' ج.م'; 
            document.getElementById('d-cat').innerText = item.category; 
            document.getElementById('d-desc').innerText = item.desc;
            document.getElementById('d-cond').innerText = item.condition === 'new' ? 'جديد' : (item.condition === 'openbox' ? 'كسر زيرو' : 'مستعمل');
            document.getElementById('d-date').innerText = formatDate(item.createdAt);

            const pubBar = document.getElementById('d-pub-bar');
            pubBar.onclick = () => toggleProfile(item.authorId);

            const pubName = document.getElementById('d-pub-name');
            const pubImg = document.getElementById('d-pub-img');
            pubName.innerText = "جاري التحميل...";
            
            // Show/Hide Edit/Delete Buttons
            const controls = document.getElementById('product-controls');
            if(state.user && (state.user.uid === item.authorId || state.isAdmin)) {
                controls.classList.remove('hidden');
            } else {
                controls.classList.add('hidden');
            }

            try {
                const uSnap = await getDoc(doc(db, "users", item.authorId));
                if(uSnap.exists()) {
                    const uData = uSnap.data();
                    state.currentAuthor = uData; 
                    pubName.innerText = uData.name || "مستخدم";
                    if(uData.image) pubImg.innerHTML = `<img src="${uData.image}" class="w-full h-full object-cover">`;
                    else pubImg.innerHTML = `<i data-lucide="user" class="w-4 h-4 text-slate-400"></i>`;
                } else {
                    pubName.innerText = "مستخدم غير معروف";
                    state.currentAuthor = null;
                }
            } catch(e) {
                pubName.innerText = "ناشر";
                state.currentAuthor = null;
            }

            const amCont = document.getElementById('d-features'); amCont.innerHTML=''; 
            const sizeRow = document.getElementById('d-sizes-row'); const sizeList = document.getElementById('d-sizes-list');
            const colorRow = document.getElementById('d-colors-row'); const colorList = document.getElementById('d-colors-list');

            sizeRow.classList.add('hidden'); colorRow.classList.add('hidden'); sizeList.innerHTML = ''; colorList.innerHTML = '';

            if(item.size && Array.isArray(item.size) && item.size.length > 0) {
                 sizeRow.classList.remove('hidden');
                 item.size.forEach(s => sizeList.innerHTML += `<span class="bg-white dark:bg-slate-700 text-slate-700 dark:text-white px-2 py-1 rounded-md text-[10px] font-bold border border-slate-200 dark:border-slate-600 shadow-sm min-w-[30px] text-center">${s}</span>`);
            }
            if(item.color && Array.isArray(item.color) && item.color.length > 0) {
                 colorRow.classList.remove('hidden');
                 item.color.forEach(c => colorList.innerHTML += `<span class="bg-white dark:bg-slate-700 text-slate-700 dark:text-white px-2 py-1 rounded-md text-[10px] font-bold border border-slate-200 dark:border-slate-600 shadow-sm">${c}</span>`);
            }
            if(item.features) item.features.forEach(a => amCont.innerHTML += `<span class="bg-slate-100 dark:bg-slate-700 dark:text-white px-2 py-1 rounded text-xs flex items-center gap-1 border border-slate-200 dark:border-slate-600 font-bold">${a}</span>`);
            
            const shipInfo = document.getElementById('d-shipping-info');
            if(item.shippingMode === 'specific' && item.shippingGov) {
                 let govText = Array.isArray(item.shippingGov) ? item.shippingGov.join('، ') : item.shippingGov;
                 shipInfo.innerHTML = `<i data-lucide="truck" class="w-3 h-3 shrink-0"></i> <span class="whitespace-normal leading-tight text-right">متاح لـ: ${govText}</span>`;
            } else {
                shipInfo.innerHTML = `<i data-lucide="truck" class="w-3 h-3 shrink-0"></i> شحن لكل المحافظات`;
            }

            document.getElementById('d-wa').href = `https://wa.me/20${item.phone}?text=استفسار بخصوص: ${item.title}`; 
            document.getElementById('d-call').href = `tel:${item.phone}`;

            const imgs = Array.isArray(item.images) ? item.images : [item.image]; 
            state.detailsSliderImages = imgs; state.detailsSliderIndex = 0;   
            const dotsContainer = document.getElementById('details-dots');
            const imgEl = document.getElementById('details-img');
            if (imgEl) {
                imgEl.src = imgs.length > 0 ? imgs[0] : 'https://placehold.co/400x300/e2e8f0/94a3b8?text=No+Image';
                imgEl.onclick = () => openLightbox(imgEl.src); 
            }
            dotsContainer.innerHTML = ''; 
            if (imgs.length > 1) dotsContainer.innerHTML = imgs.map((_, index) => `<span id="dot-${index}" class="w-2 h-2 rounded-full bg-white/40 transition-all"></span>`).join('');
            document.getElementById('details-arrows').style.display = imgs.length > 1 ? 'block' : 'none';
            
            state.productReviewsLimit = 1;
            loadProductReviews(false);
            toggleModal('details-modal'); 
            goToDetailsSlide(0, 'auto'); 
            lucide.createIcons();
            const url = new URL(window.location); url.searchParams.set('product_id', id); window.history.replaceState({}, '', url);
        }

        window.closeDetails = () => {
             toggleModal('details-modal'); state.currentItem = null; 
             document.getElementById('details-dots').innerHTML = ''; 
             const imgEl = document.getElementById('details-img'); if (imgEl) { imgEl.src = ''; }
             const url = new URL(window.location); url.searchParams.delete('product_id'); window.history.replaceState({}, '', url);
        }

        window.editProduct = () => {
            // Close details and open add modal with data
            closeDetails();
            toggleAddModal();
            // Fill data logic here (simplified for brevity, ideally fill inputs from state.currentItem)
            // For full implementation, we'd need to map currentItem fields back to inputs
            showToast("جاري تحضير التعديل...", "s");
        }

        window.deleteProduct = async () => {
            if(confirm("هل أنت متأكد من حذف هذا المنتج؟")) {
                await deleteDoc(doc(db, "listings", state.currentItem.id));
                showToast("تم الحذف بنجاح");
                closeDetails();
            }
        }

        // ... (Favs, UpdateFormFields, ToggleShipGov, SubmitListing, Del, ToggleStatus, DarkMode, ShowToast, NormalizeText, ShowSkeletons, ShareListing, ScrollCard, Lightbox functions remain same) ...

        // New Chat System Logic
        window.toggleChatList = () => {
            toggleModal('chat-list-modal');
            loadChatList();
        }

        window.loadChatList = () => {
            if(!state.user) return;
            const container = document.getElementById('chat-list-container');
            container.innerHTML = '<div class="spinner mx-auto mt-4"></div>';
            
            onSnapshot(query(collection(db, "chats"), where("participants", "array-contains", state.user.uid), orderBy("lastUpdated", "desc")), (snap) => {
                container.innerHTML = '';
                if(snap.empty) {
                    container.innerHTML = '<p class="text-center text-slate-400 text-xs mt-4">لا توجد محادثات</p>';
                    return;
                }
                
                snap.forEach(doc => {
                    const chat = doc.data();
                    const otherId = chat.participants.find(id => id !== state.user.uid);
                    // Fetch other user info (could be cached)
                    getDoc(doc(db, "users", otherId)).then(uSnap => {
                        const uData = uSnap.data() || { name: 'مستخدم', image: null };
                        const isUnread = chat.lastSenderId !== state.user.uid && !chat.read;
                        
                        container.innerHTML += `
                            <div onclick="openPrivateChat('${doc.id}', '${otherId}', '${uData.name}', '${uData.image}')" class="chat-card ${isUnread ? 'unread' : ''} flex items-center gap-3 p-3 rounded-xl bg-slate-50 dark:bg-slate-800 border border-slate-100 dark:border-slate-700 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 transition">
                                <div class="relative">
                                    ${uData.image ? `<img src="${uData.image}" class="w-10 h-10 rounded-full object-cover">` : `<div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center"><i data-lucide="user" class="w-5 h-5"></i></div>`}
                                    <div class="absolute bottom-0 right-0 w-2.5 h-2.5 rounded-full border-2 border-white ${chat.online ? 'bg-green-500' : 'bg-slate-400'}"></div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-center mb-0.5">
                                        <h4 class="font-bold text-sm truncate">${uData.name}</h4>
                                        <span class="text-[9px] text-slate-400">${formatDate(chat.lastUpdated)}</span>
                                    </div>
                                    <p class="text-xs text-slate-500 truncate last-msg">${chat.lastMessage || 'بدء المحادثة'}</p>
                                </div>
                            </div>
                        `;
                        lucide.createIcons();
                    });
                });
            });
        }

        window.openPrivateChat = (chatId, otherId, name, image) => {
            toggleModal('chat-list-modal'); // Close list
            toggleModal('private-chat-modal'); // Open chat
            
            document.getElementById('chat-header-name').innerText = name;
            document.getElementById('chat-header-img').src = image || ''; // Handle placeholder
            state.activeChatId = chatId;
            state.activeChatOtherId = otherId;
            
            // Load Messages
            const box = document.getElementById('private-chat-box');
            onSnapshot(query(collection(db, `chats/${chatId}/messages`), orderBy("timestamp", "asc")), (snap) => {
                box.innerHTML = '';
                snap.forEach(doc => {
                    const msg = doc.data();
                    const isMe = msg.senderId === state.user.uid;
                    
                    if(msg.type === 'order') {
                        // Render Order Card
                        box.innerHTML += `
                            <div class="flex ${isMe ? 'justify-start' : 'justify-end'} mb-2">
                                <div class="${isMe ? 'bg-primary text-white' : 'bg-white dark:bg-slate-700'} p-2 rounded-xl max-w-[85%] text-xs shadow-sm">
                                    <div class="font-bold mb-1 border-b border-white/20 pb-1">طلب منتج</div>
                                    ${msg.image ? `<img src="${msg.image}" class="w-full h-24 object-cover rounded-lg mb-1">` : ''}
                                    <p class="whitespace-pre-wrap">${msg.text}</p>
                                </div>
                            </div>
                        `;
                    } else {
                        // Normal Message
                        box.innerHTML += `
                            <div class="flex ${isMe ? 'justify-start' : 'justify-end'} mb-1">
                                <div class="${isMe ? 'bg-primary text-white' : 'bg-white dark:bg-slate-700'} px-3 py-2 rounded-xl ${isMe ? 'rounded-tr-none' : 'rounded-tl-none'} shadow-sm text-xs max-w-[85%]">
                                    ${msg.text}
                                </div>
                            </div>
                        `;
                    }
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        window.confirmOrder = (method) => {
            const phone = document.getElementById('ord-phone').value;
            const gov = document.getElementById('ord-gov').value;
            const city = document.getElementById('ord-city').value;
            const address = document.getElementById('ord-address').value;
            
            if(!phone || !gov || !city || !address) return showToast("يرجى إكمال جميع البيانات", "e");
            
            // Req 2: Fallback Phone
            const sellerPhone = state.currentItem.phone || (state.currentAuthor ? state.currentAuthor.phone : '');
            
            let msg = `*طلب جديد* 🛍️\n`;
            msg += `*المنتج:* ${state.currentItem.title}\n`;
            msg += `*السعر:* ${state.currentItem.price}\n`;
            
            let totalQty = 0;
            state.orderItems.forEach((item, idx) => {
                if(item.qty > 0) {
                    msg += `- طلب #${idx+1}: عدد ${item.qty} | مقاس: ${item.size || '-'} | لون: ${item.color || '-'}\n`;
                    totalQty += item.qty;
                }
            });
            
            if(totalQty === 0) return showToast("يرجى إضافة قطعة واحدة على الأقل", "e");

            msg += `\n*الإجمالي:* ${(totalQty * state.currentItem.price).toLocaleString()} ج.م\n`;
            msg += `*العميل:* ${state.userData ? state.userData.name : 'ضيف'}\n`;
            msg += `*العنوان:* ${gov} - ${city} - ${address}\n`;
            msg += `*ت:* ${phone}\n`;
            
            if(method === 'whatsapp') {
                if(!sellerPhone) return showToast("لا يوجد رقم واتساب", "e");
                const url = `https://wa.me/20${sellerPhone}?text=${encodeURIComponent(msg + `\n${window.location.origin}${window.location.pathname}?product_id=${state.currentItem.id}`)}`;
                window.open(url, '_blank');
            } else {
                // Req 9: Order via Chat
                if(!state.user) return showToast("يجب تسجيل الدخول", "e");
                // Logic to find/create chat with author and send message
                startChatWithAuthor(state.currentItem.authorId, msg, Array.isArray(state.currentItem.images) ? state.currentItem.images[0] : state.currentItem.image);
            }
            toggleOrderModal();
        }

        async function startChatWithAuthor(authorId, text, image) {
            // Check if chat exists
            const q = query(collection(db, "chats"), where("participants", "array-contains", state.user.uid));
            const snap = await getDocs(q);
            let chatId = null;
            
            snap.forEach(doc => {
                if(doc.data().participants.includes(authorId)) chatId = doc.id;
            });

            if(!chatId) {
                const ref = await addDoc(collection(db, "chats"), {
                    participants: [state.user.uid, authorId],
                    lastMessage: "طلب منتج جديد",
                    lastUpdated: serverTimestamp(),
                    read: false,
                    lastSenderId: state.user.uid
                });
                chatId = ref.id;
            }

            await addDoc(collection(db, `chats/${chatId}/messages`), {
                text: text,
                image: image,
                type: 'order',
                senderId: state.user.uid,
                timestamp: serverTimestamp()
            });
            
            showToast("تم إرسال الطلب للمسوق");
            openPrivateChat(chatId, authorId, state.currentAuthor?.name || 'المسوق', state.currentAuthor?.image);
        }

        // Support Floating Button Logic
        window.toggleSupportChat = () => {
            toggleModal('support-chat-modal');
            // Load support chat logic (similar to regular chat but with admin ID or special collection)
        }

        lucide.createIcons();
    </script>
</body>
</html>
