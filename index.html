<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>ุงูุณูู ููุงู | ุงููุชุฌุฑ ุงูุดุงูู</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ุงูุณูู ููุงู">
    <link id="manifest-link" rel="manifest">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { 
                extend: { 
                    colors: { 
                        navy: '#0f172a', 
                        darkbg: '#1e293b', 
                        primary: '#10b981', 
                        secondary: '#3b82f6' 
                    },
                    fontFamily: {
                        cairo: ['Cairo', 'sans-serif']
                    },
                    zIndex: {
                        '60': '60',
                        '70': '70',
                        '80': '80',
                        '90': '90',
                        '100': '100',
                        'modal': '200',
                        'splash': '9999'
                    }
                } 
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { 
            font-family: 'Cairo', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 80px;
            overscroll-behavior-y: none;
            background-color: #f8fafc;
        }
        .dark body { background-color: #0f172a; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .select-none { user-select: none; }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #000000; border-radius: 10px; }
        .dark .custom-scroll::-webkit-scrollbar-thumb { background: #ffffff; }

        @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
        .skeleton { animation: shimmer 2s infinite linear; background: linear-gradient(to right, #f1f5f9 4%, #e2e8f0 25%, #f1f5f9 36%); background-size: 1000px 100%; }
        .dark .skeleton { background: linear-gradient(to right, #1e293b 4%, #334155 25%, #1e293b 36%); }

        @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-pop { animation: popIn 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        /* STRICT MODAL LAYERING */
        .modal-overlay { 
            position: fixed; inset: 0; 
            background-color: rgba(0,0,0,0.6); 
            backdrop-filter: blur(2px);
            display: flex; align-items: flex-end; /* Mobile: Bottom sheet style */
            justify-content: center; 
            z-index: 200; /* High Z-Index */
        }
        .modal-overlay.hidden { display: none !important; }

        .mobile-full-modal { 
            width: 100%; height: 100%; 
            background-color: white; 
            display: flex; flex-direction: column; 
            z-index: 201; /* Content above overlay */
        }
        .dark .mobile-full-modal { background-color: #0f172a; }

        @media (min-width: 768px) { 
            .modal-overlay { align-items: center; }
            .mobile-full-modal { 
                width: 100%; max-width: 28rem; height: 600px; max-height: 85vh; 
                border-radius: 1.5rem; overflow: hidden; 
            } 
        }

        /* Specific Z-Index Fixes */
        #details-modal { z-index: 200; }
        #profile-modal { z-index: 210; } /* Profile ABOVE Details */
        #splash-screen { z-index: 9999; } /* Splash ABOVE ALL */
        
        header { z-index: 50; }
        nav { z-index: 60; }
        #search-container { z-index: 40; }

        /* Toast */
        @keyframes slideInDown { from { transform: translate(-50%, -100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .toast { 
            animation: slideInDown 0.3s forwards; 
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10000;
            width: max-content; max-width: 90vw; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        }
        .toast.hiding { animation: fadeOut 0.2s forwards; }

        /* Inputs */
        .form-input { 
            width: 100%; background-color: #ffffff; border: 1px solid #000000 !important; border-radius: 0.5rem; 
            padding: 0 0.5rem; height: 2.5rem; display: flex; align-items: center; font-size: 0.8rem; font-weight: 600; 
            color: #1e293b; outline: none; transition: all 0.2s; 
        }
        .form-input:disabled { background-color: #f1f5f9; color: #94a3b8; border-color: #cbd5e1 !important; }
        .dark .form-input { background-color: #1e293b; border-color: #94a3b8 !important; color: white; }
        .dark .form-input:disabled { background-color: #334155; }
        .form-input:focus { border-color: #10b981 !important; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1); }

        select.form-input { appearance: none; background: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E") left 0.5rem center no-repeat; background-size: 1.5em; padding-left: 2rem; }
        textarea.form-input { height: auto; padding-top: 0.5rem; }

        /* Star Rating */
        .star-rating { display: flex; flex-direction: row-reverse; justify-content: flex-end; gap: 2px; }
        .star-rating input { display: none; }
        .star-rating label { cursor: pointer; color: #cbd5e1; font-size: 1.2rem; transition: color 0.2s; }
        .star-rating input:checked ~ label, .star-rating label:hover, .star-rating label:hover ~ label { color: #fbbf24; }

        /* Login View Fixed */
        #login-view { position: fixed; inset: 0; z-index: 100; background-color: #f8fafc; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .dark #login-view { background-color: #0f172a; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-navy dark:text-slate-100 select-none overflow-x-hidden">

    <!-- SPLASH SCREEN -->
    <div id="splash-screen" class="fixed inset-0 bg-navy flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="bg-white/10 p-5 rounded-3xl mb-4 animate-bounce">
            <i data-lucide="shopping-bag" class="w-20 h-20 text-primary"></i>
        </div>
        <h1 class="text-4xl font-black text-white mb-4 tracking-tight">ุงูุณูู <span class="text-primary">ููุงู</span></h1>
        <div class="w-10 h-10 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
        <p class="text-white/50 text-xs mt-4 font-bold">ุฌุงุฑู ุชุญููู ุงูููุชุฌุงุช...</p>
    </div>

    <!-- LOGIN VIEW -->
    <div id="login-view" class="hidden">
        <div class="w-full max-w-md bg-white dark:bg-darkbg p-5 rounded-3xl shadow-2xl border border-slate-200 dark:border-slate-700 flex flex-col max-h-[90vh]">
            <div class="flex flex-col items-center gap-2 mb-4 shrink-0">
                <div class="bg-navy dark:bg-primary text-white p-3 rounded-2xl shadow-lg rotate-3">
                    <i data-lucide="shopping-bag" class="w-6 h-6"></i>
                </div>
                <h1 class="font-black text-xl text-navy dark:text-white">ุงูุณูู <span class="text-primary">ููุงู</span></h1>
            </div>

            <div class="bg-slate-100 dark:bg-slate-800 p-1 rounded-xl flex mb-4 border border-slate-200 dark:border-slate-700 shrink-0">
                <button onclick="setAuthType('login')" id="btn-type-login" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-navy dark:bg-primary text-white shadow-md">ุชุณุฌูู ุฏุฎูู</button>
                <button onclick="setAuthType('signup')" id="btn-type-signup" class="flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:text-navy dark:hover:text-white">ุฅูุดุงุก ุญุณุงุจ</button>
            </div>

            <div class="bg-slate-100 dark:bg-slate-800 p-1 rounded-xl flex mb-4 border border-slate-200 dark:border-slate-700 shrink-0">
                <button onclick="setAuthRole('customer')" id="btn-role-customer" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-navy text-white shadow-md"><div class="flex items-center justify-center gap-2"><i data-lucide="user" class="w-3 h-3"></i> ุนููู</div></button>
                <button onclick="setAuthRole('marketer')" id="btn-role-marketer" class="flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:bg-white dark:hover:bg-slate-700"><div class="flex items-center justify-center gap-2"><i data-lucide="store" class="w-3 h-3"></i> ููุฏู ุฎุฏูุฉ</div></button>
            </div>

            <div class="login-scroll overflow-y-auto custom-scroll space-y-3 flex-1 px-1">
                <div id="auth-image-field" class="hidden flex-col items-center gap-2 transition-all duration-300">
                    <div class="relative group cursor-pointer">
                        <input type="file" id="auth-img-input" accept="image/*" onchange="handleAuthImage(this)" class="absolute inset-0 opacity-0 z-10 cursor-pointer">
                        <div class="w-20 h-20 rounded-full bg-slate-50 dark:bg-slate-800 border-2 border-dashed border-primary/50 flex items-center justify-center overflow-hidden relative hover:bg-primary/5 transition">
                            <img id="auth-img-preview" src="" class="w-full h-full object-cover hidden">
                            <div id="auth-img-placeholder" class="flex flex-col items-center text-slate-400"><i data-lucide="camera" class="w-6 h-6 mb-1"></i><span class="text-[9px] font-bold">ุตูุฑุฉ</span></div>
                        </div>
                        <div class="absolute bottom-0 right-0 bg-navy dark:bg-primary text-white p-1 rounded-full shadow-sm pointer-events-none"><i data-lucide="plus" class="w-3 h-3"></i></div>
                    </div>
                </div>

                <div>
                    <label class="form-label">ุงุณู ุงููุณุชุฎุฏู (ุฅูุฌููุฒู)</label>
                    <div class="relative"><input id="auth-username" type="text" class="form-input text-left" placeholder="username" style="direction: ltr;"><i data-lucide="at-sign" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i></div>
                </div>

                <div>
                    <label class="form-label">ูููุฉ ุงููุฑูุฑ</label>
                    <div class="relative"><input id="auth-pass" type="password" class="form-input" placeholder="******"><i data-lucide="lock" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i></div>
                </div>

                <div id="signup-fields" class="hidden space-y-3 border-t border-slate-100 dark:border-slate-700 pt-3 mt-2">
                    <div><label class="form-label">ุงูุงุณู ุงููุงูู (ุนุฑุจู)</label><input id="auth-name-ar" type="text" class="form-input" placeholder="ูุซุงู: ุฃุญูุฏ ูุญูุฏ"></div>
                    <div><label class="form-label">ุฑูู ุงููุงุชู</label><input id="auth-phone" type="tel" class="form-input" placeholder="01xxxxxxxxx"></div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="form-label">ุงููุญุงูุธุฉ</label><select id="auth-gov" onchange="updateCities()" class="form-input text-xs"></select></div>
                        <div><label class="form-label">ุงููุฑูุฒ/ุงููุฏููุฉ</label><select id="auth-city" class="form-input text-xs"><option value="">ุงุฎุชุฑ ุงููุญุงูุธุฉ</option></select></div>
                    </div>
                    <div><label class="form-label">ุงูุนููุงู ุจุงูุชูุตูู</label><input id="auth-address" type="text" class="form-input" placeholder="ุงูุดุงุฑุนุ ุฑูู ุงูููุฒู..."></div>
                </div>
            </div>

            <div class="mt-4 pt-2 border-t border-slate-100 dark:border-slate-700 shrink-0">
                <button onclick="processAuth()" id="btn-auth-action" class="w-full bg-navy dark:bg-primary text-white py-3 rounded-xl font-bold shadow-lg shadow-navy/20 hover:opacity-90 transition-all active:scale-95 flex justify-center items-center gap-2 text-sm"><span>ุฏุฎูู ููุญุณุงุจ</span> <i data-lucide="arrow-left" class="w-4 h-4"></i></button>
                <div id="auth-error" class="text-red-600 dark:text-red-400 text-[10px] font-bold text-center hidden bg-red-50 dark:bg-red-900/20 p-2 rounded-lg border border-red-200 dark:border-red-800 mt-2 break-words" dir="ltr"></div>
            </div>
        </div>
    </div>

    <!-- MAIN APP CONTENT -->
    <div id="app-content" class="hidden">
        <div id="toast-container" class="fixed top-4 left-0 right-0 z-[10000] flex flex-col items-center gap-2 pointer-events-none px-4"></div>

        <header class="fixed top-0 w-full bg-white/95 dark:bg-navy/95 border-b border-slate-200 dark:border-slate-700 flex flex-col justify-center px-4 shadow-sm backdrop-blur-md h-12">
            <div class="flex items-center justify-between w-full">
                <div class="flex items-center gap-2" id="logo-trigger">
                    <div class="bg-navy dark:bg-primary text-white p-1 rounded-md"><i data-lucide="shopping-bag" class="w-4 h-4"></i></div>
                    <div class="flex flex-col leading-none">
                        <h1 class="font-bold text-sm">ุงูุณูู <span class="text-primary">ููุงู</span></h1>
                        <div id="welcome-text" class="hidden text-[10px] font-bold mt-0.5"><span class="text-navy dark:text-white">ุฃููุงู: </span><span id="header-username" class="text-primary"></span></div>
                    </div>
                </div>
                <div class="flex gap-1.5 items-center">
                    <button onclick="toggleProfile(state.user ? state.user.uid : null)" class="p-1.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-white hover:bg-slate-200 transition"><i data-lucide="user" class="w-4 h-4"></i></button>
                    <button onclick="toggleDarkMode()" class="p-1.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-yellow-400 hover:bg-slate-200 transition"><i data-lucide="moon" class="w-4 h-4 block dark:hidden"></i><i data-lucide="sun" class="w-4 h-4 hidden dark:block"></i></button>
                    <button onclick="toggleAdminPanel()" id="btn-admin-top" class="hidden bg-slate-100 dark:bg-slate-800 p-1.5 rounded-full text-slate-600 dark:text-white"><i data-lucide="shield" class="w-4 h-4"></i></button>
                    <button onclick="logout()" class="p-1.5 rounded-full bg-slate-100 dark:bg-slate-800 text-red-600 hover:bg-red-100 transition"><i data-lucide="log-out" class="w-4 h-4"></i></button>
                </div>
            </div>
        </header>

        <main class="pt-14 container mx-auto px-4 max-w-6xl min-h-screen">
            <div id="view-header" class="hidden flex items-center gap-2 pb-1">
                <button onclick="switchToHomeView()" class="bg-white dark:bg-slate-800 p-1.5 rounded-full border border-slate-200 dark:border-slate-700 shadow-sm"><i data-lucide="arrow-right" class="w-4 h-4 text-slate-600 dark:text-white"></i></button>
                <h2 id="view-title" class="text-base font-bold text-slate-800 dark:text-white pt-0.5"></h2>
            </div>

            <div id="search-container" class="sticky top-12 bg-slate-50/95 dark:bg-navy/95 backdrop-blur-lg pt-1.5 pb-1.5 -mx-4 px-4 transition-all">
                <div class="relative max-w-3xl mx-auto flex gap-2 items-center">
                    <div class="relative flex-1">
                        <input type="text" id="search-input" oninput="handleSearch()" placeholder="ุงุจุญุซ..." class="w-full form-input pr-9 pl-20 h-9 shadow-sm text-xs">
                        <i data-lucide="search" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                        <div class="absolute left-2 top-1/2 -translate-y-1/2 flex items-center gap-1 z-10">
                            <button id="btn-filter-toggle" onclick="toggleFilterPanel()" class="hidden text-secondary dark:text-blue-400 p-1 hover:scale-110 transition"><i data-lucide="sliders-horizontal" class="w-4 h-4"></i></button>
                            <button onclick="toggleFavView()" class="relative text-red-500 p-1 hover:scale-110 transition"><i data-lucide="heart" class="w-4 h-4"></i><span id="fav-count" class="absolute top-0 right-0 w-1.5 h-1.5 bg-red-600 rounded-full border border-white dark:border-darkbg hidden"></span></button>
                        </div>
                    </div>
                </div>
                <div id="filter-panel" class="hidden mt-1 bg-white dark:bg-darkbg p-2 rounded-xl border border-slate-200 dark:border-slate-700 shadow-xl animate-pop relative z-50">
                    <div class="flex justify-between items-center mb-1"><span class="font-bold text-[10px]">ุชุตููุฉ ุงููุชุงุฆุฌ</span><button onclick="resetFilters()" class="text-[10px] text-red-500 font-bold underline cursor-pointer p-1">ุฅุนุงุฏุฉ ุชุนููู</button></div>
                    <div class="grid grid-cols-2 gap-2">
                        <select id="filter-gov" onchange="applyFilters()" class="form-input text-xs h-8"><option value="">ูู ุงููุญุงูุธุงุช</option></select>
                        <select id="filter-price" onchange="applyFilters()" class="form-input text-xs h-8"><option value="">ูู ุงูุฃุณุนุงุฑ</option><option value="low">ุงูุฃูู ุณุนุฑุงู</option><option value="high">ุงูุฃุนูู ุณุนุฑุงู</option></select>
                    </div>
                </div>
            </div>

            <div id="categories-container" class="hidden justify-start gap-2 overflow-x-auto pt-1 pb-2 no-scrollbar"></div>
            <div id="grid-container" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 pb-10 mt-2"></div>
            <div id="empty-state" class="hidden text-center py-20 opacity-60 flex-col items-center"><div class="bg-slate-200 dark:bg-slate-800 p-4 rounded-full inline-block mb-2"><i data-lucide="shirt" class="w-8 h-8 text-slate-400"></i></div><p class="text-slate-500 dark:text-slate-400 font-bold text-sm">ูุง ุชูุฌุฏ ูุชุงุฆุฌ</p><button onclick="resetFilters()" class="mt-2 text-primary text-xs font-bold underline">ุฅุนุงุฏุฉ ุชุนููู</button></div>
        </main>

        <nav class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-white/90 dark:bg-slate-800/90 border border-slate-200 dark:border-slate-600 px-6 py-2 rounded-full flex items-center gap-8 shadow-lg transform transition-all hover:scale-105">
            <button onclick="switchToHomeView()" class="flex flex-col items-center gap-1 text-slate-500 dark:text-slate-400 hover:text-navy dark:hover:text-white transition group"><i data-lucide="home" class="w-5 h-5 group-hover:scale-110 transition"></i></button>
            <button id="nav-add-btn" onclick="toggleAddModal()" class="w-12 h-12 bg-navy dark:bg-primary text-white rounded-full flex items-center justify-center shadow-lg shadow-slate-900/20 transform -translate-y-5 border-4 border-slate-50 dark:border-navy hover:scale-110 transition active:scale-90"><i data-lucide="plus" class="w-6 h-6"></i></button>
            <button onclick="toggleChat()" class="flex flex-col items-center gap-1 text-slate-500 dark:text-slate-400 hover:text-navy dark:hover:text-white transition group relative"><div id="chat-badge" class="hidden absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border border-white dark:border-slate-800"></div><i data-lucide="message-circle" class="w-5 h-5 group-hover:scale-110 transition"></i></button>
        </nav>
    </div>

    <!-- PROFILE MODAL (Z-Index 210) -->
    <div id="profile-modal" class="hidden modal-overlay">
        <div class="mobile-full-modal animate-pop border border-slate-200 dark:border-slate-700">
            <div class="bg-navy dark:bg-primary p-3 text-white flex justify-between items-center shrink-0">
                <h3 class="font-bold text-sm">ุงูููู ุงูุดุฎุตู</h3>
                <button onclick="toggleProfile()" class="bg-red-500 hover:bg-red-600 p-1.5 rounded-full text-white shadow-sm"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 bg-white dark:bg-darkbg custom-scroll">
                <div class="flex flex-col items-center gap-3 mb-6 relative">
                    <div class="relative">
                        <div id="prof-img-container" class="w-24 h-24 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center overflow-hidden border-4 border-primary shadow-lg">
                            <i data-lucide="user" class="w-10 h-10 text-slate-400"></i>
                        </div>
                        <label id="btn-edit-img" class="hidden absolute bottom-0 right-0 bg-navy text-white p-1.5 rounded-full cursor-pointer shadow-md">
                            <input type="file" accept="image/*" class="hidden" onchange="updateProfileImage(this)">
                            <i data-lucide="camera" class="w-3 h-3"></i>
                        </label>
                    </div>
                    <div class="text-center w-full">
                        <div class="flex items-center justify-center gap-2">
                            <h2 id="prof-name" class="font-black text-xl text-navy dark:text-white">...</h2>
                            <button id="btn-edit-profile" onclick="enableEditMode()" class="hidden text-primary"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                        </div>
                        <span id="prof-role" class="text-xs bg-slate-100 dark:bg-slate-700 px-3 py-1 rounded-full text-slate-500 dark:text-slate-300 font-bold mt-1 inline-block">...</span>
                    </div>
                </div>

                <div class="space-y-3 mb-6">
                    <div class="bg-slate-100 dark:bg-slate-800 p-3 rounded-xl border border-slate-200 dark:border-slate-700">
                        <label class="form-label text-slate-400">ุงูุงุณู</label>
                        <input id="in-prof-name" type="text" disabled class="form-input border-none bg-transparent !shadow-none !p-0 h-auto text-sm font-bold text-navy dark:text-white">
                    </div>
                    <div class="bg-slate-100 dark:bg-slate-800 p-3 rounded-xl border border-slate-200 dark:border-slate-700">
                        <label class="form-label text-slate-400">ุฑูู ุงููุงุชู</label>
                        <input id="in-prof-phone" type="tel" disabled class="form-input border-none bg-transparent !shadow-none !p-0 h-auto text-sm font-bold text-navy dark:text-white">
                    </div>
                    <div class="bg-slate-100 dark:bg-slate-800 p-3 rounded-xl border border-slate-200 dark:border-slate-700">
                        <label class="form-label text-slate-400">ุงูุนููุงู</label>
                        <input id="in-prof-address" type="text" disabled class="form-input border-none bg-transparent !shadow-none !p-0 h-auto text-sm font-bold text-navy dark:text-white">
                    </div>
                    
                    <button id="btn-save-profile" onclick="saveProfile()" class="hidden w-full bg-primary text-white py-2 rounded-xl font-bold shadow-lg">ุญูุธ ุงูุชุบููุฑุงุช</button>

                    <div id="prof-password-section" class="hidden bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border border-slate-100 dark:border-slate-700 mt-4">
                        <label class="form-label text-slate-400">ุชุบููุฑ ูููุฉ ุงููุฑูุฑ</label>
                        <div class="flex gap-2">
                            <input id="new-password" type="password" class="form-input text-xs" placeholder="ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ">
                            <button onclick="changePassword()" class="bg-navy dark:bg-primary text-white px-3 py-1 rounded-lg text-xs font-bold whitespace-nowrap">ุชุญุฏูุซ</button>
                        </div>
                    </div>
                </div>

                <div id="prof-reviews-section" class="hidden">
                    <h3 class="font-bold text-sm text-navy dark:text-white mb-3 border-b pb-2 border-slate-100 dark:border-slate-700">ุขุฑุงุก ุงูุนููุงุก</h3>
                    <div id="prof-reviews-list" class="space-y-3"></div>
                    <button id="prof-reviews-more" onclick="loadProfileReviews(true)" class="hidden w-full text-center text-xs text-primary font-bold mt-2 py-2">ุนุฑุถ ุงููุฒูุฏ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- DETAILS MODAL (Z-Index 200) -->
    <div id="details-modal" class="hidden modal-overlay">
        <div class="mobile-full-modal animate-pop border border-slate-200 dark:border-slate-700">
            <div class="relative h-72 bg-gray-100 dark:bg-slate-800 shrink-0 group">
                <button onclick="closeDetails()" class="absolute top-3 left-3 bg-white/80 dark:bg-black/50 text-slate-800 dark:text-white p-1.5 rounded-full z-20 shadow-sm"><i data-lucide="x" class="w-5 h-5"></i></button>
                <div class="absolute top-3 right-3 flex gap-2 z-20">
                    <button onclick="copyDetails()" class="bg-white/80 dark:bg-black/50 text-slate-800 dark:text-white p-1.5 rounded-full shadow-sm hover:bg-white hover:text-primary transition"><i data-lucide="copy" class="w-5 h-5"></i></button>
                    <button onclick="shareListing()" class="bg-white/80 dark:bg-black/50 text-slate-800 dark:text-white p-1.5 rounded-full shadow-sm"><i data-lucide="share-2" class="w-5 h-5"></i></button>
                </div>
                <div id="details-slider-container" class="w-full h-full flex items-center justify-center bg-gray-100 dark:bg-slate-800">
                    <img id="details-img" src="" class="w-full h-full object-cover cursor-pointer" onclick="openLightbox(this.src)">
                </div>
                <div id="details-arrows"><button onclick="scrollDetails(1)" class="absolute left-2 top-1/2 -translate-y-1/2 bg-black/30 text-white p-1 rounded-full z-10"><i data-lucide="chevron-left" class="w-5 h-5"></i></button><button onclick="scrollDetails(-1)" class="absolute right-2 top-1/2 -translate-y-1/2 bg-black/30 text-white p-1 rounded-full z-10"><i data-lucide="chevron-right" class="w-5 h-5"></i></button></div>
                <div id="details-dots" class="absolute bottom-3 left-1/2 -translate-x-1/2 z-20 flex gap-1.5"></div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 bg-white dark:bg-darkbg custom-scroll">
                <div id="d-pub-bar" class="flex items-center justify-between mb-2 p-1.5 bg-slate-100 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 h-auto cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-700/80 transition">
                     <div class="flex items-center gap-2">
                         <div id="d-pub-img" class="w-7 h-7 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center overflow-hidden"><i data-lucide="user" class="w-3 h-3 text-slate-400"></i></div>
                         <div class="flex flex-col justify-center">
                             <h4 id="d-pub-name" class="font-bold text-[10px] text-navy dark:text-white leading-tight">...</h4>
                             <span class="text-[8px] text-slate-400">ุงููุงุดุฑ (ุงุถุบุท ููุนุฑุถ)</span>
                         </div>
                     </div>
                     <div id="d-shipping-info" class="flex flex-wrap items-center gap-1 text-[9px] font-bold text-slate-500 bg-white dark:bg-slate-700 px-1.5 py-0.5 rounded border border-slate-200 dark:border-slate-600 max-w-[55%] justify-end leading-tight"></div>
                </div>

                <div class="bg-slate-100 dark:bg-slate-800 p-3 rounded-xl mb-3 border border-slate-200 dark:border-slate-700">
                    <div class="flex justify-between items-start mb-2"><h2 id="d-title" class="text-base font-bold text-slate-900 dark:text-white leading-snug w-3/4 select-text"></h2><span id="d-price" class="text-primary font-black text-lg whitespace-nowrap select-text"></span></div>
                    <div class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400 pb-2 border-b border-slate-200 dark:border-slate-600"><span id="d-cat" class="bg-white dark:bg-slate-700 px-2 py-0.5 rounded text-[10px] border border-slate-200 dark:border-slate-600"></span> <span id="d-cond" class="bg-white dark:bg-slate-700 px-2 py-0.5 rounded text-[10px] border border-slate-200 dark:border-slate-600 font-bold"></span></div>
                </div>
                
                <div id="d-variants-container" class="space-y-2 mb-4 bg-slate-100 dark:bg-slate-800 p-3 rounded-xl border border-slate-200 dark:border-slate-700">
                    <div id="d-sizes-row" class="hidden flex flex-wrap items-center gap-2">
                        <span class="text-[10px] font-bold text-slate-400 shrink-0">ุงูููุงุณุงุช:</span>
                        <div id="d-sizes-list" class="flex flex-wrap gap-1"></div>
                    </div>
                    <div id="d-colors-row" class="hidden flex flex-wrap items-center gap-2">
                        <span class="text-[10px] font-bold text-slate-400 shrink-0">ุงูุฃููุงู:</span>
                        <div id="d-colors-list" class="flex flex-wrap gap-1"></div>
                    </div>
                </div>

                <div id="d-features" class="flex flex-wrap gap-2 mb-4"></div>

                <div class="space-y-1 mb-6 bg-slate-100 dark:bg-slate-800 p-3 rounded-xl border border-slate-200 dark:border-slate-700"><h3 class="text-xs font-bold text-slate-900 dark:text-slate-200 uppercase tracking-wider">ุงููุตู</h3><p id="d-desc" class="text-xs text-slate-600 dark:text-slate-300 leading-relaxed whitespace-pre-wrap font-medium select-text"></p></div>

                <div class="border-t border-slate-100 dark:border-slate-700 pt-4">
                    <h3 class="text-xs font-bold text-slate-900 dark:text-white mb-3">ุงูุชููููุงุช</h3>
                    <div id="add-review-form" class="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl mb-4 border border-slate-100 dark:border-slate-700">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] font-bold">ุฃุถู ุชููููู</span>
                            <div class="star-rating text-lg">
                                <input type="radio" id="star5" name="rating" value="5" onclick="setRating(5)"><label for="star5">โ</label>
                                <input type="radio" id="star4" name="rating" value="4" onclick="setRating(4)"><label for="star4">โ</label>
                                <input type="radio" id="star3" name="rating" value="3" onclick="setRating(3)"><label for="star3">โ</label>
                                <input type="radio" id="star2" name="rating" value="2" onclick="setRating(2)"><label for="star2">โ</label>
                                <input type="radio" id="star1" name="rating" value="1" onclick="setRating(1)"><label for="star1">โ</label>
                            </div>
                        </div>
                        <textarea id="review-text" class="form-input text-xs w-full mb-2" rows="2" placeholder="ุงูุชุจ ุฑุฃูู ููุง..."></textarea>
                        <button onclick="submitProductReview()" class="bg-navy dark:bg-primary text-white px-3 py-1.5 rounded-lg text-xs font-bold w-full">ูุดุฑ ุงูุชูููู</button>
                    </div>
                    <div id="product-reviews-list" class="space-y-3"></div>
                    <button id="load-more-reviews" onclick="loadProductReviews(true)" class="hidden w-full text-center text-xs text-primary font-bold mt-2 py-2">ุนุฑุถ ุงููุฒูุฏ</button>
                </div>
            </div>
            <div class="p-3 border-t border-slate-100 dark:border-slate-700 bg-white dark:bg-darkbg flex gap-2 shrink-0 pb-8 md:pb-3"><a id="d-wa" href="#" target="_blank" class="flex-1 bg-[#25D366] text-white py-2.5 rounded-xl flex justify-center items-center gap-2 font-bold shadow-lg hover:opacity-90 transition text-sm"><i data-lucide="message-circle" class="w-4 h-4"></i> ูุงุชุณุงุจ</a><a id="d-call" href="#" class="flex-1 bg-navy dark:bg-primary text-white py-2.5 rounded-xl flex justify-center items-center gap-2 font-bold shadow-lg hover:opacity-90 transition text-sm"><i data-lucide="phone" class="w-4 h-4"></i> ุงุชุตุงู</a></div>
        </div>
    </div>

    <!-- ADD MODAL -->
    <div id="add-modal" class="hidden modal-overlay">
        <div class="mobile-full-modal animate-pop border border-slate-200 dark:border-slate-700">
            <div class="p-3 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800 shrink-0 h-12">
                <h3 class="font-bold text-slate-800 dark:text-white text-sm">ุฅุถุงูุฉ ููุชุฌ</h3>
                <button onclick="toggleAddModal()" class="bg-white dark:bg-slate-700 p-1 rounded-full border border-slate-200 dark:border-slate-600 text-slate-500 dark:text-white hover:text-red-500"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-3 space-y-2 bg-white dark:bg-darkbg custom-scroll">
                <div class="form-group"><span class="form-label">ุงูุตูุฑ (max 7)</span><div class="grid grid-cols-4 gap-2"><label class="aspect-square border-2 border-dashed border-primary/40 bg-primary/5 dark:bg-primary/10 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:border-primary hover:bg-primary/10 transition text-primary relative overflow-hidden group"><input type="file" multiple accept="image/*" onchange="handleUpload(this)" class="absolute inset-0 opacity-0 z-10"><i data-lucide="camera" class="w-5 h-5 mb-1 group-hover:scale-110 transition"></i><span class="text-[9px] font-bold">ุฅุถุงูุฉ</span></label><div id="preview-area" class="col-span-3 flex gap-2 overflow-x-auto no-scrollbar items-center"></div></div></div>
                <div class="grid grid-cols-2 gap-2"><div class="form-group"><label class="form-label">ุงุณู ุงูููุชุฌ</label><input id="in-title" class="form-input h-9 text-xs" placeholder="ุงุณู ุงูููุชุฌ..."></div><div class="form-group"><label class="form-label">ุงูุณุนุฑ</label><input id="in-price" type="number" class="form-input h-9 text-xs" placeholder="0"></div></div>
                <div class="grid grid-cols-2 gap-2"><div class="form-group"><label class="form-label">ุงููุณู</label><select id="in-cat" onchange="updateFormFields()" class="form-input h-9 text-xs bg-gray-50"></select></div><div id="field-condition" class="form-group hidden"><label class="form-label">ุงูุญุงูุฉ</label><select id="in-condition" class="form-input h-9 text-xs"><option value="new">ุฌุฏูุฏ</option><option value="used">ูุณุชุนูู</option><option value="openbox">ูุณุฑ ุฒูุฑู</option></select></div></div>
                <div id="dynamic-fields" class="bg-slate-50 dark:bg-slate-800/50 p-2 rounded-lg border border-slate-100 dark:border-slate-700 form-group space-y-2 hidden"><div id="field-size-chips" class="hidden"><label class="form-label text-primary">ุงูููุงุณุงุช ุงููุชุงุญุฉ</label><div id="size-chips-container" class="flex flex-wrap gap-1.5"></div></div><div id="field-color-chips" class="hidden"><label class="form-label text-primary">ุงูุฃููุงู ุงููุชุงุญุฉ</label><div id="color-chips-container" class="flex flex-wrap gap-1.5"></div></div></div>
                <div class="form-group bg-slate-50 dark:bg-slate-800/50 p-2 rounded-lg border border-slate-100 dark:border-slate-700"><label class="form-label mb-1">ุฃูุงูู ุงูุดุญู</label><div class="flex gap-2 mb-2"><label class="flex-1 cursor-pointer"><input type="radio" name="ship-mode" value="all" onchange="toggleShipGov()" checked class="hidden peer"><div class="text-center py-1.5 rounded-lg border border-slate-300 dark:border-slate-600 text-[10px] font-bold text-slate-500 peer-checked:border-primary peer-checked:text-primary peer-checked:bg-white dark:peer-checked:bg-slate-700 transition">ูู ุงููุญุงูุธุงุช</div></label><label class="flex-1 cursor-pointer"><input type="radio" name="ship-mode" value="specific" onchange="toggleShipGov()" class="hidden peer"><div class="text-center py-1.5 rounded-lg border border-slate-300 dark:border-slate-600 text-[10px] font-bold text-slate-500 peer-checked:border-primary peer-checked:text-primary peer-checked:bg-white dark:peer-checked:bg-slate-700 transition">ูุญุงูุธุงุช ูุญุฏุฏุฉ</div></label></div><div id="ship-gov-container" class="hidden"><div class="text-[10px] mb-1 text-slate-400">ุงุฎุชุฑ ุงููุญุงูุธุงุช ุงููุชุงุญุฉ:</div><div id="ship-gov-list" class="max-h-24 overflow-y-auto custom-scroll grid grid-cols-2 gap-1 p-1 bg-white dark:bg-darkbg border border-slate-200 dark:border-slate-600 rounded-lg"></div></div></div>
                <div class="form-group"><label class="form-label">ููุงุตูุงุช ุฅุถุงููุฉ:</label><div class="flex flex-wrap gap-1.5"><label class="cursor-pointer"><input type="checkbox" class="chip-checkbox hidden" value="ุฃุตูู"><div class="border border-slate-300 dark:border-slate-600 rounded-lg px-2 py-1 text-[10px] font-bold text-slate-500 dark:text-slate-400 transition hover:bg-slate-100">ุฃุตูู</div></label><label class="cursor-pointer"><input type="checkbox" class="chip-checkbox hidden" value="ูุงู ููุจู"><div class="border border-slate-300 dark:border-slate-600 rounded-lg px-2 py-1 text-[10px] font-bold text-slate-500 dark:text-slate-400 transition hover:bg-slate-100">ูุงู ููุจู</div></label><label class="cursor-pointer"><input type="checkbox" class="chip-checkbox hidden" value="ุถูุงู"><div class="border border-slate-300 dark:border-slate-600 rounded-lg px-2 py-1 text-[10px] font-bold text-slate-500 dark:text-slate-400 transition hover:bg-slate-100">ุถูุงู</div></label><label class="cursor-pointer"><input type="checkbox" class="chip-checkbox hidden" value="ุชูุตูู"><div class="border border-slate-300 dark:border-slate-600 rounded-lg px-2 py-1 text-[10px] font-bold text-slate-500 dark:text-slate-400 transition hover:bg-slate-100">ุชูุตูู</div></label></div></div>
                <div class="form-group"><label class="form-label">ุชูููุฒ:</label><div class="flex gap-2 p-1 bg-slate-100 dark:bg-slate-800 rounded-lg"><label class="flex-1 cursor-pointer text-center"><input type="radio" name="badge" value="none" checked class="hidden peer"><div class="text-center py-1 rounded-md text-[10px] font-bold text-slate-500 peer-checked:bg-white dark:peer-checked:bg-slate-700 peer-checked:shadow-sm peer-checked:text-navy dark:peer-checked:text-white transition">ุนุงุฏู</div></label><label class="flex-1 cursor-pointer text-center"><input type="radio" name="badge" value="hot" class="hidden peer"><div class="text-center py-1 rounded-md text-[10px] font-bold text-slate-500 peer-checked:bg-orange-500 peer-checked:text-white transition">๐ฅ ุนุฑุถ</div></label></div></div>
                <div class="grid grid-cols-3 gap-2"><div class="form-group col-span-1"><label class="form-label">ุฑูู ุงููุงุชู</label><input id="in-phone" type="tel" class="form-input h-9 text-xs" placeholder="01xxxxxxxxx"></div><div class="form-group col-span-2"><label class="form-label">ุงููุตู</label><textarea id="in-desc" rows="1" class="form-input text-xs" placeholder="ุชูุงุตูู..."></textarea></div></div>
            </div>
            <div class="p-3 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 shrink-0 pb-8 md:pb-3"><button onclick="submitListing()" id="btn-publish" class="w-full bg-navy dark:bg-primary text-white py-3 rounded-xl font-bold text-sm shadow-lg shadow-navy/20 hover:opacity-90 transition flex justify-center items-center gap-2"><span>ูุดุฑ ุงูุขู</span><i data-lucide="arrow-left" class="w-4 h-4"></i></button></div>
        </div>
    </div>

    <!-- CHAT MODAL -->
    <div id="chat-modal" class="hidden modal-overlay">
        <div class="mobile-full-modal animate-pop border border-slate-200 dark:border-slate-700">
            <div class="bg-navy dark:bg-primary p-3 text-white flex justify-between items-center shrink-0">
                <div class="flex items-center gap-2"><div class="bg-white/10 p-1.5 rounded-full"><i data-lucide="bot" class="w-5 h-5 text-yellow-400"></i></div><div><h4 class="font-bold text-xs">ุงูุฏุนู ุงูููู</h4></div></div>
                <div class="flex items-center gap-2"><a href="https://wa.me/201206244875" target="_blank" class="bg-[#25D366] px-2 py-1 rounded-full flex items-center gap-1 text-[10px] font-bold hover:opacity-90 transition"><i data-lucide="message-circle" class="w-3 h-3"></i> 01206244875</a><button onclick="toggleChat()" class="hover:bg-white/20 p-1 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            </div>
            <div id="chat-box" class="flex-1 bg-slate-100 dark:bg-slate-900 p-3 overflow-y-auto space-y-2 text-xs"></div>
            <div class="p-2 bg-white dark:bg-slate-800 border-t dark:border-slate-700 flex items-center gap-2 shrink-0 pb-safe"><input id="chat-msg" type="text" class="flex-1 bg-slate-100 dark:bg-slate-700 border-0 rounded-full px-4 py-3 text-sm outline-none dark:text-white font-bold" placeholder="ุงูุชุจ..."><button onclick="sendMsg()" class="w-8 h-8 bg-navy dark:bg-primary rounded-full text-white flex items-center justify-center shadow"><i data-lucide="send" class="w-4 h-4"></i></button></div>
        </div>
    </div>

    <!-- LIGHTBOX -->
    <div id="lightbox" class="hidden fixed inset-0 bg-black/95 z-[9999] flex flex-col items-center justify-center select-none">
        <button onclick="closeLightbox()" class="absolute top-4 left-4 bg-white/20 text-white p-2 rounded-full z-20"><i data-lucide="x" class="w-6 h-6"></i></button>
        <button onclick="navigateLightbox(-1)" class="absolute left-2 md:left-10 top-1/2 -translate-y-1/2 bg-black/30 text-white p-2 rounded-full z-20 hover:bg-black/50 transition"><i data-lucide="chevron-left" class="w-8 h-8"></i></button>
        <button onclick="navigateLightbox(1)" class="absolute right-2 md:right-10 top-1/2 -translate-y-1/2 bg-black/30 text-white p-2 rounded-full z-20 hover:bg-black/50 transition"><i data-lucide="chevron-right" class="w-8 h-8"></i></button>
        <div class="relative w-full h-full flex items-center justify-center"><img id="lightbox-img" src="" class="max-w-full max-h-[80vh] object-contain"></div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="admin-panel" class="hidden fixed inset-0 bg-navy z-[9999] flex flex-col text-white"><div class="p-3 border-b border-white/10 flex justify-between items-center bg-[#001a38]"><h2 class="font-bold flex items-center gap-2 text-sm"><i data-lucide="shield" class="w-4 h-4 text-primary"></i> ุงูุชุญูู</h2><div class="flex gap-3"><button onclick="refreshAdmin()"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button><button onclick="toggleAdminPanel()"><i data-lucide="x" class="w-5 h-5"></i></button></div></div><div class="flex-1 flex overflow-hidden"><div class="w-1/3 border-l border-white/10 bg-[#001f3f] overflow-y-auto p-2" id="admin-users-list"></div><div class="w-2/3 flex flex-col bg-navy relative"><div id="admin-chat-header" class="h-12 border-b border-white/10 flex items-center justify-between px-3 bg-[#001a38]"><span class="text-xs font-bold">ุงุฎุชุฑ ูุญุงุฏุซุฉ</span><button onclick="kickUser()" id="btn-end-chat" class="hidden bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded flex items-center gap-1"><i data-lucide="slash" class="w-3 h-3"></i> ุฅููุงุก</button></div><div id="admin-msg-area" class="flex-1 p-3 overflow-y-auto space-y-2 text-xs"></div><div class="p-2 border-t border-white/10 flex gap-2 bg-[#001a38]"><input id="admin-input" class="flex-1 bg-white/5 border border-white/20 rounded px-3 py-1.5 text-xs text-white outline-none" placeholder="ุงูุฑุฏ..."><button onclick="sendAdminMsg()" class="bg-primary px-4 py-1.5 rounded text-xs font-bold">ุฅุฑุณุงู</button></div></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp, getDocs, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ... (EGYPT_DATA, PWA Manifest, Firebase Config - Same as before)
        const EGYPT_DATA={"ุงููุงูุฑุฉ":["ูุฏููุฉ ูุตุฑ","ูุตุฑ ุงูุฌุฏูุฏุฉ","ุงููุนุงุฏู","ุงูุชุฌูุน ุงูุฎุงูุณ","ุดุจุฑุง","ุนูู ุดูุณ","ุงููุฑุฌ","ุญููุงู","ูุณุท ุงูุจูุฏ","ุงูุฒูุงูู","ุงููููู","ุงูุนุจุงุณูุฉ","ุงูุฒูุชูู","ุญุฏุงุฆู ุงููุจุฉ","ุงูุณูุฏุฉ ุฒููุจ"],"ุงูุฌูุฒุฉ":["ุงููุฑู","ููุตู","6 ุฃูุชูุจุฑ","ุงูุดูุฎ ุฒุงูุฏ","ุงูุฏูู","ุงููููุฏุณูู","ุงูุนุฌูุฒุฉ","ุฅูุจุงุจุฉ","ุงููุฑุงู","ุจููุงู ุงูุฏูุฑูุฑ","ุงูุนูุฑุงููุฉ","ุงููููุจ","ุงูุจุฏุฑุดูู","ุงูุญูุงูุฏูุฉ","ุงูุตู","ุฃุทููุญ"],"ุงูุฅุณููุฏุฑูุฉ":["ุณููุญุฉ","ููุงูู","ุงูููุชุฒู","ุณูุฏู ุจุดุฑ","ุงูุนุตุงูุฑุฉ","ุงูููุฏุฑุฉ","ูููุชูุฑูุง","ุฌููู","ุณุชุงููู","ุฑุดุฏู","ููุฑ ุนุจุฏู","ูุญุฑู ุจู","ุงูุนุฌูู","ุงูุจูุทุงุด","ุงููุงููููู","ุจุฑุฌ ุงูุนุฑุจ"],"ุงูุฏููููุฉ":["ุงูููุตูุฑุฉ","ุทูุฎุง","ููุช ุบูุฑ","ุฏูุฑูุณ","ุดุฑุจูู","ุงูุณูุจูุงููู","ุฃุฌุง","ุจููุงุณ","ูููุฉ ุงููุตุฑ","ุงููุทุฑูุฉ","ุงูุฌูุงููุฉ","ุจูู ุนุจูุฏ"],"ุงูุดุฑููุฉ":["ุงูุฒูุงุฒูู","ุงูุนุดุฑ ูู ุฑูุถุงู","ูููุง ุงูููุญ","ุจูุจูุณ","ูุงููุณ","ุฃุจู ุญูุงุฏ","ุงูุญุณูููุฉ","ููุฑ ุตูุฑ","ุฃุจู ูุจูุฑ","ุฏูุฑุจ ูุฌู","ูุดุชูู ุงูุณูู","ูููุง"],"ุงููููููุฉ":["ุดุจูู ุงูููู","ูุฏููุฉ ุงูุณุงุฏุงุช","ูููู","ุฃุดููู","ูููุณูุง","ุจุฑูุฉ ุงูุณุจุน","ุชูุง","ุงูุดูุฏุงุก","ุงูุจุงุฌูุฑ","ุณุฑุณ ุงูููุงู"],"ุงูููููุจูุฉ":["ุจููุง","ุดุจุฑุง ุงูุฎููุฉ","ููููุจ","ุงูููุงุทุฑ ุงูุฎูุฑูุฉ","ุงูุฎุงููุฉ","ููุฑ ุดูุฑ","ุทูุฎ","ุงูุนุจูุฑ","ุดุจูู ุงูููุงุทุฑ","ุงูุฎุตูุต"],"ุงูุจุญูุฑุฉ":["ุฏููููุฑ","ููุฑ ุงูุฏูุงุฑ","ุฅูุชุงู ุงูุจุงุฑูุฏ","ุฃุจู ุญูุต","ููู ุญูุงุฏุฉ","ุงูุฏููุฌุงุช","ุญูุด ุนูุณู","ุฑุดูุฏ","ุฅุฏูู","ุงููุญููุฏูุฉ","ุงูุฑุญูุงููุฉ","ุงูููุจุงุฑูุฉ"],"ุงูุบุฑุจูุฉ":["ุทูุทุง","ุงููุญูุฉ ุงููุจุฑู","ููุฑ ุงูุฒูุงุช","ุฒูุชู","ุงูุณูุทุฉ","ูุทูุฑ","ุจุณููู","ุณูููุฏ"],"ุจูุฑุณุนูุฏ":["ุญู ุงูุดุฑู","ุญู ุงูุนุฑุจ","ุญู ุงูููุงุฎ","ุญู ุงูุถูุงุญู","ุญู ุงูุฌููุจ","ุญู ุงูุฒููุฑ","ุจูุฑูุคุงุฏ"],"ุฏููุงุท":["ุฏููุงุท","ุฑุฃุณ ุงูุจุฑ","ุฏููุงุท ุงูุฌุฏูุฏุฉ","ูุงุฑุณููุฑ","ุงูุฒุฑูุง","ููุฑ ุณุนุฏ","ุงูุฑูุถุฉ","ุงูุณุฑู","ุนุฒุจุฉ ุงูุจุฑุฌ","ููุช ุฃุจู ุบุงูุจ"],"ุงูุฅุณูุงุนูููุฉ":["ุงูุฅุณูุงุนูููุฉ","ุงููุตุงุตูู","ุงูุชู ุงููุจูุฑ","ูุงูุฏ","ุงูููุทุฑุฉ ุดุฑู","ุงูููุทุฑุฉ ุบุฑุจ","ุฃุจู ุตููุฑ"],"ุงูุณููุณ":["ุญู ุงูุณููุณ","ุญู ุงูุฃุฑุจุนูู","ุญู ุนุชุงูุฉ","ุญู ุงูุฌูุงูู","ุญู ููุตู"],"ููุฑ ุงูุดูุฎ":["ููุฑ ุงูุดูุฎ","ุฏุณูู","ููู","ูุทูุจุณ","ุจูุทูู","ูุตูู ุจูุทูู","ุงูุญุงููู","ุจููุง","ุงูุฑูุงุถ","ุณูุฏู ุณุงูู","ูููู"],"ุงููููู":["ุงููููู","ุงููููู ุงูุฌุฏูุฏุฉ","ุทุงููุฉ","ุณููุฑุณ","ุฅุทุณุง","ุฅุจุดูุงู","ููุณู ุงูุตุฏูู"],"ุจูู ุณููู":["ุจูู ุณููู","ุจูู ุณููู ุงูุฌุฏูุฏุฉ","ุงููุงุณุทู","ูุงุตุฑ","ุฅููุงุณูุง","ุจุจุง","ุงููุดู","ุณูุณุทุง"],"ุงููููุง":["ุงููููุง","ุงููููุง ุงูุฌุฏูุฏุฉ","ุงูุนุฏูุฉ","ูุบุงุบุฉ","ุจูู ูุฒุงุฑ","ูุทุงู","ุณูุงููุท","ุฃุจู ูุฑูุงุต","ูููู","ุฏูุฑ ููุงุณ"],"ุฃุณููุท":["ุฃุณููุท","ุฃุณููุท ุงูุฌุฏูุฏุฉ","ุฏูุฑูุท","ุงูููุตูุฉ","ุฃุจููุจ","ูููููุท","ุฃุจู ุชูุฌ","ุงูุบูุงูู","ุณุงุญู ุณููู","ุงูุจุฏุงุฑู","ุตุฏูุง"],"ุณููุงุฌ":["ุณููุงุฌ","ุณููุงุฌ ุงูุฌุฏูุฏุฉ","ุฃุฎููู","ุฃุฎููู ุงูุฌุฏูุฏุฉ","ุงูุจูููุง","ุงููุฑุงุบุฉ","ุงูููุดุฃุฉ","ุฏุงุฑ ุงูุณูุงู","ุฌุฑุฌุง","ุฌูููุฉ","ุณุงููุชุฉ","ุทูุง","ุทูุทุง"],"ููุง":["ููุง","ููุง ุงูุฌุฏูุฏุฉ","ุฃุจู ุชุดุช","ูุฌุน ุญูุงุฏู","ุฏุดูุง","ุงูููู","ููุท","ููุต","ููุงุฏุฉ","ูุฑุดูุท"],"ุงูุฃูุตุฑ":["ุงูุฃูุตุฑ","ุฅุณูุง","ุฃุฑููุช","ุงููุฑูุฉ","ุงูุจูุงุถูุฉ","ุงูุฒูููุฉ","ุงูุทูุฏ"],"ุฃุณูุงู":["ุฃุณูุงู","ุฃุณูุงู ุงูุฌุฏูุฏุฉ","ุฏุฑุงู","ููู ุฃูุจู","ูุตุฑ ุงูููุจุฉ","ุฅุฏูู"],"ุงูุจุญุฑ ุงูุฃุญูุฑ":["ุงูุบุฑุฏูุฉ","ุฑุฃุณ ุบุงุฑุจ","ุณูุงุฌุง","ุงููุตูุฑ","ูุฑุณู ุนูู","ุดูุงุชูู","ุญูุงูุจ"],"ุงููุงุฏู ุงูุฌุฏูุฏ":["ุงูุฎุงุฑุฌุฉ","ุงูุฏุงุฎูุฉ","ุงููุฑุงูุฑุฉ","ุจุงุฑูุณ","ุจูุงุท"],"ูุทุฑูุญ":["ูุฑุณู ูุทุฑูุญ","ุงูุญูุงู","ุงูุนูููู","ุงูุถุจุนุฉ","ุงููุฌููุฉ","ุณูุฏู ุจุฑุงูู","ุงูุณููู","ุณููุฉ"],"ุดูุงู ุณููุงุก":["ุงูุนุฑูุด","ุจุฆุฑ ุงูุนุจุฏ","ุงูุดูุฎ ุฒููุฏ","ุฑูุญ","ุงูุญุณูุฉ","ูุฎู"],"ุฌููุจ ุณููุงุก":["ุงูุทูุฑ","ุดุฑู ุงูุดูุฎ","ุฏูุจ","ูููุจุน","ุทุงุจุง","ุณุงูุช ูุงุชุฑูู","ุฃุจู ุฑุฏูุณ","ุฃุจู ุฒูููุฉ","ุฑุฃุณ ุณุฏุฑ"]};
        const pwaManifest={"name":"ุงูุณูู ููุงู","short_name":"ุงูุณูู ููุงู","start_url":".","display":"standalone","background_color":"#ffffff","theme_color":"#0f172a","description":"ูุชุฌุฑ ุงูุชุฑููู ุนุตุฑู","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/641/641813.png","sizes":"192x192","type":"image/png"},{"src":"https://cdn-icons-png.flaticon.com/512/641/641813.png","sizes":"512x512","type":"image/png"}]};
        const stringManifest=JSON.stringify(pwaManifest);const blob=new Blob([stringManifest],{type:'application/json'});const manifestURL=URL.createObjectURL(blob);document.querySelector('#manifest-link').setAttribute('href',manifestURL);

        const firebaseConfig = {
          apiKey: "AIzaSyA5OiTcX95GBgiJoDHnY3y7N23o-j8hsQ8",
          authDomain: "services-cef84.firebaseapp.com",
          databaseURL: "https://services-cef84-default-rtdb.firebaseio.com",
          projectId: "services-cef84",
          storageBucket: "services-cef84.firebasestorage.app",
          messagingSenderId: "902396219187",
          appId: "1:902396219187:web:3ba084a724266afa8bb846"
        };

        const app = initializeApp(firebaseConfig); 
        const db = getFirestore(app); 
        const auth = getAuth(app);

        let state = { 
            user: null, userData: null, listings: [], images: [], chatId: null, chatStep: 0, 
            tempName: '', activeAdminChat: null, isAdmin: false, welcomeSent: false, favorites: [], 
            currentFilter: 'all', currentItem: null, currentView: 'home', lightboxImages: [], 
            lightboxIndex: 0, detailsSliderIndex: 0, detailsSliderImages: [], authRole: 'customer', 
            authType: 'login', authImageBase64: null, userRole: 'customer', currentRating: 0, 
            productReviews: [], productReviewsLimit: 1, profileReviews: [], profileReviewsLimit: 3, 
            viewingProfileId: null, isEditingProfile: false, dataLoaded: false 
        };

        // Init Logic
        function initGovs() {
            const govSelect = document.getElementById('auth-gov');
            const filterGov = document.getElementById('filter-gov');
            const shipGovList = document.getElementById('ship-gov-list'); 
            govSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุญุงูุธุฉ</option>';
            filterGov.innerHTML = '<option value="">ูู ุงููุญุงูุธุงุช</option>';
            shipGovList.innerHTML = '';
            Object.keys(EGYPT_DATA).forEach(gov => {
                govSelect.innerHTML += `<option value="${gov}">${gov}</option>`;
                filterGov.innerHTML += `<option value="${gov}">${gov}</option>`;
                shipGovList.innerHTML += `<label class="flex items-center gap-1 cursor-pointer hover:bg-slate-50 p-1 rounded"><input type="checkbox" name="ship-gov-check" value="${gov}" class="w-3 h-3 rounded border-gray-300 text-primary focus:ring-primary"><span class="text-[10px] font-bold text-slate-600">${gov}</span></label>`;
            });
        }
        initGovs();

        window.updateCities = () => {
            const gov = document.getElementById('auth-gov').value;
            const citySelect = document.getElementById('auth-city');
            citySelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุฑูุฒ/ุงููุฏููุฉ</option>';
            if(gov && EGYPT_DATA[gov]) EGYPT_DATA[gov].forEach(city => citySelect.innerHTML += `<option value="${city}">${city}</option>`);
        }

        function hideSplash() {
            const splash = document.getElementById('splash-screen');
            if(!splash.classList.contains('hidden')) {
                splash.classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => splash.classList.add('hidden'), 500);
            }
        }

        function forceSwitchToApp() {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('login-view').style.setProperty('display', 'none', 'important');
            document.getElementById('app-content').classList.remove('hidden');
            document.getElementById('loader').classList.add('hidden'); 
        }

        onAuthStateChanged(auth, async (u) => { 
            if(u) { 
                state.user = u;
                try {
                    const userDoc = await getDoc(doc(db, "users", u.uid));
                    if (userDoc.exists()) {
                        state.userData = userDoc.data();
                        state.userRole = state.userData.role || 'customer';
                        state.isAdmin = state.userData.isAdmin === true;
                        document.getElementById('header-username').innerText = state.userData.name || u.displayName;
                        document.getElementById('welcome-text').classList.remove('hidden');
                        if(state.isAdmin) document.getElementById('btn-admin-top').classList.remove('hidden');
                    }
                } catch(e) { console.warn(e); }
                
                forceSwitchToApp();
                loadListings(); 
                checkUserChat(); 
                initFavs(); 
                initCats(); 
            } else {
                state.user = null;
                hideSplash();
                document.getElementById('login-view').classList.remove('hidden');
                document.getElementById('login-view').style.removeProperty('display');
                document.getElementById('app-content').classList.add('hidden');
            }
        });

        // ... (Auth Functions: setAuthRole, setAuthType, handleAuthImage, processAuth, logout - Same as before)
        window.setAuthRole=r=>{state.authRole=r;const c=document.getElementById('btn-role-customer'),m=document.getElementById('btn-role-marketer');if(r==='customer'){c.className="flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-navy dark:bg-primary text-white shadow-md";m.className="flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:bg-white dark:hover:bg-slate-700"}else{m.className="flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-navy dark:bg-primary text-white shadow-md";c.className="flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:bg-white dark:hover:bg-slate-700"}};
        window.setAuthType=t=>{state.authType=t;const l=document.getElementById('btn-type-login'),s=document.getElementById('btn-type-signup'),a=document.getElementById('btn-auth-action'),i=document.getElementById('auth-image-field'),f=document.getElementById('signup-fields');if(t==='login'){l.className="flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-navy dark:bg-primary text-white shadow-md";s.className="flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:text-navy dark:hover:text-white";a.innerHTML=`<span>ุฏุฎูู ููุญุณุงุจ</span> <i data-lucide="arrow-left" class="w-4 h-4"></i>`;i.classList.add('hidden');i.classList.remove('flex');f.classList.add('hidden')}else{s.className="flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-navy dark:bg-primary text-white shadow-md";l.className="flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition-all hover:text-navy dark:hover:text-white";a.innerHTML=`<span>ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ</span> <i data-lucide="plus-circle" class="w-4 h-4"></i>`;i.classList.remove('hidden');i.classList.add('flex');f.classList.remove('hidden')}lucide.createIcons()};
        window.handleAuthImage=async(i)=>{if(i.files&&i.files[0]){const c=await compress(i.files[0]);state.authImageBase64=c;document.getElementById('auth-img-preview').src=c;document.getElementById('auth-img-preview').classList.remove('hidden');document.getElementById('auth-img-placeholder').classList.add('hidden')}};
        window.processAuth=async()=>{const u=document.getElementById('auth-username').value.trim().toLowerCase(),p=document.getElementById('auth-pass').value,e=document.getElementById('auth-error'),b=document.getElementById('btn-auth-action');e.classList.add('hidden');if(!u||!p){e.innerText="ูุฑุฌู ููุก ุงูุจูุงูุงุช";e.classList.remove('hidden');return}if(!/^[a-z0-9_]+$/.test(u)){e.innerText="ุงุณู ุงููุณุชุฎุฏู ุญุฑูู ุฅูุฌููุฒูุฉ ูุฃุฑูุงู ููุท";e.classList.remove('hidden');return}if(p.length<6){e.innerText="ูููุฉ ุงููุฑูุฑ ูุตูุฑุฉ";e.classList.remove('hidden');return}const em=`${u}@souq.local`;b.disabled=true;b.innerHTML=`<div class="spinner"></div>`;try{if(state.authType==='signup'){const n=document.getElementById('auth-name-ar').value.trim(),ph=document.getElementById('auth-phone').value.trim(),g=document.getElementById('auth-gov').value,c=document.getElementById('auth-city').value,ad=document.getElementById('auth-address').value.trim();if(!n||!g||!c||!ad||!ph)throw new Error("missing");const uc=await createUserWithEmailAndPassword(auth,em,p);await updateProfile(uc.user,{displayName:n});const nu={username:u,name:n,phone:ph,email:em,role:state.authRole,governorate:g,city:c,address:ad,isAdmin:false,image:state.authImageBase64||null,createdAt:serverTimestamp()};await setDoc(doc(db,"users",uc.user.uid),nu);state.userData=nu;state.userRole=state.authRole;document.getElementById('header-username').innerText=n;document.getElementById('welcome-text').classList.remove('hidden')}else{await signInWithEmailAndPassword(auth,em,p)}b.innerHTML=`ุชู ุจูุฌุงุญ <i data-lucide="check" class="w-4 h-4"></i>`;setTimeout(()=>{forceSwitchToApp();showToast(`ุฃููุงู ุจู ๐`,'s')},500)}catch(err){console.error(err);e.innerText="ุญุฏุซ ุฎุทุฃ ูู ุงูุจูุงูุงุช";e.classList.remove('hidden');b.disabled=false;b.innerHTML="ุญุงูู ูุฑุฉ ุฃุฎุฑู";lucide.createIcons()}};
        window.logout=()=>{signOut(auth).then(()=>window.location.reload())};

        const CATEGORIES = ["ููุงุจุณ ุฑุฌุงูู", "ููุงุจุณ ุญุฑููู", "ููุงุจุณ ุงุทูุงู", "ุงุญุฐูุฉ ุฑุฌุงูู", "ุงุญุฐูุฉ ุญุฑููู", "ุงุญุฐูุฉ ุงุทูุงู", "ุงูุณุณูุฑุงุช ุฑุฌุงูู", "ุงูุณุณูุฑุงุช ุญุฑููู", "ุงูุณุณูุฑุงุช ุงุทูุงู", "ุจุฑูุงูุงุช ุฑุฌุงูู ูุญุฑููู", "ุงูุญูุงุฆุจ ุงูุดุฎุตูุฉ", "ุงููุธุงุฑุงุช", "ูุณุชุญุถุฑุงุช ุงูุชุฌููู", "ุงุฏูุงุช ุญูุงูุฉ ููุฑุฌุงู", "ููููุงุช ุบุฐุงุฆูุฉ", "ุงุฏูุงุช ุฑูุงุถูุฉ", "ุงููุฏุงูุง ุงูุดุฎุตูุฉ", "ุงููุฏุงูุง ูุงูุงูุนุงุจ", "ููุชุฌุงุช ุงูุนูุงูุฉ ุจุงูุจุดุฑุฉ", "ููุชุฌุงุช ุงูุงุทูุงู", "ุงููุดุฉ"];
        const USED_CATS = ["ุงููุธุงุฑุงุช", "ุงูุณุณูุฑุงุช ุฑุฌุงูู", "ุงูุณุณูุฑุงุช ุญุฑููู", "ุงูุณุณูุฑุงุช ุงุทูุงู"];
        const CLOTHES_CATS = ["ููุงุจุณ ุฑุฌุงูู", "ููุงุจุณ ุญุฑููู", "ููุงุจุณ ุงุทูุงู", "ุงููุดุฉ"];
        const SHOES_CATS = ["ุงุญุฐูุฉ ุฑุฌุงูู", "ุงุญุฐูุฉ ุญุฑููู", "ุงุญุฐูุฉ ุงุทูุงู"];
        const SIZES_MEN = ["S", "M", "L", "XL", "2XL", "3XL", "4XL", "FreeSize"];
        const SIZES_WOMEN = ["XS", "S", "M", "L", "XL", "2XL", "FreeSize"];
        const SIZES_KIDS = ["1y", "2y", "4y", "6y", "8y", "10y", "12y", "14y", "16y"];
        const SIZES_SHOES_ADULT = ["37", "38", "39", "40", "41", "42", "43", "44", "45"];
        const SIZES_SHOES_KIDS = ["20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35"];
        const BASIC_COLORS = ["ุฃุจูุถ", "ุฃุณูุฏ", "ุฑูุงุฏู", "ูุญูู", "ุฃุญูุฑ", "ุฃุฒุฑู", "ุจูุฌ", "ุฃุฎุถุฑ", "ุฃุตูุฑ", "ุจูู"];
        const CATEGORY_IMAGES = {"ููุงุจุณ ุฑุฌุงูู":"https://images.unsplash.com/photo-1617137968427-85924c800a22?q=80&w=300","ุจุฑูุงูุงุช ุฑุฌุงูู ูุญุฑููู":"https://images.unsplash.com/photo-1541643600914-78b084683601?q=80&w=300","ุงููุธุงุฑุงุช":"https://images.unsplash.com/photo-1572635196237-14b3f281503f?q=80&w=300","ูุณุชุญุถุฑุงุช ุงูุชุฌููู":"https://images.unsplash.com/photo-1596462502278-27bfdc403348?q=80&w=300","ุงุฏูุงุช ุญูุงูุฉ ููุฑุฌุงู":"https://images.unsplash.com/photo-1621607512214-68297480165e?q=80&w=300","ููููุงุช ุบุฐุงุฆูุฉ":"https://images.unsplash.com/photo-1581009137042-c552e485697a?q=80&w=300","ุงุญุฐูุฉ ุญุฑููู":"https://images.unsplash.com/photo-1549298916-b41d501d3772?q=80&w=300","ุงุฏูุงุช ุฑูุงุถูุฉ":"https://images.unsplash.com/photo-1517836357463-d25dfeac3438?q=80&w=300","ููุงุจุณ ุญุฑููู":"https://images.pexels.com/photos/3772506/pexels-photo-3772506.jpeg?auto=compress&cs=tinysrgb&w=300","ุงุญุฐูุฉ ุฑุฌุงูู":"https://images.pexels.com/photos/5264901/pexels-photo-5264901.jpeg?auto=compress&cs=tinysrgb&w=300","ุงุญุฐูุฉ ุงุทูุงู":"https://images.pexels.com/photos/29737094/pexels-photo-29737094.jpeg?auto=compress&cs=tinysrgb&w=300","ููุงุจุณ ุงุทูุงู":"https://images.pexels.com/photos/1620758/pexels-photo-1620758.jpeg?auto=compress&cs=tinysrgb&w=300","ุงูุณุณูุฑุงุช ุฑุฌุงูู":"https://images.pexels.com/photos/3766112/pexels-photo-3766112.jpeg?auto=compress&cs=tinysrgb&w=300","ุงูุณุณูุฑุงุช ุญุฑููู":"https://images.pexels.com/photos/17568000/pexels-photo-17568000.jpeg?auto=compress&cs=tinysrgb&w=300","ุงูุณุณูุฑุงุช ุงุทูุงู":"https://images.pexels.com/photos/2848522/pexels-photo-2848522.jpeg?auto=compress&cs=tinysrgb&w=300","ุงูุญูุงุฆุจ ุงูุดุฎุตูุฉ":"https://images.pexels.com/photos/1986996/pexels-photo-1986996.jpeg?auto=compress&cs=tinysrgb&w=300","ุงููุฏุงูุง ุงูุดุฎุตูุฉ":"https://images.pexels.com/photos/19066549/pexels-photo-19066549.jpeg?auto=compress&cs=tinysrgb&w=300","ุงููุฏุงูุง ูุงูุงูุนุงุจ":"https://images.pexels.com/photos/4491662/pexels-photo-4491662.jpeg?auto=compress&cs=tinysrgb&w=300","ููุชุฌุงุช ุงูุนูุงูุฉ ุจุงูุจุดุฑุฉ":"https://images.pexels.com/photos/10117729/pexels-photo-10117729.jpeg?auto=compress&cs=tinysrgb&w=300","ููุชุฌุงุช ุงูุงุทูุงู":"https://images.pexels.com/photos/26337029/pexels-photo-26337029.jpeg?auto=compress&cs=tinysrgb&w=300","ุงููุดุฉ":"https://images.pexels.com/photos/34636582/pexels-photo-34636582.jpeg?auto=compress&cs=tinysrgb&w=300"};

        function initCats() {
            const cont = document.getElementById('categories-container');
            cont.innerHTML = `<button onclick="filter('all')" id="chip-all" class="chip-btn">ุงููู</button>`;
            const sel = document.getElementById('in-cat'); sel.innerHTML = '';
            CATEGORIES.forEach(c => {
                const btn = document.createElement('button'); btn.innerText = c; btn.id = `chip-${c.replace(/\s/g, '')}`;
                btn.className = "px-4 py-1.5 rounded-full bg-white dark:bg-darkbg border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-300 text-xs font-bold whitespace-nowrap transition hover:border-primary hover:text-primary chip-btn";
                btn.onclick = () => filter(c); cont.appendChild(btn);
                const opt = document.createElement('option'); opt.value = c; opt.innerText = c; sel.appendChild(opt);
            });
        }

        // View Logic
        function renderView() {
            const s=document.getElementById('search-container'), c=document.getElementById('categories-container'), 
                  h=document.getElementById('view-header'), g=document.getElementById('grid-container'), 
                  fb=document.getElementById('btn-filter-toggle'), fp=document.getElementById('filter-panel');
            fp.classList.add('hidden');
            if (state.currentView === 'home') {
                h.classList.add('hidden'); c.classList.add('hidden'); fb.classList.add('hidden'); s.classList.remove('hidden');
                g.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 pb-10 mt-4';
                document.getElementById('search-input').placeholder = 'ุงุจุญุซ ุนู ูุณู...';
                renderCategoryCards();
            } else if (state.currentView === 'category') {
                h.classList.remove('hidden');
                document.getElementById('view-title').innerText = state.currentFilter === 'all' ? 'ูู ุงูููุชุฌุงุช' : (state.currentFilter === 'fav' ? 'ุงูููุถูุฉ' : state.currentFilter);
                if (state.currentFilter === 'fav') { s.classList.add('hidden'); c.classList.add('hidden'); } 
                else { s.classList.remove('hidden'); fb.classList.remove('hidden'); document.getElementById('search-input').placeholder = 'ุงุจุญุซ ุนู ููุชุฌ...'; if(state.currentFilter==='all')c.classList.remove('hidden');else c.classList.add('hidden'); }
                g.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 pb-10';
                filter(state.currentFilter);
            }
            lucide.createIcons();
        }

        window.toggleFilterPanel=()=>document.getElementById('filter-panel').classList.toggle('hidden');
        window.applyFilters=()=>renderProducts();
        window.resetFilters=()=>{
            document.getElementById('search-input').value=''; document.getElementById('filter-price').value=''; document.getElementById('filter-gov').value='';
            if(state.currentView==='category'){ if(state.currentFilter!=='all'&&state.currentFilter!=='fav')renderProducts(); else switchToHomeView(); } else renderCategoryCards();
        };
        window.switchToCategoryView=c=>{state.currentView='category';state.currentFilter=c;document.getElementById('search-input').value='';window.scrollTo({top:0,behavior:'smooth'});renderView()};
        window.switchToHomeView=()=>{state.currentView='home';state.currentFilter='all';document.getElementById('search-input').value='';window.scrollTo({top:0,behavior:'smooth'});renderView();const u=new URL(window.location);u.searchParams.delete('product_id');window.history.replaceState({},'',u)};

        function renderCategoryCards() {
            const c=document.getElementById('grid-container'), q=normalizeText(document.getElementById('search-input').value); c.innerHTML='';
            const f=CATEGORIES.filter(cat=>normalizeText(cat).includes(q));
            if(!f.length) document.getElementById('empty-state').classList.remove('hidden');
            else { document.getElementById('empty-state').classList.add('hidden'); f.forEach(cat=>{ c.innerHTML+=`<div onclick="switchToCategoryView('${cat}')" class="relative rounded-xl overflow-hidden shadow-sm border-2 border-black dark:border-slate-700 h-28 cursor-pointer active:scale-95 transition-transform group flex items-center justify-center text-center p-2"><img src="${CATEGORY_IMAGES[cat]||'https://via.placeholder.com/150'}" class="absolute inset-0 w-full h-full object-cover transition-transform duration-300 group-hover:scale-110"><div class="absolute inset-0 bg-black/50"></div><h3 class="relative z-10 font-bold text-white text-sm drop-shadow-md">${cat}</h3></div>` }) }
        }

        function loadListings() { 
            showSkeletons(); 
            onSnapshot(query(collection(db, "listings")), (snap) => { 
                state.listings = []; snap.forEach(d => state.listings.push({id: d.id, ...d.data()})); 
                state.listings.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); 
                hideSplash(); // Hide splash after data load
                const p = new URLSearchParams(window.location.search).get('product_id');
                if(p && !state.currentItem) { const i = state.listings.find(x => x.id === p); if(i) openDetails(i.id); }
                renderView();
            }); 
        }

        window.handleSearch=()=>{if(state.currentView==='home')renderCategoryCards();else renderProducts()};
        window.filter=t=>{state.currentFilter=t;document.querySelectorAll('#categories-container .chip-btn').forEach(b=>b.className="px-4 py-1.5 rounded-full bg-white dark:bg-darkbg border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-300 text-xs font-bold whitespace-nowrap transition hover:border-primary hover:text-primary chip-btn");const a=document.getElementById(t==='all'?'chip-all':`chip-${t.replace(/\s/g,'')}`);if(a){a.className="px-5 py-1.5 rounded-full bg-navy dark:bg-primary text-white text-xs font-bold shadow whitespace-nowrap transform scale-105 transition chip-btn";a.scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'})}if(state.currentView!=='category')state.currentView='category';document.getElementById('view-title').innerText=t==='all'?'ูู ุงูููุชุฌุงุช':(t==='fav'?'ุงูููุถูุฉ':t);renderProducts()};

        function renderProducts() {
            const q=normalizeText(document.getElementById('search-input').value), pf=document.getElementById('filter-price').value, gf=document.getElementById('filter-gov').value, c=document.getElementById('grid-container'); c.innerHTML='';
            let f=state.listings.filter(i=>{let m=true;if(state.currentFilter==='fav')m=(state.favorites||[]).includes(i.id);else m=state.currentFilter==='all'||i.category===state.currentFilter;const mt=normalizeText(i.title).includes(q)||normalizeText(i.category||'').includes(q);let mg=true;if(gf&&i.governorate)mg=i.governorate===gf;return m&&mt&&mg});
            if(pf==='low')f.sort((a,b)=>a.price-b.price);else if(pf==='high')f.sort((a,b)=>b.price-a.price);
            if(!f.length)document.getElementById('empty-state').classList.remove('hidden');else{document.getElementById('empty-state').classList.add('hidden');f.forEach(i=>c.innerHTML+=createCard(i))}lucide.createIcons();
        }

        function createCard(i) {
            const isFav=(state.favorites||[]).includes(i.id), heart=isFav?"fill-red-500 text-red-500":"text-white", isOwn=state.user&&state.user.uid===i.authorId, badge=i.badge==='hot'?`<span class="absolute top-1 left-1 bg-orange-500 text-white text-[9px] font-bold px-2 py-0.5 rounded shadow animate-pulse z-10">๐ฅ ุนุฑุถ</span>`:'';
            let overlay='', clk=`openDetails('${i.id}')`; if(i.status&&i.status!=='available'){clk='';overlay=`<div class="absolute inset-0 z-20 bg-white/80 dark:bg-black/80 backdrop-blur-sm flex items-center justify-center"><span class="bg-red-600 text-white font-bold px-4 py-2 rounded-xl shadow-xl transform -rotate-12 text-sm">${i.status==='sold'?'ุชู ุงูุจูุน':'ุบูุฑ ูุชุงุญ'}</span></div>`}
            const ctrls=(state.isAdmin||isOwn)?`<div class="absolute top-1 right-1 z-20 flex gap-1"><button onclick="del(event,'${i.id}')" class="bg-white/80 text-red-500 p-1 rounded shadow"><i data-lucide="trash-2" class="w-3 h-3"></i></button><button onclick="toggleStatus(event,'${i.id}','${i.status||'available'}')" class="bg-white/80 text-blue-600 p-1 rounded shadow"><i data-lucide="edit-3" class="w-3 h-3"></i></button></div>`:'';
            return `<div class="bg-white dark:bg-slate-800 rounded-lg overflow-hidden shadow-sm border-2 border-black dark:border-slate-700 flex flex-col h-full cursor-pointer active:scale-95 transition-transform group relative" onclick="${clk}"><div class="relative w-full h-32 sm:h-40 bg-gray-200 dark:bg-slate-700">${overlay} ${ctrls} ${!ctrls&&!overlay?badge:''} <button onclick="toggleFav(event,'${i.id}')" class="absolute top-1 left-1 z-20 p-1.5 rounded-full bg-black/20 hover:bg-black/40"><i data-lucide="heart" class="w-4 h-4 ${heart}"></i></button><div id="slider-${i.id}" class="flex w-full h-full overflow-x-auto no-scrollbar snap-x snap-mandatory scroll-smooth">${(Array.isArray(i.images)?i.images:[i.image]).map(s=>`<img src="${s}" class="w-full h-full object-cover shrink-0 snap-center ${overlay?'grayscale':''}" loading="lazy">`).join('')}</div><span class="absolute bottom-1 right-1 bg-white/90 dark:bg-black/60 text-slate-800 dark:text-white px-2 py-0.5 rounded text-[9px] font-bold shadow z-10">${i.category}</span></div><div class="p-2 flex-1 flex flex-col"><div class="flex justify-between items-start mb-1"><h3 class="font-bold text-slate-900 dark:text-white text-xs line-clamp-1">${i.title}</h3><span class="font-black text-primary text-xs whitespace-nowrap">${Number(i.price).toLocaleString()} ุฌ.ู</span></div><div class="text-[10px] text-slate-500 dark:text-slate-400 mb-2 flex gap-1 items-center"><span class="bg-slate-100 dark:bg-white/5 px-1.5 rounded">${i.condition==='new'?'ุฌุฏูุฏ':(i.condition==='openbox'?'ูุณุฑ ุฒูุฑู':'ูุณุชุนูู')}</span></div><div class="mt-auto flex gap-1 pt-2 border-t border-slate-100 dark:border-slate-700"><a href="https://wa.me/20${i.phone}" target="_blank" onclick="event.stopPropagation()" class="flex-1 bg-primary text-white py-1.5 rounded flex justify-center items-center gap-1 text-[10px] font-bold"><i data-lucide="message-circle" class="w-3 h-3"></i> ูุงุชุณ</a></div></div></div>`;
        }

        // Details Logic
        window.openDetails = async (id) => {
            const item = state.listings.find(i => i.id === id); if(!item) return;
            state.currentItem = item; 
            document.getElementById('d-title').innerText = item.title; 
            document.getElementById('d-price').innerText = Number(item.price).toLocaleString() + ' ุฌ.ู'; 
            document.getElementById('d-cat').innerText = item.category; 
            document.getElementById('d-desc').innerText = item.desc;
            document.getElementById('d-cond').innerText = item.condition === 'new' ? 'ุฌุฏูุฏ' : (item.condition === 'openbox' ? 'ูุณุฑ ุฒูุฑู' : 'ูุณุชุนูู');

            // Req 5: Clickable Publisher
            const pubBar = document.getElementById('d-pub-bar');
            pubBar.onclick = () => toggleProfile(item.authorId);

            const pubName = document.getElementById('d-pub-name');
            const pubImg = document.getElementById('d-pub-img');
            pubName.innerText = "ุฌุงุฑู ุงูุชุญููู...";
            
            try {
                const uSnap = await getDoc(doc(db, "users", item.authorId));
                if(uSnap.exists()) {
                    const uData = uSnap.data();
                    pubName.innerText = uData.name || "ูุณุชุฎุฏู";
                    if(uData.image) pubImg.innerHTML = `<img src="${uData.image}" class="w-full h-full object-cover">`;
                    else pubImg.innerHTML = `<i data-lucide="user" class="w-4 h-4 text-slate-400"></i>`;
                } else pubName.innerText = "ูุณุชุฎุฏู ุบูุฑ ูุนุฑูู";
            } catch(e) { pubName.innerText = "ูุงุดุฑ"; }

            const amCont = document.getElementById('d-features'); amCont.innerHTML=''; 
            const sizeRow = document.getElementById('d-sizes-row'), sizeList = document.getElementById('d-sizes-list');
            const colorRow = document.getElementById('d-colors-row'), colorList = document.getElementById('d-colors-list');
            sizeRow.classList.add('hidden'); colorRow.classList.add('hidden'); sizeList.innerHTML = ''; colorList.innerHTML = '';

            if(item.size && Array.isArray(item.size) && item.size.length > 0) {
                 sizeRow.classList.remove('hidden');
                 item.size.forEach(s => sizeList.innerHTML += `<span class="bg-white dark:bg-slate-700 text-slate-700 dark:text-white px-2 py-1 rounded-md text-[10px] font-bold border border-slate-200 dark:border-slate-600 shadow-sm min-w-[30px] text-center">${s}</span>`);
            }
            if(item.color && Array.isArray(item.color) && item.color.length > 0) {
                 colorRow.classList.remove('hidden');
                 item.color.forEach(c => colorList.innerHTML += `<span class="bg-white dark:bg-slate-700 text-slate-700 dark:text-white px-2 py-1 rounded-md text-[10px] font-bold border border-slate-200 dark:border-slate-600 shadow-sm">${c}</span>`);
            }
            if(item.features) item.features.forEach(a => amCont.innerHTML += `<span class="bg-slate-100 dark:bg-slate-700 dark:text-white px-2 py-1 rounded text-xs flex items-center gap-1 border border-slate-200 dark:border-slate-600 font-bold">${a}</span>`);
            
            const shipInfo = document.getElementById('d-shipping-info');
            if(item.shippingMode === 'specific' && item.shippingGov) {
                 let govText = Array.isArray(item.shippingGov) ? item.shippingGov.join('ุ ') : item.shippingGov;
                 shipInfo.innerHTML = `<i data-lucide="truck" class="w-3 h-3 shrink-0"></i> <span class="whitespace-normal leading-tight text-right">ูุชุงุญ ูู: ${govText}</span>`;
            } else shipInfo.innerHTML = `<i data-lucide="truck" class="w-3 h-3 shrink-0"></i> ุดุญู ููู ุงููุญุงูุธุงุช`;

            document.getElementById('d-wa').href = `https://wa.me/20${item.phone}?text=ุงุณุชูุณุงุฑ ุจุฎุตูุต: ${item.title}`; 
            document.getElementById('d-call').href = `tel:${item.phone}`;

            const imgs = Array.isArray(item.images) ? item.images : [item.image]; 
            state.detailsSliderImages = imgs; state.detailsSliderIndex = 0;   
            const dotsContainer = document.getElementById('details-dots'), imgEl = document.getElementById('details-img');
            if (imgEl) { imgEl.src = imgs.length > 0 ? imgs[0] : 'https://placehold.co/400x300'; imgEl.onclick = () => openLightbox(imgEl.src); }
            dotsContainer.innerHTML = ''; 
            if (imgs.length > 1) dotsContainer.innerHTML = imgs.map((_, index) => `<span id="dot-${index}" class="w-2 h-2 rounded-full bg-white/40 transition-all"></span>`).join('');
            document.getElementById('details-arrows').style.display = imgs.length > 1 ? 'block' : 'none';
            
            state.productReviewsLimit = 1; loadProductReviews(false);
            toggleModal('details-modal'); goToDetailsSlide(0); lucide.createIcons();
            const url = new URL(window.location); url.searchParams.set('product_id', id); window.history.replaceState({}, '', url);
        }

        window.closeDetails=()=>{toggleModal('details-modal');state.currentItem=null;const u=new URL(window.location);u.searchParams.delete('product_id');window.history.replaceState({},'',u)};
        function goToDetailsSlide(index){const total=state.detailsSliderImages.length;if(total===0)return;if(index<0)index=total-1;if(index>=total)index=0;state.detailsSliderIndex=index;document.getElementById('details-img').src=state.detailsSliderImages[index];updateSliderDots()}
        window.scrollDetails=dir=>{goToDetailsSlide(state.detailsSliderIndex-dir)};
        function updateSliderDots(){if(state.detailsSliderImages.length<=1)return;for(let i=0;i<state.detailsSliderImages.length;i++){const d=document.getElementById(`dot-${i}`);if(d)d.className=i===state.detailsSliderIndex?'w-4 h-2 rounded-full bg-white shadow transition-all':'w-2 h-2 rounded-full bg-white/40 transition-all'}}
        window.copyDetails=()=>{if(!state.currentItem)return;const t=`ุงูููุชุฌ: ${state.currentItem.title}\nุงูุณุนุฑ: ${state.currentItem.price}\n${state.currentItem.desc}`;navigator.clipboard.writeText(t).then(()=>showToast('ุชู ุงููุณุฎ')).catch(()=>showToast('ูุดู ุงููุณุฎ','e'))};

        // Profile Logic (Req 2, 3, 5, 7)
        window.toggleProfile = async (userId = null) => {
            if(toggleModal('profile-modal')) {
                const targetId = userId || (state.user ? state.user.uid : null);
                if(!targetId) return;
                
                state.viewingProfileId = targetId;
                const isOwner = state.user && state.user.uid === targetId;
                state.isEditingProfile = false;
                
                // Reset UI
                document.getElementById('prof-name').innerText = '...';
                document.getElementById('prof-role').innerText = '...';
                document.getElementById('in-prof-phone').value = '';
                document.getElementById('in-prof-address').value = '';
                document.getElementById('in-prof-name').value = '';
                
                // Disable inputs by default
                document.querySelectorAll('#profile-modal input').forEach(i => i.disabled = true);
                document.getElementById('btn-save-profile').classList.add('hidden');
                document.getElementById('btn-edit-profile').classList.add('hidden');
                document.getElementById('btn-edit-img').classList.add('hidden');
                document.getElementById('prof-password-section').classList.add('hidden');
                document.getElementById('prof-reviews-section').classList.add('hidden');

                try {
                    let data = null;
                    if(isOwner && state.userData) data = state.userData;
                    else { const snap = await getDoc(doc(db, "users", targetId)); if(snap.exists()) data = snap.data(); }

                    if(data) {
                        document.getElementById('prof-name').innerText = data.name || 'ูุณุชุฎุฏู';
                        document.getElementById('in-prof-name').value = data.name || '';
                        document.getElementById('prof-role').innerText = data.role === 'marketer' ? 'ูุณูู / ุจุงุฆุน' : 'ุนููู';
                        document.getElementById('in-prof-phone').value = data.phone || '';
                        document.getElementById('in-prof-address').value = (data.address || '') + (data.city ? ' - ' + data.city : '');
                        
                        const imgCont = document.getElementById('prof-img-container');
                        if(data.image) imgCont.innerHTML = `<img src="${data.image}" class="w-full h-full object-cover">`;
                        else imgCont.innerHTML = `<i data-lucide="user" class="w-10 h-10 text-slate-400"></i>`;

                        if(isOwner) {
                            document.getElementById('btn-edit-profile').classList.remove('hidden');
                            document.getElementById('prof-password-section').classList.remove('hidden');
                            // Only show reviews on OWN profile if marketer
                            if(data.role === 'marketer') {
                                document.getElementById('prof-reviews-section').classList.remove('hidden');
                                state.profileReviewsLimit = 3;
                                loadProfileReviews(false);
                            }
                        } else {
                            // Req 1: If viewing another profile (Publisher), DO NOT show reviews
                            // Just show data.
                        }
                    }
                } catch(e) { console.error(e); showToast("ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช", "e"); }
                lucide.createIcons();
            }
        }

        window.enableEditMode = () => {
            state.isEditingProfile = true;
            document.getElementById('in-prof-name').disabled = false;
            document.getElementById('in-prof-phone').disabled = false;
            document.getElementById('in-prof-address').disabled = false;
            document.getElementById('btn-edit-img').classList.remove('hidden');
            document.getElementById('btn-save-profile').classList.remove('hidden');
            document.getElementById('btn-edit-profile').classList.add('hidden');
        }

        window.updateProfileImage = async (input) => {
            if (input.files && input.files[0]) {
                const c = await compress(input.files[0]);
                state.authImageBase64 = c; 
                document.getElementById('prof-img-container').innerHTML = `<img src="${c}" class="w-full h-full object-cover">`;
            }
        }

        window.saveProfile = async () => {
            const newName = document.getElementById('in-prof-name').value;
            const newPhone = document.getElementById('in-prof-phone').value;
            const newAddress = document.getElementById('in-prof-address').value;
            
            const updates = { name: newName, phone: newPhone, address: newAddress };
            if(state.authImageBase64) updates.image = state.authImageBase64;

            try {
                await updateDoc(doc(db, "users", state.user.uid), updates);
                if(newName) await updateProfile(auth.currentUser, { displayName: newName });
                state.userData = { ...state.userData, ...updates };
                state.authImageBase64 = null;
                showToast("ุชู ุงูุชุญุฏูุซ ุจูุฌุงุญ");
                toggleProfile(state.user.uid); 
            } catch(e) { showToast("ูุดู ุงูุชุญุฏูุซ", "e"); }
        }

        window.changePassword = async () => {
            const newPass = document.getElementById('new-password').value;
            if(!newPass || newPass.length < 6) return showToast("ูููุฉ ุงููุฑูุฑ ูุตูุฑุฉ", "e");
            try { await updatePassword(auth.currentUser, newPass); showToast("ุชู ุงูุชุญุฏูุซ"); document.getElementById('new-password').value = ''; } 
            catch(e) { showToast("ูุฌุจ ุฅุนุงุฏุฉ ุชุณุฌูู ุงูุฏุฎูู", "e"); }
        }

        // Reviews Logic
        window.setRating = (n) => { state.currentRating = n; }
        window.submitProductReview = async () => {
            if(!state.user) return showToast("ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู", "e");
            if(!state.currentItem) return;
            if(state.currentRating === 0) return showToast("ุญุฏุฏ ุงููุฌูู", "e");
            const text = document.getElementById('review-text').value;
            await addDoc(collection(db, "product_reviews"), {
                productId: state.currentItem.id, productAuthorId: state.currentItem.authorId,
                userId: state.user.uid, userName: state.userData.name || 'ูุณุชุฎุฏู',
                userImage: state.userData.image || null, rating: state.currentRating, text: text, timestamp: serverTimestamp()
            });
            showToast("ุชู ุงููุดุฑ"); document.getElementById('review-text').value = '';
            state.productReviewsLimit = 1; loadProductReviews(false);
        }

        window.loadProductReviews = async (append = false) => {
            if(!state.currentItem) return;
            const list = document.getElementById('product-reviews-list'), btn = document.getElementById('load-more-reviews');
            if(append) state.productReviewsLimit += 3;
            const q = query(collection(db, "product_reviews"), where("productId", "==", state.currentItem.id), orderBy("timestamp", "desc"), limit(state.productReviewsLimit + 1));
            const snap = await getDocs(q);
            if(!append) list.innerHTML = '';
            let count = 0;
            snap.forEach(doc => {
                if(count < state.productReviewsLimit) {
                    const r = doc.data(), stars = "โ".repeat(r.rating) + "โ".repeat(5 - r.rating);
                    const img = r.userImage ? `<img src="${r.userImage}" class="w-full h-full object-cover">` : `<i data-lucide="user" class="w-4 h-4 text-slate-400"></i>`;
                    if(append && list.innerHTML.includes(r.text)) return; 
                    list.innerHTML += `<div class="bg-slate-50 dark:bg-slate-800/50 p-2 rounded-lg border border-slate-100 dark:border-slate-700"><div class="flex items-center gap-2 mb-1"><div class="w-6 h-6 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center overflow-hidden">${img}</div><span class="text-[10px] font-bold text-navy dark:text-white">${r.userName}</span><span class="text-yellow-400 text-xs tracking-tighter">${stars}</span></div><p class="text-[10px] text-slate-600 dark:text-slate-300 pr-8">${r.text || ''}</p></div>`;
                }
                count++;
            });
            if(snap.size > state.productReviewsLimit) btn.classList.remove('hidden'); else btn.classList.add('hidden');
            lucide.createIcons();
        }

        window.loadProfileReviews = async (append = false) => {
            if(!state.viewingProfileId) return;
            const list = document.getElementById('prof-reviews-list'), btn = document.getElementById('prof-reviews-more');
            if(append) state.profileReviewsLimit += 3;
            const q = query(collection(db, "product_reviews"), where("productAuthorId", "==", state.viewingProfileId), orderBy("timestamp", "desc"), limit(state.profileReviewsLimit + 1));
            try {
                const snap = await getDocs(q);
                if(!append) list.innerHTML = '';
                if(snap.empty) { list.innerHTML = '<p class="text-[10px] text-slate-400 text-center">ูุง ุชูุฌุฏ ุชููููุงุช</p>'; btn.classList.add('hidden'); return; }
                let count = 0;
                snap.forEach(doc => {
                    if(count < state.profileReviewsLimit) {
                        const r = doc.data(), stars = "โ".repeat(r.rating);
                        list.innerHTML += `<div class="bg-slate-50 dark:bg-slate-800/50 p-2 rounded-lg text-xs border border-slate-200 dark:border-slate-700"><div class="flex justify-between mb-1"><span class="font-bold">${r.userName}</span><span class="text-yellow-400">${stars}</span></div><p class="text-slate-600 dark:text-slate-300">${r.text}</p></div>`;
                    }
                    count++;
                });
                if(snap.size > state.profileReviewsLimit) btn.classList.remove('hidden'); else btn.classList.add('hidden');
            } catch(e) { console.log(e); list.innerHTML = '<p class="text-[10px] text-slate-400 text-center">ูุธุงู ุงูุชููููุงุช ููุฏ ุงูุชุฌููุฒ...</p>'; }
        }

        // Utils
        function toggleModal(id) { const m=document.getElementById(id); m.classList.toggle('hidden'); if(!m.classList.contains('hidden')) document.body.style.overflow='hidden'; else document.body.style.overflow=''; return !m.classList.contains('hidden'); }
        function normalizeText(t) { return t.replace(/[ุฃุฅุข]/g,'ุง').replace(/ุฉ/g,'ู').replace(/ู/g,'ู').toLowerCase(); }
        function showSkeletons() { const c=document.getElementById('grid-container'); c.innerHTML=''; for(let i=0;i<8;i++) c.innerHTML+=`<div class="bg-white dark:bg-slate-800 rounded-lg overflow-hidden shadow-sm border-2 border-slate-200 dark:border-slate-700 h-full"><div class="h-32 skeleton"></div><div class="p-2 space-y-2"><div class="h-4 rounded skeleton w-3/4"></div><div class="h-3 rounded skeleton w-1/2"></div></div></div>`; }
        function compress(f){return new Promise(r=>{const d=new FileReader();d.readAsDataURL(f);d.onload=e=>{const i=new Image();i.src=e.target.result;i.onload=()=>{const c=document.createElement('canvas');const x=c.getContext('2d');const s=800/i.width;c.width=800;c.height=i.height*s;x.drawImage(i,0,0,c.width,c.height);r(c.toDataURL('image/jpeg',0.6))}}})};
        
        // ... (Chat & Admin functions - Same as before)
        // ... (Add Modal Logic - Same as before)
        window.updateFormFields=()=>{const c=document.getElementById('in-cat').value,s=document.getElementById('field-size-chips'),sc=document.getElementById('size-chips-container'),co=document.getElementById('field-color-chips'),cc=document.getElementById('color-chips-container'),d=document.getElementById('dynamic-fields');document.getElementById('field-condition').classList.toggle('hidden',!USED_CATS.includes(c));s.classList.add('hidden');co.classList.add('hidden');d.classList.add('hidden');sc.innerHTML='';cc.innerHTML='';if(CLOTHES_CATS.includes(c)||SHOES_CATS.includes(c)){d.classList.remove('hidden');s.classList.remove('hidden');let z=[];if(c.includes("ุงุทูุงู"))z=SHOES_CATS.includes(c)?SIZES_SHOES_KIDS:SIZES_KIDS;else if(c.includes("ุญุฑููู"))z=SHOES_CATS.includes(c)?SIZES_SHOES_ADULT:SIZES_WOMEN;else z=SHOES_CATS.includes(c)?SIZES_SHOES_ADULT:SIZES_MEN;z.forEach(x=>sc.innerHTML+=`<label class="cursor-pointer"><input type="checkbox" name="smart-size" value="${x}" class="smart-option hidden"><div class="px-2 py-1 rounded-lg border border-slate-300 dark:border-slate-600 font-bold text-[10px] text-slate-500 hover:border-navy transition min-w-[30px] text-center">${x}</div></label>`)}if(CLOTHES_CATS.includes(c)){co.classList.remove('hidden');BASIC_COLORS.forEach(x=>cc.innerHTML+=`<label class="cursor-pointer"><input type="checkbox" name="smart-color" value="${x}" class="smart-option hidden"><div class="px-2 py-1 rounded-lg border border-slate-300 dark:border-slate-600 font-bold text-[10px] text-slate-500 hover:border-navy transition">${x}</div></label>`)}};
        window.toggleShipGov=()=>{const m=document.querySelector('input[name="ship-mode"]:checked').value;if(m==='specific')document.getElementById('ship-gov-container').classList.remove('hidden');else document.getElementById('ship-gov-container').classList.add('hidden')};
        window.submitListing=async()=>{if(!state.images.length)return showToast('ูุทููุจ ุตูุฑุฉ','e');const b=document.getElementById('btn-publish');b.disabled=true;b.innerHTML='<span>ุฌุงุฑู ุงููุดุฑ...</span>';const bd=document.querySelector('input[name="badge"]:checked').value,cn=document.getElementById('in-condition').value,ct=document.getElementById('in-cat').value,ft=[];document.querySelectorAll('.chip-checkbox:checked').forEach(c=>ft.push(c.value));const sz=[];document.querySelectorAll('input[name="smart-size"]:checked').forEach(c=>sz.push(c.value));const cl=[];document.querySelectorAll('input[name="smart-color"]:checked').forEach(c=>cl.push(c.value));const sm=document.querySelector('input[name="ship-mode"]:checked').value;let sg=[];if(sm==='specific'){document.querySelectorAll('input[name="ship-gov-check"]:checked').forEach(c=>sg.push(c.value));if(!sg.length){showToast('ุงุฎุชุฑ ูุญุงูุธุฉ','e');b.disabled=false;return}}await addDoc(collection(db,"listings"),{title:document.getElementById('in-title').value,price:Number(document.getElementById('in-price').value),category:ct,condition:cn,size:sz.length?sz:null,color:cl.length?cl:null,shippingMode:sm,shippingGov:sm==='specific'?sg:null,phone:document.getElementById('in-phone').value,desc:document.getElementById('in-desc').value,features:ft,images:state.images,badge:bd,status:'available',governorate:state.userData?state.userData.governorate:'',createdAt:serverTimestamp(),authorId:state.user.uid});showToast('ุชู ุงููุดุฑ');toggleAddModal();b.disabled=false;b.innerHTML='<span>ูุดุฑ ุงูุขู</span><i data-lucide="arrow-left" class="w-4 h-4"></i>';lucide.createIcons()};
        window.del=async(e,id)=>{e.stopPropagation();if(confirm('ุญุฐูุ'))await deleteDoc(doc(db,"listings",id))};
        window.toggleStatus=async(e,id,s)=>{e.stopPropagation();await updateDoc(doc(db,"listings",id),{status:s==='available'?'sold':'available'})};
        window.toggleChat=()=>{if(toggleModal('chat-modal')){if(!state.chatId&&state.chatStep===0&&!state.welcomeSent){state.welcomeSent=true;setTimeout(()=>botMsg(`ูุฑุญุจุงู ${state.user.displayName||''} ๐<br>ููู ูููููู ูุณุงุนุฏุชูุ`),100)}}};
        window.sendMsg=async()=>{const t=document.getElementById('chat-msg').value.trim();if(!t)return;document.getElementById('chat-msg').value='';userMsg(t);if(!state.chatId){if(state.chatStep===0){state.chatStep=2;const r=await addDoc(collection(db,"chats"),{userId:state.user.uid,userName:state.user.displayName||state.user.email,lastMsg:t,status:'waiting',messages:[{s:'bot',t:`ุงูุงุณู: ${state.user.displayName}`,d:new Date()},{s:'user',t,d:new Date()},{s:'bot',t:'ุฌุงุฑู ุงูุชูุตูู...',d:new Date()}],createdAt:serverTimestamp()});state.chatId=r.id;listenChat(r.id)}}else{const s=await getDocs(query(collection(db,"chats"),where('__name__','==',state.chatId)));if(!s.empty){const m=s.docs[0].data().messages;m.push({s:'user',t,d:new Date()});await updateDoc(doc(db,"chats",state.chatId),{messages:m,lastMsg:t,status:'waiting'})}}};
        function listenChat(id){onSnapshot(doc(db,"chats",id),s=>{if(s.exists()){const d=s.data();if(d.status==='closed'){state.chatId=null;state.chatStep=0;state.welcomeSent=false;document.getElementById('chat-box').innerHTML='';toggleModal('chat-modal');return}document.getElementById('chat-box').innerHTML='';d.messages.forEach(m=>{if(!m.t.startsWith('ุงูุงุณู'))(m.s==='user'?userMsg:botMsg)(m.t)})}})};
        function checkUserChat(){onSnapshot(query(collection(db,"chats"),where('userId','==',state.user.uid),where('status','!=','closed')),s=>{if(!s.empty){state.chatId=s.docs[0].id;state.chatStep=2;listenChat(state.chatId)}})};
        function userMsg(t){const d=document.createElement('div');d.className="flex justify-start";d.innerHTML=`<div class="bg-primary text-white px-3 py-2 rounded-xl rounded-tr-none shadow-sm text-xs max-w-[85%]">${t}</div>`;document.getElementById('chat-box').appendChild(d);document.getElementById('chat-box').scrollTop=9999}
        function botMsg(t){const d=document.createElement('div');d.className="flex justify-end";d.innerHTML=`<div class="bg-white dark:bg-slate-700 dark:text-white text-slate-800 px-3 py-2 rounded-xl rounded-tl-none shadow-sm text-xs max-w-[85%]">${t}</div>`;document.getElementById('chat-box').appendChild(d);document.getElementById('chat-box').scrollTop=9999}
        window.toggleAdminPanel=()=>{document.getElementById('admin-panel').classList.toggle('hidden');if(!document.getElementById('admin-panel').classList.contains('hidden'))refreshAdmin()};
        window.refreshAdmin=()=>{onSnapshot(query(collection(db,"chats"),where('status','!=','closed')),s=>{const l=document.getElementById('admin-users-list');l.innerHTML='';const c=[];s.forEach(d=>c.push({id:d.id,...d.data()}));c.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));c.forEach(dt=>{l.innerHTML+=`<div onclick="loadAdmin('${dt.id}','${dt.userName}')" class="p-3 mb-2 bg-white/5 rounded-xl cursor-pointer border border-white/10"><div class="font-bold text-xs text-white flex justify-between"><span>${dt.userName}</span>${dt.status==='waiting'?'<span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>':''}</div><div class="text-[10px] text-gray-400 truncate mt-1">${dt.lastMsg}</div></div>`})})};
        window.loadAdmin=(id,n)=>{state.activeAdminChat=id;document.getElementById('admin-chat-header').innerHTML=`<span>${n}</span><button onclick="kickUser()" id="btn-end-chat" class="hidden bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded flex items-center gap-1"><i data-lucide="slash" class="w-3 h-3"></i> ุฅููุงุก</button>`;document.getElementById('btn-end-chat').classList.remove('hidden');onSnapshot(doc(db,"chats",id),s=>{const b=document.getElementById('admin-msg-area');b.innerHTML='';if(!s.exists())return;s.data().messages.forEach(m=>{b.innerHTML+=`<div class="${m.s==='support'?'text-left':'text-right'} mb-2"><span class="inline-block px-3 py-2 rounded-lg text-xs ${m.s==='support'?'bg-primary text-white':'bg-white/10'}">${m.t}</span></div>`});b.scrollTop=9999})};
        window.sendAdminMsg=async()=>{const t=document.getElementById('admin-input').value;if(!t||!state.activeAdminChat)return;document.getElementById('admin-input').value='';const s=await getDocs(query(collection(db,"chats"),where('__name__','==',state.activeAdminChat)));const m=s.docs[0].data().messages;m.push({s:'support',t,d:new Date()});await updateDoc(doc(db,"chats",state.activeAdminChat),{messages:m,status:'active'})};
        window.kickUser=async()=>{if(confirm("ุฅููุงุกุ")){await updateDoc(doc(db,"chats",state.activeAdminChat),{status:'closed'});document.getElementById('admin-msg-area').innerHTML='';document.getElementById('btn-end-chat').classList.add('hidden');state.activeAdminChat=null}};
        
        // Lightbox
        window.openLightbox=s=>{if(!s||s.endsWith('?text=No+Image'))return;state.lightboxImages=state.detailsSliderImages.length?state.detailsSliderImages:(state.currentItem?state.currentItem.images:[]);state.lightboxIndex=state.lightboxImages.indexOf(s);if(state.lightboxIndex===-1)state.lightboxIndex=0;if(state.lightboxImages.length){document.getElementById('lightbox-img').src=state.lightboxImages[state.lightboxIndex];document.getElementById('lightbox').classList.remove('hidden')}};
        window.navigateLightbox=d=>{if(!state.lightboxImages.length)return;state.lightboxIndex+=d;if(state.lightboxIndex>=state.lightboxImages.length)state.lightboxIndex=0;else if(state.lightboxIndex<0)state.lightboxIndex=state.lightboxImages.length-1;document.getElementById('lightbox-img').src=state.lightboxImages[state.lightboxIndex]};
        window.closeLightbox=()=>{document.getElementById('lightbox').classList.add('hidden')};

        lucide.createIcons();
    </script>
</body>
</html>
