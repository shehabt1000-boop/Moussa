<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Smart Center Pro | Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ</title>
    
    <!-- Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f8fafc; padding-bottom: 80px; font-size: 13px; -webkit-tap-highlight-color: transparent; }
        
        /* Navigation */
        .nav-item { transition: all 0.2s; opacity: 0.7; border-bottom: 3px solid transparent; }
        .nav-item.active { opacity: 1; background: white; color: #1e3a8a; font-weight: 700; border-bottom-color: #fbbf24; transform: translateY(-2px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        /* Tabs */
        .tab-content { display: none; animation: fadeIn 0.2s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Scanner */
        .scanner-wrapper { border-radius: 0.75rem; overflow: hidden; background: black; position: relative; }
        #html5-qrcode-button-camera-stop { display: none !important; }

        /* Cards */
        .glass-card { background: white; border-radius: 0.75rem; padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; margin-bottom: 0.75rem; }

        /* Tables */
        .custom-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .custom-table thead { background-color: #f1f5f9; color: #1e293b; font-weight: 700; }
        .custom-table th, .custom-table td { padding: 0.5rem; border-bottom: 1px solid #e2e8f0; text-align: right; }
        .custom-table tr:last-child td { border-bottom: none; }
        .custom-table tbody tr:hover { background-color: #f8fafc; }

        /* Print */
        @media print {
            .no-print { display: none !important; }
            .print-area { position: absolute; top: 0; left: 0; width: 100%; background: white; z-index: 9999; }
        }

        /* Toggle Buttons */
        .toggle-btn-active { background-color: #ffffff; color: #1d4ed8; box-shadow: 0 1px 2px rgba(0,0,0,0.1); font-weight: 700; }
        .toggle-btn-inactive { background-color: transparent; color: #6b7280; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- Header -->
    <header class="bg-blue-900 text-white shadow-md sticky top-0 z-50 no-print">
        <div class="container mx-auto px-4 py-2 flex justify-between items-center">
            <h1 class="text-base font-bold flex items-center gap-2">ğŸ“ Smart Center</h1>
            <div class="text-[10px] bg-blue-800 px-2 py-1 rounded-full font-mono" id="headerDate"></div>
        </div>
        <div class="bg-blue-800 border-t border-blue-700">
            <div class="container mx-auto px-2">
                <div class="flex gap-1 overflow-x-auto py-2 no-scrollbar">
                    <button onclick="showTab('students', this)" class="nav-item active px-3 py-1.5 rounded text-xs text-blue-100 flex-shrink-0">Ø§Ù„Ø·Ù„Ø§Ø¨</button>
                    <button onclick="showTab('attendance', this)" class="nav-item px-3 py-1.5 rounded text-xs text-blue-100 flex-shrink-0">Ø§Ù„Ø­Ø¶ÙˆØ±</button>
                    <button onclick="showTab('accounting', this)" class="nav-item px-3 py-1.5 rounded text-xs text-blue-100 flex-shrink-0">Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©</button>
                    <button onclick="showTab('reports', this)" class="nav-item px-3 py-1.5 rounded text-xs text-blue-100 flex-shrink-0">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-3 max-w-4xl">
        
        <!-- ================= STUDENTS ================= -->
        <section id="students" class="tab-content active">
            <div class="glass-card border-r-4 border-blue-500 no-print">
                <h2 class="font-bold text-blue-900 mb-2 text-sm">ØªØ³Ø¬ÙŠÙ„ Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
                <div class="space-y-2">
                    <input type="text" id="stdName" class="w-full p-2 border rounded text-sm focus:ring-1 focus:ring-blue-500 outline-none" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø±Ø¨Ø§Ø¹ÙŠ">
                    
                    <!-- Parent Phone -->
                    <div class="flex items-center border rounded bg-white overflow-hidden">
                        <span class="bg-gray-100 px-3 py-2 text-gray-600 text-xs font-bold border-l">+20</span>
                        <input type="tel" id="stdPhone" class="w-full p-2 text-sm outline-none" placeholder="Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± (Ø¨Ø¯ÙˆÙ† 0 ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©)">
                    </div>

                    <select id="stdLevel" class="w-full p-2 border rounded bg-white text-sm">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø©...</option>
                        <optgroup label="Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©"><option value="1Ø¨">1Ø¨</option><option value="2Ø¨">2Ø¨</option><option value="3Ø¨">3Ø¨</option><option value="4Ø¨">4Ø¨</option><option value="5Ø¨">5Ø¨</option><option value="6Ø¨">6Ø¨</option></optgroup>
                        <optgroup label="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©"><option value="1Ø¹">1Ø¹</option><option value="2Ø¹">2Ø¹</option><option value="3Ø¹">3Ø¹</option></optgroup>
                        <optgroup label="Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©"><option value="1Ø«">1Ø«</option><option value="2Ø«">2Ø«</option><option value="3Ø«">3Ø«</option></optgroup>
                    </select>
                    <button onclick="registerStudent()" class="w-full bg-blue-600 text-white py-2 rounded font-bold shadow hover:bg-blue-700 text-sm">Ø­ÙØ¸ ÙˆØ¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯</button>
                </div>
            </div>

            <div class="glass-card">
                <div class="flex justify-between items-center mb-2 no-print">
                    <h2 class="font-bold text-sm">Ø§Ù„Ø·Ù„Ø§Ø¨ (<span id="stdCount">0</span>)</h2>
                    <div class="flex gap-2">
                        <input type="text" id="searchStd" onkeyup="renderStudents()" placeholder="Ø¨Ø­Ø«..." class="text-xs p-1 border rounded w-24">
                        <button onclick="printElement('studentsListArea')" class="bg-gray-800 text-white px-3 py-1 rounded text-xs">Ø·Ø¨Ø§Ø¹Ø©</button>
                    </div>
                </div>
                
                <div id="studentsListArea" class="overflow-x-auto">
                    <h2 class="text-center font-bold text-xl mb-4 hidden print-header">Ù‚Ø§Ø¦Ù…Ø© Ø·Ù„Ø§Ø¨ Ø§Ù„Ø³Ù†ØªØ±</h2>
                    <table class="custom-table">
                        <thead>
                            <tr><th>Ù…</th><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</th><th class="no-print">Ø¥Ø¬Ø±Ø§Ø¡</th></tr>
                        </thead>
                        <tbody id="studentsTable"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- ================= ATTENDANCE ================= -->
        <section id="attendance" class="tab-content">
            <div class="glass-card text-center">
                <h2 class="text-lg font-bold text-blue-900 mb-3">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</h2>
                
                <div class="flex bg-gray-100 p-1 rounded mb-3 no-print">
                    <button onclick="setAttMode('scan')" id="btnAttScan" class="flex-1 py-1.5 rounded text-xs toggle-btn-active transition-all">ğŸ“· Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
                    <button onclick="setAttMode('manual')" id="btnAttManual" class="flex-1 py-1.5 rounded text-xs toggle-btn-inactive transition-all">âŒ¨ï¸ ÙŠØ¯ÙˆÙŠ</button>
                </div>

                <div id="attScanArea" class="relative">
                    <div id="reader" class="scanner-wrapper h-56 w-full mb-2"></div>
                    <div id="scanFeedback" class="absolute inset-0 flex items-center justify-center bg-green-500/90 hidden z-10 rounded-lg">
                        <div class="text-white font-bold text-xl animate-bounce">âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„</div>
                    </div>
                    <div class="flex justify-center gap-2 no-print">
                        <button onclick="startScanner('reader', 'attendance')" class="bg-blue-600 text-white px-4 py-1 rounded shadow text-xs">ØªØ´ØºÙŠÙ„</button>
                        <button onclick="stopScanner()" class="bg-red-100 text-red-600 px-4 py-1 rounded text-xs">Ø¥ÙŠÙ‚Ø§Ù</button>
                    </div>
                </div>

                <div id="attManualArea" class="hidden">
                    <input type="number" id="manualAttID" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯" class="w-full text-center text-2xl font-bold p-2 border-2 border-blue-200 rounded mb-2 font-mono">
                    <button onclick="manualAttendance()" class="w-full bg-blue-600 text-white py-2 rounded font-bold text-sm">ØªØ³Ø¬ÙŠÙ„</button>
                </div>

                <div class="grid grid-cols-2 gap-2 mt-4 no-print">
                    <div onclick="openAttendanceModal('present')" class="bg-green-50 p-2 rounded border border-green-200 cursor-pointer hover:bg-green-100 transition">
                        <span class="block text-xl font-bold text-green-600" id="presentCount">0</span>
                        <span class="text-[10px] text-green-800 font-bold">Ø­Ø¶ÙˆØ± (Ø¹Ø±Ø¶)</span>
                    </div>
                    <div onclick="openAttendanceModal('absent')" class="bg-red-50 p-2 rounded border border-red-200 cursor-pointer hover:bg-red-100 transition">
                        <span class="block text-xl font-bold text-red-600" id="absentCount">0</span>
                        <span class="text-[10px] text-red-800 font-bold">ØºÙŠØ§Ø¨ (Ø¹Ø±Ø¶)</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- ================= ACCOUNTING ================= -->
        <section id="accounting" class="tab-content">
            <div class="grid md:grid-cols-2 gap-3">
                <div class="glass-card border-t-4 border-green-500">
                    <h3 class="font-bold text-green-700 mb-2 text-sm">ğŸ’µ Ø§Ø³ØªÙ„Ø§Ù… Ù†Ù‚Ø¯ÙŠØ©</h3>
                    <div class="flex gap-2 mb-2 no-print">
                        <button onclick="togglePayMethod('scan')" id="btnPayScan" class="flex-1 py-1 rounded text-xs font-bold toggle-btn-active">Ù…Ø³Ø­ Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
                        <button onclick="togglePayMethod('manual')" id="btnPayManual" class="flex-1 py-1 rounded text-xs font-bold toggle-btn-inactive">Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯</button>
                    </div>
                    <div id="payScanDiv" class="mb-2">
                        <div id="payReader" class="scanner-wrapper h-32 mb-2"></div>
                        <button onclick="startScanner('payReader', 'payment')" class="w-full bg-green-600 text-white py-1 rounded text-xs no-print">ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
                    </div>
                    <div id="payManualDiv" class="hidden flex gap-2 mb-2">
                        <input type="number" id="paySearchID" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨" class="flex-1 p-1.5 border rounded text-center font-bold text-sm">
                        <button onclick="searchStudentForPay()" class="bg-green-600 text-white px-3 rounded text-xs">ğŸ”</button>
                    </div>
                    <div id="paymentForm" class="hidden bg-yellow-50 p-2 rounded border border-yellow-200">
                        <div class="flex justify-between text-xs mb-2 font-bold">
                            <span id="payStdName"></span>
                            <span id="payStdID" class="font-mono bg-white px-1 rounded"></span>
                        </div>
                        <div class="flex gap-2 mb-2">
                            <input type="number" id="payAmount" value="100" class="w-1/3 p-1 border rounded text-center font-bold text-sm">
                            <select id="payType" class="w-2/3 p-1 border rounded text-xs">
                                <option value="Ø´Ù‡Ø±ÙŠØ©">Ø§Ø´ØªØ±Ø§Ùƒ Ø´Ù‡Ø±</option>
                                <option value="Ù…Ø°ÙƒØ±Ø©">Ù…Ø°ÙƒØ±Ø©</option>
                                <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                            </select>
                        </div>
                        <button onclick="confirmPayment()" class="w-full bg-green-600 text-white py-1.5 rounded font-bold shadow text-xs">ØªØ£ÙƒÙŠØ¯</button>
                    </div>
                </div>

                <div class="glass-card border-t-4 border-red-500">
                    <h3 class="font-bold text-red-700 mb-2 text-sm">ğŸ“‰ ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙØ§Øª</h3>
                    <div class="space-y-2">
                        <select id="expType" class="w-full p-1.5 border rounded text-xs bg-white">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù†Ø¯...</option>
                            <option value="Ø±ÙˆØ§ØªØ¨">Ø±ÙˆØ§ØªØ¨</option>
                            <option value="ÙƒÙ‡Ø±Ø¨Ø§Ø¡">ÙƒÙ‡Ø±Ø¨Ø§Ø¡/Ù…ÙŠØ§Ù‡</option>
                            <option value="Ø¥ÙŠØ¬Ø§Ø±">Ø¥ÙŠØ¬Ø§Ø±</option>
                            <option value="ØµÙŠØ§Ù†Ø©">ØµÙŠØ§Ù†Ø©</option>
                            <option value="Ø·Ø¨Ø§Ø¹Ø©">Ø·Ø¨Ø§Ø¹Ø©</option>
                            <option value="Ø¨ÙˆÙÙŠÙ‡">Ø¨ÙˆÙÙŠÙ‡</option>
                            <option value="Ù†Ø«Ø±ÙŠØ§Øª">Ù†Ø«Ø±ÙŠØ§Øª</option>
                        </select>
                        <div class="flex gap-2">
                            <input type="number" id="expAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" class="flex-1 p-1.5 border rounded text-xs">
                            <input type="text" id="expNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø©" class="flex-[1.5] p-1.5 border rounded text-xs">
                        </div>
                        <button onclick="addExpense()" class="w-full bg-red-50 text-red-600 border border-red-200 py-1.5 rounded font-bold hover:bg-red-100 text-xs">ØªØ³Ø¬ÙŠÙ„</button>
                    </div>
                </div>
            </div>
            
            <!-- Summary & Daily Tables -->
            <div class="bg-slate-800 text-white p-3 rounded-xl shadow-lg mt-3">
                <div class="flex justify-between items-end mb-4">
                    <div>
                        <p class="text-[10px] opacity-70">Ø§Ù„ØµØ§ÙÙŠ Ø§Ù„ÙŠÙˆÙ…</p>
                        <p class="text-2xl font-bold" id="netProfit">0</p>
                    </div>
                    <div class="text-left text-xs">
                        <div class="text-green-400">ÙˆØ§Ø±Ø¯: <span id="totalRev">0</span></div>
                        <div class="text-red-400">ØµØ§Ø¯Ø±: <span id="totalExp">0</span></div>
                    </div>
                </div>
                
                <!-- Today's Tables -->
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-white/10 p-2 rounded">
                        <h4 class="text-[10px] font-bold text-green-300 mb-1 border-b border-white/20 pb-1">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h4>
                        <div id="todayRevList" class="h-24 overflow-y-auto text-[10px] space-y-1"></div>
                    </div>
                    <div class="bg-white/10 p-2 rounded">
                        <h4 class="text-[10px] font-bold text-red-300 mb-1 border-b border-white/20 pb-1">Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙŠÙˆÙ…</h4>
                        <div id="todayExpList" class="h-24 overflow-y-auto text-[10px] space-y-1"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ================= REPORTS ================= -->
        <section id="reports" class="tab-content">
            
            <!-- Student Profile Search -->
            <div class="glass-card border-t-4 border-blue-600 mb-3">
                <h3 class="font-bold mb-2 text-blue-900 flex items-center gap-2 text-sm">
                    <span>ğŸ‘¤</span> Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨ (Ù…Ù„Ù Ø´Ø§Ù…Ù„)
                </h3>
                <div class="flex gap-2 mb-2">
                    <input type="text" id="reportStudentSearch" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯" class="flex-1 p-1.5 border rounded text-sm">
                    <button onclick="generateStudentReport()" class="bg-blue-600 text-white px-3 rounded font-bold text-xs">Ø¨Ø­Ø«</button>
                </div>
                <div id="studentReportResult" class="hidden bg-gray-50 p-3 rounded border border-gray-200 text-xs"></div>
            </div>

            <!-- General Reports -->
            <div class="glass-card border-t-4 border-indigo-500 mb-3">
                <h3 class="font-bold mb-2 text-indigo-900 text-sm">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¹Ø§Ù…Ø©</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
                    <div>
                        <label class="text-[10px] text-gray-500 block mb-1">Ø§Ù„Ù†ÙˆØ¹</label>
                        <select id="reportType" onchange="toggleReportInputs()" class="w-full p-1.5 border rounded bg-white text-xs">
                            <option value="daily">ÙŠÙˆÙ…ÙŠ</option>
                            <option value="monthly">Ø´Ù‡Ø±ÙŠ</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 block mb-1">Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label>
                        <select id="reportStage" class="w-full p-1.5 border rounded bg-white text-xs">
                            <option value="all">Ø§Ù„ÙƒÙ„</option>
                            <optgroup label="Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©"><option value="1Ø¨">1Ø¨</option><option value="2Ø¨">2Ø¨</option><option value="3Ø¨">3Ø¨</option><option value="4Ø¨">4Ø¨</option><option value="5Ø¨">5Ø¨</option><option value="6Ø¨">6Ø¨</option></optgroup>
                            <optgroup label="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©"><option value="1Ø¹">1Ø¹</option><option value="2Ø¹">2Ø¹</option><option value="3Ø¹">3Ø¹</option></optgroup>
                            <optgroup label="Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©"><option value="1Ø«">1Ø«</option><option value="2Ø«">2Ø«</option><option value="3Ø«">3Ø«</option></optgroup>
                        </select>
                    </div>
                    <div id="divDateInput">
                        <label class="text-[10px] text-gray-500 block mb-1">Ø§Ù„ÙŠÙˆÙ…</label>
                        <input type="date" id="reportDate" class="w-full p-1.5 border rounded text-xs">
                    </div>
                    <div id="divMonthInput" class="hidden">
                        <label class="text-[10px] text-gray-500 block mb-1">Ø§Ù„Ø´Ù‡Ø±</label>
                        <input type="month" id="reportMonth" class="w-full p-1.5 border rounded text-xs">
                    </div>
                </div>
                <button onclick="generateAdvancedReport()" class="w-full bg-indigo-600 text-white py-1.5 rounded font-bold shadow hover:bg-indigo-700 text-xs">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                
                <div id="reportResult" class="mt-3 hidden bg-gray-50 p-3 rounded border border-gray-200 text-xs"></div>
            </div>

            <div class="glass-card border-t-4 border-yellow-500">
                <h3 class="font-bold mb-2 flex items-center gap-2 text-yellow-800 text-sm"><span>ğŸ’¾</span> Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h3>
                <div class="flex gap-2">
                    <button onclick="exportData()" class="flex-1 bg-yellow-100 text-yellow-800 py-1.5 rounded font-bold text-xs border border-yellow-300">ØªØ­Ù…ÙŠÙ„</button>
                    <div class="relative flex-1">
                        <input type="file" id="importFile" onchange="importData(this)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <button class="w-full bg-gray-100 text-gray-700 py-1.5 rounded font-bold text-xs border border-gray-300">Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button>
                    </div>
                </div>
                <button onclick="clearAllData()" class="w-full mt-2 text-red-500 text-[10px] hover:underline">Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </div>
        </section>
    </main>

    <!-- MODAL: Student Card -->
    <div id="studentModal" class="fixed inset-0 bg-black/80 hidden z-[150] flex items-center justify-center p-4 no-print">
        <div class="bg-white rounded-xl w-full max-w-xs p-5 text-center relative shadow-2xl">
            <button onclick="closeModal('studentModal')" class="absolute top-2 right-3 text-gray-500 text-xl font-bold">&times;</button>
            
            <div id="studentCardPrintArea" class="border-4 border-double border-blue-200 p-4 rounded-xl bg-white mb-4">
                <h3 class="font-bold text-base mb-2 text-blue-900">Ø¨Ø·Ø§Ù‚Ø© Ø·Ø§Ù„Ø¨</h3>
                <div id="modalQr" class="flex justify-center mb-2"></div>
                <p id="modalCode" class="text-2xl font-black font-mono text-blue-600 mb-1"></p>
                <h2 id="modalName" class="text-lg font-bold mb-1"></h2>
                <p id="modalLevel" class="text-gray-500 text-sm"></p>
                <p class="text-[10px] text-gray-400 mt-2">Smart Center System</p>
            </div>

            <div class="grid grid-cols-2 gap-2">
                <button onclick="printElement('studentCardPrintArea')" class="bg-gray-800 text-white py-1.5 rounded text-xs font-bold">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                <button onclick="shareStudentPdf()" class="bg-red-600 text-white py-1.5 rounded text-xs font-bold">ğŸ“„ Ù…Ø´Ø§Ø±ÙƒØ© PDF</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Lists (Attendance/Finance) -->
    <div id="detailsModal" class="fixed inset-0 bg-black/80 hidden z-[100] flex items-center justify-center p-4 no-print">
        <div class="bg-white rounded-xl w-full max-w-xl p-0 h-[80vh] flex flex-col shadow-2xl overflow-hidden">
            <div class="flex justify-between items-center p-3 border-b bg-gray-50">
                <h3 id="detailsTitle" class="font-bold text-sm text-gray-800"></h3>
                <button onclick="closeModal('detailsModal')" class="text-red-500 font-bold text-lg">&times;</button>
            </div>
            
            <div id="modalFilterContainer" class="p-2 bg-gray-100 border-b hidden">
                <select id="attFilterLevel" onchange="filterAttendanceList()" class="w-full p-1.5 border rounded bg-white text-xs">
                    <option value="all">ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„</option>
                    <optgroup label="Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©"><option value="1Ø¨">1Ø¨</option><option value="2Ø¨">2Ø¨</option><option value="3Ø¨">3Ø¨</option><option value="4Ø¨">4Ø¨</option><option value="5Ø¨">5Ø¨</option><option value="6Ø¨">6Ø¨</option></optgroup>
                    <optgroup label="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©"><option value="1Ø¹">1Ø¹</option><option value="2Ø¹">2Ø¹</option><option value="3Ø¹">3Ø¹</option></optgroup>
                    <optgroup label="Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©"><option value="1Ø«">1Ø«</option><option value="2Ø«">2Ø«</option><option value="3Ø«">3Ø«</option></optgroup>
                </select>
            </div>

            <div class="overflow-y-auto flex-1 p-0">
                <table class="custom-table">
                    <thead id="detailsTableHead"></thead>
                    <tbody id="detailsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-xl z-[200] hidden font-bold text-sm"></div>

    <script>
        // --- Config ---
        const stageMap = {
            "1Ø¨": "Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "2Ø¨": "Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "3Ø¨": "Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ",
            "4Ø¨": "Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "5Ø¨": "Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "6Ø¨": "Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ",
            "1Ø¹": "Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ", "2Ø¹": "Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ", "3Ø¹": "Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ",
            "1Ø«": "Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ", "2Ø«": "Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ", "3Ø«": "Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ"
        };

        // --- Data ---
        let students = JSON.parse(localStorage.getItem('sc_students')) || [];
        let attendance = JSON.parse(localStorage.getItem('sc_attendance')) || {};
        let accounting = JSON.parse(localStorage.getItem('sc_accounting')) || { revenues: [], expenses: [] };
        const today = new Date().toISOString().split('T')[0];

        // --- Global Variables ---
        let currentReportData = { present: [], absent: [], revenues: [], expenses: [] };
        let currentStudentReport = null; 
        let currentModalStudentId = null;
        let currentParentPhone = null;

        // --- Init ---
        window.onload = () => {
            document.getElementById('headerDate').innerText = today;
            document.getElementById('reportDate').value = today;
            renderStudents();
            updateFinance();
            updateCounters();
        };

        // --- Navigation ---
        async function showTab(id, btn) {
            if(isScannerRunning) await stopScanner();
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(btn) btn.classList.add('active');
        }

        // --- Students ---
        function registerStudent() {
            const name = document.getElementById('stdName').value;
            const level = document.getElementById('stdLevel').value;
            let phone = document.getElementById('stdPhone').value;

            if(!name || !level) return showToast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            
            // Clean phone number (remove leading 0)
            if(phone.startsWith('0')) phone = phone.substring(1);

            let id;
            do { id = Math.floor(1000 + Math.random() * 9000).toString(); } 
            while (students.some(s => s.id === id));

            students.push({ id, name, level, phone, date: today });
            saveData();
            renderStudents();
            openStudentModal(id);
            document.getElementById('stdName').value = '';
            document.getElementById('stdPhone').value = '';
            showToast('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„', 'success');
        }

        function renderStudents() {
            const query = document.getElementById('searchStd').value.toLowerCase();
            const tbody = document.getElementById('studentsTable');
            const filtered = students.filter(s => s.name.toLowerCase().includes(query) || s.id.includes(query));
            
            document.getElementById('stdCount').innerText = filtered.length;
            
            tbody.innerHTML = filtered.map((s, index) => `
                <tr class="cursor-pointer" onclick="openStudentModal('${s.id}')">
                    <td class="text-gray-500">${index + 1}</td>
                    <td class="font-mono font-bold text-blue-600">${s.id}</td>
                    <td class="font-bold">${s.name}</td>
                    <td>${stageMap[s.level] || s.level}</td>
                    <td class="text-xs text-gray-500" dir="ltr">+20 ${s.phone || '-'}</td>
                    <td class="no-print" onclick="event.stopPropagation()">
                        <button onclick="delStudent('${s.id}')" class="text-red-500 text-xs font-bold">Ø­Ø°Ù</button>
                    </td>
                </tr>
            `).join('');
        }

        // --- Student Modal & Printing ---
        function openStudentModal(id) {
            const s = students.find(st => st.id === id);
            if(!s) return;
            currentModalStudentId = id;
            document.getElementById('modalName').innerText = s.name;
            document.getElementById('modalCode').innerText = s.id;
            document.getElementById('modalLevel').innerText = stageMap[s.level] || s.level;
            document.getElementById('modalQr').innerHTML = '';
            new QRCode(document.getElementById("modalQr"), { text: s.id, width: 100, height: 100 });
            document.getElementById('studentModal').classList.remove('hidden');
        }

        function printElement(elemId) {
            const content = document.getElementById(elemId);
            content.classList.add('print-area');
            window.print();
            content.classList.remove('print-area');
        }

        function shareStudentPdf() {
            const s = students.find(st => st.id === currentModalStudentId);
            const element = document.getElementById('studentCardPrintArea');
            const opt = {
                margin: 10,
                filename: `Ø¨Ø·Ø§Ù‚Ø©_${s.name}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a6', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }

        function delStudent(id) {
            if(confirm('Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ')) {
                students = students.filter(s => s.id !== id);
                saveData();
                renderStudents();
            }
        }

        // --- Attendance ---
        let html5QrCode = null;
        let isScannerRunning = false;
        let isPaused = false;

        async function startScanner(elemId, mode) {
            if(isScannerRunning) return;
            html5QrCode = new Html5Qrcode(elemId);
            await html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => {
                if(isPaused) return;
                if(mode === 'attendance') handleAttendanceScan(decodedText);
                else if(mode === 'payment') handlePaymentScan(decodedText);
            });
            isScannerRunning = true;
        }

        async function stopScanner() {
            if(html5QrCode) { await html5QrCode.stop(); html5QrCode.clear(); html5QrCode = null; isScannerRunning = false; }
        }

        function handleAttendanceScan(id) {
            isPaused = true;
            const student = students.find(s => s.id === id);
            if(student) {
                if(!attendance[today]) attendance[today] = [];
                const isPresent = attendance[today].some(entry => (typeof entry === 'string' ? entry : entry.id) === id);
                if(!isPresent) {
                    attendance[today].push({ id: id, time: new Date().toLocaleTimeString('ar-EG') });
                    saveData();
                    updateCounters();
                    showScanFeedback(true);
                    playSound('success');
                } else { showToast('Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹', 'warning'); playSound('error'); }
            } else { showToast('ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­', 'error'); playSound('error'); }
            setTimeout(() => { isPaused = false; showScanFeedback(false); }, 2000);
        }

        function showScanFeedback(show) {
            const el = document.getElementById('scanFeedback');
            if(show) el.classList.remove('hidden'); else el.classList.add('hidden');
        }

        function setAttMode(mode) {
            stopScanner().then(() => {
                const btnScan = document.getElementById('btnAttScan');
                const btnManual = document.getElementById('btnAttManual');
                if(mode === 'scan') {
                    document.getElementById('attScanArea').classList.remove('hidden');
                    document.getElementById('attManualArea').classList.add('hidden');
                    btnScan.classList.add('toggle-btn-active'); btnScan.classList.remove('toggle-btn-inactive');
                    btnManual.classList.add('toggle-btn-inactive'); btnManual.classList.remove('toggle-btn-active');
                } else {
                    document.getElementById('attScanArea').classList.add('hidden');
                    document.getElementById('attManualArea').classList.remove('hidden');
                    btnManual.classList.add('toggle-btn-active'); btnManual.classList.remove('toggle-btn-inactive');
                    btnScan.classList.add('toggle-btn-inactive'); btnScan.classList.remove('toggle-btn-active');
                }
            });
        }

        function manualAttendance() {
            const id = document.getElementById('manualAttID').value;
            handleAttendanceScan(id);
            document.getElementById('manualAttID').value = '';
        }

        // --- Attendance List Modal Logic ---
        let currentAttType = 'present';
        
        function openAttendanceModal(type) {
            currentAttType = type;
            const title = type === 'present' ? 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…' : 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…';
            document.getElementById('detailsTitle').innerText = title;
            document.getElementById('modalFilterContainer').classList.remove('hidden'); // Show filter
            
            const thead = document.getElementById('detailsTableHead');
            thead.innerHTML = `<tr><th>Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>${type === 'present' ? 'ÙˆÙ‚Øª Ø§Ù„Ø­Ø¶ÙˆØ±' : 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØºÙŠØ§Ø¨'}</th></tr>`;
            
            document.getElementById('detailsModal').classList.remove('hidden');
            filterAttendanceList();
        }

        function filterAttendanceList() {
            const levelFilter = document.getElementById('attFilterLevel').value;
            const todayRecords = attendance[today] || [];
            const presentIds = todayRecords.map(r => typeof r === 'string' ? r : r.id);
            const tbody = document.getElementById('detailsTableBody');
            
            let list = [];
            let filteredStudents = students;
            
            if(levelFilter !== 'all') {
                filteredStudents = students.filter(s => s.level === levelFilter);
            }

            if(currentAttType === 'present') {
                list = filteredStudents.filter(s => presentIds.includes(s.id)).map(s => {
                    const rec = todayRecords.find(r => (typeof r === 'string' ? r : r.id) === s.id);
                    return { ...s, time: rec.time || '-' };
                });
            } else {
                list = filteredStudents.filter(s => !presentIds.includes(s.id)).map(s => ({ ...s, time: today }));
            }

            if(list.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
            } else {
                tbody.innerHTML = list.map((s, index) => `
                    <tr class="cursor-pointer hover:bg-blue-50" onclick="openStudentModal('${s.id}')">
                        <td class="text-gray-500">${index + 1}</td>
                        <td class="font-bold">${s.name}</td>
                        <td class="font-mono text-blue-600">${s.id}</td>
                        <td>${stageMap[s.level] || s.level}</td>
                        <td class="${currentAttType === 'present' ? 'text-green-600' : 'text-red-600'}">${s.time}</td>
                    </tr>
                `).join('');
            }
        }

        function updateCounters() {
            const present = attendance[today] ? attendance[today].length : 0;
            document.getElementById('presentCount').innerText = present;
            document.getElementById('absentCount').innerText = students.length - present;
        }

        // --- Accounting ---
        let currentPayStudent = null;
        function togglePayMethod(method) {
            const btnScan = document.getElementById('btnPayScan');
            const btnManual = document.getElementById('btnPayManual');
            if(method === 'scan') {
                document.getElementById('payScanDiv').classList.remove('hidden');
                document.getElementById('payManualDiv').classList.add('hidden');
                btnScan.classList.add('toggle-btn-active'); btnScan.classList.remove('toggle-btn-inactive');
                btnManual.classList.add('toggle-btn-inactive'); btnManual.classList.remove('toggle-btn-active');
            } else {
                document.getElementById('payScanDiv').classList.add('hidden');
                document.getElementById('payManualDiv').classList.remove('hidden');
                btnManual.classList.add('toggle-btn-active'); btnManual.classList.remove('toggle-btn-inactive');
                btnScan.classList.add('toggle-btn-inactive'); btnScan.classList.remove('toggle-btn-active');
                stopScanner();
            }
        }

        function handlePaymentScan(id) {
            if(!document.getElementById('paymentForm').classList.contains('hidden')) return;
            const student = students.find(s => s.id === id);
            if(student) {
                currentPayStudent = student;
                document.getElementById('paymentForm').classList.remove('hidden');
                document.getElementById('payStdName').innerText = student.name;
                document.getElementById('payStdID').innerText = student.id;
                playSound('success');
            } else { showToast('Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error'); }
        }

        function searchStudentForPay() { handlePaymentScan(document.getElementById('paySearchID').value); }

        function confirmPayment() {
            const amount = parseFloat(document.getElementById('payAmount').value);
            const type = document.getElementById('payType').value;
            const time = new Date().toLocaleTimeString('ar-EG');
            accounting.revenues.push({ date: today, time: time, stdId: currentPayStudent.id, name: currentPayStudent.name, amount, type });
            saveData(); updateFinance();
            document.getElementById('paymentForm').classList.add('hidden');
            document.getElementById('paySearchID').value = '';
            showToast('ØªÙ… Ø§Ù„Ø¯ÙØ¹', 'success');
        }

        function addExpense() {
            const type = document.getElementById('expType').value;
            const note = document.getElementById('expNote').value;
            const amount = parseFloat(document.getElementById('expAmount').value);
            const time = new Date().toLocaleTimeString('ar-EG');
            if(!type || !amount) return showToast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            accounting.expenses.push({ date: today, time: time, desc: `${type} ${note ? '- '+note : ''}`, amount });
            saveData(); updateFinance();
            document.getElementById('expType').value = ''; document.getElementById('expNote').value = ''; document.getElementById('expAmount').value = '';
            showToast('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„', 'success');
        }

        function updateFinance() {
            const rev = accounting.revenues.reduce((sum, r) => sum + r.amount, 0);
            const exp = accounting.expenses.reduce((sum, e) => sum + e.amount, 0);
            document.getElementById('totalRev').innerText = rev;
            document.getElementById('totalExp').innerText = exp;
            document.getElementById('netProfit').innerText = (rev - exp);

            // Update Today's Tables
            const todayRevs = accounting.revenues.filter(r => r.date === today);
            const todayExps = accounting.expenses.filter(e => e.date === today);

            document.getElementById('todayRevList').innerHTML = todayRevs.map(r => 
                `<div class="flex justify-between border-b border-white/10 pb-1"><span>${r.name}</span><span>${r.amount}</span></div>`
            ).join('') || '<div class="text-center opacity-50">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div>';

            document.getElementById('todayExpList').innerHTML = todayExps.map(e => 
                `<div class="flex justify-between border-b border-white/10 pb-1"><span>${e.desc}</span><span>${e.amount}</span></div>`
            ).join('') || '<div class="text-center opacity-50">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div>';
        }

        // --- Reports ---
        function toggleReportInputs() {
            const type = document.getElementById('reportType').value;
            if(type === 'daily') {
                document.getElementById('divDateInput').classList.remove('hidden');
                document.getElementById('divMonthInput').classList.add('hidden');
            } else {
                document.getElementById('divDateInput').classList.add('hidden');
                document.getElementById('divMonthInput').classList.remove('hidden');
            }
        }

        // --- NEW: Student Profile Report ---
        function generateStudentReport() {
            const query = document.getElementById('reportStudentSearch').value.toLowerCase();
            const student = students.find(s => s.name.toLowerCase().includes(query) || s.id === query);
            const resDiv = document.getElementById('studentReportResult');

            if(!student) {
                resDiv.innerHTML = '<p class="text-red-500 text-center">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨</p>';
                resDiv.classList.remove('hidden');
                return;
            }

            currentParentPhone = student.phone;

            // Calculate Stats
            let presentDays = 0;
            let absentDays = 0;
            let absentDates = [];
            let totalPaid = 0;
            let payments = [];

            // Duration
            const joinDate = new Date(student.date);
            const now = new Date();
            const diffTime = Math.abs(now - joinDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

            // Attendance Logic
            Object.keys(attendance).forEach(date => {
                if(date >= student.date) { 
                    const dayRecords = attendance[date];
                    const isPresent = dayRecords.some(r => (typeof r === 'string' ? r : r.id) === student.id);
                    if(isPresent) {
                        presentDays++;
                    } else {
                        absentDays++;
                        absentDates.push(date);
                    }
                }
            });

            // Finance Logic
            payments = accounting.revenues.filter(r => r.stdId === student.id);
            totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);

            // Prepare Share Text
            currentStudentReport = `*ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø§Ù„Ø¨: ${student.name}*\n` +
                                   `Ø§Ù„ÙƒÙˆØ¯: ${student.id}\n` +
                                   `ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…: ${student.date}\n` +
                                   `Ù…Ø¯Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: ${diffDays} ÙŠÙˆÙ…\n` +
                                   `----------------\n` +
                                   `*Ø§Ù„ØºÙŠØ§Ø¨ (${absentDays} ÙŠÙˆÙ…):*\n` +
                                   (absentDates.length ? absentDates.join('\n') : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØºÙŠØ§Ø¨') + `\n` +
                                   `----------------\n` +
                                   `*Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª (${totalPaid} Ø¬.Ù…):*\n` +
                                   (payments.length ? payments.map(p => `${p.type}: ${p.amount} (${p.date})`).join('\n') : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¯ÙÙˆØ¹Ø§Øª');

            // Render HTML
            resDiv.innerHTML = `
                <div class="border-b pb-2 mb-2">
                    <h4 class="font-bold text-lg text-blue-900">${student.name}</h4>
                    <p class="text-gray-500 text-xs">ÙƒÙˆØ¯: ${student.id} | ${stageMap[student.level]}</p>
                    <p class="text-gray-400 text-[10px]">Ø§Ù†Ø¶Ù…: ${student.date} (Ù…Ù†Ø° ${diffDays} ÙŠÙˆÙ…)</p>
                </div>
                
                <div class="grid grid-cols-2 gap-2 mb-4 text-center">
                    <div class="bg-green-100 p-2 rounded">
                        <div class="text-xs">Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</div>
                        <div class="font-bold text-green-700">${presentDays}</div>
                    </div>
                    <div class="bg-red-100 p-2 rounded">
                        <div class="text-xs">Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨</div>
                        <div class="font-bold text-red-700">${absentDays}</div>
                    </div>
                </div>

                <div class="mb-4">
                    <h5 class="font-bold text-xs mb-1">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª (${totalPaid} Ø¬.Ù…)</h5>
                    <div class="max-h-32 overflow-y-auto text-xs border rounded p-1">
                        ${payments.length ? payments.map(p => `<div class="flex justify-between border-b p-1"><span>${p.type}</span><span>${p.amount} (${p.date})</span></div>`).join('') : '<p class="text-center">Ù„Ø§ ÙŠÙˆØ¬Ø¯</p>'}
                    </div>
                </div>

                <div class="mb-4">
                    <h5 class="font-bold text-xs mb-1">Ø³Ø¬Ù„ Ø§Ù„ØºÙŠØ§Ø¨</h5>
                    <div class="max-h-32 overflow-y-auto text-xs border rounded p-1 text-red-600">
                        ${absentDates.length ? absentDates.join('<br>') : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØºÙŠØ§Ø¨'}
                    </div>
                </div>

                <button onclick="shareStudentReport()" class="w-full bg-green-600 text-white py-1.5 rounded text-xs font-bold flex items-center justify-center gap-2">
                    <span>ğŸ“±</span> Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙˆØ§ØªØ³Ø§Ø¨
                </button>
            `;
            resDiv.classList.remove('hidden');
        }

        function shareStudentReport() {
            if(currentParentPhone) {
                const url = `https://wa.me/20${currentParentPhone}?text=${encodeURIComponent(currentStudentReport)}`;
                window.open(url, '_blank');
            } else {
                alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø£Ù…Ø± Ù…Ø³Ø¬Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨');
            }
        }

        function generateAdvancedReport() {
            const type = document.getElementById('reportType').value;
            const stage = document.getElementById('reportStage').value;
            const dateInput = document.getElementById('reportDate').value;
            const monthInput = document.getElementById('reportMonth').value;
            const resDiv = document.getElementById('reportResult');

            let totalRev = 0, totalExp = 0;
            
            // Reset Global Data
            currentReportData = { present: [], absent: [], revenues: [], expenses: [] };

            let targetStudents = students;
            if(stage !== 'all') targetStudents = students.filter(s => s.level === stage);

            if(type === 'daily') {
                if(!dateInput) return showToast('Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®', 'error');
                const dayRecords = attendance[dateInput] || [];
                const presentIds = dayRecords.map(r => typeof r === 'string' ? r : r.id);
                
                currentReportData.present = targetStudents.filter(s => presentIds.includes(s.id)).map(s => {
                    const rec = dayRecords.find(r => (typeof r === 'string' ? r : r.id) === s.id);
                    return { ...s, time: rec.time || '-' };
                });
                currentReportData.absent = targetStudents.filter(s => !presentIds.includes(s.id)).map(s => ({ ...s, time: 'ØºÙŠØ§Ø¨' }));
                currentReportData.revenues = accounting.revenues.filter(r => r.date === dateInput);
                currentReportData.expenses = accounting.expenses.filter(e => e.date === dateInput);
            } else {
                // Monthly Logic
                if(!monthInput) return showToast('Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±', 'error');
                
                // Finance
                currentReportData.revenues = accounting.revenues.filter(r => r.date.startsWith(monthInput));
                currentReportData.expenses = accounting.expenses.filter(e => e.date.startsWith(monthInput));

                // Attendance (Aggregated)
                // We need to iterate all days in the month
                let monthlyStats = {}; // { stdId: { present: 0, absentDates: [] } }
                
                // Initialize stats for target students
                targetStudents.forEach(s => {
                    monthlyStats[s.id] = { name: s.name, level: s.level, present: 0, absentDates: [] };
                });

                // Iterate attendance records
                Object.keys(attendance).forEach(date => {
                    if(date.startsWith(monthInput)) {
                        const dayRecords = attendance[date];
                        const presentIds = dayRecords.map(r => typeof r === 'string' ? r : r.id);
                        
                        targetStudents.forEach(s => {
                            if(date >= s.date) { // Only count if student joined
                                if(presentIds.includes(s.id)) {
                                    monthlyStats[s.id].present++;
                                } else {
                                    monthlyStats[s.id].absentDates.push(date);
                                }
                            }
                        });
                    }
                });

                // Convert to array for display
                currentReportData.present = Object.values(monthlyStats).map(s => ({
                    ...s, time: `${s.present} ÙŠÙˆÙ…` // Reuse 'time' field for count
                }));
                
                currentReportData.absent = Object.values(monthlyStats).filter(s => s.absentDates.length > 0).map(s => ({
                    ...s, time: s.absentDates.join(', ') // Reuse 'time' field for dates
                }));
            }

            totalRev = currentReportData.revenues.reduce((a,b)=>a+b.amount,0);
            totalExp = currentReportData.expenses.reduce((a,b)=>a+b.amount,0);

            let html = `
                <h4 class="font-bold text-center border-b pb-2 mb-2">ØªÙ‚Ø±ÙŠØ± ${type === 'daily' ? dateInput : monthInput}</h4>
                
                <div class="grid grid-cols-2 gap-2 mb-4 text-center">
                    <div onclick='openReportDetails("present")' class="bg-green-100 p-2 rounded cursor-pointer hover:bg-green-200">
                        <div class="text-xs">Ø­Ø¶ÙˆØ±</div>
                        <div class="font-bold text-green-700">${type === 'daily' ? currentReportData.present.length : 'Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„'}</div>
                    </div>
                    <div onclick='openReportDetails("absent")' class="bg-red-100 p-2 rounded cursor-pointer hover:bg-red-200">
                        <div class="text-xs">ØºÙŠØ§Ø¨</div>
                        <div class="font-bold text-red-700">${type === 'daily' ? currentReportData.absent.length : 'Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„'}</div>
                    </div>
                </div>

                <div class="space-y-2">
                    <div onclick='openReportDetails("revenues")' class="bg-green-50 p-2 rounded border border-green-200 cursor-pointer hover:bg-green-100 flex justify-between">
                        <span class="text-xs text-gray-500">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</span>
                        <span class="font-bold text-green-700">${totalRev} Ø¬.Ù…</span>
                    </div>
                    <div onclick='openReportDetails("expenses")' class="bg-red-50 p-2 rounded border border-red-200 cursor-pointer hover:bg-red-100 flex justify-between">
                        <span class="text-xs text-gray-500">Ù…ØµØ±ÙˆÙØ§Øª</span>
                        <span class="font-bold text-red-700">${totalExp} Ø¬.Ù…</span>
                    </div>
                    <div class="bg-blue-50 p-2 rounded border border-blue-200 text-center">
                        <span class="text-xs text-gray-500">Ø§Ù„ØµØ§ÙÙŠ</span>
                        <span class="font-bold text-blue-900 text-lg block">${totalRev - totalExp} Ø¬.Ù…</span>
                    </div>
                </div>
            `;
            resDiv.innerHTML = html;
            resDiv.classList.remove('hidden');
        }

        function openReportDetails(key) {
            const list = currentReportData[key];
            let title = '';
            if(key === 'present') title = 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±';
            else if(key === 'absent') title = 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨';
            else if(key === 'revenues') title = 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª';
            else title = 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª';

            document.getElementById('detailsTitle').innerText = title;
            document.getElementById('modalFilterContainer').classList.add('hidden');
            
            const thead = document.getElementById('detailsTableHead');
            const tbody = document.getElementById('detailsTableBody');

            if(key === 'present' || key === 'absent') {
                // Dynamic header based on report type (Daily vs Monthly)
                const isMonthly = document.getElementById('reportType').value === 'monthly';
                const lastCol = isMonthly ? (key === 'present' ? 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…' : 'ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„ØºÙŠØ§Ø¨') : 'Ø§Ù„ÙˆÙ‚Øª';
                
                thead.innerHTML = `<tr><th>Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>${lastCol}</th></tr>`;
                
                if(list.length === 0) tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
                else {
                    tbody.innerHTML = list.map((s, i) => `
                        <tr class="hover:bg-gray-50">
                            <td class="text-gray-500">${i + 1}</td>
                            <td class="font-bold">${s.name}</td>
                            <td>${stageMap[s.level] || s.level}</td>
                            <td class="text-xs ${key === 'absent' ? 'text-red-600' : ''}">${s.time}</td>
                        </tr>
                    `).join('');
                }
            } else {
                thead.innerHTML = `<tr><th>Ù…</th><th>Ø§Ù„Ø¨Ù†Ø¯/Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr>`;
                if(list.length === 0) tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
                else {
                    tbody.innerHTML = list.map((item, i) => `
                        <tr class="hover:bg-gray-50">
                            <td class="text-gray-500">${i + 1}</td>
                            <td class="font-bold">${item.name || item.desc}</td>
                            <td class="text-gray-500 text-xs">${item.date} | ${item.time || '-'}</td>
                            <td class="font-bold ${key === 'revenues' ? 'text-green-600' : 'text-red-600'}">${item.amount}</td>
                        </tr>
                    `).join('');
                }
            }
            document.getElementById('detailsModal').classList.remove('hidden');
        }

        // --- Backup ---
        function exportData() {
            const data = { students, attendance, accounting };
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `backup_center_${today}.json`; a.click();
        }
        function importData(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.students) {
                        localStorage.setItem('sc_students', JSON.stringify(data.students));
                        localStorage.setItem('sc_attendance', JSON.stringify(data.attendance));
                        localStorage.setItem('sc_accounting', JSON.stringify(data.accounting));
                        location.reload();
                    }
                } catch(err) { alert('Ù…Ù„Ù ØªØ§Ù„Ù'); }
            }; reader.readAsText(file);
        }
        function clearAllData() { if(confirm('Ø­Ø°Ù Ø§Ù„ÙƒÙ„ØŸ')) { localStorage.clear(); location.reload(); } }

        // --- Utils ---
        function saveData() {
            localStorage.setItem('sc_students', JSON.stringify(students));
            localStorage.setItem('sc_attendance', JSON.stringify(attendance));
            localStorage.setItem('sc_accounting', JSON.stringify(accounting));
        }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function showToast(msg, type) {
            const t = document.getElementById('toast'); t.innerText = msg;
            t.className = `fixed top-5 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-xl z-[200] font-bold text-sm text-white ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
            t.classList.remove('hidden'); setTimeout(() => t.classList.add('hidden'), 3000);
        }
        function playSound(type) {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator(); osc.connect(ctx.destination);
            if(type === 'success') { osc.frequency.setValueAtTime(800, ctx.currentTime); osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.1); }
            else { osc.frequency.setValueAtTime(300, ctx.currentTime); osc.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.2); }
            osc.start(); osc.stop(ctx.currentTime + 0.2);
        }
    </script>
</body>
</html>